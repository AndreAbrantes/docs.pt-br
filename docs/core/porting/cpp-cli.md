---
title: Migrando projetos C++/CLI para .NET Core
description: Aprenda a portar projetos C++/CLI para o .NET Core.
author: mjrousos
ms.date: 01/10/2020
ms.openlocfilehash: eb03f2a5ff42e8279fd3ebd6ee6fb6d955f6798d
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/14/2020
ms.locfileid: "75964926"
---
# <a name="how-to-port-a-ccli-project-to-net-core"></a><span data-ttu-id="fb6e7-103">Como portar um projeto C++/CLI para o .NET Core</span><span class="sxs-lookup"><span data-stu-id="fb6e7-103">How to port a C++/CLI project to .NET Core</span></span>

<span data-ttu-id="fb6e7-104">Começando com o .NET Core 3.1 e o Visual Studio 2019 versão 16.4, [os projetos C++/CLI](/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp) podem atingir o .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-104">Beginning with .NET Core 3.1 and Visual Studio 2019 version 16.4, [C++/CLI projects](/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp) can target .NET Core.</span></span> <span data-ttu-id="fb6e7-105">Esse suporte torna possível portar aplicativos de desktop do Windows com camadas de interop C++/CLI para .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-105">This support makes it possible to port Windows desktop applications with C++/CLI interop layers to .NET Core.</span></span> <span data-ttu-id="fb6e7-106">Este artigo descreve como portar projetos C++/CLI de .NET Framework para .NET Core 3.1.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-106">This article describes how to port C++/CLI projects from .NET Framework to .NET Core 3.1.</span></span>

## <a name="ccli-net-core-limitations"></a><span data-ttu-id="fb6e7-107">C++/CLI .NET Principais limitações</span><span class="sxs-lookup"><span data-stu-id="fb6e7-107">C++/CLI .NET Core limitations</span></span>

<span data-ttu-id="fb6e7-108">Existem algumas limitações importantes para portar projetos C++/CLI para .NET Core em comparação com outros idiomas:</span><span class="sxs-lookup"><span data-stu-id="fb6e7-108">There are some important limitations to porting C++/CLI projects to .NET Core compared to other languages:</span></span>

* <span data-ttu-id="fb6e7-109">O suporte a C++/CLI para .NET Core é apenas para Windows.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-109">C++/CLI support for .NET Core is Windows only.</span></span>
* <span data-ttu-id="fb6e7-110">Os projetos C++/CLI não podem atingir o .NET Standard, apenas o .NET Core (ou .NET Framework).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-110">C++/CLI projects can't target .NET Standard, only .NET Core (or .NET Framework).</span></span>
* <span data-ttu-id="fb6e7-111">Os projetos C++/CLI não suportam o novo formato de arquivo de projeto no estilo SDK.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-111">C++/CLI projects don't support the new SDK-style project file format.</span></span> <span data-ttu-id="fb6e7-112">Em vez disso, mesmo ao direcionar o .NET Core, os projetos C++/CLI usam o formato de arquivo vcxproj existente.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-112">Instead, even when targeting .NET Core, C++/CLI projects use the existing vcxproj file format.</span></span>
* <span data-ttu-id="fb6e7-113">Os projetos C++/CLI não podem segmentar várias plataformas .NET.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-113">C++/CLI projects can't multitarget multiple .NET platforms.</span></span> <span data-ttu-id="fb6e7-114">Se você precisar construir um projeto C++/CLI para o .NET Framework e o .NET Core, use arquivos de projeto separados.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-114">If you need to build a C++/CLI project for both .NET Framework and .NET Core, use separate project files.</span></span>
* <span data-ttu-id="fb6e7-115">O .NET Core `-clr:pure` não `-clr:safe` suporta ou `-clr:netcore` compila, apenas a `-clr` nova opção (que equivale a .NET Framework).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-115">.NET Core doesn't support `-clr:pure` or `-clr:safe` compilation, only the new `-clr:netcore` option (which is equivalent to `-clr` for .NET Framework).</span></span>

## <a name="port-a-ccli-project"></a><span data-ttu-id="fb6e7-116">Porta um projeto C++/CLI</span><span class="sxs-lookup"><span data-stu-id="fb6e7-116">Port a C++/CLI project</span></span>

<span data-ttu-id="fb6e7-117">Para portar um projeto C++/CLI para .NET Core, faça as seguintes alterações no arquivo vcxproj.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-117">To port a C++/CLI project to .NET Core, make the following changes to the vcxproj file.</span></span> <span data-ttu-id="fb6e7-118">Essas etapas de migração diferem das etapas necessárias para outros tipos de projeto porque os projetos C++/CLI não usam arquivos de projeto no estilo SDK.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-118">These migration steps differ from the steps needed for other project types because C++/CLI projects don't use SDK-style project files.</span></span>

1. <span data-ttu-id="fb6e7-119">Substitua `<CLRSupport>true</CLRSupport>` `<CLRSupport>NetCore</CLRSupport>`as propriedades por .</span><span class="sxs-lookup"><span data-stu-id="fb6e7-119">Replace `<CLRSupport>true</CLRSupport>` properties with `<CLRSupport>NetCore</CLRSupport>`.</span></span> <span data-ttu-id="fb6e7-120">Esta propriedade está frequentemente em grupos de propriedades específicos da configuração, então você pode precisar substituí-la em vários lugares.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-120">This property is often in configuration-specific property groups, so you may need to replace it in multiple places.</span></span>
2. <span data-ttu-id="fb6e7-121">Substitua `<TargetFrameworkVersion>` `<TargetFramework>netcoreapp3.1</TargetFramework>`as propriedades por .</span><span class="sxs-lookup"><span data-stu-id="fb6e7-121">Replace `<TargetFrameworkVersion>` properties with `<TargetFramework>netcoreapp3.1</TargetFramework>`.</span></span>
3. <span data-ttu-id="fb6e7-122">Remova quaisquer referências do `<Reference Include="System" />`Quadro .NET (como ).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-122">Remove any .NET Framework references (like `<Reference Include="System" />`).</span></span> <span data-ttu-id="fb6e7-123">Os conjuntos .NET Core SDK são `<CLRSupport>NetCore</CLRSupport>`automaticamente referenciados ao usar .</span><span class="sxs-lookup"><span data-stu-id="fb6e7-123">.NET Core SDK assemblies are automatically referenced when using `<CLRSupport>NetCore</CLRSupport>`.</span></span>
4. <span data-ttu-id="fb6e7-124">Atualize o uso da API em arquivos cpp, conforme necessário, para remover APIs indisponíveis para .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-124">Update API usage in cpp files, as necessary, to remove APIs unavailable to .NET Core.</span></span> <span data-ttu-id="fb6e7-125">Como os projetos C++/CLI tendem a ser camadas de interop bastante finas, muitas vezes não são necessárias muitas mudanças.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-125">Because C++/CLI projects tend to be fairly thin interop layers, there are often not many changes needed.</span></span> <span data-ttu-id="fb6e7-126">O [Analisador de Portabilidade .NET](../../standard/analyzers/portability-analyzer.md) pode ser usado para identificar APIs .NET não suportadas usadas por binários C++/CLI, assim como com binários puramente gerenciados.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-126">The [.NET Portability Analyzer](../../standard/analyzers/portability-analyzer.md) can be used to identify unsupported .NET APIs used by C++/CLI binaries just as with purely managed binaries.</span></span> <span data-ttu-id="fb6e7-127">As diretrizes para determinar a portabilidade de código e atualizar projetos para trabalhar com APIs do Núcleo .NET estão disponíveis na [orientação de portabilidade](./libraries.md#determine-portability)da biblioteca .</span><span class="sxs-lookup"><span data-stu-id="fb6e7-127">Guidelines for determining code portability and updating projects to work with .NET Core APIs are available in the [library porting guidance](./libraries.md#determine-portability).</span></span>

### <a name="wpf-and-windows-forms-usage"></a><span data-ttu-id="fb6e7-128">Uso de Formulários WPF e Windows</span><span class="sxs-lookup"><span data-stu-id="fb6e7-128">WPF and Windows Forms usage</span></span>

<span data-ttu-id="fb6e7-129">Os projetos .NET Core C++/CLI podem usar formulários do Windows e APIs do WPF.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-129">.NET Core C++/CLI projects can use Windows Forms and WPF APIs.</span></span> <span data-ttu-id="fb6e7-130">Para usar essas APIs de desktop do Windows, você precisa adicionar referências de estrutura explícitas às bibliotecas de ida e fiscal.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-130">To use these Windows desktop APIs, you need to add explicit framework references to the UI libraries.</span></span> <span data-ttu-id="fb6e7-131">Projetos no estilo SDK que usam APIs de desktop do `Microsoft.NET.Sdk.WindowsDesktop` Windows fazem referência às bibliotecas de estruturas necessárias automaticamente usando o SDK.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-131">SDK-style projects that use Windows desktop APIs reference the necessary framework libraries automatically by using the `Microsoft.NET.Sdk.WindowsDesktop` SDK.</span></span> <span data-ttu-id="fb6e7-132">Como os projetos C++/CLI não usam o formato de projeto no estilo SDK, eles precisam adicionar referências de estrutura explícitas ao direcionar o .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-132">Because C++/CLI projects don't use the SDK-style project format, they need to add explicit framework references when targeting .NET Core.</span></span>

<span data-ttu-id="fb6e7-133">Para usar apis do Windows Forms, adicione esta referência ao arquivo vcxproj:</span><span class="sxs-lookup"><span data-stu-id="fb6e7-133">To use Windows Forms APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference all of Windows Forms -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App.WindowsForms" />
```

<span data-ttu-id="fb6e7-134">Para usar as APIs do WPF, adicione esta referência ao arquivo vcxproj:</span><span class="sxs-lookup"><span data-stu-id="fb6e7-134">To use WPF APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference all of WPF -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App.WPF" />
```

<span data-ttu-id="fb6e7-135">Para usar tanto os Formulários do Windows quanto as APIs do WPF, adicione esta referência ao arquivo vcxproj:</span><span class="sxs-lookup"><span data-stu-id="fb6e7-135">To use both Windows Forms and WPF APIs, add this reference to the vcxproj file:</span></span>

```xml
<!-- Reference the entirety of the Windows desktop framework:
     Windows Forms, WPF, and the types that provide integration between them -->
<FrameworkReference Include="Microsoft.WindowsDesktop.App" />
```

<span data-ttu-id="fb6e7-136">Atualmente, não é possível adicionar essas referências usando o gerente de referência do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-136">Currently, it's not possible to add these references using Visual Studio's reference manager.</span></span> <span data-ttu-id="fb6e7-137">Em vez disso, atualize o arquivo do projeto manualmente.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-137">Instead, update the project file manually.</span></span> <span data-ttu-id="fb6e7-138">Esta atualização pode ser feita no Visual Studio descarregando o projeto e, em seguida, editando o arquivo do projeto.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-138">This update can be done in Visual Studio by unloading the project and then editing the project file.</span></span> <span data-ttu-id="fb6e7-139">Você também pode usar outro editor como VS Code.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-139">You can also use another editor like VS Code.</span></span>

## <a name="build-without-msbuild"></a><span data-ttu-id="fb6e7-140">Construir sem MSBuild</span><span class="sxs-lookup"><span data-stu-id="fb6e7-140">Build without MSBuild</span></span>

<span data-ttu-id="fb6e7-141">Também é possível construir projetos C++/CLI sem usar o MSBuild.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-141">It's also possible to build C++/CLI projects without using MSBuild.</span></span> <span data-ttu-id="fb6e7-142">Siga estas etapas para construir um projeto C++/CLI para .NET Core diretamente com *cl.exe* e *link.exe*:</span><span class="sxs-lookup"><span data-stu-id="fb6e7-142">Follow these steps to build a C++/CLI project for .NET Core directly with *cl.exe* and *link.exe*:</span></span>

1. <span data-ttu-id="fb6e7-143">Ao compilar, `-clr:netcore` passe para *cl.exe*.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-143">When compiling, pass `-clr:netcore` to *cl.exe*.</span></span>
2. <span data-ttu-id="fb6e7-144">Montagem de referência necessária .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-144">Reference necessary .NET Core reference assemblies.</span></span>
3. <span data-ttu-id="fb6e7-145">Ao vincular, forneça o diretório de host `LibPath` do aplicativo .NET Core como um (para que *ijwhost.lib* possa ser encontrado).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-145">When linking, provide the .NET Core app host directory as a `LibPath` (so that *ijwhost.lib* can be found).</span></span>
4. <span data-ttu-id="fb6e7-146">Copie *ijwhost.dll* (do diretório de host do aplicativo .NET Core) para o diretório de saída do projeto.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-146">Copy *ijwhost.dll* (from the .NET Core app host directory) to the project's output directory.</span></span>
5. <span data-ttu-id="fb6e7-147">Certifique-se de que existe um arquivo [runtimeconfig.json](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) para o primeiro componente do aplicativo que executará o código gerenciado.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-147">Make sure a [runtimeconfig.json](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) file exists for the first component of the application that will run managed code.</span></span> <span data-ttu-id="fb6e7-148">Se o aplicativo tiver um ponto `runtime.config` de entrada gerenciado, um arquivo será criado e copiado automaticamente.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-148">If the application has a managed entry point, a `runtime.config` file will be created and copied automatically.</span></span> <span data-ttu-id="fb6e7-149">Se o aplicativo tiver um ponto de entrada `runtimeconfig.json` nativo, porém, você precisa criar um arquivo para a primeira biblioteca C++/CLI para usar o tempo de execução do .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-149">If the application has a native entry point, though, you need to create a `runtimeconfig.json` file for the first C++/CLI library to use the .NET Core runtime.</span></span>

## <a name="known-issues"></a><span data-ttu-id="fb6e7-150">Problemas conhecidos</span><span class="sxs-lookup"><span data-stu-id="fb6e7-150">Known issues</span></span>

<span data-ttu-id="fb6e7-151">Existem alguns problemas conhecidos a serem atentos ao trabalhar com projetos C++/CLI direcionados ao .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-151">There are a couple known issues to look out for when working with C++/CLI projects targeting .NET Core.</span></span>

* <span data-ttu-id="fb6e7-152">Uma referência de estrutura do WPF em projetos .NET Core C++/CLI atualmente causa alguns avisos estranhos sobre não poder importar símbolos.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-152">A WPF framework reference in .NET Core C++/CLI projects currently causes some extraneous warnings about being unable to import symbols.</span></span> <span data-ttu-id="fb6e7-153">Esses avisos podem ser ignorados com segurança e devem ser corrigidos em breve.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-153">These warnings can be safely ignored and should be fixed soon.</span></span>
* <span data-ttu-id="fb6e7-154">Se o aplicativo tiver um ponto de entrada nativo, a biblioteca C++/CLI que primeiro executa o código gerenciado precisa de um arquivo [runtimeconfig.json.](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md)</span><span class="sxs-lookup"><span data-stu-id="fb6e7-154">If the application has a native entry point, the C++/CLI library that first executes managed code needs a [runtimeconfig.json](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md) file.</span></span> <span data-ttu-id="fb6e7-155">Este arquivo de configuração é usado quando o tempo de execução do .NET Core é iniciado.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-155">This config file is used when the .NET Core runtime starts.</span></span> <span data-ttu-id="fb6e7-156">Os projetos C++/CLI `runtimeconfig.json` ainda não criam arquivos automaticamente no tempo de compilação, então o arquivo deve ser gerado manualmente.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-156">C++/CLI projects don't create `runtimeconfig.json` files automatically at build time yet, so the file must be generated manually.</span></span> <span data-ttu-id="fb6e7-157">Se uma biblioteca C++/CLI for chamada a partir de um ponto de entrada `runtimeconfig.json` gerenciado, a biblioteca C++/CLI não precisará de um arquivo (uma vez que o conjunto de pontos de entrada terá um usado ao iniciar o tempo de execução).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-157">If a C++/CLI library is called from a managed entry point, then the C++/CLI library doesn't need a `runtimeconfig.json` file (since the entry point assembly will have one that is used when starting the runtime).</span></span> <span data-ttu-id="fb6e7-158">Um simples `runtimeconfig.json` arquivo de amostra é mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="fb6e7-158">A simple sample `runtimeconfig.json` file is shown below.</span></span> <span data-ttu-id="fb6e7-159">Para obter mais informações, consulte a [especificação no GitHub](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md).</span><span class="sxs-lookup"><span data-stu-id="fb6e7-159">For more information, see the [spec on GitHub](https://github.com/dotnet/cli/blob/master/Documentation/specs/runtime-configuration-file.md).</span></span>

    ```json
    {
          "runtimeOptions": {
             "tfm": "netcoreapp3.1",
             "framework": {
                "name": "Microsoft.NETCore.App",
                "version": "3.1.0"
             }
          }
    }
    ```
