---
title: Alterações na autenticação NTLM para HttpWebRequest na versão 3.5 SP1
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
author: mcleblanc
ms.author: markl
manager: markl
ms.openlocfilehash: f5affc15607ddae76ec90a90928cb42fa0ad49e1
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/04/2018
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a><span data-ttu-id="caf7d-102">Alterações na autenticação NTLM para HttpWebRequest na versão 3.5 SP1</span><span class="sxs-lookup"><span data-stu-id="caf7d-102">Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1</span></span>
<span data-ttu-id="caf7d-103">Foram feitas alterações de segurança no .NET Framework versão 3.5 SP1 que afetam a maneira como a autenticação integrada do Windows é manipulada por <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream> e por classes relacionadas no namespace System.Net.</span><span class="sxs-lookup"><span data-stu-id="caf7d-103">Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace.</span></span> <span data-ttu-id="caf7d-104">Essas alterações podem afetar os aplicativos que usam essas classes para fazer solicitações da Web e receber respostas em que a autenticação integrada do Windows baseada no NTLM é usada.</span><span class="sxs-lookup"><span data-stu-id="caf7d-104">These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.</span></span> <span data-ttu-id="caf7d-105">Essa alteração pode afetar os servidores Web e aplicativos cliente configurados para usar a autenticação integrada do Windows.</span><span class="sxs-lookup"><span data-stu-id="caf7d-105">This change can impact web servers and client applications that are configured to use integrated Windows authentication.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="caf7d-106">Visão geral</span><span class="sxs-lookup"><span data-stu-id="caf7d-106">Overview</span></span>  
 <span data-ttu-id="caf7d-107">O design da autenticação integrada do Windows permite que algumas respostas de credencial sejam universais, o que significa que elas podem ser reutilizadas ou encaminhadas.</span><span class="sxs-lookup"><span data-stu-id="caf7d-107">The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.</span></span> <span data-ttu-id="caf7d-108">Se esse recurso de design específico não for necessário, os protocolos de autenticação deverão conter informações específicas ao destino, bem como informações específicas ao canal.</span><span class="sxs-lookup"><span data-stu-id="caf7d-108">If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.</span></span> <span data-ttu-id="caf7d-109">Em seguida, os serviços podem fornecer proteção estendida para garantir que as respostas de credencial contenham informações específicas ao serviço, como um SPN (Nome da Entidade de Serviço).</span><span class="sxs-lookup"><span data-stu-id="caf7d-109">Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).</span></span> <span data-ttu-id="caf7d-110">Com essas informações nas trocas de credenciais, os serviços podem proteger melhor contra o uso mal intencionado de respostas de credencial que podem ter sido obtidas indevidamente.</span><span class="sxs-lookup"><span data-stu-id="caf7d-110">With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.</span></span>  
  
 <span data-ttu-id="caf7d-111">Vários componentes nos namespaces <xref:System.Net> e <xref:System.Net.Security> executam a autenticação integrada do Windows em nome de um aplicativo de chamada.</span><span class="sxs-lookup"><span data-stu-id="caf7d-111">Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application.</span></span> <span data-ttu-id="caf7d-112">Esta seção descreve as alterações nos componentes do System.Net para adicionar a proteção estendida no uso que eles fazem da autenticação integrada do Windows.</span><span class="sxs-lookup"><span data-stu-id="caf7d-112">This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.</span></span>  
  
## <a name="changes"></a><span data-ttu-id="caf7d-113">Alterações</span><span class="sxs-lookup"><span data-stu-id="caf7d-113">Changes</span></span>  
 <span data-ttu-id="caf7d-114">O processo de autenticação NTLM usado com a autenticação integrada do Windows inclui um desafio emitido pelo computador de destino e enviado novamente para o computador cliente.</span><span class="sxs-lookup"><span data-stu-id="caf7d-114">The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.</span></span> <span data-ttu-id="caf7d-115">Quando um computador recebe um desafio que ele próprio gerou, a autenticação falhará, a menos que a conexão seja uma conexão de loopback (endereço IPv4 127.0.0.1, por exemplo).</span><span class="sxs-lookup"><span data-stu-id="caf7d-115">When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).</span></span>  
  
 <span data-ttu-id="caf7d-116">Ao acessar um serviço executado em um servidor Web interno, é comum acessar o serviço usando uma URL semelhante a http://contoso/service ou https://contoso/service.</span><span class="sxs-lookup"><span data-stu-id="caf7d-116">When accessing a service running on an internal Web server, it is common to access the service using a URL similar to http://contoso/service or https://contoso/service.</span></span> <span data-ttu-id="caf7d-117">O nome “contoso” geralmente não é o nome do computador no qual o serviço é implantado.</span><span class="sxs-lookup"><span data-stu-id="caf7d-117">The name "contoso" is often not the computer name of the computer on which the service is deployed.</span></span> <span data-ttu-id="caf7d-118">O <xref:System.Net> e os namespaces relacionados dão suporte ao uso do Active Directory, DNS, NetBIOS, o arquivo de hosts do computador local (geralmente, WINDOWS\system32\drivers\etc\hosts, por exemplo) ou o arquivo lmhosts do computador local (geralmente, WINDOWS\system32\drivers\etc\lmhosts, por exemplo) para resolver nomes em endereços.</span><span class="sxs-lookup"><span data-stu-id="caf7d-118">The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\system32\drivers\etc\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\system32\drivers\etc\lmhosts, for example) to resolve names to addresses.</span></span> <span data-ttu-id="caf7d-119">O nome “contoso” é resolvido para que as solicitações enviadas para “contoso” sejam enviadas para o computador do servidor apropriado.</span><span class="sxs-lookup"><span data-stu-id="caf7d-119">The name "contoso" is resolved so that requests sent to "contoso" are sent to the appropriate server computer.</span></span>  
  
 <span data-ttu-id="caf7d-120">Quando configurado para implantações grandes, também é comum que um único nome do servidor virtual seja fornecido à implantação com os nomes de computador subjacentes nunca usados pelos aplicativos cliente e usuários finais.</span><span class="sxs-lookup"><span data-stu-id="caf7d-120">When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.</span></span> <span data-ttu-id="caf7d-121">Por exemplo, você pode chamar o servidor www.contoso.com, mas em uma rede interna, basta usar “contoso”.</span><span class="sxs-lookup"><span data-stu-id="caf7d-121">For example, you might call the server www.contoso.com, but on an internal network simply use "contoso".</span></span> <span data-ttu-id="caf7d-122">Esse nome é chamado de cabeçalho de Host na solicitação da Web do cliente.</span><span class="sxs-lookup"><span data-stu-id="caf7d-122">This name is called the Host header in the client web request.</span></span> <span data-ttu-id="caf7d-123">Conforme especificado pelo protocolo HTTP, o campo de cabeçalho da solicitação Host especifica o número da porta e o host da Internet do recurso solicitado.</span><span class="sxs-lookup"><span data-stu-id="caf7d-123">As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.</span></span> <span data-ttu-id="caf7d-124">Essas informações são obtidas do URI original fornecido pelo usuário ou pelo recurso de referência (geralmente uma URL HTTP).</span><span class="sxs-lookup"><span data-stu-id="caf7d-124">This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).</span></span> <span data-ttu-id="caf7d-125">No .NET Framework versão 4, essas informações também podem ser definidas pelo cliente usando a nova propriedade <xref:System.Net.HttpWebRequest.Host%2A>.</span><span class="sxs-lookup"><span data-stu-id="caf7d-125">On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.</span></span>  
  
 <span data-ttu-id="caf7d-126">A classe <xref:System.Net.AuthenticationManager> controla os componentes de autenticação gerenciada (“módulos”) que são usados pelas classes derivadas <xref:System.Net.WebRequest> e pela classe <xref:System.Net.WebClient>.</span><span class="sxs-lookup"><span data-stu-id="caf7d-126">The <xref:System.Net.AuthenticationManager> class controls the managed authentication components ("modules") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="caf7d-127">A classe <xref:System.Net.AuthenticationManager> fornece uma propriedade que expõe um objeto <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>, indexado por uma cadeia de caracteres do URI, de aplicativos para fornecer uma cadeia de caracteres do SPN personalizada a ser usada durante a autenticação.</span><span class="sxs-lookup"><span data-stu-id="caf7d-127">The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.</span></span>  
  
 <span data-ttu-id="caf7d-128">A versão 3.5 SP1 agora usa como padrão a especificação do nome do host usado na URL da solicitação no SPN da troca de autenticação NTLM (NT LAN Manager) quando a propriedade <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> não está definida.</span><span class="sxs-lookup"><span data-stu-id="caf7d-128">Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set.</span></span> <span data-ttu-id="caf7d-129">O nome do host usado na URL da solicitação pode ser diferente do cabeçalho de Host especificado na <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> na solicitação do cliente.</span><span class="sxs-lookup"><span data-stu-id="caf7d-129">The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request.</span></span> <span data-ttu-id="caf7d-130">O nome do host usado na URL de solicitação pode ser diferente do nome do host real do servidor, do nome do computador do servidor, do endereço IP do computador ou do endereço de loopback.</span><span class="sxs-lookup"><span data-stu-id="caf7d-130">The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.</span></span> <span data-ttu-id="caf7d-131">Nesses casos, o Windows falhará a solicitação de autenticação.</span><span class="sxs-lookup"><span data-stu-id="caf7d-131">In these cases, Windows will fail the authentication request.</span></span> <span data-ttu-id="caf7d-132">Para resolver o problema, é necessário notificar o Windows de que o nome do host usado na URL da solicitação na solicitação do cliente (“contoso”, por exemplo) é realmente um nome alternativo para o computador local.</span><span class="sxs-lookup"><span data-stu-id="caf7d-132">To address the issue, we need to notify Windows that the host name used in the request URL in the client request ("contoso", for example) is actually an alternate name for the local computer.</span></span>  
  
 <span data-ttu-id="caf7d-133">Há vários métodos possíveis para que um aplicativo para servidores resolva essa alteração.</span><span class="sxs-lookup"><span data-stu-id="caf7d-133">There are several possible methods for a server application to work around this change.</span></span> <span data-ttu-id="caf7d-134">A abordagem recomendada é mapear o nome do host usado na URL da solicitação para a chave `BackConnectionHostNames` do Registro no servidor.</span><span class="sxs-lookup"><span data-stu-id="caf7d-134">The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server.</span></span> <span data-ttu-id="caf7d-135">A chave do Registro `BackConnectionHostNames` é normalmente usada para mapear um nome do host para um endereço de loopback.</span><span class="sxs-lookup"><span data-stu-id="caf7d-135">The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address.</span></span> <span data-ttu-id="caf7d-136">As etapas são listadas abaixo.</span><span class="sxs-lookup"><span data-stu-id="caf7d-136">The steps are listed below.</span></span>  
  
 <span data-ttu-id="caf7d-137">Para especificar os nomes do host que são mapeados para o endereço de loopback e que podem se conectar a sites em um computador local, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="caf7d-137">To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:</span></span>  
  
 1. <span data-ttu-id="caf7d-138">Clique em Iniciar, clique em Executar, digite regedit e, em seguida, clique em OK.</span><span class="sxs-lookup"><span data-stu-id="caf7d-138">Click Start, click Run, type regedit, and then click OK.</span></span>  
  
 2. <span data-ttu-id="caf7d-139">No Editor do Registro, localize e, em seguida, clique na seguinte chave do Registro:</span><span class="sxs-lookup"><span data-stu-id="caf7d-139">In Registry Editor, locate and then click the following registry key:</span></span>  
  
 `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`  
  
 3. <span data-ttu-id="caf7d-140">Clique com o botão direito do mouse em MSV1_0, aponte para Novo e, em seguida, clique em Valor de Cadeia de Caracteres Múltipla.</span><span class="sxs-lookup"><span data-stu-id="caf7d-140">Right-click MSV1_0, point to New, and then click Multi-String Value.</span></span>  
  
 4. <span data-ttu-id="caf7d-141">Digite `BackConnectionHostNames` e, depois, pressione ENTER.</span><span class="sxs-lookup"><span data-stu-id="caf7d-141">Type `BackConnectionHostNames`, and then press ENTER.</span></span>  
  
 5. <span data-ttu-id="caf7d-142">Clique com o botão direito do mouse em `BackConnectionHostNames` e, em seguida, clique em Modificar.</span><span class="sxs-lookup"><span data-stu-id="caf7d-142">Right-click `BackConnectionHostNames`, and then click Modify.</span></span>  
  
 6. <span data-ttu-id="caf7d-143">Na caixa de dados Valor, digite o nome do host ou os nomes do host dos sites (o nome do host usado na URL da solicitação) que estão no computador local e, em seguida, clique em OK.</span><span class="sxs-lookup"><span data-stu-id="caf7d-143">In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.</span></span>  
  
 7. <span data-ttu-id="caf7d-144">Encerre o Editor do Registro e, em seguida, reinicie o serviço IISAdmin e execute IISReset.</span><span class="sxs-lookup"><span data-stu-id="caf7d-144">Quit Registry Editor, and then restart the IISAdmin service and run IISReset.</span></span>  
  
 <span data-ttu-id="caf7d-145">Uma solução alternativa menos segura é desabilitar a verificação de loopback, conforme descrito em [http://support.microsoft.com/kb/896861](http://go.microsoft.com/fwlink/?LinkID=179657).</span><span class="sxs-lookup"><span data-stu-id="caf7d-145">A less secure work around is to disable the loop back check, as described in [http://support.microsoft.com/kb/896861](http://go.microsoft.com/fwlink/?LinkID=179657).</span></span> <span data-ttu-id="caf7d-146">Isso desabilita a proteção contra ataques de reflexão.</span><span class="sxs-lookup"><span data-stu-id="caf7d-146">This disables the protection against reflection attacks.</span></span> <span data-ttu-id="caf7d-147">Portanto, é melhor restringir o conjunto de nomes alternativos somente àqueles que você espera que sejam usados pelo computador.</span><span class="sxs-lookup"><span data-stu-id="caf7d-147">So it is better to constrain the set of alternate names to only those you expect the machine to actually use.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="caf7d-148">Consulte também</span><span class="sxs-lookup"><span data-stu-id="caf7d-148">See Also</span></span>  
 <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>  
 <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>  
 <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
