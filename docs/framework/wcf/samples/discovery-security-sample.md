---
title: "Exemplo de segurança de descoberta"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
caps.latest.revision: "13"
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.workload: dotnet
ms.openlocfilehash: f50334c8477b8823ef1dfb6abcae640e439d5ddd
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/22/2017
---
# <a name="discovery-security-sample"></a><span data-ttu-id="3498b-102">Exemplo de segurança de descoberta</span><span class="sxs-lookup"><span data-stu-id="3498b-102">Discovery Security Sample</span></span>
<span data-ttu-id="3498b-103">A especificação de descoberta não requer que os pontos de extremidade que participam do processo de descoberta para ser seguro.</span><span class="sxs-lookup"><span data-stu-id="3498b-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="3498b-104">Aprimorando as mensagens de descoberta com segurança reduz os vários tipos de ataques (negação de serviço, a alteração da mensagem, reproduzir, falsificação).</span><span class="sxs-lookup"><span data-stu-id="3498b-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="3498b-105">Este exemplo implementa canais personalizados de computação e verificar as assinaturas de mensagem usando o formato de assinatura compact (descrito na seção 8.2 da especificação WS-Discovery).</span><span class="sxs-lookup"><span data-stu-id="3498b-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="3498b-106">O exemplo dá suporte ao [especificação de descoberta de 2005](http://go.microsoft.com/fwlink/?LinkId=177912) e [versão 1.1](http://go.microsoft.com/fwlink/?LinkId=179677).</span><span class="sxs-lookup"><span data-stu-id="3498b-106">The sample supports both the [2005 Discovery specification](http://go.microsoft.com/fwlink/?LinkId=177912) and the [1.1 version](http://go.microsoft.com/fwlink/?LinkId=179677).</span></span>  
  
 <span data-ttu-id="3498b-107">O canal personalizado é aplicado na parte superior da pilha de canais existentes para pontos de extremidade de descoberta e o anúncio.</span><span class="sxs-lookup"><span data-stu-id="3498b-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="3498b-108">Dessa forma, um cabeçalho de assinatura é aplicado a todas as mensagens enviadas.</span><span class="sxs-lookup"><span data-stu-id="3498b-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="3498b-109">A assinatura é verificada nas mensagens recebidas e quando ela não corresponde, ou quando as mensagens não tem uma assinatura, as mensagens serão descartadas.</span><span class="sxs-lookup"><span data-stu-id="3498b-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="3498b-110">Para assinar e verificar as mensagens, o exemplo usa certificados.</span><span class="sxs-lookup"><span data-stu-id="3498b-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="3498b-111">Discussão</span><span class="sxs-lookup"><span data-stu-id="3498b-111">Discussion</span></span>  
 <span data-ttu-id="3498b-112">O WCF é muito extensível e permite que os usuários a possibilidade de personalizar canais conforme desejado.</span><span class="sxs-lookup"><span data-stu-id="3498b-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="3498b-113">O exemplo implementa um elemento de associação de segurança de descoberta que cria canais seguros.</span><span class="sxs-lookup"><span data-stu-id="3498b-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="3498b-114">Os canais de segurança se aplicam e verificar as assinaturas de mensagem em são aplicados no topo da pilha atual.</span><span class="sxs-lookup"><span data-stu-id="3498b-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="3498b-115">O elemento de associação de segurança cria fábricas de canal seguro e ouvintes de canais.</span><span class="sxs-lookup"><span data-stu-id="3498b-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="3498b-116">Fábrica de canal seguro</span><span class="sxs-lookup"><span data-stu-id="3498b-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="3498b-117">A fábrica de canal seguro cria saída ou canais duplex de adicionar uma assinatura compact para cabeçalhos de mensagem.</span><span class="sxs-lookup"><span data-stu-id="3498b-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="3498b-118">Para manter as mensagens tão pequenas quanto possível o formato de assinatura compact é usado.</span><span class="sxs-lookup"><span data-stu-id="3498b-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="3498b-119">A estrutura de uma assinatura do compact é mostrada no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="3498b-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >   
  [<d:Sig Scheme="xs:anyURI"   
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"   
          Sig="xs:base64Binary"   
          ... />]?  
  ...   
</d:Security>  
```  
  
> [!NOTE]
>  <span data-ttu-id="3498b-120">O `PrefixList` foi adicionado o protocolo de versão de descoberta de 2008.</span><span class="sxs-lookup"><span data-stu-id="3498b-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="3498b-121">Para calcular a assinatura, o exemplo determina os itens de assinatura expandida.</span><span class="sxs-lookup"><span data-stu-id="3498b-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="3498b-122">Uma assinatura XML (`SignedInfo`) é criado usando o `ds` prefixo de namespace, conforme exigido pela especificação WS-Discovery.</span><span class="sxs-lookup"><span data-stu-id="3498b-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="3498b-123">O corpo e todos os cabeçalhos de descoberta e a resolução namespaces são referenciados na assinatura, portanto não pode ser violados.</span><span class="sxs-lookup"><span data-stu-id="3498b-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="3498b-124">Cada elemento referenciado é transformado usando canonização do exclusivo (http://www.w3.org/2001/10/xml-exc-c14n#) e, em seguida, um valor de resumo de SHA-1 é computada (http://www.w3.org/2000/09/xmldsig#sha1).</span><span class="sxs-lookup"><span data-stu-id="3498b-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="3498b-125">Com base em todos os elementos e seus valores de resumo, o valor de assinatura é calculado usando o algoritmo RSA (http://www.w3.org/2000/09/xmldsig#rsa-sha1).</span><span class="sxs-lookup"><span data-stu-id="3498b-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="3498b-126">As mensagens são assinadas com um certificado de cliente especificado.</span><span class="sxs-lookup"><span data-stu-id="3498b-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="3498b-127">O local de armazenamento, o nome e o nome de assunto do certificado devem ser especificados quando o elemento de associação é criado.</span><span class="sxs-lookup"><span data-stu-id="3498b-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="3498b-128">O `KeyId` na assinatura compact representa o identificador de chave de token de assinatura e é o assunto chave identificador SKI () do token de autenticação ou (se não existir o SKI) um hash SHA-1 da chave pública do token de assinatura.</span><span class="sxs-lookup"><span data-stu-id="3498b-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="3498b-129">Ouvinte de canal seguro</span><span class="sxs-lookup"><span data-stu-id="3498b-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="3498b-130">O ouvinte de canal seguro cria canais de entrada ou duplex que verificam a assinatura compact em mensagens recebidas.</span><span class="sxs-lookup"><span data-stu-id="3498b-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="3498b-131">Para verificar a assinatura, o `KeyId` especificado no compact anexada à mensagem de assinatura é usada para selecionar um certificado do armazenamento especificado.</span><span class="sxs-lookup"><span data-stu-id="3498b-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="3498b-132">Se a mensagem não tem uma assinatura ou a verificação de assinatura falhar, as mensagens são descartadas.</span><span class="sxs-lookup"><span data-stu-id="3498b-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="3498b-133">Para usar a associação de segurança, o exemplo define uma fábrica que cria personalizada <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> e <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> com o elemento de associação de segurança de descoberta adicional.</span><span class="sxs-lookup"><span data-stu-id="3498b-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="3498b-134">Esses pontos de extremidade seguros podem ser usados nos serviços detectáveis e ouvintes de anúncio de descoberta.</span><span class="sxs-lookup"><span data-stu-id="3498b-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="3498b-135">Detalhes de exemplo</span><span class="sxs-lookup"><span data-stu-id="3498b-135">Sample Details</span></span>  
 <span data-ttu-id="3498b-136">O exemplo inclui uma biblioteca e 4 aplicativos de console:</span><span class="sxs-lookup"><span data-stu-id="3498b-136">The sample includes a library and 4 console applications:</span></span>  
  
-   <span data-ttu-id="3498b-137">**DiscoverySecurityChannels**: uma biblioteca que expõe a associação de segurança.</span><span class="sxs-lookup"><span data-stu-id="3498b-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="3498b-138">A biblioteca calcula e verifica a assinatura compact para mensagens de entrada/saída.</span><span class="sxs-lookup"><span data-stu-id="3498b-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
-   <span data-ttu-id="3498b-139">**Serviço**: um serviço expondo ICalculatorService contrato, self-host.</span><span class="sxs-lookup"><span data-stu-id="3498b-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="3498b-140">O serviço está marcado como detectável.</span><span class="sxs-lookup"><span data-stu-id="3498b-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="3498b-141">O usuário Especifica os detalhes do certificado usado para assinar mensagens, especificando o local do repositório e o nome e o nome da entidade ou outro identificador exclusivo para o certificado e o armazenamento onde os certificados de cliente estão localizados (os certificados usados para verificar a assinatura para as mensagens de entrada).</span><span class="sxs-lookup"><span data-stu-id="3498b-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="3498b-142">Com base nesses detalhes, um UdpDiscoveryEndpoint com segurança adicional é criado e usado.</span><span class="sxs-lookup"><span data-stu-id="3498b-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
-   <span data-ttu-id="3498b-143">**Cliente**: esta classe tenta descobrir um ICalculatorService e para chamar métodos no serviço.</span><span class="sxs-lookup"><span data-stu-id="3498b-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="3498b-144">Novamente, um <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> com adicionado segurança é criada e usada para assinar e verificar as mensagens.</span><span class="sxs-lookup"><span data-stu-id="3498b-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
-   <span data-ttu-id="3498b-145">**AnnouncementListener**: um serviço auto-hospedado que escuta anúncios online e offline e usa o ponto de extremidade de comunicado de segurança.</span><span class="sxs-lookup"><span data-stu-id="3498b-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="3498b-146">Se bat será executado várias vezes, o Gerenciador de certificados solicitará para escolher um certificado a ser adicionado, pois há certificados duplicados.</span><span class="sxs-lookup"><span data-stu-id="3498b-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="3498b-147">Nesse caso, bat deve ser anulada e Cleanup.bat deve ser chamado porque as duplicatas já foram criadas.</span><span class="sxs-lookup"><span data-stu-id="3498b-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="3498b-148">CleanUp.bat também solicita que você escolha um certificado a ser excluído.</span><span class="sxs-lookup"><span data-stu-id="3498b-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="3498b-149">Selecione um certificado na lista e continuar a executar Cleanup.bat até que nenhum certificado está pendente.</span><span class="sxs-lookup"><span data-stu-id="3498b-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="3498b-150">Para usar este exemplo</span><span class="sxs-lookup"><span data-stu-id="3498b-150">To use this sample</span></span>  
  
1.  <span data-ttu-id="3498b-151">Execute o script de bat em um prompt de comando do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="3498b-151">Execute the Setup.bat script from a Visual Studio command prompt.</span></span> <span data-ttu-id="3498b-152">O exemplo usa certificados para assinar e verificar as mensagens.</span><span class="sxs-lookup"><span data-stu-id="3498b-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="3498b-153">O script cria os certificados usando Makecert.exe e, em seguida, instala-os usando Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="3498b-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="3498b-154">O script deve ser executado com privilégios de administrador.</span><span class="sxs-lookup"><span data-stu-id="3498b-154">The script must be run with administrator privileges.</span></span>  
  
2.  <span data-ttu-id="3498b-155">Para compilar e executar o exemplo, abra o arquivo Security.sln no Visual Studio e escolha **recriar todos os**.</span><span class="sxs-lookup"><span data-stu-id="3498b-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="3498b-156">Atualizar as propriedades da solução para iniciar vários projetos: selecione **iniciar** para todos os projetos, exceto DiscoverySecureChannels.</span><span class="sxs-lookup"><span data-stu-id="3498b-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="3498b-157">Execute a solução normalmente.</span><span class="sxs-lookup"><span data-stu-id="3498b-157">Run the solution normally.</span></span>  
  
3.  <span data-ttu-id="3498b-158">Depois que você concluir o exemplo, execute o script de Cleanup.bat que remove os certificados criados para este exemplo.</span><span class="sxs-lookup"><span data-stu-id="3498b-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="3498b-159">Os exemplos podem já estar instalados no seu computador.</span><span class="sxs-lookup"><span data-stu-id="3498b-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="3498b-160">Verifique o seguinte diretório (padrão) antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="3498b-160">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="3498b-161">Se este diretório não existir, vá para [Windows Communication Foundation (WCF) e exemplos do Windows Workflow Foundation (WF) para o .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) para baixar todos os [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] e [!INCLUDE[wf1](../../../../includes/wf1-md.md)] exemplos.</span><span class="sxs-lookup"><span data-stu-id="3498b-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="3498b-162">Este exemplo está localizado no seguinte diretório.</span><span class="sxs-lookup"><span data-stu-id="3498b-162">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
  
## <a name="see-also"></a><span data-ttu-id="3498b-163">Consulte também</span><span class="sxs-lookup"><span data-stu-id="3498b-163">See Also</span></span>
