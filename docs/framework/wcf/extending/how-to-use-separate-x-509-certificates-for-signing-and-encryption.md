---
title: 'Como: usar certificados X.509 separados para assinatura e criptografia'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, extensibility
- ClientCredentials class
- ClientCredentialsSecurityTokenManager class
ms.assetid: 0b06ce4e-7835-4d82-8baf-d525c71a0e49
ms.openlocfilehash: e464aff46f311ede1cd629fb459ade9a6e627d59
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/07/2019
ms.locfileid: "70796950"
---
# <a name="how-to-use-separate-x509-certificates-for-signing-and-encryption"></a><span data-ttu-id="f1c04-102">Como: usar certificados X.509 separados para assinatura e criptografia</span><span class="sxs-lookup"><span data-stu-id="f1c04-102">How to: Use Separate X.509 Certificates for Signing and Encryption</span></span>

<span data-ttu-id="f1c04-103">Este tópico mostra como configurar o Windows Communication Foundation (WCF) para usar certificados diferentes para assinatura e criptografia de mensagens no cliente e no serviço.</span><span class="sxs-lookup"><span data-stu-id="f1c04-103">This topic shows how to configure Windows Communication Foundation (WCF) to use different certificates for message signing and encryption on both the client and service.</span></span>

<span data-ttu-id="f1c04-104">Para permitir que certificados separados sejam usados para assinatura e criptografia, um cliente personalizado ou credenciais de serviço (ou ambos) devem ser criadas porque o WCF não fornece uma API para definir vários certificados de cliente ou de serviço.</span><span class="sxs-lookup"><span data-stu-id="f1c04-104">To enable separate certificates to be used for signing and encryption, a custom client or service credentials (or both) must be created because WCF does not provide an API to set multiple client or service certificates.</span></span> <span data-ttu-id="f1c04-105">Além disso, um Gerenciador de token de segurança deve ser fornecido para aproveitar as informações de vários certificados e para criar um provedor de token de segurança apropriado para o uso de chave e a direção da mensagem especificados.</span><span class="sxs-lookup"><span data-stu-id="f1c04-105">Additionally, a security token manager must be provided to leverage the multiple certificates' information and to create an appropriate security token provider for specified key usage and message direction.</span></span>

<span data-ttu-id="f1c04-106">O diagrama a seguir mostra as classes principais usadas, as classes das quais elas herdam (mostradas por uma seta apontando para cima) e os tipos de retorno de determinados métodos e propriedades.</span><span class="sxs-lookup"><span data-stu-id="f1c04-106">The following diagram shows the main classes used, the classes they inherit from (shown by an upward-pointing arrow), and the return types of certain methods and properties.</span></span>

- <span data-ttu-id="f1c04-107">`MyClientCredentials`é uma implementação personalizada do <xref:System.ServiceModel.Description.ClientCredentials>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-107">`MyClientCredentials` is a custom implementation of <xref:System.ServiceModel.Description.ClientCredentials>.</span></span>

  - <span data-ttu-id="f1c04-108">Suas propriedades mostradas no diagrama todas as instâncias retornam de <xref:System.Security.Cryptography.X509Certificates.X509Certificate2>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-108">Its properties shown in the diagram all return instances of <xref:System.Security.Cryptography.X509Certificates.X509Certificate2>.</span></span>

  - <span data-ttu-id="f1c04-109">Seu método <xref:System.ServiceModel.Description.ClientCredentials.CreateSecurityTokenManager%2A> retorna uma instância do `MyClientCredentialsSecurityTokenManager`.</span><span class="sxs-lookup"><span data-stu-id="f1c04-109">Its method <xref:System.ServiceModel.Description.ClientCredentials.CreateSecurityTokenManager%2A> returns an instance of `MyClientCredentialsSecurityTokenManager`.</span></span>

- <span data-ttu-id="f1c04-110">`MyClientCredentialsSecurityTokenManager`é uma implementação personalizada do <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-110">`MyClientCredentialsSecurityTokenManager` is a custom implementation of <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>.</span></span>

  - <span data-ttu-id="f1c04-111">Seu método <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> retorna uma instância do <xref:System.IdentityModel.Selectors.X509SecurityTokenProvider>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-111">Its method <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> returns an instance of <xref:System.IdentityModel.Selectors.X509SecurityTokenProvider>.</span></span>

<span data-ttu-id="f1c04-112">![Gráfico mostrando como as credenciais do cliente são usadas](./media/e4971edd-a59f-4571-b36f-7e6b2f0d610f.gif "e4971edd-a59f-4571-b36f-7e6b2f0d610f")</span><span class="sxs-lookup"><span data-stu-id="f1c04-112">![Chart showing how client credentials are used](./media/e4971edd-a59f-4571-b36f-7e6b2f0d610f.gif "e4971edd-a59f-4571-b36f-7e6b2f0d610f")</span></span>

<span data-ttu-id="f1c04-113">Para obter mais informações sobre credenciais personalizadas, [consulte Walkthrough: Criando credenciais](walkthrough-creating-custom-client-and-service-credentials.md)de cliente e de serviço personalizadas.</span><span class="sxs-lookup"><span data-stu-id="f1c04-113">For more information about custom credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>

<span data-ttu-id="f1c04-114">Além disso, você deve criar um verificador de identidade personalizado e vinculá-lo a um elemento de associação de segurança em uma associação personalizada.</span><span class="sxs-lookup"><span data-stu-id="f1c04-114">In addition, you must create a custom identity verifier, and link it to a security binding element in a custom binding.</span></span> <span data-ttu-id="f1c04-115">Você também deve usar as credenciais personalizadas em vez das credenciais padrão.</span><span class="sxs-lookup"><span data-stu-id="f1c04-115">You must also use the custom credentials instead of the default credentials.</span></span>

<span data-ttu-id="f1c04-116">O diagrama a seguir mostra as classes envolvidas na associação personalizada e como o verificador de identidade personalizado está vinculado.</span><span class="sxs-lookup"><span data-stu-id="f1c04-116">The following diagram shows the classes involved in the custom binding, and how the custom identity verifier is linked.</span></span> <span data-ttu-id="f1c04-117">Há vários elementos de ligação envolvidos, todos herdados de <xref:System.ServiceModel.Channels.BindingElement>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-117">There are several binding elements involved, all of which inherit from <xref:System.ServiceModel.Channels.BindingElement>.</span></span> <span data-ttu-id="f1c04-118">O <xref:System.ServiceModel.Channels.AsymmetricSecurityBindingElement> tem a <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> Propriedade, que retorna uma instância do <xref:System.ServiceModel.Security.IdentityVerifier>, da qual `MyIdentityVerifier` é personalizado.</span><span class="sxs-lookup"><span data-stu-id="f1c04-118">The <xref:System.ServiceModel.Channels.AsymmetricSecurityBindingElement> has the <xref:System.ServiceModel.Channels.LocalClientSecuritySettings> property, which returns an instance of <xref:System.ServiceModel.Security.IdentityVerifier>, from which `MyIdentityVerifier` is customized.</span></span>

<span data-ttu-id="f1c04-119">![Gráfico mostrando um elemento de associação personalizado](./media/dddea4a2-0bb4-4921-9bf4-20d4d82c3da5.gif "dddea4a2-0bb4-4921-9bf4-20d4d82c3da5")</span><span class="sxs-lookup"><span data-stu-id="f1c04-119">![Chart showing a custom binding element](./media/dddea4a2-0bb4-4921-9bf4-20d4d82c3da5.gif "dddea4a2-0bb4-4921-9bf4-20d4d82c3da5")</span></span>

<span data-ttu-id="f1c04-120">Para obter mais informações sobre como criar um verificador de identidade personalizado, consulte Como: [Como: Crie um verificador](how-to-create-a-custom-client-identity-verifier.md)de identidade de cliente personalizado.</span><span class="sxs-lookup"><span data-stu-id="f1c04-120">For more information about creating a custom identity verifier, see How to: [How to: Create a Custom Client Identity Verifier](how-to-create-a-custom-client-identity-verifier.md).</span></span>

### <a name="to-use-separate-certificates-for-signing-and-encryption"></a><span data-ttu-id="f1c04-121">Para usar certificados separados para assinatura e criptografia</span><span class="sxs-lookup"><span data-stu-id="f1c04-121">To use separate certificates for signing and encryption</span></span>

1. <span data-ttu-id="f1c04-122">Defina uma nova classe de credenciais de cliente que herda <xref:System.ServiceModel.Description.ClientCredentials> da classe.</span><span class="sxs-lookup"><span data-stu-id="f1c04-122">Define a new client credentials class that inherits from the <xref:System.ServiceModel.Description.ClientCredentials> class.</span></span> <span data-ttu-id="f1c04-123">Implemente quatro novas propriedades para permitir a especificação de `ClientSigningCertificate`vários `ClientEncryptingCertificate`certificados `ServiceSigningCertificate`:, `ServiceEncryptingCertificate`, e.</span><span class="sxs-lookup"><span data-stu-id="f1c04-123">Implement four new properties to allow multiple certificates specification: `ClientSigningCertificate`, `ClientEncryptingCertificate`, `ServiceSigningCertificate`, and `ServiceEncryptingCertificate`.</span></span> <span data-ttu-id="f1c04-124">Além disso, <xref:System.ServiceModel.Description.ClientCredentials.CreateSecurityTokenManager%2A> substitua o método para retornar uma instância da <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> classe personalizada que é definida na próxima etapa.</span><span class="sxs-lookup"><span data-stu-id="f1c04-124">Also override the <xref:System.ServiceModel.Description.ClientCredentials.CreateSecurityTokenManager%2A> method to return an instance of the customized <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class that is defined in the next step.</span></span>

     [!code-csharp[c_FourCerts#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#1)]
     [!code-vb[c_FourCerts#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#1)]

2. <span data-ttu-id="f1c04-125">Defina um novo Gerenciador de token do Client Security que herda <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> da classe.</span><span class="sxs-lookup"><span data-stu-id="f1c04-125">Define a new client security token manager that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="f1c04-126">Substitua o <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> método para criar um provedor de token de segurança apropriado.</span><span class="sxs-lookup"><span data-stu-id="f1c04-126">Override the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> method to create an appropriate security token provider.</span></span> <span data-ttu-id="f1c04-127">O `requirement` parâmetro (a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>) fornece a direção da mensagem e o uso da chave.</span><span class="sxs-lookup"><span data-stu-id="f1c04-127">The `requirement` parameter (a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>) provides the message direction and key usage.</span></span>

     [!code-csharp[c_FourCerts#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#2)]
     [!code-vb[c_FourCerts#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#2)]

3. <span data-ttu-id="f1c04-128">Defina uma nova classe de credenciais de serviço que herda <xref:System.ServiceModel.Description.ServiceCredentials> da classe.</span><span class="sxs-lookup"><span data-stu-id="f1c04-128">Define a new service credentials class that inherits from the <xref:System.ServiceModel.Description.ServiceCredentials> class.</span></span> <span data-ttu-id="f1c04-129">Implemente quatro novas propriedades para permitir a especificação de `ClientSigningCertificate`vários `ClientEncryptingCertificate`certificados `ServiceSigningCertificate`:, `ServiceEncryptingCertificate`, e.</span><span class="sxs-lookup"><span data-stu-id="f1c04-129">Implement four new properties to allow multiple certificates specification: `ClientSigningCertificate`, `ClientEncryptingCertificate`, `ServiceSigningCertificate`, and `ServiceEncryptingCertificate`.</span></span> <span data-ttu-id="f1c04-130">Além disso, <xref:System.ServiceModel.Description.ServiceCredentials.CreateSecurityTokenManager%2A> substitua o método para retornar uma instância da <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager> classe personalizada que é definida na próxima etapa.</span><span class="sxs-lookup"><span data-stu-id="f1c04-130">Also override the <xref:System.ServiceModel.Description.ServiceCredentials.CreateSecurityTokenManager%2A> method to return an instance of the customized <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager> class that is defined in the next step.</span></span>

     [!code-csharp[c_FourCerts#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#3)]
     [!code-vb[c_FourCerts#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#3)]

4. <span data-ttu-id="f1c04-131">Defina um novo Gerenciador de token de segurança de serviço que <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager> herda da classe.</span><span class="sxs-lookup"><span data-stu-id="f1c04-131">Define a new service security token manager that inherits from the <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="f1c04-132">Substitua o <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> método para criar um provedor de token de segurança apropriado, considerando a direção da mensagem passada e o uso da chave.</span><span class="sxs-lookup"><span data-stu-id="f1c04-132">Override the <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager.CreateSecurityTokenProvider%2A> method to create an appropriate security token provider given the passed-in message direction and key usage.</span></span>

     [!code-csharp[c_FourCerts#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#4)]
     [!code-vb[c_FourCerts#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#4)]

### <a name="to-use-multiple-certificates-on-the-client"></a><span data-ttu-id="f1c04-133">Para usar vários certificados no cliente</span><span class="sxs-lookup"><span data-stu-id="f1c04-133">To use multiple certificates on the client</span></span>

1. <span data-ttu-id="f1c04-134">Crie uma associação personalizada.</span><span class="sxs-lookup"><span data-stu-id="f1c04-134">Create a custom binding.</span></span> <span data-ttu-id="f1c04-135">O elemento de associação de segurança deve operar no modo duplex para permitir que diferentes provedores de token de segurança estejam presentes para solicitações e respostas.</span><span class="sxs-lookup"><span data-stu-id="f1c04-135">The security binding element must operate in duplex mode to allow different security token providers to be present for requests and responses.</span></span> <span data-ttu-id="f1c04-136">Uma maneira de fazer isso é usar um transporte compatível com duplex ou usar o <xref:System.ServiceModel.Channels.CompositeDuplexBindingElement> , conforme mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="f1c04-136">One way to do this is to use a duplex-capable transport or to use the <xref:System.ServiceModel.Channels.CompositeDuplexBindingElement> as shown in the following code.</span></span> <span data-ttu-id="f1c04-137">Vincule o personalizado <xref:System.ServiceModel.Security.IdentityVerifier> que é definido na próxima etapa para o elemento de associação de segurança.</span><span class="sxs-lookup"><span data-stu-id="f1c04-137">Link the customized <xref:System.ServiceModel.Security.IdentityVerifier> which is defined in the next step to the security binding element.</span></span> <span data-ttu-id="f1c04-138">Substitua as credenciais de cliente padrão pelas credenciais de cliente personalizadas criadas anteriormente.</span><span class="sxs-lookup"><span data-stu-id="f1c04-138">Replace the default client credentials with the customized client credentials previously created.</span></span>

     [!code-csharp[c_FourCerts#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#5)]
     [!code-vb[c_FourCerts#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#5)]

2. <span data-ttu-id="f1c04-139">Defina um personalizado <xref:System.ServiceModel.Security.IdentityVerifier>.</span><span class="sxs-lookup"><span data-stu-id="f1c04-139">Define a custom <xref:System.ServiceModel.Security.IdentityVerifier>.</span></span> <span data-ttu-id="f1c04-140">O serviço tem várias identidades porque certificados diferentes são usados para criptografar a solicitação e para assinar a resposta.</span><span class="sxs-lookup"><span data-stu-id="f1c04-140">The service has multiple identities because different certificates are used to encrypt the request and to sign the response.</span></span>

    > [!NOTE]
    > <span data-ttu-id="f1c04-141">No exemplo a seguir, o verificador de identidade personalizado fornecido não executa nenhuma verificação de identidade de ponto de extremidade para fins de demonstração.</span><span class="sxs-lookup"><span data-stu-id="f1c04-141">In the following sample, the provided custom identity verifier does not perform any endpoint identity checking for demonstration purposes.</span></span> <span data-ttu-id="f1c04-142">Essa não é uma prática recomendada para o código de produção.</span><span class="sxs-lookup"><span data-stu-id="f1c04-142">This is not recommended practice for production code.</span></span>

     [!code-csharp[c_FourCerts#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#6)]
     [!code-vb[c_FourCerts#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#6)]

### <a name="to-use-multiple-certificates-on-the-service"></a><span data-ttu-id="f1c04-143">Para usar vários certificados no serviço</span><span class="sxs-lookup"><span data-stu-id="f1c04-143">To use multiple certificates on the service</span></span>

1. <span data-ttu-id="f1c04-144">Crie uma associação personalizada.</span><span class="sxs-lookup"><span data-stu-id="f1c04-144">Create a custom binding.</span></span> <span data-ttu-id="f1c04-145">O elemento de associação de segurança deve operar em um modo duplex para permitir que diferentes provedores de token de segurança estejam presentes para solicitações e respostas.</span><span class="sxs-lookup"><span data-stu-id="f1c04-145">The security binding element must operate in a duplex mode to allow different security token providers to be present for requests and responses.</span></span> <span data-ttu-id="f1c04-146">Assim como no cliente, use um transporte compatível com duplex ou use <xref:System.ServiceModel.Channels.CompositeDuplexBindingElement> , conforme mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="f1c04-146">As with the client, use a duplex-capable transport or use <xref:System.ServiceModel.Channels.CompositeDuplexBindingElement> as shown in the following code.</span></span> <span data-ttu-id="f1c04-147">Substitua as credenciais de serviço padrão pelas credenciais de serviço personalizadas criadas anteriormente.</span><span class="sxs-lookup"><span data-stu-id="f1c04-147">Replace the default service credentials with the customized service credentials previously created.</span></span>

     [!code-csharp[c_FourCerts#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_fourcerts/cs/source.cs#7)]
     [!code-vb[c_FourCerts#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_fourcerts/vb/source.vb#7)]

## <a name="see-also"></a><span data-ttu-id="f1c04-148">Consulte também</span><span class="sxs-lookup"><span data-stu-id="f1c04-148">See also</span></span>

- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>
- <xref:System.ServiceModel.Security.ServiceCredentialsSecurityTokenManager>
- <xref:System.ServiceModel.Security.IdentityVerifier>
- [<span data-ttu-id="f1c04-149">Passo a passo: Criando credenciais de cliente e de serviço personalizadas</span><span class="sxs-lookup"><span data-stu-id="f1c04-149">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
