---
title: Como criar um token personalizado
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: 2198d5548b09ba05eeb11466a6fd2d3a1262de94
ms.sourcegitcommit: 15109844229ade1c6449f48f3834db1b26907824
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/07/2018
ms.locfileid: "33809203"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="8d5b9-102">Como criar um token personalizado</span><span class="sxs-lookup"><span data-stu-id="8d5b9-102">How to: Create a Custom Token</span></span>
<span data-ttu-id="8d5b9-103">Este tópico mostra como criar um token de segurança personalizada usando o <xref:System.IdentityModel.Tokens.SecurityToken> classe e como integrá-lo com um provedor de token de segurança personalizada e um autenticador.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-103">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="8d5b9-104">Para obter um exemplo de código completo, consulte o [personalizado Token](../../../../docs/framework/wcf/samples/custom-token.md) exemplo.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-104">For a complete code example see the [Custom Token](../../../../docs/framework/wcf/samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="8d5b9-105">Um *token de segurança* é essencialmente um elemento XML que é usado pela estrutura de segurança do Windows Communication Foundation (WCF) para representar declarações sobre um remetente da mensagem SOAP.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-105">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="8d5b9-106">Segurança do WCF fornece vários tokens para modos de autenticação fornecidos pelo sistema.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-106">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="8d5b9-107">Os exemplos incluem um token de segurança de certificado x. 509 representado pelo <xref:System.IdentityModel.Tokens.X509SecurityToken> classe ou um token de segurança do nome de usuário representado pelo <xref:System.IdentityModel.Tokens.UserNameSecurityToken> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-107">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="8d5b9-108">Às vezes, um modo de autenticação ou credenciais não é suportado pelos tipos de fornecido.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-108">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="8d5b9-109">Nesse caso, é necessário criar um token de segurança personalizadas para fornecer uma representação XML da credencial personalizada dentro da mensagem SOAP.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-109">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="8d5b9-110">Os procedimentos a seguir mostram como criar um token de segurança personalizado e como integrá-lo com a infraestrutura de segurança do WCF.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-110">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="8d5b9-111">Este tópico cria um token de cartão de crédito que é usado para transmitir informações sobre cartão de crédito do cliente para o servidor.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-111">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="8d5b9-112">Para obter mais informações sobre credenciais personalizadas e Gerenciador de token de segurança, consulte [passo a passo: criação de cliente personalizadas e as credenciais de serviço](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-112">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="8d5b9-113">Consulte o <xref:System.IdentityModel.Tokens> namespace mais classes que representam os tokens de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-113">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
 <span data-ttu-id="8d5b9-114">Para obter mais informações sobre credenciais, o Gerenciador de token de segurança e classes de provedor e o autenticador, consulte [arquitetura de segurança](http://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-114">For more information about credentials, security token manager, and provider and authenticator classes, see [Security Architecture](http://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f).</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="8d5b9-115">Procedimentos</span><span class="sxs-lookup"><span data-stu-id="8d5b9-115">Procedures</span></span>  
 <span data-ttu-id="8d5b9-116">Um aplicativo cliente deve ser fornecido com uma maneira de especificar as informações de cartão de crédito para a infraestrutura de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="8d5b9-117">Essas informações ficam disponíveis para o aplicativo por uma classe de credenciais de cliente personalizadas.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="8d5b9-118">A primeira etapa é criar uma classe para representar as informações de cartão de crédito para credenciais personalizadas do cliente.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="8d5b9-119">Para criar uma classe que representa as informações de cartão de crédito dentro de credenciais de cliente</span><span class="sxs-lookup"><span data-stu-id="8d5b9-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1.  <span data-ttu-id="8d5b9-120">Defina uma nova classe que representa as informações de cartão de crédito para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="8d5b9-121">O exemplo a seguir chama a classe `CreditCardInfo`.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2.  <span data-ttu-id="8d5b9-122">Adicione propriedades adequadas para a classe para permitir que um aplicativo defina as informações necessárias para o token personalizado.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="8d5b9-123">Neste exemplo, a classe tem três propriedades: `CardNumber`, `CardIssuer`, e `ExpirationDate`.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="8d5b9-124">Em seguida, uma classe que representa o token de segurança personalizada deve ser criada.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="8d5b9-125">Essa classe é usada pelo provedor de token de segurança, autenticador e classes do serializador para passar informações sobre o token de segurança de e para a infraestrutura de segurança do WCF.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="8d5b9-126">Para criar uma classe de token de segurança personalizadas</span><span class="sxs-lookup"><span data-stu-id="8d5b9-126">To create a custom security token class</span></span>  
  
1.  <span data-ttu-id="8d5b9-127">Definir uma nova classe que deriva de <xref:System.IdentityModel.Tokens.SecurityToken> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="8d5b9-128">Este exemplo cria uma classe denominada `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2.  <span data-ttu-id="8d5b9-129">Substituir o <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> propriedade.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="8d5b9-130">Essa propriedade é usada para obter o identificador do token de segurança que é usado para apontar para a representação de XML de token de segurança de outros elementos dentro da mensagem SOAP.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="8d5b9-131">Neste exemplo, um identificador de token pode ser passado a ele como um parâmetro de construtor ou um novo aleatório é gerado sempre que uma instância de token de segurança é criada.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3.  <span data-ttu-id="8d5b9-132">Implemente a propriedade <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A>.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="8d5b9-133">Essa propriedade retorna uma coleção de chaves de segurança que representa a instância de token de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="8d5b9-134">Essas chaves podem ser usadas pelo WCF para assinar ou criptografar as partes da mensagem SOAP.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="8d5b9-135">Neste exemplo, o token de segurança do cartão de crédito não pode conter quaisquer chaves de segurança; Portanto, a implementação sempre retorna uma coleção vazia.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4.  <span data-ttu-id="8d5b9-136">Substituir o <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> e <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> propriedades.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="8d5b9-137">Essas propriedades são usadas pelo WCF para determinar a validade da instância de token de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="8d5b9-138">Neste exemplo, o token de segurança do cartão de crédito tem apenas uma data de validade, portanto, o `ValidFrom` propriedade retorna um <xref:System.DateTime> que representa a data e hora da criação de instância.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="8d5b9-139">Quando um segurança novo tipo de token é criado, ele requer uma implementação do <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="8d5b9-140">A implementação é usada na configuração de elemento de associação de segurança para representar o novo tipo de token.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="8d5b9-141">A classe de parâmetros de token de segurança serve como um modelo que é usado para corresponder a instância de token de segurança para quando uma mensagem é processada.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="8d5b9-142">O modelo fornece propriedades adicionais que um aplicativo pode usar para especificar critérios que o token de segurança deve corresponder para ser usado ou autenticado.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="8d5b9-143">O exemplo a seguir não adicione quaisquer propriedades adicionais, portanto, somente a segurança de tipo de token é correspondido quando a infraestrutura WCF procura por uma instância de token de segurança para usar ou para validar.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="8d5b9-144">Para criar uma classe de parâmetros de token de segurança personalizadas</span><span class="sxs-lookup"><span data-stu-id="8d5b9-144">To create a custom security token parameters class</span></span>  
  
1.  <span data-ttu-id="8d5b9-145">Definir uma nova classe que deriva de <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2.  <span data-ttu-id="8d5b9-146">Implementar o método de <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> .</span><span class="sxs-lookup"><span data-stu-id="8d5b9-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="8d5b9-147">Copie todos os campos internos definidos em sua classe, se houver.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="8d5b9-148">Esse exemplo define todos os campos adicionais.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-148">This example does not define any additional fields.</span></span>  
  
3.  <span data-ttu-id="8d5b9-149">Implementar o <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> propriedade somente leitura.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="8d5b9-150">Essa propriedade retorna `true` se o tipo de token de segurança representado por essa classe pode ser usado para autenticar um cliente para um serviço.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="8d5b9-151">Neste exemplo, o token de segurança do cartão de crédito pode ser usado para autenticar um cliente para um serviço.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4.  <span data-ttu-id="8d5b9-152">Implementar o <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> propriedade somente leitura.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="8d5b9-153">Essa propriedade retorna `true` se o tipo de token de segurança representado por essa classe pode ser usado para autenticar um serviço para um cliente.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="8d5b9-154">Neste exemplo, o token de segurança do cartão de crédito não pode ser usado para autenticar um serviço para um cliente.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5.  <span data-ttu-id="8d5b9-155">Implementar o <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> propriedade somente leitura.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="8d5b9-156">Essa propriedade retorna `true` se o tipo de token de segurança representado por essa classe pode ser mapeado para uma conta do Windows.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="8d5b9-157">Se assim, o resultado da autenticação é representado por um <xref:System.Security.Principal.WindowsIdentity> instância da classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="8d5b9-158">Neste exemplo, o token não pode ser mapeado para uma conta do Windows.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6.  <span data-ttu-id="8d5b9-159">Implementar o método de <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> .</span><span class="sxs-lookup"><span data-stu-id="8d5b9-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="8d5b9-160">Esse método é chamado pela estrutura de segurança do WCF quando ele exige uma referência para a instância de token de segurança representada por essa classe de parâmetros de token de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="8d5b9-161">A instância token de segurança e <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> que especifica o tipo de referência que está sendo solicitada são passados para este método como argumentos.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="8d5b9-162">Neste exemplo, somente referências internas são suportadas pelo token de segurança do cartão de crédito.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="8d5b9-163">O <xref:System.IdentityModel.Tokens.SecurityToken> classe possui a funcionalidade para criar referências internas; portanto, a implementação não requer código adicional.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7.  <span data-ttu-id="8d5b9-164">Implementar o método de <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> .</span><span class="sxs-lookup"><span data-stu-id="8d5b9-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="8d5b9-165">Este método é chamado pelo WCF para converter a instância de classe de parâmetros de token de segurança em uma instância de <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="8d5b9-166">O resultado é usado por provedores de token de segurança para criar a instância de token de segurança apropriado.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="8d5b9-167">Tokens de segurança são transmitidos em mensagens SOAP, que requer um mecanismo de conversão entre a representação de token de segurança na memória e a representação durante a transmissão.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="8d5b9-168">Para realizar essa tarefa, o WCF usa um serializador de token de segurança.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="8d5b9-169">Cada token personalizado deve ser acompanhado por um serializador de token de segurança personalizada que pode serializar e desserializar o token de segurança personalizada da mensagem SOAP.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="8d5b9-170">Chaves derivadas são habilitadas por padrão.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="8d5b9-171">Se você criar um token de segurança personalizado e usá-lo como o token primário, WCF uma chave dele derivado.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="8d5b9-172">Ao fazer isso, ele chama o serializador de token de segurança personalizadas para gravar o <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> para o token de segurança personalizada ao serializar o `DerivedKeyToken` para a transmissão.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="8d5b9-173">Na extremidade receptora, ao desserializar o token fora da conexão, o `DerivedKeyToken` serializador espera um `SecurityTokenReference` elemento como o filho de nível superior em si mesmo.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="8d5b9-174">Se o serializador de token de segurança personalizada não adicionou um `SecurityTokenReference` elemento durante a serialização de seu tipo de cláusula, uma exceção será lançada.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="8d5b9-175">Para criar um serializador de token de segurança personalizadas</span><span class="sxs-lookup"><span data-stu-id="8d5b9-175">To create a custom security token serializer</span></span>  
  
1.  <span data-ttu-id="8d5b9-176">Definir uma nova classe que deriva de <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2.  <span data-ttu-id="8d5b9-177">Substituir o <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> método, que se baseia em um <xref:System.Xml.XmlReader> para ler o fluxo XML.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="8d5b9-178">O método retorna `true` se a implementação de serializador pode desserializar o token de segurança com base em dado o elemento atual.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="8d5b9-179">Neste exemplo, esse método verifica se o leitor de XML atual do elemento XML tem o nome do elemento correto e o namespace.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="8d5b9-180">Se não existir, ele chama a implementação da classe base deste método para lidar com o elemento XML.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3.  <span data-ttu-id="8d5b9-181">Substituir o método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29>.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="8d5b9-182">Esse método lê o conteúdo XML do token de segurança e constrói a representação na memória apropriada para ele.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="8d5b9-183">Se não reconhece o elemento XML em que o leitor de XML passado está aguardando, ele chama a implementação da classe base para processar os tipos de token fornecido pelo sistema.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4.  <span data-ttu-id="8d5b9-184">Substituir o método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="8d5b9-185">Este método retorna `true` se ele puder converter a representação de token na memória (transmitida como um argumento) para a representação XML.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="8d5b9-186">Se ele não pode converter, ele chama a implementação da classe base.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5.  <span data-ttu-id="8d5b9-187">Substituir o método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="8d5b9-188">Este método converte uma representação de token de segurança na memória em uma representação XML.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="8d5b9-189">Se o método não pode converter, ele chama a implementação da classe base.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="8d5b9-190">Depois de concluir os procedimentos anteriores quatro, integre o token de segurança personalizada com o provedor de token de segurança, autenticador, Gerenciador e credenciais de cliente e de serviço.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="8d5b9-191">Para integrar o token de segurança personalizado com um provedor de token de segurança</span><span class="sxs-lookup"><span data-stu-id="8d5b9-191">To integrate the custom security token with a security token provider</span></span>  
  
1.  <span data-ttu-id="8d5b9-192">O provedor de token de segurança cria, modifica (se necessário) e retorna uma instância do token.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="8d5b9-193">Para criar um provedor personalizado para o token de segurança personalizada, crie uma classe que herda de <xref:System.IdentityModel.Selectors.SecurityTokenProvider> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="8d5b9-194">O exemplo a seguir substitui o <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> método para retornar uma instância do `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="8d5b9-195">Para obter mais informações sobre provedores de token de segurança personalizada, consulte [como: criar um provedor de Token de segurança personalizado](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="8d5b9-196">Para integrar o token de segurança personalizado com um autenticador de token de segurança</span><span class="sxs-lookup"><span data-stu-id="8d5b9-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1.  <span data-ttu-id="8d5b9-197">O autenticador de token de segurança valida o conteúdo do token de segurança quando ele é extraído da mensagem.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="8d5b9-198">Para criar um autenticador personalizado para o token de segurança personalizada, crie uma classe que herda de <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="8d5b9-199">O exemplo a seguir substitui o <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> método.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="8d5b9-200">Para obter mais informações sobre autenticadores de token de segurança personalizada, consulte [como: criar um autenticador de Token de segurança personalizado](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="8d5b9-201">Para integrar o token de segurança personalizado com um Gerenciador de token de segurança</span><span class="sxs-lookup"><span data-stu-id="8d5b9-201">To integrate the custom security token with a security token manager</span></span>  
  
1.  <span data-ttu-id="8d5b9-202">O Gerenciador de token de segurança cria o provedor de token apropriado, o autenticador de segurança e instâncias do serializador de token.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="8d5b9-203">Para criar um Gerenciador de token personalizado, crie uma classe que herda de <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="8d5b9-204">Os principais métodos de classe usam um <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> para criar o provedor apropriado e as credenciais de cliente ou serviço.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="8d5b9-205">Para obter mais informações sobre gerenciadores de token de segurança personalizada, consulte [passo a passo: criação de cliente personalizadas e as credenciais de serviço](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="8d5b9-206">Para integrar o token de segurança personalizada com credenciais de serviço e cliente personalizados</span><span class="sxs-lookup"><span data-stu-id="8d5b9-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1.  <span data-ttu-id="8d5b9-207">O cliente personalizadas e as credenciais de serviço devem ser adicionadas para fornecer uma API para o aplicativo permitir a especificação de informações do token personalizadas que são usadas pela infraestrutura de token de segurança personalizada criada anteriormente para fornecer e autenticar a segurança personalizada conteúdo do token.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="8d5b9-208">Os exemplos a seguir mostram como isso pode ser feito.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-208">The following samples show how this can be done.</span></span> <span data-ttu-id="8d5b9-209">Para obter mais informações sobre as credenciais de serviço e cliente personalizados, consulte [passo a passo: criação de cliente personalizadas e as credenciais de serviço](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="8d5b9-210">A classe de parâmetros de token de segurança personalizada criada anteriormente é usada para informar a estrutura de segurança do WCF que um token de segurança personalizada deve ser usado ao se comunicar com um serviço.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="8d5b9-211">O procedimento a seguir mostra como isso pode ser feito.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="8d5b9-212">Para integrar o token de segurança personalizado com a associação</span><span class="sxs-lookup"><span data-stu-id="8d5b9-212">To integrate the custom security token with the binding</span></span>  
  
1.  <span data-ttu-id="8d5b9-213">A classe de parâmetros de token de segurança personalizada deve ser especificada em uma das coleções de parâmetros de token que são expostas no <xref:System.ServiceModel.Channels.SecurityBindingElement> classe.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="8d5b9-214">O exemplo a seguir usa a coleção retornada pela `SignedEncrypted`.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="8d5b9-215">O código adiciona o token personalizado do cartão de crédito para cada mensagem enviada do cliente para o serviço com seu conteúdo automaticamente assinadas e criptografadas.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="8d5b9-216">Este tópico mostra as várias partes do código necessário para implementar e usar um token personalizado.</span><span class="sxs-lookup"><span data-stu-id="8d5b9-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="8d5b9-217">Para ver um exemplo completo de como todas essas partes do código se encaixam, consulte [personalizado Token](../../../../docs/framework/wcf/samples/custom-token.md).</span><span class="sxs-lookup"><span data-stu-id="8d5b9-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../../../../docs/framework/wcf/samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8d5b9-218">Consulte também</span><span class="sxs-lookup"><span data-stu-id="8d5b9-218">See Also</span></span>  
 <xref:System.IdentityModel.Tokens.SecurityToken>  
 <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>  
 <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>  
 <xref:System.IdentityModel.Selectors.SecurityTokenProvider>  
 <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>  
 <xref:System.IdentityModel.Policy.IAuthorizationPolicy>  
 <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>  
 <xref:System.IdentityModel.Selectors.SecurityTokenManager>  
 <xref:System.ServiceModel.Description.ClientCredentials>  
 <xref:System.ServiceModel.Description.ServiceCredentials>  
 <xref:System.ServiceModel.Channels.SecurityBindingElement>  
 [<span data-ttu-id="8d5b9-219">Passo a passo: criando credenciais de serviço e de cliente personalizados</span><span class="sxs-lookup"><span data-stu-id="8d5b9-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)  
 [<span data-ttu-id="8d5b9-220">Como criar um autenticador de token de segurança personalizado</span><span class="sxs-lookup"><span data-stu-id="8d5b9-220">How to: Create a Custom Security Token Authenticator</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-authenticator.md)  
 [<span data-ttu-id="8d5b9-221">Como criar um provedor de token de segurança personalizado</span><span class="sxs-lookup"><span data-stu-id="8d5b9-221">How to: Create a Custom Security Token Provider</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)  
 [<span data-ttu-id="8d5b9-222">Arquitetura de segurança</span><span class="sxs-lookup"><span data-stu-id="8d5b9-222">Security Architecture</span></span>](http://msdn.microsoft.com/library/16593476-d36a-408d-808c-ae6fd483e28f)
