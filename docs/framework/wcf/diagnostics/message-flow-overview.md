---
title: Visão geral de fluxo de mensagens
ms.date: 03/30/2017
ms.assetid: fb0899e1-84cc-4d90-b45b-dc5a50063943
ms.openlocfilehash: 0bfbd1523f1d5db4a94cf3af03a03779af14655d
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/07/2019
ms.locfileid: "70795970"
---
# <a name="message-flow-overview"></a><span data-ttu-id="cc93a-102">Visão geral de fluxo de mensagens</span><span class="sxs-lookup"><span data-stu-id="cc93a-102">Message Flow Overview</span></span>
<span data-ttu-id="cc93a-103">Em um sistema distribuído que contém serviços interconectados, é necessário determinar as relações de causal entre os serviços.</span><span class="sxs-lookup"><span data-stu-id="cc93a-103">In a distributed system containing interconnected services, it is necessary to determine causal relationships between the services.</span></span> <span data-ttu-id="cc93a-104">É importante entender os vários componentes que faziam parte de um fluxo de solicitação para dar suporte a cenários críticos, como monitoramento de integridade, solução de problemas e análise de causa raiz.</span><span class="sxs-lookup"><span data-stu-id="cc93a-104">It is important to understand the various components that were part of a request flow to support critical scenarios such as health monitoring, troubleshooting, and root cause analysis.</span></span> <span data-ttu-id="cc93a-105">Para habilitar a correlação de rastreamentos entre vários serviços, no .NET Framework 4, adicionamos suporte por meio dos seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="cc93a-105">To enable the correlation of traces between various services, in the .NET Framework 4 we added support through the following features:</span></span>

- <span data-ttu-id="cc93a-106">Rastreamento analítico: Um recurso de rastreamento de alto desempenho e baixo nível baixo usando o ETW (rastreamento de eventos para Windows).</span><span class="sxs-lookup"><span data-stu-id="cc93a-106">Analytic tracing: A high performance and low verbosity tracing feature using Event Tracing for Windows (ETW).</span></span>

- <span data-ttu-id="cc93a-107">Modelo de atividade de ponta a ponta para serviços WCF/WF: Esse recurso dá suporte à correlação de rastreamentos <xref:System.ServiceModel> gerados <xref:System.Workflow.ComponentModel> pelos namespaces e.</span><span class="sxs-lookup"><span data-stu-id="cc93a-107">End-to-end activity model for WCF/WF services: This feature supports correlation of traces generated by the <xref:System.ServiceModel> and <xref:System.Workflow.ComponentModel> namespaces.</span></span>

- <span data-ttu-id="cc93a-108">Rastreamento de ETW para WF: Esse recurso usa registros de rastreamento gerados pelos serviços do WF para fornecer visibilidade do estado atual do fluxo de trabalho e do andamento.</span><span class="sxs-lookup"><span data-stu-id="cc93a-108">ETW tracking for WF: This feature uses tracking records generated by WF services to provide visibility into the workflow’s current state and progress.</span></span>

 <span data-ttu-id="cc93a-109">Os erros registrados em um registro rastreamento ou rastreamento podem ser usados para encontrar defeitos de código ou mensagens formadas incorretamente.</span><span class="sxs-lookup"><span data-stu-id="cc93a-109">Errors logged in a tracking or tracing record can be used to find code defects or incorrectly formed messages.</span></span> <span data-ttu-id="cc93a-110">A propriedade ActivityId do nó de correlação no cabeçalho da mensagem do evento pode ser usada para determinar a atividade com falha.</span><span class="sxs-lookup"><span data-stu-id="cc93a-110">The ActivityId property of the Correlation node in the event’s message header can be used to determine the faulting activity.</span></span> <span data-ttu-id="cc93a-111">Para habilitar o rastreamento de fluxo de mensagens por ID de atividade, consulte [Configurando o rastreamento de fluxo de mensagens](./etw/configuring-message-flow-tracing.md).</span><span class="sxs-lookup"><span data-stu-id="cc93a-111">To enable message flow tracing by activity ID, see [Configuring Message Flow Tracing](./etw/configuring-message-flow-tracing.md).</span></span> <span data-ttu-id="cc93a-112">Este tópico demonstra como habilitar o rastreamento de fluxo de mensagens no projeto criado no tutorial de Introdução.</span><span class="sxs-lookup"><span data-stu-id="cc93a-112">This topic demonstrates how to enable message flow tracing in the project created in the Getting Started tutorial.</span></span>

### <a name="to-enable-message-flow-tracing-in-the-getting-started-tutorial"></a><span data-ttu-id="cc93a-113">Para habilitar o rastreamento de fluxo de mensagens no tutorial de Introdução</span><span class="sxs-lookup"><span data-stu-id="cc93a-113">To enable message flow tracing in the Getting Started tutorial</span></span>

1. <span data-ttu-id="cc93a-114">Abra Visualizador de Eventos clicando em **Iniciar**, **executar**e inserindo `eventvwr.exe`.</span><span class="sxs-lookup"><span data-stu-id="cc93a-114">Open Event Viewer by clicking **Start**, **Run**, and entering `eventvwr.exe`.</span></span>

2. <span data-ttu-id="cc93a-115">Se você não tiver habilitado o rastreamento analítico, expanda **logs de aplicativos e serviços**, **Microsoft**, **Windows**, **servidor de aplicativos-aplicativos**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-115">If you haven’t enabled analytic tracing, expand **Applications and Services Logs**, **Microsoft**, **Windows**, **Application Server-Applications**.</span></span> <span data-ttu-id="cc93a-116">Selecione **Exibir**, **Mostrar logs analíticos e de depuração**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-116">Select **View**, **Show Analytic and Debug Logs**.</span></span> <span data-ttu-id="cc93a-117">Clique com o botão direito do mouse em **analítica** e selecione **habilitar log**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-117">Right-click **Analytic** and select **Enable Log**.</span></span> <span data-ttu-id="cc93a-118">Deixe Visualizador de Eventos aberto para que os rastreamentos possam ser exibidos.</span><span class="sxs-lookup"><span data-stu-id="cc93a-118">Leave Event Viewer open so that traces can be viewed.</span></span>

3. <span data-ttu-id="cc93a-119">Abra o exemplo criado no [tutorial de introdução](../getting-started-tutorial.md) no Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="cc93a-119">Open the sample created in the [Getting Started Tutorial](../getting-started-tutorial.md) in Visual Studio 2012.</span></span> <span data-ttu-id="cc93a-120">Observe que você deve executar o Visual Studio 2012 como administrador para que o serviço possa ser criado.</span><span class="sxs-lookup"><span data-stu-id="cc93a-120">Note that you must run Visual Studio 2012 as an administrator so that the service can be created.</span></span> <span data-ttu-id="cc93a-121">Se você tiver os exemplos do WCF instalados, poderá abrir o [introdução](../samples/getting-started-sample.md), que contém o projeto concluído criado no tutorial.</span><span class="sxs-lookup"><span data-stu-id="cc93a-121">If you have the WCF samples installed, you can open the [Getting Started](../samples/getting-started-sample.md), which contains the completed project created in the tutorial.</span></span>

4. <span data-ttu-id="cc93a-122">Clique com o botão direito do mouse no projeto de **serviço** e selecione **Adicionar**, **novo item**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-122">Right-click the **Service** project and select **Add**, **New Item**.</span></span> <span data-ttu-id="cc93a-123">Selecione o **arquivo de configuração do aplicativo** e clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-123">Select **Application Configuration File** and click **OK**.</span></span>

5. <span data-ttu-id="cc93a-124">Adicione o código a seguir ao arquivo app. config criado na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="cc93a-124">Add the following code to the App.Config file created in the previous step.</span></span>

    ```xml
    <system.serviceModel>
      <diagnostics>
        <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
      </diagnostics>
    </system.serviceModel>
    ```

6. <span data-ttu-id="cc93a-125">Execute o aplicativo de servidor sem depuração pressionando CTRL + F5.</span><span class="sxs-lookup"><span data-stu-id="cc93a-125">Execute the server application without debugging by pressing CTRL+F5.</span></span> <span data-ttu-id="cc93a-126">Execute o projeto cliente clicando com o botão direito do mouse no projeto **cliente** e selecionando **depurar**, **Iniciar nova instância**.</span><span class="sxs-lookup"><span data-stu-id="cc93a-126">Execute the client project by right-clicking the **Client** project and selecting **Debug**, **Start New Instance**.</span></span>

7. <span data-ttu-id="cc93a-127">Para rastrear os eventos do cliente para o servidor, adicione o seguinte ao arquivo de configuração do aplicativo no projeto do cliente.</span><span class="sxs-lookup"><span data-stu-id="cc93a-127">To trace the events from the client to the server, add the following to the application configuration file in the Client project.</span></span>

    ```xml
    <diagnostics>
      <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
    </diagnostics>
    ```

8. <span data-ttu-id="cc93a-128">Em Program.cs no cliente, adicione a seguinte instrução using.</span><span class="sxs-lookup"><span data-stu-id="cc93a-128">In Program.cs in the client, add the following Using statement.</span></span>

    ```csharp
    using System.Diagnostics;
    ```

9. <span data-ttu-id="cc93a-129">No método principal no arquivo program.cs no projeto cliente, defina o GUID de rastreamento a ser propagado no log de eventos.</span><span class="sxs-lookup"><span data-stu-id="cc93a-129">In the Main method in the program.cs file in the client project, set the Trace GUID to be propagated in the event log.</span></span>

    ```csharp
    Guid guid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = guid;
    ```

10. <span data-ttu-id="cc93a-130">Atualize e examine o log **analítico** .</span><span class="sxs-lookup"><span data-stu-id="cc93a-130">Refresh and examine the **Analytic**  log.</span></span>  <span data-ttu-id="cc93a-131">Procure um evento com a ID de evento 220.</span><span class="sxs-lookup"><span data-stu-id="cc93a-131">Look for an event with Event ID 220.</span></span>  <span data-ttu-id="cc93a-132">Selecione o evento e clique na guia **detalhes** no painel de visualização.</span><span class="sxs-lookup"><span data-stu-id="cc93a-132">Select the event, and click the **Details** tab in the preview pane.</span></span> <span data-ttu-id="cc93a-133">Esse evento conterá a ID de correlação para a atividade de chamada.</span><span class="sxs-lookup"><span data-stu-id="cc93a-133">This event will contain the correlation ID for the calling activity.</span></span>

    ```xml
    <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" />
    ```

    > [!NOTE]
    > <span data-ttu-id="cc93a-134">Todos os eventos com o mesmo GUID na ActivityId estão relacionados a uma solicitação.</span><span class="sxs-lookup"><span data-stu-id="cc93a-134">All events with the same GUID in the ActivityID are related to one request.</span></span> <span data-ttu-id="cc93a-135">Isso pode ser usado para correlacionar mensagens de um cliente específico a um serviço específico.</span><span class="sxs-lookup"><span data-stu-id="cc93a-135">This can be used to correlate messages from a specific client to a specific service.</span></span> <span data-ttu-id="cc93a-136">Se o cliente tiver chamado outro serviço, o mesmo cliente poderá ser identificado por ActivityId.</span><span class="sxs-lookup"><span data-stu-id="cc93a-136">If the client called another service, then the same client could be identified by ActivityID.</span></span>

11. <span data-ttu-id="cc93a-137">Em alguns casos, o ActivityId pode ser alterado do GUID original para um novo ActivityId.</span><span class="sxs-lookup"><span data-stu-id="cc93a-137">In some cases, the ActivityID can change from the original GUID to a new ActivityID.</span></span> <span data-ttu-id="cc93a-138">Nesse caso, um evento de transferência é emitido.</span><span class="sxs-lookup"><span data-stu-id="cc93a-138">In that case, a transfer event is emitted.</span></span> <span data-ttu-id="cc93a-139">Essa ID de evento é 499 e o evento conterá os dados a seguir no cabeçalho.</span><span class="sxs-lookup"><span data-stu-id="cc93a-139">This event ID is 499, and the event will contain the following data in the header.</span></span>

    ```xml
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
        <System>
            <Provider Name="Microsoft-Windows-Application Server-Applications" Guid="{c651f5f6-1c0d-492e-8ae1-b4efd7c9d503}" />
            <EventID>499</EventID>
            ...
            <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" RelatedActivityID="{85FC0930-9C49-42DA-804B-A7368104BD1B}" />
            ...
       </System>
    </Event>
    ```

    > [!NOTE]
    > <span data-ttu-id="cc93a-140">O evento de transferência registra a alteração do ActivityId ativo do GUID especificado como ActivityId para o GUID especificado como RelatedActivityID.</span><span class="sxs-lookup"><span data-stu-id="cc93a-140">The transfer event records the change of the active ActivityID from the GUID specified as the ActivityID to the GUID specified as RelatedActivityID.</span></span> <span data-ttu-id="cc93a-141">Depois que o evento de transferência for emitido, todos os eventos conterão o novo GUID como ActivityId.</span><span class="sxs-lookup"><span data-stu-id="cc93a-141">After the transfer event is emitted, all events will contain the new GUID as the ActivityID.</span></span>
