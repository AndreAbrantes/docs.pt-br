---
title: Emitindo traços de código de usuário
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: 18b424139f4c1656193f80cf76c704af2b2887e3
ms.sourcegitcommit: 15109844229ade1c6449f48f3834db1b26907824
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/07/2018
ms.locfileid: "33807115"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="e8143-102">Emitindo traços de código de usuário</span><span class="sxs-lookup"><span data-stu-id="e8143-102">Emitting User-Code Traces</span></span>
<span data-ttu-id="e8143-103">Além de habilitar o rastreamento na configuração para coletar dados de instrumentação gerados pelo Windows Communication Foundation (WCF), você também pode emitir rastreamentos programaticamente no código do usuário.</span><span class="sxs-lookup"><span data-stu-id="e8143-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="e8143-104">Dessa forma, você pode criar proativamente dados de instrumentação que você pode examinar posteriormente para fins de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="e8143-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="e8143-105">Este tópico discute como você pode fazer isso.</span><span class="sxs-lookup"><span data-stu-id="e8143-105">This topic discusses how you can do this.</span></span>  
  
 <span data-ttu-id="e8143-106">Além disso, o [estendendo rastreamento](../../../../../docs/framework/wcf/samples/extending-tracing.md) exemplo inclui todo o código demonstrado nas seções a seguir.</span><span class="sxs-lookup"><span data-stu-id="e8143-106">In addition, the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>  
  
## <a name="creating-a-trace-source"></a><span data-ttu-id="e8143-107">Criação de uma origem de rastreamento</span><span class="sxs-lookup"><span data-stu-id="e8143-107">Creating a Trace Source</span></span>  
 <span data-ttu-id="e8143-108">Você pode usar o código a seguir para criar uma fonte de rastreamento do usuário.</span><span class="sxs-lookup"><span data-stu-id="e8143-108">You can use the following code to create a user trace source.</span></span>  
  
```  
TraceSource ts = new TraceSource("myUserTraceSource");  
```  
  
## <a name="creating-activities"></a><span data-ttu-id="e8143-109">Criação de atividades</span><span class="sxs-lookup"><span data-stu-id="e8143-109">Creating Activities</span></span>  
 <span data-ttu-id="e8143-110">As atividades são a unidade lógica de processamento.</span><span class="sxs-lookup"><span data-stu-id="e8143-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="e8143-111">Você pode criar uma atividade para cada unidade de processamento principal no qual você deseja que os rastreamentos são agrupados.</span><span class="sxs-lookup"><span data-stu-id="e8143-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="e8143-112">Por exemplo, você pode criar uma atividade para cada solicitação para o serviço.</span><span class="sxs-lookup"><span data-stu-id="e8143-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="e8143-113">Para fazer isso, execute as etapas a seguir.</span><span class="sxs-lookup"><span data-stu-id="e8143-113">To do so, perform the following steps.</span></span>  
  
1.  <span data-ttu-id="e8143-114">Salve a ID de atividade no escopo.</span><span class="sxs-lookup"><span data-stu-id="e8143-114">Save the activity ID in scope.</span></span>  
  
2.  <span data-ttu-id="e8143-115">Criar uma nova ID de atividade.</span><span class="sxs-lookup"><span data-stu-id="e8143-115">Create a new activity ID.</span></span>  
  
3.  <span data-ttu-id="e8143-116">Transferência da atividade no escopo para a nova, defina a nova atividade no escopo e emitir um rastreamento de início para a atividade.</span><span class="sxs-lookup"><span data-stu-id="e8143-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>  
  
 <span data-ttu-id="e8143-117">O código a seguir demonstra como fazer isso.</span><span class="sxs-lookup"><span data-stu-id="e8143-117">The following code demonstrates how to do this.</span></span>  
  
```  
Guid oldID = Trace.CorrelationManager.ActivityId;  
Guid traceID = Guid.NewGuid();  
ts.TraceTransfer(0, "transfer", traceID);  
Trace.CorrelationManager.ActivityId = traceID; // Trace is static  
ts.TraceEvent(TraceEventType.Start, 0, "Add request");  
```  
  
## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="e8143-118">Emitindo traços de dentro de uma atividade de usuário</span><span class="sxs-lookup"><span data-stu-id="e8143-118">Emitting Traces within a User Activity</span></span>  
 <span data-ttu-id="e8143-119">O código a seguir emite rastreamentos em uma atividade de usuário.</span><span class="sxs-lookup"><span data-stu-id="e8143-119">The following code emits traces within a user activity.</span></span>  
  
```  
double value1 = 100.00D;  
double value2 = 15.99D;  
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);  
double result = client.Add(value1, value2);  
ts.TraceInformation("Client receives Add response '" + result + "'");  
```  
  
## <a name="stopping-the-activities"></a><span data-ttu-id="e8143-120">Parar as atividades</span><span class="sxs-lookup"><span data-stu-id="e8143-120">Stopping the Activities</span></span>  
 <span data-ttu-id="e8143-121">Para interromper as atividades, transferir de volta para a antiga atividade, parar a id da atividade atual e redefinir a id da atividade anterior no escopo.</span><span class="sxs-lookup"><span data-stu-id="e8143-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>  
  
 <span data-ttu-id="e8143-122">O código a seguir demonstra como fazer isso.</span><span class="sxs-lookup"><span data-stu-id="e8143-122">The following code demonstrates how to do this.</span></span>  
  
```  
ts.TraceTransfer(0, "transfer", oldID);  
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");  
Trace.CorrelationManager.ActivityId = oldID;  
```  
  
## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="e8143-123">Propagando a ID de atividade a um serviço</span><span class="sxs-lookup"><span data-stu-id="e8143-123">Propagating the Activity ID to A Service</span></span>  
 <span data-ttu-id="e8143-124">Se você definir o `propagateActivity` atributo `true` para o `System.ServiceModel` arquivos de origem do rastreamento na configuração de serviço e o cliente, o serviço de processamento de solicitação para adicionar ocorre na mesma atividade como definido no cliente.</span><span class="sxs-lookup"><span data-stu-id="e8143-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="e8143-125">Se o serviço define suas próprias atividades e transferências, os rastreamentos de serviço não aparecem na atividade propagadas pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="e8143-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="e8143-126">Em vez disso, eles aparecem em uma atividade correlacionada por rastreamentos de transferência para a atividade cuja ID é propagada pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="e8143-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8143-127">Se o `propagateActivity` atributo é definido como `true` no cliente e no serviço, a atividade de ambiente no escopo de operação do serviço é definida pelo WCF.</span><span class="sxs-lookup"><span data-stu-id="e8143-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>  
  
 <span data-ttu-id="e8143-128">Você pode usar o código a seguir para verificar se uma atividade foi definida no escopo pelo WCF.</span><span class="sxs-lookup"><span data-stu-id="e8143-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>  
  
```  
// Check if an activity was set in scope by WCF, if it was   
// propagated from the client. If not, ( ambient activity is   
// equal to Guid.Empty), create a new one.  
if(Trace.CorrelationManager.ActivityId == Guid.Empty)  
{  
    Guid newGuid = Guid.NewGuid();  
    Trace.CorrelationManager.ActivityId = newGuid;  
}  
// Emit your Start trace.  
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");  
  
// Emit the processing traces for that request.  
serviceTs.TraceInformation("Service receives Add "   
                            + n1 + ", " + n2);  
// double result = n1 + n2;  
serviceTs.TraceInformation("Service sends Add result" + result);  
  
// Emit the Stop trace and exit the method scope.  
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");  
// return result;  
```  
  
## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="e8143-129">Exceções geradas no código de rastreamento</span><span class="sxs-lookup"><span data-stu-id="e8143-129">Tracing Exceptions Thrown in Code</span></span>  
 <span data-ttu-id="e8143-130">Quando você gera uma exceção no código, você também pode rastrear a exceção no nível de aviso ou usando o código a seguir.</span><span class="sxs-lookup"><span data-stu-id="e8143-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>  
  
```  
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");  
```  
  
## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="e8143-131">Exibindo rastreamentos de usuário na ferramenta de Visualizador de rastreamento de serviço</span><span class="sxs-lookup"><span data-stu-id="e8143-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>  
 <span data-ttu-id="e8143-132">Esta seção contém capturas de tela de rastreamentos gerados pela execução de [estendendo rastreamento](../../../../../docs/framework/wcf/samples/extending-tracing.md) de exemplo, quando exibido usando o [ferramenta de Visualizador de rastreamento de serviço (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="e8143-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>  
  
 <span data-ttu-id="e8143-133">O diagrama a seguir, a atividade de "Solicitação para adicionar" criada anteriormente está selecionada no painel esquerdo.</span><span class="sxs-lookup"><span data-stu-id="e8143-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="e8143-134">Ele é listado com três outros matemática atividades de operação (divisão, subtrair, multiplicar) que constituem o programa de cliente de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="e8143-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="e8143-135">O código do usuário tiver definido uma nova atividade para cada operação isolar possíveis ocorrências do erro nas solicitações diferentes.</span><span class="sxs-lookup"><span data-stu-id="e8143-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>  
  
 <span data-ttu-id="e8143-136">Para demonstrar o uso de transferências no [estendendo rastreamento](../../../../../docs/framework/wcf/samples/extending-tracing.md) exemplo, uma atividade de cálculo que encapsula as solicitações de quatro operação também é criada.</span><span class="sxs-lookup"><span data-stu-id="e8143-136">To demonstrate the use of transfers in the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="e8143-137">Para cada solicitação, há uma transferência de e para trás da atividade de cálculo para a atividade de solicitação (o rastreamento é realçado no painel superior à direita na figura).</span><span class="sxs-lookup"><span data-stu-id="e8143-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>  
  
 <span data-ttu-id="e8143-138">Quando você seleciona uma atividade no painel esquerdo, os rastreamentos incluídos por esta atividade são mostrados no painel superior direito.</span><span class="sxs-lookup"><span data-stu-id="e8143-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="e8143-139">Se `propagateActivity` é `true` em cada ponto de extremidade no caminho da solicitação, os rastreamentos na atividade de solicitação são de todos os processos que participam da solicitação.</span><span class="sxs-lookup"><span data-stu-id="e8143-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="e8143-140">Neste exemplo, você pode ver os rastreamentos do cliente e de serviço na coluna 4º no painel.</span><span class="sxs-lookup"><span data-stu-id="e8143-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>  
  
 <span data-ttu-id="e8143-141">Essa atividade mostra a seguinte ordem de processamento:</span><span class="sxs-lookup"><span data-stu-id="e8143-141">This activity shows the following order of processing:</span></span>  
  
1.  <span data-ttu-id="e8143-142">Cliente envia a mensagem a ser adicionada.</span><span class="sxs-lookup"><span data-stu-id="e8143-142">Client sends message to Add.</span></span>  
  
2.  <span data-ttu-id="e8143-143">Serviço recebe a mensagem de solicitação de adicionar.</span><span class="sxs-lookup"><span data-stu-id="e8143-143">Service receives Add request message.</span></span>  
  
3.  <span data-ttu-id="e8143-144">Serviço envia a resposta de adicionar.</span><span class="sxs-lookup"><span data-stu-id="e8143-144">Service sends Add response.</span></span>  
  
4.  <span data-ttu-id="e8143-145">Cliente recebe a resposta de adicionar.</span><span class="sxs-lookup"><span data-stu-id="e8143-145">Client receives Add response.</span></span>  
  
 <span data-ttu-id="e8143-146">Todos os rastreamentos foram emitidos no nível de informações.</span><span class="sxs-lookup"><span data-stu-id="e8143-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="e8143-147">Clicar em um rastreamento no painel superior direito mostra os detalhes do que o rastreamento no painel inferior direito.</span><span class="sxs-lookup"><span data-stu-id="e8143-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>  
  
 <span data-ttu-id="e8143-148">No diagrama a seguir, podemos também ver rastreamentos de transferência de e para a atividade de cálculo, bem como dois pares de iniciar e parar rastreamentos por atividade de solicitação, um para o cliente e um para o serviço (uma para cada fonte de rastreamento).</span><span class="sxs-lookup"><span data-stu-id="e8143-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>  
  
 <span data-ttu-id="e8143-149">![Visualizador de rastreamento: Emitindo usuário&#45;rastreamentos de código](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span><span class="sxs-lookup"><span data-stu-id="e8143-149">![Trace Viewer: Emitting User&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span></span>  
<span data-ttu-id="e8143-150">Lista de atividades por hora de criação (painel esquerdo) e suas atividades aninhadas (painel superior direito)</span><span class="sxs-lookup"><span data-stu-id="e8143-150">List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>  
  
 <span data-ttu-id="e8143-151">Se o código de serviço gera uma exceção que faz com que o cliente lançar também (por exemplo, quando o cliente não obteve resposta à sua solicitação), o serviço e cliente de aviso ou mensagens de erro ocorrerem na mesma atividade de correlação direta.</span><span class="sxs-lookup"><span data-stu-id="e8143-151">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="e8143-152">No diagrama a seguir, o serviço gera uma exceção indicando "o serviço se recusa a processar essa solicitação no código do usuário."</span><span class="sxs-lookup"><span data-stu-id="e8143-152">In the following diagram, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="e8143-153">O cliente também gera uma exceção que declara que "o servidor não pôde processar a solicitação devido a um erro interno."</span><span class="sxs-lookup"><span data-stu-id="e8143-153">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>  
  
 <span data-ttu-id="e8143-154">![Usando o Visualizador de rastreamento para emitir usuário&#45;rastreamentos de código](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span><span class="sxs-lookup"><span data-stu-id="e8143-154">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span></span>  
<span data-ttu-id="e8143-155">Erros em pontos de extremidade para uma determinada solicitação serão exibidos na mesma atividade se a id de atividade de solicitação foi propagada</span><span class="sxs-lookup"><span data-stu-id="e8143-155">Errors across endpoints for a given request appear in the same activity if the request activity id was propagated</span></span>  
  
 <span data-ttu-id="e8143-156">Clicando duas vezes o multiplicar atividade no painel à esquerda mostra o gráfico a seguir, com os rastreamentos da multiplicação de atividade para cada processo envolvido.</span><span class="sxs-lookup"><span data-stu-id="e8143-156">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="e8143-157">Podemos ver que um aviso ocorreu primeiro o serviço (exceção lançada), que é seguido por erros e avisos no cliente porque não foi possível processar a solicitação.</span><span class="sxs-lookup"><span data-stu-id="e8143-157">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="e8143-158">Portanto, podemos implica a relação de erro causal entre pontos de extremidade e derivar a causa do erro.</span><span class="sxs-lookup"><span data-stu-id="e8143-158">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>  
  
 <span data-ttu-id="e8143-159">![Usando o Visualizador de rastreamento para emitir usuário&#45;rastreamentos de código](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span><span class="sxs-lookup"><span data-stu-id="e8143-159">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span></span>  
<span data-ttu-id="e8143-160">Modo de exibição de gráfico de correlação de erro</span><span class="sxs-lookup"><span data-stu-id="e8143-160">Graph view of error correlation</span></span>  
  
 <span data-ttu-id="e8143-161">Para obter os rastreamentos anteriores, definimos `ActivityTracing` para as fontes de rastreamento de usuário e `propagateActivity=true` para o `System.ServiceModel` origem do rastreamento.</span><span class="sxs-lookup"><span data-stu-id="e8143-161">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="e8143-162">Nós não definimos `ActivityTracing` para o `System.ServiceModel` origem de rastreamento para habilitar o código de usuário a propagação de atividade de código do usuário.</span><span class="sxs-lookup"><span data-stu-id="e8143-162">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="e8143-163">(Ao rastreamento de atividades de ServiceModel está ativado, a ID de atividade definida no cliente não será propagada para o código de usuário do serviço; No entanto, transferências, correlacionam as atividades de código de usuário cliente e de serviço para as atividades do WCF intermediárias.)</span><span class="sxs-lookup"><span data-stu-id="e8143-163">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>  
  
 <span data-ttu-id="e8143-164">Definir atividades e propagação a ID de atividade nos permitem realizar correlação erro direto entre pontos de extremidade.</span><span class="sxs-lookup"><span data-stu-id="e8143-164">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="e8143-165">Dessa forma, pode localizar a causa de um erro mais rapidamente.</span><span class="sxs-lookup"><span data-stu-id="e8143-165">In this way, we can locate the root cause of an error more quickly.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e8143-166">Consulte também</span><span class="sxs-lookup"><span data-stu-id="e8143-166">See Also</span></span>  
 [<span data-ttu-id="e8143-167">Estendendo o rastreamento</span><span class="sxs-lookup"><span data-stu-id="e8143-167">Extending Tracing</span></span>](../../../../../docs/framework/wcf/samples/extending-tracing.md)
