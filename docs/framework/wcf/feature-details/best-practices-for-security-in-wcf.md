---
title: Práticas recomendadas para segurança no WCF
ms.custom: ''
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: ''
ms.suite: ''
ms.technology:
- dotnet-clr
ms.tgt_pltfrm: ''
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- best practices [WCF], security
ms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69
caps.latest.revision: 19
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.workload:
- dotnet
ms.openlocfilehash: 19bb6d4a172568611f73e3a50d0c526016c65aac
ms.sourcegitcommit: 03ee570f6f528a7d23a4221dcb26a9498edbdf8c
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/28/2018
---
# <a name="best-practices-for-security-in-wcf"></a><span data-ttu-id="3cea5-102">Práticas recomendadas para segurança no WCF</span><span class="sxs-lookup"><span data-stu-id="3cea5-102">Best Practices for Security in WCF</span></span>
<span data-ttu-id="3cea5-103">As seções a seguir listam as práticas recomendadas a serem considerados durante a criação de aplicativos seguros usando [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3cea5-103">The following sections list the best practices to consider when creating secure applications using [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)].</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="3cea5-104"> segurança, consulte [considerações de segurança](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [considerações de segurança para dados](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md), e [considerações de segurança com metadados](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="3cea5-104"> security, see [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md), and [Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md).</span></span>  
  
## <a name="identify-services-performing-windows-authentication-with-spns"></a><span data-ttu-id="3cea5-105">Identificar os serviços para executar a autenticação do Windows com os SPNs</span><span class="sxs-lookup"><span data-stu-id="3cea5-105">Identify Services Performing Windows Authentication with SPNs</span></span>  
 <span data-ttu-id="3cea5-106">Os serviços podem ser identificados com nomes principais de usuário (UPNs) ou nomes principais de serviço (SPNs).</span><span class="sxs-lookup"><span data-stu-id="3cea5-106">Services can be identified with either user principal names (UPNs) or service principal names (SPNs).</span></span> <span data-ttu-id="3cea5-107">Serviços executados em contas de computador como serviço de rede tem uma identidade SPN correspondente para o computador que está sendo executado.</span><span class="sxs-lookup"><span data-stu-id="3cea5-107">Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running.</span></span> <span data-ttu-id="3cea5-108">Serviços executados em contas de usuário tem uma identidade UPN correspondente para o usuário que está sendo executado, embora o `setspn` ferramenta pode ser usada para atribuir um SPN para a conta de usuário.</span><span class="sxs-lookup"><span data-stu-id="3cea5-108">Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account.</span></span> <span data-ttu-id="3cea5-109">Configurar um serviço para que ele possa ser identificado por meio de SPN e configurar os clientes que se conectar ao serviço para usar esse SPN pode fazer certas ataques mais difícil.</span><span class="sxs-lookup"><span data-stu-id="3cea5-109">Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult.</span></span> <span data-ttu-id="3cea5-110">Essas diretrizes se aplicam às associações usando Kerberos ou SSPI negociação.</span><span class="sxs-lookup"><span data-stu-id="3cea5-110">This guidance applies to bindings using Kerberos or SSPI negotiation.</span></span>  <span data-ttu-id="3cea5-111">Os clientes ainda devem especificar um SPN no caso onde SSPI reverterá para NTLM.</span><span class="sxs-lookup"><span data-stu-id="3cea5-111">Clients should still specify an SPN in the case where SSPI falls back to NTLM.</span></span>  
  
## <a name="verify-service-identities-in-wsdl"></a><span data-ttu-id="3cea5-112">Verificar as identidades de serviço em WSDL</span><span class="sxs-lookup"><span data-stu-id="3cea5-112">Verify Service Identities in WSDL</span></span>  
 <span data-ttu-id="3cea5-113">O WS-SecurityPolicy permite que os serviços publicar informações sobre suas próprias identidades nos metadados.</span><span class="sxs-lookup"><span data-stu-id="3cea5-113">WS-SecurityPolicy allows services to publish information about their own identities in metadata.</span></span> <span data-ttu-id="3cea5-114">Quando recuperados por meio de `svcutil` ou outros métodos, como <xref:System.ServiceModel.Description.WsdlImporter>, essas informações de identidade são convertidas para as propriedades de identidade do [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] endereços de ponto de extremidade de serviço.</span><span class="sxs-lookup"><span data-stu-id="3cea5-114">When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service endpoint addresses.</span></span> <span data-ttu-id="3cea5-115">Os clientes que não verificam se essas identidades de serviço estão corretas e válido efetivamente ignoram a autenticação de serviço.</span><span class="sxs-lookup"><span data-stu-id="3cea5-115">Clients which do not verify that these service identities are correct and valid effectively bypass service authentication.</span></span> <span data-ttu-id="3cea5-116">Um serviço mal-intencionado pode explorar esses clientes para executar o encaminhamento de credenciais e outros ataques "man no meio" alterando a identidade declarada em seu WSDL.</span><span class="sxs-lookup"><span data-stu-id="3cea5-116">A malicious service can exploit such clients to execute credential forwarding and other "man in the middle" attacks by changing the identity claimed in its WSDL.</span></span>  
  
## <a name="use-x509-certificates-instead-of-ntlm"></a><span data-ttu-id="3cea5-117">Use X509 certificados em vez de NTLM</span><span class="sxs-lookup"><span data-stu-id="3cea5-117">Use X509 Certificates Instead of NTLM</span></span>  
 [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="3cea5-118"> oferece dois mecanismos para autenticação de ponto a ponto: X509 certificados (usados pelo canal de ponto a ponto) e autenticação do Windows em que uma negociação de SSPI fazer downgrade do Kerberos para NTLM.</span><span class="sxs-lookup"><span data-stu-id="3cea5-118"> offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.</span></span>  <span data-ttu-id="3cea5-119">Autenticação baseada em certificado usando tamanhos de chave de 1024 bits ou mais é preferencial para NTLM por vários motivos:</span><span class="sxs-lookup"><span data-stu-id="3cea5-119">Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:</span></span>  
  
-   <span data-ttu-id="3cea5-120">a disponibilidade de autenticação mútua,</span><span class="sxs-lookup"><span data-stu-id="3cea5-120">the availability of mutual authentication,</span></span>  
  
-   <span data-ttu-id="3cea5-121">o uso de algoritmos de criptografia mais fortes, e</span><span class="sxs-lookup"><span data-stu-id="3cea5-121">the use of stronger cryptographic algorithms, and</span></span>  
  
-   <span data-ttu-id="3cea5-122">a maior dificuldade de utilizando encaminhados X509 credenciais.</span><span class="sxs-lookup"><span data-stu-id="3cea5-122">the greater difficulty of utilizing forwarded X509 credentials.</span></span>  
  
 <span data-ttu-id="3cea5-123">Para obter uma visão geral do NTLM ataques de encaminhamento, vá para [ http://msdn.microsoft.com/msdnmag/issues/06/09/SecureByDesign/default.aspx ](http://go.microsoft.com/fwlink/?LinkId=109571).</span><span class="sxs-lookup"><span data-stu-id="3cea5-123">For an overview of NTLM forwarding attacks, go to [http://msdn.microsoft.com/msdnmag/issues/06/09/SecureByDesign/default.aspx](http://go.microsoft.com/fwlink/?LinkId=109571).</span></span>  
  
## <a name="always-revert-after-impersonation"></a><span data-ttu-id="3cea5-124">Reverter sempre depois de representação</span><span class="sxs-lookup"><span data-stu-id="3cea5-124">Always Revert After Impersonation</span></span>  
 <span data-ttu-id="3cea5-125">Ao usar APIs que permitem a representação de um cliente, certifique-se de reverter para a identidade original.</span><span class="sxs-lookup"><span data-stu-id="3cea5-125">When using APIs that enable impersonation of a client, be sure to revert to the original identity.</span></span> <span data-ttu-id="3cea5-126">Por exemplo, ao usar o <xref:System.Security.Principal.WindowsIdentity> e <xref:System.Security.Principal.WindowsImpersonationContext>, usar o c# `using` instrução ou o Visual Basic`Using` instrução, conforme mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="3cea5-126">For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the Visual Basic`Using` statement, as shown in the following code.</span></span> <span data-ttu-id="3cea5-127">O <xref:System.Security.Principal.WindowsImpersonationContext> classe implementa o <xref:System.IDisposable> interface e, portanto, o common language runtime (CLR) é revertida automaticamente para a identidade original depois que o código deixa o `using` bloco.</span><span class="sxs-lookup"><span data-stu-id="3cea5-127">The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block.</span></span>  
  
 [!code-csharp[c_SecurityBestPractices#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_securitybestpractices/cs/source.cs#1)]
 [!code-vb[c_SecurityBestPractices#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_securitybestpractices/vb/source.vb#1)]  
  
## <a name="impersonate-only-as-needed"></a><span data-ttu-id="3cea5-128">Representar apenas conforme necessário</span><span class="sxs-lookup"><span data-stu-id="3cea5-128">Impersonate Only as Needed</span></span>  
 <span data-ttu-id="3cea5-129">Usando o <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> método o <xref:System.Security.Principal.WindowsIdentity> classe, é possível usar a representação em um escopo muito controlado.</span><span class="sxs-lookup"><span data-stu-id="3cea5-129">Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope.</span></span> <span data-ttu-id="3cea5-130">Isso é diferente de usar o <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> propriedade do <xref:System.ServiceModel.OperationBehaviorAttribute>, que permite a representação para o escopo da operação inteira.</span><span class="sxs-lookup"><span data-stu-id="3cea5-130">This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation.</span></span> <span data-ttu-id="3cea5-131">Sempre que possível, controlar o escopo da representação usando o mais preciso <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> método.</span><span class="sxs-lookup"><span data-stu-id="3cea5-131">Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method.</span></span>  
  
## <a name="obtain-metadata-from-trusted-sources"></a><span data-ttu-id="3cea5-132">Obter metadados de fontes confiáveis</span><span class="sxs-lookup"><span data-stu-id="3cea5-132">Obtain Metadata from Trusted Sources</span></span>  
 <span data-ttu-id="3cea5-133">Certifique-se de que você confia na origem dos metadados e certifique-se de que ninguém tenha violado os metadados.</span><span class="sxs-lookup"><span data-stu-id="3cea5-133">Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata.</span></span> <span data-ttu-id="3cea5-134">Metadados recuperados usando o protocolo HTTP é enviado em texto não criptografado e podem ser violados.</span><span class="sxs-lookup"><span data-stu-id="3cea5-134">Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with.</span></span> <span data-ttu-id="3cea5-135">Se o serviço usa o <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> e <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> propriedades, use a URL fornecida pelo criador do serviço para baixar os dados usando o protocolo HTTPS.</span><span class="sxs-lookup"><span data-stu-id="3cea5-135">If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.</span></span>  
  
## <a name="publish-metadata-using-security"></a><span data-ttu-id="3cea5-136">Publicar usando a segurança de metadados</span><span class="sxs-lookup"><span data-stu-id="3cea5-136">Publish Metadata Using Security</span></span>  
 <span data-ttu-id="3cea5-137">Para evitar a violação com metadados de um serviço publicado, proteger o ponto de extremidade de troca de metadados com transporte ou segurança em nível de mensagem.</span><span class="sxs-lookup"><span data-stu-id="3cea5-137">To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security.</span></span> <span data-ttu-id="3cea5-138">Para obter mais informações, consulte [pontos de extremidade de metadados de publicação](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) e [como: publicar metadados para um serviço usando código](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md).</span><span class="sxs-lookup"><span data-stu-id="3cea5-138">For more information, see [Publishing Metadata Endpoints](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md).</span></span>  
  
## <a name="ensure-use-of-local-issuer"></a><span data-ttu-id="3cea5-139">Certifique-se de uso do emissor Local</span><span class="sxs-lookup"><span data-stu-id="3cea5-139">Ensure Use of Local Issuer</span></span>  
 <span data-ttu-id="3cea5-140">Se um endereço do emissor e a associação especificadas para uma associação de determinado, o emissor local não é usado para pontos de extremidade que utilizam essa associação.</span><span class="sxs-lookup"><span data-stu-id="3cea5-140">If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding.</span></span> <span data-ttu-id="3cea5-141">Clientes que pretende usar sempre o emissor local devem garantir que eles não usam essa associação ou que eles modificarem a associação, de modo que o endereço do emissor é nulo.</span><span class="sxs-lookup"><span data-stu-id="3cea5-141">Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.</span></span>  
  
## <a name="saml-token-size-quotas"></a><span data-ttu-id="3cea5-142">Cotas de tamanho de Token SAML</span><span class="sxs-lookup"><span data-stu-id="3cea5-142">SAML Token Size Quotas</span></span>  
 <span data-ttu-id="3cea5-143">Quando os tokens de segurança asserções Markup Language (SAML) são serializados em mensagens, quando eles são emitidos por um Token de segurança Service (STS) ou quando os clientes apresentação-los para serviços como parte da autenticação, a cota de tamanho máximo da mensagem deve ser suficientemente grande para acomodar o token SAML e as outras partes da mensagem.</span><span class="sxs-lookup"><span data-stu-id="3cea5-143">When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts.</span></span> <span data-ttu-id="3cea5-144">Em casos normais, as cotas de tamanho de mensagem padrão são suficientes.</span><span class="sxs-lookup"><span data-stu-id="3cea5-144">In normal cases, the default message size quotas are sufficient.</span></span> <span data-ttu-id="3cea5-145">No entanto, nos casos em que um token SAML é grande porque ele contém centenas de declarações, as cotas devem ser aumentadas para acomodar o token serializado.</span><span class="sxs-lookup"><span data-stu-id="3cea5-145">However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token.</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="3cea5-146"> cotas, consulte [considerações de segurança para dados](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md).</span><span class="sxs-lookup"><span data-stu-id="3cea5-146"> quotas, see [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md).</span></span>  
  
## <a name="set-securitybindingelementincludetimestamp-to-true-on-custom-bindings"></a><span data-ttu-id="3cea5-147">Defina SecurityBindingElement.IncludeTimestamp como True em associações personalizadas</span><span class="sxs-lookup"><span data-stu-id="3cea5-147">Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings</span></span>  
 <span data-ttu-id="3cea5-148">Quando você cria uma associação personalizada, você deve definir <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> para `true`.</span><span class="sxs-lookup"><span data-stu-id="3cea5-148">When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`.</span></span> <span data-ttu-id="3cea5-149">Caso contrário, se <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> é definido como `false`, e o cliente está usando um token com chave assimétrico como X509 certificado, a mensagem não será assinada.</span><span class="sxs-lookup"><span data-stu-id="3cea5-149">Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="3cea5-150">Consulte também</span><span class="sxs-lookup"><span data-stu-id="3cea5-150">See Also</span></span>  
 [<span data-ttu-id="3cea5-151">Considerações sobre segurança</span><span class="sxs-lookup"><span data-stu-id="3cea5-151">Security Considerations</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)  
 [<span data-ttu-id="3cea5-152">Considerações sobre segurança para dados</span><span class="sxs-lookup"><span data-stu-id="3cea5-152">Security Considerations for Data</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)  
 [<span data-ttu-id="3cea5-153">Considerações de segurança com metadados</span><span class="sxs-lookup"><span data-stu-id="3cea5-153">Security Considerations with Metadata</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)
