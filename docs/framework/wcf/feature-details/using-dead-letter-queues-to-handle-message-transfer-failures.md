---
title: Utilizando filas de mensagens mortas para manuseio de transferência de mensagens com falha
ms.custom: ''
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: ''
ms.suite: ''
ms.technology:
- dotnet-clr
ms.tgt_pltfrm: ''
ms.topic: article
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
caps.latest.revision: 19
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload:
- dotnet
ms.openlocfilehash: b51999b1984dedf1baf23e41c1592382849c431b
ms.sourcegitcommit: 94d33cadc5ff81d2ac389bf5f26422c227832052
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/30/2018
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="357fb-102">Utilizando filas de mensagens mortas para manuseio de transferência de mensagens com falha</span><span class="sxs-lookup"><span data-stu-id="357fb-102">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>
<span data-ttu-id="357fb-103">Mensagens em fila podem não entrega.</span><span class="sxs-lookup"><span data-stu-id="357fb-103">Queued messages can fail delivery.</span></span> <span data-ttu-id="357fb-104">Essas mensagens com falha são registradas em uma fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-104">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="357fb-105">Falha na entrega pode ser causado por motivos como falhas de rede, uma fila excluída, uma fila cheia, falha de autenticação ou uma falha ao entregar no tempo.</span><span class="sxs-lookup"><span data-stu-id="357fb-105">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="357fb-106">Mensagens em fila podem permanecer na fila por um longo tempo, se o aplicativo de recebimento não lê-los da fila de maneira oportuna.</span><span class="sxs-lookup"><span data-stu-id="357fb-106">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="357fb-107">Esse comportamento pode não ser apropriado para mensagens de detecção de hora.</span><span class="sxs-lookup"><span data-stu-id="357fb-107">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="357fb-108">Mensagens de detecção de hora têm um tempo para a propriedade de vida (TTL) definido na associação em fila, que indica quanto tempo as mensagens podem ficar na fila antes de expirarem.</span><span class="sxs-lookup"><span data-stu-id="357fb-108">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="357fb-109">As mensagens expiradas são enviadas para uma fila especial chamada fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-109">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="357fb-110">As mensagens também podem ser colocadas em uma fila de mensagens mortas por outros motivos, como exceder uma cota de fila ou devido a falha de autenticação.</span><span class="sxs-lookup"><span data-stu-id="357fb-110">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="357fb-111">Em geral, os aplicativos gravar lógica de compensação para ler as mensagens da fila de mensagens mortas e razões da falha.</span><span class="sxs-lookup"><span data-stu-id="357fb-111">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="357fb-112">A lógica de compensação depende da causa da falha.</span><span class="sxs-lookup"><span data-stu-id="357fb-112">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="357fb-113">Por exemplo, no caso de falha de autenticação, você pode corrigir o certificado conectado com a mensagem e reenviar a mensagem.</span><span class="sxs-lookup"><span data-stu-id="357fb-113">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="357fb-114">Se a entrega falhou porque a cota da fila de destino foi atingida, tente realizar novamente a entrega na esperança de que o problema de cota foi resolvido.</span><span class="sxs-lookup"><span data-stu-id="357fb-114">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="357fb-115">Sistemas de enfileiramento de mensagens mais tem uma fila de mensagens mortas de todo o sistema em que todas as mensagens com falha do sistema são armazenadas.</span><span class="sxs-lookup"><span data-stu-id="357fb-115">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="357fb-116">Serviço de enfileiramento de mensagens (MSMQ) fornece duas filas de mensagens mortas de todo o sistema: uma fila de mensagens mortas transacional todo o sistema que armazena as mensagens que falharam na entrega à fila transacional e uma fila de mensagens mortas de todo o sistema não-transacional que armazena mensagens que falharam na entrega para a fila não transacional.</span><span class="sxs-lookup"><span data-stu-id="357fb-116">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="357fb-117">Se dois clientes estão enviando mensagens para dois serviços diferentes e, portanto, diferentes filas em [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] estão compartilhando o mesmo serviço MSMQ para enviar, em seguida, é possível ter uma mistura de mensagens na fila de mensagens mortas de sistema.</span><span class="sxs-lookup"><span data-stu-id="357fb-117">If two clients are sending messages to two different services, and therefore different queues in [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="357fb-118">Isso nem sempre é ideal.</span><span class="sxs-lookup"><span data-stu-id="357fb-118">This is not always optimal.</span></span> <span data-ttu-id="357fb-119">Em alguns casos (por exemplo, segurança), talvez não seja um cliente para ler mensagens de outro cliente de uma fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-119">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="357fb-120">Uma fila de mensagens mortas compartilhada também exige que os clientes navegar por meio de fila para localizar uma mensagem que eles enviaram, que pode ser extremamente dispendioso com base no número de mensagens na fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-120">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="357fb-121">Portanto, em [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] `NetMsmqBinding`, `MsmqIntegrationBinding,` e MSMQ em [!INCLUDE[wv](../../../../includes/wv-md.md)] fornecem uma fila de mensagens mortas personalizada (também conhecida como uma fila de mensagens mortas específicas do aplicativo).</span><span class="sxs-lookup"><span data-stu-id="357fb-121">Therefore, in [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on [!INCLUDE[wv](../../../../includes/wv-md.md)] provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="357fb-122">A fila de mensagens mortas personalizada fornece isolamento entre os clientes que compartilham o mesmo serviço MSMQ para enviar mensagens.</span><span class="sxs-lookup"><span data-stu-id="357fb-122">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="357fb-123">Em [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)], [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] fornece uma fila de mensagens mortas de todo o sistema para todos os aplicativos cliente em fila.</span><span class="sxs-lookup"><span data-stu-id="357fb-123">On [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)], [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="357fb-124">Em [!INCLUDE[wv](../../../../includes/wv-md.md)], [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] fornece uma fila de mensagens mortas para cada aplicativo cliente na fila.</span><span class="sxs-lookup"><span data-stu-id="357fb-124">On [!INCLUDE[wv](../../../../includes/wv-md.md)], [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="357fb-125">Especificando o uso de fila de mensagens mortas</span><span class="sxs-lookup"><span data-stu-id="357fb-125">Specifying Use of the Dead-Letter Queue</span></span>  
 <span data-ttu-id="357fb-126">Uma fila de mensagens mortas é no Gerenciador de filas do aplicativo de envio.</span><span class="sxs-lookup"><span data-stu-id="357fb-126">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="357fb-127">Ele armazena as mensagens que expiraram ou tiveram uma falha de transferência ou entrega.</span><span class="sxs-lookup"><span data-stu-id="357fb-127">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="357fb-128">A associação tem as seguintes propriedades de fila de mensagens mortas:</span><span class="sxs-lookup"><span data-stu-id="357fb-128">The binding has the following dead-letter queue properties:</span></span>  
  
-   <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
-   <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="357fb-129">Lendo mensagens da fila de mensagens mortas</span><span class="sxs-lookup"><span data-stu-id="357fb-129">Reading Messages from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="357fb-130">Um aplicativo que lê mensagens fora de uma fila de mensagens mortas é semelhante a um [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] serviço lê a partir de uma fila de aplicativos, exceto as pequenas diferenças a seguir:</span><span class="sxs-lookup"><span data-stu-id="357fb-130">An application that reads messages out of a dead-letter queue is similar to a [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] service that reads from an application queue, except for the following minor differences:</span></span>  
  
-   <span data-ttu-id="357fb-131">Para ler mensagens de uma fila de mensagens mortas transacional do sistema, o identificador de recurso uniforme (URI) deve estar no formato: net.msmq://localhost/system$; DeadXact.</span><span class="sxs-lookup"><span data-stu-id="357fb-131">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
-   <span data-ttu-id="357fb-132">Para ler mensagens de uma fila de mensagens mortas não transacional do sistema, o URI deve estar no formato: net.msmq://localhost/system$; mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-132">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
-   <span data-ttu-id="357fb-133">Para ler mensagens de uma fila de mensagens mortas personalizada, o URI deve ser do formulário: net.msmq://localhost/private/\<*nome de dlq personalizada*> onde *nome de dlq personalizada* é o nome personalizado fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-133">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="357fb-134">Para obter mais informações sobre como as filas de endereço, consulte [pontos de extremidade de serviço e endereçamento de fila](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="357fb-134">For more information about how to address queues, see [Service Endpoints and Queue Addressing](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="357fb-135">O [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] pilha os endereços de correspondências de destinatário que o serviço está escutando com o endereço na mensagem.</span><span class="sxs-lookup"><span data-stu-id="357fb-135">The [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="357fb-136">Se os endereços corresponderem, a mensagem é enviada; Caso contrário, a mensagem não é enviada.</span><span class="sxs-lookup"><span data-stu-id="357fb-136">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="357fb-137">Isso pode causar problemas durante a leitura da fila de mensagens mortas, porque as mensagens na fila de mensagens mortas normalmente são endereçadas para o serviço e não o serviço de fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-137">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="357fb-138">Portanto, a leitura da fila de mensagens mortas do serviço deve instalar um filtro de endereço `ServiceBehavior` que instrui a pilha para corresponder a todas as mensagens na fila, independentemente do destinatário.</span><span class="sxs-lookup"><span data-stu-id="357fb-138">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="357fb-139">Especificamente, você deve adicionar um `ServiceBehavior` com o <xref:System.ServiceModel.AddressFilterMode.Any> parâmetro para o serviço de leitura de mensagens da fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-139">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="357fb-140">Tratamento de fila de mensagens mortas de mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="357fb-140">Poison Message Handling from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="357fb-141">Manipulação de mensagens suspeitas está disponível em filas de mensagens mortas, com algumas condições.</span><span class="sxs-lookup"><span data-stu-id="357fb-141">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="357fb-142">Porque você não pode criar subfilas de filas do sistema, durante a leitura da fila de mensagens mortas de sistema, o `ReceiveErrorHandling` não pode ser definido como `Move`.</span><span class="sxs-lookup"><span data-stu-id="357fb-142">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="357fb-143">Observe que, se você estiver lendo de uma fila de mensagens mortas personalizada, você pode ter subfilas e, portanto, `Move` é uma disposição válida para a mensagem suspeita.</span><span class="sxs-lookup"><span data-stu-id="357fb-143">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="357fb-144">Quando `ReceiveErrorHandling` é definido como `Reject`, quando a leitura da fila de mensagens mortas personalizada, a mensagem suspeita é colocada na fila de mensagens mortas de sistema.</span><span class="sxs-lookup"><span data-stu-id="357fb-144">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="357fb-145">Se ler da fila de mensagens mortas de sistema, a mensagem será descartada (limpas).</span><span class="sxs-lookup"><span data-stu-id="357fb-145">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="357fb-146">Uma rejeição de uma fila de mensagens mortas sistema em MSMQ descarta (limpa) a mensagem.</span><span class="sxs-lookup"><span data-stu-id="357fb-146">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="357fb-147">Exemplo</span><span class="sxs-lookup"><span data-stu-id="357fb-147">Example</span></span>  
 <span data-ttu-id="357fb-148">O exemplo a seguir mostra como criar uma fila de mensagens mortas e como usá-lo para processar as mensagens expiradas.</span><span class="sxs-lookup"><span data-stu-id="357fb-148">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="357fb-149">O exemplo é baseado no exemplo [como: mensagens na fila do Exchange com pontos de extremidade do WCF](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="357fb-149">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="357fb-150">O exemplo a seguir mostra como escrever o código do cliente para o serviço que usa uma fila de mensagens mortas para cada aplicativo de processamento de pedidos.</span><span class="sxs-lookup"><span data-stu-id="357fb-150">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="357fb-151">O exemplo também mostra como processar mensagens da fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-151">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="357fb-152">A seguir está o código para um cliente que especifica uma fila de mensagens mortas para cada aplicativo.</span><span class="sxs-lookup"><span data-stu-id="357fb-152">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="357fb-153">A seguir está o código para o arquivo de configuração do cliente.</span><span class="sxs-lookup"><span data-stu-id="357fb-153">The following is code for the client configuration file.</span></span>  
  
  
  
 <span data-ttu-id="357fb-154">A seguir está o código para um serviço de processamento de mensagens de uma fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-154">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="357fb-155">A seguir está o código para o arquivo de configuração do serviço de fila de mensagens mortas.</span><span class="sxs-lookup"><span data-stu-id="357fb-155">The following is code for the dead-letter queue service configuration file.</span></span>  
  
  
  
## <a name="see-also"></a><span data-ttu-id="357fb-156">Consulte também</span><span class="sxs-lookup"><span data-stu-id="357fb-156">See Also</span></span>  
 [<span data-ttu-id="357fb-157">Visão geral de filas</span><span class="sxs-lookup"><span data-stu-id="357fb-157">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)  
 [<span data-ttu-id="357fb-158">Como trocar mensagens na fila com pontos de extremidade do WCF</span><span class="sxs-lookup"><span data-stu-id="357fb-158">How to: Exchange Queued Messages with WCF Endpoints</span></span>](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md)  
 [<span data-ttu-id="357fb-159">Manipulação de mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="357fb-159">Poison Message Handling</span></span>](../../../../docs/framework/wcf/feature-details/poison-message-handling.md)
