---
title: Criando um serviço de fluxo de trabalho de execução longa
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: 3e422c138b49fa19aa29e4fa1488d61a2c9bc2f8
ms.sourcegitcommit: 30a558d23e3ac5a52071121a52c305c85fe15726
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/25/2019
ms.locfileid: "75348099"
---
# <a name="create-a-long-running-workflow-service"></a><span data-ttu-id="372b9-102">Criar um serviço de fluxo de trabalho de execução longa</span><span class="sxs-lookup"><span data-stu-id="372b9-102">Create a Long-running Workflow Service</span></span>

<span data-ttu-id="372b9-103">Este tópico descreve como criar um serviço de fluxo de trabalho de execução longa.</span><span class="sxs-lookup"><span data-stu-id="372b9-103">This topic describes how to create a long-running workflow service.</span></span> <span data-ttu-id="372b9-104">Os serviços de fluxo de trabalho de longa execução podem ser executados por longos períodos de tempo.</span><span class="sxs-lookup"><span data-stu-id="372b9-104">Long running workflow services may run for long periods of time.</span></span> <span data-ttu-id="372b9-105">Em algum momento, o fluxo de trabalho pode ficar ocioso aguardando algumas informações adicionais.</span><span class="sxs-lookup"><span data-stu-id="372b9-105">At some point the workflow may go idle waiting for some additional information.</span></span> <span data-ttu-id="372b9-106">Quando isso ocorre, o fluxo de trabalho é persistido em um banco de dados SQL e removido da memória.</span><span class="sxs-lookup"><span data-stu-id="372b9-106">When this occurs the workflow is persisted to a SQL database and is removed from memory.</span></span> <span data-ttu-id="372b9-107">Quando as informações adicionais ficarem disponíveis, a instância do fluxo de trabalho será carregada de volta na memória e continuará em execução.</span><span class="sxs-lookup"><span data-stu-id="372b9-107">When the additional information becomes available the workflow instance is loaded back into memory and continues executing.</span></span>  <span data-ttu-id="372b9-108">Nesse cenário, você está implementando um sistema de pedidos muito simplificado.</span><span class="sxs-lookup"><span data-stu-id="372b9-108">In this scenario you are implementing a very simplified ordering system.</span></span>  <span data-ttu-id="372b9-109">O cliente envia uma mensagem inicial para o serviço de fluxo de trabalho para iniciar a ordem.</span><span class="sxs-lookup"><span data-stu-id="372b9-109">The client sends an initial message to the workflow service to start the order.</span></span> <span data-ttu-id="372b9-110">Ele retorna uma ID do pedido para o cliente.</span><span class="sxs-lookup"><span data-stu-id="372b9-110">It returns an order ID to the client.</span></span> <span data-ttu-id="372b9-111">Neste ponto, o serviço de fluxo de trabalho está aguardando outra mensagem do cliente e entra no estado ocioso e é persistido em um banco de dados SQL Server.</span><span class="sxs-lookup"><span data-stu-id="372b9-111">At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.</span></span>  <span data-ttu-id="372b9-112">Quando o cliente envia a próxima mensagem para solicitar um item, o serviço de fluxo de trabalho é carregado de volta na memória e conclui o processamento do pedido.</span><span class="sxs-lookup"><span data-stu-id="372b9-112">When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.</span></span> <span data-ttu-id="372b9-113">No exemplo de código, ele retorna uma cadeia de caracteres que informa que o item foi adicionado à ordem.</span><span class="sxs-lookup"><span data-stu-id="372b9-113">In the code sample it returns a string stating the item has been added to the order.</span></span> <span data-ttu-id="372b9-114">O exemplo de código não deve ser um aplicativo do mundo real da tecnologia, mas sim um exemplo simples que ilustra os serviços de fluxo de trabalho de longa execução.</span><span class="sxs-lookup"><span data-stu-id="372b9-114">The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.</span></span> <span data-ttu-id="372b9-115">Este tópico pressupõe que você saiba como criar projetos e soluções do Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="372b9-115">This topic assumes you know how to create Visual Studio 2012 projects and solutions.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="372b9-116">{1&gt;{2&gt;Pré-requisitos&lt;2}&lt;1}</span><span class="sxs-lookup"><span data-stu-id="372b9-116">Prerequisites</span></span>

<span data-ttu-id="372b9-117">Você deve ter o seguinte software instalado para usar este passo a passos:</span><span class="sxs-lookup"><span data-stu-id="372b9-117">You must have the following software installed to use this walkthrough:</span></span>

1. <span data-ttu-id="372b9-118">Microsoft SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="372b9-118">Microsoft SQL Server 2008</span></span>

2. <span data-ttu-id="372b9-119">Visual Studio 2012</span><span class="sxs-lookup"><span data-stu-id="372b9-119">Visual Studio 2012</span></span>

3. <span data-ttu-id="372b9-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span><span class="sxs-lookup"><span data-stu-id="372b9-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span></span>

4. <span data-ttu-id="372b9-121">Você está familiarizado com o WCF e o Visual Studio 2012 e sabe como criar projetos/soluções.</span><span class="sxs-lookup"><span data-stu-id="372b9-121">You are familiar with WCF and Visual Studio 2012 and know how to create projects/solutions.</span></span>

## <a name="set-up-the-sql-database"></a><span data-ttu-id="372b9-122">Configurar o banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="372b9-122">Set up the SQL Database</span></span>

1. <span data-ttu-id="372b9-123">Para que as instâncias do serviço de fluxo de trabalho sejam persistidas, você deve ter Microsoft SQL Server instalado e deve configurar um banco de dados para armazenar as instâncias de fluxo de trabalho persistentes.</span><span class="sxs-lookup"><span data-stu-id="372b9-123">In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.</span></span> <span data-ttu-id="372b9-124">Execute o Microsoft SQL Management Studio clicando no botão **Iniciar** , selecionando **todos os programas**, **Microsoft SQL Server 2008**e **Microsoft SQL Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="372b9-124">Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.</span></span>

2. <span data-ttu-id="372b9-125">Clique no botão **conectar** para fazer logon na instância de SQL Server</span><span class="sxs-lookup"><span data-stu-id="372b9-125">Click the **Connect** button to log on to the SQL Server instance</span></span>

3. <span data-ttu-id="372b9-126">Clique com o botão direito do mouse em **bancos** de dados no modo de exibição de árvore e selecione **novo Database..**</span><span class="sxs-lookup"><span data-stu-id="372b9-126">Right click **Databases** in the tree view and select **New Database..**</span></span> <span data-ttu-id="372b9-127">para criar um novo banco de dados chamado `SQLPersistenceStore`.</span><span class="sxs-lookup"><span data-stu-id="372b9-127">to create a new database called `SQLPersistenceStore`.</span></span>

4. <span data-ttu-id="372b9-128">Execute o arquivo de script SqlWorkflowInstanceStoreSchema. SQL localizado no diretório C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en no banco de dados SQLPersistenceStore para configurar os esquemas de banco de dados necessários.</span><span class="sxs-lookup"><span data-stu-id="372b9-128">Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database schemas.</span></span>

5. <span data-ttu-id="372b9-129">Execute o arquivo de script SqlWorkflowInstanceStoreLogic. SQL localizado no diretório C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en no banco de dados SQLPersistenceStore para configurar a lógica de banco de dados necessária.</span><span class="sxs-lookup"><span data-stu-id="372b9-129">Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database logic.</span></span>

## <a name="create-the-web-hosted-workflow-service"></a><span data-ttu-id="372b9-130">Criar o serviço de fluxo de trabalho hospedado na Web</span><span class="sxs-lookup"><span data-stu-id="372b9-130">Create the Web Hosted Workflow Service</span></span>

1. <span data-ttu-id="372b9-131">Crie uma solução vazia do Visual Studio 2012, nomeie-a `OrderProcessing`.</span><span class="sxs-lookup"><span data-stu-id="372b9-131">Create an empty Visual Studio 2012 solution, name it `OrderProcessing`.</span></span>

2. <span data-ttu-id="372b9-132">Adicione um novo projeto de aplicativo do serviço de fluxo de trabalho WCF chamado `OrderService` à solução.</span><span class="sxs-lookup"><span data-stu-id="372b9-132">Add a new WCF Workflow Service Application project called `OrderService` to the solution.</span></span>

3. <span data-ttu-id="372b9-133">Na caixa de diálogo Propriedades do projeto, selecione a guia **Web** .</span><span class="sxs-lookup"><span data-stu-id="372b9-133">In the project properties dialog, select the **Web** tab.</span></span>

    1. <span data-ttu-id="372b9-134">Em **Iniciar ação** , selecione **página específica** e especifique `Service1.xamlx`.</span><span class="sxs-lookup"><span data-stu-id="372b9-134">Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.</span></span>

        <span data-ttu-id="372b9-135">![Propriedades da Web do projeto de serviço de fluxo de trabalho](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Criar a opção de página específica do serviço de fluxo de trabalho hospedado na Web")</span><span class="sxs-lookup"><span data-stu-id="372b9-135">![Workflow Service Project Web Properties](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Create the web hosted workflow service - Specific Page option")</span></span>

    2. <span data-ttu-id="372b9-136">Em **servidores** , selecione **usar servidor Web local do IIS**.</span><span class="sxs-lookup"><span data-stu-id="372b9-136">Under **Servers** select **Use Local IIS Web server**.</span></span>

        <span data-ttu-id="372b9-137">![Configurações do servidor Web local](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Criar o serviço de fluxo de trabalho hospedado da Web-usar a opção de servidor Web IIS local")</span><span class="sxs-lookup"><span data-stu-id="372b9-137">![Local Web Server Settings](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Create the web hosted workflow service - Use Local IIS Web Server option")</span></span>

        > [!WARNING]
        > <span data-ttu-id="372b9-138">Você deve executar o Visual Studio 2012 no modo de administrador para fazer essa configuração.</span><span class="sxs-lookup"><span data-stu-id="372b9-138">You must run Visual Studio 2012 in administrator mode to make this setting.</span></span>

        <span data-ttu-id="372b9-139">Essas duas etapas configuram o projeto de serviço de fluxo de trabalho a ser hospedado pelo IIS.</span><span class="sxs-lookup"><span data-stu-id="372b9-139">These two steps configure the workflow service project to be hosted by IIS.</span></span>

4. <span data-ttu-id="372b9-140">Abra `Service1.xamlx` se ele ainda não estiver aberto e exclua as atividades **ReceiveRequest** e **SendResponse** existentes.</span><span class="sxs-lookup"><span data-stu-id="372b9-140">Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.</span></span>

5. <span data-ttu-id="372b9-141">Selecione a atividade de **serviço sequencial** e clique no link **variáveis** e adicione as variáveis mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-141">Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration.</span></span> <span data-ttu-id="372b9-142">Isso adiciona algumas variáveis que serão usadas posteriormente no serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="372b9-142">Doing this adds some variables that will be used later on in the workflow service.</span></span>

    > [!NOTE]
    > <span data-ttu-id="372b9-143">Se CorrelationHandle não estiver na lista suspensa tipo de variável, selecione **procurar tipos** na lista suspensa.</span><span class="sxs-lookup"><span data-stu-id="372b9-143">If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down.</span></span> <span data-ttu-id="372b9-144">Digite CorrelationHandle na caixa **nome do tipo** , selecione CorrelationHandle na ListBox e clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="372b9-144">Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.</span></span>

    <span data-ttu-id="372b9-145">![Adicionar variáveis](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Adicione variáveis à atividade de serviço sequencial.")</span><span class="sxs-lookup"><span data-stu-id="372b9-145">![Add Variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Add variables to the Sequential Service activity.")</span></span>

6. <span data-ttu-id="372b9-146">Arraste e solte um modelo de atividade **ReceiveAndSendReply** na atividade de **serviço sequencial** .</span><span class="sxs-lookup"><span data-stu-id="372b9-146">Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity.</span></span> <span data-ttu-id="372b9-147">Esse conjunto de atividades receberá uma mensagem de um cliente e enviará uma resposta de volta.</span><span class="sxs-lookup"><span data-stu-id="372b9-147">This set of activities will receive a message from a client and send a reply back.</span></span>

    1. <span data-ttu-id="372b9-148">Selecione a atividade **receber** e defina as propriedades realçadas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-148">Select the **Receive** activity and set the properties highlighted in the following illustration.</span></span>

        <span data-ttu-id="372b9-149">![Definir propriedades da atividade de recebimento](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Defina as propriedades da atividade Receive.")</span><span class="sxs-lookup"><span data-stu-id="372b9-149">![Set Receive Activity Properties](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Set the Receive activity properties.")</span></span>

        <span data-ttu-id="372b9-150">A propriedade DisplayName define o nome exibido para a atividade Receive no designer.</span><span class="sxs-lookup"><span data-stu-id="372b9-150">The DisplayName property sets the name displayed for the Receive activity in the designer.</span></span> <span data-ttu-id="372b9-151">As propriedades ServiceContractName e OperationName especificam o nome do contrato de serviço e a operação que são implementados pela atividade Receive.</span><span class="sxs-lookup"><span data-stu-id="372b9-151">The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.</span></span> <span data-ttu-id="372b9-152">Para obter mais informações sobre como os contratos são usados nos serviços de fluxo de trabalho, consulte [usando contratos no fluxo de trabalho](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="372b9-152">For more information about how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span></span>

    2. <span data-ttu-id="372b9-153">Clique no link **definir...** na atividade **ReceiveStartOrder** e defina as propriedades mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-153">Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.</span></span>  <span data-ttu-id="372b9-154">Observe que o botão de opção **parâmetros** está selecionado, um parâmetro chamado `p_customerName` está associado à variável `customerName`.</span><span class="sxs-lookup"><span data-stu-id="372b9-154">Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable.</span></span> <span data-ttu-id="372b9-155">Isso configura a atividade **Receive** para receber alguns dados e associar esses dados a variáveis locais.</span><span class="sxs-lookup"><span data-stu-id="372b9-155">This configures the **Receive** activity to receive some data and bind that data to local variables.</span></span>

        <span data-ttu-id="372b9-156">![Definindo os dados recebidos pela atividade Receive](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Defina as propriedades dos dados recebidos pela atividade Receive.")</span><span class="sxs-lookup"><span data-stu-id="372b9-156">![Setting the data received by the Receive activity](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Set the properties for data received by the Receive activity.")</span></span>

    3. <span data-ttu-id="372b9-157">Selecione a atividade **SendReplyToReceive** e defina a propriedade realçada mostrada na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-157">Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.</span></span>

        <span data-ttu-id="372b9-158">![Definindo as propriedades da atividade SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "Setresponderproperties")</span><span class="sxs-lookup"><span data-stu-id="372b9-158">![Setting the properties of the SendReply activity](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span></span>

    4. <span data-ttu-id="372b9-159">Clique no link **definir...** na atividade **SendReplyToStartOrder** e defina as propriedades mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-159">Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration.</span></span> <span data-ttu-id="372b9-160">Observe que o botão de opção **parâmetros** está selecionado; um parâmetro chamado `p_orderId` está associado à variável `orderId`.</span><span class="sxs-lookup"><span data-stu-id="372b9-160">Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable.</span></span> <span data-ttu-id="372b9-161">Essa configuração especifica que a atividade SendReplyToStartOrder retornará um valor do tipo cadeia de caracteres para o chamador.</span><span class="sxs-lookup"><span data-stu-id="372b9-161">This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.</span></span>

        <span data-ttu-id="372b9-162">![Configurando os dados de conteúdo da atividade SendReply](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Defina a configuração para a atividade SetReplyToStartOrder.")</span><span class="sxs-lookup"><span data-stu-id="372b9-162">![Configuring the SendReply activity content data](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configure setting for SetReplyToStartOrder activity.")</span></span>

    5. <span data-ttu-id="372b9-163">Arraste e solte uma atividade atribuir entre as atividades **Receive** e **SendReply** e defina as propriedades conforme mostrado na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="372b9-163">Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:</span></span>

        <span data-ttu-id="372b9-164">![Adicionando uma atividade atribuir](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Adicionar uma atividade atribuir.")</span><span class="sxs-lookup"><span data-stu-id="372b9-164">![Adding an assign activity](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Add an assign activity.")</span></span>

        <span data-ttu-id="372b9-165">Isso cria uma nova ID de pedido e coloca o valor na variável orderId.</span><span class="sxs-lookup"><span data-stu-id="372b9-165">This creates a new order ID and places the value in the orderId variable.</span></span>

    6. <span data-ttu-id="372b9-166">Selecione a atividade **ReplyToStartOrder** .</span><span class="sxs-lookup"><span data-stu-id="372b9-166">Select the **ReplyToStartOrder** activity.</span></span> <span data-ttu-id="372b9-167">Na janela Propriedades, clique no botão de reticências de **CorrelationInitializers**.</span><span class="sxs-lookup"><span data-stu-id="372b9-167">In the properties window click the ellipsis button for **CorrelationInitializers**.</span></span> <span data-ttu-id="372b9-168">Selecione o link **Adicionar inicializador** , insira `orderIdHandle` na caixa de texto inicializador, selecione inicializador de correlação de consulta para o tipo de correlação e selecione p_orderId na caixa suspensa consultas XPath.</span><span class="sxs-lookup"><span data-stu-id="372b9-168">Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.</span></span> <span data-ttu-id="372b9-169">Essas configurações são mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-169">These settings are shown in the following illustration.</span></span> <span data-ttu-id="372b9-170">Clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="372b9-170">Click **OK**.</span></span>  <span data-ttu-id="372b9-171">Isso Inicializa uma correlação entre o cliente e essa instância do serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="372b9-171">This initializes a correlation between the client and this instance of the workflow service.</span></span> <span data-ttu-id="372b9-172">Quando uma mensagem que contém essa ID de pedido é recebida, ela é roteada para essa instância do serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="372b9-172">When a message containing this order ID is received it is routed to this instance of the workflow service.</span></span>

        <span data-ttu-id="372b9-173">![Adicionando um inicializador de correlação](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Adicione um inicializador de correlação.")</span><span class="sxs-lookup"><span data-stu-id="372b9-173">![Adding a correlation initializer](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Add a correlation initializer.")</span></span>

7. <span data-ttu-id="372b9-174">Arraste e solte outra atividade **ReceiveAndSendReply** para o final do fluxo de trabalho (fora da **sequência** que contém as primeiras atividades **Receive** e **SendReply** ).</span><span class="sxs-lookup"><span data-stu-id="372b9-174">Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities).</span></span> <span data-ttu-id="372b9-175">Isso receberá a segunda mensagem enviada pelo cliente e responderá a ela.</span><span class="sxs-lookup"><span data-stu-id="372b9-175">This will receive the second message sent by the client and respond to it.</span></span>

    1. <span data-ttu-id="372b9-176">Selecione a **sequência** que contém as atividades **Receive** e **SendReply** adicionadas recentemente e clique no botão **variáveis** .</span><span class="sxs-lookup"><span data-stu-id="372b9-176">Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button.</span></span> <span data-ttu-id="372b9-177">Adicione a variável realçada na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="372b9-177">Add the variable highlighted in the following illustration:</span></span>

        <span data-ttu-id="372b9-178">![Adicionando novas variáveis](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Adicione a variável ItemId.")</span><span class="sxs-lookup"><span data-stu-id="372b9-178">![Adding new variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Add the ItemId variable.")</span></span>

        <span data-ttu-id="372b9-179">Além disso, adicione `orderResult` como **cadeia de caracteres** no escopo de `Sequence`.</span><span class="sxs-lookup"><span data-stu-id="372b9-179">Also add `orderResult` as **String** in the `Sequence` scope.</span></span>

    2. <span data-ttu-id="372b9-180">Selecione a atividade **receber** e defina as propriedades mostradas na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="372b9-180">Select the **Receive** activity and set the properties shown in the following illustration:</span></span>

        <span data-ttu-id="372b9-181">![Definir as propriedades da atividade Receive](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Defina as propriedades de atividades de recebimento.")</span><span class="sxs-lookup"><span data-stu-id="372b9-181">![Set the Receive activity properties](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Set the Receive activities properties.")</span></span>

        > [!NOTE]
        > <span data-ttu-id="372b9-182">Não se esqueça de alterar o campo **ServiceContractName** com `../IAddItem`.</span><span class="sxs-lookup"><span data-stu-id="372b9-182">Don't forget to change **ServiceContractName** field with `../IAddItem`.</span></span>

    3. <span data-ttu-id="372b9-183">Clique no link **definir...** na atividade **ReceiveAddItem** e adicione os parâmetros mostrados na ilustração a seguir: isso configura a atividade Receive para aceitar dois parâmetros, a ID do pedido e a ID do item que está sendo ordenado.</span><span class="sxs-lookup"><span data-stu-id="372b9-183">Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.</span></span>

        <span data-ttu-id="372b9-184">![Especificando parâmetros para o segundo recebimento](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure a atividade Receive para receber dois parâmetros.")</span><span class="sxs-lookup"><span data-stu-id="372b9-184">![Specifying parameters for the second receive](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure the receive activity to receive two parameters.")</span></span>

    4. <span data-ttu-id="372b9-185">Clique no botão de reticências **CorrelateOn** e insira `orderIdHandle`.</span><span class="sxs-lookup"><span data-stu-id="372b9-185">Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`.</span></span> <span data-ttu-id="372b9-186">Em **consultas XPath**, clique na seta suspensa e selecione `p_orderId`.</span><span class="sxs-lookup"><span data-stu-id="372b9-186">Under **XPath Queries**, click the drop down arrow and select `p_orderId`.</span></span> <span data-ttu-id="372b9-187">Isso configura a correlação na segunda atividade de recebimento.</span><span class="sxs-lookup"><span data-stu-id="372b9-187">This configures the correlation on the second receive activity.</span></span> <span data-ttu-id="372b9-188">Para obter mais informações sobre correlação, consulte [correlação](../../../../docs/framework/wcf/feature-details/correlation.md).</span><span class="sxs-lookup"><span data-stu-id="372b9-188">For more information about correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md).</span></span>

        <span data-ttu-id="372b9-189">![Definindo a propriedade CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Defina a propriedade CorrelatesOn.")</span><span class="sxs-lookup"><span data-stu-id="372b9-189">![Setting the CorrelatesOn property](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Set the CorrelatesOn property.")</span></span>

    5. <span data-ttu-id="372b9-190">Arraste e solte uma atividade **If** imediatamente após a atividade **ReceiveAddItem** .</span><span class="sxs-lookup"><span data-stu-id="372b9-190">Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity.</span></span> <span data-ttu-id="372b9-191">Essa atividade funciona exatamente como uma instrução If.</span><span class="sxs-lookup"><span data-stu-id="372b9-191">This activity acts just like an if statement.</span></span>

        1. <span data-ttu-id="372b9-192">Defina a propriedade **condição** como `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span><span class="sxs-lookup"><span data-stu-id="372b9-192">Set the **Condition** property to `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span></span>

        2. <span data-ttu-id="372b9-193">Arraste e solte uma atividade **assign** na seção **then,** e outra na seção **else** define as propriedades de **atribuir** atividades, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-193">Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.</span></span>

            <span data-ttu-id="372b9-194">![Atribuindo o resultado da chamada de serviço](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Atribua o resultado da chamada de serviço.")</span><span class="sxs-lookup"><span data-stu-id="372b9-194">![Assigning the result of the service call](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assign the result of the service call.")</span></span>

            <span data-ttu-id="372b9-195">Se a condição for `true` a seção **then** será executada.</span><span class="sxs-lookup"><span data-stu-id="372b9-195">If the condition is `true` the **Then** section will be executed.</span></span> <span data-ttu-id="372b9-196">Se a condição for `false` a seção **else** será executada.</span><span class="sxs-lookup"><span data-stu-id="372b9-196">If the condition is `false` the **Else** section is executed.</span></span>

        3. <span data-ttu-id="372b9-197">Selecione a atividade **SendReplyToReceive** e defina a propriedade **DisplayName** mostrada na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-197">Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.</span></span>

            <span data-ttu-id="372b9-198">![Definindo as propriedades da atividade SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Defina a propriedade de atividade SendReply.")</span><span class="sxs-lookup"><span data-stu-id="372b9-198">![Setting the SendReply activity properties](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Set the SendReply activity property.")</span></span>

        4. <span data-ttu-id="372b9-199">Clique no link **definir...** na atividade **SetReplyToAddItem** e configure-o conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="372b9-199">Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration.</span></span> <span data-ttu-id="372b9-200">Isso configura a atividade **SendReplyToAddItem** para retornar o valor na variável `orderResult`.</span><span class="sxs-lookup"><span data-stu-id="372b9-200">This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.</span></span>

            <span data-ttu-id="372b9-201">![Definindo a associação de dados para a atividade SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Defina a propriedade para a atividade SendReplyToAddItem.")</span><span class="sxs-lookup"><span data-stu-id="372b9-201">![Setting the data binding for the SendReply activity](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Set property for SendReplyToAddItem activity.")</span></span>

8. <span data-ttu-id="372b9-202">Abra o arquivo Web. config e adicione os elementos a seguir na seção \<comportamento > para habilitar a persistência do fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="372b9-202">Open the web.config file and add the following elements in the \<behavior> section to enable workflow persistence.</span></span>

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    > <span data-ttu-id="372b9-203">Certifique-se de substituir o host e o nome da instância do SQL Server no trecho de código anterior.</span><span class="sxs-lookup"><span data-stu-id="372b9-203">Make sure to replace your host and SQL server instance name in the previous code snippet.</span></span>

9. <span data-ttu-id="372b9-204">{1&gt;Compile a solução.&lt;1}</span><span class="sxs-lookup"><span data-stu-id="372b9-204">Build the solution.</span></span>

## <a name="create-a-client-application-to-call-the-workflow-service"></a><span data-ttu-id="372b9-205">Criar um aplicativo cliente para chamar o serviço de fluxo de trabalho</span><span class="sxs-lookup"><span data-stu-id="372b9-205">Create a Client Application to Call the Workflow Service</span></span>

1. <span data-ttu-id="372b9-206">Adicione um novo projeto de aplicativo de console chamado `OrderClient` à solução.</span><span class="sxs-lookup"><span data-stu-id="372b9-206">Add a new Console application project called `OrderClient` to the solution.</span></span>

2. <span data-ttu-id="372b9-207">Adicionar referências aos seguintes assemblies ao projeto `OrderClient`</span><span class="sxs-lookup"><span data-stu-id="372b9-207">Add references to the following assemblies to the `OrderClient` project</span></span>

    1. <span data-ttu-id="372b9-208">System.ServiceModel.dll</span><span class="sxs-lookup"><span data-stu-id="372b9-208">System.ServiceModel.dll</span></span>

    2. <span data-ttu-id="372b9-209">System.ServiceModel.Activities.dll</span><span class="sxs-lookup"><span data-stu-id="372b9-209">System.ServiceModel.Activities.dll</span></span>

3. <span data-ttu-id="372b9-210">Adicione uma referência de serviço ao serviço de fluxo de trabalho e especifique `OrderService` como o namespace.</span><span class="sxs-lookup"><span data-stu-id="372b9-210">Add a service reference to the workflow service and specify `OrderService` as the namespace.</span></span>

4. <span data-ttu-id="372b9-211">No método `Main()` do projeto cliente, adicione o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="372b9-211">In the `Main()` method of the client project add the following code:</span></span>

    ```csharp
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. <span data-ttu-id="372b9-212">Compile a solução e execute o aplicativo `OrderClient`.</span><span class="sxs-lookup"><span data-stu-id="372b9-212">Build the solution and run the `OrderClient` application.</span></span> <span data-ttu-id="372b9-213">O cliente exibirá o seguinte texto:</span><span class="sxs-lookup"><span data-stu-id="372b9-213">The client will display the following text:</span></span>

    ```output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. <span data-ttu-id="372b9-214">Para verificar se o serviço de fluxo de trabalho foi persistido, inicie o SQL Server Management Studio acessando o menu **Iniciar** , selecionando **todos os programas**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="372b9-214">To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span></span>

    1. <span data-ttu-id="372b9-215">No painel esquerdo, expanda, **bancos de dados**, **SQLPersistenceStore**, **exibições** e clique com o botão direito do mouse em **System. Activities. DurableInstancing. instances** e selecione **selecionar as primeiras 1000 linhas**.</span><span class="sxs-lookup"><span data-stu-id="372b9-215">In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**.</span></span> <span data-ttu-id="372b9-216">No painel de **resultados** , verifique se você vê pelo menos uma instância listada.</span><span class="sxs-lookup"><span data-stu-id="372b9-216">In the **Results** pane verify you see at least one instance listed.</span></span> <span data-ttu-id="372b9-217">Pode haver outras instâncias de execuções anteriores se uma exceção ocorreu durante a execução.</span><span class="sxs-lookup"><span data-stu-id="372b9-217">There may be other instances from prior runs if an exception occurred while running.</span></span> <span data-ttu-id="372b9-218">Você pode excluir as linhas existentes clicando com o botão direito do mouse em **System. Activities. DurableInstancing. Instances** e selecionando **editar as primeiras 200 linhas**, pressionando o botão **executar** , selecionando todas as linhas no painel de resultados e selecionando **excluir**.</span><span class="sxs-lookup"><span data-stu-id="372b9-218">You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.</span></span>  <span data-ttu-id="372b9-219">Para verificar se a instância exibida no banco de dados é a instância que seu aplicativo criou, verifique se a exibição de instâncias está vazia antes de executar o cliente.</span><span class="sxs-lookup"><span data-stu-id="372b9-219">To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.</span></span> <span data-ttu-id="372b9-220">Depois que o cliente estiver executando a execução da consulta novamente (selecione as primeiras 1000 linhas) e verifique se uma nova instância foi adicionada.</span><span class="sxs-lookup"><span data-stu-id="372b9-220">Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.</span></span>

7. <span data-ttu-id="372b9-221">Pressione Enter para enviar a mensagem de adição de item ao serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="372b9-221">Press enter to send the add item message to the workflow service.</span></span> <span data-ttu-id="372b9-222">O cliente exibirá o seguinte texto:</span><span class="sxs-lookup"><span data-stu-id="372b9-222">The client will display the following text:</span></span>

    ```output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a><span data-ttu-id="372b9-223">Veja também</span><span class="sxs-lookup"><span data-stu-id="372b9-223">See also</span></span>

- [<span data-ttu-id="372b9-224">Serviços de fluxo de trabalho</span><span class="sxs-lookup"><span data-stu-id="372b9-224">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
