---
title: Criando um serviço de fluxo de trabalho de execução longa
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: ac0cb83ad428ce98a05fd0626fff835162ad0e41
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/23/2019
ms.locfileid: "62048104"
---
# <a name="creating-a-long-running-workflow-service"></a><span data-ttu-id="b6a4c-102">Criando um serviço de fluxo de trabalho de execução longa</span><span class="sxs-lookup"><span data-stu-id="b6a4c-102">Creating a Long-running Workflow Service</span></span>
<span data-ttu-id="b6a4c-103">Este tópico descreve como criar um serviço de fluxo de trabalho de longa execução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-103">This topic describes how to create a long-running workflow service.</span></span> <span data-ttu-id="b6a4c-104">Serviços de fluxo de trabalho de longa execução pode ser executada por longos períodos de tempo.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-104">Long running workflow services may run for long periods of time.</span></span> <span data-ttu-id="b6a4c-105">Em algum momento o fluxo de trabalho poderá ficar ocioso enquanto aguarda para obter informações adicionais.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-105">At some point the workflow may go idle waiting for some additional information.</span></span> <span data-ttu-id="b6a4c-106">Quando isso acontece o fluxo de trabalho é mantido para um banco de dados SQL e é removido da memória.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-106">When this occurs the workflow is persisted to a SQL database and is removed from memory.</span></span> <span data-ttu-id="b6a4c-107">Quando as informações adicionais está disponível a instância de fluxo de trabalho é carregada para a memória e continua executando.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-107">When the additional information becomes available the workflow instance is loaded back into memory and continues executing.</span></span>  <span data-ttu-id="b6a4c-108">Nesse cenário, você está implementando um sistema de pedidos muito simplificado.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-108">In this scenario you are implementing a very simplified ordering system.</span></span>  <span data-ttu-id="b6a4c-109">O cliente envia uma mensagem inicial para o serviço de fluxo de trabalho para iniciar a ordem.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-109">The client sends an initial message to the workflow service to start the order.</span></span> <span data-ttu-id="b6a4c-110">Ele retorna uma ID de pedido para o cliente.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-110">It returns an order ID to the client.</span></span> <span data-ttu-id="b6a4c-111">Neste ponto o serviço de fluxo de trabalho está aguardando a outra mensagem do cliente e entra no estado ocioso e é mantido para um banco de dados do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-111">At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.</span></span>  <span data-ttu-id="b6a4c-112">Quando o cliente envia a próxima mensagem a um item de ordem, o serviço de fluxo de trabalho é carregado para a memória e termina de processar o pedido.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-112">When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.</span></span> <span data-ttu-id="b6a4c-113">No exemplo de código, ele retorna uma cadeia de caracteres informando que o item foi adicionado ao pedido.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-113">In the code sample it returns a string stating the item has been added to the order.</span></span> <span data-ttu-id="b6a4c-114">O exemplo de código não deve ser um aplicativo do mundo real da tecnologia, mas em vez disso, um exemplo simple que ilustra os serviços de fluxo de trabalho de longa execução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-114">The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.</span></span> <span data-ttu-id="b6a4c-115">Este tópico pressupõe que você sabe como criar soluções e projetos do Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-115">This topic assumes you know how to create Visual Studio 2012 projects and solutions.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="b6a4c-116">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="b6a4c-116">Prerequisites</span></span>
 <span data-ttu-id="b6a4c-117">Você deve ter o seguinte software instalado para usar este passo a passo:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-117">You must have the following software installed to use this walkthrough:</span></span>

1. <span data-ttu-id="b6a4c-118">Microsoft SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="b6a4c-118">Microsoft SQL Server 2008</span></span>

2. <span data-ttu-id="b6a4c-119">Visual Studio 2012</span><span class="sxs-lookup"><span data-stu-id="b6a4c-119">Visual Studio 2012</span></span>

3. <span data-ttu-id="b6a4c-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span><span class="sxs-lookup"><span data-stu-id="b6a4c-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span></span>

4. <span data-ttu-id="b6a4c-121">Você está familiarizado com o WCF e o Visual Studio 2012 e sabe como criar projetos/soluções.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-121">You are familiar with WCF and Visual Studio 2012 and know how to create projects/solutions.</span></span>

### <a name="to-setup-the-sql-database"></a><span data-ttu-id="b6a4c-122">Para configurar o banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="b6a4c-122">To Setup the SQL Database</span></span>

1. <span data-ttu-id="b6a4c-123">Para instâncias de serviço de fluxo de trabalho a serem persistidos que você deve ter o Microsoft SQL Server instalado e você deve configurar um banco de dados para armazenar as instâncias de fluxo de trabalho persistida.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-123">In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.</span></span> <span data-ttu-id="b6a4c-124">Execute o Microsoft SQL Management Studio clicando o **inicie** botão, selecionando **todos os programas**, **Microsoft SQL Server 2008**, e **Microsoft SQL Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-124">Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.</span></span>

2. <span data-ttu-id="b6a4c-125">Clique o **Connect** botão para fazer logon na instância do SQL Server</span><span class="sxs-lookup"><span data-stu-id="b6a4c-125">Click the **Connect** button to log on to the SQL Server instance</span></span>

3. <span data-ttu-id="b6a4c-126">Clique com botão direito **bancos de dados** no modo de exibição de árvore e selecione **novo banco de dados...**</span><span class="sxs-lookup"><span data-stu-id="b6a4c-126">Right click **Databases** in the tree view and select **New Database..**</span></span> <span data-ttu-id="b6a4c-127">para criar um novo banco de dados chamado `SQLPersistenceStore`.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-127">to create a new database called `SQLPersistenceStore`.</span></span>

4. <span data-ttu-id="b6a4c-128">Execute o arquivo de script Sqlworkflowinstancestoreschema localizado no diretório C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en no banco de dados SQLPersistenceStore para configurar os esquemas de banco de dados necessários.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-128">Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database schemas.</span></span>

5. <span data-ttu-id="b6a4c-129">Execute o arquivo de script de Sqlworkflowinstancestorelogic localizado no diretório C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en no banco de dados SQLPersistenceStore para configurar a lógica de banco de dados necessários.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-129">Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database logic.</span></span>

### <a name="to-create-the-web-hosted-workflow-service"></a><span data-ttu-id="b6a4c-130">Para criar a Web hospedado no serviço de fluxo de trabalho</span><span class="sxs-lookup"><span data-stu-id="b6a4c-130">To Create the Web Hosted Workflow Service</span></span>

1. <span data-ttu-id="b6a4c-131">Crie uma solução vazia do Visual Studio 2012, nomeie- `OrderProcessing`.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-131">Create an empty Visual Studio 2012 solution, name it `OrderProcessing`.</span></span>

2. <span data-ttu-id="b6a4c-132">Adicionar um novo projeto de aplicativo de serviço de fluxo de trabalho WCF chamado `OrderService` à solução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-132">Add a new WCF Workflow Service Application project called `OrderService` to the solution.</span></span>

3. <span data-ttu-id="b6a4c-133">Na caixa de diálogo de propriedades da projeto, selecione a **Web** guia.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-133">In the project properties dialog, select the **Web** tab.</span></span>

    1. <span data-ttu-id="b6a4c-134">Sob **iniciar ação** selecionar **página específica** e especifique `Service1.xamlx`.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-134">Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.</span></span>

         <span data-ttu-id="b6a4c-135">![Propriedades de Web de projeto de serviço de fluxo de trabalho](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "criar o serviço de fluxo de trabalho hospedado na web - opção de página específica")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-135">![Workflow Service Project Web Properties](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Create the web hosted workflow service - Specific Page option")</span></span>

    2. <span data-ttu-id="b6a4c-136">Sob **servidores** selecionar **servidor Web do IIS Local Use**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-136">Under **Servers** select **Use Local IIS Web server**.</span></span>

         <span data-ttu-id="b6a4c-137">![Configurações do servidor Web local](./media/creating-a-long-running-workflow-service/use-local-web-server.png "criar o serviço de fluxo de trabalho hospedado na web - opção de usar o servidor de Web do IIS Local")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-137">![Local Web Server Settings](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Create the web hosted workflow service - Use Local IIS Web Server option")</span></span>

        > [!WARNING]
        >  <span data-ttu-id="b6a4c-138">Você deve executar o Visual Studio 2012 no modo administrador para fazer essa configuração.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-138">You must run Visual Studio 2012 in administrator mode to make this setting.</span></span>

         <span data-ttu-id="b6a4c-139">Essas duas etapas configuram o projeto de serviço de fluxo de trabalho seja hospedado pelo IIS.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-139">These two steps configure the workflow service project to be hosted by IIS.</span></span>

4. <span data-ttu-id="b6a4c-140">Abra `Service1.xamlx` se ele estiver não abrir já e exclua o existente **ReceiveRequest** e **SendResponse** atividades.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-140">Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.</span></span>

5. <span data-ttu-id="b6a4c-141">Selecione o **Sequential Service** atividade e clique no **variáveis** vincular e adicione as variáveis mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-141">Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration.</span></span> <span data-ttu-id="b6a4c-142">Isso adiciona algumas variáveis que serão usados posteriormente no serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-142">Doing this adds some variables that will be used later on in the workflow service.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="b6a4c-143">Se o CorrelationHandle não estiver na lista suspensa tipo de variável, selecione **procurar tipos** na lista suspensa.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-143">If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down.</span></span> <span data-ttu-id="b6a4c-144">Digite CorrelationHandle na **nome do tipo** selecione CorrelationHandle na caixa de listagem e clique em **Okey**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-144">Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.</span></span>

     <span data-ttu-id="b6a4c-145">![Adicione variáveis](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "adicionar variáveis à atividade Sequential Service.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-145">![Add Variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Add variables to the Sequential Service activity.")</span></span>

6. <span data-ttu-id="b6a4c-146">Arraste e solte uma **ReceiveAndSendReply** modelo de atividade para o **Sequential Service** atividade.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-146">Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity.</span></span> <span data-ttu-id="b6a4c-147">Esse conjunto de atividades será receber uma mensagem de um cliente e enviar uma resposta de volta.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-147">This set of activities will receive a message from a client and send a reply back.</span></span>

    1. <span data-ttu-id="b6a4c-148">Selecione o **Receive** atividade e defina as propriedades realçadas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-148">Select the **Receive** activity and set the properties highlighted in the following illustration.</span></span>

         <span data-ttu-id="b6a4c-149">![Definir propriedades de atividade receber](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "definir as propriedades de atividade de recebimento.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-149">![Set Receive Activity Properties](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Set the Receive activity properties.")</span></span>

         <span data-ttu-id="b6a4c-150">A propriedade DisplayName define o nome exibido para a atividade Receive no designer.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-150">The DisplayName property sets the name displayed for the Receive activity in the designer.</span></span> <span data-ttu-id="b6a4c-151">As propriedades ServiceContractName e OperationName especificam o nome do contrato de serviço e operação são implementados pela atividade Receive.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-151">The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.</span></span> <span data-ttu-id="b6a4c-152">Para obter mais informações sobre como os contratos são usados nos serviços de fluxo de trabalho, consulte [utilizando contratos no fluxo de trabalho](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="b6a4c-152">For more information about how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span></span>

    2. <span data-ttu-id="b6a4c-153">Clique o **defina...**  link na **ReceiveStartOrder** atividade e defina as propriedades mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-153">Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.</span></span>  <span data-ttu-id="b6a4c-154">Observe que o **parâmetros** botão de opção é selecionado, um parâmetro denominado `p_customerName` está associado a `customerName` variável.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-154">Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable.</span></span> <span data-ttu-id="b6a4c-155">Isso configura a **Receive** atividade receber alguns dados e associar dados a variáveis locais.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-155">This configures the **Receive** activity to receive some data and bind that data to local variables.</span></span>

         <span data-ttu-id="b6a4c-156">![Definindo os dados recebidos pela atividade Receive](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "definir as propriedades de dados recebidos pela atividade Receive.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-156">![Setting the data received by the Receive activity](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Set the properties for data received by the Receive activity.")</span></span>

    3. <span data-ttu-id="b6a4c-157">Selecione o **SendReplyToReceive** atividade e defina a propriedade realçada mostrada na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-157">Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.</span></span>

         <span data-ttu-id="b6a4c-158">![Definindo as propriedades da atividade SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-158">![Setting the properties of the SendReply activity](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span></span>

    4. <span data-ttu-id="b6a4c-159">Clique o **defina...**  link na **SendReplyToStartOrder** atividade e defina as propriedades mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-159">Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration.</span></span> <span data-ttu-id="b6a4c-160">Observe que o **parâmetros** botão de opção é selecionado; um parâmetro chamado `p_orderId` está associado a `orderId` variável.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-160">Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable.</span></span> <span data-ttu-id="b6a4c-161">Essa configuração especifica que a atividade SendReplyToStartOrder retornará um valor de cadeia de caracteres de tipo para o chamador.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-161">This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.</span></span>

         <span data-ttu-id="b6a4c-162">![Configurando os dados de conteúdo de atividade de SendReply](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "definir a configuração para a atividade de SetReplyToStartOrder.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-162">![Configuring the SendReply activity content data](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configure setting for SetReplyToStartOrder activity.")</span></span>

    5. <span data-ttu-id="b6a4c-163">Arrastar e soltar uma atividade de atribuição entre o **Receive** e **SendReply** atividades e defina as propriedades conforme mostrado na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-163">Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:</span></span>

         <span data-ttu-id="b6a4c-164">![Adicionar uma atividade assign](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "adicionar uma atividade de atribuição.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-164">![Adding an assign activity](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Add an assign activity.")</span></span>

         <span data-ttu-id="b6a4c-165">Isso cria uma nova ID de ordem e coloca o valor na variável orderId.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-165">This creates a new order ID and places the value in the orderId variable.</span></span>

    6. <span data-ttu-id="b6a4c-166">Selecione o **ReplyToStartOrder** atividade.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-166">Select the **ReplyToStartOrder** activity.</span></span> <span data-ttu-id="b6a4c-167">Na janela Propriedades, clique no botão de reticências para **CorrelationInitializers**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-167">In the properties window click the ellipsis button for **CorrelationInitializers**.</span></span> <span data-ttu-id="b6a4c-168">Selecione o **adicionar inicializador** link, digite `orderIdHandle` na caixa de texto de inicializador, selecione o inicializador de correlação de consulta para o tipo de correlação e selecione p_orderId sob a caixa de lista suspensa de consultas XPATH.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-168">Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.</span></span> <span data-ttu-id="b6a4c-169">Essas configurações são mostradas na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-169">These settings are shown in the following illustration.</span></span> <span data-ttu-id="b6a4c-170">Clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-170">Click **OK**.</span></span>  <span data-ttu-id="b6a4c-171">Isso inicializa uma correlação entre o cliente e essa instância do serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-171">This initializes a correlation between the client and this instance of the workflow service.</span></span> <span data-ttu-id="b6a4c-172">Quando uma mensagem que contém essa ordem de que ID é recebida, ela é roteada para esta instância do serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-172">When a message containing this order ID is received it is routed to this instance of the workflow service.</span></span>

         <span data-ttu-id="b6a4c-173">![Adicionando um inicializador de correlação](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "adicionar um inicializador de correlação.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-173">![Adding a correlation initializer](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Add a correlation initializer.")</span></span>

7. <span data-ttu-id="b6a4c-174">Arraste e solte outra **ReceiveAndSendReply** atividade até o final do fluxo de trabalho (fora do **sequência** que contém o primeiro **Receive** e  **SendReply** atividades).</span><span class="sxs-lookup"><span data-stu-id="b6a4c-174">Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities).</span></span> <span data-ttu-id="b6a4c-175">Isso irá receber a segunda mensagem enviada pelo cliente e responder a ele.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-175">This will receive the second message sent by the client and respond to it.</span></span>

    1. <span data-ttu-id="b6a4c-176">Selecione o **sequência** que contém o recém-adicionado **Receive** e **SendReply** atividades e clique no **variáveis** botão.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-176">Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button.</span></span> <span data-ttu-id="b6a4c-177">Adicione a variável realçada na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-177">Add the variable highlighted in the following illustration:</span></span>

         <span data-ttu-id="b6a4c-178">![Adicionando novas variáveis](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "adicionar a variável de ItemId.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-178">![Adding new variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Add the ItemId variable.")</span></span>

    2. <span data-ttu-id="b6a4c-179">Selecione o **Receive** atividade e defina as propriedades mostradas na ilustração a seguir:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-179">Select the **Receive** activity and set the properties shown in the following illustration:</span></span>

         <span data-ttu-id="b6a4c-180">![Definir as propriedades de atividade de recebimento](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "definir as propriedades de atividades de recebimento.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-180">![Set the Receive acitivity properties](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Set the Receive activities properties.")</span></span>

    3. <span data-ttu-id="b6a4c-181">Clique o **defina...**  link na **ReceiveAddItem** atividade e adicione os parâmetros mostrados na ilustração a seguir: Isso configura a atividade de recebimento para aceitar dois parâmetros, a ID da ordem e a ID do item que estão sendo ordenada.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-181">Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.</span></span>

         <span data-ttu-id="b6a4c-182">![Especificando parâmetros para o segundo recebimento](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "configurar a atividade de recebimento para receber dois parâmetros.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-182">![Specifying parameters for the second receive](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure the receive activity to receive two parameters.")</span></span>

    4. <span data-ttu-id="b6a4c-183">Clique o **CorrelateOn** reticências e digitar `orderIdHandle`.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-183">Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`.</span></span> <span data-ttu-id="b6a4c-184">Sob **consultas XPath**, clique na seta suspensa e selecione `p_orderId`.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-184">Under **XPath Queries**, click the drop down arrow and select `p_orderId`.</span></span> <span data-ttu-id="b6a4c-185">Isso configura a correlação na segunda atividade de recebimento.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-185">This configures the correlation on the second receive activity.</span></span> <span data-ttu-id="b6a4c-186">Para obter mais informações sobre a correlação, consulte [correlação](../../../../docs/framework/wcf/feature-details/correlation.md).</span><span class="sxs-lookup"><span data-stu-id="b6a4c-186">For more information about correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md).</span></span>

         <span data-ttu-id="b6a4c-187">![Definindo a propriedade CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "defina a propriedade CorrelatesOn.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-187">![Setting the CorrelatesOn property](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Set the CorrelatesOn property.")</span></span>

    5. <span data-ttu-id="b6a4c-188">Arraste e solte uma **se** atividade imediatamente após o **ReceiveAddItem** atividade.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-188">Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity.</span></span> <span data-ttu-id="b6a4c-189">Essa atividade atua como um se instrução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-189">This activity acts just like an if statement.</span></span>

        1. <span data-ttu-id="b6a4c-190">Defina as **condição** propriedade `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span><span class="sxs-lookup"><span data-stu-id="b6a4c-190">Set the **Condition** property to `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span></span>

        2. <span data-ttu-id="b6a4c-191">Arrastar e soltar uma **atribuir** atividade para o **, em seguida,** seção e outro para o **Else** seção definir as propriedades do **atribuir** atividades, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-191">Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.</span></span>

             <span data-ttu-id="b6a4c-192">![Atribuir o resultado da chamada de serviço](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "atribuir o resultado da chamada de serviço.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-192">![Assigning the result of the service call](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assign the result of the service call.")</span></span>

             <span data-ttu-id="b6a4c-193">Se a condição for `true` as **, em seguida,** seção será executada.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-193">If the condition is `true` the **Then** section will be executed.</span></span> <span data-ttu-id="b6a4c-194">Se a condição for `false` as **Else** seção será executada.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-194">If the condition is `false` the **Else** section is executed.</span></span>

        3. <span data-ttu-id="b6a4c-195">Selecione o **SendReplyToReceive** atividade e conjunto de **DisplayName** propriedade mostrada na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-195">Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.</span></span>

             <span data-ttu-id="b6a4c-196">![Definindo as propriedades da atividade SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "defina a propriedade de atividade de SendReply.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-196">![Setting the SendReply activity properties](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Set the SendReply activity property.")</span></span>

        4. <span data-ttu-id="b6a4c-197">Clique o **defina...**  link na **SetReplyToAddItem** atividade e configurá-lo, conforme mostrado na ilustração a seguir.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-197">Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration.</span></span> <span data-ttu-id="b6a4c-198">Isso configura a **SendReplyToAddItem** atividade para retornar o valor de `orderResult` variável.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-198">This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.</span></span>

             <span data-ttu-id="b6a4c-199">![Definindo a associação de dados para a atividade de SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "definir propriedade de atividade SendReplyToAddItem.")</span><span class="sxs-lookup"><span data-stu-id="b6a4c-199">![Setting the data binding for the SendReply activity](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Set property for SendReplyToAddItem activity.")</span></span>

8. <span data-ttu-id="b6a4c-200">Abra o arquivo Web. config e adicione os seguintes elementos no \<comportamento > seção para habilitar a persistência de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-200">Open the web.config file and add the following elements in the \<behavior> section to enable workflow persistence.</span></span>

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    >  <span data-ttu-id="b6a4c-201">Certifique-se de substituir seu host e o nome da instância do SQL server no trecho de código anterior.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-201">Make sure to replace your host and SQL server instance name in the previous code snippet.</span></span>

9. <span data-ttu-id="b6a4c-202">Compile a solução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-202">Build the solution.</span></span>

### <a name="to-create-a-client-application-to-call-the-workflow-service"></a><span data-ttu-id="b6a4c-203">Para criar um aplicativo cliente para chamar o serviço de fluxo de trabalho</span><span class="sxs-lookup"><span data-stu-id="b6a4c-203">To Create a Client Application to Call the Workflow Service</span></span>

1. <span data-ttu-id="b6a4c-204">Adicionar um novo projeto de aplicativo de Console chamado `OrderClient` à solução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-204">Add a new Console application project called `OrderClient` to the solution.</span></span>

2. <span data-ttu-id="b6a4c-205">Adicione referências aos assemblies a seguir para o `OrderClient` projeto</span><span class="sxs-lookup"><span data-stu-id="b6a4c-205">Add references to the following assemblies to the `OrderClient` project</span></span>

    1. <span data-ttu-id="b6a4c-206">System.ServiceModel.dll</span><span class="sxs-lookup"><span data-stu-id="b6a4c-206">System.ServiceModel.dll</span></span>

    2. <span data-ttu-id="b6a4c-207">System.ServiceModel.Activities.dll</span><span class="sxs-lookup"><span data-stu-id="b6a4c-207">System.ServiceModel.Activities.dll</span></span>

3. <span data-ttu-id="b6a4c-208">Adicionar uma referência de serviço para o serviço de fluxo de trabalho e especificar `OrderService` como o namespace.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-208">Add a service reference to the workflow service and specify `OrderService` as the namespace.</span></span>

4. <span data-ttu-id="b6a4c-209">No `Main()` método do projeto cliente adicione o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-209">In the `Main()` method of the client project add the following code:</span></span>

    ```
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. <span data-ttu-id="b6a4c-210">Compile a solução e executar o `OrderClient` aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-210">Build the solution and run the `OrderClient` application.</span></span> <span data-ttu-id="b6a4c-211">O cliente exibirá o seguinte texto:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-211">The client will display the following text:</span></span>

    ```Output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. <span data-ttu-id="b6a4c-212">Para verificar que o serviço de fluxo de trabalho tiver sido persistido, inicie o SQL Server Management Studio, vá para o **inicie** menu, selecionando **todos os programas**, **doMicrosoftSQLServer2008**, **SQL Server Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-212">To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span></span>

    1. <span data-ttu-id="b6a4c-213">No painel esquerdo, expanda, **bancos de dados**, **SQLPersistenceStore**, **modos de exibição** e clique com botão direito **System.Activities.DurableInstancing.Instances**  e selecione **selecionar 1000 linhas superiores**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-213">In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**.</span></span> <span data-ttu-id="b6a4c-214">No **resultados** painel, verifique se você ver pelo menos uma instância listada.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-214">In the **Results** pane verify you see at least one instance listed.</span></span> <span data-ttu-id="b6a4c-215">Pode haver outras instâncias de execuções anteriores se ocorreu uma exceção durante a execução.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-215">There may be other instances from prior runs if an exception occurred while running.</span></span> <span data-ttu-id="b6a4c-216">Você pode excluir linhas existentes, clicando com o botão direito **System.Activities.DurableInstancing.Instances** e selecionando **Editar Top 200 linhas**, pressione a **Execute** botão, Selecionar todas as linhas no painel de resultados e selecionando **excluir**.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-216">You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.</span></span>  <span data-ttu-id="b6a4c-217">Para verificar a instância exibida no banco de dados a instância do seu aplicativo é criado, verifique se a exibição de instâncias está vazia antes de executar o cliente.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-217">To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.</span></span> <span data-ttu-id="b6a4c-218">Depois que o cliente está em execução de executar novamente a consulta (Selecionar 1000 linhas superiores) e verifique se foi adicionada uma nova instância.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-218">Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.</span></span>

7. <span data-ttu-id="b6a4c-219">Pressione enter para enviar a mensagem do item Adicionar para o serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="b6a4c-219">Press enter to send the add item message to the workflow service.</span></span> <span data-ttu-id="b6a4c-220">O cliente exibirá o seguinte texto:</span><span class="sxs-lookup"><span data-stu-id="b6a4c-220">The client will display the following text:</span></span>

    ```Output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a><span data-ttu-id="b6a4c-221">Consulte também</span><span class="sxs-lookup"><span data-stu-id="b6a4c-221">See also</span></span>

- [<span data-ttu-id="b6a4c-222">Serviços de fluxo de trabalho</span><span class="sxs-lookup"><span data-stu-id="b6a4c-222">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
