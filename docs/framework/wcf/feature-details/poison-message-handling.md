---
title: Manuseio de mensagem suspeita
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: fe748ac40f03ed22cacb254ab464a6caf3d27a8c
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/23/2019
ms.locfileid: "62046431"
---
# <a name="poison-message-handling"></a><span data-ttu-id="d6800-102">Manuseio de mensagem suspeita</span><span class="sxs-lookup"><span data-stu-id="d6800-102">Poison Message Handling</span></span>
<span data-ttu-id="d6800-103">Um *de mensagens suspeitas* é uma mensagem que foi excedido o número máximo de tentativas de entrega para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-103">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="d6800-104">Essa situação pode ocorrer quando um aplicativo baseado em fila não pode processar uma mensagem devido a erros.</span><span class="sxs-lookup"><span data-stu-id="d6800-104">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="d6800-105">Para atender às demandas de confiabilidade, um aplicativo na fila recebe mensagens em uma transação.</span><span class="sxs-lookup"><span data-stu-id="d6800-105">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="d6800-106">Anulando a transação na qual uma mensagem na fila foi recebida deixa a mensagem na fila para que a mensagem é repetida em uma nova transação.</span><span class="sxs-lookup"><span data-stu-id="d6800-106">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="d6800-107">Se o problema que causou a anulação da transação não for corrigido, o aplicativo de recebimento pode fique preso em um loop de recebimento e anulando a mesma mensagem até que o número máximo de tentativas de entrega foi excedido e resultados de uma mensagem suspeita.</span><span class="sxs-lookup"><span data-stu-id="d6800-107">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="d6800-108">Uma mensagem pode se tornar uma mensagem suspeita por vários motivos.</span><span class="sxs-lookup"><span data-stu-id="d6800-108">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="d6800-109">Os motivos mais comuns são específicos do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-109">The most common reasons are application specific.</span></span> <span data-ttu-id="d6800-110">Por exemplo, se um aplicativo lê uma mensagem de uma fila e executa algum processamento do banco de dados, o aplicativo pode falhar obter um bloqueio no banco de dados, fazendo com que ele anular a transação.</span><span class="sxs-lookup"><span data-stu-id="d6800-110">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="d6800-111">Porque a transação de banco de dados foi anulada, a mensagem permanecerá na fila, que faz com que o aplicativo releia a mensagem uma segunda vez e fazer outra tentativa para adquirir um bloqueio no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d6800-111">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="d6800-112">As mensagens também podem se tornar suspeitas se eles contiverem informações inválidas.</span><span class="sxs-lookup"><span data-stu-id="d6800-112">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="d6800-113">Por exemplo, uma ordem de compra pode conter um número inválido de cliente.</span><span class="sxs-lookup"><span data-stu-id="d6800-113">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="d6800-114">Nesses casos, o aplicativo pode anular a transação voluntariamente e forçar a mensagem se torne uma mensagem suspeita.</span><span class="sxs-lookup"><span data-stu-id="d6800-114">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="d6800-115">Em raras ocasiões, as mensagens podem falhar ao expedidas para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-115">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="d6800-116">A camada do Windows Communication Foundation (WCF) encontrar um problema com a mensagem, como se a mensagem tiver o quadro errado, as credenciais de mensagem inválido anexado a ele ou um cabeçalho de ação inválida.</span><span class="sxs-lookup"><span data-stu-id="d6800-116">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="d6800-117">Nesses casos, o aplicativo nunca recebe a mensagem; No entanto, a mensagem ainda pode se tornar uma mensagem suspeita e ser processada manualmente.</span><span class="sxs-lookup"><span data-stu-id="d6800-117">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="d6800-118">Manipular mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="d6800-118">Handling Poison Messages</span></span>  
 <span data-ttu-id="d6800-119">No WCF, manipulação de mensagens suspeitas fornece um mecanismo para um aplicativo de recebimento lidar com mensagens que não podem ser expedidas para o aplicativo ou mensagens que são expedidos para o aplicativo, mas que não conseguirem ser processadas por causa de específicos do aplicativo motivos.</span><span class="sxs-lookup"><span data-stu-id="d6800-119">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application, or messages that are dispatched to the application but which fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="d6800-120">Manipulação de mensagens suspeitas está configurada pelas seguintes propriedades em cada uma das associações em fila disponíveis:</span><span class="sxs-lookup"><span data-stu-id="d6800-120">Poison message handling is configured by the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="d6800-121">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="d6800-121">`ReceiveRetryCount`.</span></span> <span data-ttu-id="d6800-122">Um valor inteiro que indica o número máximo de tentativas de entrega de uma mensagem da fila de aplicativos para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-122">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="d6800-123">O valor padrão é 5.</span><span class="sxs-lookup"><span data-stu-id="d6800-123">The default value is 5.</span></span> <span data-ttu-id="d6800-124">Isso é suficiente em casos em que uma repetição imediata corrige o problema, como com um deadlock temporário em um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d6800-124">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="d6800-125">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="d6800-125">`MaxRetryCycles`.</span></span> <span data-ttu-id="d6800-126">Um valor inteiro que indica o número máximo de ciclos de repetição.</span><span class="sxs-lookup"><span data-stu-id="d6800-126">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="d6800-127">Um ciclo de repetição consiste em transferir uma mensagem da fila de aplicativos para a subfila de repetição e, após um intervalo configurável, da subfila de mensagens de repetição volta para a fila de aplicativos tentarão novamente a entrega.</span><span class="sxs-lookup"><span data-stu-id="d6800-127">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="d6800-128">O valor padrão é 2.</span><span class="sxs-lookup"><span data-stu-id="d6800-128">The default value is 2.</span></span> <span data-ttu-id="d6800-129">Na [!INCLUDE[wv](../../../../includes/wv-md.md)], a mensagem é tentada um máximo de (`ReceiveRetryCount` + 1) \* (`MaxRetryCycles` + 1) vezes.</span><span class="sxs-lookup"><span data-stu-id="d6800-129">On [!INCLUDE[wv](../../../../includes/wv-md.md)], the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="d6800-130">`MaxRetryCycles` é ignorado em [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-130">`MaxRetryCycles` is ignored on [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
- <span data-ttu-id="d6800-131">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="d6800-131">`RetryCycleDelay`.</span></span> <span data-ttu-id="d6800-132">O tempo de espera entre os ciclos de repetição.</span><span class="sxs-lookup"><span data-stu-id="d6800-132">The time delay between retry cycles.</span></span> <span data-ttu-id="d6800-133">O valor padrão é 30 minutos.</span><span class="sxs-lookup"><span data-stu-id="d6800-133">The default value is 30 minutes.</span></span> <span data-ttu-id="d6800-134">`MaxRetryCycles` e `RetryCycleDelay` juntos fornecem um mecanismo para resolver o problema em que uma repetição após um intervalo periódico corrige o problema.</span><span class="sxs-lookup"><span data-stu-id="d6800-134">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="d6800-135">Por exemplo, isso lida com uma linha bloqueada definida no SQL Server pendentes confirmação da transação.</span><span class="sxs-lookup"><span data-stu-id="d6800-135">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="d6800-136">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="d6800-136">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="d6800-137">Uma enumeração que indica a ação a tomar para uma mensagem que falha na entrega depois que o número máximo de repetições foi tentado.</span><span class="sxs-lookup"><span data-stu-id="d6800-137">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="d6800-138">Os valores podem ser falhas, Drop, rejeitar e mover.</span><span class="sxs-lookup"><span data-stu-id="d6800-138">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="d6800-139">A opção padrão é falha.</span><span class="sxs-lookup"><span data-stu-id="d6800-139">The default option is Fault.</span></span>  
  
- <span data-ttu-id="d6800-140">Falha.</span><span class="sxs-lookup"><span data-stu-id="d6800-140">Fault.</span></span> <span data-ttu-id="d6800-141">Essa opção envia uma falha para o ouvinte que causou o `ServiceHost` à falha.</span><span class="sxs-lookup"><span data-stu-id="d6800-141">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="d6800-142">A mensagem deve ser removida da fila de aplicativos por algum mecanismo externo antes que o aplicativo possa continuar a processar mensagens da fila.</span><span class="sxs-lookup"><span data-stu-id="d6800-142">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="d6800-143">Descarte.</span><span class="sxs-lookup"><span data-stu-id="d6800-143">Drop.</span></span> <span data-ttu-id="d6800-144">Essa opção descarta a mensagem suspeita e a mensagem nunca é entregue ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-144">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="d6800-145">Se a mensagem `TimeToLive` propriedade tiver expirado neste ponto, em seguida, a mensagem pode aparecer na fila de mensagens mortas do remetente.</span><span class="sxs-lookup"><span data-stu-id="d6800-145">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="d6800-146">Caso contrário, a mensagem não aparecerá em lugar nenhum.</span><span class="sxs-lookup"><span data-stu-id="d6800-146">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="d6800-147">Esta opção indica que o usuário não tiver especificado o que fazer se a mensagem será perdida.</span><span class="sxs-lookup"><span data-stu-id="d6800-147">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="d6800-148">Rejeite.</span><span class="sxs-lookup"><span data-stu-id="d6800-148">Reject.</span></span> <span data-ttu-id="d6800-149">Essa opção está disponível apenas em [!INCLUDE[wv](../../../../includes/wv-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-149">This option is available only on [!INCLUDE[wv](../../../../includes/wv-md.md)].</span></span> <span data-ttu-id="d6800-150">Isso instrui o enfileiramento de mensagens (MSMQ) para enviar uma confirmação negativa de volta para o Gerenciador de fila de envio que o aplicativo não pode receber a mensagem.</span><span class="sxs-lookup"><span data-stu-id="d6800-150">This instructs Message Queuing (MSMQ) to send a negative acknowledgement back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="d6800-151">A mensagem é colocada na fila de inatividade do Gerenciador de fila envio.</span><span class="sxs-lookup"><span data-stu-id="d6800-151">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="d6800-152">Mova.</span><span class="sxs-lookup"><span data-stu-id="d6800-152">Move.</span></span> <span data-ttu-id="d6800-153">Essa opção está disponível apenas em [!INCLUDE[wv](../../../../includes/wv-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-153">This option is available only on [!INCLUDE[wv](../../../../includes/wv-md.md)].</span></span> <span data-ttu-id="d6800-154">Isso move a mensagem suspeita para uma fila de mensagens suspeitas para processamento posterior por um aplicativo de tratamento de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-154">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="d6800-155">A fila de mensagens suspeitas é uma subfila da fila de aplicativos.</span><span class="sxs-lookup"><span data-stu-id="d6800-155">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="d6800-156">Um aplicativo de tratamento de mensagens suspeitas pode ser um serviço WCF que lê mensagens de fila de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-156">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="d6800-157">Fila de mensagens suspeitas é uma subfila da fila de aplicativos e podem ser tratada como net.msmq://\<*nome da máquina*>/*applicationQueue*; suspeitas, onde  *nome da máquina* é o nome do computador no qual reside a fila e o *applicationQueue* é o nome da fila específica do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-157">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
 <span data-ttu-id="d6800-158">A seguir estão o número máximo de tentativas da entrega feita para uma mensagem:</span><span class="sxs-lookup"><span data-stu-id="d6800-158">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="d6800-159">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) em [!INCLUDE[wv](../../../../includes/wv-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-159">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on [!INCLUDE[wv](../../../../includes/wv-md.md)].</span></span>  
  
- <span data-ttu-id="d6800-160">(ReceiveRetryCount + 1) no [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-160">(ReceiveRetryCount + 1) on [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="d6800-161">Sem novas tentativas são feitas para uma mensagem que é entregue com êxito.</span><span class="sxs-lookup"><span data-stu-id="d6800-161">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="d6800-162">Para controlar o número de vezes que uma mensagem de leitura for tentada, [!INCLUDE[wv](../../../../includes/wv-md.md)] mantém uma propriedade de mensagem durável que conta o número de Anulações e uma propriedade de contagem de movimentação que conta o número de vezes que a mensagem se movem entre a fila de aplicativos e subfilas.</span><span class="sxs-lookup"><span data-stu-id="d6800-162">To keep track of the number of times a message read is attempted, [!INCLUDE[wv](../../../../includes/wv-md.md)] maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="d6800-163">O canal do WCF usa estes para calcular a contagem de repetição de recebimento e a contagem de ciclos de repetição.</span><span class="sxs-lookup"><span data-stu-id="d6800-163">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="d6800-164">Na [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)], a contagem de anulação é mantida na memória pelo canal do WCF e é redefinida quando o aplicativo falhar.</span><span class="sxs-lookup"><span data-stu-id="d6800-164">On [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)], the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="d6800-165">Além disso, o canal do WCF pode manter que contagens de anulação de até 256 mensagens na memória a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="d6800-165">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="d6800-166">Se uma mensagem 257th é lida, contagem de anulação da mensagem mais antigo será redefinida.</span><span class="sxs-lookup"><span data-stu-id="d6800-166">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="d6800-167">A anulação de contagem e contagem de propriedades estão disponíveis para a operação de serviço por meio do contexto da operação de mover.</span><span class="sxs-lookup"><span data-stu-id="d6800-167">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="d6800-168">O exemplo de código a seguir mostra como acessá-los.</span><span class="sxs-lookup"><span data-stu-id="d6800-168">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="d6800-169">O WCF fornece duas ligações na fila padrão:</span><span class="sxs-lookup"><span data-stu-id="d6800-169">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="d6800-170"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="d6800-170"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="d6800-171">Um [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] associação adequada para a execução de comunicação baseada em fila com outros pontos de extremidade do WCF.</span><span class="sxs-lookup"><span data-stu-id="d6800-171">A [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="d6800-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="d6800-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="d6800-173">Uma associação adequada para se comunicar com aplicativos de enfileiramento de mensagens existentes.</span><span class="sxs-lookup"><span data-stu-id="d6800-173">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="d6800-174">Você pode alterar propriedades nessas associações de acordo com as necessidades do seu serviço WCF.</span><span class="sxs-lookup"><span data-stu-id="d6800-174">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="d6800-175">A mensagem suspeita toda mecanismo de tratamento é local para o aplicativo de recebimento.</span><span class="sxs-lookup"><span data-stu-id="d6800-175">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="d6800-176">O processo é invisível para o aplicativo de envio, a menos que o aplicativo de recebimento, por fim, interrompe e envia uma confirmação negativa volta ao remetente.</span><span class="sxs-lookup"><span data-stu-id="d6800-176">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="d6800-177">Nesse caso, a mensagem é movida para a fila de mensagens mortas do remetente.</span><span class="sxs-lookup"><span data-stu-id="d6800-177">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="d6800-178">Prática recomendada: Tratamento de MsmqPoisonMessageException</span><span class="sxs-lookup"><span data-stu-id="d6800-178">Best Practice: Handling MsmqPoisonMessageException</span></span>  
 <span data-ttu-id="d6800-179">Quando o serviço determina que uma mensagem é suspeita, transporte enfileirado lança um <xref:System.ServiceModel.MsmqPoisonMessageException> que contém o `LookupId` da mensagem suspeita.</span><span class="sxs-lookup"><span data-stu-id="d6800-179">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="d6800-180">Um aplicativo de recebimento pode implementar o <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface para tratar os erros que o aplicativo requer.</span><span class="sxs-lookup"><span data-stu-id="d6800-180">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="d6800-181">Para obter mais informações, consulte [estendendo o controle sobre o tratamento de erros e emissão de relatórios](../../../../docs/framework/wcf/samples/extending-control-over-error-handling-and-reporting.md).</span><span class="sxs-lookup"><span data-stu-id="d6800-181">For more information, see [Extending Control Over Error Handling and Reporting](../../../../docs/framework/wcf/samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="d6800-182">O aplicativo pode exigir algum tipo de manipulação de mensagens suspeitas automatizado que move as mensagens suspeitas em uma fila de mensagens suspeitas, para que o serviço possa acessar o restante das mensagens na fila.</span><span class="sxs-lookup"><span data-stu-id="d6800-182">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="d6800-183">O único cenário para usar o mecanismo do manipulador de erro para escutar mensagens suspeitas exceções é quando o <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> configuração é definida como <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span><span class="sxs-lookup"><span data-stu-id="d6800-183">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="d6800-184">O exemplo de mensagens suspeitas para enfileiramento de mensagens 3.0 demonstra esse comportamento.</span><span class="sxs-lookup"><span data-stu-id="d6800-184">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="d6800-185">O exemplo a seguir descreve as etapas necessárias para tratar mensagens suspeitas, incluindo práticas recomendadas:</span><span class="sxs-lookup"><span data-stu-id="d6800-185">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="d6800-186">Certifique-se de que suas configurações suspeitas refletem os requisitos do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-186">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="d6800-187">Ao trabalhar com as configurações, certifique-se de que você entenda as diferenças entre os recursos do enfileiramento de mensagens em [!INCLUDE[wv](../../../../includes/wv-md.md)], [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-187">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on [!INCLUDE[wv](../../../../includes/wv-md.md)], [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
2. <span data-ttu-id="d6800-188">Se necessário, implemente o `IErrorHandler` para lidar com erros de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-188">If required, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="d6800-189">Como definir `ReceiveErrorHandling` para `Fault` requer um mecanismo manual para mover a mensagem suspeita fora da fila ou para corrigir um problema de dependente externo, o uso típico é implementar `IErrorHandler` quando `ReceiveErrorHandling` é definido como `Fault`, como como mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="d6800-189">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="d6800-190">Criar um `PoisonBehaviorAttribute` que o comportamento de serviço pode usar.</span><span class="sxs-lookup"><span data-stu-id="d6800-190">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="d6800-191">Instala o comportamento de `IErrorHandler` no dispatcher.</span><span class="sxs-lookup"><span data-stu-id="d6800-191">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="d6800-192">Consulte o exemplo de código a seguir.</span><span class="sxs-lookup"><span data-stu-id="d6800-192">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="d6800-193">Certifique-se de que seu serviço é anotado com o atributo de comportamento suspeitos.</span><span class="sxs-lookup"><span data-stu-id="d6800-193">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="d6800-194">Além disso, se o `ReceiveErrorHandling` é definido como `Fault`, o `ServiceHost` Falha ao encontrar a mensagem suspeita.</span><span class="sxs-lookup"><span data-stu-id="d6800-194">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="d6800-195">Você pode interligar o evento com falha e desligar o serviço, tome medidas corretivas e reiniciar.</span><span class="sxs-lookup"><span data-stu-id="d6800-195">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="d6800-196">Por exemplo, o `LookupId` no <xref:System.ServiceModel.MsmqPoisonMessageException> propagadas para o `IErrorHandler` pode ser observado e quando as falhas de host de serviço, você pode usar o `System.Messaging` API para receber a mensagem de fila usando o `LookupId` para remover a mensagem da fila e armazenar a mensagem em algum armazenamento externo ou outra fila.</span><span class="sxs-lookup"><span data-stu-id="d6800-196">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="d6800-197">Você pode reiniciar `ServiceHost` para continuar o processamento normal.</span><span class="sxs-lookup"><span data-stu-id="d6800-197">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="d6800-198">O [manipulação de mensagens suspeitas no MSMQ 4.0](../../../../docs/framework/wcf/samples/poison-message-handling-in-msmq-4-0.md) demonstra esse comportamento.</span><span class="sxs-lookup"><span data-stu-id="d6800-198">The [Poison Message Handling in MSMQ 4.0](../../../../docs/framework/wcf/samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="d6800-199">Tempo limite da transação e mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="d6800-199">Transaction Time-Out and Poison Messages</span></span>  
 <span data-ttu-id="d6800-200">Uma classe de erros pode ocorrer entre o canal de transporte em fila e o código do usuário.</span><span class="sxs-lookup"><span data-stu-id="d6800-200">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="d6800-201">Esses erros podem ser detectados por camadas intermediária, como a camada de segurança de mensagem ou o serviço de lógica de expedição.</span><span class="sxs-lookup"><span data-stu-id="d6800-201">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="d6800-202">Por exemplo, um certificado x. 509 ausente detectado na camada de segurança de SOAP e uma ação ausente são casos em que a mensagem expedida para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d6800-202">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="d6800-203">Quando isso acontece, o modelo de serviço descarta a mensagem.</span><span class="sxs-lookup"><span data-stu-id="d6800-203">When this happens, the service model drops the message.</span></span> <span data-ttu-id="d6800-204">Como a mensagem é lida em uma transação e um resultado para essa transação não pode ser fornecido, a transação eventualmente expira, anulações e a mensagem é colocada de volta na fila.</span><span class="sxs-lookup"><span data-stu-id="d6800-204">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="d6800-205">Em outras palavras, para uma determinada classe de erros, a transação não anular imediatamente, mas aguarda até que a transação de tempo limite. Você pode modificar o tempo limite da transação para um serviço usando <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span><span class="sxs-lookup"><span data-stu-id="d6800-205">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="d6800-206">Para alterar o tempo limite da transação em todo o computador, modifique o arquivo Machine. config e defina o tempo limite de transação adequado. É importante para observar que, dependendo do tempo limite definido na transação, a transação, eventualmente, anula e volta para a fila e sua contagem de anulação é incrementada.</span><span class="sxs-lookup"><span data-stu-id="d6800-206">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="d6800-207">Finalmente, a mensagem se torna suspeita e a disposição da direita é feita de acordo com as configurações de usuário.</span><span class="sxs-lookup"><span data-stu-id="d6800-207">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="d6800-208">Sessões e mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="d6800-208">Sessions and Poison Messages</span></span>  
 <span data-ttu-id="d6800-209">Uma sessão sofre a repetição do mesma e os procedimentos de manipulação de mensagens suspeitas como uma única mensagem.</span><span class="sxs-lookup"><span data-stu-id="d6800-209">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="d6800-210">As propriedades listadas anteriormente para mensagens suspeitas se aplicam a toda a sessão.</span><span class="sxs-lookup"><span data-stu-id="d6800-210">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="d6800-211">Isso significa que toda a sessão é repetida e vai para uma fila de mensagens suspeitas final ou fila de mensagens mortas do remetente, se a mensagem será rejeitada.</span><span class="sxs-lookup"><span data-stu-id="d6800-211">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="d6800-212">Mensagens suspeitas e envio em lote</span><span class="sxs-lookup"><span data-stu-id="d6800-212">Batching and Poison Messages</span></span>  
 <span data-ttu-id="d6800-213">Se uma mensagem se torna uma mensagem suspeita e é parte de um lote, em seguida, o lote inteiro será revertido e o canal retorna ao ler uma mensagem por vez.</span><span class="sxs-lookup"><span data-stu-id="d6800-213">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="d6800-214">Para obter mais informações sobre o envio em lote, consulte [mensagens de envio em lote em uma transação](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md)</span><span class="sxs-lookup"><span data-stu-id="d6800-214">For more information about batching, see [Batching Messages in a Transaction](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="d6800-215">Manipulação de mensagens em uma fila de mensagens suspeitas de mensagens suspeitas</span><span class="sxs-lookup"><span data-stu-id="d6800-215">Poison-message Handling for Messages in a Poison Queue</span></span>  
 <span data-ttu-id="d6800-216">Manipulação de mensagens suspeitas não termina quando uma mensagem é colocada na fila de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-216">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="d6800-217">Mensagens na fila de mensagens suspeitas ainda devem ser lidas e manipuladas.</span><span class="sxs-lookup"><span data-stu-id="d6800-217">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="d6800-218">Ao ler as mensagens da subfila de mensagens suspeita final, você pode usar um subconjunto das configurações de manipulação de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-218">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="d6800-219">As configurações aplicáveis são `ReceiveRetryCount` e `ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="d6800-219">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="d6800-220">Você pode definir `ReceiveErrorHandling` para soltar, rejeitar, ou de falha.</span><span class="sxs-lookup"><span data-stu-id="d6800-220">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="d6800-221">`MaxRetryCycles` é ignorado e uma exceção é lançada se `ReceiveErrorHandling` é definido como a movimentação.</span><span class="sxs-lookup"><span data-stu-id="d6800-221">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="d6800-222">Diferenças do Windows XP, Windows Server 2003 e Windows Vista</span><span class="sxs-lookup"><span data-stu-id="d6800-222">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  
 <span data-ttu-id="d6800-223">Conforme observado anteriormente, nem todas as configurações de manipulação de mensagens suspeitas se aplicam a [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-223">As noted earlier, not all poison-message handling settings apply to [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span> <span data-ttu-id="d6800-224">A seguir as principais diferenças entre o enfileiramento de mensagens em [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], [!INCLUDE[wxp](../../../../includes/wxp-md.md)], e [!INCLUDE[wv](../../../../includes/wv-md.md)] são relevantes para a manipulação de mensagens suspeitas:</span><span class="sxs-lookup"><span data-stu-id="d6800-224">The following key differences between Message Queuing on [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)], [!INCLUDE[wxp](../../../../includes/wxp-md.md)], and [!INCLUDE[wv](../../../../includes/wv-md.md)] are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="d6800-225">Mensagem de enfileiramento de mensagens no [!INCLUDE[wv](../../../../includes/wv-md.md)] dá suporte a subfilas, enquanto [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)] não dão suporte a subfilas.</span><span class="sxs-lookup"><span data-stu-id="d6800-225">Message Queuing in [!INCLUDE[wv](../../../../includes/wv-md.md)] supports subqueues, while [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)] do not support subqueues.</span></span> <span data-ttu-id="d6800-226">Subfilas são usadas na manipulação de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-226">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="d6800-227">As filas de repetição e a fila de mensagens suspeitas são as subfilas para a fila do aplicativo é criado com base nas configurações de manipulação de mensagens suspeitas.</span><span class="sxs-lookup"><span data-stu-id="d6800-227">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="d6800-228">O `MaxRetryCycles` determina quantos repetir as subfilas para criar.</span><span class="sxs-lookup"><span data-stu-id="d6800-228">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="d6800-229">Portanto, quando em execução no [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] ou [!INCLUDE[wxp](../../../../includes/wxp-md.md)], `MaxRetryCycles` são ignorados e `ReceiveErrorHandling.Move` não é permitido.</span><span class="sxs-lookup"><span data-stu-id="d6800-229">Therefore, when running on [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] or [!INCLUDE[wxp](../../../../includes/wxp-md.md)], `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="d6800-230">Mensagem de enfileiramento de mensagens no [!INCLUDE[wv](../../../../includes/wv-md.md)] dá suporte a negativo confirmação, enquanto [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)] não fizer isso.</span><span class="sxs-lookup"><span data-stu-id="d6800-230">Message Queuing in [!INCLUDE[wv](../../../../includes/wv-md.md)] supports negative acknowledgment, while [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)] do not.</span></span> <span data-ttu-id="d6800-231">Uma confirmação negativa de Gerenciador de fila de recebimento faz com que o Gerenciador de fila de envio colocar a mensagem rejeitada na fila de inatividade.</span><span class="sxs-lookup"><span data-stu-id="d6800-231">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="d6800-232">Como tal, `ReceiveErrorHandling.Reject` não é permitido com [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-232">As such, `ReceiveErrorHandling.Reject` is not allowed with [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
- <span data-ttu-id="d6800-233">Mensagem de enfileiramento de mensagens em [!INCLUDE[wv](../../../../includes/wv-md.md)] dá suporte a uma propriedade de mensagem que mantém uma contagem do número de tempos de entrega de mensagens é tentada.</span><span class="sxs-lookup"><span data-stu-id="d6800-233">Message Queuing in [!INCLUDE[wv](../../../../includes/wv-md.md)] supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="d6800-234">Essa propriedade de contagem de anulação não está disponível no [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6800-234">This abort count property is not available on [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span> <span data-ttu-id="d6800-235">WCF mantém a contagem de anulação na memória, portanto, é possível que essa propriedade não pode conter um valor preciso quando a mesma mensagem é lida por mais de um serviço WCF em um farm.</span><span class="sxs-lookup"><span data-stu-id="d6800-235">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d6800-236">Consulte também</span><span class="sxs-lookup"><span data-stu-id="d6800-236">See also</span></span>

- [<span data-ttu-id="d6800-237">Visão geral de filas</span><span class="sxs-lookup"><span data-stu-id="d6800-237">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)
- [<span data-ttu-id="d6800-238">Diferenças de recursos da Fila no Windows Vista, Windows Server 2003 e Windows XP</span><span class="sxs-lookup"><span data-stu-id="d6800-238">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="d6800-239">Especificando e lidando com falhas em contratos e serviços</span><span class="sxs-lookup"><span data-stu-id="d6800-239">Specifying and Handling Faults in Contracts and Services</span></span>](../../../../docs/framework/wcf/specifying-and-handling-faults-in-contracts-and-services.md)
