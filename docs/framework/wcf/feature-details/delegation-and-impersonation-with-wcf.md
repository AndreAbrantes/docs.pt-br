---
title: Delegação e representação com o WCF
ms.custom: ''
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: ''
ms.suite: ''
ms.technology:
- dotnet-clr
ms.tgt_pltfrm: ''
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
caps.latest.revision: 40
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload:
- dotnet
ms.openlocfilehash: 8fc08c442813991b425b2bed3a0047fc5efa0d83
ms.sourcegitcommit: 94d33cadc5ff81d2ac389bf5f26422c227832052
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/30/2018
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="67b7a-102">Delegação e representação com o WCF</span><span class="sxs-lookup"><span data-stu-id="67b7a-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="67b7a-103">*Representação* é uma técnica comum que os serviços usam para restringir o acesso de cliente aos recursos de um domínio serviço.</span><span class="sxs-lookup"><span data-stu-id="67b7a-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="67b7a-104">Recursos de domínio de serviço podem ser recursos do computador, como arquivos locais (representação), ou um recurso em outro computador, como um compartilhamento de arquivo (delegação).</span><span class="sxs-lookup"><span data-stu-id="67b7a-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="67b7a-105">Para um aplicativo de exemplo, consulte [representar o cliente](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="67b7a-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="67b7a-106">Para obter um exemplo de como usar a representação, consulte [como: representar um cliente em um serviço](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="67b7a-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="67b7a-107">Lembre-se de que, ao representar um cliente em um serviço, o serviço é executado com as credenciais do cliente, que podem ter mais privilégios que o processo do servidor.</span><span class="sxs-lookup"><span data-stu-id="67b7a-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="67b7a-108">Visão geral</span><span class="sxs-lookup"><span data-stu-id="67b7a-108">Overview</span></span>  
 <span data-ttu-id="67b7a-109">Normalmente, os clientes chamar um serviço para que o serviço executar alguma ação no nome do cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="67b7a-110">A representação permite que o serviço atuar como o cliente ao executar a ação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="67b7a-111">A delegação permite que um serviço front-end encaminhar a solicitação do cliente para um serviço de back-end de forma que o serviço de back-end também pode representar o cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="67b7a-112">Geralmente, a representação é usada como uma maneira de verificar se um cliente está autorizado a executar uma ação específica, enquanto a delegação é uma maneira de fluxo de recursos de representação, junto com a identidade do cliente, para um serviço back-end.</span><span class="sxs-lookup"><span data-stu-id="67b7a-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="67b7a-113">A delegação é um recurso do domínio Windows que pode ser usado quando a autenticação Kerberos é executada.</span><span class="sxs-lookup"><span data-stu-id="67b7a-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="67b7a-114">A delegação é diferente do fluxo de identidade e, como a delegação transfere a capacidade de representar o cliente sem posse da senha do cliente, é uma quantidade maior operação privilegiada de fluxo de identidade.</span><span class="sxs-lookup"><span data-stu-id="67b7a-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="67b7a-115">Representação e delegação exigem que o cliente tenha uma identidade do Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="67b7a-116">Se um cliente não possui uma identidade do Windows, a única opção disponível é a identidade do cliente para o segundo serviço de fluxo.</span><span class="sxs-lookup"><span data-stu-id="67b7a-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="67b7a-117">Noções básicas de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-117">Impersonation Basics</span></span>  
 [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]<span data-ttu-id="67b7a-118"> dá suporte à representação para uma variedade de credenciais de cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-118"> supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="67b7a-119">Este tópico descreve o suporte de modelo de serviço para representar o chamador durante a implementação de um método de serviço.</span><span class="sxs-lookup"><span data-stu-id="67b7a-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="67b7a-120">Também são abordadas cenários comuns de implantação que envolve a representação e segurança de SOAP e [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] opções nesses cenários.</span><span class="sxs-lookup"><span data-stu-id="67b7a-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] options in these scenarios.</span></span>  
  
 <span data-ttu-id="67b7a-121">Este tópico enfoca a representação e delegação em [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] ao usar a segurança SOAP.</span><span class="sxs-lookup"><span data-stu-id="67b7a-121">This topic focuses on impersonation and delegation in [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] when using SOAP security.</span></span> <span data-ttu-id="67b7a-122">Você também pode usar a representação e delegação com [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] ao usar a segurança de transporte, conforme descrito em [usando representação com segurança de transporte](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="67b7a-122">You can also use impersonation and delegation with [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="67b7a-123">Dois métodos</span><span class="sxs-lookup"><span data-stu-id="67b7a-123">Two Methods</span></span>  
 [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-124"> Segurança SOAP tem dois métodos distintos para executar representação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-124"> SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="67b7a-125">O método usado depende da associação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-125">The method used depends on the binding.</span></span> <span data-ttu-id="67b7a-126">Uma é a representação de um token do Windows obtido com a autenticação Kerberos ou de Interface de provedor de suporte de segurança (SSPI), que é armazenado em cache, em seguida, no serviço.</span><span class="sxs-lookup"><span data-stu-id="67b7a-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="67b7a-127">A segunda é a representação de um token do Windows obtido extensões Kerberos, coletivamente chamadas *Service-for-User* (S4U).</span><span class="sxs-lookup"><span data-stu-id="67b7a-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="67b7a-128">Representação de Token em cache</span><span class="sxs-lookup"><span data-stu-id="67b7a-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="67b7a-129">Você pode executar a representação de token armazenado em cache com o seguinte:</span><span class="sxs-lookup"><span data-stu-id="67b7a-129">You can perform cached-token impersonation with the following:</span></span>  
  
-   <span data-ttu-id="67b7a-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, e <xref:System.ServiceModel.NetTcpBinding> com uma credencial de cliente do Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
-   <span data-ttu-id="67b7a-131"><xref:System.ServiceModel.BasicHttpBinding> com um <xref:System.ServiceModel.BasicHttpSecurityMode> definido como o <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credencial ou qualquer outra associação padrão em que o cliente apresenta uma credencial de nome de usuário que o serviço pode ser mapeados para uma conta válida do Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="67b7a-132">Qualquer <xref:System.ServiceModel.Channels.CustomBinding> que usa uma credencial de cliente do Windows com o `requireCancellation` definido como `true`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="67b7a-133">(A propriedade está disponível nas seguintes classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, e <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) Se uma conversa segura é usada na associação, ela também deve ter o `requireCancellation` propriedade definida como `true`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
-   <span data-ttu-id="67b7a-134">Qualquer <xref:System.ServiceModel.Channels.CustomBinding> onde o cliente apresenta uma credencial de nome de usuário.</span><span class="sxs-lookup"><span data-stu-id="67b7a-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="67b7a-135">Se a conversa segura é usada na associação, ela também deve ter o `requireCancellation` propriedade definida como `true`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="67b7a-136">Representação S4U com base em</span><span class="sxs-lookup"><span data-stu-id="67b7a-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="67b7a-137">Você pode executar com base em S4U representação com o seguinte:</span><span class="sxs-lookup"><span data-stu-id="67b7a-137">You can perform S4U-based impersonation with the following:</span></span>  
  
-   <span data-ttu-id="67b7a-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, e <xref:System.ServiceModel.NetTcpBinding> com uma credencial de cliente de certificado que o serviço pode ser mapeados para uma conta válida do Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="67b7a-139">Qualquer <xref:System.ServiceModel.Channels.CustomBinding> que usa uma credencial de cliente do Windows com o `requireCancellation` propriedade definida como `false`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
-   <span data-ttu-id="67b7a-140">Qualquer <xref:System.ServiceModel.Channels.CustomBinding> que usa um nome de usuário ou a credencial de cliente do Windows e a conversa segura com o `requireCancellation` propriedade definida como `false`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="67b7a-141">A extensão à qual o serviço pode representar o cliente depende dos privilégios que a conta de serviço mantém quando ele tenta representação, o tipo de representação usada e possivelmente a extensão de representação que permite que o cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-142">Quando o cliente e o serviço estiverem em execução no mesmo computador e o cliente é executado sob uma conta de sistema (por exemplo, `Local System` ou `Network Service`), o cliente não pode ser representado quando uma sessão segura é estabelecida com o contexto de segurança com monitoração de estado tokens.</span><span class="sxs-lookup"><span data-stu-id="67b7a-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="67b7a-143">Um aplicativo Windows Form ou console normalmente é executado sob a conta conectado no momento, para que a conta pode ser representada por padrão.</span><span class="sxs-lookup"><span data-stu-id="67b7a-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="67b7a-144">No entanto, quando o cliente é um [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] página e que é hospedado no [!INCLUDE[iis601](../../../../includes/iis601-md.md)] ou [!INCLUDE[iisver](../../../../includes/iisver-md.md)], em seguida, execute o cliente no `Network Service` por padrão.</span><span class="sxs-lookup"><span data-stu-id="67b7a-144">However, when the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page and that page is hosted in [!INCLUDE[iis601](../../../../includes/iis601-md.md)] or [!INCLUDE[iisver](../../../../includes/iisver-md.md)], then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="67b7a-145">Todas as associações fornecidas pelo sistema que oferecem suporte a sessões seguras usam um token de contexto de segurança sem monitoração de estado (SCT) por padrão.</span><span class="sxs-lookup"><span data-stu-id="67b7a-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="67b7a-146">No entanto, se o cliente é um [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] página e sessões seguras com monitoração de estado SCTs forem usados, o cliente não pode ser representado.</span><span class="sxs-lookup"><span data-stu-id="67b7a-146">However, if the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="67b7a-147">Para obter mais informações sobre como usar SCTs com monitoração de estado em uma sessão segura, consulte [como: criar um Token de contexto de segurança para uma sessão segura](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span><span class="sxs-lookup"><span data-stu-id="67b7a-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="67b7a-148">Representação em um método de serviço: modelo declarativo</span><span class="sxs-lookup"><span data-stu-id="67b7a-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="67b7a-149">A maioria dos cenários de representação envolvem a execução do método de serviço no contexto do chamador.</span><span class="sxs-lookup"><span data-stu-id="67b7a-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-150"> Fornece um recurso de representação que torna isso fácil de fazer, permitindo que o usuário especifique o requisito de representação no <xref:System.ServiceModel.OperationBehaviorAttribute> atributo.</span><span class="sxs-lookup"><span data-stu-id="67b7a-150"> provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="67b7a-151">Por exemplo, no código a seguir, o [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] infraestrutura representará o chamador antes de executar o `Hello` método.</span><span class="sxs-lookup"><span data-stu-id="67b7a-151">For example, in the following code, the [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="67b7a-152">Qualquer tentativa de acessar recursos nativos dentro de `Hello` método só terá êxito se a lista de controle de acesso (ACL) do recurso permite que o chamador de privilégios de acesso.</span><span class="sxs-lookup"><span data-stu-id="67b7a-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="67b7a-153">Para habilitar a representação, defina o <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> propriedade para um do <xref:System.ServiceModel.ImpersonationOption> valores de enumeração, ou <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> ou <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="67b7a-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-154">Quando um serviço possui credenciais mais alto que o cliente remoto, as credenciais do serviço são usadas se o <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> está definida como <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="67b7a-155">Ou seja, se um usuário de baixo privilégio fornecer suas credenciais, um serviço de privilégios mais altos executa o método com as credenciais do serviço e pode usar recursos que o usuário de baixo privilégio caso contrário, não seria capaz de usar.</span><span class="sxs-lookup"><span data-stu-id="67b7a-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="67b7a-156">O [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] infraestrutura pode representar o chamador somente se o chamador é autenticado com as credenciais que podem ser mapeadas para uma conta de usuário do Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-156">The [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="67b7a-157">Se o serviço está configurado para se autenticar usando uma credencial que não pode ser mapeada para uma conta do Windows, o método de serviço não será executado.</span><span class="sxs-lookup"><span data-stu-id="67b7a-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-158">Em [!INCLUDE[wxp](../../../../includes/wxp-md.md)], representação falhará se um stateful SCT é criado, resultando em um <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="67b7a-159">Para obter mais informações, consulte [cenários sem suporte](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="67b7a-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="67b7a-160">Representação em um método de serviço: modelo obrigatório</span><span class="sxs-lookup"><span data-stu-id="67b7a-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="67b7a-161">Às vezes, um chamador não precisa representar o método de todo o serviço de função, mas para apenas uma parte dele.</span><span class="sxs-lookup"><span data-stu-id="67b7a-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="67b7a-162">Nesse caso, obtenha a identidade do Windows do chamador dentro do método de serviço e executar imperativa a representação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="67b7a-163">Fazer isso usando o <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> propriedade o <xref:System.ServiceModel.ServiceSecurityContext> para retornar uma instância do <xref:System.Security.Principal.WindowsIdentity> classe e chamar o <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> método antes de usar a instância.</span><span class="sxs-lookup"><span data-stu-id="67b7a-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-164">Certifique-se de usar o Visual Basic`Using` instrução ou c# `using` instrução automaticamente reverter a ação de representação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="67b7a-165">Se você não usar a instrução, ou se você usar uma linguagem de programação que não seja do Visual Basic ou c#, certifique-se de reverter o nível de representação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="67b7a-166">Falha ao fazer isso pode formar a base para a negação de serviço e elevação de ataques de privilégio.</span><span class="sxs-lookup"><span data-stu-id="67b7a-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="67b7a-167">Representação de todos os métodos de serviço</span><span class="sxs-lookup"><span data-stu-id="67b7a-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="67b7a-168">Em alguns casos, você deve executar todos os métodos de um serviço no contexto do chamador.</span><span class="sxs-lookup"><span data-stu-id="67b7a-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="67b7a-169">Em vez de explicitamente habilitar esse recurso em uma base por método, use o <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="67b7a-170">Conforme mostrado no código a seguir, defina o <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> propriedade `true`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="67b7a-171">O <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> são recuperados das coleções de comportamentos do <xref:System.ServiceModel.ServiceHost> classe.</span><span class="sxs-lookup"><span data-stu-id="67b7a-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="67b7a-172">Observe também que o `Impersonation` propriedade o <xref:System.ServiceModel.OperationBehaviorAttribute> aplicado para cada método também deve ser definido como <xref:System.ServiceModel.ImpersonationOption.Allowed> ou <xref:System.ServiceModel.ImpersonationOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="67b7a-173">A tabela a seguir descreve [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] comportamento para todas as combinações possíveis de `ImpersonationOption` e `ImpersonateCallerForAllServiceOperations`.</span><span class="sxs-lookup"><span data-stu-id="67b7a-173">The following table describes [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="67b7a-174">Comportamento</span><span class="sxs-lookup"><span data-stu-id="67b7a-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="67b7a-175">Necessária</span><span class="sxs-lookup"><span data-stu-id="67b7a-175">Required</span></span>|<span data-ttu-id="67b7a-176">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-176">n/a</span></span>|[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-177"> representa o chamador</span><span class="sxs-lookup"><span data-stu-id="67b7a-177"> impersonates the caller</span></span>|  
|<span data-ttu-id="67b7a-178">Permitido</span><span class="sxs-lookup"><span data-stu-id="67b7a-178">Allowed</span></span>|<span data-ttu-id="67b7a-179">false</span><span class="sxs-lookup"><span data-stu-id="67b7a-179">false</span></span>|[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-180"> não representar o chamador</span><span class="sxs-lookup"><span data-stu-id="67b7a-180"> does not impersonate the caller</span></span>|  
|<span data-ttu-id="67b7a-181">Permitido</span><span class="sxs-lookup"><span data-stu-id="67b7a-181">Allowed</span></span>|<span data-ttu-id="67b7a-182">true</span><span class="sxs-lookup"><span data-stu-id="67b7a-182">true</span></span>|[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-183"> representa o chamador</span><span class="sxs-lookup"><span data-stu-id="67b7a-183"> impersonates the caller</span></span>|  
|<span data-ttu-id="67b7a-184">Não permitido</span><span class="sxs-lookup"><span data-stu-id="67b7a-184">NotAllowed</span></span>|<span data-ttu-id="67b7a-185">false</span><span class="sxs-lookup"><span data-stu-id="67b7a-185">false</span></span>|[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="67b7a-186"> não representar o chamador</span><span class="sxs-lookup"><span data-stu-id="67b7a-186"> does not impersonate the caller</span></span>|  
|<span data-ttu-id="67b7a-187">Não permitido</span><span class="sxs-lookup"><span data-stu-id="67b7a-187">NotAllowed</span></span>|<span data-ttu-id="67b7a-188">true</span><span class="sxs-lookup"><span data-stu-id="67b7a-188">true</span></span>|<span data-ttu-id="67b7a-189">Não permitido.</span><span class="sxs-lookup"><span data-stu-id="67b7a-189">Disallowed.</span></span> <span data-ttu-id="67b7a-190">(Um <xref:System.InvalidOperationException> é gerada.)</span><span class="sxs-lookup"><span data-stu-id="67b7a-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="67b7a-191">Nível de representação obtidas as credenciais do Windows e armazenado em cache o Token de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="67b7a-192">Em alguns cenários, o cliente tem parcial controle sobre o nível de representação que o serviço executa quando uma credencial de cliente do Windows é usada.</span><span class="sxs-lookup"><span data-stu-id="67b7a-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="67b7a-193">Um cenário ocorre quando o cliente especifica um nível de representação anônima.</span><span class="sxs-lookup"><span data-stu-id="67b7a-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="67b7a-194">O outro ocorre ao executar a representação com um token de cache.</span><span class="sxs-lookup"><span data-stu-id="67b7a-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="67b7a-195">Isso é feito definindo o <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> propriedade o <xref:System.ServiceModel.Security.WindowsClientCredential> classe, que pode é acessada como uma propriedade de genérica <xref:System.ServiceModel.ChannelFactory%601> classe.</span><span class="sxs-lookup"><span data-stu-id="67b7a-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-196">Especificar um nível de representação de Anonymous faz com que o cliente fazer logon serviço anonimamente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="67b7a-197">O serviço, portanto, deve permitir logons anônimos, independentemente se a representação é executada.</span><span class="sxs-lookup"><span data-stu-id="67b7a-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="67b7a-198">O cliente pode especificar o nível de representação como <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, ou <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="67b7a-199">Apenas um token no nível especificado é produzido, conforme mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="67b7a-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="67b7a-200">A tabela a seguir especifica o nível de representação que o serviço obtém a representação de um token em cache.</span><span class="sxs-lookup"><span data-stu-id="67b7a-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="67b7a-201">Valor `AllowedImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="67b7a-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="67b7a-202">Serviço tem `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="67b7a-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="67b7a-203">Cliente e serviço são capazes de delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="67b7a-204">Token de cache `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="67b7a-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="67b7a-205">Anônimo</span><span class="sxs-lookup"><span data-stu-id="67b7a-205">Anonymous</span></span>|<span data-ttu-id="67b7a-206">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-206">Yes</span></span>|<span data-ttu-id="67b7a-207">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-207">n/a</span></span>|<span data-ttu-id="67b7a-208">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-208">Impersonation</span></span>|  
|<span data-ttu-id="67b7a-209">Anônimo</span><span class="sxs-lookup"><span data-stu-id="67b7a-209">Anonymous</span></span>|<span data-ttu-id="67b7a-210">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-210">No</span></span>|<span data-ttu-id="67b7a-211">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-211">n/a</span></span>|<span data-ttu-id="67b7a-212">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-212">Identification</span></span>|  
|<span data-ttu-id="67b7a-213">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-213">Identification</span></span>|<span data-ttu-id="67b7a-214">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-214">n/a</span></span>|<span data-ttu-id="67b7a-215">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-215">n/a</span></span>|<span data-ttu-id="67b7a-216">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-216">Identification</span></span>|  
|<span data-ttu-id="67b7a-217">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-217">Impersonation</span></span>|<span data-ttu-id="67b7a-218">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-218">Yes</span></span>|<span data-ttu-id="67b7a-219">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-219">n/a</span></span>|<span data-ttu-id="67b7a-220">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-220">Impersonation</span></span>|  
|<span data-ttu-id="67b7a-221">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-221">Impersonation</span></span>|<span data-ttu-id="67b7a-222">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-222">No</span></span>|<span data-ttu-id="67b7a-223">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-223">n/a</span></span>|<span data-ttu-id="67b7a-224">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-224">Identification</span></span>|  
|<span data-ttu-id="67b7a-225">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-225">Delegation</span></span>|<span data-ttu-id="67b7a-226">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-226">Yes</span></span>|<span data-ttu-id="67b7a-227">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-227">Yes</span></span>|<span data-ttu-id="67b7a-228">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-228">Delegation</span></span>|  
|<span data-ttu-id="67b7a-229">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-229">Delegation</span></span>|<span data-ttu-id="67b7a-230">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-230">Yes</span></span>|<span data-ttu-id="67b7a-231">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-231">No</span></span>|<span data-ttu-id="67b7a-232">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-232">Impersonation</span></span>|  
|<span data-ttu-id="67b7a-233">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-233">Delegation</span></span>|<span data-ttu-id="67b7a-234">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-234">No</span></span>|<span data-ttu-id="67b7a-235">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-235">n/a</span></span>|<span data-ttu-id="67b7a-236">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="67b7a-237">Nível de representação obtidos de credenciais de nome de usuário e armazenados em cache o Token de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="67b7a-238">Passando o serviço de seu nome de usuário e senha, permite que um cliente [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] para fazer logon como esse usuário, que é equivalente à configuração de `AllowedImpersonationLevel` propriedade <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="67b7a-238">By passing the service its user name and password, a client enables [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="67b7a-239">(O `AllowedImpersonationLevel` está disponível na <xref:System.ServiceModel.Security.WindowsClientCredential> e <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) A tabela a seguir fornece a representação de nível obtida quando o serviço recebe as credenciais de nome de usuário.</span><span class="sxs-lookup"><span data-stu-id="67b7a-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="67b7a-240">Serviço tem `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="67b7a-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="67b7a-241">Cliente e serviço são capazes de delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="67b7a-242">Token de cache `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="67b7a-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="67b7a-243">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-243">n/a</span></span>|<span data-ttu-id="67b7a-244">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-244">Yes</span></span>|<span data-ttu-id="67b7a-245">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-245">Yes</span></span>|<span data-ttu-id="67b7a-246">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-246">Delegation</span></span>|  
|<span data-ttu-id="67b7a-247">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-247">n/a</span></span>|<span data-ttu-id="67b7a-248">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-248">Yes</span></span>|<span data-ttu-id="67b7a-249">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-249">No</span></span>|<span data-ttu-id="67b7a-250">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-250">Impersonation</span></span>|  
|<span data-ttu-id="67b7a-251">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-251">n/a</span></span>|<span data-ttu-id="67b7a-252">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-252">No</span></span>|<span data-ttu-id="67b7a-253">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-253">n/a</span></span>|<span data-ttu-id="67b7a-254">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="67b7a-255">Obtido com base em S4U representação de nível de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="67b7a-256">Serviço tem `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="67b7a-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="67b7a-257">Serviço tem `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="67b7a-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="67b7a-258">Cliente e serviço são capazes de delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="67b7a-259">Token de cache `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="67b7a-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="67b7a-260">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-260">Yes</span></span>|<span data-ttu-id="67b7a-261">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-261">Yes</span></span>|<span data-ttu-id="67b7a-262">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-262">n/a</span></span>|<span data-ttu-id="67b7a-263">Representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-263">Impersonation</span></span>|  
|<span data-ttu-id="67b7a-264">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-264">Yes</span></span>|<span data-ttu-id="67b7a-265">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-265">No</span></span>|<span data-ttu-id="67b7a-266">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-266">n/a</span></span>|<span data-ttu-id="67b7a-267">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-267">Identification</span></span>|  
|<span data-ttu-id="67b7a-268">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-268">No</span></span>|<span data-ttu-id="67b7a-269">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-269">n/a</span></span>|<span data-ttu-id="67b7a-270">N/D</span><span class="sxs-lookup"><span data-stu-id="67b7a-270">n/a</span></span>|<span data-ttu-id="67b7a-271">Identificação</span><span class="sxs-lookup"><span data-stu-id="67b7a-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="67b7a-272">Mapeamento de um certificado de cliente para uma conta do Windows</span><span class="sxs-lookup"><span data-stu-id="67b7a-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="67b7a-273">É possível que um cliente para autenticar-se a um serviço usando um certificado e tem o mapa de serviço de cliente para uma conta existente por meio do Active Directory.</span><span class="sxs-lookup"><span data-stu-id="67b7a-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="67b7a-274">O XML a seguir mostra como configurar o serviço para mapear o certificado.</span><span class="sxs-lookup"><span data-stu-id="67b7a-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="67b7a-275">O código a seguir mostra como configurar o serviço.</span><span class="sxs-lookup"><span data-stu-id="67b7a-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="67b7a-276">Delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-276">Delegation</span></span>  
 <span data-ttu-id="67b7a-277">Para delegar a um serviço de back-end, um serviço deve executar o multi-trecho de Kerberos (SSPI sem o fallback de NTLM) ou Kerberos direto de autenticação para o serviço de back-end usando a identidade do cliente Windows.</span><span class="sxs-lookup"><span data-stu-id="67b7a-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="67b7a-278">Para delegar a um serviço de back-end, crie um <xref:System.ServiceModel.ChannelFactory%601> e um canal e se comunicar por meio do canal ao representar o cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="67b7a-279">Com essa forma de delegação, a distância em que o serviço de back-end pode ser localizado do serviço de front-end depende do nível de representação obtido com o serviço de front-end.</span><span class="sxs-lookup"><span data-stu-id="67b7a-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="67b7a-280">Quando o nível de representação é <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, os serviços de front-end e back-end devem ser executados no mesmo computador.</span><span class="sxs-lookup"><span data-stu-id="67b7a-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="67b7a-281">Quando o nível de representação é <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, os serviços de front-end e back-end podem ser em computadores separados ou no mesmo computador.</span><span class="sxs-lookup"><span data-stu-id="67b7a-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="67b7a-282">Habilitando a representação de nível de delegação exige a configuração de diretiva de domínio do Windows para permitir a delegação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="67b7a-283">Para obter mais informações sobre como configurar o Active Directory para suporte à delegação, consulte [habilitando a autenticação delegada](http://go.microsoft.com/fwlink/?LinkId=99690).</span><span class="sxs-lookup"><span data-stu-id="67b7a-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](http://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="67b7a-284">Quando um cliente é autenticado para o serviço de front-end usando um nome de usuário e senha que correspondem a uma conta do Windows no serviço de back-end, o serviço de front-end pode autenticar para o serviço de back-end com a reutilização de nome de usuário e a senha do cliente.</span><span class="sxs-lookup"><span data-stu-id="67b7a-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="67b7a-285">Esta é uma forma muito eficiente de fluxo de identidade, como passando o nome de usuário e senha para o serviço de back-end permite que o serviço de back-end executar representação, mas não constitui a delegação porque Kerberos não é usado.</span><span class="sxs-lookup"><span data-stu-id="67b7a-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="67b7a-286">Controles de Active Directory sobre a delegação não se aplicam à autenticação de nome e a senha do usuário.</span><span class="sxs-lookup"><span data-stu-id="67b7a-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="67b7a-287">Capacidade de delegação como uma função de nível de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="67b7a-288">Nível de representação</span><span class="sxs-lookup"><span data-stu-id="67b7a-288">Impersonation level</span></span>|<span data-ttu-id="67b7a-289">O serviço pode executar processo cruzado de delegação</span><span class="sxs-lookup"><span data-stu-id="67b7a-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="67b7a-290">O serviço pode executar delegação entre computadores</span><span class="sxs-lookup"><span data-stu-id="67b7a-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="67b7a-291">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-291">No</span></span>|<span data-ttu-id="67b7a-292">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="67b7a-293">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-293">Yes</span></span>|<span data-ttu-id="67b7a-294">Não</span><span class="sxs-lookup"><span data-stu-id="67b7a-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="67b7a-295">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-295">Yes</span></span>|<span data-ttu-id="67b7a-296">Sim</span><span class="sxs-lookup"><span data-stu-id="67b7a-296">Yes</span></span>|  
  
 <span data-ttu-id="67b7a-297">O exemplo de código a seguir demonstra como usar a delegação.</span><span class="sxs-lookup"><span data-stu-id="67b7a-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="67b7a-298">Como configurar um aplicativo para usar a delegação restrita</span><span class="sxs-lookup"><span data-stu-id="67b7a-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="67b7a-299">Antes de você poder usar restrita delegação, o remetente, destinatário e o controlador de domínio deve ser configurado para fazer isso.</span><span class="sxs-lookup"><span data-stu-id="67b7a-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="67b7a-300">O procedimento a seguir lista as etapas que permitem que a delegação restrita.</span><span class="sxs-lookup"><span data-stu-id="67b7a-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="67b7a-301">Para obter detalhes sobre as diferenças entre a delegação e a delegação restrita, consulte a parte de [extensões Kerberos do Windows Server 2003](http://go.microsoft.com/fwlink/?LinkId=100194) que discute discussão restrita.</span><span class="sxs-lookup"><span data-stu-id="67b7a-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](http://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1.  <span data-ttu-id="67b7a-302">No controlador de domínio, desmarque o **conta é confidencial e não pode ser delegada** caixa de seleção para a conta sob a qual o aplicativo cliente está em execução.</span><span class="sxs-lookup"><span data-stu-id="67b7a-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2.  <span data-ttu-id="67b7a-303">No controlador de domínio, selecione o **a conta é confiável para delegação** caixa de seleção para a conta sob a qual o aplicativo cliente está em execução.</span><span class="sxs-lookup"><span data-stu-id="67b7a-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3.  <span data-ttu-id="67b7a-304">No controlador de domínio, configure o computador de camada intermediária para que seja confiável para delegação, clicando o **confiar no computador para delegação** opção.</span><span class="sxs-lookup"><span data-stu-id="67b7a-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4.  <span data-ttu-id="67b7a-305">No controlador de domínio, configure o computador de camada intermediária para usar a delegação restrita, clicando o **confiar no computador para delegação apenas a serviços especificados** opção.</span><span class="sxs-lookup"><span data-stu-id="67b7a-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="67b7a-306">Para obter instruções mais detalhadas sobre como configurar a delegação restrita, consulte os tópicos a seguir no MSDN:</span><span class="sxs-lookup"><span data-stu-id="67b7a-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
-   [<span data-ttu-id="67b7a-307">Solucionando problemas de delegação de Kerberos</span><span class="sxs-lookup"><span data-stu-id="67b7a-307">Troubleshooting Kerberos Delegation</span></span>](http://go.microsoft.com/fwlink/?LinkId=36724)  
  
-   [<span data-ttu-id="67b7a-308">Transição de protocolo Kerberos e delegação restrita</span><span class="sxs-lookup"><span data-stu-id="67b7a-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](http://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="67b7a-309">Consulte também</span><span class="sxs-lookup"><span data-stu-id="67b7a-309">See Also</span></span>  
 <xref:System.ServiceModel.OperationBehaviorAttribute>  
 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>  
 <xref:System.ServiceModel.ImpersonationOption>  
 <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>  
 <xref:System.ServiceModel.ServiceSecurityContext>  
 <xref:System.Security.Principal.WindowsIdentity>  
 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>  
 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>  
 <xref:System.ServiceModel.ServiceHost>  
 <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>  
 <xref:System.ServiceModel.Security.WindowsClientCredential>  
 <xref:System.ServiceModel.ChannelFactory%601>  
 <xref:System.Security.Principal.TokenImpersonationLevel.Identification>  
 [<span data-ttu-id="67b7a-310">Usando a representação com segurança de transporte</span><span class="sxs-lookup"><span data-stu-id="67b7a-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)  
 [<span data-ttu-id="67b7a-311">Representar o cliente</span><span class="sxs-lookup"><span data-stu-id="67b7a-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)  
 [<span data-ttu-id="67b7a-312">Como representar um cliente em um serviço</span><span class="sxs-lookup"><span data-stu-id="67b7a-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)  
 [<span data-ttu-id="67b7a-313">Ferramenta de utilitário de metadados ServiceModel (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="67b7a-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
