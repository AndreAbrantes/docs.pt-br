---
title: Copiando e fixando
ms.date: 03/30/2017
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 90ed12862c4cadc45777150deb1b9f91f111bf41
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/28/2019
ms.locfileid: "64750512"
---
# <a name="copying-and-pinning"></a><span data-ttu-id="36199-102">Copiando e fixando</span><span class="sxs-lookup"><span data-stu-id="36199-102">Copying and Pinning</span></span>

<span data-ttu-id="36199-103">Ao realizar marshaling dos dados, o marshaler de interoperabilidade pode copiar ou fixar os dados com marshaling.</span><span class="sxs-lookup"><span data-stu-id="36199-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="36199-104">A cópia dos dados coloca uma cópia dos dados de um local de memória em outro local de memória.</span><span class="sxs-lookup"><span data-stu-id="36199-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="36199-105">A ilustração a seguir mostra as diferenças entre a cópia de um tipo de valor e a cópia de um tipo passado por referência da memória gerenciada para a não gerenciada.</span><span class="sxs-lookup"><span data-stu-id="36199-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>

![Diagrama que mostra como o valor e os tipos de referência são copiados.](./media/copying-and-pinning/interop-marshal-copy.gif)

<span data-ttu-id="36199-107">Os argumentos de método passados por valor têm o marshaling realizado para o código não gerenciado como valores na pilha.</span><span class="sxs-lookup"><span data-stu-id="36199-107">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="36199-108">O processo de cópia é direto.</span><span class="sxs-lookup"><span data-stu-id="36199-108">The copying process is direct.</span></span> <span data-ttu-id="36199-109">Os argumentos passados por referência são passados como ponteiros na pilha.</span><span class="sxs-lookup"><span data-stu-id="36199-109">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="36199-110">Tipos de referência também são passados por valor e por referência.</span><span class="sxs-lookup"><span data-stu-id="36199-110">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="36199-111">Como mostra a ilustração a seguir, os tipos de referência passados por valor são copiados ou fixados:</span><span class="sxs-lookup"><span data-stu-id="36199-111">As the following illustration shows, reference types passed by value are either copied or pinned:</span></span>

![Diagrama mostrando os tipos de referência passados por valor e por referência.](./media/copying-and-pinning/interop-marshal-reference-pin.gif)

<span data-ttu-id="36199-113">A anexação temporária bloqueia os dados em seu local atual de memória, impedindo, portanto, que eles sejam relocados pelo coletor de lixo do Common Language Runtime.</span><span class="sxs-lookup"><span data-stu-id="36199-113">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="36199-114">O marshaler fixa os dados para reduzir a sobrecarga da cópia e melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="36199-114">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="36199-115">O tipo dos dados determina se eles são copiados ou fixados durante o processo de marshaling.</span><span class="sxs-lookup"><span data-stu-id="36199-115">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="36199-116">A anexação é executada automaticamente durante o marshaling de objetos, como <xref:System.String>. No entanto, também é possível fixar a memória manualmente usando a classe <xref:System.Runtime.InteropServices.GCHandle>.</span><span class="sxs-lookup"><span data-stu-id="36199-116">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>

## <a name="formatted-blittable-classes"></a><span data-ttu-id="36199-117">Classes blittable formatadas</span><span class="sxs-lookup"><span data-stu-id="36199-117">Formatted Blittable Classes</span></span>

<span data-ttu-id="36199-118">As classes [blittable](blittable-and-non-blittable-types.md) formatadas têm o layout fixo (formatado) e uma representação de dados comum na memória gerenciada e não gerenciada.</span><span class="sxs-lookup"><span data-stu-id="36199-118">Formatted [blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="36199-119">Quando esses tipos exigem o marshaling, um ponteiro para o objeto no heap é passado diretamente para o receptor.</span><span class="sxs-lookup"><span data-stu-id="36199-119">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="36199-120">O receptor pode alterar o conteúdo do local de memória que está sendo referenciado pelo ponteiro.</span><span class="sxs-lookup"><span data-stu-id="36199-120">The callee can change the contents of the memory location being referenced by the pointer.</span></span>

> [!NOTE]
> <span data-ttu-id="36199-121">O receptor pode alterar o conteúdo da memória se o parâmetro estiver marcado como Saída ou Entrada/Saída. Por outro lado, o receptor deve evitar alterar o conteúdo quando o parâmetro é definido para ter o marshaling realizado como Entrada, que é o padrão para tipos blittable formatados.</span><span class="sxs-lookup"><span data-stu-id="36199-121">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="36199-122">A modificação de um objeto de Entrada gera problemas quando a mesma classe é exportada para uma biblioteca de tipos e usada para fazer chamadas entre apartments.</span><span class="sxs-lookup"><span data-stu-id="36199-122">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>

## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="36199-123">Classes não blittable formatadas</span><span class="sxs-lookup"><span data-stu-id="36199-123">Formatted Non-Blittable Classes</span></span>

<span data-ttu-id="36199-124">As classes [não blittable](blittable-and-non-blittable-types.md) formatadas têm o layout fixo (formatado), mas a representação de dados é diferente na memória gerenciada e não gerenciada.</span><span class="sxs-lookup"><span data-stu-id="36199-124">Formatted [non-blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="36199-125">Os dados podem exigir transformação nas seguintes condições:</span><span class="sxs-lookup"><span data-stu-id="36199-125">The data can require transformation under the following conditions:</span></span>

- <span data-ttu-id="36199-126">Se uma classe não blittable tem o marshaling realizado por valor, o receptor recebe um ponteiro para uma cópia da estrutura de dados.</span><span class="sxs-lookup"><span data-stu-id="36199-126">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="36199-127">Se uma classe não blittable tem o marshaling realizado por referência, o receptor recebe um ponteiro para um ponteiro para uma cópia da estrutura de dados.</span><span class="sxs-lookup"><span data-stu-id="36199-127">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="36199-128">Se o atributo <xref:System.Runtime.InteropServices.InAttribute> for definido, essa cópia será sempre inicializada com o estado da instância, com marshaling conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="36199-128">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>

- <span data-ttu-id="36199-129">Se o atributo <xref:System.Runtime.InteropServices.OutAttribute> for definido, o estado será sempre copiado novamente para a instância após o retorno, com marshaling conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="36199-129">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>

- <span data-ttu-id="36199-130">Se **InAttribute** e **OutAttribute** forem definidos, ambas as cópias serão necessárias.</span><span class="sxs-lookup"><span data-stu-id="36199-130">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="36199-131">Se um dos atributos for omitido, o marshaler poderá otimizar com a eliminação da cópia.</span><span class="sxs-lookup"><span data-stu-id="36199-131">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>

## <a name="reference-types"></a><span data-ttu-id="36199-132">Tipos de referência</span><span class="sxs-lookup"><span data-stu-id="36199-132">Reference Types</span></span>

<span data-ttu-id="36199-133">Tipos de referência podem ser passados por valor ou por referência.</span><span class="sxs-lookup"><span data-stu-id="36199-133">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="36199-134">Quando eles são passados por valor, um ponteiro para o tipo é passado na pilha.</span><span class="sxs-lookup"><span data-stu-id="36199-134">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="36199-135">Quando são passados por referência, um ponteiro para um ponteiro para o tipo é passado na pilha.</span><span class="sxs-lookup"><span data-stu-id="36199-135">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>

<span data-ttu-id="36199-136">Os tipos de referência têm o seguinte comportamento condicional:</span><span class="sxs-lookup"><span data-stu-id="36199-136">Reference types have the following conditional behavior:</span></span>

- <span data-ttu-id="36199-137">Se um tipo de referência é passado por valor e tem membros de tipos não blittable, os tipos são convertidos duas vezes:</span><span class="sxs-lookup"><span data-stu-id="36199-137">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>

  - <span data-ttu-id="36199-138">Quando um argumento é passado para o lado não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="36199-138">When an argument is passed to the unmanaged side.</span></span>

  - <span data-ttu-id="36199-139">Após o retorno da chamada.</span><span class="sxs-lookup"><span data-stu-id="36199-139">On return from the call.</span></span>

  <span data-ttu-id="36199-140">Para evitar a cópia e a conversão desnecessárias, esses tipos têm o marshaling realizado em parâmetros de Entrada.</span><span class="sxs-lookup"><span data-stu-id="36199-140">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="36199-141">Aplique os atributos **InAttribute** e **OutAttribute** explicitamente a um argumento para que o chamador veja as alterações feitas pelo receptor.</span><span class="sxs-lookup"><span data-stu-id="36199-141">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>

- <span data-ttu-id="36199-142">Se um tipo de referência é passado por valor e tem somente membros de tipos blittable, ele pode ser fixado durante o marshaling e todas as alterações feitas nos membros do tipo pelo receptor são vistas pelo chamador.</span><span class="sxs-lookup"><span data-stu-id="36199-142">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="36199-143">Aplique **InAttribute** e **OutAttribute** explicitamente se desejar obter esse comportamento.</span><span class="sxs-lookup"><span data-stu-id="36199-143">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="36199-144">Sem esses atributos direcionais, o marshaler de interoperabilidade não exporta as informações direcionais para a biblioteca de tipos (ele exporta-as como Entrada, que é o padrão) e isso poderá causar problemas com o marshaling entre apartments do COM.</span><span class="sxs-lookup"><span data-stu-id="36199-144">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>

- <span data-ttu-id="36199-145">Se um tipo de referência for passado por referência, ele terá o marshaling realizado como Entrada/Saída por padrão.</span><span class="sxs-lookup"><span data-stu-id="36199-145">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>

## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="36199-146">System.String e System.Text.StringBuilder</span><span class="sxs-lookup"><span data-stu-id="36199-146">System.String and System.Text.StringBuilder</span></span>

<span data-ttu-id="36199-147">Quando os dados têm o marshaling realizado para um código não gerenciado por valor ou por referência, o marshaler normalmente copia os dados para um buffer secundário (possivelmente, convertendo conjuntos de caracteres durante a cópia) e passa uma referência para o buffer para o receptor.</span><span class="sxs-lookup"><span data-stu-id="36199-147">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="36199-148">A menos que a referência seja um **BSTR** alocado com **SysAllocString**, a referência é sempre alocada com **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="36199-148">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>

<span data-ttu-id="36199-149">Como uma otimização quando um tipo de cadeia de caracteres tem o marshaling realizado por valor (como uma cadeia de caracteres Unicode), o marshaler passa ao receptor um ponteiro direto para cadeias de caracteres gerenciadas no buffer interno do Unicode, em vez de copiá-lo para um novo buffer.</span><span class="sxs-lookup"><span data-stu-id="36199-149">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>

> [!CAUTION]
> <span data-ttu-id="36199-150">Quando uma cadeia de caracteres é passada por valor, o receptor nunca deve alterar a referência passada pelo marshaler.</span><span class="sxs-lookup"><span data-stu-id="36199-150">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="36199-151">Isso pode corromper o heap gerenciado.</span><span class="sxs-lookup"><span data-stu-id="36199-151">Doing so can corrupt the managed heap.</span></span>

<span data-ttu-id="36199-152">Quando um <xref:System.String?displayProperty=nameWithType> é passado por referência, o marshaler copia o conteúdo da cadeia de caracteres para um buffer secundário antes de fazer a chamada.</span><span class="sxs-lookup"><span data-stu-id="36199-152">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="36199-153">Em seguida, ele copia o conteúdo do buffer para uma nova cadeia de caracteres após o retorno da chamada.</span><span class="sxs-lookup"><span data-stu-id="36199-153">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="36199-154">Essa técnica garante que a cadeia de caracteres gerenciada imutável permaneça inalterada.</span><span class="sxs-lookup"><span data-stu-id="36199-154">This technique ensures that the immutable managed string remains unaltered.</span></span>

<span data-ttu-id="36199-155">Quando um <xref:System.Text.StringBuilder?displayProperty=nameWithType> é passado por valor, o marshaler passa uma referência ao buffer interno do **StringBuilder** diretamente para o chamador.</span><span class="sxs-lookup"><span data-stu-id="36199-155">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="36199-156">O chamador e o receptor devem concordar com o tamanho do buffer.</span><span class="sxs-lookup"><span data-stu-id="36199-156">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="36199-157">O chamador é responsável pela criação de um **StringBuilder** de tamanho adequado.</span><span class="sxs-lookup"><span data-stu-id="36199-157">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="36199-158">O receptor deve tomar as precauções necessárias para garantir que o buffer não tenha estouro.</span><span class="sxs-lookup"><span data-stu-id="36199-158">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="36199-159">**StringBuilder** é uma exceção à regra em que os tipos de referência passados por valor são passados como parâmetros de Entrada por padrão.</span><span class="sxs-lookup"><span data-stu-id="36199-159">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="36199-160">Ele é sempre passado como Entrada/Saída.</span><span class="sxs-lookup"><span data-stu-id="36199-160">It is always passed as In/Out.</span></span>

## <a name="see-also"></a><span data-ttu-id="36199-161">Consulte também</span><span class="sxs-lookup"><span data-stu-id="36199-161">See also</span></span>

- [<span data-ttu-id="36199-162">Comportamento de marshaling padrão</span><span class="sxs-lookup"><span data-stu-id="36199-162">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)
- <span data-ttu-id="36199-163">[Atributos direcionais](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="36199-163">[Directional Attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span></span>
- [<span data-ttu-id="36199-164">Marshaling de interoperabilidade</span><span class="sxs-lookup"><span data-stu-id="36199-164">Interop Marshaling</span></span>](interop-marshaling.md)
