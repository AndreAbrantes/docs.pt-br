---
title: Gerenciamento de sessões do WIF
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
manager: mbaldwin
ms.openlocfilehash: 04c2f4bdfe2a6309fde0821db308ee2a83887323
ms.sourcegitcommit: efff8f331fd9467f093f8ab8d23a203d6ecb5b60
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/01/2018
ms.locfileid: "43456364"
---
# <a name="wif-session-management"></a><span data-ttu-id="beadf-102">Gerenciamento de sessões do WIF</span><span class="sxs-lookup"><span data-stu-id="beadf-102">WIF Session Management</span></span>
<span data-ttu-id="beadf-103">Quando um cliente tenta acessar um recurso protegido hospedado por uma terceira parte confiável pela primeira vez, o cliente deve primeiro se autenticar em um STS (serviço de token de segurança) que é de confiança da terceira parte confiável.</span><span class="sxs-lookup"><span data-stu-id="beadf-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="beadf-104">Em seguida, o STS emite um token de segurança para o cliente.</span><span class="sxs-lookup"><span data-stu-id="beadf-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="beadf-105">O cliente apresenta esse token para a terceira parte confiável, que, em seguida, concede o acesso do cliente ao recurso protegido.</span><span class="sxs-lookup"><span data-stu-id="beadf-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="beadf-106">No entanto, você não deseja que o cliente precise se autenticar novamente no STS a cada solicitação, especialmente, porque ele até mesmo pode não estar no mesmo computador ou no mesmo domínio da terceira parte confiável.</span><span class="sxs-lookup"><span data-stu-id="beadf-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="beadf-107">Em vez disso, o WIF (Windows Identity Foundation) faz com que o cliente e a terceira parte confiável estabeleçam uma sessão em que o cliente usa um token de segurança de sessão para se autenticar na terceira parte confiável para todas as solicitações após a primeira solicitação.</span><span class="sxs-lookup"><span data-stu-id="beadf-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="beadf-108">A terceira parte confiável pode usar esse token de segurança de sessão, que é armazenado em um cookie, para reconstruir o <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> do cliente.</span><span class="sxs-lookup"><span data-stu-id="beadf-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="beadf-109">O STS define qual autenticação o cliente deve fornecer.</span><span class="sxs-lookup"><span data-stu-id="beadf-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="beadf-110">No entanto, o cliente pode ter várias credenciais com as quais ele pode se autenticar no STS.</span><span class="sxs-lookup"><span data-stu-id="beadf-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="beadf-111">Por exemplo, ele pode ter um token do Windows Live, um nome de usuário e uma senha, um certificado e uma chave inteligente.</span><span class="sxs-lookup"><span data-stu-id="beadf-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="beadf-112">Nesse caso, o STS concede ao cliente várias identidades, com cada identidade correspondendo a uma das credenciais apresentadas pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="beadf-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="beadf-113">A terceira parte confiável pode usar uma ou mais dessas identidades quando decidir qual nível de acesso será concedido ao cliente.</span><span class="sxs-lookup"><span data-stu-id="beadf-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="beadf-114">A <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> é usada para reconstruir o <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> do cliente, que contém todas as identidades do cliente em <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span><span class="sxs-lookup"><span data-stu-id="beadf-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="beadf-115">Cada <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> na coleção contém os tokens de inicialização associados a essa identidade.</span><span class="sxs-lookup"><span data-stu-id="beadf-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="beadf-116">Se um novo token de sessão é emitido com a ID de sessão do token de sessão original, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> não atualiza o token de sessão no cache de token.</span><span class="sxs-lookup"><span data-stu-id="beadf-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="beadf-117">Você sempre deve instanciar um token de sessão com uma ID de sessão exclusiva.</span><span class="sxs-lookup"><span data-stu-id="beadf-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="beadf-118">Session.SecurityTokenHandler.ReadToken gera uma exceção <xref:System.Xml.XmlException> se ela recebe uma entrada inválida; por exemplo, se o cookie que contém o token de sessão está corrompido.</span><span class="sxs-lookup"><span data-stu-id="beadf-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="beadf-119">Recomendamos capturar essa exceção e fornecer um comportamento específico ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="beadf-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="beadf-120">Se uma página da Web protegida contiver muitos recursos (como gráficos pequenos) que também estão no domínio protegido, o cliente deverá se autenticar novamente na terceira parte confiável para baixar cada um desses recursos.</span><span class="sxs-lookup"><span data-stu-id="beadf-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="beadf-121">O uso de um token de autenticação de sessão evita a necessidade de se autenticar no STS a cada solicitação, mas ainda significa que muitos cookies estão sendo enviados.</span><span class="sxs-lookup"><span data-stu-id="beadf-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="beadf-122">Talvez você deseje configurar a página da Web para que os dados e os recursos importantes sejam armazenados no domínio protegido, enquanto itens secundários são armazenados em um domínio desprotegido e vinculados por meio da página da Web principal.</span><span class="sxs-lookup"><span data-stu-id="beadf-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="beadf-123">Além disso, defina o caminho do cookie para referenciar somente o domínio protegido.</span><span class="sxs-lookup"><span data-stu-id="beadf-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="beadf-124">Para operar no modo de referência, a Microsoft recomenda fornecer um manipulador para o evento <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> no arquivo **global.asax.cs** e configurar a propriedade **IsReferenceMode** no token passado na propriedade <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A>.</span><span class="sxs-lookup"><span data-stu-id="beadf-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="beadf-125">Essas atualizações garantirão que o token de sessão opere em modo de referência para cada solicitação e são preferíveis em comparação a simplesmente configurar a propriedade <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> no Módulo de Autenticação de Sessão.</span><span class="sxs-lookup"><span data-stu-id="beadf-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="beadf-126">Extensibilidade</span><span class="sxs-lookup"><span data-stu-id="beadf-126">Extensibility</span></span>  
 <span data-ttu-id="beadf-127">É possível estender o mecanismo de gerenciamento de sessão.</span><span class="sxs-lookup"><span data-stu-id="beadf-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="beadf-128">Um motivo para isso seria melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="beadf-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="beadf-129">Por exemplo, você pode criar um manipulador de cookie personalizado que transforma ou otimiza o token de segurança de sessão entre seu estado na memória e o que acontece no cookie.</span><span class="sxs-lookup"><span data-stu-id="beadf-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="beadf-130">Para fazer isso, configure a propriedade <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> da <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> para usar um manipulador de cookie personalizado que é derivado de <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="beadf-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="beadf-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> é o manipulador de cookie padrão, pois os cookies excedem o tamanho permitido para o protocolo HTTP; se, em vez disso, você usar um manipulador de cookie personalizado, deverá implementar o agrupamento.</span><span class="sxs-lookup"><span data-stu-id="beadf-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="beadf-132">Para obter mais informações, consulte [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) exemplo.</span><span class="sxs-lookup"><span data-stu-id="beadf-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="beadf-133">Essa amostra apresenta um cache de sessão pronto para o farm (em vez de um tokenreplycache), para que você possa usar sessões por referência, em vez de trocar cookies grandes. Essa amostra também apresenta uma maneira mais fácil de proteger cookies em um farm.</span><span class="sxs-lookup"><span data-stu-id="beadf-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="beadf-134">O cache de sessão é baseado no WCF.</span><span class="sxs-lookup"><span data-stu-id="beadf-134">The session cache is WCF-based.</span></span> <span data-ttu-id="beadf-135">Em relação à proteção da sessão, a amostra apresenta uma nova funcionalidade no WIF 4.5 de uma transformação de cookie baseada em MachineKey, que pode ser ativada simplesmente colando o trecho apropriado no web.config. O exemplo em si não está em um farm, mas demonstra o que você precisa para tornar seu aplicativo pronto para o farm.</span><span class="sxs-lookup"><span data-stu-id="beadf-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
