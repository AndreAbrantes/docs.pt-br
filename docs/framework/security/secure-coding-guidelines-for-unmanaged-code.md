---
title: Diretrizes de codificação segura para código não gerenciado
ms.date: 03/30/2017
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
author: mairaw
ms.author: mairaw
ms.openlocfilehash: 867157b329218b79c8cc1255b2158bbe83666531
ms.sourcegitcommit: 289e06e904b72f34ac717dbcc5074239b977e707
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/17/2019
ms.locfileid: "71045360"
---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a><span data-ttu-id="9bf44-102">Diretrizes de codificação segura para código não gerenciado</span><span class="sxs-lookup"><span data-stu-id="9bf44-102">Secure Coding Guidelines for Unmanaged Code</span></span>
<span data-ttu-id="9bf44-103">Um código de biblioteca precisa chamar o código não gerenciado (por exemplo, APIs de código nativo, assim como Win32).</span><span class="sxs-lookup"><span data-stu-id="9bf44-103">Some library code needs to call into unmanaged code (for example, native code APIs, such as Win32).</span></span> <span data-ttu-id="9bf44-104">Visto que isso significa que sair do perímetro de segurança para código gerenciado, o devido cuidado é necessário.</span><span class="sxs-lookup"><span data-stu-id="9bf44-104">Because this means going outside the security perimeter for managed code, due caution is required.</span></span> <span data-ttu-id="9bf44-105">Se seu código é neutro em termos de segurança, seu código e qualquer outro código que o chama devem ter permissão de código não gerenciado (<xref:System.Security.Permissions.SecurityPermission> com o sinalizador <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> especificado).</span><span class="sxs-lookup"><span data-stu-id="9bf44-105">If your code is security-neutral, both your code and any code that calls it must have unmanaged code permission (<xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> flag specified).</span></span>  
  
 <span data-ttu-id="9bf44-106">No entanto, geralmente não é razoável para o chamador ter permissões tão elevadas.</span><span class="sxs-lookup"><span data-stu-id="9bf44-106">However, it is often unreasonable for your caller to have such powerful permissions.</span></span> <span data-ttu-id="9bf44-107">Nesses casos, seu código confiável pode ser intermediário, semelhante ao wrapper gerenciado ou código da biblioteca descrito em [Protegendo código de Wrapper](../misc/securing-wrapper-code.md).</span><span class="sxs-lookup"><span data-stu-id="9bf44-107">In such cases, your trusted code can be the go-between, similar to the managed wrapper or library code described in [Securing Wrapper Code](../misc/securing-wrapper-code.md).</span></span> <span data-ttu-id="9bf44-108">Se a funcionalidade de código não gerenciado subjacente for totalmente segura, ele poderá ser exposto diretamente; caso contrário, uma verificação de permissão adequada (demanda) será necessária primeiro.</span><span class="sxs-lookup"><span data-stu-id="9bf44-108">If the underlying unmanaged code functionality is totally safe, it can be directly exposed; otherwise, a suitable permission check (demand) is required first.</span></span>  
  
 <span data-ttu-id="9bf44-109">Quando seu código chama código não gerenciado, mas você não deseja exigir que os chamadores tenham permissão para acessar código não gerenciado, você deve declarar esse direito.</span><span class="sxs-lookup"><span data-stu-id="9bf44-109">When your code calls into unmanaged code but you do not want to require your callers to have permission to access unmanaged code, you must assert that right.</span></span> <span data-ttu-id="9bf44-110">Uma declaração bloqueia a movimentação da pilha em seu quadro.</span><span class="sxs-lookup"><span data-stu-id="9bf44-110">An assertion blocks the stack walk at your frame.</span></span> <span data-ttu-id="9bf44-111">Você deve ter cuidado para não criar uma falha de segurança nesse processo.</span><span class="sxs-lookup"><span data-stu-id="9bf44-111">You must be careful that you do not create a security hole in this process.</span></span> <span data-ttu-id="9bf44-112">Geralmente, isso significa que você deve exigir uma permissão adequada dos chamadores e usar código não gerenciado para executar apenas o que ela permite e nada mais.</span><span class="sxs-lookup"><span data-stu-id="9bf44-112">Usually, this means that you must demand a suitable permission of your callers and then use unmanaged code to perform only what that permission allows and no more.</span></span> <span data-ttu-id="9bf44-113">Em alguns casos (por exemplo, em uma função de obtenção de hora do dia), o código não gerenciado pode ser diretamente exposto a chamadores sem nenhuma verificação de segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-113">In some cases (for example, a get time-of-day function), unmanaged code can be directly exposed to callers without any security checks.</span></span> <span data-ttu-id="9bf44-114">Em qualquer caso, qualquer código que fizer uma declaração deverá assumir a responsabilidade pela segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-114">In any case, any code that asserts must take responsibility for security.</span></span>  
  
 <span data-ttu-id="9bf44-115">Já que qualquer código gerenciado que fornece um caminho de código para código nativo é um destino potencial para código mal-intencionado, determinar qual código não gerenciado pode ser usado com segurança e como ele deve ser usado requer muito cuidado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-115">Because any managed code that provides a code path into native code is a potential target for malicious code, determining which unmanaged code can be safely used and how it must be used requires extreme care.</span></span> <span data-ttu-id="9bf44-116">Em geral, o código não gerenciado nunca deve ser diretamente exposto a chamadores parcialmente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="9bf44-116">Generally, unmanaged code should never be directly exposed to partially trusted callers.</span></span> <span data-ttu-id="9bf44-117">Há duas considerações principais ao avaliar a segurança do uso de código não gerenciado em bibliotecas que podem ser chamadas por código parcialmente confiável:</span><span class="sxs-lookup"><span data-stu-id="9bf44-117">There are two primary considerations in evaluating the safety of unmanaged code use in libraries that are callable by partially trusted code:</span></span>  
  
- <span data-ttu-id="9bf44-118">**Funcionalidade**.</span><span class="sxs-lookup"><span data-stu-id="9bf44-118">**Functionality**.</span></span> <span data-ttu-id="9bf44-119">A API não gerenciada fornece funcionalidade que não permite a chamadores executar operações potencialmente perigosas?</span><span class="sxs-lookup"><span data-stu-id="9bf44-119">Does the unmanaged API provide functionality that does not allow callers to perform potentially dangerous operations?</span></span> <span data-ttu-id="9bf44-120">A segurança de acesso ao código usa as permissões para impor o acesso aos recursos, portanto, considere se a API usa uma interface do usuário, arquivos ou threading ou se ela expõe informações protegidas.</span><span class="sxs-lookup"><span data-stu-id="9bf44-120">Code access security uses permissions to enforce access to resources, so consider whether the API uses files, a user interface, or threading, or whether it exposes protected information.</span></span> <span data-ttu-id="9bf44-121">Em caso afirmativo, o código gerenciado que a encapsula deve exigir as permissões necessárias antes de permitir que ela seja inserida.</span><span class="sxs-lookup"><span data-stu-id="9bf44-121">If it does, the managed code wrapping it must demand the necessary permissions before allowing it to be entered.</span></span> <span data-ttu-id="9bf44-122">Além disso, embora não protegido por uma permissão, o acesso à memória deve ser restrito à segurança de tipo estrito.</span><span class="sxs-lookup"><span data-stu-id="9bf44-122">Additionally, while not protected by a permission, memory access must be confined to strict type safety.</span></span>  
  
- <span data-ttu-id="9bf44-123">**Verificação de parâmetros**.</span><span class="sxs-lookup"><span data-stu-id="9bf44-123">**Parameter checking**.</span></span> <span data-ttu-id="9bf44-124">Um ataque comum passa parâmetros inesperados para métodos da API de código não gerenciado expostos em uma tentativa de fazer com que eles operem fora das especificações.</span><span class="sxs-lookup"><span data-stu-id="9bf44-124">A common attack passes unexpected parameters to exposed unmanaged code API methods in an attempt to cause them to operate out of specification.</span></span> <span data-ttu-id="9bf44-125">Estouros de buffer usando um índice fora do intervalo ou valores de deslocamento são um exemplo comum desse tipo de ataque, assim como o são todos os parâmetros que podem explorar um bug no código subjacente.</span><span class="sxs-lookup"><span data-stu-id="9bf44-125">Buffer overruns using out-of-range index or offset values are one common example of this type of attack, as are any parameters that might exploit a bug in the underlying code.</span></span> <span data-ttu-id="9bf44-126">Portanto, mesmo que a API de código não gerenciado seja funcionalmente segura (após as demandas necessárias) para chamadores parcialmente confiáveis, o código gerenciado também deverá verificar a validade de parâmetros exaustivamente para garantir que nenhuma chamada indesejada seja possível por meio de um código mal-intencionado usando a camada de wrapper de código gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-126">Thus, even if the unmanaged code API is functionally safe (after necessary demands) for partially trusted callers, managed code must also check parameter validity exhaustively to ensure that no unintended calls are possible from malicious code using the managed code wrapper layer.</span></span>  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a><span data-ttu-id="9bf44-127">Usando SuppressUnmanagedCodeSecurityAttribute</span><span class="sxs-lookup"><span data-stu-id="9bf44-127">Using SuppressUnmanagedCodeSecurityAttribute</span></span>  
 <span data-ttu-id="9bf44-128">Há um aspecto do desempenho para declarar e, em seguida, chamar código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-128">There is a performance aspect to asserting and then calling unmanaged code.</span></span> <span data-ttu-id="9bf44-129">Para cada uma dessas chamadas, o sistema de segurança automaticamente exige permissão de código não gerenciado, resultando em uma movimentação da pilha a cada vez.</span><span class="sxs-lookup"><span data-stu-id="9bf44-129">For every such call, the security system automatically demands unmanaged code permission, resulting in a stack walk each time.</span></span> <span data-ttu-id="9bf44-130">Se você declara e imediatamente chama código não gerenciado, a movimentação da pilha pode ser insignificante: ele consiste em sua declaração e chamada de código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-130">If you assert and immediately call unmanaged code, the stack walk can be meaningless: it consists of your assert and your unmanaged code call.</span></span>  
  
 <span data-ttu-id="9bf44-131">Um atributo personalizado chamado <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> pode ser aplicado a pontos de entrada de código não gerenciado para desabilitar a verificação de segurança normal, que demanda <xref:System.Security.Permissions.SecurityPermission> com a permissão <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> especificada.</span><span class="sxs-lookup"><span data-stu-id="9bf44-131">A custom attribute called <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> can be applied to unmanaged code entry points to disable the normal security check that demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> permission specified.</span></span> <span data-ttu-id="9bf44-132">É preciso tomar sempre muito cuidado ao fazer isso, porque essa ação cria uma porta aberta em código não gerenciado sem verificações de segurança de tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="9bf44-132">Extreme caution must always be taken when doing this, because this action creates an open door into unmanaged code with no runtime security checks.</span></span> <span data-ttu-id="9bf44-133">Observe que mesmo com **SuppressUnmanagedCodeSecurityAttribute** aplicado, há uma verificação de segurança única que ocorre durante a compilação JIT (Just-In-Time) para garantir que o chamador imediato tenha permissão para chamar código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-133">It should be noted that even with **SuppressUnmanagedCodeSecurityAttribute** applied, there is a one-time security check that happens at just-in-time (JIT) compilation to ensure that the immediate caller has permission to call unmanaged code.</span></span>  
  
 <span data-ttu-id="9bf44-134">Se você usar o **SuppressUnmanagedCodeSecurityAttribute**, verifique os seguintes pontos:</span><span class="sxs-lookup"><span data-stu-id="9bf44-134">If you use the **SuppressUnmanagedCodeSecurityAttribute**, check the following points:</span></span>  
  
- <span data-ttu-id="9bf44-135">Verifique o ponto de entrada de código não gerenciado interno ou inacessível fora de seu código.</span><span class="sxs-lookup"><span data-stu-id="9bf44-135">Make the unmanaged code entry point internal or otherwise inaccessible outside your code.</span></span>  
  
- <span data-ttu-id="9bf44-136">Qualquer chamada para código não gerenciado é uma potencial falha de segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-136">Any call into unmanaged code is a potential security hole.</span></span> <span data-ttu-id="9bf44-137">Verifique se seu código não é um portal para que código malicioso chame indiretamente código não gerenciado e evite uma verificação de segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-137">Make sure your code is not a portal for malicious code to indirectly call into unmanaged code and avoid a security check.</span></span> <span data-ttu-id="9bf44-138">Solicitar permissões, se apropriado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-138">Demand permissions, if appropriate.</span></span>  
  
- <span data-ttu-id="9bf44-139">Use uma convenção de nomenclatura para identificar explicitamente quando você estiver criando um caminho perigoso em código não gerenciado, conforme descrito na seção abaixo.</span><span class="sxs-lookup"><span data-stu-id="9bf44-139">Use a naming convention to explicitly identify when you are creating a dangerous path into unmanaged code, as described in the section below..</span></span>  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a><span data-ttu-id="9bf44-140">Convenção de nomenclatura para métodos de código não gerenciado</span><span class="sxs-lookup"><span data-stu-id="9bf44-140">Naming convention for unmanaged code methods</span></span>  
 <span data-ttu-id="9bf44-141">Foi estabelecida uma convenção útil e altamente recomendada para nomear os métodos de código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-141">A useful and highly recommended convention has been established for naming unmanaged code methods.</span></span> <span data-ttu-id="9bf44-142">Todos os métodos de código não gerenciado são separados em três categorias: **seguro**, **nativo** e **não seguro**.</span><span class="sxs-lookup"><span data-stu-id="9bf44-142">All unmanaged code methods are separated into three categories: **safe**, **native**, and **unsafe**.</span></span> <span data-ttu-id="9bf44-143">Essas palavras-chave podem ser usadas como nomes de classe dentro dos quais os vários tipos de pontos de entrada de código não gerenciado são definidos.</span><span class="sxs-lookup"><span data-stu-id="9bf44-143">These keywords can be used as class names within which the various kinds of unmanaged code entry points are defined.</span></span> <span data-ttu-id="9bf44-144">No código-fonte, essas palavras-chave devem ser adicionadas ao nome de classe, como em `Safe.GetTimeOfDay`, `Native.Xyz` ou `Unsafe.DangerousAPI`, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="9bf44-144">In source code, these keywords should be added to the class name, as in `Safe.GetTimeOfDay`, `Native.Xyz`, or `Unsafe.DangerousAPI`, for example.</span></span> <span data-ttu-id="9bf44-145">Cada uma dessas palavras-chave fornece informações de segurança úteis para desenvolvedores que usam essa classe, conforme descrito na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="9bf44-145">Each of these keywords provides useful security information for developers using that class, as described in the following table.</span></span>  
  
|<span data-ttu-id="9bf44-146">Palavra-chave</span><span class="sxs-lookup"><span data-stu-id="9bf44-146">Keyword</span></span>|<span data-ttu-id="9bf44-147">Considerações sobre segurança</span><span class="sxs-lookup"><span data-stu-id="9bf44-147">Security considerations</span></span>|  
|-------------|-----------------------------|  
|<span data-ttu-id="9bf44-148">**seguro**</span><span class="sxs-lookup"><span data-stu-id="9bf44-148">**safe**</span></span>|<span data-ttu-id="9bf44-149">É totalmente inofensivo que qualquer código, até mesmo mal-intencionado, o chame.</span><span class="sxs-lookup"><span data-stu-id="9bf44-149">Completely harmless for any code, even malicious code, to call.</span></span> <span data-ttu-id="9bf44-150">Pode ser usado exatamente como outro código gerenciado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-150">Can be used just like other managed code.</span></span> <span data-ttu-id="9bf44-151">Por exemplo, uma função que obtém a hora do dia é normalmente segura.</span><span class="sxs-lookup"><span data-stu-id="9bf44-151">For example, a function that gets the time of day is typically safe.</span></span>|  
|<span data-ttu-id="9bf44-152">**nativo**</span><span class="sxs-lookup"><span data-stu-id="9bf44-152">**native**</span></span>|<span data-ttu-id="9bf44-153">Neutro em termos de segurança, ou seja, código não gerenciado que requer permissão de código não gerenciado para chamar.</span><span class="sxs-lookup"><span data-stu-id="9bf44-153">Security-neutral; that is, unmanaged code that requires unmanaged code permission to call.</span></span> <span data-ttu-id="9bf44-154">A segurança é verificada, o que impede um chamador não autorizado.</span><span class="sxs-lookup"><span data-stu-id="9bf44-154">Security is checked, which stops an unauthorized caller.</span></span>|  
|<span data-ttu-id="9bf44-155">**unsafe**</span><span class="sxs-lookup"><span data-stu-id="9bf44-155">**unsafe**</span></span>|<span data-ttu-id="9bf44-156">Ponto de entrada de código não gerenciado potencialmente perigoso com segurança suprimida.</span><span class="sxs-lookup"><span data-stu-id="9bf44-156">Potentially dangerous unmanaged code entry point with security suppressed.</span></span> <span data-ttu-id="9bf44-157">Os desenvolvedores devem ter o máximo de cuidado ao usar código não gerenciado desse tipo, verificando se outras proteções estão em vigor para evitar uma vulnerabilidade de segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-157">Developers should use the greatest caution when using such unmanaged code, making sure that other protections are in place to prevent a security vulnerability.</span></span> <span data-ttu-id="9bf44-158">Os desenvolvedores devem ser responsáveis, pois essa palavra-chave substitui o sistema de segurança.</span><span class="sxs-lookup"><span data-stu-id="9bf44-158">Developers must be responsible, as this keyword overrides the security system.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="9bf44-159">Consulte também</span><span class="sxs-lookup"><span data-stu-id="9bf44-159">See also</span></span>

- [<span data-ttu-id="9bf44-160">Diretrizes de codificação segura</span><span class="sxs-lookup"><span data-stu-id="9bf44-160">Secure Coding Guidelines</span></span>](../../standard/security/secure-coding-guidelines.md)
