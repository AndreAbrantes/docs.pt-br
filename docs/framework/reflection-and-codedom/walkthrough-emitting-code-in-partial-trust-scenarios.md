---
title: 'Passo a passo: Emitindo o código em cenários de confiança parcial'
description: Consulte como emitir código em cenários de confiança parcial. A emissão de reflexão usa as mesmas APIs, mas alguns recursos precisam de permissões especiais em código parcialmente confiável.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: 70adb3ce67b45459b18741948092a912f6173731
ms.sourcegitcommit: 3d84eac0818099c9949035feb96bbe0346358504
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/21/2020
ms.locfileid: "86865184"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="0e7c3-104">Passo a passo: Emitindo o código em cenários de confiança parcial</span><span class="sxs-lookup"><span data-stu-id="0e7c3-104">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="0e7c3-105">A emissão de reflexão usa a mesma API definida na confiança total ou parcial, porém alguns recursos exigem permissões especiais em código parcialmente confiável.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-105">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="0e7c3-106">Além disso, a emissão de reflexão tem um recurso, os métodos dinâmicos hospedados anonimamente, que é projetado para ser usado com confiança parcial e por assemblies transparentes de segurança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-106">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="0e7c3-107">Antes do .NET Framework 3.5, a emissão de código necessitava de <xref:System.Security.Permissions.ReflectionPermission> com o sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-107">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="0e7c3-108">Essa permissão é incluída por padrão nos conjuntos de permissões denominados `FullTrust` e `Intranet`, mas não no conjunto de permissões `Internet`.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-108">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="0e7c3-109">Portanto, uma biblioteca poderia ser usada da confiança parcial somente se tivesse o atributo <xref:System.Security.SecurityCriticalAttribute> e também executasse um método <xref:System.Security.PermissionSet.Assert%2A> para <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-109">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="0e7c3-110">Tais bibliotecas exigem uma análise atenta da segurança, pois erros de código poderiam resultar em falhas de segurança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-110">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="0e7c3-111">O .NET Framework 3.5 permite que o código seja emitido em cenários de confiança parcial sem a emissão de nenhuma demanda de segurança, pois a geração de código não é uma operação inerentemente privilegiada.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-111">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="0e7c3-112">Ou seja, o código gerado não tem mais permissões que o assembly que o emite.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-112">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="0e7c3-113">Isso permite que bibliotecas que emitem código sejam transparentes de segurança e elimina a necessidade de declarar <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, de modo que escrever uma biblioteca de segurança não exige uma análise minuciosa da segurança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-113">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="0e7c3-114">Este passo a passo ilustra as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="0e7c3-114">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="0e7c3-115">[Configurando uma área restrita simples para testar código parcialmente confiável](#Setting_up).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-115">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="0e7c3-116">Essa é uma maneira simples de experimentar o código em confiança parcial.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-116">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="0e7c3-117">Para executar código que realmente vem de locais não confiáveis, consulte [Como executar código parcialmente confiável em uma área restrita](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-117">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="0e7c3-118">[Executando código em domínios de aplicativo parcialmente confiável](#Running_code).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-118">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="0e7c3-119">[Usando métodos dinâmicos hospedados anonimamente para emitir e executar código em confiança parcial](#Using_methods).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-119">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="0e7c3-120">Para obter mais informações sobre como emitir código em cenários de confiança parcial, consulte [Problemas de segurança na emissão de reflexão](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-120">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="0e7c3-121">Para obter uma lista completa do código mostrado nesses procedimentos, consulte a [Seção de exemplos](#Example) no final deste passo a passo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-121">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="0e7c3-122">Configurar locais parcialmente confiáveis</span><span class="sxs-lookup"><span data-stu-id="0e7c3-122">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="0e7c3-123">Os dois procedimentos a seguir mostram como configurar locais de onde você pode testar o código com confiança parcial.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-123">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="0e7c3-124">O primeiro procedimento mostra como criar um domínio do aplicativo em área restrita no qual o código recebe permissões da Internet.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-124">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="0e7c3-125">O segundo procedimento mostra como adicionar <xref:System.Security.Permissions.ReflectionPermission> com o sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> para um domínio do aplicativo parcialmente confiável, a fim de habilitar o acesso aos dados particulares em assemblies de confiança iguais ou inferior.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-125">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="0e7c3-126">Criar domínios do aplicativo em área restrita</span><span class="sxs-lookup"><span data-stu-id="0e7c3-126">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="0e7c3-127">Para criar um domínio do aplicativo no qual seus assemblies são executados com confiança parcial, você deve especificar o conjunto de permissões a serem concedidas aos assemblies usando a sobrecarga de método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> para criar o domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-127">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="0e7c3-128">A maneira mais fácil de especificar o conjunto de concessões é recuperar um conjunto de permissões nomeadas da política de segurança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-128">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="0e7c3-129">O procedimento a seguir cria um domínio do aplicativo em área restrita que executa seu código com confiança parcial para testar cenários em que o código emitido pode acessar somente membros públicos de tipos públicos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-129">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="0e7c3-130">Um procedimento subsequente mostra como adicionar <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> para testar cenários em que o código emitido pode acessar tipos não públicos e membros em assemblies que recebem permissões iguais ou inferiores.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-130">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="0e7c3-131">Criar um domínio do aplicativo com confiança parcial</span><span class="sxs-lookup"><span data-stu-id="0e7c3-131">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="0e7c3-132">Crie um conjunto de permissões que serão concedidas aos assemblies no domínio do aplicativo em área restrita.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-132">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="0e7c3-133">Nesse caso, o conjunto de permissões da zona da Internet é usado.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-133">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="0e7c3-134">Crie um objeto <xref:System.AppDomainSetup> para inicializar o domínio do aplicativo com um caminho de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-134">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="0e7c3-135">Para simplificar, este exemplo de código usa a pasta atual.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-135">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="0e7c3-136">Para executar um código que realmente vem da Internet, use uma pasta separada para o código não confiável, conforme descrito em [Como executar código parcialmente confiável em uma área restrita](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="0e7c3-136">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="0e7c3-137">Crie o domínio do aplicativo especificando as informações de configuração de domínio do aplicativo e o conjunto de concessões para todos os assemblies que são executadas no domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-137">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="0e7c3-138">O último parâmetro da sobrecarga do método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> permite que você especifique um conjunto de assemblies que devem receber confiança total, em vez do conjunto de concessões do domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-138">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="0e7c3-139">Você não precisa especificar os assemblies do .NET Framework que o aplicativo usa, pois tais assemblies estão no cache de assembly global.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-139">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="0e7c3-140">Assemblies no cache de assembly global sempre são totalmente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-140">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="0e7c3-141">Você pode usar esse parâmetro para especificar os assemblies de nome forte que não estão no cache de assembly global.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-141">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="0e7c3-142">Adicionando RestrictedMemberAccess a domínios em área restrita</span><span class="sxs-lookup"><span data-stu-id="0e7c3-142">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="0e7c3-143">Aplicativos host podem permitir que os métodos dinâmicos hospedados anonimamente tenham acesso aos dados particulares em assemblies com níveis de confiança iguais ou inferior ao nível de confiança do assembly que emite o código.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-143">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="0e7c3-144">Para habilitar essa capacidade restrita de ignorar as verificações de visibilidade JIT (Just-In-Time), o aplicativo host adiciona um objeto <xref:System.Security.Permissions.ReflectionPermission> com o sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (ADM) para o conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-144">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="0e7c3-145">Por exemplo, um host pode conceder permissões da Internet a aplicativos da Internet mais ADM para que um aplicativo da Internet possa emitir código que acessa dados particulares em seus próprios assemblies.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-145">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="0e7c3-146">Como o acesso é limitado aos assemblies de confiança igual ou inferior, um aplicativo da Internet não pode acessar membros de assemblies totalmente confiáveis, como assemblies do .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-146">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="0e7c3-147">Para evitar a elevação de privilégio, as informações de pilha para o assembly de emissão são incluídas quando ps métodos dinâmicos hospedados anonimamente são construídos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-147">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="0e7c3-148">Quando o método é invocado, as informações de pilha são verificadas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-148">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="0e7c3-149">Dessa forma, um método dinâmico hospedado anonimamente que é invocado do código totalmente confiável ainda é limitado ao nível de confiança do assembly de emissão.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-149">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="0e7c3-150">Criar um domínio do aplicativo com confiança parcial mais ADM</span><span class="sxs-lookup"><span data-stu-id="0e7c3-150">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="0e7c3-151">Crie um novo objeto <xref:System.Security.Permissions.ReflectionPermission> com o sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (ADM) e use o método <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> para adicionar a permissão ao conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-151">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="0e7c3-152">O método <xref:System.Security.PermissionSet.AddPermission%2A> adiciona a permissão ao conjunto de concessões se ele não já estiver incluído.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-152">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="0e7c3-153">Se a permissão já estiver incluída no conjunto de concessões, os sinalizadores especificados serão adicionados à permissão existente.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-153">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0e7c3-154">O ADM é um recurso de métodos dinâmicos hospedados anonimamente.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-154">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="0e7c3-155">Quando métodos dinâmicos comuns ignoram verificações de visibilidade JIT, o código emitido requer confiança total.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-155">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="0e7c3-156">Crie o domínio do aplicativo especificando as informações de configuração do domínio do aplicativo e o conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-156">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="0e7c3-157">Executando código em domínios do aplicativo em área restrita</span><span class="sxs-lookup"><span data-stu-id="0e7c3-157">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="0e7c3-158">O procedimento a seguir explica como definir uma classe com métodos que podem ser executados em um domínio do aplicativo, como criar uma instância da classe do domínio e como executar seus métodos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-158">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="0e7c3-159">Definir e executar um método em um domínio do aplicativo</span><span class="sxs-lookup"><span data-stu-id="0e7c3-159">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="0e7c3-160">Defina uma classe derivada de <xref:System.MarshalByRefObject>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-160">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="0e7c3-161">Isso permite criar instâncias da classe em outros domínios do aplicativo e fazer chamadas de método entre limites de domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-161">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="0e7c3-162">Nesse exemplo, a classe é denominada `Worker`.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-162">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="0e7c3-163">Defina um método público que contém o código que você deseja executar.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-163">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="0e7c3-164">Neste exemplo, o código emite um método dinâmico simples, cria um delegado para executar o método e invoca o delegado.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-164">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="0e7c3-165">Em seu programa principal, obtenha o nome de exibição do seu assembly.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-165">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="0e7c3-166">Esse nome é usado quando você cria instâncias da classe `Worker` no domínio do aplicativo em área restrita.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-166">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="0e7c3-167">Em seu programa principal, crie um domínio do aplicativo em área restrita, conforme descrito [no primeiro procedimento](#Setting_up) neste passo a passo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-167">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="0e7c3-168">Não é necessário adicionar permissões ao conjunto de permissões `Internet`, pois o método `SimpleEmitDemo` usa apenas métodos públicos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-168">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="0e7c3-169">No seu programa principal, crie uma instância da classe `Worker` no domínio do aplicativo em área restrita.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-169">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="0e7c3-170">O método <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> cria o objeto no domínio do aplicativo de destino e retorna um proxy pode ser usado para chamar as propriedades e métodos do objeto.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-170">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0e7c3-171">Se você usar esse código em Visual Studio, deverá alterar o nome da classe para incluir o namespace.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-171">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="0e7c3-172">Por padrão, o namespace é o nome do projeto.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-172">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="0e7c3-173">Por exemplo, se o projeto for “PartialTrust”, o nome de classe deverá ser “PartialTrust.Worker”.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-173">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="0e7c3-174">Adicionar código para chamar o método `SimpleEmitDemo`.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-174">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="0e7c3-175">É realizado marshaling na chamada além do limite de domínio do aplicativo e o código é executado no domínio do aplicativo em área restrita.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-175">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="0e7c3-176">Usando métodos dinâmicos hospedados anonimamente</span><span class="sxs-lookup"><span data-stu-id="0e7c3-176">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="0e7c3-177">Métodos dinâmicos hospedados anonimamente são associados a um assembly transparente que é fornecido pelo sistema.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-177">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="0e7c3-178">Portanto, o código que eles contêm é transparente.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-178">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="0e7c3-179">Métodos dinâmicos comuns, por outro lado, devem ser associados a um módulo existente (especificado diretamente ou inferido de um tipo associado) e usar o nível de segurança desse módulo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-179">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="0e7c3-180">A única maneira de associar um método dinâmico ao assembly que fornece hospedagem anônima é usar os construtores descritos no procedimento a seguir.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-180">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="0e7c3-181">Não é possível especificar explicitamente um módulo no assembly hospedagem anônima.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-181">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="0e7c3-182">Métodos dinâmicos comuns têm acesso os membros internos do módulo aos quais estão associados ou aos membros privados do tipo aos quais estão associados.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-182">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="0e7c3-183">Como os métodos dinâmicos hospedados anonimamente são isolados do código, eles não tem acesso a dados particulares.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-183">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="0e7c3-184">No entanto, eles têm uma capacidade restrita para ignorar verificações de visibilidade JIT para obter acesso aos dados particulares.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-184">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="0e7c3-185">Essa capacidade é limitada a assemblies com níveis de confiança igual ou inferior ao nível de confiança do assembly que emite o código.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-185">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="0e7c3-186">Para evitar a elevação de privilégio, as informações de pilha para o assembly de emissão são incluídas quando ps métodos dinâmicos hospedados anonimamente são construídos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-186">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="0e7c3-187">Quando o método é invocado, as informações de pilha são verificadas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-187">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="0e7c3-188">Um método dinâmico hospedado anonimamente que é invocado do código totalmente confiável ainda é limitado ao nível de confiança do assembly que o emitiu.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-188">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="0e7c3-189">Usar métodos dinâmicos hospedados anonimamente</span><span class="sxs-lookup"><span data-stu-id="0e7c3-189">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="0e7c3-190">Crie um método dinâmico hospedado anonimamente usando um construtor que não especifica um tipo ou um módulo associado.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-190">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="0e7c3-191">Se um método dinâmico hospedado anonimamente usar apenas métodos e tipos públicos, ele não requer acesso de membro restrito e não precisa ignorar verificações de visibilidade JIT.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-191">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="0e7c3-192">Nenhuma permissão especial é necessária para emitir um método dinâmico, mas o código emitido requer as permissões exigidas por esses tipos e métodos que ele usa.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-192">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="0e7c3-193">Por exemplo, se o código emitido chama um método que acessa um arquivo, ele requer <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-193">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="0e7c3-194">Se o nível de confiança não inclui essa permissão, uma exceção de segurança é gerada quando o código emitido é executado.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-194">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="0e7c3-195">O código mostrado aqui emite um método dinâmico que usa apenas o método <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-195">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="0e7c3-196">Portanto, o código pode ser executado em locais parcialmente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-196">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="0e7c3-197">Como alternativa, crie um método dinâmico hospedado anonimamente com capacidade restrita de ignorar as verificações de visibilidade JIT usando o construtor <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> e especificando `true` para o parâmetro `restrictedSkipVisibility`.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-197">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="0e7c3-198">A restrição é que o método dinâmico hospedado anonimamente poderá acessar dados particulares somente em assemblies com níveis de confiança igual ou inferior ao nível de confiança do assembly de emissão.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-198">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="0e7c3-199">Por exemplo, se o método dinâmico estiver em execução com confiança de Internet, ele poderá acessar os dados particulares em outros assemblies que também são executados com confiança de Internet, mas não poderá acessar dados particulares de assemblies do .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-199">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="0e7c3-200">Assemblies do .NET Framework são instalados no cache de assembly global e sempre são totalmente confiáveis.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-200">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="0e7c3-201">Métodos dinâmicos hospedados anonimamente podem usar essa capacidade restrita para ignorar as verificações de visibilidade JIT somente se o aplicativo host conceder <xref:System.Security.Permissions.ReflectionPermission> com o sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-201">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="0e7c3-202">A demanda por essa permissão é realizada quando o método é invocado.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-202">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="0e7c3-203">Informações de pilha de chamadas para o assembly de emissão são incluídas quando o método dinâmico é construído.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-203">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="0e7c3-204">Portanto, a demanda é feita em relação às permissões do assembly de emissão, em vez do assembly que invoca o método.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-204">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="0e7c3-205">Isso impede que o código emitido seja executado com permissões elevadas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-205">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="0e7c3-206">O [exemplo de código completo](#Example) no final dessa instrução passo a passo demonstra o uso e as limitações de acesso de membro restrito.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-206">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="0e7c3-207">Sua classe `Worker` inclui um método que pode criar métodos dinâmicos hospedados anonimamente com ou sem o recurso restrito para ignorar as verificações de visibilidade e o exemplo mostra o resultado da execução desse método em domínios do aplicativo com níveis diferentes de confiança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-207">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="0e7c3-208">A capacidade restrita de ignorar as verificações de visibilidade é um recurso de métodos dinâmicos hospedados anonimamente.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-208">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="0e7c3-209">Quando métodos dinâmicos comuns ignoram verificações de visibilidade JIT, eles devem receber confiança total.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-209">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="0e7c3-210">Exemplo</span><span class="sxs-lookup"><span data-stu-id="0e7c3-210">Example</span></span>

### <a name="description"></a><span data-ttu-id="0e7c3-211">Descrição</span><span class="sxs-lookup"><span data-stu-id="0e7c3-211">Description</span></span>

<span data-ttu-id="0e7c3-212">O exemplo de código a seguir demonstra o uso do sinalizador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> para permitir que métodos dinâmicos hospedados anonimamente ignorem as verificações de visibilidade JIT, mas somente quando o membro de destino tiver um nível de confiança igual ou inferior ao assembly que emite o código.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-212">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="0e7c3-213">O exemplo define uma classe `Worker` que pode passar por marshaling entre limites de domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-213">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="0e7c3-214">A classe tem duas sobrecargas de método `AccessPrivateMethod` que emitem e executam métodos dinâmicos.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-214">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="0e7c3-215">A primeira sobrecarga emite um método dinâmico que chama o método `PrivateMethod` particular da classe `Worker` e pode emitir o método dinâmico com ou sem verificações de visibilidade JIT.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-215">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="0e7c3-216">A segunda sobrecarga emite um método dinâmico que acessa uma propriedade `internal` (propriedade `Friend` no Visual Basic) da classe <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-216">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="0e7c3-217">O exemplo usa um método auxiliar para criar um conjunto de concessões limitado a permissões `Internet` e, em seguida, cria um domínio do aplicativo, usando a sobrecarga do método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> para especificar que todo o código que é executado no domínio usa esse conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-217">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="0e7c3-218">O exemplo cria uma instância da classe `Worker` no domínio do aplicativo e executa o método `AccessPrivateMethod` duas vezes.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-218">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="0e7c3-219">Na primeira vez que o método `AccessPrivateMethod` é executado, as verificações de visibilidade JIT são impostas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-219">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="0e7c3-220">O método dinâmico falhará quando for invocado, pois as verificações de visibilidade JIT o impedirão de acessar o método particular.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-220">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="0e7c3-221">Na segunda vez que o método `AccessPrivateMethod` é executado, as verificações de visibilidade JIT são ignoradas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-221">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="0e7c3-222">O método dinâmico falha quando ele é compilado, porque o conjunto de concessões `Internet` não concede permissões suficientes para ignorar as verificações de visibilidade.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-222">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="0e7c3-223">O exemplo adiciona <xref:System.Security.Permissions.ReflectionPermission> com <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> ao conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-223">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="0e7c3-224">O exemplo a seguir cria um segundo domínio, especificando que todo o código que é executado no domínio recebe as permissões no novo conjunto de concessões.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-224">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="0e7c3-225">O exemplo cria uma instância da classe `Worker` no domínio do aplicativo e executa ambas as sobrecargas do método `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-225">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="0e7c3-226">A primeira sobrecarga do método `AccessPrivateMethod` é executada e as verificações de visibilidade JIT são ignoradas.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-226">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="0e7c3-227">O método dinâmico é compilado e executado com êxito, pois o assembly que emite o código é o mesmo que o assembly que contém o método particular.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-227">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="0e7c3-228">Portanto, os níveis de confiança são iguais.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-228">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="0e7c3-229">Se o aplicativo que contém a classe `Worker` tiver vários assemblies, o mesmo processo teria êxito para qualquer um desses assemblies, pois todos estão no mesmo nível de confiança.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-229">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="0e7c3-230">A segunda sobrecarga do método `AccessPrivateMethod` é executada e as verificações de visibilidade JIT são ignoradas novamente.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-230">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="0e7c3-231">Desta vez, o método dinâmico falha quando é compilado, pois ele tenta acessar a `internal` `FirstChar` propriedade da <xref:System.String> classe.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-231">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="0e7c3-232">O assembly que contém a classe <xref:System.String> é totalmente confiável.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-232">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="0e7c3-233">Portanto, ele está em um nível mais alto que o assembly que emite o código.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-233">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="0e7c3-234">Essa comparação mostra como <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> habilita código parcialmente confiável para ignorar as verificações de visibilidade para outros códigos parcialmente confiáveis sem comprometer a segurança do código confiável.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-234">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="0e7c3-235">Código</span><span class="sxs-lookup"><span data-stu-id="0e7c3-235">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="0e7c3-236">Compilando o código</span><span class="sxs-lookup"><span data-stu-id="0e7c3-236">Compiling the Code</span></span>

- <span data-ttu-id="0e7c3-237">Se você compilar esse exemplo de código no Visual Studio, deverá alterar o nome da classe para incluir o namespace ao passá-lo para o método <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-237">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="0e7c3-238">Por padrão, o namespace é o nome do projeto.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-238">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="0e7c3-239">Por exemplo, se o projeto for “PartialTrust”, o nome de classe deverá ser “PartialTrust.Worker”.</span><span class="sxs-lookup"><span data-stu-id="0e7c3-239">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="0e7c3-240">Veja também</span><span class="sxs-lookup"><span data-stu-id="0e7c3-240">See also</span></span>

- [<span data-ttu-id="0e7c3-241">Problemas de segurança na emissão de reflexão</span><span class="sxs-lookup"><span data-stu-id="0e7c3-241">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="0e7c3-242">Como executar código parcialmente confiável em uma área restrita</span><span class="sxs-lookup"><span data-stu-id="0e7c3-242">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
