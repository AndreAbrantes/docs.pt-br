---
title: "Escrevendo SQL dinâmico seguro no SQL Server"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-ado
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
caps.latest.revision: "9"
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.workload: dotnet
ms.openlocfilehash: 41c396bf2101e54adb1608f938c702ff7663cb1d
ms.sourcegitcommit: ed26cfef4e18f6d93ab822d8c29f902cff3519d1
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/17/2018
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="e7e97-102">Escrevendo SQL dinâmico seguro no SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="e7e97-103">A Injeção de SQL é o processo pelo qual um usuário mal-intencionado insere instruções Transact-SQL em vez de entrada válida.</span><span class="sxs-lookup"><span data-stu-id="e7e97-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="e7e97-104">Se a entrada for passada diretamente para o servidor sem ser validada e se o aplicativo executa inadvertidamente o código injetado, o ataque terá o potencial de danificar ou destruir dados.</span><span class="sxs-lookup"><span data-stu-id="e7e97-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="e7e97-105">Qualquer procedimento que construa instruções SQL deve ser analisado em busca de vulnerabilidades de injeção porque o SQL Server executará todas as consultas sintaticamente válidas que receber.</span><span class="sxs-lookup"><span data-stu-id="e7e97-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="e7e97-106">Até mesmo os dados com parâmetros podem ser manipulados por um invasor qualificado e determinado.</span><span class="sxs-lookup"><span data-stu-id="e7e97-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="e7e97-107">Se você usar o SQL dinâmico, parametrize os comandos e nunca inclua valores de parâmetros diretamente na cadeia de caracteres da consulta.</span><span class="sxs-lookup"><span data-stu-id="e7e97-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="e7e97-108">Anatomia de um ataque de injeção de SQL</span><span class="sxs-lookup"><span data-stu-id="e7e97-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="e7e97-109">O processo de injeção funciona encerrando prematuramente uma cadeia de caracteres de texto e anexando um novo comando.</span><span class="sxs-lookup"><span data-stu-id="e7e97-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="e7e97-110">Como o comando inserido pode ter cadeias de caracteres adicionais anexadas a ele antes de ser executado, o malfeitor encerra a cadeia de caracteres injetada com uma marca de comentário "--".</span><span class="sxs-lookup"><span data-stu-id="e7e97-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="e7e97-111">O texto subsequente é ignorado em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="e7e97-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="e7e97-112">Vários comandos podem ser inseridos usando um delimitador de ponto e vírgula (;).</span><span class="sxs-lookup"><span data-stu-id="e7e97-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="e7e97-113">Contanto que o código SQL injetado esteja sintaticamente correto, a violação não poderá ser detectada programaticamente.</span><span class="sxs-lookup"><span data-stu-id="e7e97-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="e7e97-114">Portanto, você deve validar todas as entradas de usuário e cuidadosamente revisar o código que executa comandos SQL construídos no servidor que você está usando.</span><span class="sxs-lookup"><span data-stu-id="e7e97-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="e7e97-115">Nunca concatene entrada de usuário que não seja validada.</span><span class="sxs-lookup"><span data-stu-id="e7e97-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="e7e97-116">A concatenação de cadeia de caracteres é o ponto de entrada primária para injeção de script.</span><span class="sxs-lookup"><span data-stu-id="e7e97-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="e7e97-117">Aqui estão algumas diretrizes úteis:</span><span class="sxs-lookup"><span data-stu-id="e7e97-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="e7e97-118">Nunca construa instruções Transact-SQL diretamente da entrada do usuário; use procedimentos armazenados para validar a entrada de usuário.</span><span class="sxs-lookup"><span data-stu-id="e7e97-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="e7e97-119">Valide a entrada de usuário testando tipo, comprimento, formato e intervalo.</span><span class="sxs-lookup"><span data-stu-id="e7e97-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="e7e97-120">Use a função Transact-SQL QUOTENAME() para ignorar nomes do sistema ou a função REPLACE() para ignorar qualquer caractere em uma cadeia de caracteres.</span><span class="sxs-lookup"><span data-stu-id="e7e97-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="e7e97-121">Implemente várias camadas de validação em cada camada do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="e7e97-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="e7e97-122">Teste o tamanho e o tipo de dados de entrada e imponha limites apropriados.</span><span class="sxs-lookup"><span data-stu-id="e7e97-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="e7e97-123">Isso pode ajudar a impedir o excesso deliberado de buffer.</span><span class="sxs-lookup"><span data-stu-id="e7e97-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="e7e97-124">Teste o conteúdo de variáveis de cadeia de caracteres e aceite somente valores previstos.</span><span class="sxs-lookup"><span data-stu-id="e7e97-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="e7e97-125">Rejeite entradas que contenham dados binários, sequências de escape e caracteres de comentário.</span><span class="sxs-lookup"><span data-stu-id="e7e97-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="e7e97-126">Quando você estiver trabalhando com documentos XML, valide todos os dados em seu esquema como foram inseridos.</span><span class="sxs-lookup"><span data-stu-id="e7e97-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="e7e97-127">Em ambientes de várias camadas, todos os dados devem ser validados antes de entrarem na zona de confiança.</span><span class="sxs-lookup"><span data-stu-id="e7e97-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="e7e97-128">Não aceite as seguintes cadeias de caracteres nos campos a partir do qual os nomes de arquivo podem ser construídos: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL e PRN.</span><span class="sxs-lookup"><span data-stu-id="e7e97-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="e7e97-129">Use objetos <xref:System.Data.SqlClient.SqlParameter> com procedimentos armazenados e comandos para fornecer a verificação de tipo e validação de comprimento.</span><span class="sxs-lookup"><span data-stu-id="e7e97-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="e7e97-130">Use expressões <xref:System.Text.RegularExpressions.Regex> em código de cliente para filtrar caracteres inválidos.</span><span class="sxs-lookup"><span data-stu-id="e7e97-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="e7e97-131">Estratégias dinâmicas do SQL</span><span class="sxs-lookup"><span data-stu-id="e7e97-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="e7e97-132">Executar instruções SQL dinamicamente criadas em seu código procedural quebra a cadeia de propriedade, fazendo o SQL Server verificar as permissões do chamador nos objetos acessados pelo SQL dinâmico.</span><span class="sxs-lookup"><span data-stu-id="e7e97-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="e7e97-133">O SQL Server tem métodos para conceder aos usuários acesso aos dados usando procedimentos armazenados e funções definidas pelo usuário que executa o SQL dinâmico.</span><span class="sxs-lookup"><span data-stu-id="e7e97-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="e7e97-134">Usando a representação com o Transact-SQL EXECUTE AS cláusula, conforme descrito em [personalizando permissões com representação no SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7e97-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="e7e97-135">Assinando procedimentos armazenados com certificados, conforme descrito em [assinatura de procedimentos armazenados no SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7e97-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="e7e97-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="e7e97-136">EXECUTE AS</span></span>  
 <span data-ttu-id="e7e97-137">A cláusula EXECUTE AS substitui as permissões do chamador com relação pelas do usuário especificado na cláusula EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="e7e97-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="e7e97-138">Os procedimentos armazenados aninhados ou gatilhos são executados sob o contexto de segurança do usuário do proxy.</span><span class="sxs-lookup"><span data-stu-id="e7e97-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="e7e97-139">Isso pode interromper aplicativos que dependem de segurança em nível de linha ou exigem auditoria.</span><span class="sxs-lookup"><span data-stu-id="e7e97-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="e7e97-140">Algumas funções que retornam a identidade do usuário retornam o usuário especificado na cláusula EXECUTE AS, não o chamador original.</span><span class="sxs-lookup"><span data-stu-id="e7e97-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="e7e97-141">O contexto de execução é revertido para o chamador original somente após a execução do procedimento ou quando uma instrução REVERT for emitida.</span><span class="sxs-lookup"><span data-stu-id="e7e97-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="e7e97-142">Assinatura de certificado</span><span class="sxs-lookup"><span data-stu-id="e7e97-142">Certificate Signing</span></span>  
 <span data-ttu-id="e7e97-143">Quando um procedimento armazenado que foi assinado com um certificado é executado, as permissões concedidas para o usuário do certificado são mescladas com as do chamador.</span><span class="sxs-lookup"><span data-stu-id="e7e97-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="e7e97-144">O contexto de execução permanece o mesmo; o usuário do certificado não representa o chamador.</span><span class="sxs-lookup"><span data-stu-id="e7e97-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="e7e97-145">Assinar procedimentos armazenados exige várias etapas para implementar.</span><span class="sxs-lookup"><span data-stu-id="e7e97-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="e7e97-146">Cada vez que o procedimento é modificado, ele deve ser assinado novamente.</span><span class="sxs-lookup"><span data-stu-id="e7e97-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="e7e97-147">Acesso entre bancos de dados</span><span class="sxs-lookup"><span data-stu-id="e7e97-147">Cross Database Access</span></span>  
 <span data-ttu-id="e7e97-148">O encadeamento de propriedades entre bancos de dados não funciona nos casos em que as instruções SQL criadas dinamicamente são executadas.</span><span class="sxs-lookup"><span data-stu-id="e7e97-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="e7e97-149">Você pode solucionar isso no [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] criando um procedimento armazenado que acessa dados em outro banco de dados e assinando o procedimento armazenado com um certificado existente em ambos os bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="e7e97-149">You can work around this in [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="e7e97-150">Isso concede acesso de usuários aos recursos de banco de dados usados pelo procedimento sem conceder-lhes o acesso ao banco de dados ou permissões.</span><span class="sxs-lookup"><span data-stu-id="e7e97-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="e7e97-151">Recursos externos</span><span class="sxs-lookup"><span data-stu-id="e7e97-151">External Resources</span></span>  
 <span data-ttu-id="e7e97-152">Para obter mais informações, consulte os seguintes recursos.</span><span class="sxs-lookup"><span data-stu-id="e7e97-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="e7e97-153">Recurso</span><span class="sxs-lookup"><span data-stu-id="e7e97-153">Resource</span></span>|<span data-ttu-id="e7e97-154">Descrição</span><span class="sxs-lookup"><span data-stu-id="e7e97-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="e7e97-155">[Procedimentos armazenados](http://go.microsoft.com/fwlink/?LinkId=98233) e [injeção SQL](http://go.microsoft.com/fwlink/?LinkId=98234) nos Manuais Online do SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-155">[Stored Procedures](http://go.microsoft.com/fwlink/?LinkId=98233) and [SQL Injection](http://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="e7e97-156">Os tópicos descrevem como criar procedimentos armazenados e como a injeção de SQL funciona.</span><span class="sxs-lookup"><span data-stu-id="e7e97-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
|<span data-ttu-id="e7e97-157">[Novos ataques por truncamento de SQL e como evitá-los](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) na MSDN Magazine.</span><span class="sxs-lookup"><span data-stu-id="e7e97-157">[New SQL Truncation Attacks And How To Avoid Them](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) in MSDN Magazine.</span></span>|<span data-ttu-id="e7e97-158">Descreve como delimitar caracteres e cadeias de caracteres, injeção de SQL e modificação por ataques de truncamento.</span><span class="sxs-lookup"><span data-stu-id="e7e97-158">Describes how to delimit characters and strings, SQL injection, and modification by  truncation attacks.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="e7e97-159">Consulte também</span><span class="sxs-lookup"><span data-stu-id="e7e97-159">See Also</span></span>  
 <span data-ttu-id="e7e97-160">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md) (Protegendo aplicativos ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="e7e97-160">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</span></span>  
 [<span data-ttu-id="e7e97-161">Visão geral de segurança do SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-161">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="e7e97-162">Cenários de segurança do aplicativo no SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-162">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="e7e97-163">Gerenciando permissões com procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-163">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e7e97-164">Assinando procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-164">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e7e97-165">Personalizando permissões com representação no SQL Server</span><span class="sxs-lookup"><span data-stu-id="e7e97-165">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 <span data-ttu-id="e7e97-166">[ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917) (Central de desenvolvedores do DataSet e de provedores gerenciados do ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="e7e97-166">[ADO.NET Managed Providers and DataSet Developer Center](http://go.microsoft.com/fwlink/?LinkId=217917)</span></span>
