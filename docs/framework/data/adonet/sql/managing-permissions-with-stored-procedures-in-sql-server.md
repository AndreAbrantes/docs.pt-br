---
title: Gerenciando permissões com procedimentos armazenados no SQL Server
ms.date: 03/30/2017
ms.assetid: 08fa34e8-2ffa-470d-ba62-e511a5f8558e
ms.openlocfilehash: 92752df75390c4f672f4a0cc1dd48ec7c07f6265
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54546498"
---
# <a name="managing-permissions-with-stored-procedures-in-sql-server"></a><span data-ttu-id="4fd67-102">Gerenciando permissões com procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-102">Managing Permissions with Stored Procedures in SQL Server</span></span>
<span data-ttu-id="4fd67-103">Um método de criar várias linhas de defesa em torno do banco de dados é implementar todo o acesso a dados usando procedimentos armazenados ou funções definidas pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="4fd67-103">One method of creating multiple lines of defense around your database is to implement all data access using stored procedures or user-defined functions.</span></span> <span data-ttu-id="4fd67-104">Você revogar ou nega todas as permissões para objetos subjacentes, como tabelas, e concede permissões EXECUTE em procedimentos armazenados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-104">You revoke or deny all permissions to underlying objects, such as tables, and grant EXECUTE permissions on stored procedures.</span></span> <span data-ttu-id="4fd67-105">Isso cria efetivamente um perímetro de segurança em torno dos dados e objetos de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-105">This effectively creates a security perimeter around your data and database objects.</span></span>  
  
## <a name="stored-procedure-benefits"></a><span data-ttu-id="4fd67-106">Benefícios do procedimento armazenado</span><span class="sxs-lookup"><span data-stu-id="4fd67-106">Stored Procedure Benefits</span></span>  
 <span data-ttu-id="4fd67-107">Os procedimentos armazenados têm os seguintes benefícios:</span><span class="sxs-lookup"><span data-stu-id="4fd67-107">Stored procedures have the following benefits:</span></span>  
  
-   <span data-ttu-id="4fd67-108">A lógica de dados e as regras de negócio podem ser encapsuladas de forma que os usuários possam acessar dados e objetos somente de maneiras que os desenvolvedores e administradores de banco de dados pretenderem.</span><span class="sxs-lookup"><span data-stu-id="4fd67-108">Data logic and business rules can be encapsulated so that users can access data and objects only in ways that developers and database administrators intend.</span></span>  
  
-   <span data-ttu-id="4fd67-109">Os procedimentos armazenados com parâmetros que validam toda a entrada do usuário podem ser usados para frustrar ataques de injeção SQL.</span><span class="sxs-lookup"><span data-stu-id="4fd67-109">Parameterized stored procedures that validate all user input can be used to thwart SQL injection attacks.</span></span> <span data-ttu-id="4fd67-110">Se você usar o SQL dinâmico, parametrize os comandos e nunca inclua valores de parâmetros diretamente na cadeia de caracteres de uma consulta.</span><span class="sxs-lookup"><span data-stu-id="4fd67-110">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into a query string.</span></span>  
  
-   <span data-ttu-id="4fd67-111">Consultas ad hoc e as modificações de dados podem ser recusadas.</span><span class="sxs-lookup"><span data-stu-id="4fd67-111">Ad hoc queries and data modifications can be disallowed.</span></span> <span data-ttu-id="4fd67-112">Isso impede que os usuários destruam dados de maneira maliciosa ou inadvertida ou executem consultas que comprometam o desempenho do servidor ou da rede.</span><span class="sxs-lookup"><span data-stu-id="4fd67-112">This prevents users from maliciously or inadvertently destroying data or executing queries that impair performance on the server or the network.</span></span>  
  
-   <span data-ttu-id="4fd67-113">Os erros podem ser tratados no código do procedimento sem ser passado diretamente para aplicativos cliente.</span><span class="sxs-lookup"><span data-stu-id="4fd67-113">Errors can be handled in procedure code without being passed directly to client applications.</span></span> <span data-ttu-id="4fd67-114">Isso impede que as mensagens de erro sejam retornadas, o que pode ajudar em um ataque de sondagem.</span><span class="sxs-lookup"><span data-stu-id="4fd67-114">This prevents error messages from being returned that could aid in a probing attack.</span></span> <span data-ttu-id="4fd67-115">Registre erros e trate-os no servidor.</span><span class="sxs-lookup"><span data-stu-id="4fd67-115">Log errors and handle them on the server.</span></span>  
  
-   <span data-ttu-id="4fd67-116">Os procedimentos armazenados podem ser escritos uma vez e acessados por muitos aplicativos.</span><span class="sxs-lookup"><span data-stu-id="4fd67-116">Stored procedures can be written once, and accessed by many applications.</span></span>  
  
-   <span data-ttu-id="4fd67-117">Os aplicativos cliente não precisam saber nada sobre as estruturas de dados subjacentes.</span><span class="sxs-lookup"><span data-stu-id="4fd67-117">Client applications do not need to know anything about the underlying data structures.</span></span> <span data-ttu-id="4fd67-118">O código do procedimento armazenado pode ser alterado sem exigir alterações em aplicativos cliente contanto que as alterações não afetem listas de parâmetros ou tipos de dados retornados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-118">Stored procedure code can be changed without requiring changes in client applications as long as the changes do not affect parameter lists or returned data types.</span></span>  
  
-   <span data-ttu-id="4fd67-119">Os procedimentos armazenados podem reduzir o tráfego de rede combinando várias operações em uma chamada de procedimento.</span><span class="sxs-lookup"><span data-stu-id="4fd67-119">Stored procedures can reduce network traffic by combining multiple operations into one procedure call.</span></span>  
  
## <a name="stored-procedure-execution"></a><span data-ttu-id="4fd67-120">Execução de procedimento armazenado</span><span class="sxs-lookup"><span data-stu-id="4fd67-120">Stored Procedure Execution</span></span>  
 <span data-ttu-id="4fd67-121">Os procedimentos armazenados aproveitam o encadeamento de propriedade para fornecer acesso aos dados de forma que os usuários não precisem ter a permissão explícita para acessar objetos de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-121">Stored procedures take advantage of ownership chaining to provide access to data so that users do not need to have explicit permission to access database objects.</span></span> <span data-ttu-id="4fd67-122">Uma cadeia de propriedade existe quando os objetos que se acessam entre si tiverem o mesmo proprietário sequencialmente.</span><span class="sxs-lookup"><span data-stu-id="4fd67-122">An ownership chain exists when objects that access each other sequentially are owned by the same user.</span></span> <span data-ttu-id="4fd67-123">Por exemplo, um procedimento armazenado pode chamar outros procedimentos armazenados, ou um procedimento armazenado pode acessar várias tabelas.</span><span class="sxs-lookup"><span data-stu-id="4fd67-123">For example, a stored procedure can call other stored procedures, or a stored procedure can access multiple tables.</span></span> <span data-ttu-id="4fd67-124">Se todos os objetos na cadeia de execução tiverem o mesmo proprietário, o SQL Server somente verificará a permissão EXECUTE para o chamador, não as permissões do chamador em outros objetos.</span><span class="sxs-lookup"><span data-stu-id="4fd67-124">If all objects in the chain of execution have the same owner, then SQL Server only checks the EXECUTE permission for the caller, not the caller's permissions on other objects.</span></span> <span data-ttu-id="4fd67-125">Portanto, você precisa conceder somente permissões EXECUTE em procedimentos armazenados; você pode revogar ou nega todas as permissões nas tabelas subjacentes.</span><span class="sxs-lookup"><span data-stu-id="4fd67-125">Therefore you need to grant only EXECUTE permissions on stored procedures; you can revoke or deny all permissions on the underlying tables.</span></span>  
  
## <a name="best-practices"></a><span data-ttu-id="4fd67-126">Práticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="4fd67-126">Best Practices</span></span>  
 <span data-ttu-id="4fd67-127">Somente gravar procedimentos armazenados não é suficiente para proteger adequadamente seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="4fd67-127">Simply writing stored procedures isn't enough to adequately secure your application.</span></span> <span data-ttu-id="4fd67-128">Você também deverá considerar os seguintes buracos na segurança.</span><span class="sxs-lookup"><span data-stu-id="4fd67-128">You should also consider the following potential security holes.</span></span>  
  
-   <span data-ttu-id="4fd67-129">Conceda permissões EXECUTE em procedimentos armazenados para funções de banco de dados que você deseja que possam acessar os dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-129">Grant EXECUTE permissions on the stored procedures for database roles you want to be able to access the data.</span></span>  
  
-   <span data-ttu-id="4fd67-130">Revogue ou negue todas as permissões para as tabelas subjacentes para todas as funções e usuários no banco de dados, inclusive a função `public`.</span><span class="sxs-lookup"><span data-stu-id="4fd67-130">Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the `public` role.</span></span> <span data-ttu-id="4fd67-131">Todos os usuários herdam permissões públicas.</span><span class="sxs-lookup"><span data-stu-id="4fd67-131">All users inherit permissions from public.</span></span> <span data-ttu-id="4fd67-132">Portanto, negar permissões a `public` significa que somente os proprietários e os membros de `sysadmin` têm acesso; todos os outros usuários não poderão herdar permissões de associação em outras funções.</span><span class="sxs-lookup"><span data-stu-id="4fd67-132">Therefore denying permissions to `public` means that only owners and `sysadmin` members have access; all other users will be unable to inherit permissions from membership in other roles.</span></span>  
  
-   <span data-ttu-id="4fd67-133">Não adicione usuários ou funções às funções `sysadmin` ou `db_owner`.</span><span class="sxs-lookup"><span data-stu-id="4fd67-133">Do not add users or roles to the `sysadmin` or `db_owner` roles.</span></span> <span data-ttu-id="4fd67-134">Os administradores do sistema e os proprietários de banco de dados podem acessar todos os objetos de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-134">System administrators and database owners can access all database objects.</span></span>  
  
-   <span data-ttu-id="4fd67-135">Desabilite a conta `guest`.</span><span class="sxs-lookup"><span data-stu-id="4fd67-135">Disable the `guest` account.</span></span> <span data-ttu-id="4fd67-136">Isso impedirá que os usuários anônimos conectem-se ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-136">This will prevent anonymous users from connecting to the database.</span></span> <span data-ttu-id="4fd67-137">A conta guest é desabilitada por padrão em novos bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="4fd67-137">The guest account is disabled by default in new databases.</span></span>  
  
-   <span data-ttu-id="4fd67-138">Implemente tratamento de erros e registre os erros em log.</span><span class="sxs-lookup"><span data-stu-id="4fd67-138">Implement error handling and log errors.</span></span>  
  
-   <span data-ttu-id="4fd67-139">Crie os procedimentos armazenados com parâmetros que validam toda a entrada do usuário.</span><span class="sxs-lookup"><span data-stu-id="4fd67-139">Create parameterized stored procedures that validate all user input.</span></span> <span data-ttu-id="4fd67-140">Considere toda a entrada do usuário como não confiável.</span><span class="sxs-lookup"><span data-stu-id="4fd67-140">Treat all user input as untrusted.</span></span>  
  
-   <span data-ttu-id="4fd67-141">Evite SQL dinâmico a menos que seja absolutamente necessário.</span><span class="sxs-lookup"><span data-stu-id="4fd67-141">Avoid dynamic SQL unless absolutely necessary.</span></span> <span data-ttu-id="4fd67-142">Use a função Transact-SQL QUOTENAME() para limitar um valor de cadeia de caracteres e ignorar qualquer ocorrência de delimitadores na cadeia de caracteres de entrada.</span><span class="sxs-lookup"><span data-stu-id="4fd67-142">Use the Transact-SQL QUOTENAME() function to delimit a string value and escape any occurrence of the delimiter in the input string.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="4fd67-143">Recursos externos</span><span class="sxs-lookup"><span data-stu-id="4fd67-143">External Resources</span></span>  
 <span data-ttu-id="4fd67-144">Para obter mais informações, consulte os seguintes recursos.</span><span class="sxs-lookup"><span data-stu-id="4fd67-144">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="4fd67-145">Recurso</span><span class="sxs-lookup"><span data-stu-id="4fd67-145">Resource</span></span>|<span data-ttu-id="4fd67-146">Descrição</span><span class="sxs-lookup"><span data-stu-id="4fd67-146">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="4fd67-147">[Procedimentos armazenados](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) e [Injeção de SQL](https://go.microsoft.com/fwlink/?LinkId=98234) nos Manuais Online do SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-147">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](https://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="4fd67-148">Os tópicos descrevem como criar procedimentos armazenados e como a injeção de SQL funciona.</span><span class="sxs-lookup"><span data-stu-id="4fd67-148">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="4fd67-149">Consulte também</span><span class="sxs-lookup"><span data-stu-id="4fd67-149">See also</span></span>
- <span data-ttu-id="4fd67-150">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md) (Protegendo aplicativos ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="4fd67-150">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</span></span>
- [<span data-ttu-id="4fd67-151">Visão geral de segurança do SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-151">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="4fd67-152">Cenários de segurança do aplicativo no SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-152">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="4fd67-153">Escrevendo SQL dinâmico seguro no SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-153">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="4fd67-154">Assinando procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-154">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="4fd67-155">Personalizando permissões com representação no SQL Server</span><span class="sxs-lookup"><span data-stu-id="4fd67-155">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="4fd67-156">Modificando dados com procedimentos armazenados</span><span class="sxs-lookup"><span data-stu-id="4fd67-156">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)
- <span data-ttu-id="4fd67-157">[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917) (Central de desenvolvedores do DataSet e de provedores gerenciados do ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="4fd67-157">[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)</span></span>
