---
title: Isolamento de instantâneo no SQL Server
description: Leia uma visão geral de isolamento de instantâneo e controle de versão de linha no SQL Server e saiba como gerenciar a simultaneidade com níveis de isolamento.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 4934c031eb9dfb26d60c5233937cbc65ca60d4f7
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91183072"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="524fc-103">Isolamento de instantâneo no SQL Server</span><span class="sxs-lookup"><span data-stu-id="524fc-103">Snapshot Isolation in SQL Server</span></span>

<span data-ttu-id="524fc-104">O isolamento de instantâneo aprimora a simultaneidade para aplicativos OLTP.</span><span class="sxs-lookup"><span data-stu-id="524fc-104">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="524fc-105">Entendendo o isolamento de instantâneo e o controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="524fc-105">Understanding Snapshot Isolation and Row Versioning</span></span>  

 <span data-ttu-id="524fc-106">Depois que o isolamento de instantâneo estiver habilitado, as versões de linha atualizadas para cada transação deverão ser mantidas.</span><span class="sxs-lookup"><span data-stu-id="524fc-106">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="524fc-107">Antes do SQL Server 2019, essas versões eram armazenadas em **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="524fc-107">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="524fc-108">SQL Server 2019 apresenta um novo recurso, a ADR (recuperação de banco de dados acelerada) que exige seu próprio conjunto de versões de linha.</span><span class="sxs-lookup"><span data-stu-id="524fc-108">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="524fc-109">Portanto, a partir de SQL Server 2019, se ADR não estiver habilitado, as versões de linha serão mantidas em **tempdb** como sempre.</span><span class="sxs-lookup"><span data-stu-id="524fc-109">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="524fc-110">Se ADR estiver habilitado, todas as versões de linha, relacionadas ao isolamento de instantâneo e ADR, serão mantidas no repositório de versão persistente do ADR (PVS), que está localizado no banco de dados do usuário em um grupo de arquivos que o usuário especifica.</span><span class="sxs-lookup"><span data-stu-id="524fc-110">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="524fc-111">Um número de sequência de transação exclusivo identifica cada transação. Esses números exclusivos são registrados para cada versão de linha.</span><span class="sxs-lookup"><span data-stu-id="524fc-111">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="524fc-112">A transação funciona com as versões de linha mais recentes que têm um número de sequência anterior ao número de sequência da transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-112">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="524fc-113">As versões de linha mais recentes criadas depois que a transação foi iniciada são ignoradas pela transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-113">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="524fc-114">O termo "instantâneo" reflete o fato de que todas as consultas na transação veem a mesma versão (ou instantâneo) do banco de dados, com base no estado do banco de dados no momento em que a transação é iniciada.</span><span class="sxs-lookup"><span data-stu-id="524fc-114">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="524fc-115">Nenhum bloqueio é adquirido nas linhas de dados subjacentes ou páginas de dados em uma transação de instantâneo, o que permite que outras transações sejam executadas sem serem bloqueadas por uma transação anterior não concluída.</span><span class="sxs-lookup"><span data-stu-id="524fc-115">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="524fc-116">Transações que modificam dados não bloqueiam transações que leem dados e transações que leem dados não bloqueiam transações que gravam dados, como normalmente fariam no nível de isolamento READ COMMITTED padrão no SQL Server.</span><span class="sxs-lookup"><span data-stu-id="524fc-116">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="524fc-117">Esse comportamento de não bloqueio também reduz consideravelmente a probabilidade de deadlocks para transações complexas.</span><span class="sxs-lookup"><span data-stu-id="524fc-117">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="524fc-118">O isolamento de instantâneo usa um modelo de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="524fc-118">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="524fc-119">Se uma transação de instantâneo tentar confirmar modificações a dados alterados desde o início da transação, a transação será revertida e um erro será gerado.</span><span class="sxs-lookup"><span data-stu-id="524fc-119">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="524fc-120">Você poderá evitar isso usando dicas de UPDLOCK para instruções SELECT que acessem dados a serem modificados.</span><span class="sxs-lookup"><span data-stu-id="524fc-120">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="524fc-121">Para obter mais informações, confira "Dicas de bloqueio" nos Manuais Online do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="524fc-121">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="524fc-122">Antes de ser usado em transações, o isolamento de instantâneo precisa ser habilitado ao configurar a opção ALLOW_SNAPSHOT_ISOLATION no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="524fc-122">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="524fc-123">Isso ativa o mecanismo para armazenar versões de linha no banco de dados temporário (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="524fc-123">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="524fc-124">Você precisa habilitar o isolamento de instantâneo, usando a instrução ALTER DATABASE do Transact-SQL, em cada banco de dados que usa esse recurso.</span><span class="sxs-lookup"><span data-stu-id="524fc-124">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="524fc-125">Nesse sentido, o isolamento de instantâneos difere dos níveis de isolamento tradicionais de READ COMMITTED, REPEATABLE READ, SERIALIZABLE e READ UNCOMMITTED, que não exigem nenhuma configuração.</span><span class="sxs-lookup"><span data-stu-id="524fc-125">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="524fc-126">As seguintes instruções ativam o isolamento de instantâneo e substituem o comportamento READ COMMITTED padrão por SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="524fc-126">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="524fc-127">Configurar a opção READ_COMMITTED_SNAPSHOT ON permite o acesso a linhas com controle de versão no nível de isolamento READ COMMITTED padrão.</span><span class="sxs-lookup"><span data-stu-id="524fc-127">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="524fc-128">Se a opção READ_COMMITTED_SNAPSHOT for definida como OFF, você precisará definir explicitamente o nível de isolamento do instantâneo para cada sessão a fim de acessar linhas com controle de versão.</span><span class="sxs-lookup"><span data-stu-id="524fc-128">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="524fc-129">Gerenciando simultaneidade com níveis de isolamento</span><span class="sxs-lookup"><span data-stu-id="524fc-129">Managing Concurrency with Isolation Levels</span></span>  

 <span data-ttu-id="524fc-130">O nível de isolamento sob o qual uma instrução Transact-SQL é executada determina o comportamento de bloqueio e de controle de versão de linha dessa instrução.</span><span class="sxs-lookup"><span data-stu-id="524fc-130">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="524fc-131">Um nível de isolamento tem escopo que abrange toda a conexão e, uma vez definido para uma conexão com a instrução SET TRANSACTION ISOLATION LEVEL, ele permanece em vigor até que a conexão seja fechada ou outro nível de isolamento seja definido.</span><span class="sxs-lookup"><span data-stu-id="524fc-131">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="524fc-132">Quando uma conexão é fechada e retornada ao pool, o nível de isolamento da última instrução SET TRANSACTION ISOLATION LEVEL é mantido.</span><span class="sxs-lookup"><span data-stu-id="524fc-132">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="524fc-133">As conexões subsequentes reutilizando uma conexão em pool usam o nível de isolamento que estava em vigor no momento em que a conexão em questão foi colocada em pool.</span><span class="sxs-lookup"><span data-stu-id="524fc-133">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="524fc-134">As consultas individuais emitidas em uma conexão podem conter dicas de bloqueio que modificam o isolamento para uma só instrução ou transação, mas não afetam o nível de isolamento da conexão.</span><span class="sxs-lookup"><span data-stu-id="524fc-134">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="524fc-135">Os níveis de isolamento ou as dicas de bloqueio definidas em procedimentos armazenados ou funções não alteram o nível de isolamento da conexão que os chama e estão em vigor apenas pela duração do procedimento armazenado ou da chamada de função.</span><span class="sxs-lookup"><span data-stu-id="524fc-135">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="524fc-136">Quatro níveis de isolamento definidos no padrão SQL-92 são compatíveis com versões anteriores do SQL Server:</span><span class="sxs-lookup"><span data-stu-id="524fc-136">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="524fc-137">READ UNCOMMITTED é o nível de isolamento menos restritivo, pois ignora os bloqueios estabelecidos por outras transações.</span><span class="sxs-lookup"><span data-stu-id="524fc-137">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="524fc-138">Transações em execução sob READ UNCOMMITTED podem ler valores de dados modificados que ainda não foram confirmados por outras transações; essas são chamadas de leituras "sujas".</span><span class="sxs-lookup"><span data-stu-id="524fc-138">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="524fc-139">READ COMMITTED é o nível de isolamento padrão para o SQL Server.</span><span class="sxs-lookup"><span data-stu-id="524fc-139">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="524fc-140">Ele impede a realização de leituras sujas especificando que as instruções não podem ler valores de dados que foram modificados, mas ainda não confirmados por outras transações.</span><span class="sxs-lookup"><span data-stu-id="524fc-140">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="524fc-141">Outras transações ainda podem modificar, inserir ou excluir dados entre execuções de instruções individuais dentro da transação atual, resultando em leituras não repetíveis ou dados fantasmas.</span><span class="sxs-lookup"><span data-stu-id="524fc-141">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="524fc-142">REPEATABLE READ é um nível de isolamento mais restritivo do que READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="524fc-142">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="524fc-143">Ele engloba READ COMMITTED e, adicionalmente, especifica que nenhuma outra transação pode modificar nem excluir dados que tenham sido lidos pela transação atual até que a transação atual seja confirmada.</span><span class="sxs-lookup"><span data-stu-id="524fc-143">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="524fc-144">A simultaneidade é menor do que a encontrada em READ COMMITTED, porque os bloqueios compartilhados nos dados lidos são mantidos até o término da transação, em vez de serem liberados ao final de cada instrução.</span><span class="sxs-lookup"><span data-stu-id="524fc-144">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="524fc-145">SERIALIZABLE é o nível de isolamento mais restritivo, pois ele bloqueia intervalos de chaves inteiros até que a transação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="524fc-145">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="524fc-146">Ele engloba REPEATABLE READ e adiciona a restrição de que outras transações não podem inserir novas linhas em intervalos que foram lidos pela transação até que a transação esteja concluída.</span><span class="sxs-lookup"><span data-stu-id="524fc-146">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="524fc-147">Para obter mais informações, confira o [Guia de controle de versão de linha e bloqueio de transação](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="524fc-147">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="524fc-148">Extensões de nível de isolamento de instantâneo</span><span class="sxs-lookup"><span data-stu-id="524fc-148">Snapshot Isolation Level Extensions</span></span>  

 <span data-ttu-id="524fc-149">O SQL Server introduziu extensões nos níveis de isolamento SQL-92 com a introdução do nível de isolamento do SNAPSHOT e uma implementação adicional de READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="524fc-149">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="524fc-150">O nível de isolamento READ_COMMITTED_SNAPSHOT pode substituir READ COMMITTED de maneira transparente para todas as transações.</span><span class="sxs-lookup"><span data-stu-id="524fc-150">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="524fc-151">O nível de isolamento SNAPSHOT especifica que dados lidos dentro de uma transação nunca refletirão alterações feitas por outras transações simultâneas.</span><span class="sxs-lookup"><span data-stu-id="524fc-151">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="524fc-152">A transação usa as versões de linhas de dados que existem quando a transação é iniciada.</span><span class="sxs-lookup"><span data-stu-id="524fc-152">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="524fc-153">Nenhum bloqueio é colocado nos dados quando eles são lidos, então transações com nível de isolamento SNAPSHOT não bloqueiam a gravação de dados por outras transações.</span><span class="sxs-lookup"><span data-stu-id="524fc-153">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="524fc-154">Transações que gravam dados não impedem que transações snapshot leiam dados.</span><span class="sxs-lookup"><span data-stu-id="524fc-154">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="524fc-155">Para poder usar o isolamento de instantâneo, você precisa habilitá-lo, configurando a opção de banco de dados ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="524fc-155">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="524fc-156">A opção de banco de dados READ_COMMITTED_SNAPSHOT determina o comportamento do nível de isolamento READ COMMITTED padrão quando o isolamento de instantâneo está habilitado em um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="524fc-156">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="524fc-157">Se você não especificar READ_COMMITTED_SNAPSHOT como ON, READ COMMITTED será aplicado a todas as transações implícitas.</span><span class="sxs-lookup"><span data-stu-id="524fc-157">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="524fc-158">Isso resulta no mesmo comportamento obtido ao configurar READ_COMMITTED_SNAPSHOT como OFF (o padrão).</span><span class="sxs-lookup"><span data-stu-id="524fc-158">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="524fc-159">Quando READ_COMMITTED_SNAPSHOT OFF está em vigor, o Mecanismo de Banco de Dados usa bloqueios compartilhados para impor o nível de isolamento padrão.</span><span class="sxs-lookup"><span data-stu-id="524fc-159">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="524fc-160">Se você definir a opção de banco de dados READ_COMMITTED_SNAPSHOT como ON, o mecanismo de banco de dados usará o controle de versão de linha e o isolamento de instantâneo como o padrão, em vez de usar bloqueios para proteger os dados.</span><span class="sxs-lookup"><span data-stu-id="524fc-160">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="524fc-161">Como funcionam o isolamento de instantâneo e o controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="524fc-161">How Snapshot Isolation and Row Versioning Work</span></span>  

 <span data-ttu-id="524fc-162">Quando o nível de isolamento SNAPSHOT está habilitado, cada vez que uma linha é atualizada, o Mecanismo de Banco de Dados do SQL Server armazena uma cópia da linha original em **tempdb** e adiciona um número de sequência da transação à linha.</span><span class="sxs-lookup"><span data-stu-id="524fc-162">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="524fc-163">A seguinte sequência de eventos ocorre:</span><span class="sxs-lookup"><span data-stu-id="524fc-163">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="524fc-164">Uma nova transação é iniciada e recebe um número de sequência de transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-164">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="524fc-165">O Mecanismo de Banco de Dados lê uma linha dentro da transação e recupera a versão de linha de **tempdb** ao qual o número de sequência está próximo, e menor do que o número de sequência de transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-165">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="524fc-166">O Mecanismo de Banco de Dados verifica se o número de sequência da transação não está na lista de números de sequência de transação das transações não confirmadas ativas quando a transação de instantâneo foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="524fc-166">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="524fc-167">A transação lê a versão da linha de **tempdb** que estava atual no início da transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-167">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="524fc-168">Ela não verá novas linhas inseridas depois que a transação foi iniciada, porque esses valores de número de sequência serão maiores que o valor do número de sequência da transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-168">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="524fc-169">A transação atual verá as linhas que foram excluídas depois que a transação iniciou, porque haverá uma versão de linha em **tempdb** com um valor menor do número de sequência.</span><span class="sxs-lookup"><span data-stu-id="524fc-169">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="524fc-170">O resultado efetivo do isolamento de instantâneo é que a transação vê todos os dados como eles existiam no início da transação, sem respeitar nem colocar nenhum bloqueio nas tabelas subjacentes.</span><span class="sxs-lookup"><span data-stu-id="524fc-170">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="524fc-171">Isso pode resultar em aprimoramentos de desempenho em situações em que há contenção.</span><span class="sxs-lookup"><span data-stu-id="524fc-171">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="524fc-172">Uma transação de instantâneo sempre usa o controle de simultaneidade otimista, transacionando todos os bloqueios que impediriam que outras transações atualizassem as linhas.</span><span class="sxs-lookup"><span data-stu-id="524fc-172">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="524fc-173">Se uma transação de instantâneo tentar confirmar uma atualização para uma linha que foi alterada após o início da transação, a transação será revertida e um erro será gerado.</span><span class="sxs-lookup"><span data-stu-id="524fc-173">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="524fc-174">Trabalhando com isolamento de instantâneo no ADO.NET</span><span class="sxs-lookup"><span data-stu-id="524fc-174">Working with Snapshot Isolation in ADO.NET</span></span>  

 <span data-ttu-id="524fc-175">O isolamento de instantâneo é compatível com o ADO.NET graças ao uso da classe <xref:System.Data.SqlClient.SqlTransaction>.</span><span class="sxs-lookup"><span data-stu-id="524fc-175">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="524fc-176">Se um banco de dados tiver sido habilitado para o isolamento de instantâneo, mas não estiver configurado para READ_COMMITTED_SNAPSHOT ON, você deverá iniciar um <xref:System.Data.SqlClient.SqlTransaction> usando o valor de enumeração **IsolationLevel.Snapshot** ao chamar o método <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>.</span><span class="sxs-lookup"><span data-stu-id="524fc-176">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="524fc-177">Esse fragmento de código pressupõe que a conexão é um objeto <xref:System.Data.SqlClient.SqlConnection> aberto.</span><span class="sxs-lookup"><span data-stu-id="524fc-177">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="524fc-178">Exemplo</span><span class="sxs-lookup"><span data-stu-id="524fc-178">Example</span></span>  

 <span data-ttu-id="524fc-179">O exemplo a seguir demonstra como os diferentes níveis de isolamento se comportam ao tentar acessar dados bloqueados e não se destina a ser usado em código de produção.</span><span class="sxs-lookup"><span data-stu-id="524fc-179">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="524fc-180">O código conecta-se ao banco de dados de exemplo **AdventureWorks** no SQL Server e cria uma tabela denominada **TestSnapshot** e insere uma linha de dados.</span><span class="sxs-lookup"><span data-stu-id="524fc-180">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="524fc-181">O código usa a instrução ALTER DATABASE do Transact-SQL para ativar o isolamento de instantâneo para o banco de dados, mas não define a opção READ_COMMITTED_SNAPSHOT, deixando o comportamento padrão de nível de isolamento READ COMMITTED em vigor.</span><span class="sxs-lookup"><span data-stu-id="524fc-181">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="524fc-182">Em seguida, o código executa as seguintes ações:</span><span class="sxs-lookup"><span data-stu-id="524fc-182">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="524fc-183">Ele começa, mas não conclui, sqlTransaction1, que usa o nível de isolamento SERIALIZABLE para iniciar uma transação de atualização.</span><span class="sxs-lookup"><span data-stu-id="524fc-183">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="524fc-184">Isso faz com que a tabela seja bloqueada.</span><span class="sxs-lookup"><span data-stu-id="524fc-184">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="524fc-185">Abre uma segunda conexão e inicia uma segunda transação usando o nível de isolamento SNAPSHOT para ler os dados na tabela **TestSnapshot**.</span><span class="sxs-lookup"><span data-stu-id="524fc-185">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="524fc-186">Como o isolamento de instantâneo está habilitado, essa transação pode ler os dados que existiam antes de a sqlTransaction1 ser iniciada.</span><span class="sxs-lookup"><span data-stu-id="524fc-186">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="524fc-187">Abre uma terceira conexão e inicia uma transação usando o nível de isolamento READ COMMITTED para tentar ler os dados na tabela.</span><span class="sxs-lookup"><span data-stu-id="524fc-187">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="524fc-188">Nesse caso, o código não pode ler os dados porque não é possível ler após os bloqueios colocados na tabela na primeira transação e expirar. O mesmo resultado ocorreria se os níveis de isolamento REPETIdos de leitura e SERIALIZÁvel fossem usados porque esses níveis de isolamento também não conseguem ler os bloqueios colocados na primeira transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-188">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="524fc-189">Ele abre uma quarta conexão e inicia uma transação usando o nível de isolamento READ UNCOMMITTED, que executa uma leitura suja do valor não confirmado em sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="524fc-189">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="524fc-190">Esse valor poderá nunca realmente existir no banco de dados se a primeira transação não for confirmada.</span><span class="sxs-lookup"><span data-stu-id="524fc-190">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="524fc-191">Ele primeiro reverte a primeira transação e a limpa excluindo a tabela **TestSnapshot** e desativando o isolamento de instantâneo para o banco de dados **AdventureWorks**.</span><span class="sxs-lookup"><span data-stu-id="524fc-191">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="524fc-192">Os exemplos a seguir usam a mesma cadeia de conexão com o pool de conexão desativado.</span><span class="sxs-lookup"><span data-stu-id="524fc-192">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="524fc-193">Se uma conexão for colocada em pool, redefinir o nível de isolamento dela não redefinirá o nível de isolamento no servidor.</span><span class="sxs-lookup"><span data-stu-id="524fc-193">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="524fc-194">Como resultado, as conexões subsequentes que usam a mesma conexão interna em pool começam com seus respectivos níveis de isolamento definidos para o da conexão em pool.</span><span class="sxs-lookup"><span data-stu-id="524fc-194">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="524fc-195">Uma alternativa para desativar o pool de conexões é definir o nível de isolamento explicitamente para cada conexão.</span><span class="sxs-lookup"><span data-stu-id="524fc-195">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="524fc-196">Exemplo</span><span class="sxs-lookup"><span data-stu-id="524fc-196">Example</span></span>  

 <span data-ttu-id="524fc-197">O exemplo a seguir demonstra o comportamento do isolamento de instantâneo quando os dados estão sendo modificados.</span><span class="sxs-lookup"><span data-stu-id="524fc-197">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="524fc-198">O código executa as seguintes ações:</span><span class="sxs-lookup"><span data-stu-id="524fc-198">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="524fc-199">Conecta-se a um banco de dados de exemplo **AdventureWorks** e permite o isolamento de SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="524fc-199">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="524fc-200">Cria uma tabela denominada **TestSnapshotUpdate** e insere três linhas de dados de exemplo.</span><span class="sxs-lookup"><span data-stu-id="524fc-200">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="524fc-201">Começa sqlTransaction1 usando o isolamento de instantâneo, mas não a conclui.</span><span class="sxs-lookup"><span data-stu-id="524fc-201">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="524fc-202">Três linhas de dados são selecionadas na transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-202">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="524fc-203">Cria um segundo **SqlConnection** para **AdventureWorks** e cria uma segunda transação usando o nível de isolamento READ COMMITTED que atualiza um valor em uma das linhas selecionadas em sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="524fc-203">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="524fc-204">Confirma sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="524fc-204">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="524fc-205">Retorna para sqlTransaction1 e tenta atualizar a mesma linha que sqlTransaction1 já confirmou.</span><span class="sxs-lookup"><span data-stu-id="524fc-205">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="524fc-206">O erro 3960 é gerado e sqlTransaction1 é revertida automaticamente.</span><span class="sxs-lookup"><span data-stu-id="524fc-206">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="524fc-207">O **SqlException.Number** e **SqlException.Message** são exibidos na janela do console.</span><span class="sxs-lookup"><span data-stu-id="524fc-207">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="524fc-208">Executa o código de limpeza para desligar o isolamento de instantâneo no **AdventureWorks** e excluir a tabela **TestSnapshotUpdate**.</span><span class="sxs-lookup"><span data-stu-id="524fc-208">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="524fc-209">Usando dicas de bloqueio com isolamento de instantâneo</span><span class="sxs-lookup"><span data-stu-id="524fc-209">Using Lock Hints with Snapshot Isolation</span></span>  

 <span data-ttu-id="524fc-210">No exemplo anterior, a primeira transação seleciona dados e uma segunda transação atualiza os dados antes que a primeira transação possa ser concluída, causando um conflito de atualização quando a primeira transação tenta atualizar a mesma linha.</span><span class="sxs-lookup"><span data-stu-id="524fc-210">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="524fc-211">Você pode reduzir a chance de conflitos de atualização em transações de instantâneo de execução longa pelo fornecimento de dicas de bloqueio no início da transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-211">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="524fc-212">A seguinte instrução SELECT usa a dica UPDLOCK para bloquear as linhas selecionadas:</span><span class="sxs-lookup"><span data-stu-id="524fc-212">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="524fc-213">O uso da dica de bloqueio UPDLOCK bloqueia as linhas que tentam atualizar as linhas antes da primeira transação ser concluída.</span><span class="sxs-lookup"><span data-stu-id="524fc-213">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="524fc-214">Isso garante que as linhas selecionadas não tenham conflitos quando forem atualizadas posteriormente na transação.</span><span class="sxs-lookup"><span data-stu-id="524fc-214">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="524fc-215">Confira "Dicas de bloqueio" nos Manuais Online do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="524fc-215">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="524fc-216">Se o aplicativo tem muitos conflitos, o isolamento de instantâneo pode não ser a melhor opção.</span><span class="sxs-lookup"><span data-stu-id="524fc-216">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="524fc-217">As dicas só devem ser usadas quando realmente necessário.</span><span class="sxs-lookup"><span data-stu-id="524fc-217">Hints should only be used when really needed.</span></span> <span data-ttu-id="524fc-218">Seu aplicativo não deve ser projetado para que ele dependa constantemente de dicas de bloqueio para sua operação.</span><span class="sxs-lookup"><span data-stu-id="524fc-218">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="524fc-219">Veja também</span><span class="sxs-lookup"><span data-stu-id="524fc-219">See also</span></span>

- [<span data-ttu-id="524fc-220">SQL Server e ADO.NET</span><span class="sxs-lookup"><span data-stu-id="524fc-220">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="524fc-221">Visão geral do ADO.NET</span><span class="sxs-lookup"><span data-stu-id="524fc-221">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="524fc-222">Guia de Controle de Versão de Linha e Bloqueio de Transações</span><span class="sxs-lookup"><span data-stu-id="524fc-222">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
