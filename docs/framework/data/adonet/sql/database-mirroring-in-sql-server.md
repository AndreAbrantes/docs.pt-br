---
title: Espelhamento de banco de dados no SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.openlocfilehash: 81e8bd5ba9274c84ffe18f617978b61238ebeff2
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/07/2019
ms.locfileid: "70782437"
---
# <a name="database-mirroring-in-sql-server"></a><span data-ttu-id="c9d78-102">Espelhamento de banco de dados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="c9d78-102">Database Mirroring in SQL Server</span></span>
<span data-ttu-id="c9d78-103">O espelhamento de banco de dados no SQL Server permite que você mantenha uma cópia, ou o espelho, de um banco de dados do SQL Server em um servidor em espera.</span><span class="sxs-lookup"><span data-stu-id="c9d78-103">Database mirroring in SQL Server allows you to keep a copy, or mirror, of a SQL Server database on a standby server.</span></span> <span data-ttu-id="c9d78-104">O espelhamento garante que duas cópias separadas dos dados existam o tempo todo, fornecendo a alta disponibilidade e a redundância completa de dados.</span><span class="sxs-lookup"><span data-stu-id="c9d78-104">Mirroring ensures that two separate copies of the data exist at all times, providing high availability and complete data redundancy.</span></span> <span data-ttu-id="c9d78-105">O provedor de dados .NET para o SQL Server fornece suporte implícito para espelhamento de banco de dados, de modo que o desenvolvedor não precisa realizar nenhuma ação ou gravar código quando tiver sido configurado para um banco de dados do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c9d78-105">The .NET Data Provider for SQL Server provides implicit support for database mirroring, so that the developer does not need to take any action or write any code once it has been configured for a SQL Server database.</span></span> <span data-ttu-id="c9d78-106">Além disso, o objeto <xref:System.Data.SqlClient.SqlConnection> oferece suporte a um modo de conexão explícita que permite fornecer o nome de um servidor de parceiro de failover no <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="c9d78-106">In addition, the <xref:System.Data.SqlClient.SqlConnection> object supports an explicit connection mode that allows supplying the name of a failover partner server in the <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
 <span data-ttu-id="c9d78-107">A seguinte sequência simplificada de eventos ocorre para um objeto <xref:System.Data.SqlClient.SqlConnection> cujo alvo são um banco de dados configurado para espelhamento:</span><span class="sxs-lookup"><span data-stu-id="c9d78-107">The following simplified sequence of events occurs for a <xref:System.Data.SqlClient.SqlConnection> object that targets a database configured for mirroring:</span></span>  
  
1. <span data-ttu-id="c9d78-108">O aplicativo cliente conecta-se com sucesso ao banco de dados principal e o servidor envia de volta o nome do servidor parceiro, que é armazenado em cache no cliente.</span><span class="sxs-lookup"><span data-stu-id="c9d78-108">The client application successfully connects to the principal database, and the server sends back the name of the partner server, which is then cached on the client.</span></span>  
  
2. <span data-ttu-id="c9d78-109">Se o servidor que contém o banco de dados principal falhar ou a conectividade for interrompida, a conexão e o estado da transação serão perdidos.</span><span class="sxs-lookup"><span data-stu-id="c9d78-109">If the server containing the principal database fails or connectivity is interrupted, connection and transaction state is lost.</span></span> <span data-ttu-id="c9d78-110">O aplicativo cliente tenta restabelecer uma conexão com o banco de dados principal e falha.</span><span class="sxs-lookup"><span data-stu-id="c9d78-110">The client application attempts to re-establish a connection to the principal database and fails.</span></span>  
  
3. <span data-ttu-id="c9d78-111">O aplicativo cliente em seguida tenta de modo transparente estabelecer uma conexão com o banco de dados espelho no servidor parceiro.</span><span class="sxs-lookup"><span data-stu-id="c9d78-111">The client application then transparently attempts to establish a connection to the mirror database on the partner server.</span></span> <span data-ttu-id="c9d78-112">Se tiver êxito, a conexão será redirecionada para o banco de dados espelho, que então se torna o novo banco de dados principal.</span><span class="sxs-lookup"><span data-stu-id="c9d78-112">If it succeeds, the connection is redirected to the mirror database, which then becomes the new principal database.</span></span>  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a><span data-ttu-id="c9d78-113">Especificando o parceiro de failover na cadeia de conexão</span><span class="sxs-lookup"><span data-stu-id="c9d78-113">Specifying the Failover Partner in the Connection String</span></span>  
 <span data-ttu-id="c9d78-114">Se você fornece o nome de um servidor de parceiro de failover na cadeia de conexão, o cliente tentará de modo transparente uma conexão com o parceiro de failover se o banco de dados principal ficar indisponível quando o aplicativo cliente for conectado primeiro.</span><span class="sxs-lookup"><span data-stu-id="c9d78-114">If you supply the name of a failover partner server in the connection string, the client will transparently attempt a connection with the failover partner if the principal database is unavailable when the client application first connects.</span></span>  
  
```  
";Failover Partner=PartnerServerName"  
```  
  
 <span data-ttu-id="c9d78-115">Se você omitir o nome do servidor de parceiro de failover e o banco de dados principal ficar indisponível quando o aplicativo cliente é conectado primeiro, um <xref:System.Data.SqlClient.SqlException> é gerado.</span><span class="sxs-lookup"><span data-stu-id="c9d78-115">If you omit the name of the failover partner server and the principal database is unavailable when the client application first connects then a <xref:System.Data.SqlClient.SqlException> is raised.</span></span>  
  
 <span data-ttu-id="c9d78-116">Quando um <xref:System.Data.SqlClient.SqlConnection> é aberto com êxito, o nome do parceiro de failover é retornado pelo servidor e substitui todos os valores fornecidos na cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="c9d78-116">When a <xref:System.Data.SqlClient.SqlConnection> is successfully opened, the failover partner name is returned by the server and supersedes any values supplied in the connection string.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c9d78-117">Você deve especificar explicitamente o catálogo inicial ou o nome do banco de dados na cadeia de conexão para cenários de espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c9d78-117">You must explicitly specify the initial catalog or database name in the connection string for database mirroring scenarios.</span></span> <span data-ttu-id="c9d78-118">Se o cliente receber informações de failover em uma conexão que não tem um catálogo inicial ou um banco de dados explicitamente especificado, as informações de failover não serão armazenadas em cache e o aplicativo não tentará realizar o failover se o servidor principal falhar.</span><span class="sxs-lookup"><span data-stu-id="c9d78-118">If the client receives failover information on a connection that doesn't have an explicitly specified initial catalog or database, the failover information is not cached and the application does not attempt to fail over if the principal server fails.</span></span> <span data-ttu-id="c9d78-119">Se uma cadeia de conexão tiver um valor para o parceiro de failover, mas nenhum valor para o catálogo inicial ou banco de dados, um `InvalidArgumentException` será gerado.</span><span class="sxs-lookup"><span data-stu-id="c9d78-119">If a connection string has a value for the failover partner, but no value for the initial catalog or database, an `InvalidArgumentException` is raised.</span></span>  
  
## <a name="retrieving-the-current-server-name"></a><span data-ttu-id="c9d78-120">Recuperando o nome do servidor atual</span><span class="sxs-lookup"><span data-stu-id="c9d78-120">Retrieving the Current Server Name</span></span>  
 <span data-ttu-id="c9d78-121">No caso de um failover, você poderá recuperar o nome do servidor ao qual a conexão atual está realmente conectada usando a propriedade <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> de um objeto <xref:System.Data.SqlClient.SqlConnection>.</span><span class="sxs-lookup"><span data-stu-id="c9d78-121">In the event of a failover, you can retrieve the name of the server to which the current connection is actually connected by using the <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> property of a <xref:System.Data.SqlClient.SqlConnection> object.</span></span> <span data-ttu-id="c9d78-122">O fragmento de código a seguir recupera o nome do servidor ativo, supondo que a variável de conexão referencie uma <xref:System.Data.SqlClient.SqlConnection> aberta.</span><span class="sxs-lookup"><span data-stu-id="c9d78-122">The following code fragment retrieves the name of the active server, assuming that the connection variable references an open <xref:System.Data.SqlClient.SqlConnection>.</span></span>  
  
 <span data-ttu-id="c9d78-123">Quando ocorre um evento de failover e a conexão é alternada para o servidor espelho, a propriedade **DataSource** é atualizada para refletir o nome do espelho.</span><span class="sxs-lookup"><span data-stu-id="c9d78-123">When a failover event occurs and the connection is switched to the mirror server, the **DataSource** property is updated to reflect the mirror name.</span></span>  
  
```vb  
Dim activeServer As String = connection.DataSource  
```  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a><span data-ttu-id="c9d78-124">Comportamento de espelhamento SqlClient</span><span class="sxs-lookup"><span data-stu-id="c9d78-124">SqlClient Mirroring Behavior</span></span>  
 <span data-ttu-id="c9d78-125">O cliente sempre tenta se conectar ao servidor principal atual.</span><span class="sxs-lookup"><span data-stu-id="c9d78-125">The client always tries to connect to the current principal server.</span></span> <span data-ttu-id="c9d78-126">Se ele falhar, tentará o parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="c9d78-126">If it fails, it tries the failover partner.</span></span> <span data-ttu-id="c9d78-127">Se o banco de dados espelho já tiver sido alternado para a função principal no servidor de parceiro, a conexão será bem-sucedida e o novo mapeamento da entidade de segurança espelho será enviado ao cliente e armazenado em cache para o tempo de vida do <xref:System.AppDomain> de chamada.</span><span class="sxs-lookup"><span data-stu-id="c9d78-127">If the mirror database has already been switched to the principal role on the partner server, the connection succeeds and the new principal-mirror mapping is sent to the client and cached for the lifetime of the calling <xref:System.AppDomain>.</span></span> <span data-ttu-id="c9d78-128">Ele não é armazenado no armazenamento persistente e não está disponível para conexões subsequentes em um **AppDomain** ou processo diferente.</span><span class="sxs-lookup"><span data-stu-id="c9d78-128">It is not stored in persistent storage and is not available for subsequent connections in a different **AppDomain** or process.</span></span> <span data-ttu-id="c9d78-129">No entanto, ele está disponível para conexões subsequentes dentro do mesmo **AppDomain**.</span><span class="sxs-lookup"><span data-stu-id="c9d78-129">However, it is available for subsequent connections within the same **AppDomain**.</span></span> <span data-ttu-id="c9d78-130">Observe que outro **AppDomain** ou processo em execução no mesmo ou em um computador diferente sempre tem seu pool de conexões e essas conexões não são redefinidas.</span><span class="sxs-lookup"><span data-stu-id="c9d78-130">Note that another **AppDomain** or process running on the same or a different computer always has its pool of connections, and those connections are not reset.</span></span> <span data-ttu-id="c9d78-131">Nesse caso, se o banco de dados primário ficar inativo, cada processo ou **AppDomain** falhará uma vez, e o pool será limpo automaticamente.</span><span class="sxs-lookup"><span data-stu-id="c9d78-131">In that case, if the primary database goes down, each process or **AppDomain** fails once, and the pool is automatically cleared.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c9d78-132">O suporte a espelhamento no servidor é configurado em cada banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c9d78-132">Mirroring support on the server is configured on a per-database basis.</span></span> <span data-ttu-id="c9d78-133">Se as operações de manipulação de dados forem executadas em outros bancos de dados não incluídos no conjunto de entidade de segurança/espelho, usando nomes com várias partes ou alterando o banco de dados atual, as alterações feitas a esses outros bancos de dados não serão propagadas no caso de falha.</span><span class="sxs-lookup"><span data-stu-id="c9d78-133">If data manipulation operations are executed against other databases not included in the principal/mirror set, either by using multipart names or by changing the current database, the changes to these other databases do not propagate in the event of failure.</span></span> <span data-ttu-id="c9d78-134">Nenhum erro é gerado quando os dados são modificados em um banco de dados que não está espelhado.</span><span class="sxs-lookup"><span data-stu-id="c9d78-134">No error is generated when data is modified in a database that is not mirrored.</span></span> <span data-ttu-id="c9d78-135">O desenvolvedor deve avaliar o impacto possível dessas operações.</span><span class="sxs-lookup"><span data-stu-id="c9d78-135">The developer must evaluate the possible impact of such operations.</span></span>  
  
## <a name="database-mirroring-resources"></a><span data-ttu-id="c9d78-136">Recursos de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="c9d78-136">Database Mirroring Resources</span></span>  
 <span data-ttu-id="c9d78-137">Para obter a documentação conceitual e informações sobre como configurar, implantar e administrar o espelhamento, consulte os recursos a seguir na documentação SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c9d78-137">For conceptual documentation and information on configuring, deploying and administering mirroring, see the following resources in SQL Server documentation.</span></span>  
  
|<span data-ttu-id="c9d78-138">Recurso</span><span class="sxs-lookup"><span data-stu-id="c9d78-138">Resource</span></span>|<span data-ttu-id="c9d78-139">Descrição</span><span class="sxs-lookup"><span data-stu-id="c9d78-139">Description</span></span>|  
|--------------|-----------------|  
|[<span data-ttu-id="c9d78-140">Espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="c9d78-140">Database Mirroring</span></span>](/sql/database-engine/database-mirroring/database-mirroring-sql-server)|<span data-ttu-id="c9d78-141">Descreve como configurar o espelhamento no SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c9d78-141">Describes how to set up and configure mirroring in SQL Server.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="c9d78-142">Consulte também</span><span class="sxs-lookup"><span data-stu-id="c9d78-142">See also</span></span>

- <span data-ttu-id="c9d78-143">[ADO.NET Overview](../ado-net-overview.md) (Visão geral do ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="c9d78-143">[ADO.NET Overview](../ado-net-overview.md)</span></span>
