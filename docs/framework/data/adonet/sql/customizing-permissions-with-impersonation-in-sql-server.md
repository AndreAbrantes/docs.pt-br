---
title: Personalizando permissões com representação no SQL Server
ms.date: 03/30/2017
ms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1
ms.openlocfilehash: dd7fb4c94c5a0a9bca0cd36b8d76864158072d4e
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/23/2019
ms.locfileid: "61877897"
---
# <a name="customizing-permissions-with-impersonation-in-sql-server"></a><span data-ttu-id="bfcde-102">Personalizando permissões com representação no SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-102">Customizing Permissions with Impersonation in SQL Server</span></span>
<span data-ttu-id="bfcde-103">Muitos aplicativos usam procedimentos armazenados para acessar os dados, dependendo do encadeamento de propriedade para restringir o acesso a tabelas base.</span><span class="sxs-lookup"><span data-stu-id="bfcde-103">Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.</span></span> <span data-ttu-id="bfcde-104">Você pode conceder permissões EXECUTE em procedimentos armazenados, revogando ou negando permissões nas tabelas base.</span><span class="sxs-lookup"><span data-stu-id="bfcde-104">You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.</span></span> <span data-ttu-id="bfcde-105">O SQL Server não verifica as permissões do chamador se o procedimento armazenado e as tabelas têm o mesmo proprietário.</span><span class="sxs-lookup"><span data-stu-id="bfcde-105">SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.</span></span> <span data-ttu-id="bfcde-106">No entanto, o encadeamento de propriedades não funcionará se os objetos tiverem proprietários diferentes ou no caso de SQL dinâmico.</span><span class="sxs-lookup"><span data-stu-id="bfcde-106">However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.</span></span>  
  
 <span data-ttu-id="bfcde-107">Você pode usar a cláusula EXECUTE AS em um procedimento armazenado quando o chamador não tiver permissões nos objetos de banco de dados referenciados.</span><span class="sxs-lookup"><span data-stu-id="bfcde-107">You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.</span></span> <span data-ttu-id="bfcde-108">O efeito da cláusula EXECUTE AS é que o contexto de execução é alternado para o usuário do proxy.</span><span class="sxs-lookup"><span data-stu-id="bfcde-108">The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.</span></span> <span data-ttu-id="bfcde-109">Qualquer código, assim como as chamadas para os procedimentos armazenados ou gatilhos aninhados, é executado sob o contexto de segurança do usuário do proxy.</span><span class="sxs-lookup"><span data-stu-id="bfcde-109">All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.</span></span> <span data-ttu-id="bfcde-110">O contexto de execução é revertido para o chamador original somente após a execução do procedimento ou quando uma instrução REVERT for emitida.</span><span class="sxs-lookup"><span data-stu-id="bfcde-110">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
## <a name="context-switching-with-the-execute-as-statement"></a><span data-ttu-id="bfcde-111">Alternância de contexto com a instrução EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="bfcde-111">Context Switching with the EXECUTE AS Statement</span></span>  
 <span data-ttu-id="bfcde-112">A instrução EXECUTE AS do Transact-SQL permite a troca do contexto de execução de uma instrução representando outro logon ou usuário do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="bfcde-112">The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.</span></span> <span data-ttu-id="bfcde-113">Essa é uma técnica útil para testar consultas e procedimentos como outro usuário.</span><span class="sxs-lookup"><span data-stu-id="bfcde-113">This is a useful technique for testing queries and procedures as another user.</span></span>  
  
```  
EXECUTE AS LOGIN = 'loginName';  
EXECUTE AS USER = 'userName';  
```  
  
 <span data-ttu-id="bfcde-114">Você deve ter permissões IMPERSONATE no logon ou usuário que você está representando.</span><span class="sxs-lookup"><span data-stu-id="bfcde-114">You must have IMPERSONATE permissions on the login or user you are impersonating.</span></span> <span data-ttu-id="bfcde-115">Essa permissão é implícita para `sysadmin` para todos os bancos de dados e os membros de função `db_owner` nos bancos de dados que eles possuem.</span><span class="sxs-lookup"><span data-stu-id="bfcde-115">This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.</span></span>  
  
## <a name="granting-permissions-with-the-execute-as-clause"></a><span data-ttu-id="bfcde-116">Concedendo permissões com a cláusula EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="bfcde-116">Granting Permissions with the EXECUTE AS Clause</span></span>  
 <span data-ttu-id="bfcde-117">Você pode usar a cláusula EXECUTE AS no cabeçalho da definição de um procedimento armazenado, gatilho, ou uma função definida pelo usuário (com exceção das funções com valor de tabela embutida).</span><span class="sxs-lookup"><span data-stu-id="bfcde-117">You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).</span></span> <span data-ttu-id="bfcde-118">Isso faz o procedimento ser executado no contexto do nome de usuário ou palavra-chave especificada na cláusula EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="bfcde-118">This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="bfcde-119">Você pode criar um usuário de proxy no banco de dados que não seja mapeado para um logon, permitindo apenas as permissões necessárias sobre os objetos acessados pelo procedimento.</span><span class="sxs-lookup"><span data-stu-id="bfcde-119">You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.</span></span> <span data-ttu-id="bfcde-120">Apenas o usuário do proxy especificado na cláusula EXECUTE AS deve ter permissões em todos os objetos acessados pelo módulo.</span><span class="sxs-lookup"><span data-stu-id="bfcde-120">Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="bfcde-121">Algumas ações, como TRUNCATE TABLE, não têm permissões concessíveis.</span><span class="sxs-lookup"><span data-stu-id="bfcde-121">Some actions, such as TRUNCATE TABLE, do not have grantable permissions.</span></span> <span data-ttu-id="bfcde-122">Incorporando a instrução dentro de um procedimento e especificando um usuário de proxy que tenha permissões ALTER TABLE, você pode estender as permissões para truncar a tabela para chamadores que têm somente as permissões EXECUTE no procedimento.</span><span class="sxs-lookup"><span data-stu-id="bfcde-122">By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.</span></span>  
  
 <span data-ttu-id="bfcde-123">O contexto especificado na cláusula EXECUTE AS é válido para a duração do procedimento, inclusive procedimentos aninhados e gatilhos.</span><span class="sxs-lookup"><span data-stu-id="bfcde-123">The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.</span></span> <span data-ttu-id="bfcde-124">O contexto será revertido para o chamador quando a execução estiver concluída ou a instrução REVERT for emitida.</span><span class="sxs-lookup"><span data-stu-id="bfcde-124">Context reverts to the caller when execution is complete or the REVERT statement is issued.</span></span>  
  
 <span data-ttu-id="bfcde-125">Há três etapas envolvidas no uso da cláusula EXECUTE AS em um procedimento.</span><span class="sxs-lookup"><span data-stu-id="bfcde-125">There are three steps involved in using the EXECUTE AS clause in a procedure.</span></span>  
  
1. <span data-ttu-id="bfcde-126">Crie um usuário de proxy no banco de dados que não seja mapeado para um logon.</span><span class="sxs-lookup"><span data-stu-id="bfcde-126">Create a proxy user in the database that is not mapped to a login.</span></span> <span data-ttu-id="bfcde-127">Isso não é obrigatório, mas ajuda a gerenciar permissões.</span><span class="sxs-lookup"><span data-stu-id="bfcde-127">This is not required, but it helps when managing permissions.</span></span>  
  
```  
CREATE USER proxyUser WITHOUT LOGIN  
```  
  
1. <span data-ttu-id="bfcde-128">Conceda ao usuário de proxy as permissões necessárias.</span><span class="sxs-lookup"><span data-stu-id="bfcde-128">Grant the proxy user the necessary permissions.</span></span>  
  
2. <span data-ttu-id="bfcde-129">Adicione a cláusula EXECUTE AS no procedimento armazenado ou função definida pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="bfcde-129">Add the EXECUTE AS clause to the stored procedure or user-defined function.</span></span>  
  
```  
CREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  
```  
  
> [!NOTE]
>  <span data-ttu-id="bfcde-130">Os aplicativos que exigem a auditoria podem ser interrompidos porque o contexto de segurança original do chamador não é retido.</span><span class="sxs-lookup"><span data-stu-id="bfcde-130">Applications that require auditing can break because the original security context of the caller is not retained.</span></span> <span data-ttu-id="bfcde-131">As funções internas que retornam a identidade do usuário atual, como SESSION_USER, USER ou USER_NAME retornarão o usuário associado com a cláusula EXECUTE AS, não o chamador original.</span><span class="sxs-lookup"><span data-stu-id="bfcde-131">Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.</span></span>  
  
### <a name="using-execute-as-with-revert"></a><span data-ttu-id="bfcde-132">Usando EXECUTE AS com REVERT</span><span class="sxs-lookup"><span data-stu-id="bfcde-132">Using EXECUTE AS with REVERT</span></span>  
 <span data-ttu-id="bfcde-133">Você pode usar a instrução REVERT do Transact-SQL para reverter para o contexto da execução original.</span><span class="sxs-lookup"><span data-stu-id="bfcde-133">You can use the Transact-SQL REVERT statement to revert to the original execution context.</span></span>  
  
 <span data-ttu-id="bfcde-134">A cláusula opcional WITH NO REVERT COOKIE = @variableName, permite que você alternar o contexto de execução para o chamador se o @variableName variável contém o valor correto.</span><span class="sxs-lookup"><span data-stu-id="bfcde-134">The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value.</span></span> <span data-ttu-id="bfcde-135">Isso permite a troca do contexto de execução de volta para o chamador em ambientes em que o pool de conexões é usado.</span><span class="sxs-lookup"><span data-stu-id="bfcde-135">This allows you to switch the execution context back to the caller in environments where connection pooling is used.</span></span> <span data-ttu-id="bfcde-136">Porque o valor de @variableName é conhecido apenas pelo chamador de EXECUTE AS instrução, o chamador pode garantir que o contexto de execução não pode ser alterado pelo usuário final que invocar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="bfcde-136">Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.</span></span> <span data-ttu-id="bfcde-137">Quando a conexão é fechada, ela será retornada para o pool.</span><span class="sxs-lookup"><span data-stu-id="bfcde-137">When the connection is closed, it is returned to the pool.</span></span> <span data-ttu-id="bfcde-138">Para obter mais informações sobre conexão pooling no ADO.NET, consulte [Pooling de Conexão do SQL Server (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="bfcde-138">For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span></span>  
  
### <a name="specifying-the-execution-context"></a><span data-ttu-id="bfcde-139">Especificando o contexto de execução</span><span class="sxs-lookup"><span data-stu-id="bfcde-139">Specifying the Execution Context</span></span>  
 <span data-ttu-id="bfcde-140">Além de especificar um usuário, você também poderá usar EXECUTE AS com qualquer uma das palavras-chave a seguir.</span><span class="sxs-lookup"><span data-stu-id="bfcde-140">In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.</span></span>  
  
-   <span data-ttu-id="bfcde-141">CALLER.</span><span class="sxs-lookup"><span data-stu-id="bfcde-141">CALLER.</span></span> <span data-ttu-id="bfcde-142">Executar como CALLER é o padrão; se nenhuma outra opção for especificada, o procedimento será executado no contexto de segurança do chamador.</span><span class="sxs-lookup"><span data-stu-id="bfcde-142">Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.</span></span>  
  
-   <span data-ttu-id="bfcde-143">OWNER.</span><span class="sxs-lookup"><span data-stu-id="bfcde-143">OWNER.</span></span> <span data-ttu-id="bfcde-144">Executar como OWNER executa o procedimento no contexto do proprietário do procedimento.</span><span class="sxs-lookup"><span data-stu-id="bfcde-144">Executing as OWNER executes the procedure in the context of the procedure owner.</span></span> <span data-ttu-id="bfcde-145">Se o procedimento for criado em um esquema de propriedade do `dbo` ou pelo proprietário do banco de dados, o procedimento será executado com permissões ilimitadas.</span><span class="sxs-lookup"><span data-stu-id="bfcde-145">If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.</span></span>  
  
-   <span data-ttu-id="bfcde-146">SELF.</span><span class="sxs-lookup"><span data-stu-id="bfcde-146">SELF.</span></span> <span data-ttu-id="bfcde-147">Executar como SELF executa no contexto de segurança do criador do procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="bfcde-147">Executing as SELF executes in the security context of the creator of the stored procedure.</span></span> <span data-ttu-id="bfcde-148">Isso é equivalente a executar como usuário especificado, onde o usuário especificado é a pessoa que cria ou altera o procedimento.</span><span class="sxs-lookup"><span data-stu-id="bfcde-148">This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bfcde-149">Consulte também</span><span class="sxs-lookup"><span data-stu-id="bfcde-149">See also</span></span>

- <span data-ttu-id="bfcde-150">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md) (Protegendo aplicativos ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="bfcde-150">[Securing ADO.NET Applications](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)</span></span>
- [<span data-ttu-id="bfcde-151">Visão geral de segurança do SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-151">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="bfcde-152">Cenários de segurança do aplicativo no SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-152">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="bfcde-153">Gerenciando permissões com procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-153">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="bfcde-154">Escrevendo SQL dinâmico seguro no SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-154">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="bfcde-155">Assinando procedimentos armazenados no SQL Server</span><span class="sxs-lookup"><span data-stu-id="bfcde-155">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="bfcde-156">Modificando dados com procedimentos armazenados</span><span class="sxs-lookup"><span data-stu-id="bfcde-156">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)
- <span data-ttu-id="bfcde-157">[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917) (Central de desenvolvedores do DataSet e de provedores gerenciados do ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="bfcde-157">[ADO.NET Managed Providers and DataSet Developer Center](https://go.microsoft.com/fwlink/?LinkId=217917)</span></span>
