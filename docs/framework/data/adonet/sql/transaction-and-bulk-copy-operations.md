---
title: Operações de transação e de cópia em massa
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: 27fafc0ef45b80eddd993229f52d119b40b4956f
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91155426"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="8fb9b-102">Operações de transação e de cópia em massa</span><span class="sxs-lookup"><span data-stu-id="8fb9b-102">Transaction and Bulk Copy Operations</span></span>

<span data-ttu-id="8fb9b-103">Operações de cópia em massa podem ser executadas como operações isoladas ou como parte de uma transação de várias etapas.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="8fb9b-104">Essa última opção permite executar mais de uma operação de cópia em massa dentro da mesma transação, bem como executar outras operações de banco de dados (como inserções, atualizações e exclusões), podendo ainda confirmar ou reverter toda a transação.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="8fb9b-105">Por padrão, uma operação de cópia em massa é executada como uma operação isolada.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="8fb9b-106">A operação de cópia em massa ocorre de forma não transacionada, sem a oportunidade de revertê-la novamente.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="8fb9b-107">Se você precisar reverter toda ou parte da cópia em massa quando ocorrer um erro, poderá usar uma <xref:System.Data.SqlClient.SqlBulkCopy> transação gerenciada, executar a operação de cópia em massa dentro de uma transação existente ou ser inscrito em um **System. Transactions** <xref:System.Transactions.Transaction> .</span><span class="sxs-lookup"><span data-stu-id="8fb9b-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="8fb9b-108">Executando uma operação não transacionada de cópia em massa</span><span class="sxs-lookup"><span data-stu-id="8fb9b-108">Performing a Non-transacted Bulk Copy Operation</span></span>  

 <span data-ttu-id="8fb9b-109">O aplicativo de Console a seguir mostra o que acontece quando uma operação de cópia em massa não transacionada encontra um erro na operação.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="8fb9b-110">No exemplo, cada tabela de origem e cada tabela de destino incluem uma coluna `Identity` denominada **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="8fb9b-111">O código prepara primeiro a tabela de destino excluindo todas as linhas e, em seguida, inserindo uma única linha cuja **ProductID** é conhecida por existir na tabela de origem.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="8fb9b-112">Por padrão, um novo valor para a coluna `Identity` é gerado na tabela de destino para cada linha adicionada.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="8fb9b-113">Neste exemplo, uma opção é definida quando a conexão é aberta, o que força o processo de carregamento em massa a usar os valores de `Identity` da tabela de origem.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="8fb9b-114">A operação de cópia em massa é executada com a propriedade <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> definida como 10.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="8fb9b-115">Quando a operação encontra a linha inválida, uma exceção é lançada.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="8fb9b-116">Neste primeiro exemplo, a operação de cópia em massa é não transacionada.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="8fb9b-117">Todos os lotes copiados até o ponto do erro são confirmados; o lote que contém a chave duplicada é revertido e a operação de cópia em massa é interrompida antes de processar todos os outros lotes.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="8fb9b-118">Este exemplo não será executado a menos que você tenha criado as tabelas de trabalho conforme descrito em [configuração de exemplo de cópia em massa](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="8fb9b-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="8fb9b-119">Esse código é fornecido para demonstrar a sintaxe para usar somente **SqlBulkCopy**.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="8fb9b-120">Se as tabelas de origem e destino estiverem localizadas na mesma instância do SQL Server, será mais fácil e mais rápido usar uma instrução `INSERT … SELECT` do Transact-SQL para copiar os dados.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="8fb9b-121">Executando uma operação dedicada de cópia em massa em uma transação</span><span class="sxs-lookup"><span data-stu-id="8fb9b-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  

 <span data-ttu-id="8fb9b-122">Por padrão, uma operação de cópia em massa é sua própria transação.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="8fb9b-123">Quando quiser executar uma operação de cópia em massa dedicada, crie uma instância do <xref:System.Data.SqlClient.SqlBulkCopy> com uma cadeia de conexão ou use um objeto <xref:System.Data.SqlClient.SqlConnection> existente sem uma transação ativa.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="8fb9b-124">Em cada cenário, a operação de cópia em massa cria e, em seguida, confirma ou reverte a transação.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="8fb9b-125">Você pode especificar explicitamente a opção <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> no construtor de classe <xref:System.Data.SqlClient.SqlBulkCopy> para explicitamente fazer com que uma operação de cópia em massa seja executada em sua própria transação, fazendo com que cada lote da operação de cópia em massa seja executado dentro de uma transação separada.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="8fb9b-126">Como lotes diferentes são executados em diferentes transações, se ocorrer um erro durante a operação de cópia em massa, todas as linhas no lote atual serão revertidas, mas as linhas de lotes anteriores permanecerão no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="8fb9b-127">O aplicativo de console a seguir é semelhante ao exemplo anterior, com uma exceção: neste exemplo, a operação de cópia em massa gerencia suas próprias transações.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="8fb9b-128">Todos os lotes copiados até o ponto do erro são confirmados; o lote que contém a chave duplicada é revertido e a operação de cópia em massa é interrompida antes de processar todos os outros lotes.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="8fb9b-129">Este exemplo não será executado a menos que você tenha criado as tabelas de trabalho conforme descrito em [configuração de exemplo de cópia em massa](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="8fb9b-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="8fb9b-130">Esse código é fornecido para demonstrar a sintaxe para usar somente **SqlBulkCopy**.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="8fb9b-131">Se as tabelas de origem e destino estiverem localizadas na mesma instância do SQL Server, será mais fácil e mais rápido usar uma instrução `INSERT … SELECT` do Transact-SQL para copiar os dados.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="8fb9b-132">Usando transações existentes</span><span class="sxs-lookup"><span data-stu-id="8fb9b-132">Using Existing Transactions</span></span>  

 <span data-ttu-id="8fb9b-133">É possível especificar um objeto <xref:System.Data.SqlClient.SqlTransaction> existente como um parâmetro em um construtor <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="8fb9b-134">Nessa situação, a operação de cópia em massa é executada em uma transação existente e nenhuma alteração é feita ao estado da transação (isto é, ela não é confirmada nem anulada).</span><span class="sxs-lookup"><span data-stu-id="8fb9b-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="8fb9b-135">Isso permite que um aplicativo inclua a operação de cópia em massa em uma transação com outras operações de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="8fb9b-136">No entanto, uma exceção será lançada caso você não especifique um objeto <xref:System.Data.SqlClient.SqlTransaction>, passe uma referência nula e caso a conexão tenha uma transação ativa.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="8fb9b-137">Caso precise reverter toda a operação de cópia em massa porque ocorreu um erro. Ou caso a cópia em massa deva ser executada como parte de um processo maior que pode ser revertido, será possível fornecer um objeto <xref:System.Data.SqlClient.SqlTransaction> para o construtor <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="8fb9b-138">O aplicativo de console a seguir é semelhante para o primeiro exemplo (não transacionado), com uma exceção: neste exemplo, a operação de cópia em massa está incluída em uma transação maior, externa.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="8fb9b-139">Quando ocorre o erro de violação de chave primária, a transação inteira é revertida e nenhuma linha é adicionada à tabela de destino.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="8fb9b-140">Este exemplo não será executado a menos que você tenha criado as tabelas de trabalho conforme descrito em [configuração de exemplo de cópia em massa](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="8fb9b-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="8fb9b-141">Esse código é fornecido para demonstrar a sintaxe para usar somente **SqlBulkCopy**.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="8fb9b-142">Se as tabelas de origem e destino estiverem localizadas na mesma instância do SQL Server, será mais fácil e mais rápido usar uma instrução `INSERT … SELECT` do Transact-SQL para copiar os dados.</span><span class="sxs-lookup"><span data-stu-id="8fb9b-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="8fb9b-143">Confira também</span><span class="sxs-lookup"><span data-stu-id="8fb9b-143">See also</span></span>

- [<span data-ttu-id="8fb9b-144">Operações de cópia em massa no SQL Server</span><span class="sxs-lookup"><span data-stu-id="8fb9b-144">Bulk Copy Operations in SQL Server</span></span>](bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="8fb9b-145">Visão geral do ADO.NET</span><span class="sxs-lookup"><span data-stu-id="8fb9b-145">ADO.NET Overview</span></span>](../ado-net-overview.md)
