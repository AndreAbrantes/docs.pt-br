---
title: Pool de conexões SQL Server
description: Saiba como o ADO.NET minimiza o custo de abrir conexões usando SQL Server pooling de conexão, o que reduz a sobrecarga para novas conexões.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 96d9e9a7e43f71dc30bd2d7a7f1902238941d471
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91156349"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="da682-103">Pool de conexões do SQL Server (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="da682-103">SQL Server Connection Pooling (ADO.NET)</span></span>

<span data-ttu-id="da682-104">Para se conectar a um servidor de banco de dados, existem, normalmente, várias etapas demoradas.</span><span class="sxs-lookup"><span data-stu-id="da682-104">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="da682-105">Um canal físico, como um soquete ou um pipe nomeado, deve ser estabelecido, o handshake inicial com o servidor deve ocorrer, informações de cadeia de conexão devem ser analisadas, a conexão deve ser autenticada pelo servidor, verificações devem ser realizadas para a inscrição na transação atual e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="da682-105">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="da682-106">Na prática, a maioria dos aplicativos usa apenas uma ou algumas configurações diferentes para conexões.</span><span class="sxs-lookup"><span data-stu-id="da682-106">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="da682-107">Isso significa que, durante a execução do aplicativo, muitas conexões idênticas serão abertas e fechadas repetidamente.</span><span class="sxs-lookup"><span data-stu-id="da682-107">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="da682-108">Para minimizar o custo de abertura de conexões, o ADO.NET usa uma técnica de otimização chamada *pooling de conexão*.</span><span class="sxs-lookup"><span data-stu-id="da682-108">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="da682-109">O pool de conexões reduz o número de vezes que as novas conexões devem ser abertas.</span><span class="sxs-lookup"><span data-stu-id="da682-109">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="da682-110">O *Pooler* mantém a propriedade da conexão física.</span><span class="sxs-lookup"><span data-stu-id="da682-110">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="da682-111">Para gerenciar as conexões, ele mantém um conjunto de conexões ativas para cada configuração de conexão específica.</span><span class="sxs-lookup"><span data-stu-id="da682-111">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="da682-112">Sempre que um usuário chama `Open` em uma conexão, o pooler procura uma conexão disponível no pool.</span><span class="sxs-lookup"><span data-stu-id="da682-112">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="da682-113">Se houver uma conexão agrupada disponível, ele retornará essa conexão para o chamador, em vez de abrir uma nova conexão.</span><span class="sxs-lookup"><span data-stu-id="da682-113">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="da682-114">Quando o aplicativo chama `Close` na conexão, o pooler retorna essa chamada para o conjunto de conexões ativas agrupadas, em vez de fechar a conexão.</span><span class="sxs-lookup"><span data-stu-id="da682-114">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="da682-115">Depois de retornada ao pool, a conexão está pronta para ser reutilizada na próxima chamada `Open`.</span><span class="sxs-lookup"><span data-stu-id="da682-115">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="da682-116">Somente conexões com a mesma configuração podem ser agrupadas.</span><span class="sxs-lookup"><span data-stu-id="da682-116">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="da682-117">O ADO.NET mantém vários pools ao mesmo tempo, um para cada configuração.</span><span class="sxs-lookup"><span data-stu-id="da682-117">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="da682-118">As conexões são separadas em pools pela cadeia de conexão e, quando o modo de segurança integrada é usado, pela identidade do Windows.</span><span class="sxs-lookup"><span data-stu-id="da682-118">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="da682-119">As conexões também são agrupadas conforme estejam ou não inscritas em uma transação.</span><span class="sxs-lookup"><span data-stu-id="da682-119">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="da682-120">Ao usar o <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, a instância <xref:System.Data.SqlClient.SqlCredential> afeta o pool de conexões.</span><span class="sxs-lookup"><span data-stu-id="da682-120">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="da682-121">As instâncias diferentes de <xref:System.Data.SqlClient.SqlCredential> usarão pools de conexões diferentes, mesmo se a identificação do usuário e a senha forem iguais.</span><span class="sxs-lookup"><span data-stu-id="da682-121">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="da682-122">O pooling de conexões pode melhorar significativamente o desempenho e a escalabilidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="da682-122">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="da682-123">Por padrão, o pool de conexões está habilitado em ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="da682-123">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="da682-124">A menos que você explicitamente o desabilite, o pooler otimiza as conexões quando elas são abertas e fechadas no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="da682-124">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="da682-125">Você também pode fornecer vários modificadores de cadeias de conexão para controlar o comportamento do pool de conexões.</span><span class="sxs-lookup"><span data-stu-id="da682-125">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="da682-126">Para obter mais informações, consulte "Controlando o pool de conexões com palavras-chave de cadeias de conexão" posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="da682-126">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="da682-127">Quando o pool de conexões é habilitado e ocorre um erro de tempo limite ou outro erro de logon, é gerada uma exceção e as tentativas subsequentes de conexão falham nos próximos cinco segundos, "o período bloqueio".</span><span class="sxs-lookup"><span data-stu-id="da682-127">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="da682-128">Se o aplicativo tentar se conectar dentro do período de bloqueio, a primeira exceção será gerada novamente.</span><span class="sxs-lookup"><span data-stu-id="da682-128">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="da682-129">Falhas subsequentes após o término do período de bloqueio resultarão em novos períodos de bloqueio, duas vezes maior que o anterior, até um máximo de um minuto.</span><span class="sxs-lookup"><span data-stu-id="da682-129">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="da682-130">Criação e atribuição de pools</span><span class="sxs-lookup"><span data-stu-id="da682-130">Pool Creation and Assignment</span></span>  

 <span data-ttu-id="da682-131">Quando uma conexão é aberta pela primeira vez, um pool de conexões é criado com base em um algoritmo compatível exato que associa o pool à cadeia de conexão na conexão.</span><span class="sxs-lookup"><span data-stu-id="da682-131">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="da682-132">Cada pool de conexões é associado a uma cadeia de conexão distinta.</span><span class="sxs-lookup"><span data-stu-id="da682-132">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="da682-133">Se a cadeia de conexão não for uma correspondência exata de um pool existente, quando uma nova conexão for aberta, um novo pool será criado.</span><span class="sxs-lookup"><span data-stu-id="da682-133">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="da682-134">As conexões são agrupadas por processo, por domínio do aplicativo, por cadeia de conexão e, quando o modo de segurança integrada é usado, pela identidade do Windows.</span><span class="sxs-lookup"><span data-stu-id="da682-134">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="da682-135">As cadeias de conexão também devem ser uma correspondência exata; as palavras-chave fornecidas em uma ordem diferente para a mesma conexão serão agrupadas separadamente.</span><span class="sxs-lookup"><span data-stu-id="da682-135">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="da682-136">No exemplo de C# a seguir, três novos objetos <xref:System.Data.SqlClient.SqlConnection> são criados, mas apenas dois pools de conexões são necessários para gerenciá-los.</span><span class="sxs-lookup"><span data-stu-id="da682-136">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="da682-137">Observe que a primeira e a segunda cadeias de conexão diferem pelo valor atribuído para `Initial Catalog`.</span><span class="sxs-lookup"><span data-stu-id="da682-137">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="da682-138">Se `MinPoolSize` não for especificado na cadeia de conexão, nem estiver especificado como zero, as conexões no pool serão fechadas após um período de inatividade.</span><span class="sxs-lookup"><span data-stu-id="da682-138">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="da682-139">Entretanto, se o `MinPoolSize` especificado for maior que zero, o pool de conexões não será destruído até que o `AppDomain` seja descarregado e o processo concluído.</span><span class="sxs-lookup"><span data-stu-id="da682-139">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="da682-140">A manutenção de pools inativos ou vazios envolve sobrecarga mínima do sistema.</span><span class="sxs-lookup"><span data-stu-id="da682-140">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="da682-141">O pool é limpo automaticamente quando ocorre um erro fatal, como um failover.</span><span class="sxs-lookup"><span data-stu-id="da682-141">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="da682-142">Adicionando conexões</span><span class="sxs-lookup"><span data-stu-id="da682-142">Adding Connections</span></span>  

 <span data-ttu-id="da682-143">Um pool de conexões é criado para cada cadeia de conexão exclusiva.</span><span class="sxs-lookup"><span data-stu-id="da682-143">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="da682-144">Quando um pool é criado, vários objetos de conexão são criados e adicionados ao pool para que o requisito de tamanho mínimo de pool seja atendido.</span><span class="sxs-lookup"><span data-stu-id="da682-144">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="da682-145">As conexões são adicionadas ao pool quando necessário, até o tamanho máximo de pool especificado (100 é o padrão).</span><span class="sxs-lookup"><span data-stu-id="da682-145">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="da682-146">As conexões são retornadas para o pool quando fechadas ou descartadas.</span><span class="sxs-lookup"><span data-stu-id="da682-146">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="da682-147">Quando um objeto <xref:System.Data.SqlClient.SqlConnection> é solicitado, ele é obtido do pool caso haja uma conexão útil disponível.</span><span class="sxs-lookup"><span data-stu-id="da682-147">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="da682-148">Para ser útil, uma conexão não deve estar em uso, deve ter um contexto de transação correspondente (ou não deve estar associada a nenhum contexto de transação) e deve ter um vínculo válido com o servidor.</span><span class="sxs-lookup"><span data-stu-id="da682-148">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="da682-149">O pool de conexões atende às solicitações de conexões realocando-as à medida que são retornadas ao pool.</span><span class="sxs-lookup"><span data-stu-id="da682-149">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="da682-150">Se o tamanho máximo de pool for atingido e nenhuma conexão útil estiver disponível, a solicitação será colocada na fila.</span><span class="sxs-lookup"><span data-stu-id="da682-150">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="da682-151">Em seguida, o pooler tentará recuperar conexões até que o tempo limite seja esgotado (o padrão é de 15 segundos).</span><span class="sxs-lookup"><span data-stu-id="da682-151">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="da682-152">Se o pooler não puder atender à solicitação antes que se esgote o tempo limite de conexão, uma exceção será gerada.</span><span class="sxs-lookup"><span data-stu-id="da682-152">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="da682-153">É altamente recomendável sempre fechar a conexão quando você terminar de usá-la para que a conexão seja retornada ao pool.</span><span class="sxs-lookup"><span data-stu-id="da682-153">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="da682-154">Você pode fazer isso usando os `Close` métodos ou `Dispose` do `Connection` objeto ou abrindo todas as conexões dentro de uma `using` instrução em C#, ou uma `Using` instrução em Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="da682-154">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="da682-155">As conexões que não são fechadas explicitamente não podem ser adicionadas nem retornadas ao pool.</span><span class="sxs-lookup"><span data-stu-id="da682-155">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="da682-156">Para obter mais informações, consulte [usando a instrução](../../../csharp/language-reference/keywords/using-statement.md) ou [como: descartar um recurso do sistema](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) para Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="da682-156">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="da682-157">Não chame `Close` nem `Dispose` em um objeto `Connection`, em um `DataReader` nem em nenhum outro objeto gerenciado no método `Finalize` de sua classe.</span><span class="sxs-lookup"><span data-stu-id="da682-157">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="da682-158">Em um finalizador, libere somente recursos não gerenciados que sua classe possui diretamente.</span><span class="sxs-lookup"><span data-stu-id="da682-158">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="da682-159">Se a classe não tiver nenhum recurso não gerenciado, não inclua um método `Finalize` em sua definição de classe.</span><span class="sxs-lookup"><span data-stu-id="da682-159">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="da682-160">Para obter mais informações, consulte [coleta de lixo](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="da682-160">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="da682-161">Para obter mais informações sobre os eventos associados às conexões de abertura e fechamento, consulte classe de evento [Audit login](/sql/relational-databases/event-classes/audit-login-event-class) e [auditoria logout Event](/sql/relational-databases/event-classes/audit-logout-event-class) na documentação do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="da682-161">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="da682-162">Removendo conexões</span><span class="sxs-lookup"><span data-stu-id="da682-162">Removing Connections</span></span>  

 <span data-ttu-id="da682-163">O pool de conexões remove uma conexão do pool após ele ficar ocioso por aproximadamente 4-8 minutos, ou se o Pooler detectar que a conexão com o servidor foi severa.</span><span class="sxs-lookup"><span data-stu-id="da682-163">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="da682-164">Observe que uma conexão interrompida pode ser detectada somente após uma tentativa de comunicação com o servidor.</span><span class="sxs-lookup"><span data-stu-id="da682-164">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="da682-165">Se for encontrada uma conexão que não esteja mais conectada ao servidor, ela será marcada como inválida.</span><span class="sxs-lookup"><span data-stu-id="da682-165">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="da682-166">As conexões inválidas são removidas de pool de conexões somente quando são fechadas ou recuperadas.</span><span class="sxs-lookup"><span data-stu-id="da682-166">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="da682-167">Se uma conexão com um servidor desapareceu, ela pode ser removida do pool mesmo se o pooler de conexões não tiver detectado a conexão interrompida e a marcado como inválida.</span><span class="sxs-lookup"><span data-stu-id="da682-167">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="da682-168">Este é o caso porque a sobrecarga de verificar se a conexão ainda é válida eliminaria os benefícios de se ter um pooler, provocando outra viagem de ida e volta ao servidor.</span><span class="sxs-lookup"><span data-stu-id="da682-168">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="da682-169">Quando isso ocorrer, a primeira tentativa de usar a conexão detectará que a conexão foi interrompida e uma exceção será gerada.</span><span class="sxs-lookup"><span data-stu-id="da682-169">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="da682-170">Limpando o pool</span><span class="sxs-lookup"><span data-stu-id="da682-170">Clearing the Pool</span></span>  

 <span data-ttu-id="da682-171">O ADO.NET 2,0 introduziu dois novos métodos para limpar o pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> e <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A> .</span><span class="sxs-lookup"><span data-stu-id="da682-171">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="da682-172">`ClearAllPools` limpa os pools de conexões de um provedor específico e `ClearPool` limpa o pool de conexões associado a uma conexão específica.</span><span class="sxs-lookup"><span data-stu-id="da682-172">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="da682-173">Se houver conexões em uso no momento da chamada, elas serão devidamente marcadas.</span><span class="sxs-lookup"><span data-stu-id="da682-173">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="da682-174">Quando fechadas, serão descartadas, em vez de retornadas ao pool.</span><span class="sxs-lookup"><span data-stu-id="da682-174">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="da682-175">Suporte a transações</span><span class="sxs-lookup"><span data-stu-id="da682-175">Transaction Support</span></span>  

 <span data-ttu-id="da682-176">As conexões são removidas do pool e atribuídas com base no contexto de transação.</span><span class="sxs-lookup"><span data-stu-id="da682-176">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="da682-177">A menos que `Enlist=false` seja especificado na cadeia de conexão, o pool de conexões verifica se a conexão está inscrita no contexto de <xref:System.Transactions.Transaction.Current%2A>.</span><span class="sxs-lookup"><span data-stu-id="da682-177">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="da682-178">Quando uma conexão é fechada e retornada ao pool com uma transação `System.Transactions` inscrita, ela é reservada para que a próxima solicitação desse pool de conexões com a mesma transação `System.Transactions` seja retornada à mesma conexão, se disponível.</span><span class="sxs-lookup"><span data-stu-id="da682-178">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="da682-179">Se uma solicitação desse tipo for emitida, e não houver conexões agrupadas disponíveis, uma conexão será removida da parte não transacionada do pool e depois inscrita.</span><span class="sxs-lookup"><span data-stu-id="da682-179">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="da682-180">Se não houver conexões disponíveis em nenhuma área do pool, uma nova conexão será criada e inscrita.</span><span class="sxs-lookup"><span data-stu-id="da682-180">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="da682-181">Quando uma conexão for fechada, ela será retornada ao pool e à subdivisão apropriada com base no contexto de transação.</span><span class="sxs-lookup"><span data-stu-id="da682-181">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="da682-182">Portanto, é possível fechar a conexão sem gerar erros, mesmo que uma transação distribuída ainda esteja pendente.</span><span class="sxs-lookup"><span data-stu-id="da682-182">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="da682-183">Isso permite confirmar ou anular a transação distribuída posteriormente.</span><span class="sxs-lookup"><span data-stu-id="da682-183">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="da682-184">Controlando o pool de conexões com palavras-chave de cadeias de conexão</span><span class="sxs-lookup"><span data-stu-id="da682-184">Controlling Connection Pooling with Connection String Keywords</span></span>  

 <span data-ttu-id="da682-185">A propriedade `ConnectionString` do objeto <xref:System.Data.SqlClient.SqlConnection> dá suporte a pares chave-valor de cadeias de conexão que podem ser usados para ajustar o comportamento da lógica do pool de conexões.</span><span class="sxs-lookup"><span data-stu-id="da682-185">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="da682-186">Para obter mais informações, consulte <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="da682-186">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="da682-187">Fragmentação de pool</span><span class="sxs-lookup"><span data-stu-id="da682-187">Pool Fragmentation</span></span>  

 <span data-ttu-id="da682-188">A fragmentação de pool é um problema comum em muitos aplicativos da Web nos quais o aplicativo pode criar um grande número de pools que não são liberados até que o processo seja encerrado.</span><span class="sxs-lookup"><span data-stu-id="da682-188">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="da682-189">Isso deixa um grande número de conexões abertas e consumindo memória, o que resulta em baixo desempenho.</span><span class="sxs-lookup"><span data-stu-id="da682-189">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="da682-190">Fragmentação de pool devido à segurança integrada</span><span class="sxs-lookup"><span data-stu-id="da682-190">Pool Fragmentation Due to Integrated Security</span></span>  

 <span data-ttu-id="da682-191">As conexões são agrupadas de acordo com a cadeia de conexão e a identidade do usuário.</span><span class="sxs-lookup"><span data-stu-id="da682-191">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="da682-192">Portanto, se você usa autenticação Básica ou autenticação do Windows no site, bem como um logon de segurança integrada, pode obter um pool por usuário.</span><span class="sxs-lookup"><span data-stu-id="da682-192">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="da682-193">Embora isso melhore o desempenho de solicitações de bancos de dados subsequentes feitas por um único usuário, esse usuário não pode aproveitar as vantagens das conexões feitas por outros usuários.</span><span class="sxs-lookup"><span data-stu-id="da682-193">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="da682-194">Isso também resulta em, pelo menos, uma conexão por usuário com o servidor de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="da682-194">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="da682-195">Trata-se de um efeito colateral de uma arquitetura de aplicativo Web específico que os desenvolvedores devem ponderar em relação aos requisitos de segurança e auditoria.</span><span class="sxs-lookup"><span data-stu-id="da682-195">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="da682-196">Fragmentação de pool devido a vários bancos de dados</span><span class="sxs-lookup"><span data-stu-id="da682-196">Pool Fragmentation Due to Many Databases</span></span>  

 <span data-ttu-id="da682-197">Vários provedores de serviços de Internet hospedam vários sites em um único servidor.</span><span class="sxs-lookup"><span data-stu-id="da682-197">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="da682-198">Eles podem usar um único banco de dados para confirmar um logon de autenticação de formulários e para abrir uma conexão com um banco de dados específico desse usuário ou grupo de usuários.</span><span class="sxs-lookup"><span data-stu-id="da682-198">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="da682-199">A conexão com o banco de dados de autenticação é agrupada e usada por todos.</span><span class="sxs-lookup"><span data-stu-id="da682-199">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="da682-200">Entretanto, há um pool de conexões separado para cada banco de dados, que aumenta o número de conexões com o servidor.</span><span class="sxs-lookup"><span data-stu-id="da682-200">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="da682-201">Trata-se também de um efeito colateral de projeto do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="da682-201">This is also a side-effect of the application design.</span></span> <span data-ttu-id="da682-202">Existe uma forma relativamente simples de evitar esse efeito colateral sem comprometer a segurança quando você se conectar ao SQL Server.</span><span class="sxs-lookup"><span data-stu-id="da682-202">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="da682-203">Em vez de se conectar a um banco de dados separado para cada usuário ou grupo, conecte-se ao mesmo banco de dados no servidor e execute a instrução Transact-SQL USE para alternar para o banco de dados desejado.</span><span class="sxs-lookup"><span data-stu-id="da682-203">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="da682-204">O fragmento de código a seguir demonstra como criar uma conexão inicial com o banco de dados `master` e depois alternar para o banco de dados desejado especificado na variável da cadeia de caracteres `databaseName`.</span><span class="sxs-lookup"><span data-stu-id="da682-204">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="da682-205">Funções de aplicativo e pool de conexões</span><span class="sxs-lookup"><span data-stu-id="da682-205">Application Roles and Connection Pooling</span></span>  

 <span data-ttu-id="da682-206">Depois de ativada uma função de aplicativo do SQL Server ao chamar o procedimento armazenado do sistema `sp_setapprole`, o contexto de segurança dessa conexão não pode ser redefinido.</span><span class="sxs-lookup"><span data-stu-id="da682-206">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="da682-207">Entretanto, se o pool estiver habilitado, a conexão será retornada a ele e ocorrerá um erro quando a conexão agrupada for reutilizada.</span><span class="sxs-lookup"><span data-stu-id="da682-207">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="da682-208">Para obter mais informações, consulte o artigo da base de dados de conhecimento, "[erros de função de aplicativo SQL com OLE DB pooling de recursos](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)".</span><span class="sxs-lookup"><span data-stu-id="da682-208">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="da682-209">Alternativas a funções de aplicativo</span><span class="sxs-lookup"><span data-stu-id="da682-209">Application Role Alternatives</span></span>  

 <span data-ttu-id="da682-210">Recomendamos que você aproveite todas as vantagens dos mecanismos de segurança que podem ser usados no lugar de funções de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="da682-210">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="da682-211">Para obter mais informações, consulte [criando funções de aplicativo no SQL Server](./sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="da682-211">For more information, see [Creating Application Roles in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="da682-212">Confira também</span><span class="sxs-lookup"><span data-stu-id="da682-212">See also</span></span>

- [<span data-ttu-id="da682-213">Pool de conexões</span><span class="sxs-lookup"><span data-stu-id="da682-213">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="da682-214">SQL Server e ADO.NET</span><span class="sxs-lookup"><span data-stu-id="da682-214">SQL Server and ADO.NET</span></span>](./sql/index.md)
- [<span data-ttu-id="da682-215">Contadores de desempenho</span><span class="sxs-lookup"><span data-stu-id="da682-215">Performance Counters</span></span>](performance-counters.md)
- [<span data-ttu-id="da682-216">Visão geral do ADO.NET</span><span class="sxs-lookup"><span data-stu-id="da682-216">ADO.NET Overview</span></span>](ado-net-overview.md)
