---
title: Consultas compiladas (LINQ to Entities)
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 8025ba1d-29c7-4407-841b-d5a3bed40b7a
ms.openlocfilehash: f3270147f0cf38a646efac603f058173daa78547
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/15/2020
ms.locfileid: "90541129"
---
# <a name="compiled-queries--linq-to-entities"></a><span data-ttu-id="8f2a5-102">Consultas compiladas (LINQ to Entities)</span><span class="sxs-lookup"><span data-stu-id="8f2a5-102">Compiled queries  (LINQ to Entities)</span></span>

<span data-ttu-id="8f2a5-103">Quando um aplicativo executa muitas vezes consultas estruturalmente similares no Entity Framework, geralmente é possível melhorar o desempenho compilando a consulta uma única vez e executando-a várias vezes com parâmetros diferentes.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-103">When you have an application that executes structurally similar queries many times in the Entity Framework, you can frequently increase performance by compiling the query one time and executing it several times with different parameters.</span></span> <span data-ttu-id="8f2a5-104">Por exemplo, um aplicativo pode precisar recuperar todos os clientes de uma cidade específica; a cidade é especificada em runtime pelo usuário em um formulário.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-104">For example, an application might have to retrieve all the customers in a particular city; the city is specified at runtime by the user in a form.</span></span> <span data-ttu-id="8f2a5-105">LINQ to Entities dá suporte ao uso de consultas compiladas para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-105">LINQ to Entities supports using compiled queries for this purpose.</span></span>  
  
 <span data-ttu-id="8f2a5-106">A partir do .NET Framework 4,5, as consultas LINQ são armazenadas em cache automaticamente.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-106">Starting with .NET Framework 4.5, LINQ queries are cached automatically.</span></span> <span data-ttu-id="8f2a5-107">No entanto, você ainda pode usar consultas LINQ para reduzir esse custo em execuções posteriores e consultas compiladas podem ser mais eficientes que consultas LINQ que são automaticamente armazenadas em cache.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-107">However, you can still use compiled LINQ queries to reduce this cost in later executions and compiled queries can be more efficient than LINQ queries that are automatically cached.</span></span> <span data-ttu-id="8f2a5-108">LINQ to Entities consultas que aplicam o `Enumerable.Contains` operador a coleções na memória não são armazenadas em cache automaticamente.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-108">LINQ to Entities queries that apply the `Enumerable.Contains` operator to in-memory collections are not automatically cached.</span></span> <span data-ttu-id="8f2a5-109">Além disso, a parametrização de coleções na memória em consultas do LINQ compiladas não é permitida.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-109">Also, parameterizing in-memory collections in compiled LINQ queries is not allowed.</span></span>  
  
 <span data-ttu-id="8f2a5-110">A classe <xref:System.Data.Objects.CompiledQuery> fornece a compilação e o cache de consultas para reutilização.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-110">The <xref:System.Data.Objects.CompiledQuery> class provides compilation and caching of queries for reuse.</span></span> <span data-ttu-id="8f2a5-111">Conceitualmente, essa classe contém um método <xref:System.Data.Objects.CompiledQuery> de `Compile` com várias sobrecargas.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-111">Conceptually, this class contains a <xref:System.Data.Objects.CompiledQuery>'s `Compile` method with several overloads.</span></span> <span data-ttu-id="8f2a5-112">Chame o método `Compile` para criar um novo delegado para representar a consulta compilada.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-112">Call the `Compile` method to create a new delegate to represent the compiled query.</span></span> <span data-ttu-id="8f2a5-113">Os métodos `Compile`, com <xref:System.Data.Objects.ObjectContext> e valores de parâmetro, retornam um delegado que gera um resultado (como uma instância <xref:System.Linq.IQueryable%601>).</span><span class="sxs-lookup"><span data-stu-id="8f2a5-113">The `Compile` methods, provided with a <xref:System.Data.Objects.ObjectContext> and parameter values, return a delegate that produces some result (such as an <xref:System.Linq.IQueryable%601> instance).</span></span> <span data-ttu-id="8f2a5-114">A consulta é compilada somente uma vez durante a primeira execução.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-114">The query compiles once during only the first execution.</span></span> <span data-ttu-id="8f2a5-115">As opções de mesclagem definidas para a consulta no momento da compilação não podem ser alteradas posteriormente.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-115">The merge options set for the query at the time of the compilation cannot be changed later.</span></span> <span data-ttu-id="8f2a5-116">Depois que a consulta é compilada, você só pode fornecer parâmetros de tipo primitivo, mas não pode substituir partes da consulta que alterariam o SQL gerado.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-116">Once the query is compiled, you can only supply parameters of primitive type but you cannot replace parts of the query that would change the generated SQL.</span></span> <span data-ttu-id="8f2a5-117">Para obter mais informações, consulte [Opções de mesclagem do EF e consultas compiladas](/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries).</span><span class="sxs-lookup"><span data-stu-id="8f2a5-117">For more information, see [EF Merge Options and Compiled Queries](/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries).</span></span>
  
 <span data-ttu-id="8f2a5-118">A LINQ to Entities expressão de consulta que <xref:System.Data.Objects.CompiledQuery> o `Compile` método do compila é representada por um dos `Func` delegados genéricos, como <xref:System.Func%605> .</span><span class="sxs-lookup"><span data-stu-id="8f2a5-118">The LINQ to Entities query expression that the <xref:System.Data.Objects.CompiledQuery>'s `Compile` method compiles is represented by one of the generic `Func` delegates, such as <xref:System.Func%605>.</span></span> <span data-ttu-id="8f2a5-119">No máximo, a expressão de consulta pode encapsular um parâmetro `ObjectContext`, um parâmetro de retorno e 16 parâmetros de consulta.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-119">At most, the query expression can encapsulate an `ObjectContext` parameter, a return parameter, and 16 query parameters.</span></span> <span data-ttu-id="8f2a5-120">Se mais de 16 parâmetros de consulta forem necessários, você poderá criar uma estrutura cujas propriedades representem parâmetros de consulta.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-120">If more than 16 query parameters are required, you can create a structure whose properties represent query parameters.</span></span> <span data-ttu-id="8f2a5-121">Será possível usar, então, as propriedades da estrutura na expressão de consulta depois de definir as propriedades.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-121">You can then use the properties on the structure in the query expression after you set the properties.</span></span>  
  
## <a name="example-1"></a><span data-ttu-id="8f2a5-122">Exemplo 1</span><span class="sxs-lookup"><span data-stu-id="8f2a5-122">Example 1</span></span>  
 <span data-ttu-id="8f2a5-123">O exemplo a seguir compila e invoca uma consulta que aceita um parâmetro de entrada <xref:System.Decimal> e retorna uma sequência de pedidos em que o total devido é maior ou igual a US$ 200:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-123">The following example compiles and then invokes a query that accepts a <xref:System.Decimal> input parameter and returns a sequence of orders where the total due is greater than or equal to $200.00:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query 2](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery2)]
 [!code-vb[DP L2E Conceptual Examples - compiled query2](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery2)]  
  
## <a name="example-2"></a><span data-ttu-id="8f2a5-124">Exemplo 2</span><span class="sxs-lookup"><span data-stu-id="8f2a5-124">Example 2</span></span>  
 <span data-ttu-id="8f2a5-125">O exemplo a seguir compila e invoca uma consulta que retorna uma instância <xref:System.Data.Objects.ObjectQuery%601>:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-125">The following example compiles and then invokes a query that returns an <xref:System.Data.Objects.ObjectQuery%601> instance:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query1_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery1_mq)]
 [!code-vb[DP L2E Conceptual Examples - compiled query1_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery1_mq)]  
  
## <a name="example-3"></a><span data-ttu-id="8f2a5-126">Exemplo 3</span><span class="sxs-lookup"><span data-stu-id="8f2a5-126">Example 3</span></span>  
 <span data-ttu-id="8f2a5-127">O exemplo a seguir compila e invoca uma consulta que retorna a média dos preços na lista de produtos como um valor <xref:System.Decimal>:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-127">The following example compiles and then invokes a query that returns the average of the product list prices as a <xref:System.Decimal> value:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query3_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery3_mq)]
 [!code-vb[DP L2E Conceptual Examples - compiled query3_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery3_mq)]  
  
## <a name="example-4"></a><span data-ttu-id="8f2a5-128">Exemplo 4</span><span class="sxs-lookup"><span data-stu-id="8f2a5-128">Example 4</span></span>  
 <span data-ttu-id="8f2a5-129">O exemplo a seguir compila e, em seguida, invoca uma consulta que aceita um <xref:System.String> parâmetro de entrada e, em seguida, retorna um `Contact` cujo endereço de email começa com a cadeia de caracteres especificada:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-129">The following example compiles and then invokes a query that accepts a <xref:System.String> input parameter and then returns a `Contact` whose email address starts with the specified string:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query4_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery4_mq)]
 [!code-vb[DP L2E Conceptual Examples - compiled query4_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery4_mq)]  
  
## <a name="example-5"></a><span data-ttu-id="8f2a5-130">Exemplo 5</span><span class="sxs-lookup"><span data-stu-id="8f2a5-130">Example 5</span></span>  
 <span data-ttu-id="8f2a5-131">O exemplo a seguir compila e invoca uma consulta que aceita os parâmetros de entrada <xref:System.DateTime> e <xref:System.Decimal> e retorna uma sequência de pedidos em que a data do pedido é posterior a 8 de março de 2003 e o total devido é menor que US$ 300:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-131">The following example compiles and then invokes a query that accepts <xref:System.DateTime> and <xref:System.Decimal> input parameters and returns a sequence of orders where the order date is later than March 8, 2003, and the total due is less than $300.00:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query5](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery5)]
 [!code-vb[DP L2E Conceptual Examples - compiled query5](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery5)]  
  
## <a name="example-6"></a><span data-ttu-id="8f2a5-132">Exemplo 6</span><span class="sxs-lookup"><span data-stu-id="8f2a5-132">Example 6</span></span>  
 <span data-ttu-id="8f2a5-133">O exemplo a seguir compila e invoca uma consulta que aceita um parâmetro de entrada <xref:System.DateTime> e retorna uma sequência de pedidos em que a data do pedido é posterior a 8 de março de 2004.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-133">The following example compiles and then invokes a query that accepts a <xref:System.DateTime> input parameter and returns a sequence of orders where the order date is later than March 8, 2004.</span></span> <span data-ttu-id="8f2a5-134">Essa consulta retorna informações de pedidos como uma sequência de tipos anônimos.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-134">This query returns the order information as a sequence of anonymous types.</span></span> <span data-ttu-id="8f2a5-135">Os tipos anônimos são inferidos pelo compilador. Assim, não é possível especificar parâmetros de tipo no método <xref:System.Data.Objects.CompiledQuery> de `Compile` e o tipo é definido na própria consulta.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-135">Anonymous types are inferred by the compiler, so you cannot specify type parameters in the <xref:System.Data.Objects.CompiledQuery>'s `Compile` method and the type is defined in the query itself.</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query6](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery6)]
 [!code-vb[DP L2E Conceptual Examples - compiled query6](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery6)]  
  
## <a name="example-7"></a><span data-ttu-id="8f2a5-136">Exemplo 7</span><span class="sxs-lookup"><span data-stu-id="8f2a5-136">Example 7</span></span>  
 <span data-ttu-id="8f2a5-137">O exemplo a seguir compila e invoca uma consulta que aceita um parâmetro de entrada de estrutura definida pelo usuário e retorna uma sequência de pedidos.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-137">The following example compiles and then invokes a query that accepts a user-defined structure input parameter and returns a sequence of orders.</span></span> <span data-ttu-id="8f2a5-138">A estrutura define a data de início, a data de término e os parâmetros de consulta do total devido, e a consulta retorna os pedidos enviados entre 3 de março e 8 de março de 2003 com um total devido maior que US$ 700.</span><span class="sxs-lookup"><span data-stu-id="8f2a5-138">The structure defines start date, end date, and total due query parameters, and the query returns orders shipped between March 3 and March 8, 2003 with a total due greater than $700.00.</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - compiled query7](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery7)]
 [!code-vb[DP L2E Conceptual Examples - compiled query7](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery7)]  
  
 <span data-ttu-id="8f2a5-139">A estrutura que define os parâmetros de consulta:</span><span class="sxs-lookup"><span data-stu-id="8f2a5-139">The structure that defines the query parameters:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples - MyParamsStruct](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#myparamsstruct)]
 [!code-vb[DP L2E Conceptual Examples - MyParamsStruct](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#myparamsstruct)]  
  
## <a name="see-also"></a><span data-ttu-id="8f2a5-140">Confira também</span><span class="sxs-lookup"><span data-stu-id="8f2a5-140">See also</span></span>

- [<span data-ttu-id="8f2a5-141">ADO.NET Entity Framework</span><span class="sxs-lookup"><span data-stu-id="8f2a5-141">ADO.NET Entity Framework</span></span>](../index.md)
- [<span data-ttu-id="8f2a5-142">LINQ to Entities</span><span class="sxs-lookup"><span data-stu-id="8f2a5-142">LINQ to Entities</span></span>](linq-to-entities.md)
- [<span data-ttu-id="8f2a5-143">Opções de mesclagem do EF e consultas compiladas</span><span class="sxs-lookup"><span data-stu-id="8f2a5-143">EF Merge Options and Compiled Queries</span></span>](/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries)
