---
title: Executar a recuperação
description: Execute a recuperação no .NET. O Gerenciador de recursos ajuda a resolver inalistas de transações duráveis reinscrevendo o participante da transação após a falha do recurso.
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: 23ee6cb194dbafb08ef7acf17aad25a57b57045e
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91186725"
---
# <a name="performing-recovery"></a><span data-ttu-id="7f10e-104">Executar a recuperação</span><span class="sxs-lookup"><span data-stu-id="7f10e-104">Performing Recovery</span></span>

<span data-ttu-id="7f10e-105">Um Gerenciador de recursos facilita a resolução de inscrições duráveis em uma transação, reenlisting o participante de transação após falha de recurso.</span><span class="sxs-lookup"><span data-stu-id="7f10e-105">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="7f10e-106">O processo de recuperação</span><span class="sxs-lookup"><span data-stu-id="7f10e-106">The Recovery Process</span></span>  

 <span data-ttu-id="7f10e-107">Para inscrever permanentemente um recurso (descrito por uma implementação do <xref:System.Transactions.IEnlistmentNotification> interface) que podem ser mais tarde qualificadas para a recuperação, você deve chamar o <xref:System.Transactions.Transaction.EnlistDurable%2A> método.</span><span class="sxs-lookup"><span data-stu-id="7f10e-107">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="7f10e-108">Além disso, você deve fornecer o <xref:System.Transactions.Transaction.EnlistDurable%2A> método com um identificador de Gerenciador de recursos (um <xref:System.Guid>) que é usado para rotular consistentemente o participante da transação em caso de falha de recurso.</span><span class="sxs-lookup"><span data-stu-id="7f10e-108">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="7f10e-109">Por esse motivo, o <xref:System.Guid> que é fornecido para a chamada de inscrição inicial deve ser idêntico ao parâmetro *resourceManagerIdentifier* na <xref:System.Transactions.TransactionManager.Reenlist%2A> chamada durante a recuperação.</span><span class="sxs-lookup"><span data-stu-id="7f10e-109">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="7f10e-110">Caso contrário, <xref:System.Transactions.TransactionException> é lançada.</span><span class="sxs-lookup"><span data-stu-id="7f10e-110">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="7f10e-111">Para obter mais informações sobre inlistagens duráveis, consulte [Inscrevendo recursos como participantes em uma transação](enlisting-resources-as-participants-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="7f10e-111">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="7f10e-112">Na fase de preparação (fase 1) do protocolo 2PC, quando sua implementação de um Gerenciador de recursos duráveis recebe o <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notificação, ele deve registrar seu registro de preparação durante essa fase.</span><span class="sxs-lookup"><span data-stu-id="7f10e-112">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="7f10e-113">O registro deve conter todas as informações necessárias concluir a transação na confirmação.</span><span class="sxs-lookup"><span data-stu-id="7f10e-113">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="7f10e-114">O registro de preparação pode ser acessado posteriormente durante a recuperação, recuperando a <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> Propriedade do retorno de chamada *PreparingEnlistment* .</span><span class="sxs-lookup"><span data-stu-id="7f10e-114">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="7f10e-115">O log de registro não precisa ser executada dentro do <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> método como o Gerenciador de recursos pode fazer isso em um thread de trabalho.</span><span class="sxs-lookup"><span data-stu-id="7f10e-115">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="7f10e-116">O processo de recuperação consiste em duas etapas a seguir:</span><span class="sxs-lookup"><span data-stu-id="7f10e-116">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="7f10e-117">Etapa 1 - ReEnlist</span><span class="sxs-lookup"><span data-stu-id="7f10e-117">Step 1 - ReEnlist</span></span>  

 <span data-ttu-id="7f10e-118">O Gerenciador de recursos examina o registro de informações de preparação para cada inscrição está em dúvida.</span><span class="sxs-lookup"><span data-stu-id="7f10e-118">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="7f10e-119">Isso é feito examinando o <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> propriedade do <xref:System.Transactions.PreparingEnlistment> retorno de chamada, que é passado para o Gerenciador de recursos do <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notificação durante a fase 1.</span><span class="sxs-lookup"><span data-stu-id="7f10e-119">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="7f10e-120">Para cada essa inscrição examina, ele chama <xref:System.Transactions.TransactionManager.Reenlist%2A> no Gerenciador de transações.</span><span class="sxs-lookup"><span data-stu-id="7f10e-120">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="7f10e-121">Esse método passa exclusivo <xref:System.Guid> que identifica o Gerenciador de recursos, bem como informações da inscrição em uma matriz de bytes.</span><span class="sxs-lookup"><span data-stu-id="7f10e-121">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="7f10e-122">Um novo <xref:System.Transactions.Enlistment> objeto é retornado.</span><span class="sxs-lookup"><span data-stu-id="7f10e-122">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="7f10e-123">Se na nova inscrição falhará com uma exceção, o Gerenciador de recursos será necessário tentar novamente mais tarde.</span><span class="sxs-lookup"><span data-stu-id="7f10e-123">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="7f10e-124">Você só deve chamar o <xref:System.Transactions.TransactionManager.Reenlist%2A> método quando reinicia um Gerenciador de recursos de falha.</span><span class="sxs-lookup"><span data-stu-id="7f10e-124">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="7f10e-125">Além disso, você só deve reinscrevê registradas por um Gerenciador de recursos durante a fase de preparação inicial de protocolo 2PC de transações não resolvidas.</span><span class="sxs-lookup"><span data-stu-id="7f10e-125">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="7f10e-126">Qualquer tentativa de chamar esse método em momentos inválidos pode produzir resultados incorretos.</span><span class="sxs-lookup"><span data-stu-id="7f10e-126">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="7f10e-127">Quando um participante é reenlisted usando esse método, os métodos de fase 2 da <xref:System.Transactions.IEnlistmentNotification> que correspondam ao resultado da transação (isto é, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> ou <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) são chamados conforme apropriado.</span><span class="sxs-lookup"><span data-stu-id="7f10e-127">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="7f10e-128">Etapa 2: concluir a recuperação</span><span class="sxs-lookup"><span data-stu-id="7f10e-128">Step 2 - Completing the recovery</span></span>  

 <span data-ttu-id="7f10e-129">Quando todas as reenlistments forem concluídos, o Gerenciador de recursos chama o <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> método.</span><span class="sxs-lookup"><span data-stu-id="7f10e-129">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="7f10e-130">Esse método conclui a recuperação e informa o Gerenciador de transações que o Gerenciador de recursos tem não mais transações em dúvida.</span><span class="sxs-lookup"><span data-stu-id="7f10e-130">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="7f10e-131">Fazendo isso, o Gerenciador de recursos garante que ele não chamará o <xref:System.Transactions.TransactionManager.Reenlist%2A> método novamente.</span><span class="sxs-lookup"><span data-stu-id="7f10e-131">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="7f10e-132">Um Gerenciador de recursos não é necessário para resolver todas as transações em dúvida antes de inscrever-se em novas transações.</span><span class="sxs-lookup"><span data-stu-id="7f10e-132">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="7f10e-133">A primeira etapa pode ser executada a qualquer momento depois que o Gerenciador de recursos estabelece uma relação com o Gerenciador de transações, mas depois de foi <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> invocado (etapa 2); a etapa 1 não pode ser executada novamente.</span><span class="sxs-lookup"><span data-stu-id="7f10e-133">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="7f10e-134">Etapa 2 pode ser repetida várias vezes sem afetar o resultado das transações.</span><span class="sxs-lookup"><span data-stu-id="7f10e-134">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
