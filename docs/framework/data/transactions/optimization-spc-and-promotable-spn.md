---
title: Otimização usando commit de fase única e notificação de fase única promovível
description: Otimize o desempenho usando a confirmação de fase única e a notificação de fase única promocionaltable. Saiba mais sobre a infraestrutura System. Transactions no .NET.
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141972"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="1c05d-104">Otimização usando commit de fase única e notificação de fase única promovível</span><span class="sxs-lookup"><span data-stu-id="1c05d-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="1c05d-105">Este tópico descreve os mecanismos fornecidos pelo <xref:System.Transactions> infra-estrutura para otimizar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="1c05d-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="1c05d-106">Inscrição de fase única passíveis de promoção</span><span class="sxs-lookup"><span data-stu-id="1c05d-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="1c05d-107">O <xref:System.Transactions> infra-estrutura administrates uma transação dentro de um único domínio de aplicativo que envolve a no máximo um único recurso durável ou vários recursos voláteis.</span><span class="sxs-lookup"><span data-stu-id="1c05d-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="1c05d-108">Como o <xref:System.Transactions> infra-estrutura usa chamadas de domínio apenas intra-aplicativo, ele produz a melhor taxa de transferência e o desempenho.</span><span class="sxs-lookup"><span data-stu-id="1c05d-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="1c05d-109">No entanto, se a transação é fornecida a outro objeto em outro domínio de aplicativo (incluindo entre limites de processo e da máquinas) no mesmo computador, ou se você se inscrever outro gerenciador de recursos duráveis, o <xref:System.Transactions> infra-estrutura aumenta automaticamente a transação a ser gerenciado pelo MSDTC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="1c05d-110">Uma transação gerenciada por MSDTC não é tão em termos de desempenho como um gerenciado pelo <xref:System.Transactions> infra-estrutura.</span><span class="sxs-lookup"><span data-stu-id="1c05d-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="1c05d-111">Para otimizar o desempenho, o <xref:System.Transactions> infra-estrutura fornece o podem ser promovidas única fase de inscrição (PSPE) que permite que um único durável recurso remoto, localizado em um domínio de aplicativo diferente, o processo ou a máquina, participe de um <xref:System.Transactions> transação sem fazer com que ele ser escalonado para uma transação MSDTC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="1c05d-112">Esse Gerenciador de recursos (RM) pode hospedar e "proprietário" de uma transação que posteriormente pode ser escalonada para uma transação distribuída (ou transação MSDTC) se necessário.</span><span class="sxs-lookup"><span data-stu-id="1c05d-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="1c05d-113">Isso reduz a possibilidade de usar o MSDTC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="1c05d-114">O Gerenciador de recursos específico normalmente tem suas próprias transações distribuídas não internas e precisa oferecer suporte a converter essas transações em transações distribuídas em runtime.</span><span class="sxs-lookup"><span data-stu-id="1c05d-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="1c05d-115">Por exemplo, o SQL Server 2005 é tal um Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="1c05d-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="1c05d-116">Nesse caso, o <xref:System.Transactions> infra-estrutura usa uma função de gerenciamento de passivo monitorando apenas a transação para uma necessidade de escalonamento.</span><span class="sxs-lookup"><span data-stu-id="1c05d-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="1c05d-117">Para oferecer suporte a interação entre o <xref:System.Transactions> infra-estrutura e Gerenciador de recursos, o último precisa implementar a interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span><span class="sxs-lookup"><span data-stu-id="1c05d-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="1c05d-118">O <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> método é usado para inscrever um único recurso durável que pode ser escalonado posteriormente.</span><span class="sxs-lookup"><span data-stu-id="1c05d-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="1c05d-119">Esse método garante que a inscrição pode ser escalonada conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="1c05d-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="1c05d-120">Se a inscrição for bem-sucedida, o Gerenciador de recursos cria sua transação interna e o associa a <xref:System.Transactions> transação.</span><span class="sxs-lookup"><span data-stu-id="1c05d-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="1c05d-121">Se a inscrição PSPE falhar, o Gerenciador de recursos em vez disso, deve inscrever usando o <xref:System.Transactions.Transaction.EnlistDurable%2A> método.</span><span class="sxs-lookup"><span data-stu-id="1c05d-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="1c05d-122">Falhas para se inscrever no PSPE podem acontecer quando a transação já for uma transação distribuída ou outro RM já executou uma inscrição de PSPE</span><span class="sxs-lookup"><span data-stu-id="1c05d-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="1c05d-123">Depois de inscrito, chamadas por clientes para confirmar ou anular a <xref:System.Transactions> transação são convertidos em chamadas no Gerenciador de recursos, invocando o <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> método, ou o <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectivamente.</span><span class="sxs-lookup"><span data-stu-id="1c05d-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="1c05d-124">Se o <xref:System.Transactions> transação nunca requer escalonamento, quando a transação é confirmada, o RM recebe um <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notificação.</span><span class="sxs-lookup"><span data-stu-id="1c05d-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="1c05d-125">Em seguida, ele poderá confirmar a transação interna que foi inicialmente criada.</span><span class="sxs-lookup"><span data-stu-id="1c05d-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="1c05d-126">Se o <xref:System.Transactions> transação deverá ser escalonado (por exemplo, para oferecer suporte a vários RMs), <xref:System.Transactions> informa ao Gerenciador de recursos, chamando o <xref:System.Transactions.ITransactionPromoter.Promote%2A> método no <xref:System.Transactions.ITransactionPromoter> interface, da qual o <xref:System.Transactions.IPromotableSinglePhaseNotification> interface deriva.</span><span class="sxs-lookup"><span data-stu-id="1c05d-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="1c05d-127">O Gerenciador de recursos converte a transação interna de uma transação local (que não exigem registro em log) para um objeto de transação que é capaz de participar de uma transação do DTC e associa o trabalho já realizado.</span><span class="sxs-lookup"><span data-stu-id="1c05d-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="1c05d-128">Quando a transação é solicitada a confirmar, o Gerenciador de transações ainda envia o <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notificação para o Gerenciador de recursos, que confirma a transação distribuída que criou durante a expansão.</span><span class="sxs-lookup"><span data-stu-id="1c05d-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="1c05d-129">Os rastreamentos de **TransactionCommitted** (gerados quando uma confirmação é invocada na transação escalonada) contêm a ID de atividade da transação do DTC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="1c05d-130">Para saber mais sobre escalonamento de gerenciamento, confira [escalonamento de gerenciamento de transações](transaction-management-escalation.md).</span><span class="sxs-lookup"><span data-stu-id="1c05d-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="1c05d-131">Cenário de escalonamento de gerenciamento de transações</span><span class="sxs-lookup"><span data-stu-id="1c05d-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="1c05d-132">O cenário a seguir demonstra um escalonamento para uma transação distribuída usando o <xref:System.Data> namespace como o 'proxy' para o Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="1c05d-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="1c05d-133">Este cenário pressupõe que já existe um <xref:System.Data> conexão com o banco de dados, CN1, envolvidos na transação e o aplicativo deseja envolver outro <xref:System.Data> conexão, CN2.</span><span class="sxs-lookup"><span data-stu-id="1c05d-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="1c05d-134">A transação deve ser escalada para o DTC, como uma transação de confirmação de duas fases distribuída completa.</span><span class="sxs-lookup"><span data-stu-id="1c05d-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="1c05d-135">Nesse cenário,</span><span class="sxs-lookup"><span data-stu-id="1c05d-135">In this scenario,</span></span>

1. <span data-ttu-id="1c05d-136">Chamadas de CN1 a <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> método para se inscrever na transação.</span><span class="sxs-lookup"><span data-stu-id="1c05d-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="1c05d-137">Em seguida, a transação é ainda local e não há nenhum inscrições podem ser promovidas na transação, para que o <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> chamada for bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="1c05d-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="1c05d-138">Quando a segunda conexão, CN2 chama <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, a chamada falhará porque não há outra inscrição podem ser promovida envolvidas.</span><span class="sxs-lookup"><span data-stu-id="1c05d-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="1c05d-139">Por isso, CN2 deve obter uma transação do DTC para passá-lo para SQL.</span><span class="sxs-lookup"><span data-stu-id="1c05d-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="1c05d-140">Para fazer isso, ele usa um dos métodos fornecidos pelo <xref:System.Transactions.TransactionInterop> classe para produzir um formato da transação que pode ser determinado para SQL.</span><span class="sxs-lookup"><span data-stu-id="1c05d-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="1c05d-141"><xref:System.Transactions>chama o <xref:System.Transactions.ITransactionPromoter.Promote%2A> método na <xref:System.Transactions.ITransactionPromoter> interface implementada por CN1.</span><span class="sxs-lookup"><span data-stu-id="1c05d-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="1c05d-142">Neste ponto, CN1 aumenta a transação, usando um mecanismo específico para o SQL 2005 e <xref:System.Data>.</span><span class="sxs-lookup"><span data-stu-id="1c05d-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="1c05d-143">O valor de retorno de <xref:System.Transactions.ITransactionPromoter.Promote%2A> método é uma matriz de bytes que contém um token de propagação da transação.</span><span class="sxs-lookup"><span data-stu-id="1c05d-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="1c05d-144"><xref:System.Transactions>usa esse token de propagação para criar uma transação do DTC que pode ser incorporada à transação local.</span><span class="sxs-lookup"><span data-stu-id="1c05d-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="1c05d-145">Neste ponto, CN2 pode usar os dados recebidos de chamar um dos métodos por <xref:System.Transactions.TransactionInterop> para passar a transação para SQL.</span><span class="sxs-lookup"><span data-stu-id="1c05d-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="1c05d-146">Agora, ambos estão inscritos em uma transação distribuída do DTC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="1c05d-147">Otimização de confirmação de fase única</span><span class="sxs-lookup"><span data-stu-id="1c05d-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="1c05d-148">O protocolo de confirmação de fase única é mais eficiente em runtime, como todas as atualizações são realizadas sem qualquer coordenação explícita.</span><span class="sxs-lookup"><span data-stu-id="1c05d-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="1c05d-149">Para tirar proveito dessa otimização, você deve implementar um Gerenciador de recursos usando <xref:System.Transactions.ISinglePhaseNotification> para o recurso de interface e se inscrever em uma transação usando o <xref:System.Transactions.Transaction.EnlistDurable%2A> ou <xref:System.Transactions.Transaction.EnlistVolatile%2A> método.</span><span class="sxs-lookup"><span data-stu-id="1c05d-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="1c05d-150">Especificamente, o parâmetro *Enlistoptions* deve ser igual a <xref:System.Transactions.EnlistmentOptions.None> para garantir que uma única confirmação de fase seja executada.</span><span class="sxs-lookup"><span data-stu-id="1c05d-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="1c05d-151">Como o <xref:System.Transactions.ISinglePhaseNotification> interface deriva de <xref:System.Transactions.IEnlistmentNotification> a interface, se o RM não está qualificado para confirmação de fase única, ele pode ainda receber a fase de duas notificações de confirmação.</span><span class="sxs-lookup"><span data-stu-id="1c05d-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="1c05d-152">Se receber o RM um <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notificação do TM, ele deve tentar fazer o trabalho necessário para confirmar e proporcionalmente informam o Gerenciador de transações se a transação deve ser confirmada ou revertida chamando o <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, ou <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> método o <xref:System.Transactions.SinglePhaseEnlistment> parâmetro.</span><span class="sxs-lookup"><span data-stu-id="1c05d-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="1c05d-153">Uma resposta de <xref:System.Transactions.Enlistment.Done%2A> sobre a inscrição neste estágio implica a semântica de somente leitura.</span><span class="sxs-lookup"><span data-stu-id="1c05d-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="1c05d-154">Portanto, você não deve responder <xref:System.Transactions.Enlistment.Done%2A> além de qualquer um dos outros métodos.</span><span class="sxs-lookup"><span data-stu-id="1c05d-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="1c05d-155">Se houver apenas uma inscrição volátil e nenhuma inscrição durável, a inscrição volátil receberá uma notificação do SPC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="1c05d-156">Se houver qualquer inscrições voláteis e apenas uma inscrição durável, as inscrições voláteis receberão 2PC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="1c05d-157">Quando ele for concluído, a distribuição durável recebe SPC.</span><span class="sxs-lookup"><span data-stu-id="1c05d-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="1c05d-158">Veja também</span><span class="sxs-lookup"><span data-stu-id="1c05d-158">See also</span></span>

- [<span data-ttu-id="1c05d-159">Inscrever recursos como participantes em uma transação</span><span class="sxs-lookup"><span data-stu-id="1c05d-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="1c05d-160">Confirmar uma transação de fase única e de várias fases</span><span class="sxs-lookup"><span data-stu-id="1c05d-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
