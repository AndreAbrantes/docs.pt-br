---
title: Implementar um Gerenciador de recursos
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
caps.latest.revision: "3"
author: Erikre
ms.author: erikre
manager: erikre
ms.openlocfilehash: b72b1bf68fa445a188c327098295d76815a80b16
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/18/2017
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="b5ddd-102">Implementar um Gerenciador de recursos</span><span class="sxs-lookup"><span data-stu-id="b5ddd-102">Implementing a Resource Manager</span></span>
<span data-ttu-id="b5ddd-103">Cada recurso usado em uma transação é gerenciado por um Gerenciador de recursos, as ações são coordenadas por um Gerenciador de transações.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-103">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="b5ddd-104">Gerenciadores de recursos trabalham em cooperação com o Gerenciador de transações para fornecer o aplicativo com uma garantia de atomicidade e isolamento.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-104">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="b5ddd-105">Microsoft SQL Server, filas de mensagens duráveis, tabelas de hash em memória são exemplos de gerenciadores de recursos.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-105">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="b5ddd-106">Um Gerenciador de recursos gerencia dados duráveis ou voláteis.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-106">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="b5ddd-107">A durabilidade (ou o inverso a volatilidade) de um recurso Gerenciador refere-se ao Gerenciador de recursos oferece suporte a recuperação de falhas.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-107">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="b5ddd-108">Se um Gerenciador de recursos oferece suporte à recuperação de falha, ele persiste os dados para o armazenamento durável durante da Fase1 (preparar), de modo que, se o Gerenciador de recursos de ficar inativo, ele pode novamente se inscrever na transação após a recuperação e executar as ações apropriadas com base em notificações recebidas do Gerenciador de transações.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-108">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="b5ddd-109">Em geral, os gerenciadores de recursos voláteis gerenciar recursos voláteis, como uma estrutura de dados na memória (por exemplo, na memória transacionado-hashtable) e gerenciadores de recursos duráveis gerenciar recursos em um repositório de backup mais persistente (por exemplo, um banco de dados cujo armazenamento de backup em disco).</span><span class="sxs-lookup"><span data-stu-id="b5ddd-109">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="b5ddd-110">Em ordem para um recurso para participar de uma transação, ele deve se inscrever na transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="b5ddd-111">O <xref:System.Transactions.Transaction> classe define um conjunto de métodos cujos nomes começam com **Enlist** que fornecem essa funcionalidade.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="b5ddd-112">Os diferentes **Enlist** métodos correspondem a diferentes tipos de inscrição que pode ter um Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="b5ddd-113">Especificamente, você usa o <xref:System.Transactions.Transaction.EnlistVolatile%2A> métodos para recursos voláteis e o <xref:System.Transactions.Transaction.EnlistDurable%2A> método Recursos duráveis.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="b5ddd-114">Para simplificar, depois de decidir se deseja usar o <xref:System.Transactions.Transaction.EnlistDurable%2A> ou <xref:System.Transactions.Transaction.EnlistVolatile%2A> método com base no suporte a durabilidade do recurso, você deve inscrever o recurso para participar de dois a fase de confirmação (2PC), Implementando o <xref:System.Transactions.IEnlistmentNotification> interface para seu Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-114">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="b5ddd-115">Para obter mais informações sobre 2PC, consulte [confirmar uma transação de fase única e de várias fases](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="b5ddd-115">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="b5ddd-116">Inscrevendo, o Gerenciador de recursos garante que ele obtém retornos de chamada do Gerenciador de transações quando a transação é confirmada ou anulada.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-116">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="b5ddd-117">Há uma instância de <xref:System.Transactions.IEnlistmentNotification> por inscrição.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-117">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="b5ddd-118">Normalmente, há uma inscrição por transação, mas um Gerenciador de recursos pode optar por se inscrever várias vezes na mesma transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-118">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="b5ddd-119">Após a inscrição, o Gerenciador de recursos responde às solicitações da transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-119">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="b5ddd-120">Um Gerenciador de recursos duráveis armazena informações suficientes para permitir que ele seja desfeita ou refeita trabalho da transação em recursos que ele gerencia.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-120">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="b5ddd-121">Há várias maneiras de fazer isso. Manter versões dos dados ou manter um log das alterações é duas técnicas comuns.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-121">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="b5ddd-122">Quando o aplicativo confirma a transação, o Gerenciador de transações inicia o protocolo de confirmação de duas fases.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-122">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="b5ddd-123">Primeiro, o Gerenciador de transações solicita cada Gerenciador de recursos listados se ele está preparado para confirmar a transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-123">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="b5ddd-124">O Gerenciador de recursos deve preparar para confirmar — ele se prepara para confirmar ou anular a transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-124">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="b5ddd-125">Durante a fase de preparação, o Gerenciador de recursos duráveis registra os dados antigos e novos em armazenamento estável para que o Gerenciador de recursos pode recuperá-lo mesmo que o sistema falhe.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-125">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="b5ddd-126">Se o Gerenciador de recursos pode preparar, ele informa o Gerenciador de transações seu voto confirmar ou anular a transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-126">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="b5ddd-127">Se o Gerenciador de recursos relatar uma falha na preparação, o Gerenciador de transações envia um comando de reversão para cada Gerenciador de recursos e indica a falha da confirmação ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-127">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="b5ddd-128">Quando preparado, um Gerenciador de recursos deve esperar até obter uma confirmação ou anulação de retorno de chamada do Gerenciador de transações na fase 2.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-128">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="b5ddd-129">Normalmente, o protocolo de preparação e confirmação inteiro é concluída em uma fração de segundo.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-129">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="b5ddd-130">Se houver falhas no sistema ou a comunicação, a notificação de confirmação ou anulação pode não chegar para minutos ou horas.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-130">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="b5ddd-131">Durante esse período, o Gerenciador de recursos está em dúvida sobre o resultado da transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-131">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="b5ddd-132">Ele não sabe se a transação foi confirmada ou anulada.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-132">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="b5ddd-133">Embora o Gerenciador de recursos está em dúvida sobre uma transação, ele mantém os dados modificados, mantendo a transação bloqueada, isolando essas alterações de quaisquer outras transações.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-133">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="b5ddd-134">Quando um Gerenciador de recursos falha, todas as suas transações inscrita são anuladas, exceto aquelas que são preparadas ou confirmadas antes da falha.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-134">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="b5ddd-135">Quando um Gerenciador de recursos durável é reiniciado, reconstrói o estado confirmado os recursos que ele gerencia recuperando as informações de preparação gravadas na fase de preparação, e confirma ou anula essas transações de forma adequada.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-135">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="b5ddd-136">Em resumo, o protocolo de confirmação de duas fases e os gerenciadores de recursos se combinam para realizar transações atômicas e duráveis.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-136">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="b5ddd-137">O <xref:System.Transactions.Transaction> classe também fornece o <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> método para inscrever um podem ser promovidas única fase de inscrição (PSPE).</span><span class="sxs-lookup"><span data-stu-id="b5ddd-137">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="b5ddd-138">Isso permite que um recurso durável manager (RM) para hospedar e "proprietário" de uma transação que posteriormente pode ser escalonada para ser gerenciado pelo MSDTC se necessário.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-138">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="b5ddd-139">Para obter mais informações sobre isso, consulte [otimização usando única fase de confirmação e notificação de fase única passível de promoção](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="b5ddd-139">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="b5ddd-140">Nesta seção</span><span class="sxs-lookup"><span data-stu-id="b5ddd-140">In This Section</span></span>  
 <span data-ttu-id="b5ddd-141">As etapas que geralmente seguidas por um Gerenciador de recursos são descritas nos tópicos a seguir.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-141">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="b5ddd-142">Inscrição de recursos como participantes em uma transação</span><span class="sxs-lookup"><span data-stu-id="b5ddd-142">Enlisting Resources as Participants in a Transaction</span></span>](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="b5ddd-143">Descreve como um recurso durável ou voláteis pode se inscrever em uma transação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-143">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="b5ddd-144">Confirmar uma transação de fase única e de várias fases</span><span class="sxs-lookup"><span data-stu-id="b5ddd-144">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](../../../../docs/framework/data/transactions/committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="b5ddd-145">Descreve como um Gerenciador de recursos responde para confirmar a notificação e preparar a confirmação.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-145">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="b5ddd-146">Executar recuperação</span><span class="sxs-lookup"><span data-stu-id="b5ddd-146">Performing Recovery</span></span>](../../../../docs/framework/data/transactions/performing-recovery.md)  
  
 <span data-ttu-id="b5ddd-147">Descreve como um Gerenciador de recursos durável recupera de falha.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-147">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="b5ddd-148">Níveis de confiança de segurança de acesso a recursos</span><span class="sxs-lookup"><span data-stu-id="b5ddd-148">Security Trust Levels in Accessing Resources</span></span>](../../../../docs/framework/data/transactions/security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="b5ddd-149">Descreve como os três níveis de confiança para System. Transactions restringem o acesso os tipos de recursos que <xref:System.Transactions> expõe.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-149">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="b5ddd-150">Otimização de uso único de fase de confirmação e notificação de fase única passível de promoção</span><span class="sxs-lookup"><span data-stu-id="b5ddd-150">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](../../../../docs/framework/data/transactions/optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="b5ddd-151">Descreve as práticas de otimização disponíveis para as implementações de gerenciadores de recursos.</span><span class="sxs-lookup"><span data-stu-id="b5ddd-151">Describes optimization practices available to implementations of resource managers.</span></span>
