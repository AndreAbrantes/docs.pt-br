---
title: Implementando uma transação implícita, usando o escopo da transação
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 49d1706a-1e0c-4c85-9704-75c908372eb9
ms.openlocfilehash: ae0c729444b3ccb154481e65a094d29d68541793
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54645841"
---
# <a name="implementing-an-implicit-transaction-using-transaction-scope"></a><span data-ttu-id="dbbf3-102">Implementando uma transação implícita, usando o escopo da transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-102">Implementing an Implicit Transaction using Transaction Scope</span></span>
<span data-ttu-id="dbbf3-103">O <xref:System.Transactions.TransactionScope> classe fornece uma maneira simples para marcar um bloco de código como participar de uma transação, sem a necessidade de interagir com a própria transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-103">The <xref:System.Transactions.TransactionScope> class provides a simple way to mark a block of code as participating in a transaction, without requiring you to interact with the transaction itself.</span></span> <span data-ttu-id="dbbf3-104">Selecione um escopo de transação e gerenciar a transação ambiente automaticamente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-104">A transaction scope can select and manage the ambient transaction automatically.</span></span> <span data-ttu-id="dbbf3-105">Devido à sua facilidade de uso e a eficiência, é recomendável que você use o <xref:System.Transactions.TransactionScope> classe ao desenvolver um aplicativo de transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-105">Due to its ease of use and efficiency, it is recommended that you use the <xref:System.Transactions.TransactionScope> class when developing a transaction application.</span></span>  
  
 <span data-ttu-id="dbbf3-106">Além disso, você não precisa conseguir recursos explicitamente com a transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-106">In addition, you do not need to enlist resources explicitly with the transaction.</span></span> <span data-ttu-id="dbbf3-107">Qualquer <xref:System.Transactions> Gerenciador de recursos (como o SQL Server 2005) pode detectar a existência de uma transação ambiente criada pelo escopo e inscrever-se automaticamente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-107">Any <xref:System.Transactions> resource manager (such as SQL Server 2005) can detect the existence of an ambient transaction created by the scope and automatically enlist.</span></span>  
  
## <a name="creating-a-transaction-scope"></a><span data-ttu-id="dbbf3-108">Criar um escopo de transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-108">Creating a transaction scope</span></span>  
 <span data-ttu-id="dbbf3-109">O exemplo a seguir mostra um uso simple do <xref:System.Transactions.TransactionScope> classe.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-109">The following sample shows a simple usage of the <xref:System.Transactions.TransactionScope> class.</span></span>  
  
 [!code-csharp[TransactionScope#1](../../../../samples/snippets/csharp/VS_Snippets_Remoting/TransactionScope/cs/ScopeWithSQL.cs#1)]
 [!code-vb[TransactionScope#1](../../../../samples/snippets/visualbasic/VS_Snippets_Remoting/TransactionScope/vb/ScopeWithSQL.vb#1)]  
  
 <span data-ttu-id="dbbf3-110">O escopo da transação é iniciado depois que você criar um novo <xref:System.Transactions.TransactionScope> objeto.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-110">The transaction scope is started once you create a new <xref:System.Transactions.TransactionScope> object.</span></span>  <span data-ttu-id="dbbf3-111">Conforme ilustrado no exemplo de código, é recomendável que você crie escopos com um **usando** instrução.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-111">As illustrated in the code sample, it is recommended that you create scopes with a **using** statement.</span></span> <span data-ttu-id="dbbf3-112">O **usando** instrução está disponível no C# e no Visual Basic e funciona como um **try... por fim** bloco para garantir que o escopo é descartado corretamente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-112">The **using** statement is available both in C# and in Visual Basic, and works like a **try...finally** block to ensure that the scope is disposed of properly.</span></span>  
  
 <span data-ttu-id="dbbf3-113">Quando você cria uma instância <xref:System.Transactions.TransactionScope>, o Gerenciador de transações determina qual transação para participar.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-113">When you instantiate <xref:System.Transactions.TransactionScope>, the transaction manager determines which transaction to participate in.</span></span> <span data-ttu-id="dbbf3-114">Uma vez determinado, o escopo sempre participa dessa transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-114">Once determined, the scope always participates in that transaction.</span></span> <span data-ttu-id="dbbf3-115">A decisão se baseia em dois fatores: se uma transação de ambiente está presente e o valor de **TransactionScopeOption** parâmetro no construtor.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-115">The decision is based on two factors: whether an ambient transaction is present and the value of the **TransactionScopeOption** parameter in the constructor.</span></span> <span data-ttu-id="dbbf3-116">A transação ambiente é a transação na qual o código é executado.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-116">The ambient transaction is the transaction within which your code executes.</span></span> <span data-ttu-id="dbbf3-117">Você pode obter uma referência para a transação de ambiente chamando estático <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> propriedade o <xref:System.Transactions.Transaction> classe.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-117">You can obtain a reference to the ambient transaction by calling the static <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> property of the <xref:System.Transactions.Transaction> class.</span></span> <span data-ttu-id="dbbf3-118">Para obter mais informações sobre como esse parâmetro é usado, consulte a [Gerenciando o fluxo de transações usando TransactionScopeOption](#ManageTxFlow) seção deste tópico.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-118">For more information on how this parameter is used, see the [Managing transaction flow using TransactionScopeOption](#ManageTxFlow) section of this topic.</span></span>  
  
## <a name="completing-a-transaction-scope"></a><span data-ttu-id="dbbf3-119">Concluindo um escopo de transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-119">Completing a transaction scope</span></span>  
 <span data-ttu-id="dbbf3-120">Quando seu aplicativo conclui todo o trabalho que deseja executar em uma transação, você deve chamar o <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWIthType> método apenas uma vez para informar o Gerenciador de transações que é aceitável para confirmar a transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-120">When your application completes all the work it wants to perform in a transaction, you should call the <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWIthType> method only once to inform the transaction manager that it is acceptable to commit the transaction.</span></span> <span data-ttu-id="dbbf3-121">É muito bom colocar a chamada para <xref:System.Transactions.TransactionScope.Complete%2A> como a última instrução na **usando** bloco.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-121">It is very good practice to put the call to <xref:System.Transactions.TransactionScope.Complete%2A> as the last statement in the **using** block.</span></span>  
  
 <span data-ttu-id="dbbf3-122">Falha ao chamar esse método anula a transação, porque o Gerenciador de transações interpretará isso como uma falha do sistema, ou equivalente a uma exceção lançada dentro do escopo da transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-122">Failing to call this method aborts the transaction, because the transaction manager interprets this as a system failure, or equivalent to an exception thrown within the scope of the transaction.</span></span> <span data-ttu-id="dbbf3-123">No entanto, chamar este método não garante que a transação será ser confirmada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-123">However, calling this method does not guarantee that the transaction wil be committed.</span></span> <span data-ttu-id="dbbf3-124">É simplesmente uma maneira de informar o Gerenciador de transações do seu status.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-124">It is merely a way of informing the transaction manager of your status.</span></span> <span data-ttu-id="dbbf3-125">Depois de chamar o <xref:System.Transactions.TransactionScope.Complete%2A> método, você não pode acessar a transação de ambiente usando o <xref:System.Transactions.Transaction.Current%2A> propriedade e tentar fazer isso resultará em uma exceção é lançada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-125">After calling the <xref:System.Transactions.TransactionScope.Complete%2A> method, you can no longer access the ambient transaction by using the <xref:System.Transactions.Transaction.Current%2A> property, and attempting to do so will result in an exception being thrown.</span></span>  
  
 <span data-ttu-id="dbbf3-126">Se o <xref:System.Transactions.TransactionScope> do objeto criou a transação inicialmente, o trabalho real de confirmação da transação, o Gerenciador de transações ocorre após a última linha do código em de **usando** bloco.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-126">If the <xref:System.Transactions.TransactionScope> object created the transaction initially, the actual work of committing the transaction by the transaction manager occurs after the last line of code in the **using** block.</span></span> <span data-ttu-id="dbbf3-127">Se ele não criou a transação, a confirmação ocorre sempre que <xref:System.Transactions.CommittableTransaction.Commit%2A> é chamado pelo proprietário do <xref:System.Transactions.CommittableTransaction> objeto.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-127">If it did not create the transaction, the commit occurs whenever <xref:System.Transactions.CommittableTransaction.Commit%2A> is called by the owner of the <xref:System.Transactions.CommittableTransaction> object.</span></span> <span data-ttu-id="dbbf3-128">Nesse momento o Gerenciador de transações chama o recurso gerentes e informá-los para confirmar ou reverter, com base em se a <xref:System.Transactions.TransactionScope.Complete%2A> método foi chamado no <xref:System.Transactions.TransactionScope> objeto.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-128">At that point the transaction manager calls the resource managers and informs them to either commit or rollback, based on whether the <xref:System.Transactions.TransactionScope.Complete%2A> method was called on the <xref:System.Transactions.TransactionScope> object.</span></span>  
  
 <span data-ttu-id="dbbf3-129">O **usando** instrução garante que o <xref:System.Transactions.TransactionScope.Dispose%2A> método da <xref:System.Transactions.TransactionScope> objeto seja chamado mesmo se ocorrer uma exceção.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-129">The **using** statement ensures that the <xref:System.Transactions.TransactionScope.Dispose%2A> method of the <xref:System.Transactions.TransactionScope> object is called even if an exception occurs.</span></span> <span data-ttu-id="dbbf3-130">O <xref:System.Transactions.TransactionScope.Dispose%2A> método marca o final do escopo da transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-130">The <xref:System.Transactions.TransactionScope.Dispose%2A> method marks the end of the transaction scope.</span></span> <span data-ttu-id="dbbf3-131">Exceções que ocorrem depois de chamar esse método não podem afetar a transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-131">Exceptions that occur after calling this method may not affect the transaction.</span></span> <span data-ttu-id="dbbf3-132">Esse método também restaura a transação de ambiente para ele estado anterior.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-132">This method also restores the ambient transaction to it previous state.</span></span>  
  
 <span data-ttu-id="dbbf3-133">Um <xref:System.Transactions.TransactionAbortedException> será lançada se o escopo cria a transação e a transação for anulada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-133">A <xref:System.Transactions.TransactionAbortedException> is thrown if the scope creates the transaction, and the transaction is aborted.</span></span> <span data-ttu-id="dbbf3-134">Um <xref:System.Transactions.TransactionInDoubtException> será lançada se o Gerenciador de transações não pode chegar a uma decisão de confirmação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-134">A <xref:System.Transactions.TransactionInDoubtException> is thrown if the transaction manager cannot reach a Commit decision.</span></span> <span data-ttu-id="dbbf3-135">Nenhuma exceção é gerada se a transação for confirmada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-135">No exception is thrown if the transaction is committed.</span></span>  
  
## <a name="rolling-back-a-transaction"></a><span data-ttu-id="dbbf3-136">Reverter uma transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-136">Rolling back a transaction</span></span>  
 <span data-ttu-id="dbbf3-137">Se você quiser reverter uma transação, você não deve chamar o <xref:System.Transactions.TransactionScope.Complete%2A> método dentro do escopo da transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-137">If you want to rollback a transaction, you should not call the <xref:System.Transactions.TransactionScope.Complete%2A> method within the transaction scope.</span></span> <span data-ttu-id="dbbf3-138">Por exemplo, você pode lançar uma exceção dentro do escopo.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-138">For example, you can throw an exception within the scope.</span></span> <span data-ttu-id="dbbf3-139">A transação na qual participa também será revertida.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-139">The transaction in which it participates in will be rolled back.</span></span>  
  
##  <a name="ManageTxFlow"></a> <span data-ttu-id="dbbf3-140">Gerenciando o fluxo de transações usando TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="dbbf3-140">Managing transaction flow using TransactionScopeOption</span></span>  
 <span data-ttu-id="dbbf3-141">Escopo da transação pode ser aninhado, chamando um método que usa um <xref:System.Transactions.TransactionScope> de dentro de um método que usa seu próprio escopo, como é o caso com o `RootMethod` método no exemplo a seguir,</span><span class="sxs-lookup"><span data-stu-id="dbbf3-141">Transaction scope can be nested by calling a method that uses a <xref:System.Transactions.TransactionScope> from within a method that uses its own scope, as is the case with the `RootMethod` method in the following example,</span></span>  
  
```csharp  
void RootMethod()  
{  
     using(TransactionScope scope = new TransactionScope())  
     {  
          /* Perform transactional work here */  
          SomeMethod();  
          scope.Complete();  
     }  
}  
  
void SomeMethod()  
{  
     using(TransactionScope scope = new TransactionScope())  
     {  
          /* Perform transactional work here */  
          scope.Complete();  
     }  
}  
```  
  
 <span data-ttu-id="dbbf3-142">O escopo da transação mais alto é conhecido como o escopo raiz.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-142">The top-most transaction scope is referred to as the root scope.</span></span>  
  
 <span data-ttu-id="dbbf3-143">O <xref:System.Transactions.TransactionScope> classe fornece vários construtores sobrecarregados que aceitam uma enumeração do tipo <xref:System.Transactions.TransactionScopeOption>, que define o comportamento transacional do escopo.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-143">The <xref:System.Transactions.TransactionScope> class provides several overloaded constructors that accept an enumeration of the type <xref:System.Transactions.TransactionScopeOption>, which defines the transactional behavior of the scope.</span></span>  
  
 <span data-ttu-id="dbbf3-144">Um <xref:System.Transactions.TransactionScope> objeto tem três opções:</span><span class="sxs-lookup"><span data-stu-id="dbbf3-144">A <xref:System.Transactions.TransactionScope> object has three options:</span></span>  
  
-   <span data-ttu-id="dbbf3-145">Una a transação de ambiente ou criar um novo caso não exista.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-145">Join the ambient transaction, or create a new one if one does not exist.</span></span>  
  
-   <span data-ttu-id="dbbf3-146">Ser um novo escopo de raiz, ou seja, iniciar uma nova transação e ter essa transação com a nova transação ambiente dentro de seu próprio escopo.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-146">Be a new root scope, that is, start a new transaction and have that transaction be the new ambient transaction inside its own scope.</span></span>  
  
-   <span data-ttu-id="dbbf3-147">Não fazer parte de uma transação, todo.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-147">Not take part in a transaction at all.</span></span> <span data-ttu-id="dbbf3-148">Como resultado, há uma transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-148">There is no ambient transaction as a result.</span></span>  
  
 <span data-ttu-id="dbbf3-149">Se o escopo é instanciado com <xref:System.Transactions.TransactionScopeOption.Required>e uma transação de ambiente estiver presente, o escopo une a transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-149">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Required>, and an ambient transaction is present, the scope joins that transaction.</span></span> <span data-ttu-id="dbbf3-150">Se, por outro lado, não há nenhuma transação de ambiente, o escopo cria uma nova transação e se tornar o escopo raiz.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-150">If, on the other hand, there is no ambient transaction, then the scope creates a new transaction, and become the root scope.</span></span> <span data-ttu-id="dbbf3-151">Este é o valor padrão.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-151">This is the default value.</span></span> <span data-ttu-id="dbbf3-152">Quando <xref:System.Transactions.TransactionScopeOption.Required> é usado, o código dentro do escopo não precisa ter um comportamento diferente seja a raiz ou apenas associando a transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-152">When <xref:System.Transactions.TransactionScopeOption.Required> is used, the code inside the scope does not need to behave differently whether it is the root or just joining the ambient transaction.</span></span> <span data-ttu-id="dbbf3-153">Ele deve operar identicamente em ambos os casos.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-153">It should operate identically in both cases.</span></span>  
  
 <span data-ttu-id="dbbf3-154">Se o escopo é instanciado com <xref:System.Transactions.TransactionScopeOption.RequiresNew>, é sempre o escopo raiz.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-154">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.RequiresNew>, it is always the root scope.</span></span> <span data-ttu-id="dbbf3-155">Ele inicia uma nova transação, e sua transação se torna a nova transação ambiente dentro do escopo.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-155">It starts a new transaction, and its transaction becomes the new ambient transaction inside the scope.</span></span>  
  
 <span data-ttu-id="dbbf3-156">Se o escopo é instanciado com <xref:System.Transactions.TransactionScopeOption.Suppress>, ele nunca faz parte de uma transação, independentemente de se uma transação de ambiente está presente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-156">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Suppress>, it never takes part in a transaction, regardless of whether an ambient transaction is present.</span></span> <span data-ttu-id="dbbf3-157">Um escopo instanciado com esse valor sempre ter **nulo** como sua transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-157">A scope instantiated with this value always have **null** as its ambient transaction.</span></span>  
  
 <span data-ttu-id="dbbf3-158">As opções acima são resumidas na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-158">The above options are summarized in the following table.</span></span>  
  
|<span data-ttu-id="dbbf3-159">TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="dbbf3-159">TransactionScopeOption</span></span>|<span data-ttu-id="dbbf3-160">Transação de ambiente</span><span class="sxs-lookup"><span data-stu-id="dbbf3-160">Ambient Transaction</span></span>|<span data-ttu-id="dbbf3-161">O escopo faz parte do</span><span class="sxs-lookup"><span data-stu-id="dbbf3-161">The scope takes part in</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="dbbf3-162">Obrigatório</span><span class="sxs-lookup"><span data-stu-id="dbbf3-162">Required</span></span>|<span data-ttu-id="dbbf3-163">Não</span><span class="sxs-lookup"><span data-stu-id="dbbf3-163">No</span></span>|<span data-ttu-id="dbbf3-164">Nova transação (será a raiz)</span><span class="sxs-lookup"><span data-stu-id="dbbf3-164">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="dbbf3-165">Requer novo</span><span class="sxs-lookup"><span data-stu-id="dbbf3-165">Requires New</span></span>|<span data-ttu-id="dbbf3-166">Não</span><span class="sxs-lookup"><span data-stu-id="dbbf3-166">No</span></span>|<span data-ttu-id="dbbf3-167">Nova transação (será a raiz)</span><span class="sxs-lookup"><span data-stu-id="dbbf3-167">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="dbbf3-168">Suprimir</span><span class="sxs-lookup"><span data-stu-id="dbbf3-168">Suppress</span></span>|<span data-ttu-id="dbbf3-169">Não</span><span class="sxs-lookup"><span data-stu-id="dbbf3-169">No</span></span>|<span data-ttu-id="dbbf3-170">Nenhuma transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-170">No Transaction</span></span>|  
|<span data-ttu-id="dbbf3-171">Obrigatório</span><span class="sxs-lookup"><span data-stu-id="dbbf3-171">Required</span></span>|<span data-ttu-id="dbbf3-172">Sim</span><span class="sxs-lookup"><span data-stu-id="dbbf3-172">Yes</span></span>|<span data-ttu-id="dbbf3-173">Transação de ambiente</span><span class="sxs-lookup"><span data-stu-id="dbbf3-173">Ambient  Transaction</span></span>|  
|<span data-ttu-id="dbbf3-174">Requer novo</span><span class="sxs-lookup"><span data-stu-id="dbbf3-174">Requires New</span></span>|<span data-ttu-id="dbbf3-175">Sim</span><span class="sxs-lookup"><span data-stu-id="dbbf3-175">Yes</span></span>|<span data-ttu-id="dbbf3-176">Nova transação (será a raiz)</span><span class="sxs-lookup"><span data-stu-id="dbbf3-176">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="dbbf3-177">Suprimir</span><span class="sxs-lookup"><span data-stu-id="dbbf3-177">Suppress</span></span>|<span data-ttu-id="dbbf3-178">Sim</span><span class="sxs-lookup"><span data-stu-id="dbbf3-178">Yes</span></span>|<span data-ttu-id="dbbf3-179">Nenhuma transação</span><span class="sxs-lookup"><span data-stu-id="dbbf3-179">No Transaction</span></span>|  
  
 <span data-ttu-id="dbbf3-180">Quando um <xref:System.Transactions.TransactionScope> objeto ingressa em uma transação ambiente existente, descarte o objeto de escopo não pode terminar a transação, a menos que o escopo anula a transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-180">When a <xref:System.Transactions.TransactionScope> object joins an existing ambient transaction, disposing of the scope object may not end the transaction, unless the scope aborts the transaction.</span></span> <span data-ttu-id="dbbf3-181">Se a transação ambiente criada por um escopo de raiz, somente quando o escopo raiz é descartado, não <xref:System.Transactions.CommittableTransaction.Commit%2A> chamado na transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-181">If the ambient transaction was created by a root scope, only when the root scope is disposed of, does <xref:System.Transactions.CommittableTransaction.Commit%2A> get called on the transaction.</span></span> <span data-ttu-id="dbbf3-182">Se a transação foi criada manualmente, a transação termina quando ele é anulado ou confirmado pelo seu criador.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-182">If the transaction was created manually, the transaction ends when it is either aborted, or committed by its creator.</span></span>  
  
 <span data-ttu-id="dbbf3-183">A exemplo a seguir mostra um <xref:System.Transactions.TransactionScope> que cria três objetos de escopo aninhado, cada instanciados com outro objeto <xref:System.Transactions.TransactionScopeOption> valor.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-183">The following example shows a <xref:System.Transactions.TransactionScope> object that creates three nested scope objects, each instantiated with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())   
//Default is Required   
{   
     using(TransactionScope scope2 = new   
      TransactionScope(TransactionScopeOption.Required))   
     {  
     ...  
     }   
  
     using(TransactionScope scope3 = new TransactionScope(TransactionScopeOption.RequiresNew))   
     {  
     ...  
     }   
  
     using(TransactionScope scope4 = new   
        TransactionScope(TransactionScopeOption.Suppress))   
    {  
     ...  
    }   
}  
```  
  
 <span data-ttu-id="dbbf3-184">O exemplo mostra um bloco de código sem qualquer transação ambiente criando um novo escopo (`scope1`) com <xref:System.Transactions.TransactionScopeOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-184">The example shows a code block without any ambient transaction creating a new scope (`scope1`) with <xref:System.Transactions.TransactionScopeOption.Required>.</span></span> <span data-ttu-id="dbbf3-185">O escopo `scope1` é um escopo de raiz quando ele cria uma nova transação (uma transação) e faz com que a transação A transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-185">The scope `scope1` is a root scope as it creates a new transaction (Transaction A) and makes Transaction A the ambient transaction.</span></span> <span data-ttu-id="dbbf3-186">`Scope1`em seguida, cria três mais objetos, cada um com outro <xref:System.Transactions.TransactionScopeOption> valor.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-186">`Scope1` then creates three more objects, each with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span> <span data-ttu-id="dbbf3-187">Por exemplo, `scope2` é criado com <xref:System.Transactions.TransactionScopeOption.Required>, e como há uma transação de ambiente, ele adiciona a primeira transação criada pelo `scope1`.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-187">For example, `scope2` is created with <xref:System.Transactions.TransactionScopeOption.Required>, and since there is an ambient transaction, it joins the first transaction created by `scope1`.</span></span> <span data-ttu-id="dbbf3-188">Observe que `scope3` é o escopo da raiz de uma nova transação e que `scope4` não tem nenhuma transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-188">Note that `scope3` is the root scope of a new transaction, and that `scope4` has no ambient transaction.</span></span>  
  
 <span data-ttu-id="dbbf3-189">Embora o padrão e mais comumente usado o valor de <xref:System.Transactions.TransactionScopeOption> é <xref:System.Transactions.TransactionScopeOption.Required>, cada um dos outros valores tem sua finalidade exclusiva.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-189">Although the default and most commonly used value of <xref:System.Transactions.TransactionScopeOption> is <xref:System.Transactions.TransactionScopeOption.Required>, each of the other values has its unique purpose.</span></span>  
  
 <span data-ttu-id="dbbf3-190"><xref:System.Transactions.TransactionScopeOption.Suppress>é útil quando você quiser preservar as operações executadas pela seção de código e não desejar anular a transação ambiente se as operações de falham.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-190"><xref:System.Transactions.TransactionScopeOption.Suppress> is useful when you want to preserve the operations performed by the code section, and do not want to abort the ambient transaction if the operations fail.</span></span> <span data-ttu-id="dbbf3-191">Por exemplo, quando você deseja executar um log ou operações de auditoria ou quando desejar publicar eventos para assinantes, independentemente de se a transação de ambiente confirma ou anula.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-191">For example, when you want to perform logging or audit operations, or when you want to publish events to subscribers regardless of whether your ambient transaction commits or aborts.</span></span> <span data-ttu-id="dbbf3-192">Esse valor permite que você tenha uma seção de código não-transacional dentro de um escopo de transação, como mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-192">This value allows you to have a non-transactional code section inside a transaction scope, as shown in the following example.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())  
{  
     try  
     {  
          //Start of non-transactional section   
          using(TransactionScope scope2 = new  
             TransactionScope(TransactionScopeOption.Suppress))  
          {  
               //Do non-transactional work here  
          }  
          //Restores ambient transaction here  
   }  
     catch  
     {}  
   //Rest of scope1  
}  
```  
  
### <a name="voting-inside-a-nested-scope"></a><span data-ttu-id="dbbf3-193">Votação dentro de um escopo aninhado</span><span class="sxs-lookup"><span data-stu-id="dbbf3-193">Voting inside a nested scope</span></span>  
 <span data-ttu-id="dbbf3-194">Embora um escopo aninhado pode unir a transação de ambiente do escopo raiz, chamar <xref:System.Transactions.TransactionScope.Complete%2A> no escopo aninhado não tem nenhum efeito sobre o escopo raiz.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-194">Although a nested scope can join the ambient transaction of the root scope, calling <xref:System.Transactions.TransactionScope.Complete%2A> in the nested scope has no affect on the root scope.</span></span> <span data-ttu-id="dbbf3-195">Somente se todos os escopos do escopo raiz até o último escopo aninhado votam para confirmar a transação, a transação será confirmada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-195">Only if all the scopes from the root scope down to the last nested scope vote to commit the transaction, will the transaction be committed.</span></span> <span data-ttu-id="dbbf3-196">Não chamar <xref:System.Transactions.TransactionScope.Complete%2A> em um escopo aninhado afetará o escopo raiz como a transação ambiente imediatamente será anulada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-196">Not calling <xref:System.Transactions.TransactionScope.Complete%2A> in a nested scope will affect the root scope as the ambient transaction will immediately be aborted.</span></span>  
  
## <a name="setting-the-transactionscope-timeout"></a><span data-ttu-id="dbbf3-197">Definir o tempo limite de TransactionScope</span><span class="sxs-lookup"><span data-stu-id="dbbf3-197">Setting the TransactionScope timeout</span></span>  
 <span data-ttu-id="dbbf3-198">Alguns dos construtores sobrecarregados de <xref:System.Transactions.TransactionScope> aceitar um valor do tipo <xref:System.TimeSpan>, que é usado para controlar o tempo limite da transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-198">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a value of type <xref:System.TimeSpan>, which is used to control the timeout of the transaction.</span></span> <span data-ttu-id="dbbf3-199">Um tempo limite definido como zero significa um tempo limite infinito.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-199">A timeout set to zero means an infinite timeout.</span></span> <span data-ttu-id="dbbf3-200">Tempo limite infinito é útil principalmente para depuração, quando quiser isolar um problema em sua lógica de negócios, percorrendo seu código, e você não deseja que a transação que você depurar tempo limite durante a tentativa de localizar o problema.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-200">Infinite timeout is useful mostly for debugging, when you want to isolate a problem in your business logic by stepping through your code, and you do not want the transaction you debug to time out while you attempt to locate the problem.</span></span> <span data-ttu-id="dbbf3-201">Ser extremamente cauteloso ao usar o valor de tempo limite infinito em todos os outros casos, porque ele substitui as proteções contra bloqueios de transação.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-201">Be extremely careful using the infinite timeout value in all other cases, because it overrides the safeguards against transaction deadlocks.</span></span>  
  
 <span data-ttu-id="dbbf3-202">Você normalmente define o <xref:System.Transactions.TransactionScope> tempo limite para valores que não seja padrão nos dois casos.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-202">You typically set the <xref:System.Transactions.TransactionScope> timeout to values other than default in two cases.</span></span> <span data-ttu-id="dbbf3-203">A primeira é durante o desenvolvimento, quando você deseja testar a maneira como o seu aplicativo manipula transações anuladas.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-203">The first is during development, when you want to test the way your application handles aborted transactions.</span></span> <span data-ttu-id="dbbf3-204">Definindo o tempo limite como um valor pequeno (como um milissegundo), você fazer com que a transação falhar e, portanto, pode observar o código de tratamento de erros.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-204">By setting the timeout to a small value (such as one millisecond), you cause your transaction to fail and can thus observe your error handling code.</span></span> <span data-ttu-id="dbbf3-205">O segundo caso em que você definir o valor como menor que o tempo limite padrão é quando você acreditar que o escopo está envolvido na contenção de recursos, resultando em bloqueios.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-205">The second case in which you set the value to be less than the default timeout is when you believe that the scope is involved in resource contention, resulting in deadlocks.</span></span> <span data-ttu-id="dbbf3-206">Nesse caso, você deseja anular a transação assim que possível e aguarda o tempo limite padrão expirar.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-206">In that case, you want to abort the transaction as soon as possible and not wait for the default timeout to expire.</span></span>  
  
 <span data-ttu-id="dbbf3-207">Quando um escopo ingressa em uma transação de ambiente, mas Especifica um tempo limite menor do que a transação ambiente é definida como, o tempo limite de novo e mais curto é imposto no <xref:System.Transactions.TransactionScope> objeto e o escopo devem terminar no tempo aninhado especificado ou a transação é cancelada automaticamente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-207">When a scope joins an ambient transaction but specifies a smaller timeout than the one the ambient transaction is set to, the new, shorter timeout is enforced on the <xref:System.Transactions.TransactionScope> object, and the scope must end within the nested time specified, or the transaction is automatically aborted.</span></span> <span data-ttu-id="dbbf3-208">Se o tempo limite do escopo aninhado é maior do que a transação de ambiente, ele não tem efeito.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-208">If the nested scope's timeout is more than that of the ambient transaction, it has no effect.</span></span>  
  
## <a name="setting-the-transactionscope-isolation-level"></a><span data-ttu-id="dbbf3-209">Definindo o nível de isolamento de TransactionScope</span><span class="sxs-lookup"><span data-stu-id="dbbf3-209">Setting the TransactionScope isolation level</span></span>  
 <span data-ttu-id="dbbf3-210">Alguns dos construtores sobrecarregados de <xref:System.Transactions.TransactionScope> aceitar uma estrutura do tipo <xref:System.Transactions.TransactionOptions> para especificar um nível de isolamento, além de um valor de tempo limite.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-210">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a structure of type <xref:System.Transactions.TransactionOptions> to specify an isolation level, in addition to a timeout value.</span></span> <span data-ttu-id="dbbf3-211">Por padrão, a transação será executado com nível de isolamento definido como <xref:System.Transactions.IsolationLevel.Serializable>.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-211">By default, the transaction executes with isolation level set to <xref:System.Transactions.IsolationLevel.Serializable>.</span></span> <span data-ttu-id="dbbf3-212">Selecionando um nível de isolamento diferente de <xref:System.Transactions.IsolationLevel.Serializable> é normalmente usado para sistemas com uso intensivo de leitura.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-212">Selecting an isolation level other than <xref:System.Transactions.IsolationLevel.Serializable> is commonly used for read-intensive systems.</span></span> <span data-ttu-id="dbbf3-213">Isso requer uma compreensão sólida da teoria e a semântica da própria transação, os problemas de simultaneidade envolvidos e as conseqüências de consistência do sistema de processamento de transações.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-213">This requires a solid understanding of transaction processing theory and the semantics of the transaction itself, the concurrency issues involved, and the consequences for system consistency.</span></span>  
  
 <span data-ttu-id="dbbf3-214">Além disso, nem todos os gerenciadores de recursos oferecer suporte a todos os níveis de isolamento, e eles podem optar por fazer parte de transação em um nível mais alto que o configurado.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-214">In addition, not all resource managers support all levels of isolation, and they may elect to take part in the transaction at a higher level than the one configured.</span></span>  
  
 <span data-ttu-id="dbbf3-215">Cada nível de isolamento além <xref:System.Transactions.IsolationLevel.Serializable> é suscetível a inconsistência resultantes de outras transações que acessam as mesmas informações.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-215">Every isolation level besides <xref:System.Transactions.IsolationLevel.Serializable> is susceptible to inconsistency resulting from other transactions accessing the same information.</span></span> <span data-ttu-id="dbbf3-216">É a diferença entre os diferentes níveis de isolamento da forma leitura e gravação bloqueios são usados.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-216">The difference between the different isolation levels is in the way read and write locks are used.</span></span> <span data-ttu-id="dbbf3-217">Um bloqueio pode ser mantido somente quando a transação acessa os dados no Gerenciador de recursos, ou pode ser mantida até que a transação é confirmada ou anulada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-217">A lock can be held only when the transaction accesses the data in the resource manager, or it can be held until the transaction is committed or aborted.</span></span> <span data-ttu-id="dbbf3-218">O primeiro é melhor taxa de transferência, o segundo para manter a consistência.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-218">The former is better for throughput, the latter for consistency.</span></span> <span data-ttu-id="dbbf3-219">Os dois tipos de bloqueios e os dois tipos de operações (leitura/gravação) oferecem quatro níveis de isolamento básico.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-219">The two kinds of locks and the two kinds of operations (read/write) give four basic isolation levels.</span></span> <span data-ttu-id="dbbf3-220">Consulte <xref:System.Transactions.IsolationLevel> para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-220">See <xref:System.Transactions.IsolationLevel> for more information.</span></span>  
  
 <span data-ttu-id="dbbf3-221">Quando usando aninhadas <xref:System.Transactions.TransactionScope> objetos, todos os escopos aninhados devem ser configurados para usar exatamente o mesmo nível de isolamento se deseja unir a transação de ambiente.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-221">When using nested <xref:System.Transactions.TransactionScope> objects, all nested scopes must be configured to use exactly the same isolation level if they want to join the ambient transaction.</span></span> <span data-ttu-id="dbbf3-222">Se um aninhada <xref:System.Transactions.TransactionScope> objeto tentar unir a transação ambiente ainda Especifica um nível de isolamento diferente, um <xref:System.ArgumentException> é lançada.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-222">If a nested <xref:System.Transactions.TransactionScope> object tries to join the ambient transaction yet it specifies a different isolation level, an <xref:System.ArgumentException> is thrown.</span></span>  
  
## <a name="interop-with-com"></a><span data-ttu-id="dbbf3-223">Interoperação com COM+</span><span class="sxs-lookup"><span data-stu-id="dbbf3-223">Interop with COM+</span></span>  
 <span data-ttu-id="dbbf3-224">Quando você cria um novo <xref:System.Transactions.TransactionScope> instância, você pode usar o <xref:System.Transactions.EnterpriseServicesInteropOption> enumeração em um dos construtores para especificar como interagir com COM+.</span><span class="sxs-lookup"><span data-stu-id="dbbf3-224">When you create a new <xref:System.Transactions.TransactionScope> instance, you can use the <xref:System.Transactions.EnterpriseServicesInteropOption> enumeration in one of the constructors to specify how to interact with COM+.</span></span> <span data-ttu-id="dbbf3-225">Para obter mais informações sobre isso, consulte [interoperabilidade com serviços da empresa e transações COM+](../../../../docs/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span><span class="sxs-lookup"><span data-stu-id="dbbf3-225">For more information on this, see [Interoperability with Enterprise Services and COM+ Transactions](../../../../docs/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="dbbf3-226">Consulte também</span><span class="sxs-lookup"><span data-stu-id="dbbf3-226">See also</span></span>
- <xref:System.Transactions.Transaction.Clone%2A>
- <xref:System.Transactions.TransactionScope>
