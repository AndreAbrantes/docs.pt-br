---
title: Gerenciando o contexto do serviço de dados (WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 9b2b0bb709081ca7b0b2a1367f10e1f7a08c98c9
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/04/2018
ms.locfileid: "33365222"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Gerenciando o contexto do serviço de dados (WCF Data Services)
A classe <xref:System.Data.Services.Client.DataServiceContext> encapsula as operações que têm suporte em um serviço de dados especificado. Embora os serviços do [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] sejam sem estado, o contexto não é. Portanto, você pode usar o <xref:System.Data.Services.Client.DataServiceContext> classe para manter o estado no cliente entre as interações com o serviço de dados para oferecer suporte a recursos como gerenciamento de alterações. Essa classe também gerencia identidades e rastreia alterações.  
  
## <a name="merge-options-and-identity-resolution"></a>Opções de mesclagem e a resolução de identidade  
 Quando um <xref:System.Data.Services.Client.DataServiceQuery%601> é executado, as entidades na resposta feed são materializadas em objetos. Para obter mais informações, consulte [materialização de objetos](../../../../docs/framework/data/wcf/object-materialization-wcf-data-services.md). A maneira na qual as entradas em uma mensagem de resposta são materializadas em objetos é executada com base na resolução de identidade e depende da opção de mesclagem na qual a consulta foi executada. Quando várias consultas ou carga de solicitações são executadas no escopo de um único <xref:System.Data.Services.Client.DataServiceContext>, o [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] client monitora apenas uma única instância de um objeto que tem um valor de chave específico. Essa chave, que é usada para executar a resolução de identidade, identifica exclusivamente uma entidade.  
  
 Por padrão, o cliente materializa apenas uma entrada na resposta de feed em um objeto para entidades que já não estão sendo controladas pelo <xref:System.Data.Services.Client.DataServiceContext>. Isso significa que as alterações nos objetos já está em cache não são substituídas. Esse comportamento é controlado pela especificação de uma <xref:System.Data.Services.Client.MergeOption> valor para consultas e operações de carregamento. Essa opção é especificada pela configuração de <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> propriedade o <xref:System.Data.Services.Client.DataServiceContext>. O valor de opção de mesclagem padrão é <xref:System.Data.Services.Client.MergeOption.AppendOnly>. Isso só materializa objetos para entidades que não já estão sendo rastreadas, o que significa que os objetos existentes não são substituídos. Outra maneira de impedir alterações em objetos do cliente sejam substituídos pelas atualizações do serviço de dados é especificar <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Quando você especificar <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, valores de objetos do cliente são substituídos pelos valores mais recentes das entradas no feed de resposta, mesmo que já foram feitas alterações a esses objetos. Quando um <xref:System.Data.Services.Client.MergeOption.NoTracking> opção de mesclagem é usada, o <xref:System.Data.Services.Client.DataServiceContext> não é possível enviar as alterações feitas nos objetos de cliente para o serviço de dados. Com essa opção, as alterações sempre são substituídas com valores do serviço de dados.  
  
## <a name="managing-concurrency"></a>Gerenciar a simultaneidade  
 [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] dá suporte a simultaneidade otimista que permite que o serviço de dados detectar conflitos de atualização. O provedor de serviços de dados pode ser configurado de forma que o serviço de dados verifica se há alterações para entidades usando um token de simultaneidade. Esse token inclui um ou mais propriedades de um tipo de entidade que são validadas pelo serviço de dados para determinar se um recurso foi alterado. Tokens de simultaneidade, que são incluídos no cabeçalho eTag de solicitações e respostas do serviço de dados, que são gerenciados pelo [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] cliente. Para obter mais informações, consulte [atualizar o serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
 O <xref:System.Data.Services.Client.DataServiceContext> rastreia as alterações feitas nos objetos que foram relatados manualmente usando <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>, e <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>, ou por um <xref:System.Data.Services.Client.DataServiceCollection%601>. Quando o <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> método é chamado, o cliente envia as alterações de volta para o serviço de dados. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> pode falhar quando as alterações de dados no cliente está em conflito com as alterações no serviço de dados. Quando isso ocorrer, você deve consultar o recurso de entidade novamente receber os dados de atualização. Para substituir as alterações no serviço de dados, execute a consulta usando o <xref:System.Data.Services.Client.MergeOption.PreserveChanges> opção de mesclagem. Quando você chama <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> novamente, as alterações preservadas no cliente são mantidas para o serviço de dados, enquanto outras alterações que não já foram feitas para o recurso no serviço de dados.  
  
## <a name="saving-changes"></a>Salvando alterações  
 As alterações são rastreadas na <xref:System.Data.Services.Client.DataServiceContext> instância, mas não são enviadas para o servidor imediatamente. Depois que você tiver terminado com as alterações necessárias para uma atividade especificada, chame <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> para enviar todas as alterações para o serviço de dados. Um <xref:System.Data.Services.Client.DataServiceResponse> objeto é retornado após o <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> operação for concluída. O <xref:System.Data.Services.Client.DataServiceResponse> objeto inclui uma sequência de <xref:System.Data.Services.Client.OperationResponse> objetos que, por sua vez, contêm uma sequência de <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> tentativa ou persistente de instâncias que representam as alterações. Quando uma entidade é criada ou modificada no serviço de dados, o <xref:System.Data.Services.Client.EntityDescriptor> inclui uma referência para a entidade atualizada, incluindo quaisquer valores de propriedade gerada pelo servidor, como o gerado `ProductID` valor no exemplo anterior. A biblioteca de cliente atualiza automaticamente o [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] objeto com esses novos valores.  
  
 Para inserir bem-sucedida e operações de atualização, a propriedade state do <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> associado à operação de objeto é definido como <xref:System.Data.Services.Client.EntityStates.Unchanged> e os novos valores são mesclados usando <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. Quando uma instrução insert, update ou haverá falha na operação de exclusão no serviço de dados, o estado da entidade permanece a mesma antes <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> foi chamado e o <xref:System.Data.Services.Client.OperationResponse.Error%2A> propriedade do <xref:System.Data.Services.Client.OperationResponse> é definido como um <xref:System.Data.Services.Client.DataServiceRequestException> que contém informações sobre o erro. Para obter mais informações, consulte [atualizar o serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Definir o método HTTP para atualizações  
 Por padrão, a biblioteca de cliente do .NET Framework envia atualizações para entidades existentes como solicitações de mesclagem. Uma solicitação de mesclagem atualiza as propriedades selecionadas da entidade. No entanto o cliente sempre inclui todas as propriedades na solicitação de mesclagem, até mesmo propriedades que não foram alterados. O [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] protocolo também oferece suporte a enviadas solicitações PUT para atualizar entidades. Em uma solicitação PUT, uma entidade existente essencialmente é substituída por uma nova instância da entidade com valores de propriedade do cliente. Para usar solicitações PUT, defina o <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> sinalizador no <xref:System.Data.Services.Client.SaveChangesOptions> enumeração ao chamar <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
>  Uma solicitação PUT irão se comportar de forma diferente de uma solicitação de mesclagem quando o cliente não sabe sobre todas as propriedades da entidade. Isso pode ocorrer ao projetar um tipo de entidade em um tipo novo no cliente. Também pode ocorrer quando novas propriedades foram adicionadas para a entidade no modelo de dados de serviço e o <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> propriedade o <xref:System.Data.Services.Client.DataServiceContext> é definido como `true` para ignorar esses erros de mapeamento do cliente. Nesses casos, uma solicitação PUT redefinirá as propriedades que são desconhecidas para o cliente para seus valores padrão.  
  
### <a name="post-tunneling"></a>Túnel de POSTAGEM  
 Por padrão, o envia de biblioteca de cliente criar, ler, atualizar e excluir solicitações para um [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] de serviço usando os métodos HTTP correspondentes do POST, GET, PUT, mesclagem/PATCH e DELETE. Isso upholds os princípios básicos do REST Representational State Transfer (). No entanto, não cada implementação do servidor Web oferece suporte a todo o conjunto de métodos HTTP. Em alguns casos, os métodos com suporte podem ser restritos a apenas GET e POST. Isso pode acontecer quando um intermediário, como um firewall bloqueia solicitações com alguns métodos. Porque a maioria das vezes, há suporte para os métodos GET e POST, [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] determina uma maneira de executar métodos HTTP sem suporte por meio de uma solicitação POST. Conhecido como *o túnel de método* ou *POST túnel*, isso permite que um cliente envia uma solicitação POST com o método real especificado em personalizado `X-HTTP-Method` cabeçalho. Para habilitar o túnel de POSTAGEM para solicitações, defina o <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> propriedade o <xref:System.Data.Services.Client.DataServiceContext> instância `true`.  
  
## <a name="see-also"></a>Consulte também  
 [WCF Data Services Client Library](../../../../docs/framework/data/wcf/wcf-data-services-client-library.md) (Biblioteca de clientes do WCF Data Services)  
 [Atualizando o serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md)  
 [Operações assíncronas](../../../../docs/framework/data/wcf/asynchronous-operations-wcf-data-services.md)  
 [Operações de envio em lote](../../../../docs/framework/data/wcf/batching-operations-wcf-data-services.md)
