---
title: Gerenciando o contexto do serviço de dados (WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 33e7ce17eea5d534b941d778fd13144ad51b4094
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/23/2019
ms.locfileid: "61875791"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Gerenciando o contexto do serviço de dados (WCF Data Services)
A classe <xref:System.Data.Services.Client.DataServiceContext> encapsula as operações que têm suporte em um serviço de dados especificado. Embora os serviços do [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] sejam sem estado, o contexto não é. Portanto, você pode usar o <xref:System.Data.Services.Client.DataServiceContext> classe para manter o estado no cliente entre interações com o serviço de dados para dar suporte a recursos como o gerenciamento de alterações. Essa classe também gerencia identidades e rastreia alterações.  
  
## <a name="merge-options-and-identity-resolution"></a>Opções de mesclagem e resolução de identidade  
 Quando um <xref:System.Data.Services.Client.DataServiceQuery%601> é executado, as entidades no feed de resposta são materializadas em objetos. Para obter mais informações, consulte [Materialization de objeto](../../../../docs/framework/data/wcf/object-materialization-wcf-data-services.md). A maneira na qual as entradas em uma mensagem de resposta são materializadas em objetos é executada com base na resolução de identidade e depende da opção de mesclagem na qual a consulta foi executada. Quando várias consultas ou carga de solicitações são executadas no escopo de uma única <xref:System.Data.Services.Client.DataServiceContext>, o [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] client monitora apenas uma única instância de um objeto que tem um valor de chave específico. Essa chave, que é usado para executar a resolução de identidade, identifica exclusivamente uma entidade.  
  
 Por padrão, o cliente só materializa uma entrada na resposta de feed em um objeto para entidades que já não estão sendo acompanhados pelo <xref:System.Data.Services.Client.DataServiceContext>. Isso significa que as alterações nos objetos já está em cache não serão substituídas. Esse comportamento é controlado pela especificação de um <xref:System.Data.Services.Client.MergeOption> de valor para consultas e operações de carregamento. Essa opção for especificada, definindo o <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> propriedade no <xref:System.Data.Services.Client.DataServiceContext>. O valor de opção de mesclagem padrão é <xref:System.Data.Services.Client.MergeOption.AppendOnly>. Isso apenas materializa objetos para entidades que não já estão sendo rastreadas, o que significa que os objetos existentes não serão substituídos. Outra maneira de impedir alterações em objetos no cliente que não sejam substituídos pelas atualizações do serviço de dados é especificar <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Quando você especifica <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, valores de objetos no cliente são substituídos pelos valores mais recentes das entradas no feed de resposta, mesmo que já foram feitas alterações a esses objetos. Quando um <xref:System.Data.Services.Client.MergeOption.NoTracking> opção de mesclagem for usada, o <xref:System.Data.Services.Client.DataServiceContext> não é possível enviar as alterações feitas em objetos de cliente para o serviço de dados. Com essa opção, as alterações sempre são substituídas pelos valores do serviço de dados.  
  
## <a name="managing-concurrency"></a>Gerenciando a simultaneidade  
 [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] dá suporte à simultaneidade otimista que permite que o serviço de dados detectar conflitos de atualização. O provedor de serviços de dados pode ser configurado de forma que o serviço de dados verifica alterações em entidades usando um token de simultaneidade. Esse token inclui um ou mais propriedades de um tipo de entidade que são validadas pelo serviço de dados para determinar se um recurso foi alterado. Tokens de simultaneidade, que são incluídos no cabeçalho de eTag de solicitações e respostas do serviço de dados, são gerenciados para você pelo [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] cliente. Para obter mais informações, consulte [atualização do serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
 O <xref:System.Data.Services.Client.DataServiceContext> rastreia as alterações feitas nos objetos que foram relatados manualmente, usando <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>, e <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>, ou por um <xref:System.Data.Services.Client.DataServiceCollection%601>. Quando o <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> método é chamado, o cliente envia as alterações de volta para o serviço de dados. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> pode falhar quando as alterações de dados no cliente em conflito com as alterações no serviço de dados. Quando isso ocorrer, você deve consultar o recurso de entidade novamente receber os dados de atualização. Para substituir as alterações no serviço de dados, execute a consulta usando o <xref:System.Data.Services.Client.MergeOption.PreserveChanges> opção de mesclagem. Quando você chama <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> novamente, as alterações que preservados no cliente serão mantidas para o serviço de dados, enquanto outras alterações que não já foram feitas para o recurso no serviço de dados.  
  
## <a name="saving-changes"></a>Salvando alterações  
 As alterações são rastreadas no <xref:System.Data.Services.Client.DataServiceContext> da instância, mas não são enviadas para o servidor imediatamente. Depois que você tiver concluído as alterações necessárias para uma atividade especificada, chame <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> para enviar todas as alterações ao serviço de dados. Um <xref:System.Data.Services.Client.DataServiceResponse> objeto é retornado após o <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> operação é concluída. O <xref:System.Data.Services.Client.DataServiceResponse> objeto inclui uma sequência de <xref:System.Data.Services.Client.OperationResponse> objetos que, por sua vez, contêm uma sequência de <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> tentativa ou persistentes de instâncias que representam as alterações. Quando uma entidade é criada ou modificada no serviço de dados, o <xref:System.Data.Services.Client.EntityDescriptor> inclui uma referência para a entidade atualizada, incluindo quaisquer valores de propriedade gerada pelo servidor, como o gerado `ProductID` valor no exemplo anterior. A biblioteca de cliente atualizará automaticamente o [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] objeto tenha esses novos valores.  
  
 Para inserção bem-sucedida e operações de atualização, a propriedade state do <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> associado à operação do objeto é definido como <xref:System.Data.Services.Client.EntityStates.Unchanged> e os novos valores são mesclados usando <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. Quando uma inserção, atualização ou operação de exclusão falhar no serviço de dados, o estado da entidade permanece a mesma como era antes <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> foi chamado e o <xref:System.Data.Services.Client.OperationResponse.Error%2A> propriedade da <xref:System.Data.Services.Client.OperationResponse> é definido como um <xref:System.Data.Services.Client.DataServiceRequestException> que contém informações sobre o erro. Para obter mais informações, consulte [atualização do serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Definir o método HTTP para atualizações  
 Por padrão, a biblioteca de cliente do .NET Framework envia atualizações para entidades existentes como solicitações de mesclagem. Uma solicitação de mesclagem atualiza as propriedades selecionadas da entidade. No entanto o cliente sempre inclui todas as propriedades na solicitação de mesclagem, até mesmo as propriedades que não foram alterados. O [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] protocolo também dá suporte a enviar solicitações PUT para atualizar entidades. Em uma solicitação PUT, uma entidade existente, essencialmente, é substituída por uma nova instância da entidade com valores de propriedade do cliente. Para usar solicitações PUT, defina as <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> sinalizador na <xref:System.Data.Services.Client.SaveChangesOptions> enumeração ao chamar <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
>  Uma solicitação PUT irá se comportar de maneira diferente de uma solicitação de mesclagem quando o cliente não souber sobre todas as propriedades da entidade. Isso pode ocorrer ao projetar um tipo de entidade em um novo tipo no cliente. Ele também pode ocorrer quando foram adicionadas novas propriedades à entidade no modelo de dados de serviço e o <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> propriedade no <xref:System.Data.Services.Client.DataServiceContext> é definido como `true` para ignorar esses erros de mapeamento do cliente. Nesses casos, uma solicitação PUT redefinirá quaisquer propriedades que são desconhecidas para o cliente para seus valores padrão.  
  
### <a name="post-tunneling"></a>Túnel de POSTAGEM  
 Por padrão, o cliente envia de biblioteca criar, ler, atualizar e excluir solicitações para um [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] de serviço usando os métodos HTTP correspondentes de POST, GET, PUT, MERGE/PATCH e excluir. Isso mantém os princípios básicos do REST Representational State Transfer (). No entanto, nem toda implementação do servidor Web dá suporte ao conjunto completo de métodos HTTP. Em alguns casos, os métodos com suporte podem ser restritos a apenas GET e POST. Isso pode acontecer quando um intermediário, como um firewall bloqueia solicitações com determinados métodos. Porque os métodos GET e POST têm suporte com mais frequência, [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] prescreve uma maneira de executar métodos HTTP sem suporte por meio de uma solicitação POST. Conhecido como *método túnel* ou *túnel de POSTAGEM*, isso permite que um cliente envie uma solicitação POST com o método real especificado na personalizado `X-HTTP-Method` cabeçalho. Para habilitar o túnel de POSTAGEM para solicitações, defina as <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> propriedade no <xref:System.Data.Services.Client.DataServiceContext> da instância para `true`.  
  
## <a name="see-also"></a>Consulte também

- [WCF Data Services Client Library](../../../../docs/framework/data/wcf/wcf-data-services-client-library.md) (Biblioteca de clientes do WCF Data Services)
- [Atualizando o serviço de dados](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md)
- [Operações assíncronas](../../../../docs/framework/data/wcf/asynchronous-operations-wcf-data-services.md)
- [Operações de envio em lote](../../../../docs/framework/data/wcf/batching-operations-wcf-data-services.md)
