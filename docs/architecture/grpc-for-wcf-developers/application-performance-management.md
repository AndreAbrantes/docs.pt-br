---
title: Gerenciamento de desempenho de aplicativos-gRPC para desenvolvedores do WCF
description: Registro em log, métricas e rastreamento para aplicativos ASP.NET Core gRPC.
ms.date: 09/02/2019
ms.openlocfilehash: 98da6c5391f021011e281a57e8f775709fa128ef
ms.sourcegitcommit: 9a97c76e141333394676bc5d264c6624b6f45bcf
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/08/2020
ms.locfileid: "75740966"
---
# <a name="application-performance-management"></a><span data-ttu-id="ae64d-103">Gerenciamento de desempenho de aplicativos</span><span class="sxs-lookup"><span data-stu-id="ae64d-103">Application Performance Management</span></span>

<span data-ttu-id="ae64d-104">Em ambientes de produção como o kubernetes, é importante monitorar os aplicativos para garantir que eles estejam sendo executados de forma ideal.</span><span class="sxs-lookup"><span data-stu-id="ae64d-104">In production environments like Kubernetes, it's important to monitor applications to ensure they're running optimally.</span></span> <span data-ttu-id="ae64d-105">O registro em log e as métricas são particularmente importantes.</span><span class="sxs-lookup"><span data-stu-id="ae64d-105">Logging and metrics are particularly important.</span></span> <span data-ttu-id="ae64d-106">ASP.NET Core, incluindo o gRPC, fornece suporte interno para produzir e gerenciar mensagens de log e dados de métrica, bem como dados de *rastreamento* .</span><span class="sxs-lookup"><span data-stu-id="ae64d-106">ASP.NET Core, including gRPC, provides built-in support for producing and managing log messages and metrics data, as well as *tracing* data.</span></span>

## <a name="the-difference-between-logging-and-metrics"></a><span data-ttu-id="ae64d-107">A diferença entre registro em log e métricas</span><span class="sxs-lookup"><span data-stu-id="ae64d-107">The difference between logging and metrics</span></span>

<span data-ttu-id="ae64d-108">O *registro em log* se preocupa com mensagens de texto que registram informações detalhadas sobre as coisas ocorridas no sistema.</span><span class="sxs-lookup"><span data-stu-id="ae64d-108">*Logging* is concerned with text messages that record detailed information about things that have happened in the system.</span></span> <span data-ttu-id="ae64d-109">As mensagens de log podem incluir dados de exceção, como rastreamentos de pilha ou dados estruturados que fornecem contexto sobre a mensagem.</span><span class="sxs-lookup"><span data-stu-id="ae64d-109">Log messages might include exception data, like stack traces, or structured data that provides context about the message.</span></span> <span data-ttu-id="ae64d-110">A saída de log é normalmente gravada em um repositório de texto pesquisável.</span><span class="sxs-lookup"><span data-stu-id="ae64d-110">Logging output is commonly written to a searchable text store.</span></span>

<span data-ttu-id="ae64d-111">As *métricas* referem-se aos dados numéricos projetados para serem agregados e apresentados usando gráficos em um painel.</span><span class="sxs-lookup"><span data-stu-id="ae64d-111">*Metrics* refers to numeric data designed to be aggregated and presented by using charts and graphs in a dashboard.</span></span> <span data-ttu-id="ae64d-112">O painel fornece uma visão geral da integridade e do desempenho de um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="ae64d-112">The dashboard provides a view of the overall health and performance of an application.</span></span> <span data-ttu-id="ae64d-113">Os dados de métricas também podem ser usados para disparar alertas automatizados quando um limite é excedido.</span><span class="sxs-lookup"><span data-stu-id="ae64d-113">Metrics data can also be used to trigger automated alerts when a threshold is exceeded.</span></span> <span data-ttu-id="ae64d-114">Aqui estão alguns exemplos de dados de métricas:</span><span class="sxs-lookup"><span data-stu-id="ae64d-114">Here are some examples of metrics data:</span></span>

- <span data-ttu-id="ae64d-115">Tempo necessário para processar solicitações.</span><span class="sxs-lookup"><span data-stu-id="ae64d-115">Time taken to process requests.</span></span>
- <span data-ttu-id="ae64d-116">O número de solicitações por segundo manipuladas por uma instância de um serviço.</span><span class="sxs-lookup"><span data-stu-id="ae64d-116">The number of requests per second being handled by an instance of a service.</span></span>
- <span data-ttu-id="ae64d-117">O número de solicitações com falha em uma instância.</span><span class="sxs-lookup"><span data-stu-id="ae64d-117">The number of failed requests on an instance.</span></span>

## <a name="logging-in-aspnet-core-grpc"></a><span data-ttu-id="ae64d-118">Fazendo logon ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="ae64d-118">Logging in ASP.NET Core gRPC</span></span>

<span data-ttu-id="ae64d-119">O ASP.NET Core fornece suporte interno para registro em log, na forma do pacote NuGet [Microsoft. Extensions. Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) .</span><span class="sxs-lookup"><span data-stu-id="ae64d-119">ASP.NET Core provides built-in support for logging, in the form of the [Microsoft.Extensions.Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) NuGet package.</span></span> <span data-ttu-id="ae64d-120">As principais partes dessa biblioteca estão incluídas no SDK da Web, portanto, não é necessário instalá-las manualmente.</span><span class="sxs-lookup"><span data-stu-id="ae64d-120">The core parts of this library are included with the Web SDK, so there's no need to install it manually.</span></span> <span data-ttu-id="ae64d-121">Por padrão, as mensagens de log são gravadas na saída padrão (o "console") e em qualquer depurador anexado.</span><span class="sxs-lookup"><span data-stu-id="ae64d-121">By default, log messages are written to the standard output (the "console") and to any attached debugger.</span></span> <span data-ttu-id="ae64d-122">Para gravar logs em armazenamentos de dados externos persistentes, talvez seja necessário importar [pacotes de coletor de log opcionais](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span><span class="sxs-lookup"><span data-stu-id="ae64d-122">To write logs to persistent external data stores, you might need to import [optional logging sink packages](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span></span>

<span data-ttu-id="ae64d-123">O ASP.NET Core estrutura gRPC grava mensagens de log de diagnóstico detalhadas para essa estrutura de log, para que elas possam ser processadas e armazenadas junto com as próprias mensagens do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="ae64d-123">The ASP.NET Core gRPC framework writes detailed diagnostic logging messages to this logging framework, so they can be processed and stored along with your application's own messages.</span></span>

### <a name="produce-log-messages"></a><span data-ttu-id="ae64d-124">Produzir mensagens de log</span><span class="sxs-lookup"><span data-stu-id="ae64d-124">Produce log messages</span></span>

<span data-ttu-id="ae64d-125">A extensão de log é automaticamente registrada com o sistema de injeção de dependência ASP.NET Core, para que você possa especificar os agentes como um parâmetro de Construtor em tipos de serviço gRPC.</span><span class="sxs-lookup"><span data-stu-id="ae64d-125">The logging extension is automatically registered with ASP.NET Core's dependency injection system, so you can specify loggers as a constructor parameter on gRPC service types.</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private readonly ILogger<StockData> _logger;

    public StockData(ILogger<StockData> logger)
    {
        _logger = logger;
    }
}
```

<span data-ttu-id="ae64d-126">Muitas mensagens de log, como solicitações e exceções, são fornecidas pelos componentes ASP.NET Core e gRPC Framework.</span><span class="sxs-lookup"><span data-stu-id="ae64d-126">Many log messages, such as requests and exceptions, are provided by the ASP.NET Core and gRPC framework components.</span></span> <span data-ttu-id="ae64d-127">Adicione suas próprias mensagens de log para fornecer detalhes e contexto sobre a lógica do aplicativo, em vez de preocupações de nível inferior.</span><span class="sxs-lookup"><span data-stu-id="ae64d-127">Add your own log messages to provide detail and context about application logic, rather than lower-level concerns.</span></span>

<span data-ttu-id="ae64d-128">Para obter mais informações sobre como gravar mensagens de log e destinos e coletores de log disponíveis, consulte [Logging in .NET Core and ASP.NET Core](/aspnet/core/fundamentals/logging/).</span><span class="sxs-lookup"><span data-stu-id="ae64d-128">For more information about writing log messages and available logging sinks and targets, see  [Logging in .NET Core and ASP.NET Core](/aspnet/core/fundamentals/logging/).</span></span>

## <a name="metrics-in-aspnet-core-grpc"></a><span data-ttu-id="ae64d-129">Métricas no ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="ae64d-129">Metrics in ASP.NET Core gRPC</span></span>

<span data-ttu-id="ae64d-130">O tempo de execução do .NET Core fornece um conjunto de componentes para emitir e observar métricas.</span><span class="sxs-lookup"><span data-stu-id="ae64d-130">The .NET Core runtime provides a set of components for emitting and observing metrics.</span></span> <span data-ttu-id="ae64d-131">Isso inclui APIs como as classes <xref:System.Diagnostics.Tracing.EventSource> e <xref:System.Diagnostics.Tracing.EventCounter>.</span><span class="sxs-lookup"><span data-stu-id="ae64d-131">These include APIs such as the <xref:System.Diagnostics.Tracing.EventSource> and <xref:System.Diagnostics.Tracing.EventCounter> classes.</span></span> <span data-ttu-id="ae64d-132">Essas APIs podem emitir dados numéricos básicos que podem ser consumidos por processos externos, como a [ferramenta global dotnet-Counters](../../core/diagnostics/dotnet-counters.md)ou o rastreamento de eventos para Windows.</span><span class="sxs-lookup"><span data-stu-id="ae64d-132">These APIs can emit basic numeric data that can be consumed by external processes, like the [dotnet-counters global tool](../../core/diagnostics/dotnet-counters.md), or Event Tracing for Windows.</span></span> <span data-ttu-id="ae64d-133">Para obter mais informações sobre como usar `EventCounter` em seu próprio código, consulte [introdução ao EventCounter](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md).</span><span class="sxs-lookup"><span data-stu-id="ae64d-133">For more information about using `EventCounter` in your own code, see [EventCounter introduction](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md).</span></span>

<span data-ttu-id="ae64d-134">Para obter métricas mais avançadas e gravar dados de métrica em uma maior variedade de armazenamentos de dados, você pode tentar um projeto de código-fonte aberto chamado [métricas de aplicativo](https://www.app-metrics.io).</span><span class="sxs-lookup"><span data-stu-id="ae64d-134">For more advanced metrics and for writing metric data to a wider range of data stores, you might try an open-source project called [App Metrics](https://www.app-metrics.io).</span></span> <span data-ttu-id="ae64d-135">Esse conjunto de bibliotecas fornece um amplo conjunto de tipos para instrumentar seu código.</span><span class="sxs-lookup"><span data-stu-id="ae64d-135">This suite of libraries provides an extensive set of types to instrument your code.</span></span> <span data-ttu-id="ae64d-136">Ele também oferece pacotes para gravar métricas em diferentes tipos de destinos que incluem bancos de dados de série temporal, como Prometheus e InfluxDB, e [Application insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="ae64d-136">It also offers packages to write metrics to different kinds of targets that include time-series databases, such as Prometheus and InfluxDB, and [Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview).</span></span> <span data-ttu-id="ae64d-137">O pacote NuGet [app. Metrics. AspNetCore. Mvc](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) , inclusive, adiciona um conjunto abrangente de métricas básicas que são geradas automaticamente por meio da integração com o ASP.NET Core Framework.</span><span class="sxs-lookup"><span data-stu-id="ae64d-137">The [App.Metrics.AspNetCore.Mvc](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) NuGet package even adds a comprehensive set of basic metrics that are automatically generated via integration with the ASP.NET Core framework.</span></span> <span data-ttu-id="ae64d-138">O site do projeto fornece [modelos](https://www.app-metrics.io/samples/grafana/) para exibir essas métricas com a plataforma de visualização [Grafana](https://grafana.com/) .</span><span class="sxs-lookup"><span data-stu-id="ae64d-138">The project website provides [templates](https://www.app-metrics.io/samples/grafana/) for displaying those metrics with the [Grafana](https://grafana.com/) visualization platform.</span></span>

### <a name="produce-metrics"></a><span data-ttu-id="ae64d-139">Produzir métricas</span><span class="sxs-lookup"><span data-stu-id="ae64d-139">Produce metrics</span></span>

<span data-ttu-id="ae64d-140">A maioria das plataformas de métricas oferece suporte aos seguintes tipos:</span><span class="sxs-lookup"><span data-stu-id="ae64d-140">Most metrics platforms support the following types:</span></span>

| <span data-ttu-id="ae64d-141">Tipo de métrica</span><span class="sxs-lookup"><span data-stu-id="ae64d-141">Metric type</span></span> | <span data-ttu-id="ae64d-142">Descrição</span><span class="sxs-lookup"><span data-stu-id="ae64d-142">Description</span></span> |
| ----------- | ----------- |
| <span data-ttu-id="ae64d-143">Contador</span><span class="sxs-lookup"><span data-stu-id="ae64d-143">Counter</span></span>     | <span data-ttu-id="ae64d-144">Controla com que frequência algo acontece, como solicitações e erros.</span><span class="sxs-lookup"><span data-stu-id="ae64d-144">Tracks how often something happens, such as requests and errors.</span></span> |
| <span data-ttu-id="ae64d-145">Medidor</span><span class="sxs-lookup"><span data-stu-id="ae64d-145">Gauge</span></span>       | <span data-ttu-id="ae64d-146">Registra um único valor que muda ao longo do tempo, como conexões ativas.</span><span class="sxs-lookup"><span data-stu-id="ae64d-146">Records a single value that changes over time, such as active connections.</span></span> |
| <span data-ttu-id="ae64d-147">Histograma</span><span class="sxs-lookup"><span data-stu-id="ae64d-147">Histogram</span></span>   | <span data-ttu-id="ae64d-148">Mede uma distribuição de valores entre limites arbitrários.</span><span class="sxs-lookup"><span data-stu-id="ae64d-148">Measures a distribution of values across arbitrary limits.</span></span> <span data-ttu-id="ae64d-149">Por exemplo, um histograma pode acompanhar o tamanho do conjunto de registros, contando quantas continham 10 <, quantos registros continham 11-100, quantos registros de 101-1000 continham e quantos registros contidos > 1000.</span><span class="sxs-lookup"><span data-stu-id="ae64d-149">For example, a histogram can track dataset size, counting how many contained <10 records, how many contained 11-100 records, how many contained 101-1000 records, and how many contained >1000 records.</span></span> |
| <span data-ttu-id="ae64d-150">Medidor</span><span class="sxs-lookup"><span data-stu-id="ae64d-150">Meter</span></span>       | <span data-ttu-id="ae64d-151">Mede a taxa na qual um evento ocorre em vários intervalos de tempo.</span><span class="sxs-lookup"><span data-stu-id="ae64d-151">Measures the rate at which an event occurs in various time spans.</span></span> |
| <span data-ttu-id="ae64d-152">{1&gt;Timer&lt;1}</span><span class="sxs-lookup"><span data-stu-id="ae64d-152">Timer</span></span>       | <span data-ttu-id="ae64d-153">Controla a duração de eventos e a taxa na qual ele ocorre, armazenado como um histograma.</span><span class="sxs-lookup"><span data-stu-id="ae64d-153">Tracks the duration of events and the rate at which it occurs, stored as a histogram.</span></span> |

<span data-ttu-id="ae64d-154">Usando as *métricas de aplicativo*, uma interface `IMetrics` pode ser obtida por meio de injeção de dependência e usada para registrar qualquer uma dessas métricas para um serviço gRPC.</span><span class="sxs-lookup"><span data-stu-id="ae64d-154">By using *App Metrics*, an `IMetrics` interface can be obtained via dependency injection, and used to record any of these metrics for a gRPC service.</span></span> <span data-ttu-id="ae64d-155">O exemplo a seguir mostra como contar o número de solicitações de `Get` feitas ao longo do tempo:</span><span class="sxs-lookup"><span data-stu-id="ae64d-155">The following example shows how to count the number of `Get` requests made over time:</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private static readonly CounterOptions GetRequestCounter = new CounterOptions
    {
        Name = "StockData_Get_Requests",
        MeasurementUnit = Unit.Calls
    };

    private readonly IStockRepository _repository;
    private readonly IMetrics _metrics;

    public StockData(IStockRepository repository, IMetrics metrics)
    {
        _repository = repository;
        _metrics = metrics;
    }

    public override async Task<GetResponse> Get(GetRequest request, ServerCallContext context)
    {
        _metrics.Measure.Counter.Increment(GetRequestCounter);

        // Serve request...
    }
}
```

### <a name="store-and-visualize-metrics-data"></a><span data-ttu-id="ae64d-156">Armazenar e Visualizar dados de métricas</span><span class="sxs-lookup"><span data-stu-id="ae64d-156">Store and visualize metrics data</span></span>

<span data-ttu-id="ae64d-157">A melhor maneira de armazenar dados de métricas está em um banco de dados de série temporal, um armazenamento de dado especializado criado para registrar séries de dados numéricas marcadas com carimbos de data */hora*.</span><span class="sxs-lookup"><span data-stu-id="ae64d-157">The best way to store metrics data is in a *time-series database*, a specialized data store designed to record numerical data series marked with timestamps.</span></span> <span data-ttu-id="ae64d-158">Os bancos de dados mais populares são [Prometheus](https://prometheus.io/) e [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span><span class="sxs-lookup"><span data-stu-id="ae64d-158">The most popular of these databases are [Prometheus](https://prometheus.io/) and [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span></span> <span data-ttu-id="ae64d-159">O Microsoft Azure também fornece armazenamento de métricas dedicado por meio do serviço de [Azure monitor](https://docs.microsoft.com/azure/azure-monitor/overview) .</span><span class="sxs-lookup"><span data-stu-id="ae64d-159">Microsoft Azure also provides dedicated metrics storage through the [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) service.</span></span>

<span data-ttu-id="ae64d-160">A solução atual para visualização de dados de métricas é [Grafana](https://grafana.com), que funciona com uma ampla variedade de provedores de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="ae64d-160">The current go-to solution for visualizing metrics data is [Grafana](https://grafana.com), which works with a wide range of storage providers.</span></span> <span data-ttu-id="ae64d-161">A imagem a seguir mostra um painel Grafana de exemplo que exibe as métricas da malha do serviço Linkerd que executa o exemplo StockData:</span><span class="sxs-lookup"><span data-stu-id="ae64d-161">The following image shows an example Grafana dashboard that displays metrics from the Linkerd service mesh running the StockData sample:</span></span>

![Captura de tela do painel do Grafana](media/application-performance-management/grafana-screenshot.png)

### <a name="metrics-based-alerting"></a><span data-ttu-id="ae64d-163">Alertas baseados em métricas</span><span class="sxs-lookup"><span data-stu-id="ae64d-163">Metrics-based alerting</span></span>

<span data-ttu-id="ae64d-164">A natureza numérica dos dados de métricas significa que ele é ideal para impulsionar sistemas de alerta, notificando os desenvolvedores ou engenheiros de suporte quando um valor cai fora de alguma tolerância definida.</span><span class="sxs-lookup"><span data-stu-id="ae64d-164">The numerical nature of metrics data means that it's ideally suited to drive alerting systems, notifying developers or support engineers when a value falls outside of some defined tolerance.</span></span> <span data-ttu-id="ae64d-165">Todas as plataformas já mencionadas fornecem suporte para alertas por meio de uma variedade de opções, incluindo emails, mensagens de texto ou visualizações no painel.</span><span class="sxs-lookup"><span data-stu-id="ae64d-165">The platforms already mentioned all provide support for alerting via a range of options, including emails, text messages, or in-dashboard visualizations.</span></span>

## <a name="distributed-tracing"></a><span data-ttu-id="ae64d-166">Rastreamento distribuído</span><span class="sxs-lookup"><span data-stu-id="ae64d-166">Distributed tracing</span></span>

<span data-ttu-id="ae64d-167">O rastreamento distribuído é um desenvolvimento relativamente recente no monitoramento, que tem surgido do uso crescente de microserviços e arquiteturas distribuídas.</span><span class="sxs-lookup"><span data-stu-id="ae64d-167">Distributed tracing is a relatively recent development in monitoring, which has arisen from the increasing use of microservices and distributed architectures.</span></span> <span data-ttu-id="ae64d-168">Uma única solicitação de um navegador cliente, aplicativo ou dispositivo pode ser dividida em várias etapas e subsolicitaçãos e envolve o uso de muitos serviços em uma rede.</span><span class="sxs-lookup"><span data-stu-id="ae64d-168">A single request from a client browser, application, or device can be broken down into many steps and sub-requests, and involve the use of many services across a network.</span></span> <span data-ttu-id="ae64d-169">Isso dificulta a correlação de mensagens de log e métricas com a solicitação específica que as disparou.</span><span class="sxs-lookup"><span data-stu-id="ae64d-169">This makes it difficult to correlate log messages and metrics with the specific request that triggered them.</span></span> <span data-ttu-id="ae64d-170">O rastreamento distribuído aplica identificadores a solicitações, e isso permite que os logs e as métricas sejam correlacionados a uma operação específica.</span><span class="sxs-lookup"><span data-stu-id="ae64d-170">Distributed tracing applies identifiers to requests, and this allows logs and metrics to be correlated with a particular operation.</span></span> <span data-ttu-id="ae64d-171">Isso é semelhante ao [rastreamento de ponta a ponta do WCF](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md), mas é aplicado em várias plataformas.</span><span class="sxs-lookup"><span data-stu-id="ae64d-171">This is similar to [WCF's end-to-end tracing](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md), but it's applied across multiple platforms.</span></span>

<span data-ttu-id="ae64d-172">O rastreamento distribuído cresceu rapidamente em popularidade e está começando a padronizar.</span><span class="sxs-lookup"><span data-stu-id="ae64d-172">Distributed tracing has grown quickly in popularity and is beginning to standardize.</span></span> <span data-ttu-id="ae64d-173">A base de computação nativa da nuvem criou o [padrão de rastreamento aberto](https://opentracing.io), tentando fornecer bibliotecas neutras ao fornecedor para trabalhar com back-ends, como [Jaeger](https://www.jaegertracing.io/) e o [APM elástico](https://www.elastic.co/products/apm).</span><span class="sxs-lookup"><span data-stu-id="ae64d-173">The Cloud Native Computing Foundation created the [the Open Tracing standard](https://opentracing.io), attempting to provide vendor-neutral libraries for working with back ends like [Jaeger](https://www.jaegertracing.io/) and [Elastic APM](https://www.elastic.co/products/apm).</span></span> <span data-ttu-id="ae64d-174">Ao mesmo tempo, o Google criou o [projeto OpenCensus](https://opencensus.io/) para abordar o mesmo conjunto de problemas.</span><span class="sxs-lookup"><span data-stu-id="ae64d-174">At the same time, Google created the [OpenCensus project](https://opencensus.io/) to address the same set of problems.</span></span> <span data-ttu-id="ae64d-175">Esses dois projetos estão se mesclando em um novo projeto, [OpenTelemetry](https://opentelemetry.io), que visa ser o padrão do setor do futuro.</span><span class="sxs-lookup"><span data-stu-id="ae64d-175">These two projects are merging into a new project, [OpenTelemetry](https://opentelemetry.io), which aims to be the industry standard of the future.</span></span>

### <a name="how-distributed-tracing-works"></a><span data-ttu-id="ae64d-176">Como funciona o rastreamento distribuído</span><span class="sxs-lookup"><span data-stu-id="ae64d-176">How distributed tracing works</span></span>

<span data-ttu-id="ae64d-177">O rastreamento distribuído baseia-se no conceito de *spans*: operações nomeadas e oportunas que fazem parte de um único *rastreamento*, o que pode envolver o processamento em vários nós de um sistema.</span><span class="sxs-lookup"><span data-stu-id="ae64d-177">Distributed tracing is based on the concept of *spans*: named, timed operations that are part of a single *trace*, which can involve processing on multiple nodes of a system.</span></span> <span data-ttu-id="ae64d-178">Quando uma nova operação é iniciada, um rastreamento é criado com um identificador exclusivo.</span><span class="sxs-lookup"><span data-stu-id="ae64d-178">When a new operation is initiated, a trace is created with a unique identifier.</span></span> <span data-ttu-id="ae64d-179">Para cada suboperação, um Span é criado com seu próprio identificador e identificador de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="ae64d-179">For each sub-operation, a span is created with its own identifier and trace identifier.</span></span> <span data-ttu-id="ae64d-180">À medida que a solicitação passa pelo sistema, vários componentes podem criar spans *filho* que incluem o identificador de seu *pai*.</span><span class="sxs-lookup"><span data-stu-id="ae64d-180">As the request passes around the system, various components can create *child* spans that include the identifier of their *parent*.</span></span> <span data-ttu-id="ae64d-181">Um Span tem um *contexto*, que contém os identificadores de rastreamento e de span, bem como dados úteis na forma de pares de chave e valor (chamados de *bagagem*).</span><span class="sxs-lookup"><span data-stu-id="ae64d-181">A span has a *context*, which contains the trace and span identifiers, as well as useful data in the form of key and value pairs (called *baggage*).</span></span>

### <a name="distributed-tracing-with-diagnosticsource"></a><span data-ttu-id="ae64d-182">Rastreamento distribuído com `DiagnosticSource`</span><span class="sxs-lookup"><span data-stu-id="ae64d-182">Distributed tracing with `DiagnosticSource`</span></span>

<span data-ttu-id="ae64d-183">O .NET Core tem um módulo interno que mapeia bem para rastreamentos distribuídos e abrange: [diagnosticname](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span><span class="sxs-lookup"><span data-stu-id="ae64d-183">.NET Core has an internal module that maps well to distributed traces and spans: [DiagnosticSource](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span></span> <span data-ttu-id="ae64d-184">Além de fornecer uma maneira simples de produzir e consumir diagnósticos em um processo, o módulo `DiagnosticSource` tem o conceito de uma *atividade*.</span><span class="sxs-lookup"><span data-stu-id="ae64d-184">As well as providing a simple way to produce and consume diagnostics within a process, the `DiagnosticSource` module has the concept of an *activity*.</span></span> <span data-ttu-id="ae64d-185">Uma atividade é efetivamente uma implementação de um rastreamento distribuído ou um intervalo dentro de um rastreamento.</span><span class="sxs-lookup"><span data-stu-id="ae64d-185">An activity is effectively an implementation of a distributed trace, or a span within a trace.</span></span> <span data-ttu-id="ae64d-186">Os elementos internos do módulo cuidam das atividades pai/filho, incluindo a alocação de identificadores.</span><span class="sxs-lookup"><span data-stu-id="ae64d-186">The internals of the module take care of parent/child activities, including allocating identifiers.</span></span> <span data-ttu-id="ae64d-187">Para obter mais informações sobre como usar o tipo de `Activity`, consulte o [Guia do usuário da atividade no GitHub](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide).</span><span class="sxs-lookup"><span data-stu-id="ae64d-187">For more information about using the `Activity` type, see the [Activity User Guide on GitHub](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide).</span></span>

<span data-ttu-id="ae64d-188">Como `DiagnosticSource` faz parte da estrutura principal, há suporte para vários componentes principais.</span><span class="sxs-lookup"><span data-stu-id="ae64d-188">Because `DiagnosticSource` is a part of the core framework, it's supported by several core components.</span></span> <span data-ttu-id="ae64d-189">Isso inclui <xref:System.Net.Http.HttpClient>, Entity Framework Core e ASP.NET Core, incluindo suporte explícito na estrutura gRPC.</span><span class="sxs-lookup"><span data-stu-id="ae64d-189">These include <xref:System.Net.Http.HttpClient>, Entity Framework Core, and ASP.NET Core, including explicit support in the gRPC framework.</span></span> <span data-ttu-id="ae64d-190">Quando ASP.NET Core recebe uma solicitação, ele verifica um par de cabeçalhos HTTP que correspondem ao padrão de [contexto de rastreamento W3C](https://www.w3.org/TR/trace-context) .</span><span class="sxs-lookup"><span data-stu-id="ae64d-190">When ASP.NET Core receives a request, it checks for a pair of HTTP headers matching the [W3C Trace Context](https://www.w3.org/TR/trace-context) standard.</span></span> <span data-ttu-id="ae64d-191">Se os cabeçalhos forem encontrados, uma atividade será iniciada usando os valores de identidade e o contexto dos cabeçalhos.</span><span class="sxs-lookup"><span data-stu-id="ae64d-191">If the headers are found, an activity is started by using the identity values and context from the headers.</span></span> <span data-ttu-id="ae64d-192">Se nenhum cabeçalho for encontrado, uma atividade será iniciada com valores de identidade gerados que correspondam ao formato padrão.</span><span class="sxs-lookup"><span data-stu-id="ae64d-192">If no headers are found, an activity is started with generated identity values that match the standard format.</span></span> <span data-ttu-id="ae64d-193">Qualquer diagnóstico gerado pela estrutura ou pelo código do aplicativo durante o tempo de vida dessa atividade pode ser marcado com os identificadores de rastreamento e span.</span><span class="sxs-lookup"><span data-stu-id="ae64d-193">Any diagnostics generated by the framework or by application code during the lifetime of this activity can be tagged with the trace and span identifiers.</span></span> <span data-ttu-id="ae64d-194">O suporte a `HttpClient` estende isso mais tarde, verificando se há uma atividade atual em cada solicitação e adicionando automaticamente os cabeçalhos de rastreamento à solicitação de saída.</span><span class="sxs-lookup"><span data-stu-id="ae64d-194">The `HttpClient` support extends this further by checking for a current activity on every request, and automatically adding the trace headers to the outgoing request.</span></span>

<span data-ttu-id="ae64d-195">As bibliotecas de cliente e servidor do ASP.NET Core gRPC incluem suporte explícito para `DiagnosticSource` e `Activity`, além de criar atividades e aplicar e usar informações de cabeçalho automaticamente.</span><span class="sxs-lookup"><span data-stu-id="ae64d-195">The ASP.NET Core gRPC client and server libraries include explicit support for `DiagnosticSource` and `Activity`, and create activities and apply and use header information automatically.</span></span>

> [!NOTE]
> <span data-ttu-id="ae64d-196">Tudo isso ocorre apenas se um ouvinte estiver consumindo as informações de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="ae64d-196">All of this happens only if a listener is consuming the diagnostic information.</span></span> <span data-ttu-id="ae64d-197">Se não houver um ouvinte, nenhum diagnóstico será gravado e nenhuma atividade será criada.</span><span class="sxs-lookup"><span data-stu-id="ae64d-197">If there's no listener, no diagnostics are written and no activities are created.</span></span>

### <a name="add-your-own-diagnosticsource-and-activity"></a><span data-ttu-id="ae64d-198">Adicione seu próprio `DiagnosticSource` e `Activity`</span><span class="sxs-lookup"><span data-stu-id="ae64d-198">Add your own `DiagnosticSource` and `Activity`</span></span>

<span data-ttu-id="ae64d-199">Para adicionar seu próprio diagnóstico ou criar spans explícitos dentro do código do aplicativo, consulte o [Guia do usuário do diagnosticm](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) e o [Guia do usuário da atividade](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage).</span><span class="sxs-lookup"><span data-stu-id="ae64d-199">To add your own diagnostics or create explicit spans within your application code, see the [DiagnosticSource User Guide](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) and [Activity User Guide](https://github.com/dotnet/runtime/blob/master/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage).</span></span>

### <a name="store-distributed-trace-data"></a><span data-ttu-id="ae64d-200">Armazenar dados de rastreamento distribuído</span><span class="sxs-lookup"><span data-stu-id="ae64d-200">Store distributed trace data</span></span>

<span data-ttu-id="ae64d-201">No momento da gravação, o projeto OpenTelemetry ainda está nos estágios iniciais e somente os pacotes de qualidade alfa estão disponíveis para aplicativos .NET.</span><span class="sxs-lookup"><span data-stu-id="ae64d-201">At the time of writing, the OpenTelemetry project is still in the early stages, and only alpha-quality packages are available for .NET applications.</span></span> <span data-ttu-id="ae64d-202">O projeto OpenTracing atualmente oferece bibliotecas mais maduras.</span><span class="sxs-lookup"><span data-stu-id="ae64d-202">The OpenTracing project currently offers more mature libraries.</span></span>

<span data-ttu-id="ae64d-203">A API OpenTracing é descrita na seção a seguir.</span><span class="sxs-lookup"><span data-stu-id="ae64d-203">The OpenTracing API is described in the following section.</span></span> <span data-ttu-id="ae64d-204">Se você quiser usar a API OpenTelemetry em seu aplicativo em vez disso, consulte o [repositório do SDK do .net do OpenTelemetry](https://github.com/open-telemetry/opentelemetry-dotnet) no github.</span><span class="sxs-lookup"><span data-stu-id="ae64d-204">If you want to use the OpenTelemetry API in your application instead, refer to the [OpenTelemetry .NET SDK repository](https://github.com/open-telemetry/opentelemetry-dotnet) on GitHub.</span></span>

#### <a name="use-the-opentracing-package-to-store-distributed-trace-data"></a><span data-ttu-id="ae64d-205">Usar o pacote OpenTracing para armazenar dados de rastreamento distribuídos</span><span class="sxs-lookup"><span data-stu-id="ae64d-205">Use the OpenTracing package to store distributed trace data</span></span>

<span data-ttu-id="ae64d-206">O [pacote NuGet OpenTracing](https://www.nuget.org/packages/OpenTracing/) dá suporte a todos os back-ends compatíveis com OpenTracing (que podem ser usados independentemente do `DiagnosticSource`).</span><span class="sxs-lookup"><span data-stu-id="ae64d-206">The [OpenTracing NuGet package](https://www.nuget.org/packages/OpenTracing/) supports all OpenTracing-compliant back ends (which can be used independently of `DiagnosticSource`).</span></span> <span data-ttu-id="ae64d-207">Há um pacote adicional do projeto de contribuições da API do OpenTracing, [OpenTracing. contrib. NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/).</span><span class="sxs-lookup"><span data-stu-id="ae64d-207">There's an additional package from the OpenTracing API Contributions project, [OpenTracing.Contrib.NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/).</span></span> <span data-ttu-id="ae64d-208">Esse pacote adiciona um ouvinte de `DiagnosticSource` e grava eventos e atividades em um back-end automaticamente.</span><span class="sxs-lookup"><span data-stu-id="ae64d-208">This package adds a `DiagnosticSource` listener, and writes events and activities to a back end automatically.</span></span> <span data-ttu-id="ae64d-209">Habilitar esse pacote é tão simples quanto instalá-lo do NuGet e adicioná-lo como um serviço em sua classe de `Startup`.</span><span class="sxs-lookup"><span data-stu-id="ae64d-209">Enabling this package is as simple as installing it from NuGet and adding it as a service in your `Startup` class.</span></span>

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddOpenTracing();
    }
}
```

<span data-ttu-id="ae64d-210">O pacote OpenTracing é uma camada de abstração e, como tal, requer implementação específica para o back-end.</span><span class="sxs-lookup"><span data-stu-id="ae64d-210">The OpenTracing package is an abstraction layer, and as such it requires implementation specific to the back end.</span></span> <span data-ttu-id="ae64d-211">As implementações da API OpenTracing estão disponíveis para os seguintes back-ends de software livre.</span><span class="sxs-lookup"><span data-stu-id="ae64d-211">OpenTracing API implementations are available for the following open source back ends.</span></span>

| <span data-ttu-id="ae64d-212">Name</span><span class="sxs-lookup"><span data-stu-id="ae64d-212">Name</span></span> | <span data-ttu-id="ae64d-213">Pacote</span><span class="sxs-lookup"><span data-stu-id="ae64d-213">Package</span></span> | <span data-ttu-id="ae64d-214">Site da Web</span><span class="sxs-lookup"><span data-stu-id="ae64d-214">Website</span></span> |
| ---- | ------- | -------- |
| <span data-ttu-id="ae64d-215">Jaeger</span><span class="sxs-lookup"><span data-stu-id="ae64d-215">Jaeger</span></span> | [<span data-ttu-id="ae64d-216">Jaeger</span><span class="sxs-lookup"><span data-stu-id="ae64d-216">Jaeger</span></span>](https://www.nuget.org/packages/Jaeger/) | [<span data-ttu-id="ae64d-217">jaegertracing.io</span><span class="sxs-lookup"><span data-stu-id="ae64d-217">jaegertracing.io</span></span>](https://jaegertracing.io) |
| <span data-ttu-id="ae64d-218">APM elástico</span><span class="sxs-lookup"><span data-stu-id="ae64d-218">Elastic APM</span></span> | [<span data-ttu-id="ae64d-219">Elástico. APM. NetCoreAll</span><span class="sxs-lookup"><span data-stu-id="ae64d-219">Elastic.Apm.NetCoreAll</span></span>](https://www.nuget.org/packages/Elastic.Apm.NetCoreAll/) | [<span data-ttu-id="ae64d-220">elastic.co/products/apm</span><span class="sxs-lookup"><span data-stu-id="ae64d-220">elastic.co/products/apm</span></span>](https://www.elastic.co/products/apm) |

<span data-ttu-id="ae64d-221">Para obter mais informações sobre a API do OpenTracing para .net, consulte os repositórios [OpenTracing for C# ](https://github.com/opentracing/opentracing-csharp) e [OpenTracing C#contrib/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) no github.</span><span class="sxs-lookup"><span data-stu-id="ae64d-221">For more information on the OpenTracing API for .NET, see the [OpenTracing for C#](https://github.com/opentracing/opentracing-csharp) and the [OpenTracing Contrib C#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) repositories on GitHub.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="ae64d-222">[Anterior](load-balancing.md)
>[Próximo](appendix.md)</span><span class="sxs-lookup"><span data-stu-id="ae64d-222">[Previous](load-balancing.md)
[Next](appendix.md)</span></span>
