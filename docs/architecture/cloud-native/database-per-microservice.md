---
title: Banco de dados por microsserviço
description: Contraste o armazenamento de dados em aplicativos monolíticos e nativos da nuvem.
author: robvet
ms.date: 01/22/2020
ms.openlocfilehash: c0c5611fa866d70f155e4bdad2eee1181b13c065
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/12/2020
ms.locfileid: "79141439"
---
# <a name="database-per-microservice"></a><span data-ttu-id="203d2-103">Banco de dados por microsserviço</span><span class="sxs-lookup"><span data-stu-id="203d2-103">Database-per-microservice</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="203d2-104">Como vimos ao longo deste livro, uma abordagem nativa da nuvem muda a maneira como você projeta, implanta e gerencia aplicativos.</span><span class="sxs-lookup"><span data-stu-id="203d2-104">As we've seen throughout this book, a cloud-native approach changes the way you design, deploy, and manage applications.</span></span> <span data-ttu-id="203d2-105">Também muda a forma como você gerencia e armazena dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-105">It also changes the way you manage and store data.</span></span>

<span data-ttu-id="203d2-106">A Figura 5-1 contrasta as diferenças.</span><span class="sxs-lookup"><span data-stu-id="203d2-106">Figure 5-1 contrasts the differences.</span></span>

![Armazenamento de dados em aplicativos nativos da nuvem](./media/distributed-data.png)

<span data-ttu-id="203d2-108">**Figura 5-1**.</span><span class="sxs-lookup"><span data-stu-id="203d2-108">**Figure 5-1**.</span></span> <span data-ttu-id="203d2-109">Gerenciamento de dados em aplicativos nativos da nuvem</span><span class="sxs-lookup"><span data-stu-id="203d2-109">Data management in cloud-native applications</span></span>

<span data-ttu-id="203d2-110">Desenvolvedores experientes reconhecerão facilmente a arquitetura no lado esquerdo da figura 5-1.</span><span class="sxs-lookup"><span data-stu-id="203d2-110">Experienced developers will easily recognize the architecture on the left-side of figure 5-1.</span></span> <span data-ttu-id="203d2-111">Nesta *aplicação monolítica,* os componentes de serviços de negócios se agrupam em um nível de serviços compartilhados, compartilhando dados de um único banco de dados relacional.</span><span class="sxs-lookup"><span data-stu-id="203d2-111">In this *monolithic application*, business service components collocate together in a shared services tier, sharing data from a single relational database.</span></span>

<span data-ttu-id="203d2-112">Em muitos aspectos, um único banco de dados mantém o gerenciamento de dados simples.</span><span class="sxs-lookup"><span data-stu-id="203d2-112">In many ways, a single database keeps data management simple.</span></span> <span data-ttu-id="203d2-113">Consultar dados em várias tabelas é simples.</span><span class="sxs-lookup"><span data-stu-id="203d2-113">Querying data across multiple tables is straightforward.</span></span> <span data-ttu-id="203d2-114">Alterações na atualização de dados em conjunto ou todas elas reversão.</span><span class="sxs-lookup"><span data-stu-id="203d2-114">Changes to data update together or they all rollback.</span></span> <span data-ttu-id="203d2-115">[As transações ACID](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) garantem consistência forte e imediata.</span><span class="sxs-lookup"><span data-stu-id="203d2-115">[ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarantee strong and immediate consistency.</span></span>

<span data-ttu-id="203d2-116">Projetando para nativos da nuvem, tomamos uma abordagem diferente.</span><span class="sxs-lookup"><span data-stu-id="203d2-116">Designing for cloud-native, we take a different approach.</span></span> <span data-ttu-id="203d2-117">No lado direito da Figura 5-1, observe como a funcionalidade do negócio se segrega em microsserviços pequenos e independentes.</span><span class="sxs-lookup"><span data-stu-id="203d2-117">On the right-side of Figure 5-1, note how business functionality segregates into small, independent microservices.</span></span> <span data-ttu-id="203d2-118">Cada microserviço encapsula uma capacidade de negócios específica e seus próprios dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-118">Each microservice encapsulates a specific business capability and its own data.</span></span> <span data-ttu-id="203d2-119">O banco de dados monolítico se decompõe em um modelo de dados distribuídos com muitos bancos de dados menores, cada um alinhado a um microserviço.</span><span class="sxs-lookup"><span data-stu-id="203d2-119">The monolithic database decomposes into a distributed data model with many smaller databases, each aligning with a microservice.</span></span> <span data-ttu-id="203d2-120">Quando a fumaça se dissipa, emergimos com um design que expõe um *banco de dados por microserviço.*</span><span class="sxs-lookup"><span data-stu-id="203d2-120">When the smoke clears, we emerge with a design that exposes a *database per microservice*.</span></span>

## <a name="why"></a><span data-ttu-id="203d2-121">Por quê?</span><span class="sxs-lookup"><span data-stu-id="203d2-121">Why?</span></span>

<span data-ttu-id="203d2-122">Este banco de dados por microserviço oferece muitos benefícios, especialmente para sistemas que devem evoluir rapidamente e suportar escala maciça.</span><span class="sxs-lookup"><span data-stu-id="203d2-122">This database per microservice provides many benefits, especially for systems that must evolve rapidly and support massive scale.</span></span> <span data-ttu-id="203d2-123">Com este modelo...</span><span class="sxs-lookup"><span data-stu-id="203d2-123">With this model...</span></span>

- <span data-ttu-id="203d2-124">Os dados de domínio são encapsulados dentro do serviço</span><span class="sxs-lookup"><span data-stu-id="203d2-124">Domain data is encapsulated within the service</span></span>
- <span data-ttu-id="203d2-125">Esquema de dados pode evoluir sem impactar diretamente outros serviços</span><span class="sxs-lookup"><span data-stu-id="203d2-125">Data schema can evolve without directly impacting other services</span></span>
- <span data-ttu-id="203d2-126">Cada armazenamento de dados pode dimensionar independentemente</span><span class="sxs-lookup"><span data-stu-id="203d2-126">Each data store can independently scale</span></span>
- <span data-ttu-id="203d2-127">Uma falha no armazenamento de dados em um serviço não afetará diretamente outros serviços</span><span class="sxs-lookup"><span data-stu-id="203d2-127">A data store failure in one service won't directly impact other services</span></span>

<span data-ttu-id="203d2-128">A segregação de dados também permite que cada microserviço implemente o tipo de armazenamento de dados que é melhor otimizado para sua carga de trabalho, necessidades de armazenamento e padrões de leitura/gravação.</span><span class="sxs-lookup"><span data-stu-id="203d2-128">Segregating data also enables each microservice to implement the data store type that is best optimized for its workload, storage needs, and read/write patterns.</span></span> <span data-ttu-id="203d2-129">As opções incluem armazenamentos de dados relacionais, documentos, de valor-chave e até mesmo de gráficos.</span><span class="sxs-lookup"><span data-stu-id="203d2-129">Choices include relational, document, key-value, and even graph-based data stores.</span></span>

<span data-ttu-id="203d2-130">A Figura 5-2 apresenta o princípio da persistência do poliglota em um sistema nativo da nuvem.</span><span class="sxs-lookup"><span data-stu-id="203d2-130">Figure 5-2 presents the principle of polyglot persistence in a cloud-native system.</span></span>

![Persistência de dados poliglotas](./media/polyglot-data-persistence.png)

<span data-ttu-id="203d2-132">**Figura 5-2**.</span><span class="sxs-lookup"><span data-stu-id="203d2-132">**Figure 5-2**.</span></span> <span data-ttu-id="203d2-133">Persistência de dados poliglotas</span><span class="sxs-lookup"><span data-stu-id="203d2-133">Polyglot data persistence</span></span>

<span data-ttu-id="203d2-134">Observe na figura anterior como cada microserviço suporta um tipo diferente de armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-134">Note in the previous figure how each microservice supports a different type of data store.</span></span>

- <span data-ttu-id="203d2-135">O microserviço do catálogo de produtos consome um banco de dados relacional para acomodar a rica estrutura relacional de seus dados subjacentes.</span><span class="sxs-lookup"><span data-stu-id="203d2-135">The product catalog microservice consumes a relational database to accommodate the rich relational structure of its underlying data.</span></span>
- <span data-ttu-id="203d2-136">O microserviço do carrinho de compras consome um cache distribuído que suporta seu simples armazenamento de dados de valor-chave.</span><span class="sxs-lookup"><span data-stu-id="203d2-136">The shopping cart microservice consumes a distributed cache that supports its simple, key-value data store.</span></span>
- <span data-ttu-id="203d2-137">O microserviço de pedidos consome tanto um banco de dados de documentos NoSql para operações de gravação, juntamente com uma loja de chaves/valor altamente desnormalizada para acomodar grandes volumes de operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="203d2-137">The ordering microservice consumes both a NoSql document database for write operations along with a highly denormalized key/value store to accommodate high-volumes of read operations.</span></span>
  
<span data-ttu-id="203d2-138">Embora as bases de dados relacionais permaneçam relevantes para microserviços com dados complexos, os bancos de dados NoSQL ganharam considerável popularidade.</span><span class="sxs-lookup"><span data-stu-id="203d2-138">While relational databases remain relevant for microservices with complex data, NoSQL databases have gained considerable popularity.</span></span> <span data-ttu-id="203d2-139">Eles fornecem escala maciça e alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="203d2-139">They provide massive scale and high availability.</span></span> <span data-ttu-id="203d2-140">Sua natureza sem esquemas permite que os desenvolvedores se afastem de uma arquitetura de classes de dados digitadas e ORMs que tornam a mudança cara e demorada.</span><span class="sxs-lookup"><span data-stu-id="203d2-140">Their schemaless nature allows developers to move away from an architecture of typed data classes and ORMs that make change expensive and time-consuming.</span></span> <span data-ttu-id="203d2-141">Nós cobrimos bancos de dados NoSQL mais tarde neste capítulo.</span><span class="sxs-lookup"><span data-stu-id="203d2-141">We cover NoSQL databases later in this chapter.</span></span>

 <span data-ttu-id="203d2-142">Embora encapsular dados em microsserviços separados possa aumentar a agilidade, o desempenho e a escalabilidade, ele também apresenta muitos desafios.</span><span class="sxs-lookup"><span data-stu-id="203d2-142">While encapsulating  data into separate microservices can increase agility, performance, and scalability, it also presents many challenges.</span></span> <span data-ttu-id="203d2-143">Na próxima seção, discutimos esses desafios juntamente com padrões e práticas para ajudar a superá-los.</span><span class="sxs-lookup"><span data-stu-id="203d2-143">In the next section, we discuss these challenges along with patterns and practices to help overcome them.</span></span>  

## <a name="cross-service-queries"></a><span data-ttu-id="203d2-144">Consultas de serviço cruzado</span><span class="sxs-lookup"><span data-stu-id="203d2-144">Cross-service queries</span></span>

<span data-ttu-id="203d2-145">Embora os microserviços sejam independentes e se concentrem em recursos funcionais específicos, como inventário, envio ou encomenda, eles frequentemente requerem integração com outros microserviços.</span><span class="sxs-lookup"><span data-stu-id="203d2-145">While microservices are independent and focus on specific functional capabilities, like inventory, shipping, or ordering, they frequently require integration with other microservices.</span></span> <span data-ttu-id="203d2-146">Muitas vezes, a integração envolve um microserviço *consultando* outro para dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-146">Often the integration involves one microservice *querying* another for data.</span></span> <span data-ttu-id="203d2-147">A Figura 5-3 mostra o cenário.</span><span class="sxs-lookup"><span data-stu-id="203d2-147">Figure 5-3 shows the scenario.</span></span>

![Consultando microsserviços](./media/cross-service-query.png)

<span data-ttu-id="203d2-149">**Figura 5-3**.</span><span class="sxs-lookup"><span data-stu-id="203d2-149">**Figure 5-3**.</span></span> <span data-ttu-id="203d2-150">Consultando microsserviços</span><span class="sxs-lookup"><span data-stu-id="203d2-150">Querying across microservices</span></span>

<span data-ttu-id="203d2-151">No número anterior, vemos um microserviço de cesta de compras que adiciona um item à cesta de compras do usuário.</span><span class="sxs-lookup"><span data-stu-id="203d2-151">In the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping basket.</span></span> <span data-ttu-id="203d2-152">Embora o armazenamento de dados para este microserviço contenha dados de cesta e item de linha, ele não mantém dados de produtos ou preços.</span><span class="sxs-lookup"><span data-stu-id="203d2-152">While the data store for this microservice contains basket and line item data, it doesn't maintain product or pricing data.</span></span> <span data-ttu-id="203d2-153">Em vez disso, esses itens de dados são de propriedade do catálogo e dos microsserviços de preços.</span><span class="sxs-lookup"><span data-stu-id="203d2-153">Instead, those data items are owned by the catalog and pricing microservices.</span></span> <span data-ttu-id="203d2-154">Isso apresenta um problema.</span><span class="sxs-lookup"><span data-stu-id="203d2-154">This presents a problem.</span></span> <span data-ttu-id="203d2-155">Como o microserviço da cesta de compras pode adicionar um produto à cesta de compras do usuário quando ele não tem produtos nem dados de preços em seu banco de dados?</span><span class="sxs-lookup"><span data-stu-id="203d2-155">How can the shopping basket microservice add a product to the user's shopping basket when it doesn't have product nor pricing data in its database?</span></span>

<span data-ttu-id="203d2-156">Uma opção discutida no Capítulo 4 é uma [chamada HTTP direta](service-to-service-communication.md#queries) da cesta de compras para o catálogo e microsserviços de preços.</span><span class="sxs-lookup"><span data-stu-id="203d2-156">One option discussed in Chapter 4 is a [direct HTTP call](service-to-service-communication.md#queries) from the shopping basket to the catalog and pricing microservices.</span></span> <span data-ttu-id="203d2-157">No entanto, no capítulo 4, dissemos que o HTTP síncrono chama os microsserviços *de casal* juntos, reduzindo sua autonomia e diminuindo seus benefícios arquitetônicos.</span><span class="sxs-lookup"><span data-stu-id="203d2-157">However, in chapter 4, we said synchronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their architectural benefits.</span></span>

<span data-ttu-id="203d2-158">Também podemos implementar um padrão de solicitação-resposta com filas separadas de entrada e saída para cada serviço.</span><span class="sxs-lookup"><span data-stu-id="203d2-158">We could also implement a request-reply pattern with separate inbound and outbound queues for each service.</span></span> <span data-ttu-id="203d2-159">No entanto, esse padrão é complicado e requer encanamento para correlacionar mensagens de solicitação e resposta.</span><span class="sxs-lookup"><span data-stu-id="203d2-159">However, this pattern is complicated and requires plumbing to correlate request and response messages.</span></span>
<span data-ttu-id="203d2-160">Embora isso desacopla as chamadas de microserviço back-end, o serviço de chamada ainda deve aguardar sincronizadamente a chamada ser concluída.</span><span class="sxs-lookup"><span data-stu-id="203d2-160">While it does decouple the backend microservice calls, the calling service must still synchronously wait for the call to complete.</span></span> <span data-ttu-id="203d2-161">Congestionamento da rede, falhas transitórias ou um microserviço sobrecarregado e pode resultar em operações de longa duração e até mesmo fracassadas.</span><span class="sxs-lookup"><span data-stu-id="203d2-161">Network congestion, transient faults, or an overloaded microservice and can result in long-running and even failed operations.</span></span>

<span data-ttu-id="203d2-162">Em vez disso, um padrão amplamente aceito para remover dependências de serviço cruzado é o [Padrão de Exibição Materializado,](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)mostrado na Figura 5-4.</span><span class="sxs-lookup"><span data-stu-id="203d2-162">Instead, a widely accepted pattern for removing cross-service dependencies is the [Materialized View Pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), shown in Figure 5-4.</span></span>

![Padrão de visualização materializado](./media/materialized-view-pattern.png)

<span data-ttu-id="203d2-164">**Figura 5-4**.</span><span class="sxs-lookup"><span data-stu-id="203d2-164">**Figure 5-4**.</span></span> <span data-ttu-id="203d2-165">Padrão de exibição materializado</span><span class="sxs-lookup"><span data-stu-id="203d2-165">Materialized View Pattern</span></span>

<span data-ttu-id="203d2-166">Com este padrão, você coloca uma tabela de dados local (conhecida como *modelo de leitura*) no serviço de cesta de compras.</span><span class="sxs-lookup"><span data-stu-id="203d2-166">With this pattern, you place a local data table (known as a *read model*) in the shopping basket service.</span></span> <span data-ttu-id="203d2-167">Esta tabela contém uma cópia desnormalizada dos dados necessários do produto e dos microsserviços de preços.</span><span class="sxs-lookup"><span data-stu-id="203d2-167">This table contains a denormalized copy of the data needed from the product and pricing microservices.</span></span> <span data-ttu-id="203d2-168">Copiar os dados diretamente no microserviço da cesta de compras elimina a necessidade de chamadas de serviço saqueadas caras.</span><span class="sxs-lookup"><span data-stu-id="203d2-168">Copying the data directly into the shopping basket microservice eliminates the need for expensive cross-service calls.</span></span> <span data-ttu-id="203d2-169">Com os dados locais para o serviço, você melhora o tempo de resposta e a confiabilidade do serviço.</span><span class="sxs-lookup"><span data-stu-id="203d2-169">With the data local to the service, you improve the service's response time and reliability.</span></span> <span data-ttu-id="203d2-170">Além disso, ter sua própria cópia dos dados torna o serviço de cesta de compras mais resistente.</span><span class="sxs-lookup"><span data-stu-id="203d2-170">Additionally, having its own copy of the data makes the shopping basket service more resilient.</span></span> <span data-ttu-id="203d2-171">Se o serviço de catálogo ficar indisponível, não afetaria diretamente o serviço de cesta de compras.</span><span class="sxs-lookup"><span data-stu-id="203d2-171">If the catalog service should become unavailable, it wouldn't directly impact the shopping basket service.</span></span> <span data-ttu-id="203d2-172">A cesta de compras pode continuar operando com os dados de sua própria loja.</span><span class="sxs-lookup"><span data-stu-id="203d2-172">The shopping basket can continue operating with the data from its own store.</span></span>

<span data-ttu-id="203d2-173">A pegadinha com essa abordagem é que agora você tem dados duplicados em seu sistema.</span><span class="sxs-lookup"><span data-stu-id="203d2-173">The catch with this approach is that you now have duplicate data in your system.</span></span> <span data-ttu-id="203d2-174">No entanto, a duplicação *estratégica* de dados em sistemas nativos da nuvem é uma prática estabelecida e não considerada um antipadrão ou uma prática ruim.</span><span class="sxs-lookup"><span data-stu-id="203d2-174">However, *strategically* duplicating data in cloud-native systems is an established practice and not considered an anti-pattern, or bad practice.</span></span> <span data-ttu-id="203d2-175">Tenha em mente que *um e apenas um serviço* pode possuir um conjunto de dados e ter autoridade sobre ele.</span><span class="sxs-lookup"><span data-stu-id="203d2-175">Keep in mind that *one and only one service* can own a data set and have authority over it.</span></span> <span data-ttu-id="203d2-176">Você precisará sincronizar os modelos de leitura quando o sistema de registro for atualizado.</span><span class="sxs-lookup"><span data-stu-id="203d2-176">You'll need to synchronize the read models when the system of record is updated.</span></span> <span data-ttu-id="203d2-177">A sincronização é normalmente implementada através de mensagens assíncronas com um [padrão de publicação/assinatura,](service-to-service-communication.md#events)conforme mostrado na Figura 5.4.</span><span class="sxs-lookup"><span data-stu-id="203d2-177">Synchronization is typically implemented via asynchronous messaging with a [publish/subscribe pattern](service-to-service-communication.md#events), as shown in Figure 5.4.</span></span>

## <a name="distributed-transactions"></a><span data-ttu-id="203d2-178">Transações distribuídas</span><span class="sxs-lookup"><span data-stu-id="203d2-178">Distributed transactions</span></span>

<span data-ttu-id="203d2-179">Embora a consulta de dados em microsserviços seja difícil, implementar uma transação em vários microsserviços é ainda mais complexo.</span><span class="sxs-lookup"><span data-stu-id="203d2-179">While querying data across microservices is difficult, implementing a transaction across several microservices is even more complex.</span></span> <span data-ttu-id="203d2-180">O desafio inerente de manter a consistência dos dados entre fontes de dados independentes em diferentes microsserviços não pode ser subestimado.</span><span class="sxs-lookup"><span data-stu-id="203d2-180">The inherent challenge of maintaining data consistency across independent data sources in different microservices can't be understated.</span></span> <span data-ttu-id="203d2-181">A falta de transações distribuídas em aplicativos nativos da nuvem significa que você deve gerenciar as transações distribuídas de forma programática.</span><span class="sxs-lookup"><span data-stu-id="203d2-181">The lack of distributed transactions in cloud-native applications means that you must manage distributed transactions programmatically.</span></span> <span data-ttu-id="203d2-182">Você passa de um mundo de *consistência imediata* para o de *consistência eventual.*</span><span class="sxs-lookup"><span data-stu-id="203d2-182">You move from a world of *immediate consistency* to that of *eventual consistency*.</span></span>

<span data-ttu-id="203d2-183">A Figura 5-5 mostra o problema.</span><span class="sxs-lookup"><span data-stu-id="203d2-183">Figure 5-5 shows the problem.</span></span>

![Transação no padrão saga](./media/saga-transaction-operation.png)

<span data-ttu-id="203d2-185">**Figura 5-5**.</span><span class="sxs-lookup"><span data-stu-id="203d2-185">**Figure 5-5**.</span></span> <span data-ttu-id="203d2-186">Implementação de uma transação em microsserviços</span><span class="sxs-lookup"><span data-stu-id="203d2-186">Implementing a transaction across microservices</span></span>

<span data-ttu-id="203d2-187">No número anterior, cinco microsserviços independentes participam de uma transação distribuída que cria um pedido.</span><span class="sxs-lookup"><span data-stu-id="203d2-187">In the preceding figure, five independent microservices participate in a distributed transaction that creates an order.</span></span> <span data-ttu-id="203d2-188">Cada microserviço mantém seu próprio armazenamento de dados e implementa uma transação local para sua loja.</span><span class="sxs-lookup"><span data-stu-id="203d2-188">Each microservice maintains its own data store and implements a local transaction for its store.</span></span> <span data-ttu-id="203d2-189">Para criar o pedido, a transação local para *cada* microserviço individual deve ter sucesso, ou *todos* devem abortar e reverter a operação.</span><span class="sxs-lookup"><span data-stu-id="203d2-189">To create the order, the local transaction for *each* individual microservice must succeed, or *all* must abort and roll back the operation.</span></span> <span data-ttu-id="203d2-190">Embora o suporte transacional incorporado esteja disponível dentro de cada um dos microserviços, não há suporte para uma transação distribuída que se estenderia por todos os cinco serviços para manter os dados consistentes.</span><span class="sxs-lookup"><span data-stu-id="203d2-190">While built-in transactional support is available inside each of the microservices, there's no support for a distributed transaction that would span across all five services to keep data consistent.</span></span>

<span data-ttu-id="203d2-191">Em vez disso, você deve construir esta transação distribuída *de forma programática.*</span><span class="sxs-lookup"><span data-stu-id="203d2-191">Instead, you must construct this distributed transaction *programmatically*.</span></span>

<span data-ttu-id="203d2-192">Um padrão popular para adicionar suporte transacional distribuído é o padrão Saga.</span><span class="sxs-lookup"><span data-stu-id="203d2-192">A popular pattern for adding distributed transactional support is the Saga pattern.</span></span> <span data-ttu-id="203d2-193">É implementado agrupando transações locais de forma programática e sequencial invocando cada uma delas.</span><span class="sxs-lookup"><span data-stu-id="203d2-193">It's implemented by grouping local transactions together programmatically and sequentially invoking each one.</span></span> <span data-ttu-id="203d2-194">Se alguma das transações locais falhar, a Saga aborta a operação e invoca um conjunto de [transações compensatórias.](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction)</span><span class="sxs-lookup"><span data-stu-id="203d2-194">If any of the local transactions fail, the Saga aborts the operation and invokes a set of [compensating transactions](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span></span> <span data-ttu-id="203d2-195">As transações compensatórias desfazem as alterações feitas pelas transações locais anteriores e restauram a consistência dos dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-195">The compensating transactions undo the changes made by the preceding local transactions and restore data consistency.</span></span> <span data-ttu-id="203d2-196">A Figura 5-6 mostra uma transação fracassada com o padrão Saga.</span><span class="sxs-lookup"><span data-stu-id="203d2-196">Figure 5-6 shows a failed transaction with the Saga pattern.</span></span>

![Reverter para trás no padrão da saga](./media/saga-rollback-operation.png)

<span data-ttu-id="203d2-198">**Figura 5-6**.</span><span class="sxs-lookup"><span data-stu-id="203d2-198">**Figure 5-6**.</span></span> <span data-ttu-id="203d2-199">Revertendo uma transação</span><span class="sxs-lookup"><span data-stu-id="203d2-199">Rolling back a transaction</span></span>

<span data-ttu-id="203d2-200">No número anterior, a operação *Inventário de Atualização* falhou no microserviço Inventário.</span><span class="sxs-lookup"><span data-stu-id="203d2-200">In the previous figure, the *Update Inventory* operation has failed in the Inventory microservice.</span></span> <span data-ttu-id="203d2-201">A Saga invoca um conjunto de transações compensatórias (em vermelho) para ajustar as contagens de estoque, cancelar o pagamento e a ordem e devolver os dados de cada microserviço de volta a um estado consistente.</span><span class="sxs-lookup"><span data-stu-id="203d2-201">The Saga invokes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return the data for each microservice back to a consistent state.</span></span>

<span data-ttu-id="203d2-202">Padrões de saga são tipicamente coreografados como uma série de eventos relacionados, ou orquestrados como um conjunto de comandos relacionados.</span><span class="sxs-lookup"><span data-stu-id="203d2-202">Saga patterns are typically choreographed as a series of related events, or orchestrated as a set of related commands.</span></span> <span data-ttu-id="203d2-203">No Capítulo 4, discutimos o padrão agregador de serviços que seria a base para uma implementação orquestrada da saga.</span><span class="sxs-lookup"><span data-stu-id="203d2-203">In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an orchestrated saga implementation.</span></span> <span data-ttu-id="203d2-204">Também discutimos o evento juntamente com os tópicos Azure Service Bus e Azure Event Grid que seriam a base para uma implementação coreografada da saga.</span><span class="sxs-lookup"><span data-stu-id="203d2-204">We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation for a choreographed saga implementation.</span></span>

## <a name="high-volume-data"></a><span data-ttu-id="203d2-205">Dados de alto volume</span><span class="sxs-lookup"><span data-stu-id="203d2-205">High volume data</span></span>

<span data-ttu-id="203d2-206">Grandes aplicativos nativos da nuvem geralmente suportam requisitos de dados de alto volume.</span><span class="sxs-lookup"><span data-stu-id="203d2-206">Large cloud-native applications often support high-volume data requirements.</span></span> <span data-ttu-id="203d2-207">Nesses cenários, as técnicas tradicionais de armazenamento de dados podem causar gargalos.</span><span class="sxs-lookup"><span data-stu-id="203d2-207">In these scenarios, traditional data storage techniques can cause bottlenecks.</span></span> <span data-ttu-id="203d2-208">Para sistemas complexos que são implantados em larga escala, tanto a Segregação de Responsabilidade de Comando e Consulta (CQRS) quanto o Sourcing de Eventos podem melhorar o desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="203d2-208">For complex systems that deploy on a large scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.</span></span>  

### <a name="cqrs"></a><span data-ttu-id="203d2-209">CQRS</span><span class="sxs-lookup"><span data-stu-id="203d2-209">CQRS</span></span>

<span data-ttu-id="203d2-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), é um padrão arquitetônico que pode ajudar a maximizar o desempenho, escalabilidade e segurança.</span><span class="sxs-lookup"><span data-stu-id="203d2-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), is an architectural pattern that can help maximize performance, scalability, and security.</span></span> <span data-ttu-id="203d2-211">O padrão separa as operações que leem dados das operações que escrevem dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-211">The pattern separates operations that read data from those operations that write data.</span></span>

<span data-ttu-id="203d2-212">Para cenários normais, o mesmo modelo de entidade e o objeto de repositório de dados são usados para operações *de* leitura e gravação.</span><span class="sxs-lookup"><span data-stu-id="203d2-212">For normal scenarios, the same entity model and data repository object are used for *both* read and write operations.</span></span>

<span data-ttu-id="203d2-213">No entanto, um cenário de dados de alto volume pode beneficiar de modelos e tabelas de dados separados para leituras e gravações.</span><span class="sxs-lookup"><span data-stu-id="203d2-213">However, a high volume data scenario can benefit from separate models and data tables for reads and writes.</span></span> <span data-ttu-id="203d2-214">Para melhorar o desempenho, a operação leitura poderia consultar uma representação altamente desnormalizada dos dados para evitar adesões de tabela repetitivas caras e bloqueios de mesa.</span><span class="sxs-lookup"><span data-stu-id="203d2-214">To improve performance, the read operation could query against a highly denormalized representation of the data to avoid expensive repetitive table joins and table locks.</span></span> <span data-ttu-id="203d2-215">A operação *de gravação,* conhecida como *comando,* seria atualizada contra uma representação totalmente normalizada dos dados que garantiriam consistência.</span><span class="sxs-lookup"><span data-stu-id="203d2-215">The *write* operation, known as a *command*, would update against a fully normalized representation of the data that would guarantee consistency.</span></span> <span data-ttu-id="203d2-216">Em seguida, você precisa implementar um mecanismo para manter ambas as representações em sincronia. Normalmente, sempre que a tabela de gravação é modificada, ela publica um evento que replica a modificação na tabela de leitura.</span><span class="sxs-lookup"><span data-stu-id="203d2-216">You then need to implement a mechanism to keep both representations in sync. Typically, whenever the write table is modified, it publishes an event that replicates the modification to the read table.</span></span>

<span data-ttu-id="203d2-217">A Figura 5-7 mostra uma implementação do padrão CQRS.</span><span class="sxs-lookup"><span data-stu-id="203d2-217">Figure 5-7 shows an implementation of the CQRS pattern.</span></span>

![Segregação de Responsabilidade de Comando e Consulta](./media/cqrs-implementation.png)

<span data-ttu-id="203d2-219">**Figura 5-7**.</span><span class="sxs-lookup"><span data-stu-id="203d2-219">**Figure 5-7**.</span></span> <span data-ttu-id="203d2-220">Implementação do CQRS</span><span class="sxs-lookup"><span data-stu-id="203d2-220">CQRS implementation</span></span>

<span data-ttu-id="203d2-221">Na figura anterior, modelos separados de comando e consulta são implementados.</span><span class="sxs-lookup"><span data-stu-id="203d2-221">In the previous figure, separate command and query models are implemented.</span></span> <span data-ttu-id="203d2-222">Cada operação de gravação de dados é salva no armazenamento de gravação e, em seguida, propagada para o armazenamento de leitura.</span><span class="sxs-lookup"><span data-stu-id="203d2-222">Each data write operation is saved to the write store and then propagated to the read store.</span></span> <span data-ttu-id="203d2-223">Preste muita atenção em como o processo de propagação de dados opera no princípio da [eventual consistência](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span><span class="sxs-lookup"><span data-stu-id="203d2-223">Pay close attention to how the data propagation process operates on the principle of [eventual consistency](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span></span> <span data-ttu-id="203d2-224">O modelo de leitura eventualmente sincroniza com o modelo de gravação, mas pode haver alguma defasagem no processo.</span><span class="sxs-lookup"><span data-stu-id="203d2-224">The read model eventually synchronizes with the write model, but there may be some lag in the process.</span></span> <span data-ttu-id="203d2-225">Discutimos uma eventual consistência na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="203d2-225">We discuss eventual consistency in the next section.</span></span>

<span data-ttu-id="203d2-226">Esta separação permite que leituras e gravações dimensionem de forma independente.</span><span class="sxs-lookup"><span data-stu-id="203d2-226">This separation enables reads and writes to scale independently.</span></span> <span data-ttu-id="203d2-227">As operações de leitura usam um esquema otimizado para consultas, enquanto as gravações usam um esquema otimizado para atualizações.</span><span class="sxs-lookup"><span data-stu-id="203d2-227">Read operations use a schema optimized for queries, while the writes use a schema optimized for updates.</span></span> <span data-ttu-id="203d2-228">As consultas de leitura vão contra dados desnormalizados, enquanto a lógica de negócios complexa pode ser aplicada ao modelo de gravação.</span><span class="sxs-lookup"><span data-stu-id="203d2-228">Read queries go against denormalized data, while complex business logic can be applied to the write model.</span></span> <span data-ttu-id="203d2-229">Além disso, você pode impor mais segurança nas operações de gravação do que aquelas que expõem leituras.</span><span class="sxs-lookup"><span data-stu-id="203d2-229">As well, you might impose tighter security on write operations than those exposing reads.</span></span>

<span data-ttu-id="203d2-230">A implementação do CQRS pode melhorar o desempenho do aplicativo para serviços nativos da nuvem.</span><span class="sxs-lookup"><span data-stu-id="203d2-230">Implementing CQRS can improve application performance for cloud-native services.</span></span> <span data-ttu-id="203d2-231">No entanto, resulta em um design mais complexo.</span><span class="sxs-lookup"><span data-stu-id="203d2-231">However, it does result in a more complex design.</span></span> <span data-ttu-id="203d2-232">Aplique este princípio cuidadosamente e estrategicamente às seções do seu aplicativo nativo da nuvem que se beneficiarão dele.</span><span class="sxs-lookup"><span data-stu-id="203d2-232">Apply this principle carefully and strategically to those sections of your cloud-native application that will benefit from it.</span></span> <span data-ttu-id="203d2-233">Para obter mais informações sobre o CQRS, consulte o livro da Microsoft [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span><span class="sxs-lookup"><span data-stu-id="203d2-233">For more on CQRS, see the Microsoft book [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span></span>

### <a name="event-sourcing"></a><span data-ttu-id="203d2-234">Sourcing de eventos</span><span class="sxs-lookup"><span data-stu-id="203d2-234">Event sourcing</span></span>

<span data-ttu-id="203d2-235">Outra abordagem para otimizar cenários de dados de alto volume envolve [o Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span><span class="sxs-lookup"><span data-stu-id="203d2-235">Another approach to optimizing high volume data scenarios involves [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span></span>

<span data-ttu-id="203d2-236">Um sistema normalmente armazena o estado atual de uma entidade de dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-236">A system typically stores the current state of a data entity.</span></span> <span data-ttu-id="203d2-237">Se um usuário altera seu número de telefone, por exemplo, o registro do cliente é atualizado com o novo número.</span><span class="sxs-lookup"><span data-stu-id="203d2-237">If a user changes their phone number, for example, the customer record is updated with the new number.</span></span> <span data-ttu-id="203d2-238">Sempre sabemos o estado atual de uma entidade de dados, mas cada atualização substitui o estado anterior.</span><span class="sxs-lookup"><span data-stu-id="203d2-238">We always know the current state of a data entity, but each update overwrites the previous state.</span></span>

<span data-ttu-id="203d2-239">Na maioria dos casos, esse modelo funciona bem.</span><span class="sxs-lookup"><span data-stu-id="203d2-239">In most cases, this model works fine.</span></span> <span data-ttu-id="203d2-240">Em sistemas de alto volume, no entanto, a sobrecarga de operações de bloqueio transacional e de atualização frequentes pode afetar o desempenho do banco de dados, a capacidade de resposta e a escalabilidade de limite.</span><span class="sxs-lookup"><span data-stu-id="203d2-240">In high volume systems, however, overhead from transactional locking and frequent update operations can impact database performance, responsiveness, and limit scalability.</span></span>

<span data-ttu-id="203d2-241">O Event Sourcing adota uma abordagem diferente para capturar dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-241">Event Sourcing takes a different approach to capturing data.</span></span> <span data-ttu-id="203d2-242">Cada operação que afeta os dados é persistindo a um armazenamento de eventos.</span><span class="sxs-lookup"><span data-stu-id="203d2-242">Each operation that affects data is persisted to an event store.</span></span> <span data-ttu-id="203d2-243">Em vez de atualizar o estado de um registro de dados, anexamos cada alteração a uma lista seqüencial de eventos passados - semelhante ao livro-razão de um contador.</span><span class="sxs-lookup"><span data-stu-id="203d2-243">Instead of updating the state of a data record, we append each change to a sequential list of past events - similar to an accountant's ledger.</span></span> <span data-ttu-id="203d2-244">O Event Store torna-se o sistema de registro dos dados.</span><span class="sxs-lookup"><span data-stu-id="203d2-244">The Event Store becomes the system of record for the data.</span></span> <span data-ttu-id="203d2-245">É usado para propagar várias visões materializadas dentro do contexto limitado de um microserviço.</span><span class="sxs-lookup"><span data-stu-id="203d2-245">It's used to propagate various materialized views within the bounded context of a microservice.</span></span> <span data-ttu-id="203d2-246">A Figura 5.8 mostra o padrão.</span><span class="sxs-lookup"><span data-stu-id="203d2-246">Figure 5.8 shows the pattern.</span></span>

![Fornecimento do evento](./media/event-sourcing.png)

<span data-ttu-id="203d2-248">**Figura 5-8**.</span><span class="sxs-lookup"><span data-stu-id="203d2-248">**Figure 5-8**.</span></span> <span data-ttu-id="203d2-249">Fornecimento do evento</span><span class="sxs-lookup"><span data-stu-id="203d2-249">Event Sourcing</span></span>

<span data-ttu-id="203d2-250">Na figura anterior, observe como cada entrada (em azul) para o carrinho de compras de um usuário é anexada a uma loja de eventos subjacente.</span><span class="sxs-lookup"><span data-stu-id="203d2-250">In the previous figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying event store.</span></span> <span data-ttu-id="203d2-251">Na visão materializada adjacente, o sistema projeta o estado atual reproduzindo todos os eventos associados a cada carrinho de compras.</span><span class="sxs-lookup"><span data-stu-id="203d2-251">In the adjoining materialized view, the system projects the current state by replaying all the events associated with each shopping cart.</span></span> <span data-ttu-id="203d2-252">Esta visão, ou modelo de leitura, é então exposta de volta à ui.</span><span class="sxs-lookup"><span data-stu-id="203d2-252">This view, or read model, is then exposed back to the UI.</span></span> <span data-ttu-id="203d2-253">Os eventos também podem ser integrados a sistemas e aplicações externas ou consultados para determinar o estado atual de uma entidade.</span><span class="sxs-lookup"><span data-stu-id="203d2-253">Events can also be integrated with external systems and applications or queried to determine the current state of an entity.</span></span> <span data-ttu-id="203d2-254">Com essa abordagem, você mantém a história.</span><span class="sxs-lookup"><span data-stu-id="203d2-254">With this approach, you maintain history.</span></span> <span data-ttu-id="203d2-255">Você sabe não só o estado atual de uma entidade, mas também como você chegou a este estado.</span><span class="sxs-lookup"><span data-stu-id="203d2-255">You know not only the current state of an entity, but also how you reached this state.</span></span>

<span data-ttu-id="203d2-256">Mecanicamente falando, o sourcing de eventos simplifica o modelo de gravação.</span><span class="sxs-lookup"><span data-stu-id="203d2-256">Mechanically speaking, event sourcing simplifies the write model.</span></span> <span data-ttu-id="203d2-257">Não há atualizações ou exclusões.</span><span class="sxs-lookup"><span data-stu-id="203d2-257">There are no updates or deletes.</span></span> <span data-ttu-id="203d2-258">Anexar cada entrada de dados como um evento imutável minimiza conflitos de contenção, bloqueio e concorrência associados a bancos de dados relacionais.</span><span class="sxs-lookup"><span data-stu-id="203d2-258">Appending each data entry as an immutable event minimizes contention, locking, and concurrency conflicts associated with relational databases.</span></span> <span data-ttu-id="203d2-259">Construir modelos de leitura com o padrão de visualização materializado permite desacoplar a exibição do modelo de gravação e escolher o melhor armazenamento de dados para otimizar as necessidades da interface do motorista do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="203d2-259">Building read models with the materialized view pattern enables you to decouple the view from the write model and choose the best data store to optimize the needs of your application UI.</span></span>

<span data-ttu-id="203d2-260">Para esse padrão, considere um armazenamento de dados que suporte diretamente o sourcing de eventos.</span><span class="sxs-lookup"><span data-stu-id="203d2-260">For this pattern, consider a data store that directly supports event sourcing.</span></span> <span data-ttu-id="203d2-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB e RavenDB são bons candidatos.</span><span class="sxs-lookup"><span data-stu-id="203d2-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB are good candidates.</span></span>

<span data-ttu-id="203d2-262">Como em todos os padrões e tecnologias, implementar estrategicamente e quando necessário.</span><span class="sxs-lookup"><span data-stu-id="203d2-262">As with all patterns and technologies, implement strategically and when needed.</span></span> <span data-ttu-id="203d2-263">Embora o sourcing de eventos possa proporcionar maior desempenho e escalabilidade, ele vem às custas da complexidade e de uma curva de aprendizado.</span><span class="sxs-lookup"><span data-stu-id="203d2-263">While event sourcing can provide increased performance and scalability, it comes at the expense of complexity and a learning curve.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="203d2-264">[Próximo](service-mesh-communication-infrastructure.md)
>[anterior](relational-vs-nosql-data.md)</span><span class="sxs-lookup"><span data-stu-id="203d2-264">[Previous](service-mesh-communication-infrastructure.md)
[Next](relational-vs-nosql-data.md)</span></span>
