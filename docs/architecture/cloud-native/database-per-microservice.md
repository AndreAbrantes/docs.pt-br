---
title: Banco de dados por microserviço
description: Contraste o armazenamento de dados em aplicativos monolíticos e nativos de nuvem.
author: robvet
ms.date: 01/22/2020
ms.openlocfilehash: e472309d3dc815070fc2d2c220bf4fe00b8c29ae
ms.sourcegitcommit: 13e79efdbd589cad6b1de634f5d6b1262b12ab01
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/28/2020
ms.locfileid: "76794901"
---
# <a name="database-per-microservice"></a><span data-ttu-id="a2940-103">Banco de dados por microserviço</span><span class="sxs-lookup"><span data-stu-id="a2940-103">Database-per-microservice</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="a2940-104">Como vimos em todo este livro, uma abordagem nativa de nuvem altera a maneira como você projeta, implanta e gerencia aplicativos.</span><span class="sxs-lookup"><span data-stu-id="a2940-104">As we've seen throughout this book, a cloud-native approach changes the way you design, deploy, and manage applications.</span></span> <span data-ttu-id="a2940-105">Ele também altera a maneira como você gerencia e armazena dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-105">It also changes the way you manage and store data.</span></span>

<span data-ttu-id="a2940-106">A Figura 5-1 contrasta as diferenças.</span><span class="sxs-lookup"><span data-stu-id="a2940-106">Figure 5-1 contrasts the differences.</span></span>

![Armazenamento de dados em aplicativos nativos de nuvem](./media/distributed-data.png)

<span data-ttu-id="a2940-108">**Figura 5-1**.</span><span class="sxs-lookup"><span data-stu-id="a2940-108">**Figure 5-1**.</span></span> <span data-ttu-id="a2940-109">Gerenciamento de dados em aplicativos nativos de nuvem</span><span class="sxs-lookup"><span data-stu-id="a2940-109">Data management in cloud-native applications</span></span>

<span data-ttu-id="a2940-110">Os desenvolvedores experientes reconhecerão facilmente a arquitetura no lado esquerdo da Figura 5-1.</span><span class="sxs-lookup"><span data-stu-id="a2940-110">Experienced developers will easily recognize the architecture on the left-side of figure 5-1.</span></span> <span data-ttu-id="a2940-111">Nesse *aplicativo monolítico*, os componentes do serviço de negócios se posicionam juntos em uma camada de serviços compartilhados, compartilhando dados de um único banco de dado relacional.</span><span class="sxs-lookup"><span data-stu-id="a2940-111">In this *monolithic application*, business service components collocate together in a shared services tier, sharing data from a single relational database.</span></span>

<span data-ttu-id="a2940-112">De várias maneiras, um banco de dados individual mantém o gerenciamento de dados simples.</span><span class="sxs-lookup"><span data-stu-id="a2940-112">In many ways, a single database keeps data management simple.</span></span> <span data-ttu-id="a2940-113">Consultar dados em várias tabelas é simples.</span><span class="sxs-lookup"><span data-stu-id="a2940-113">Querying data across multiple tables is straightforward.</span></span> <span data-ttu-id="a2940-114">Alterações na atualização de dados juntas ou todas elas são revertidas.</span><span class="sxs-lookup"><span data-stu-id="a2940-114">Changes to data update together or they all rollback.</span></span> <span data-ttu-id="a2940-115">[As transações ACID](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) garantem uma consistência forte e imediata.</span><span class="sxs-lookup"><span data-stu-id="a2940-115">[ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarantee strong and immediate consistency.</span></span>

<span data-ttu-id="a2940-116">Design para a nuvem nativa, adotamos uma abordagem diferente.</span><span class="sxs-lookup"><span data-stu-id="a2940-116">Designing for cloud-native, we take a different approach.</span></span> <span data-ttu-id="a2940-117">No lado direito da Figura 5-1, observe como a funcionalidade de negócios é segregada em microserviços pequenos e independentes.</span><span class="sxs-lookup"><span data-stu-id="a2940-117">On the right-side of Figure 5-1, note how business functionality segregates into small, independent microservices.</span></span> <span data-ttu-id="a2940-118">Cada microserviço encapsula um recurso comercial específico e seus próprios dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-118">Each microservice encapsulates a specific business capability and its own data.</span></span> <span data-ttu-id="a2940-119">O banco de dados monolítico é decomposto em um modelo de dado distribuído com muitos bancos de dados menores, cada um alinhando com um microserviço.</span><span class="sxs-lookup"><span data-stu-id="a2940-119">The monolithic database decomposes into a distributed data model with many smaller databases, each aligning with a microservice.</span></span> <span data-ttu-id="a2940-120">Quando a fumaça é limpa, surgemos um design que expõe um *banco de dados por microserviço*.</span><span class="sxs-lookup"><span data-stu-id="a2940-120">When the smoke clears, we emerge with a design that exposes a *database per microservice*.</span></span>

## <a name="why"></a><span data-ttu-id="a2940-121">Por quê?</span><span class="sxs-lookup"><span data-stu-id="a2940-121">Why?</span></span>

<span data-ttu-id="a2940-122">Esse banco de dados por microserviço fornece muitos benefícios, especialmente para sistemas que devem evoluir rapidamente e dar suporte a escala maciça.</span><span class="sxs-lookup"><span data-stu-id="a2940-122">This database per microservice provides many benefits, especially for systems that must evolve rapidly and support massive scale.</span></span> <span data-ttu-id="a2940-123">Com este modelo...</span><span class="sxs-lookup"><span data-stu-id="a2940-123">With this model...</span></span>

- <span data-ttu-id="a2940-124">Os dados de domínio são encapsulados dentro do serviço</span><span class="sxs-lookup"><span data-stu-id="a2940-124">Domain data is encapsulated within the service</span></span>
- <span data-ttu-id="a2940-125">O esquema de dados pode evoluir sem afetar diretamente outros serviços</span><span class="sxs-lookup"><span data-stu-id="a2940-125">Data schema can evolve without directly impacting other services</span></span>
- <span data-ttu-id="a2940-126">Cada repositório de dados pode ser dimensionado de forma independente</span><span class="sxs-lookup"><span data-stu-id="a2940-126">Each data store can independently scale</span></span>
- <span data-ttu-id="a2940-127">Uma falha no armazenamento de dados em um serviço não afetará diretamente outros serviços</span><span class="sxs-lookup"><span data-stu-id="a2940-127">A data store failure in one service won't directly impact other services</span></span>

<span data-ttu-id="a2940-128">Separar dados também permite que cada microserviço implemente o tipo de armazenamento de dados que é melhor otimizado para sua carga de trabalho, necessidades de armazenamento e padrões de leitura/gravação.</span><span class="sxs-lookup"><span data-stu-id="a2940-128">Segregating data also enables each microservice to implement the data store type that is best optimized for its workload, storage needs, and read/write patterns.</span></span> <span data-ttu-id="a2940-129">As opções incluem relacional, documento, chave-valor e até mesmo armazenamentos de dados baseados em grafo.</span><span class="sxs-lookup"><span data-stu-id="a2940-129">Choices include relational, document, key-value, and even graph-based data stores.</span></span>

<span data-ttu-id="a2940-130">A Figura 5-2 apresenta o princípio da persistência de poliglota em um sistema nativo de nuvem.</span><span class="sxs-lookup"><span data-stu-id="a2940-130">Figure 5-2 presents the principle of polyglot persistence in a cloud-native system.</span></span>

![Persistência de dados poliglota](./media/polyglot-data-persistence.png)

<span data-ttu-id="a2940-132">**Figura 5-2**.</span><span class="sxs-lookup"><span data-stu-id="a2940-132">**Figure 5-2**.</span></span> <span data-ttu-id="a2940-133">Persistência de dados poliglota</span><span class="sxs-lookup"><span data-stu-id="a2940-133">Polyglot data persistence</span></span>

<span data-ttu-id="a2940-134">Observe na figura anterior como cada microserviço dá suporte a um tipo diferente de armazenamento de dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-134">Note in the previous figure how each microservice supports a different type of data store.</span></span>

- <span data-ttu-id="a2940-135">O microserviço de catálogo de produtos consome um banco de dados relacional para acomodar a estrutura relacional avançada de seus próprios dados subjacentes.</span><span class="sxs-lookup"><span data-stu-id="a2940-135">The product catalog microservice consumes a relational database to accommodate the rich relational structure of its underlying data.</span></span>
- <span data-ttu-id="a2940-136">O microserviço de carrinho de compras consome um cache distribuído que dá suporte a seu armazenamento de dados de valor-chave simples.</span><span class="sxs-lookup"><span data-stu-id="a2940-136">The shopping cart microservice consumes a distributed cache that supports its simple, key-value data store.</span></span>
- <span data-ttu-id="a2940-137">O microserviço de ordenação consome um banco de dados de documentos NoSql para operações de gravação, juntamente com um repositório de chave/valor altamente desnormalizado para acomodar altos volumes de operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="a2940-137">The ordering microservice consumes both a NoSql document database for write operations along with a highly denormalized key/value store to accommodate high-volumes of read operations.</span></span>
  
<span data-ttu-id="a2940-138">Embora os bancos de dados relacionais permaneçam relevantes para os microserviços com os complexos, eles ganharam uma popularidade considerável.</span><span class="sxs-lookup"><span data-stu-id="a2940-138">While relational databases remain relevant for microservices with complex data, NoSQL databases have gained considerable popularity.</span></span> <span data-ttu-id="a2940-139">Eles fornecem grande escala e alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="a2940-139">They provide massive scale and high availability.</span></span> <span data-ttu-id="a2940-140">Sua natureza sem esquema permite que os desenvolvedores se afastem de uma arquitetura de classes de dados tipadas e ORMs que tornam a alteração cara e demorada.</span><span class="sxs-lookup"><span data-stu-id="a2940-140">Their schemaless nature allows developers to move away from an architecture of typed data classes and ORMs that make change expensive and time-consuming.</span></span> <span data-ttu-id="a2940-141">Abordamos os bancos de dados NoSQL posteriormente neste capítulo.</span><span class="sxs-lookup"><span data-stu-id="a2940-141">We cover NoSQL databases later in this chapter.</span></span>

 <span data-ttu-id="a2940-142">Embora o encapsulamento de dados em microserviços separados possa aumentar a agilidade, o desempenho e a escalabilidade, ele também apresenta muitos desafios.</span><span class="sxs-lookup"><span data-stu-id="a2940-142">While encapsulating  data into separate microservices can increase agility, performance, and scalability, it also presents many challenges.</span></span> <span data-ttu-id="a2940-143">Na próxima seção, discutiremos esses desafios junto com padrões e práticas para ajudar a superá-los.</span><span class="sxs-lookup"><span data-stu-id="a2940-143">In the next section, we discuss these challenges along with patterns and practices to help overcome them.</span></span>  

## <a name="cross-service-queries"></a><span data-ttu-id="a2940-144">Consultas entre serviços</span><span class="sxs-lookup"><span data-stu-id="a2940-144">Cross-service queries</span></span>

<span data-ttu-id="a2940-145">Embora os microserviço sejam independentes e se concentrem em recursos funcionais específicos, como inventário, envio ou ordenação, eles frequentemente exigem integração com outros microserviços.</span><span class="sxs-lookup"><span data-stu-id="a2940-145">While microservices are independent and focus on specific functional capabilities, like inventory, shipping, or ordering, they frequently require integration with other microservices.</span></span> <span data-ttu-id="a2940-146">Geralmente, a integração envolve um microserviço *consultando* outro para dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-146">Often the integration involves one microservice *querying* another for data.</span></span> <span data-ttu-id="a2940-147">A Figura 5-3 mostra o cenário.</span><span class="sxs-lookup"><span data-stu-id="a2940-147">Figure 5-3 shows the scenario.</span></span>

![Consultando em microserviços](./media/cross-service-query.png)

<span data-ttu-id="a2940-149">**Figura 5-3**.</span><span class="sxs-lookup"><span data-stu-id="a2940-149">**Figure 5-3**.</span></span> <span data-ttu-id="a2940-150">Consultando em microserviços</span><span class="sxs-lookup"><span data-stu-id="a2940-150">Querying across microservices</span></span>

<span data-ttu-id="a2940-151">Na figura anterior, vemos um microserviço de cesta de compras que adiciona um item à cesta de compras de um usuário.</span><span class="sxs-lookup"><span data-stu-id="a2940-151">In the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping basket.</span></span> <span data-ttu-id="a2940-152">Embora o armazenamento de dados para este microserviço contenha dados de item de linha e cesta, ele não mantém os dados de produtos ou preços.</span><span class="sxs-lookup"><span data-stu-id="a2940-152">While the data store for this microservice contains basket and line item data, it doesn't maintain product or pricing data.</span></span> <span data-ttu-id="a2940-153">Em vez disso, esses itens de dados pertencem aos microserviços de catálogo e de preços.</span><span class="sxs-lookup"><span data-stu-id="a2940-153">Instead, those data items are owned by the catalog and pricing microservices.</span></span> <span data-ttu-id="a2940-154">Isso apresenta um problema.</span><span class="sxs-lookup"><span data-stu-id="a2940-154">This presents a problem.</span></span> <span data-ttu-id="a2940-155">Como o microserviço da cesta de compras pode adicionar um produto à cesta de compras do usuário quando ele não tem dados de produto nem de preço em seu banco de dado?</span><span class="sxs-lookup"><span data-stu-id="a2940-155">How can the shopping basket microservice add a product to the user's shopping basket when it doesn't have product nor pricing data in its database?</span></span>

<span data-ttu-id="a2940-156">Uma opção discutida no capítulo 4 é uma [chamada http direta](service-to-service-communication.md#queries) da cesta de compras para os microserviços de catálogo e preço.</span><span class="sxs-lookup"><span data-stu-id="a2940-156">One option discussed in Chapter 4 is a [direct HTTP call](service-to-service-communication.md#queries) from the shopping basket to the catalog and pricing microservices.</span></span> <span data-ttu-id="a2940-157">No entanto, no capítulo 4, dissemos que *chamadas http síncronas agrupam* os microserviços, reduzindo sua autonomia e diminuindo seus benefícios arquitetônicos.</span><span class="sxs-lookup"><span data-stu-id="a2940-157">However, in chapter 4, we said synchronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their architectural benefits.</span></span>

<span data-ttu-id="a2940-158">Também poderíamos implementar um padrão de solicitação-resposta com filas de entrada e saída separadas para cada serviço.</span><span class="sxs-lookup"><span data-stu-id="a2940-158">We could also implement a request-reply pattern with separate inbound and outbound queues for each service.</span></span> <span data-ttu-id="a2940-159">No entanto, esse padrão é complicado e requer a inserção para correlacionar mensagens de solicitação e resposta.</span><span class="sxs-lookup"><span data-stu-id="a2940-159">However, this pattern is complicated and requires plumbing to correlate request and response messages.</span></span>
<span data-ttu-id="a2940-160">Embora ele desassocie as chamadas de microserviço de back-end, o serviço de chamada ainda deve esperar de forma síncrona a chamada seja concluída.</span><span class="sxs-lookup"><span data-stu-id="a2940-160">While it does decouple the backend microservice calls, the calling service must still synchronously wait for the call to complete.</span></span> <span data-ttu-id="a2940-161">Congestionamento de rede, falhas transitórias ou um microserviço sobrecarregado e pode resultar em operações de execução longa e até mesmo com falha.</span><span class="sxs-lookup"><span data-stu-id="a2940-161">Network congestion, transient faults, or an overloaded microservice and can result in long-running and even failed operations.</span></span>

<span data-ttu-id="a2940-162">Em vez disso, um padrão amplamente aceito para remover dependências entre serviços é o [padrão de exibição materializado](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), mostrado na Figura 5-4.</span><span class="sxs-lookup"><span data-stu-id="a2940-162">Instead, a widely accepted pattern for removing cross-service dependencies is the [Materialized View Pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), shown in Figure 5-4.</span></span>

![Padrão de exibição materializada](./media/materialized-view-pattern.png)

<span data-ttu-id="a2940-164">**Figura 5-4**.</span><span class="sxs-lookup"><span data-stu-id="a2940-164">**Figure 5-4**.</span></span> <span data-ttu-id="a2940-165">Padrão de exibição materializada</span><span class="sxs-lookup"><span data-stu-id="a2940-165">Materialized View Pattern</span></span>

<span data-ttu-id="a2940-166">Com esse padrão, você coloca uma tabela de dados local (conhecida como *modelo de leitura*) no serviço de cesta de compras.</span><span class="sxs-lookup"><span data-stu-id="a2940-166">With this pattern, you place a local data table (known as a *read model*) in the shopping basket service.</span></span> <span data-ttu-id="a2940-167">Esta tabela contém uma cópia desnormalizada dos dados necessários dos microserviços de produto e preço.</span><span class="sxs-lookup"><span data-stu-id="a2940-167">This table contains a denormalized copy of the data needed from the product and pricing microservices.</span></span> <span data-ttu-id="a2940-168">Copiar os dados diretamente no microserviço da cesta de compras elimina a necessidade de chamadas caras entre serviços.</span><span class="sxs-lookup"><span data-stu-id="a2940-168">Copying the data directly into the shopping basket microservice eliminates the need for expensive cross-service calls.</span></span> <span data-ttu-id="a2940-169">Com os dados locais para o serviço, você melhora o tempo de resposta e a confiabilidade do serviço.</span><span class="sxs-lookup"><span data-stu-id="a2940-169">With the data local to the service, you improve the service's response time and reliability.</span></span> <span data-ttu-id="a2940-170">Além disso, ter sua própria cópia dos dados torna o serviço de cesta de compras mais resiliente.</span><span class="sxs-lookup"><span data-stu-id="a2940-170">Additionally, having its own copy of the data makes the shopping basket service more resilient.</span></span> <span data-ttu-id="a2940-171">Se o serviço de catálogo ficar indisponível, ele não afetaria diretamente o serviço de cesta de compras.</span><span class="sxs-lookup"><span data-stu-id="a2940-171">If the catalog service should become unavailable, it wouldn't directly impact the shopping basket service.</span></span> <span data-ttu-id="a2940-172">A cesta de compras pode continuar operando com os dados de seu próprio armazenamento.</span><span class="sxs-lookup"><span data-stu-id="a2940-172">The shopping basket can continue operating with the data from its own store.</span></span> 

<span data-ttu-id="a2940-173">O problema dessa abordagem é que agora você tem dados duplicados em seu sistema.</span><span class="sxs-lookup"><span data-stu-id="a2940-173">The catch with this approach is that you now have duplicate data in your system.</span></span> <span data-ttu-id="a2940-174">No entanto, a duplicação *estratégica* de dados em sistemas nativos de nuvem é uma prática estabelecida e não é considerada um antipadrão ou uma prática inadequada.</span><span class="sxs-lookup"><span data-stu-id="a2940-174">However, *strategically* duplicating data in cloud-native systems is an established practice and not considered an anti-pattern, or bad practice.</span></span> <span data-ttu-id="a2940-175">Tenha em mente que *um e apenas um serviço* podem possuir um conjunto de dados e ter autoridade sobre ele.</span><span class="sxs-lookup"><span data-stu-id="a2940-175">Keep in mind that *one and only one service* can own a data set and have authority over it.</span></span> <span data-ttu-id="a2940-176">Você precisará sincronizar os modelos de leitura quando o sistema de registro for atualizado.</span><span class="sxs-lookup"><span data-stu-id="a2940-176">You'll need to synchronize the read models when the system of record is updated.</span></span> <span data-ttu-id="a2940-177">Normalmente, a sincronização é implementada por meio de mensagens assíncronas com um [padrão de publicação/assinatura](service-to-service-communication.md#events), como mostra a Figura 5,4.</span><span class="sxs-lookup"><span data-stu-id="a2940-177">Synchronization is typically implemented via asynchronous messaging with a [publish/subscribe pattern](service-to-service-communication.md#events), as shown in Figure 5.4.</span></span>

## <a name="distributed-transactions"></a><span data-ttu-id="a2940-178">Transações distribuídas</span><span class="sxs-lookup"><span data-stu-id="a2940-178">Distributed transactions</span></span>

<span data-ttu-id="a2940-179">Embora seja difícil consultar dados em microserviços, a implementação de uma transação em vários microserviços é ainda mais complexa.</span><span class="sxs-lookup"><span data-stu-id="a2940-179">While querying data across microservices is difficult, implementing a transaction across several microservices is even more complex.</span></span> <span data-ttu-id="a2940-180">O desafio inerente de manter a consistência de dados entre fontes de dados independentes em diferentes microservices não pode ser subestado.</span><span class="sxs-lookup"><span data-stu-id="a2940-180">The inherent challenge of maintaining data consistency across independent data sources in different microservices can't be understated.</span></span> <span data-ttu-id="a2940-181">A falta de transações distribuídas em aplicativos nativos de nuvem significa que você deve gerenciar transações distribuídas programaticamente.</span><span class="sxs-lookup"><span data-stu-id="a2940-181">The lack of distributed transactions in cloud-native applications means that you must manage distributed transactions programmatically.</span></span> <span data-ttu-id="a2940-182">Você passa de um mundo de *consistência imediata* para a *consistência eventual*.</span><span class="sxs-lookup"><span data-stu-id="a2940-182">You move from a world of *immediate consistency* to that of *eventual consistency*.</span></span>

<span data-ttu-id="a2940-183">A Figura 5-5 mostra o problema.</span><span class="sxs-lookup"><span data-stu-id="a2940-183">Figure 5-5 shows the problem.</span></span>

![Transação no padrão saga](./media/saga-transaction-operation.png)

<span data-ttu-id="a2940-185">**Figura 5-5**.</span><span class="sxs-lookup"><span data-stu-id="a2940-185">**Figure 5-5**.</span></span> <span data-ttu-id="a2940-186">Implementando uma transação em microserviços</span><span class="sxs-lookup"><span data-stu-id="a2940-186">Implementing a transaction across microservices</span></span>

<span data-ttu-id="a2940-187">Na figura anterior, cinco microserviços independentes participam de uma transação distribuída que cria um pedido.</span><span class="sxs-lookup"><span data-stu-id="a2940-187">In the preceding figure, five independent microservices participate in a distributed transaction that creates an order.</span></span> <span data-ttu-id="a2940-188">Cada microserviço mantém seu próprio armazenamento de dados e implementa uma transação local para seu armazenamento.</span><span class="sxs-lookup"><span data-stu-id="a2940-188">Each microservice maintains its own data store and implements a local transaction for its store.</span></span> <span data-ttu-id="a2940-189">Para criar o pedido, a transação local para *cada* Microservice individual deve ter sucesso ou *todos* devem abortar e reverter a operação.</span><span class="sxs-lookup"><span data-stu-id="a2940-189">To create the order, the local transaction for *each* individual microservice must succeed, or *all* must abort and roll back the operation.</span></span> <span data-ttu-id="a2940-190">Embora o suporte interno transacional esteja disponível dentro de cada um dos microserviços, não há suporte para uma transação distribuída que se englobe em todos os cinco serviços para manter os dados consistentes.</span><span class="sxs-lookup"><span data-stu-id="a2940-190">While built-in transactional support is available inside each of the microservices, there's no support for a distributed transaction that would span across all five services to keep data consistent.</span></span>

<span data-ttu-id="a2940-191">Em vez disso, você deve construir essa transação distribuída *programaticamente*.</span><span class="sxs-lookup"><span data-stu-id="a2940-191">Instead, you must construct this distributed transaction *programmatically*.</span></span>

<span data-ttu-id="a2940-192">Um padrão popular para adicionar suporte transacional distribuído é o padrão saga.</span><span class="sxs-lookup"><span data-stu-id="a2940-192">A popular pattern for adding distributed transactional support is the Saga pattern.</span></span> <span data-ttu-id="a2940-193">Ele é implementado agrupando transações locais em conjunto de forma programática e invocando sequencialmente cada uma.</span><span class="sxs-lookup"><span data-stu-id="a2940-193">It's implemented by grouping local transactions together programmatically and sequentially invoking each one.</span></span> <span data-ttu-id="a2940-194">Se qualquer uma das transações locais falhar, o saga anulará a operação e invocará um conjunto de [Transações de compensação](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span><span class="sxs-lookup"><span data-stu-id="a2940-194">If any of the local transactions fail, the Saga aborts the operation and invokes a set of [compensating transactions](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span></span> <span data-ttu-id="a2940-195">As transações de compensação desfazem as alterações feitas pelas transações locais anteriores e restauram a consistência de dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-195">The compensating transactions undo the changes made by the preceding local transactions and restore data consistency.</span></span> <span data-ttu-id="a2940-196">A Figura 5-6 mostra uma transação com falha com o padrão saga.</span><span class="sxs-lookup"><span data-stu-id="a2940-196">Figure 5-6 shows a failed transaction with the Saga pattern.</span></span>

![Reverter no padrão saga](./media/saga-rollback-operation.png)

<span data-ttu-id="a2940-198">**Figura 5-6**.</span><span class="sxs-lookup"><span data-stu-id="a2940-198">**Figure 5-6**.</span></span> <span data-ttu-id="a2940-199">Reverter uma transação</span><span class="sxs-lookup"><span data-stu-id="a2940-199">Rolling back a transaction</span></span>

<span data-ttu-id="a2940-200">Na figura anterior, a operação *Atualizar inventário* falhou no microserviço de inventário.</span><span class="sxs-lookup"><span data-stu-id="a2940-200">In the previous figure, the *Update Inventory* operation has failed in the Inventory microservice.</span></span> <span data-ttu-id="a2940-201">O saga invoca um conjunto de transações de compensação (em vermelho) para ajustar as contagens de inventário, cancelar o pagamento e a ordem e retornar os dados para cada microserviço de volta para um estado consistente.</span><span class="sxs-lookup"><span data-stu-id="a2940-201">The Saga invokes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return the data for each microservice back to a consistent state.</span></span>

<span data-ttu-id="a2940-202">Os padrões de Saga geralmente são coreografado como uma série de eventos relacionados ou orquestrados como um conjunto de comandos relacionados.</span><span class="sxs-lookup"><span data-stu-id="a2940-202">Saga patterns are typically choreographed as a series of related events, or orchestrated as a set of related commands.</span></span> <span data-ttu-id="a2940-203">No capítulo 4, discutimos o padrão agregador de serviço que seria a base para uma implementação de Saga orquestrada.</span><span class="sxs-lookup"><span data-stu-id="a2940-203">In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an orchestrated saga implementation.</span></span> <span data-ttu-id="a2940-204">Também discutimos eventos em conjunto com os tópicos do barramento de serviço do Azure e da grade de eventos do Azure que seriam uma base para uma implementação coreografado saga.</span><span class="sxs-lookup"><span data-stu-id="a2940-204">We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation for a choreographed saga implementation.</span></span>

## <a name="high-volume-data"></a><span data-ttu-id="a2940-205">Dados de alto volume</span><span class="sxs-lookup"><span data-stu-id="a2940-205">High volume data</span></span>

<span data-ttu-id="a2940-206">Grandes aplicativos nativos de nuvem geralmente dão suporte a requisitos de dados de alto volume.</span><span class="sxs-lookup"><span data-stu-id="a2940-206">Large cloud-native applications often support high-volume data requirements.</span></span> <span data-ttu-id="a2940-207">Nesses cenários, as técnicas tradicionais de armazenamento de dados podem causar gargalos.</span><span class="sxs-lookup"><span data-stu-id="a2940-207">In these scenarios, traditional data storage techniques can cause bottlenecks.</span></span> <span data-ttu-id="a2940-208">Para sistemas complexos que implantam em grande escala, o Separação das Operações de Comando e de Consulta (CQRS) e o fornecimento de eventos podem melhorar o desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a2940-208">For complex systems that deploy on a large scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.</span></span>  

### <a name="cqrs"></a><span data-ttu-id="a2940-209">CQRS</span><span class="sxs-lookup"><span data-stu-id="a2940-209">CQRS</span></span>

<span data-ttu-id="a2940-210">O [CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), é um padrão de arquitetura que pode ajudar a maximizar o desempenho, a escalabilidade e a segurança.</span><span class="sxs-lookup"><span data-stu-id="a2940-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), is an architectural pattern that can help maximize performance, scalability, and security.</span></span> <span data-ttu-id="a2940-211">O padrão separa as operações que lêem dados dessas operações que gravam dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-211">The pattern separates operations that read data from those operations that write data.</span></span> 

<span data-ttu-id="a2940-212">Para cenários normais, o mesmo modelo de entidade e objeto de repositório de dados são *usados para operações* de leitura e gravação.</span><span class="sxs-lookup"><span data-stu-id="a2940-212">For normal scenarios, the same entity model and data repository object are used for *both* read and write operations.</span></span>

<span data-ttu-id="a2940-213">No entanto, um cenário de dados de alto volume pode se beneficiar de modelos e tabelas de dados separados para leituras e gravações.</span><span class="sxs-lookup"><span data-stu-id="a2940-213">However, a high volume data scenario can benefit from separate models and data tables for reads and writes.</span></span> <span data-ttu-id="a2940-214">Para melhorar o desempenho, a operação de leitura pode consultar uma representação altamente desnormalizada dos dados para evitar junções de tabelas e bloqueios de tabelas repetitivas e decaradas.</span><span class="sxs-lookup"><span data-stu-id="a2940-214">To improve performance, the read operation could query against a highly denormalized representation of the data to avoid expensive repetitive table joins and table locks.</span></span> <span data-ttu-id="a2940-215">A operação de *gravação* , conhecida como um *comando*, seria atualizada em uma representação totalmente normalizada dos dados que garantiria a consistência.</span><span class="sxs-lookup"><span data-stu-id="a2940-215">The *write* operation, known as a *command*, would update against a fully normalized representation of the data that would guarantee consistency.</span></span> <span data-ttu-id="a2940-216">Em seguida, você precisa implementar um mecanismo para manter ambas as representações em sincronia. Normalmente, sempre que a tabela de gravação é modificada, ela publica um evento que Replica a modificação para a tabela de leitura.</span><span class="sxs-lookup"><span data-stu-id="a2940-216">You then need to implement a mechanism to keep both representations in sync. Typically, whenever the write table is modified, it publishes an event that replicates the modification to the read table.</span></span>

<span data-ttu-id="a2940-217">A Figura 5-7 mostra uma implementação do padrão CQRS.</span><span class="sxs-lookup"><span data-stu-id="a2940-217">Figure 5-7 shows an implementation of the CQRS pattern.</span></span>

![Separação das Operações de Comando e de Consulta](./media/cqrs-implementation.png)

<span data-ttu-id="a2940-219">**Figura 5-7**.</span><span class="sxs-lookup"><span data-stu-id="a2940-219">**Figure 5-7**.</span></span> <span data-ttu-id="a2940-220">Implementação de CQRS</span><span class="sxs-lookup"><span data-stu-id="a2940-220">CQRS implementation</span></span>

<span data-ttu-id="a2940-221">Na figura anterior, são implementados os modelos de comando e consulta separados.</span><span class="sxs-lookup"><span data-stu-id="a2940-221">In the previous figure, separate command and query models are implemented.</span></span> <span data-ttu-id="a2940-222">Cada operação de gravação de dados é salva no repositório de gravação e, em seguida, propagada para o repositório de leitura.</span><span class="sxs-lookup"><span data-stu-id="a2940-222">Each data write operation is saved to the write store and then propagated to the read store.</span></span> <span data-ttu-id="a2940-223">Preste muita atenção à forma como o processo de propagação de dados opera no princípio de [consistência eventual](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span><span class="sxs-lookup"><span data-stu-id="a2940-223">Pay close attention to how the data propagation process operates on the principle of [eventual consistency](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span></span> <span data-ttu-id="a2940-224">O modelo de leitura eventualmente sincroniza com o modelo de gravação, mas pode haver algum atraso no processo.</span><span class="sxs-lookup"><span data-stu-id="a2940-224">The read model eventually synchronizes with the write model, but there may be some lag in the process.</span></span> <span data-ttu-id="a2940-225">Discutiremos a consistência eventual na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="a2940-225">We discuss eventual consistency in the next section.</span></span>

<span data-ttu-id="a2940-226">Essa separação permite que leituras e gravações sejam dimensionadas de forma independente.</span><span class="sxs-lookup"><span data-stu-id="a2940-226">This separation enables reads and writes to scale independently.</span></span> <span data-ttu-id="a2940-227">As operações de leitura usam um esquema otimizado para consultas, enquanto as gravações usam um esquema otimizado para atualizações.</span><span class="sxs-lookup"><span data-stu-id="a2940-227">Read operations use a schema optimized for queries, while the writes use a schema optimized for updates.</span></span> <span data-ttu-id="a2940-228">As consultas de leitura vão contra dados desnormalizados, enquanto a lógica de negócios complexa pode ser aplicada ao modelo de gravação.</span><span class="sxs-lookup"><span data-stu-id="a2940-228">Read queries go against denormalized data, while complex business logic can be applied to the write model.</span></span> <span data-ttu-id="a2940-229">Além de isso, você pode impor uma segurança mais rígida em operações de gravação do que aquelas que expõem leituras.</span><span class="sxs-lookup"><span data-stu-id="a2940-229">As well, you might impose tighter security on write operations than those exposing reads.</span></span>

<span data-ttu-id="a2940-230">A implementação do CQRS pode melhorar o desempenho do aplicativo para serviços nativos de nuvem.</span><span class="sxs-lookup"><span data-stu-id="a2940-230">Implementing CQRS can improve application performance for cloud-native services.</span></span> <span data-ttu-id="a2940-231">No entanto, isso resulta em um design mais complexo.</span><span class="sxs-lookup"><span data-stu-id="a2940-231">However, it does result in a more complex design.</span></span> <span data-ttu-id="a2940-232">Aplique esse princípio com cuidado e estrategicamente a essas seções de seu aplicativo nativo de nuvem que se beneficiarão dela.</span><span class="sxs-lookup"><span data-stu-id="a2940-232">Apply this principle carefully and strategically to those sections of your cloud-native application that will benefit from it.</span></span> <span data-ttu-id="a2940-233">Para saber mais sobre o CQRS, confira os [microserviços do Microsoft book .net: arquitetura para aplicativos .net em contêineres](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span><span class="sxs-lookup"><span data-stu-id="a2940-233">For more on CQRS, see the Microsoft book [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span></span>

### <a name="event-sourcing"></a><span data-ttu-id="a2940-234">Fornecimento de eventos</span><span class="sxs-lookup"><span data-stu-id="a2940-234">Event sourcing</span></span>

<span data-ttu-id="a2940-235">Outra abordagem para otimizar cenários de dados de alto volume envolve o [fornecimento de eventos](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span><span class="sxs-lookup"><span data-stu-id="a2940-235">Another approach to optimizing high volume data scenarios involves [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span></span>

<span data-ttu-id="a2940-236">Normalmente, um sistema armazena o estado atual de uma entidade de dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-236">A system typically stores the current state of a data entity.</span></span> <span data-ttu-id="a2940-237">Se um usuário alterar seu número de telefone, por exemplo, o registro do cliente será atualizado com o novo número.</span><span class="sxs-lookup"><span data-stu-id="a2940-237">If a user changes their phone number, for example, the customer record is updated with the new number.</span></span> <span data-ttu-id="a2940-238">Sempre sabemos o estado atual de uma entidade de dados, mas cada atualização substitui o estado anterior.</span><span class="sxs-lookup"><span data-stu-id="a2940-238">We always know the current state of a data entity, but each update overwrites the previous state.</span></span> 

<span data-ttu-id="a2940-239">Na maioria dos casos, esse modelo funciona bem.</span><span class="sxs-lookup"><span data-stu-id="a2940-239">In most cases, this model works fine.</span></span> <span data-ttu-id="a2940-240">No entanto, em sistemas de alto volume, a sobrecarga do bloqueio transacional e das operações de atualização frequentes pode afetar o desempenho, a capacidade de resposta e a escalabilidade do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-240">In high volume systems, however, overhead from transactional locking and frequent update operations can impact database performance, responsiveness, and limit scalability.</span></span>

<span data-ttu-id="a2940-241">O fornecimento de eventos usa uma abordagem diferente para capturar dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-241">Event Sourcing takes a different approach to capturing data.</span></span> <span data-ttu-id="a2940-242">Cada operação que afeta os dados é persistida em um repositório de eventos.</span><span class="sxs-lookup"><span data-stu-id="a2940-242">Each operation that affects data is persisted to an event store.</span></span> <span data-ttu-id="a2940-243">Em vez de atualizar o estado de um registro de dados, acrescentamos cada alteração a uma lista sequencial de eventos passados, semelhante ao razão de um contador.</span><span class="sxs-lookup"><span data-stu-id="a2940-243">Instead of updating the state of a data record, we append each change to a sequential list of past events - similar to an accountant's ledger.</span></span> <span data-ttu-id="a2940-244">O repositório de eventos torna-se o sistema de registro dos dados.</span><span class="sxs-lookup"><span data-stu-id="a2940-244">The Event Store becomes the system of record for the data.</span></span> <span data-ttu-id="a2940-245">Ele é usado para propagar várias exibições materializadas dentro do contexto limitado de um microserviço.</span><span class="sxs-lookup"><span data-stu-id="a2940-245">It's used to propagate various materialized views within the bounded context of a microservice.</span></span> <span data-ttu-id="a2940-246">A Figura 5,8 mostra o padrão.</span><span class="sxs-lookup"><span data-stu-id="a2940-246">Figure 5.8 shows the pattern.</span></span>

![Fornecimento de eventos](./media/event-sourcing.png)

<span data-ttu-id="a2940-248">**Figura 5-8**.</span><span class="sxs-lookup"><span data-stu-id="a2940-248">**Figure 5-8**.</span></span> <span data-ttu-id="a2940-249">Fornecimento de eventos</span><span class="sxs-lookup"><span data-stu-id="a2940-249">Event Sourcing</span></span>

<span data-ttu-id="a2940-250">Na figura anterior, observe como cada entrada (em azul) para o carrinho de compras de um usuário é anexada a um repositório de eventos subjacente.</span><span class="sxs-lookup"><span data-stu-id="a2940-250">In the previous figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying event store.</span></span> <span data-ttu-id="a2940-251">Na exibição materializada adjacente, o sistema projeta o estado atual reproduzindo todos os eventos associados a cada carrinho de compras.</span><span class="sxs-lookup"><span data-stu-id="a2940-251">In the adjoining materialized view, the system projects the current state by replaying all the events associated with each shopping cart.</span></span> <span data-ttu-id="a2940-252">Esse modo de exibição ou leitura de modelo é então exposto de volta para a interface do usuário.</span><span class="sxs-lookup"><span data-stu-id="a2940-252">This view, or read model, is then exposed back to the UI.</span></span> <span data-ttu-id="a2940-253">Os eventos também podem ser integrados a sistemas e aplicativos externos ou consultados para determinar o estado atual de uma entidade.</span><span class="sxs-lookup"><span data-stu-id="a2940-253">Events can also be integrated with external systems and applications or queried to determine the current state of an entity.</span></span> <span data-ttu-id="a2940-254">Com essa abordagem, você mantém o histórico.</span><span class="sxs-lookup"><span data-stu-id="a2940-254">With this approach, you maintain history.</span></span> <span data-ttu-id="a2940-255">Você sabe não apenas o estado atual de uma entidade, mas também como chegou a esse estado.</span><span class="sxs-lookup"><span data-stu-id="a2940-255">You know not only the current state of an entity, but also how you reached this state.</span></span>

<span data-ttu-id="a2940-256">Falando mecânico, o fornecimento de eventos simplifica o modelo de gravação.</span><span class="sxs-lookup"><span data-stu-id="a2940-256">Mechanically speaking, event sourcing simplifies the write model.</span></span> <span data-ttu-id="a2940-257">Não há atualizações ou exclusões.</span><span class="sxs-lookup"><span data-stu-id="a2940-257">There are no updates or deletes.</span></span> <span data-ttu-id="a2940-258">Acrescentar cada entrada de dados como um evento imutável minimiza a contenção, o bloqueio e os conflitos de simultaneidade associados a bancos de dados relacionais.</span><span class="sxs-lookup"><span data-stu-id="a2940-258">Appending each data entry as an immutable event minimizes contention, locking, and concurrency conflicts associated with relational databases.</span></span> <span data-ttu-id="a2940-259">A criação de modelos de leitura com o padrão de exibição materializada permite desacoplar o modo de exibição do modelo de gravação e escolher o melhor armazenamento de dados para otimizar as necessidades da interface do usuário do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a2940-259">Building read models with the materialized view pattern enables you to decouple the view from the write model and choose the best data store to optimize the needs of your application UI.</span></span>

<span data-ttu-id="a2940-260">Para esse padrão, considere um armazenamento de dados que dá suporte diretamente a fornecimento de eventos.</span><span class="sxs-lookup"><span data-stu-id="a2940-260">For this pattern, consider a data store that directly supports event sourcing.</span></span> <span data-ttu-id="a2940-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB e RavenDB são bons candidatos.</span><span class="sxs-lookup"><span data-stu-id="a2940-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB are good candidates.</span></span>

<span data-ttu-id="a2940-262">Assim como acontece com todos os padrões e tecnologias, implemente estrategicamente e quando necessário.</span><span class="sxs-lookup"><span data-stu-id="a2940-262">As with all patterns and technologies, implement strategically and when needed.</span></span> <span data-ttu-id="a2940-263">Embora o fornecimento de eventos possa fornecer maior desempenho e escalabilidade, ele traz a despesa de complexidade e de uma curva de aprendizado.</span><span class="sxs-lookup"><span data-stu-id="a2940-263">While event sourcing can provide increased performance and scalability, it comes at the expense of complexity and a learning curve.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="a2940-264">[Anterior](service-mesh-communication-infrastructure.md)
>[Próximo](relational-vs-nosql-data.md)</span><span class="sxs-lookup"><span data-stu-id="a2940-264">[Previous](service-mesh-communication-infrastructure.md)
[Next](relational-vs-nosql-data.md)</span></span>
