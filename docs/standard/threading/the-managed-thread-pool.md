---
title: O pool de threads gerenciados
description: Saiba mais sobre o pool de threads do .NET que fornece threads de trabalho em segundo plano
ms.date: 08/02/2018
ms.technology: dotnet-standard
helpviewer_keywords:
- thread pooling [.NET]
- thread pools [.NET]
- threading [.NET], thread pool
- threading [.NET], pooling
ms.assetid: 2be05b06-a42e-4c9d-a739-96c21d673927
ms.openlocfilehash: 2671ce7c9721b15de8a3805da27040e973a62804
ms.sourcegitcommit: 67ebdb695fd017d79d9f1f7f35d145042d5a37f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/20/2020
ms.locfileid: "92223790"
---
# <a name="the-managed-thread-pool"></a><span data-ttu-id="e19fc-103">O pool de threads gerenciados</span><span class="sxs-lookup"><span data-stu-id="e19fc-103">The managed thread pool</span></span>

<span data-ttu-id="e19fc-104">A classe <xref:System.Threading.ThreadPool?displayProperty=nameWithType> fornece ao seu aplicativo um pool de threads de trabalho gerenciados pelo sistema, permitindo que você se concentre em tarefas de aplicativo, e não no gerenciamento de threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-104">The <xref:System.Threading.ThreadPool?displayProperty=nameWithType> class provides your application with a pool of worker threads that are managed by the system, allowing you to concentrate on application tasks rather than thread management.</span></span> <span data-ttu-id="e19fc-105">Se você tiver tarefas curtas que exigem processamento em segundo plano, o pool de threads gerenciados será uma maneira fácil de aproveitar os vários threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-105">If you have short tasks that require background processing, the managed thread pool is an easy way to take advantage of multiple threads.</span></span> <span data-ttu-id="e19fc-106">O uso do pool de threads é significativamente mais fácil no Framework 4 e versões posteriores, já que você pode criar objetos <xref:System.Threading.Tasks.Task> e <xref:System.Threading.Tasks.Task%601> que executam tarefas assíncronas em threads do pool de threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-106">Use of the thread pool is significantly easier in Framework 4 and later, since you can create <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> objects that perform asynchronous tasks on thread pool threads.</span></span>  
  
<span data-ttu-id="e19fc-107">O .NET usa threads do pool de threads para muitos fins, incluindo em operações de [TPL (Biblioteca de Paralelismo de Tarefas)](../parallel-programming/task-parallel-library-tpl.md), na conclusão de E/S assíncrona, em retornos de chamada [timer](timers.md), em operações de espera registradas, em chamadas de método assíncrono usando delegados e em conexões de soquete <xref:System.Net?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e19fc-107">.NET uses thread pool threads for many purposes, including [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) operations, asynchronous I/O completion, [timer](timers.md) callbacks, registered wait operations, asynchronous method calls using delegates, and <xref:System.Net?displayProperty=nameWithType> socket connections.</span></span>  

## <a name="thread-pool-characteristics"></a><span data-ttu-id="e19fc-108">Características do pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-108">Thread pool characteristics</span></span>

<span data-ttu-id="e19fc-109">Os threads de pool de threads são threads de [segundo plano](foreground-and-background-threads.md).</span><span class="sxs-lookup"><span data-stu-id="e19fc-109">Thread pool threads are [background](foreground-and-background-threads.md) threads.</span></span> <span data-ttu-id="e19fc-110">Cada thread usa o tamanho da pilha padrão, é executado com prioridade padrão e está no apartamento de vários threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-110">Each thread uses the default stack size, runs at the default priority, and is in the multithreaded apartment.</span></span> <span data-ttu-id="e19fc-111">Depois que um thread do pool conclui sua tarefa, ele é retornado para uma fila de threads em espera.</span><span class="sxs-lookup"><span data-stu-id="e19fc-111">Once a thread in the thread pool completes its task, it's returned to a queue of waiting threads.</span></span> <span data-ttu-id="e19fc-112">A partir desse momento, ele pode ser reutilizado.</span><span class="sxs-lookup"><span data-stu-id="e19fc-112">From this moment it can be reused.</span></span> <span data-ttu-id="e19fc-113">Essa reutilização permite que os aplicativos evitem o custo de criação de um novo thread para cada tarefa.</span><span class="sxs-lookup"><span data-stu-id="e19fc-113">This reuse enables applications to avoid the cost of creating a new thread for each task.</span></span>
  
<span data-ttu-id="e19fc-114">Há apenas um pool de threads por processo.</span><span class="sxs-lookup"><span data-stu-id="e19fc-114">There is only one thread pool per process.</span></span>  
  
### <a name="exceptions-in-thread-pool-threads"></a><span data-ttu-id="e19fc-115">Exceções em threads do pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-115">Exceptions in thread pool threads</span></span>

<span data-ttu-id="e19fc-116">Exceções sem tratamento nos threads do pool de threads encerram o processo.</span><span class="sxs-lookup"><span data-stu-id="e19fc-116">Unhandled exceptions in thread pool threads terminate the process.</span></span> <span data-ttu-id="e19fc-117">Há três exceções a essa regra:</span><span class="sxs-lookup"><span data-stu-id="e19fc-117">There are three exceptions to this rule:</span></span>  
  
- <span data-ttu-id="e19fc-118">Um <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> é gerado em um thread do pool de threads porque <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> foi chamado.</span><span class="sxs-lookup"><span data-stu-id="e19fc-118">A <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> is thrown in a thread pool thread because <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> was called.</span></span>  
- <span data-ttu-id="e19fc-119">Um <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> é gerado em um thread do pool de threads porque o domínio do aplicativo está sendo descarregado.</span><span class="sxs-lookup"><span data-stu-id="e19fc-119">A <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> is thrown in a thread pool thread because the application domain is being unloaded.</span></span>  
- <span data-ttu-id="e19fc-120">O CLR ou um processo de host encerra o thread.</span><span class="sxs-lookup"><span data-stu-id="e19fc-120">The common language runtime or a host process terminates the thread.</span></span>  
  
<span data-ttu-id="e19fc-121">Para obter mais informações, consulte [exceções em threads gerenciados](exceptions-in-managed-threads.md).</span><span class="sxs-lookup"><span data-stu-id="e19fc-121">For more information, see [Exceptions in Managed Threads](exceptions-in-managed-threads.md).</span></span>  
  
### <a name="maximum-number-of-thread-pool-threads"></a><span data-ttu-id="e19fc-122">Número máximo de threads do pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-122">Maximum number of thread pool threads</span></span>

<span data-ttu-id="e19fc-123">O número de operações que podem ser enfileiradas para o pool de threads é limitado apenas pela memória disponível.</span><span class="sxs-lookup"><span data-stu-id="e19fc-123">The number of operations that can be queued to the thread pool is limited only by available memory.</span></span> <span data-ttu-id="e19fc-124">No entanto, o pool de threads limita o número de threads que podem estar ativos no processo simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="e19fc-124">However, the thread pool limits the number of threads that can be active in the process simultaneously.</span></span> <span data-ttu-id="e19fc-125">Se todos os threads do pool de threads estiverem ocupados, itens de trabalho adicionais serão enfileirados até que os threads para os executar se tornem disponíveis.</span><span class="sxs-lookup"><span data-stu-id="e19fc-125">If all thread pool threads are busy, additional work items are queued until threads to execute them become available.</span></span> <span data-ttu-id="e19fc-126">A partir do .NET Framework 4, o tamanho padrão do pool de threads de um processo depende de vários fatores, como o tamanho do espaço de endereço virtual.</span><span class="sxs-lookup"><span data-stu-id="e19fc-126">Beginning with the .NET Framework 4, the default size of the thread pool for a process depends on several factors, such as the size of the virtual address space.</span></span> <span data-ttu-id="e19fc-127">Um processo pode chamar o método <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> para determinar o número de threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-127">A process can call the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> method to determine the number of threads.</span></span>  
  
<span data-ttu-id="e19fc-128">Você pode controlar o número máximo de threads usando os métodos <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> e <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e19fc-128">You can control the maximum number of threads by using the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType> methods.</span></span>  

> [!NOTE]
> <span data-ttu-id="e19fc-129">O código que hospeda o Common Language Runtime pode definir o tamanho usando o [`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md) método.</span><span class="sxs-lookup"><span data-stu-id="e19fc-129">Code that hosts the common language runtime can set the size using the [`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md) method.</span></span>  
  
### <a name="thread-pool-minimums"></a><span data-ttu-id="e19fc-130">Valores mínimos no pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-130">Thread pool minimums</span></span>

<span data-ttu-id="e19fc-131">O pool de threads fornece novos threads de trabalho ou threads de conclusão de E/S sob demanda, até atingir um mínimo especificado para cada categoria.</span><span class="sxs-lookup"><span data-stu-id="e19fc-131">The thread pool provides new worker threads or I/O completion threads on demand until it reaches a specified minimum for each category.</span></span> <span data-ttu-id="e19fc-132">Você pode usar o método <xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType> para obter esses valores mínimos.</span><span class="sxs-lookup"><span data-stu-id="e19fc-132">You can use the <xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType> method to obtain these minimum values.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e19fc-133">Quando a demanda é baixa, o número real de threads do pool de threads pode ficar abaixo dos valores mínimos.</span><span class="sxs-lookup"><span data-stu-id="e19fc-133">When demand is low, the actual number of thread pool threads can fall below the minimum values.</span></span>  
  
<span data-ttu-id="e19fc-134">Quando o mínimo é atingido, o pool de threads pode criar threads adicionais ou aguardar a conclusão de algumas tarefas.</span><span class="sxs-lookup"><span data-stu-id="e19fc-134">When a minimum is reached, the thread pool can create additional threads or wait until some tasks complete.</span></span> <span data-ttu-id="e19fc-135">A partir do .NET Framework 4, o pool de threads cria e destrói threads de trabalho a fim de otimizar a taxa de transferência, que é definida como o número de tarefas concluídas por unidade de tempo.</span><span class="sxs-lookup"><span data-stu-id="e19fc-135">Beginning with the .NET Framework 4, the thread pool creates and destroys worker threads in order to optimize throughput, which is defined as the number of tasks that complete per unit of time.</span></span> <span data-ttu-id="e19fc-136">Pouquíssimos threads podem não fazer um uso ideal dos recursos disponíveis, enquanto muitos threads podem aumentar a contenção de recursos.</span><span class="sxs-lookup"><span data-stu-id="e19fc-136">Too few threads might not make optimal use of available resources, whereas too many threads could increase resource contention.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="e19fc-137">Use o método <xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType> para aumentar o número mínimo de threads ociosos.</span><span class="sxs-lookup"><span data-stu-id="e19fc-137">You can use the <xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType> method to increase the minimum number of idle threads.</span></span> <span data-ttu-id="e19fc-138">No entanto, o aumento desnecessário desses valores pode causar problemas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="e19fc-138">However, unnecessarily increasing these values can cause performance problems.</span></span> <span data-ttu-id="e19fc-139">Se muitas tarefas começarem ao mesmo tempo, todas elas podem parecer lentas.</span><span class="sxs-lookup"><span data-stu-id="e19fc-139">If too many tasks start at the same time, all of them might appear to be slow.</span></span> <span data-ttu-id="e19fc-140">Na maioria dos casos, o pool de threads terá um desempenho melhor com seu próprio algoritmo de alocação de threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-140">In most cases the thread pool will perform better with its own algorithm for allocating threads.</span></span>  

## <a name="using-the-thread-pool"></a><span data-ttu-id="e19fc-141">Usando o pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-141">Using the thread pool</span></span>

<span data-ttu-id="e19fc-142">A partir do .NET Framework 4, a maneira mais fácil de usar o pool de threads é usando a [TPL (Biblioteca de paralelismo de tarefas)](../parallel-programming/task-parallel-library-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="e19fc-142">Beginning with the .NET Framework 4, the easiest way to use the thread pool is to use the [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md).</span></span> <span data-ttu-id="e19fc-143">Por padrão, tipos de TPL como <xref:System.Threading.Tasks.Task> e <xref:System.Threading.Tasks.Task%601> usam threads do pool de threads para executar tarefas.</span><span class="sxs-lookup"><span data-stu-id="e19fc-143">By default, TPL types like <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> use thread pool threads to run tasks.</span></span>

<span data-ttu-id="e19fc-144">Você também pode usar o pool de threads chamando <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> de código gerenciado (ou [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md) de código não gerenciado) e passando um <xref:System.Threading.WaitCallback?displayProperty=nameWithType> delegado que representa o método que executa a tarefa.</span><span class="sxs-lookup"><span data-stu-id="e19fc-144">You can also use the thread pool by calling <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> from managed code (or [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md) from unmanaged code) and passing a <xref:System.Threading.WaitCallback?displayProperty=nameWithType> delegate representing the method that performs the task.</span></span>

<span data-ttu-id="e19fc-145">Outra maneira de usar o pool de threads é enfileirando itens de trabalho relacionados a uma operação de espera usando o método <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> e passando um <xref:System.Threading.WaitHandle?displayProperty=nameWithType> que, quando sinalizado ou após tempo limite, chama o método representado pelo delegado <xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e19fc-145">Another way to use the thread pool is to queue work items that are related to a wait operation by using the <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> method and passing a <xref:System.Threading.WaitHandle?displayProperty=nameWithType> that, when signaled or when timed out, calls the method represented by the <xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType> delegate.</span></span> <span data-ttu-id="e19fc-146">Os threads do pool de thread são usados para invocar métodos de retorno de chamada.</span><span class="sxs-lookup"><span data-stu-id="e19fc-146">Thread pool threads are used to invoke callback methods.</span></span>  

<span data-ttu-id="e19fc-147">Para os exemplos, verifique as páginas de API referenciadas.</span><span class="sxs-lookup"><span data-stu-id="e19fc-147">For the examples, check the referenced API pages.</span></span>
  
## <a name="skipping-security-checks"></a><span data-ttu-id="e19fc-148">Ignorando as verificações de segurança</span><span class="sxs-lookup"><span data-stu-id="e19fc-148">Skipping security checks</span></span>

<span data-ttu-id="e19fc-149">O pool de threads também fornece os métodos <xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> e <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e19fc-149">The thread pool also provides the <xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType> methods.</span></span> <span data-ttu-id="e19fc-150">Use estes métodos somente quando você tiver certeza de que a pilha do chamador é irrelevante a qualquer verificação de segurança executada durante a execução da tarefa em fila.</span><span class="sxs-lookup"><span data-stu-id="e19fc-150">Use these methods only when you are certain that the caller's stack is irrelevant to any security checks performed during the execution of the queued task.</span></span> <span data-ttu-id="e19fc-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> e <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> capturam a pilha do chamador, que é mesclada na pilha do thread do pool de threads quando o thread começa a executar uma tarefa.</span><span class="sxs-lookup"><span data-stu-id="e19fc-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> both capture the caller's stack, which is merged into the stack of the thread pool thread when the thread begins to execute a task.</span></span> <span data-ttu-id="e19fc-152">Se uma verificação de segurança for necessária, toda a pilha deverá ser verificada.</span><span class="sxs-lookup"><span data-stu-id="e19fc-152">If a security check is required, the entire stack must be checked.</span></span> <span data-ttu-id="e19fc-153">Embora a verificação forneça segurança, também tem um custo de desempenho.</span><span class="sxs-lookup"><span data-stu-id="e19fc-153">Although the check provides safety, it also has a performance cost.</span></span>  

## <a name="when-not-to-use-thread-pool-threads"></a><span data-ttu-id="e19fc-154">Quando não usar o thread do pool de threads</span><span class="sxs-lookup"><span data-stu-id="e19fc-154">When not to use thread pool threads</span></span>

<span data-ttu-id="e19fc-155">Há várias situações nas quais é apropriado criar e gerenciar seus próprios threads em vez de usar os threads do pool de threads:</span><span class="sxs-lookup"><span data-stu-id="e19fc-155">There are several scenarios in which it's appropriate to create and manage your own threads instead of using thread pool threads:</span></span>  
  
- <span data-ttu-id="e19fc-156">Você precisa de um thread em primeiro plano.</span><span class="sxs-lookup"><span data-stu-id="e19fc-156">You require a foreground thread.</span></span>  
- <span data-ttu-id="e19fc-157">Você precisa que um thread tenha uma prioridade específica.</span><span class="sxs-lookup"><span data-stu-id="e19fc-157">You require a thread to have a particular priority.</span></span>  
- <span data-ttu-id="e19fc-158">Há tarefas que causam o bloqueio do thread por longos períodos.</span><span class="sxs-lookup"><span data-stu-id="e19fc-158">You have tasks that cause the thread to block for long periods of time.</span></span> <span data-ttu-id="e19fc-159">O pool de threads tem um número máximo de threads, portanto, a existência de muitos threads do pool de threads bloqueados pode impedir a inicialização das tarefas.</span><span class="sxs-lookup"><span data-stu-id="e19fc-159">The thread pool has a maximum number of threads, so a large number of blocked thread pool threads might prevent tasks from starting.</span></span>  
- <span data-ttu-id="e19fc-160">Você precisa colocar os threads em um apartamento de thread único.</span><span class="sxs-lookup"><span data-stu-id="e19fc-160">You need to place threads into a single-threaded apartment.</span></span> <span data-ttu-id="e19fc-161">Todos os threads <xref:System.Threading.ThreadPool> estão no apartamento de vários threads.</span><span class="sxs-lookup"><span data-stu-id="e19fc-161">All <xref:System.Threading.ThreadPool> threads are in the multithreaded apartment.</span></span>  
- <span data-ttu-id="e19fc-162">Você precisa ter uma identidade estável associada ao thread, ou dedicar um thread a uma tarefa.</span><span class="sxs-lookup"><span data-stu-id="e19fc-162">You need to have a stable identity associated with the thread, or to dedicate a thread to a task.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e19fc-163">Consulte também</span><span class="sxs-lookup"><span data-stu-id="e19fc-163">See also</span></span>

- <xref:System.Threading.ThreadPool?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType>
- [<span data-ttu-id="e19fc-164">Biblioteca de tarefas paralelas (TPL)</span><span class="sxs-lookup"><span data-stu-id="e19fc-164">Task Parallel Library (TPL)</span></span>](../parallel-programming/task-parallel-library-tpl.md)
- [<span data-ttu-id="e19fc-165">Como: Retornar um valor de uma tarefa</span><span class="sxs-lookup"><span data-stu-id="e19fc-165">How to: Return a Value from a Task</span></span>](../parallel-programming/how-to-return-a-value-from-a-task.md)
- [<span data-ttu-id="e19fc-166">Threading de objetos e recursos</span><span class="sxs-lookup"><span data-stu-id="e19fc-166">Threading Objects and Features</span></span>](threading-objects-and-features.md)
- [<span data-ttu-id="e19fc-167">Threads e threading</span><span class="sxs-lookup"><span data-stu-id="e19fc-167">Threads and Threading</span></span>](threads-and-threading.md)
- [<span data-ttu-id="e19fc-168">E/s de arquivo assíncrono</span><span class="sxs-lookup"><span data-stu-id="e19fc-168">Asynchronous File I/O</span></span>](../io/asynchronous-file-i-o.md)
- [<span data-ttu-id="e19fc-169">Temporizadores</span><span class="sxs-lookup"><span data-stu-id="e19fc-169">Timers</span></span>](timers.md)
