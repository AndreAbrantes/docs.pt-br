---
title: "Como escrever um loop Parallel.ForEach com variáveis locais de thread"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
caps.latest.revision: 
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 4c65edd8959cbf5f83e3353770f71cad130953d1
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/23/2017
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="279c1-102">Como escrever um loop Parallel.ForEach com variáveis locais de thread</span><span class="sxs-lookup"><span data-stu-id="279c1-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="279c1-103">O exemplo a seguir mostra como gravar um método <xref:System.Threading.Tasks.Parallel.ForEach%2A> que usa variáveis de thread local.</span><span class="sxs-lookup"><span data-stu-id="279c1-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="279c1-104">Quando um loop <xref:System.Threading.Tasks.Parallel.ForEach%2A> é executado, ele divide a coleção de origem em diversas partições.</span><span class="sxs-lookup"><span data-stu-id="279c1-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="279c1-105">Cada partição tem sua própria cópia da variável de "thread local".</span><span class="sxs-lookup"><span data-stu-id="279c1-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="279c1-106">O termo "thread local" não é muito preciso por que, em alguns casos, duas partições podem executar no mesmo thread.</span><span class="sxs-lookup"><span data-stu-id="279c1-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="279c1-107">O código e os parâmetros desse exemplo parecem com o método <xref:System.Threading.Tasks.Parallel.For%2A> correspondente.</span><span class="sxs-lookup"><span data-stu-id="279c1-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="279c1-108">Para saber mais, confira [Como escrever um loop Parallel.For com variáveis locais de thread](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="279c1-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="279c1-109">Para usar uma variável de thread local em um loop <xref:System.Threading.Tasks.Parallel.ForEach%2A>, você deve chamar uma das sobrecargas de método que usa dois parâmetros de tipos.</span><span class="sxs-lookup"><span data-stu-id="279c1-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="279c1-110">O primeiro parâmetro de tipo, `TSource`, especifica o tipo do elemento de origem. Já o segundo, `TLocal`, especifica o tipo da variável de thread local.</span><span class="sxs-lookup"><span data-stu-id="279c1-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="279c1-111">Exemplo</span><span class="sxs-lookup"><span data-stu-id="279c1-111">Example</span></span>  
 <span data-ttu-id="279c1-112">O exemplo a seguir chama a sobrecarga <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> para calcular a soma de uma matriz com um milhão de elementos.</span><span class="sxs-lookup"><span data-stu-id="279c1-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="279c1-113">Essa sobrecarga tem quatro parâmetros:</span><span class="sxs-lookup"><span data-stu-id="279c1-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="279c1-114">`source`, que é a fonte de dados.</span><span class="sxs-lookup"><span data-stu-id="279c1-114">`source`, which is the data source.</span></span> <span data-ttu-id="279c1-115">Ela deve implementar <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="279c1-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="279c1-116">A fonte de dados do nosso exemplo é um objeto `IEnumerable<Int32>` membro de um milhão retornado pelo método <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="279c1-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="279c1-117">`localInit`, ou a função que inicia a variável de thread local.</span><span class="sxs-lookup"><span data-stu-id="279c1-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="279c1-118">Essa função é chamada uma vez para cada partição onde a operação <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> é executada.</span><span class="sxs-lookup"><span data-stu-id="279c1-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="279c1-119">Nosso exemplo inicia a variável de thread local como zero.</span><span class="sxs-lookup"><span data-stu-id="279c1-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="279c1-120">`body`, um <xref:System.Func%604> que é invocado pelo loop paralelo em cada iteração do loop.</span><span class="sxs-lookup"><span data-stu-id="279c1-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="279c1-121">Sua assinatura é `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="279c1-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="279c1-122">Você fornece o código para o representante e o loop passa pelos parâmetros de entrada, que são:</span><span class="sxs-lookup"><span data-stu-id="279c1-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="279c1-123">O elemento atual de <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="279c1-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="279c1-124">Uma variável <xref:System.Threading.Tasks.ParallelLoopState> que pode ser usada no código do representante para avaliar o estado do loop.</span><span class="sxs-lookup"><span data-stu-id="279c1-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="279c1-125">A variável de thread local.</span><span class="sxs-lookup"><span data-stu-id="279c1-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="279c1-126">Seu representante retorna a variável de thread local, que é apresentada para a próxima iteração do loop que executa nessa partição específica.</span><span class="sxs-lookup"><span data-stu-id="279c1-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="279c1-127">Cada partição do loop mantém uma instância separada dessa variável.</span><span class="sxs-lookup"><span data-stu-id="279c1-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="279c1-128">Nesse exemplo, o representante adiciona o valor de cada inteiro à variável de thread local, que mantém um total de valores dos elementos inteiros dessa partição em execução.</span><span class="sxs-lookup"><span data-stu-id="279c1-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="279c1-129">`localFinally`, um representante `Action<TLocal>` que o <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invoca quando são concluídas as operações de loop de cada partição.</span><span class="sxs-lookup"><span data-stu-id="279c1-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="279c1-130">O método <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> passa o valor final da variável de thread local desse thread (ou partição de loop) para seu representante `Action<TLocal>`, e você fornece o código que executa a ação necessária para combinar o resultado dessa partição aos resultados de outras partições.</span><span class="sxs-lookup"><span data-stu-id="279c1-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="279c1-131">Esse representante pode ser invocado ao mesmo tempo por diversas tarefas.</span><span class="sxs-lookup"><span data-stu-id="279c1-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="279c1-132">Por isso, o exemplo usa o método <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> para sincronizar o acesso à variável `total`.</span><span class="sxs-lookup"><span data-stu-id="279c1-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="279c1-133">Como o tipo de representante é um <xref:System.Action%601>, não há valor retornado.</span><span class="sxs-lookup"><span data-stu-id="279c1-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="279c1-134">Consulte também</span><span class="sxs-lookup"><span data-stu-id="279c1-134">See Also</span></span>  
 [<span data-ttu-id="279c1-135">Paralelismo de dados</span><span class="sxs-lookup"><span data-stu-id="279c1-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="279c1-136">Como escrever um loop Parallel.For com variáveis locais de thread</span><span class="sxs-lookup"><span data-stu-id="279c1-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="279c1-137">Expressões lambda em PLINQ e TPL</span><span class="sxs-lookup"><span data-stu-id="279c1-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
