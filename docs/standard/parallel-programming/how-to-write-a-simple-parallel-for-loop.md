---
title: Como escrever um loop Parallel.For simples
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
caps.latest.revision: "18"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: ed621f41e76addde777b974732470fcfbc903563
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/21/2017
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="e5c20-102">Como escrever um loop Parallel.For simples</span><span class="sxs-lookup"><span data-stu-id="e5c20-102">How to: Write a Simple Parallel.For Loop</span></span>
<span data-ttu-id="e5c20-103">Este tópico contém dois exemplos que ilustram o <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> método.</span><span class="sxs-lookup"><span data-stu-id="e5c20-103">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="e5c20-104">O primeiro usa o <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> sobrecarga de método e o segundo usa a <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> sobrecarga, as duas sobrecargas mais simples do <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> método.</span><span class="sxs-lookup"><span data-stu-id="e5c20-104">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="e5c20-105">Você pode usar essas duas sobrecargas do <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> método quando você não precisa cancelar o loop, dividir as iterações do loop ou manter o estado de qualquer local de thread.</span><span class="sxs-lookup"><span data-stu-id="e5c20-105">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e5c20-106">Esta documentação usa expressões lambda para definir delegados na TLP.</span><span class="sxs-lookup"><span data-stu-id="e5c20-106">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="e5c20-107">Se você não estiver familiarizado com expressões lambda no C# ou no Visual Basic, veja [Expressões lambda em PLINQ e TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="e5c20-107">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
 <span data-ttu-id="e5c20-108">O primeiro exemplo calcula o tamanho dos arquivos em um único diretório.</span><span class="sxs-lookup"><span data-stu-id="e5c20-108">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="e5c20-109">A segunda calcula o produto de duas matrizes.</span><span class="sxs-lookup"><span data-stu-id="e5c20-109">The second computes the product of two matrices.</span></span>  
  
## <a name="example"></a><span data-ttu-id="e5c20-110">Exemplo</span><span class="sxs-lookup"><span data-stu-id="e5c20-110">Example</span></span>  
 <span data-ttu-id="e5c20-111">Este exemplo é um utilitário de linha de comando simples que calcula o tamanho total dos arquivos em um diretório.</span><span class="sxs-lookup"><span data-stu-id="e5c20-111">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="e5c20-112">Ele espera um caminho de diretório único como um argumento e informa o número e o tamanho total dos arquivos no diretório.</span><span class="sxs-lookup"><span data-stu-id="e5c20-112">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="e5c20-113">Depois de verificar se o diretório já existe, ele usa o <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> método para enumerar os arquivos no diretório e determinar os tamanhos de arquivo.</span><span class="sxs-lookup"><span data-stu-id="e5c20-113">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="e5c20-114">Cada tamanho de arquivo é adicionado para o `totalSize` variável.</span><span class="sxs-lookup"><span data-stu-id="e5c20-114">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="e5c20-115">Observe que a adição é realizada chamando o <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> para que a adição é executada como uma operação atômica.</span><span class="sxs-lookup"><span data-stu-id="e5c20-115">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="e5c20-116">Caso contrário, várias tarefas podem tentar atualizar o `totalSize` variável simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="e5c20-116">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>  
  
 [!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
 [!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]  
  
## <a name="example"></a><span data-ttu-id="e5c20-117">Exemplo</span><span class="sxs-lookup"><span data-stu-id="e5c20-117">Example</span></span>  
 <span data-ttu-id="e5c20-118">Este exemplo usa o <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> método para calcular o produto de duas matrizes.</span><span class="sxs-lookup"><span data-stu-id="e5c20-118">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="e5c20-119">Ele também mostra como usar o <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> classe para comparar o desempenho de um loop paralelo com um loop paralelo não.</span><span class="sxs-lookup"><span data-stu-id="e5c20-119">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="e5c20-120">Observe que, porque pode gerar um grande volume de saída, o exemplo permite que a saída para ser redirecionado para um arquivo.</span><span class="sxs-lookup"><span data-stu-id="e5c20-120">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>  
  
 [!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
 [!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]  
  
 <span data-ttu-id="e5c20-121">Ao paralelizar qualquer código, incluindo loops, uma meta importante é utilizar os processadores tanto quanto possíveis sem sobre paralelizar para o ponto em que a sobrecarga de processamento paralelo nega qualquer benefícios de desempenho.</span><span class="sxs-lookup"><span data-stu-id="e5c20-121">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="e5c20-122">Nesse exemplo específico, somente o loop externo é paralelizado porque não há muito trabalho realizado no loop interno.</span><span class="sxs-lookup"><span data-stu-id="e5c20-122">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="e5c20-123">A combinação de uma pequena quantidade de trabalho e os efeitos de cache indesejável pode resultar em degradação do desempenho em loops paralelos aninhadas.</span><span class="sxs-lookup"><span data-stu-id="e5c20-123">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="e5c20-124">Portanto, a paralelização do loop externo é apenas a melhor forma de maximizar os benefícios de simultaneidade na maioria dos sistemas.</span><span class="sxs-lookup"><span data-stu-id="e5c20-124">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>  
  
## <a name="the-delegate"></a><span data-ttu-id="e5c20-125">O representante</span><span class="sxs-lookup"><span data-stu-id="e5c20-125">The Delegate</span></span>  
 <span data-ttu-id="e5c20-126">O terceiro parâmetro dessa sobrecarga de <xref:System.Threading.Tasks.Parallel.For%2A> for um representante do tipo `Action<int>` em c# ou `Action(Of Integer)` no Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="e5c20-126">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="e5c20-127">Um `Action` delegado, se ele tem zero, um ou parâmetros de tipo dezesseis, sempre retorna void.</span><span class="sxs-lookup"><span data-stu-id="e5c20-127">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="e5c20-128">No Visual Basic, o comportamento de um `Action` está definida com um `Sub`.</span><span class="sxs-lookup"><span data-stu-id="e5c20-128">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="e5c20-129">O exemplo usa uma expressão lambda para criar o delegado, mas você pode criar o delegado de outras formas também.</span><span class="sxs-lookup"><span data-stu-id="e5c20-129">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="e5c20-130">Para obter mais informações, consulte [expressões Lambda em PLINQ e TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="e5c20-130">For more information, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="the-iteration-value"></a><span data-ttu-id="e5c20-131">O valor de iteração</span><span class="sxs-lookup"><span data-stu-id="e5c20-131">The Iteration Value</span></span>  
 <span data-ttu-id="e5c20-132">O representante usa um único parâmetro de entrada cujo valor é a iteração atual.</span><span class="sxs-lookup"><span data-stu-id="e5c20-132">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="e5c20-133">Esse valor de iteração é fornecido pelo tempo de execução e seu valor inicial é o índice do primeiro elemento no segmento (partição) de origem que está sendo processada no thread atual.</span><span class="sxs-lookup"><span data-stu-id="e5c20-133">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>  
  
 <span data-ttu-id="e5c20-134">Se você precisar de mais controle sobre o nível de simultaneidade, use uma das sobrecargas que usa um <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> parâmetro de entrada, como: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e5c20-134">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>  
  
## <a name="return-value-and-exception-handling"></a><span data-ttu-id="e5c20-135">Valor de retorno e tratamento de exceção</span><span class="sxs-lookup"><span data-stu-id="e5c20-135">Return Value and Exception Handling</span></span>  
 <span data-ttu-id="e5c20-136"><xref:System.Threading.Tasks.Parallel.For%2A>Retorna um <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> quando tem concluído a todos os threads do objeto.</span><span class="sxs-lookup"><span data-stu-id="e5c20-136"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="e5c20-137">Esse valor de retorno é útil quando você estiver parando ou separação de iteração de loop manualmente, porque o <xref:System.Threading.Tasks.ParallelLoopResult> armazena informações como a última iteração executou até a conclusão.</span><span class="sxs-lookup"><span data-stu-id="e5c20-137">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="e5c20-138">Se uma ou mais exceções ocorrem em um dos threads, um <xref:System.AggregateException?displayProperty=nameWithType> será lançada.</span><span class="sxs-lookup"><span data-stu-id="e5c20-138">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>  
  
 <span data-ttu-id="e5c20-139">O código neste exemplo, o valor de retorno <xref:System.Threading.Tasks.Parallel.For%2A> não é usado.</span><span class="sxs-lookup"><span data-stu-id="e5c20-139">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>  
  
## <a name="analysis-and-performance"></a><span data-ttu-id="e5c20-140">Análise e desempenho</span><span class="sxs-lookup"><span data-stu-id="e5c20-140">Analysis and Performance</span></span>  
 <span data-ttu-id="e5c20-141">Você pode usar o Assistente de desempenho para exibir o uso da CPU no computador.</span><span class="sxs-lookup"><span data-stu-id="e5c20-141">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="e5c20-142">Como uma experiência, aumente o número de colunas e linhas de matrizes.</span><span class="sxs-lookup"><span data-stu-id="e5c20-142">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="e5c20-143">Quanto maior as matrizes, quanto maior a diferença de desempenho entre as versões paralelas e sequenciais da computação.</span><span class="sxs-lookup"><span data-stu-id="e5c20-143">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="e5c20-144">Quando a matriz é pequena, a versão sequencial será executado mais rapidamente devido à sobrecarga de configurar o loop paralelo.</span><span class="sxs-lookup"><span data-stu-id="e5c20-144">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>  
  
 <span data-ttu-id="e5c20-145">Chamadas síncronas a recursos compartilhados, como o Console ou o sistema de arquivos, significativamente prejudicará o desempenho de um loop paralelo.</span><span class="sxs-lookup"><span data-stu-id="e5c20-145">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="e5c20-146">Ao medir o desempenho, tente evitar chamadas como <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> dentro do loop.</span><span class="sxs-lookup"><span data-stu-id="e5c20-146">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>  
  
## <a name="compiling-the-code"></a><span data-ttu-id="e5c20-147">Compilando o código</span><span class="sxs-lookup"><span data-stu-id="e5c20-147">Compiling the Code</span></span>  
  
-   <span data-ttu-id="e5c20-148">Copie e cole esse código em um projeto do Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="e5c20-148">Copy and paste this code into a Visual Studio 2010 project.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e5c20-149">Consulte também</span><span class="sxs-lookup"><span data-stu-id="e5c20-149">See Also</span></span>  
 <xref:System.Threading.Tasks.Parallel.For%2A>  
 <xref:System.Threading.Tasks.Parallel.ForEach%2A>  
 [<span data-ttu-id="e5c20-150">Paralelismo de dados</span><span class="sxs-lookup"><span data-stu-id="e5c20-150">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="e5c20-151">Programação paralela</span><span class="sxs-lookup"><span data-stu-id="e5c20-151">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)
