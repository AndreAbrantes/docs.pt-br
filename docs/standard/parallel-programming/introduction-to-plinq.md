---
title: Introdução ao PLINQ
description: Saiba como fazer consultas em paralelo usando PLINQ no .NET. PLINQ significa consulta integrada de linguagem paralela (LINQ).
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- PLINQ queries, introduction to
ms.assetid: eaa720d8-8999-4eb7-8df5-3c19ca61cad0
ms.openlocfilehash: 9dbc4fde3f72d01aee91978ed5cb0baf0895de26
ms.sourcegitcommit: 7137e12f54c4e83a94ae43ec320f8cf59c1772ea
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/10/2020
ms.locfileid: "84662453"
---
# <a name="introduction-to-plinq"></a><span data-ttu-id="3de03-104">Introdução ao PLINQ</span><span class="sxs-lookup"><span data-stu-id="3de03-104">Introduction to PLINQ</span></span>

<span data-ttu-id="3de03-105">O Parallel LINQ (PLINQ) é uma implementação paralela do padrão [LINQ (consulta integrada à linguagem)](../../csharp/programming-guide/concepts/linq/index.md) .</span><span class="sxs-lookup"><span data-stu-id="3de03-105">Parallel LINQ (PLINQ) is a parallel implementation of the [Language-Integrated Query (LINQ)](../../csharp/programming-guide/concepts/linq/index.md) pattern.</span></span> <span data-ttu-id="3de03-106">O PLINQ implementa o conjunto completo de operadores de consulta padrão LINQ como métodos de extensão para o namespace <xref:System.Linq> e tem operadores adicionais para operações paralelas.</span><span class="sxs-lookup"><span data-stu-id="3de03-106">PLINQ implements the full set of LINQ standard query operators as extension methods for the <xref:System.Linq> namespace and has additional operators for parallel operations.</span></span> <span data-ttu-id="3de03-107">O PLINQ combina a simplicidade e a legibilidade da sintaxe LINQ com o poder da programação paralela.</span><span class="sxs-lookup"><span data-stu-id="3de03-107">PLINQ combines the simplicity and readability of LINQ syntax with the power of parallel programming.</span></span>

> [!TIP]
> <span data-ttu-id="3de03-108">Se você não estiver familiarizado com o LINQ, ele apresenta um modelo unificado para consultar qualquer fonte de dados enumerável de forma segura de tipo.</span><span class="sxs-lookup"><span data-stu-id="3de03-108">If you're not familiar with LINQ, it features a unified model for querying any enumerable data source in a type-safe manner.</span></span> <span data-ttu-id="3de03-109">LINQ to Objects é o nome para consultas LINQ executadas em coleções na memória, como <xref:System.Collections.Generic.List%601> e matrizes.</span><span class="sxs-lookup"><span data-stu-id="3de03-109">LINQ to Objects is the name for LINQ queries that are run against in-memory collections such as <xref:System.Collections.Generic.List%601> and arrays.</span></span> <span data-ttu-id="3de03-110">Este artigo pressupõe que você tenha uma compreensão básica de LINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-110">This article assumes that you have a basic understanding of LINQ.</span></span> <span data-ttu-id="3de03-111">Para obter mais informações, consulte [LINQ (consulta integrada à linguagem)](../../csharp/programming-guide/concepts/linq/index.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-111">For more information, see [Language-Integrated Query (LINQ)](../../csharp/programming-guide/concepts/linq/index.md).</span></span>

## <a name="what-is-a-parallel-query"></a><span data-ttu-id="3de03-112">O que é uma consulta paralela?</span><span class="sxs-lookup"><span data-stu-id="3de03-112">What is a Parallel query?</span></span>

<span data-ttu-id="3de03-113">Uma consulta PLINQ, em muitas formas, é semelhante a uma consulta não paralela de LINQ to Objects.</span><span class="sxs-lookup"><span data-stu-id="3de03-113">A PLINQ query in many ways resembles a non-parallel LINQ to Objects query.</span></span> <span data-ttu-id="3de03-114">Consultas PLINQ, assim como consultas sequenciais de LINQ, operam em qualquer <xref:System.Collections.IEnumerable> fonte de dados ou na memória <xref:System.Collections.Generic.IEnumerable%601> e têm a execução adiada, o que significa que elas não começam a ser executadas até que a consulta seja enumerada.</span><span class="sxs-lookup"><span data-stu-id="3de03-114">PLINQ queries, just like sequential LINQ queries, operate on any in-memory <xref:System.Collections.IEnumerable> or <xref:System.Collections.Generic.IEnumerable%601> data source, and have deferred execution, which means they do not begin executing until the query is enumerated.</span></span> <span data-ttu-id="3de03-115">A principal diferença é que a PLINQ tenta fazer uso integral de todos os processadores no sistema.</span><span class="sxs-lookup"><span data-stu-id="3de03-115">The primary difference is that PLINQ attempts to make full use of all the processors on the system.</span></span> <span data-ttu-id="3de03-116">Ela faz isso particionando a fonte de dados em segmentos e então executando a consulta em cada segmento em threads de trabalho separados em paralelo em vários processadores.</span><span class="sxs-lookup"><span data-stu-id="3de03-116">It does this by partitioning the data source into segments, and then executing the query on each segment on separate worker threads in parallel on multiple processors.</span></span> <span data-ttu-id="3de03-117">Em muitos casos, a execução paralela significa que a consulta é executada de forma significativamente mais rápida.</span><span class="sxs-lookup"><span data-stu-id="3de03-117">In many cases, parallel execution means that the query runs significantly faster.</span></span>

<span data-ttu-id="3de03-118">Por meio da execução paralela, a PLINQ pode obter melhorias significativas de desempenho sobre o código herdado para determinados tipos de consultas, com frequência simplesmente adicionando a operação de consulta <xref:System.Linq.ParallelEnumerable.AsParallel%2A> à fonte de dados da operação.</span><span class="sxs-lookup"><span data-stu-id="3de03-118">Through parallel execution, PLINQ can achieve significant performance improvements over legacy code for certain kinds of queries, often just by adding the <xref:System.Linq.ParallelEnumerable.AsParallel%2A> query operation to the data source.</span></span> <span data-ttu-id="3de03-119">No entanto, o paralelismo pode apresentar suas próprias complexidades e nem todas as operações de consulta são executadas mais rapidamente na PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-119">However, parallelism can introduce its own complexities, and not all query operations run faster in PLINQ.</span></span> <span data-ttu-id="3de03-120">Na verdade, a paralelização realmente atrasa determinadas consultas.</span><span class="sxs-lookup"><span data-stu-id="3de03-120">In fact, parallelization actually slows down certain queries.</span></span> <span data-ttu-id="3de03-121">Portanto, você deve compreender como problemas como a classificação afetam consultas paralelas.</span><span class="sxs-lookup"><span data-stu-id="3de03-121">Therefore, you should understand how issues such as ordering affect parallel queries.</span></span> <span data-ttu-id="3de03-122">Para saber mais, veja [Noções básicas sobre agilização em PLINQ](understanding-speedup-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-122">For more information, see [Understanding Speedup in PLINQ](understanding-speedup-in-plinq.md).</span></span>

> [!NOTE]
> <span data-ttu-id="3de03-123">Esta documentação usa expressões lambda para definir representantes na PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-123">This documentation uses lambda expressions to define delegates in PLINQ.</span></span> <span data-ttu-id="3de03-124">Se você não estiver familiarizado com expressões lambda em C# ou Visual Basic, consulte [expressões lambda em PLINQ e TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-124">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="3de03-125">O restante deste artigo fornece uma visão geral das principais classes PLINQ e discute como criar consultas PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-125">The remainder of this article gives an overview of the main PLINQ classes and discusses how to create PLINQ queries.</span></span> <span data-ttu-id="3de03-126">Cada seção contém links para mais informações e exemplos de código.</span><span class="sxs-lookup"><span data-stu-id="3de03-126">Each section contains links to more detailed information and code examples.</span></span>

## <a name="the-parallelenumerable-class"></a><span data-ttu-id="3de03-127">A Classe ParallelEnumerable</span><span class="sxs-lookup"><span data-stu-id="3de03-127">The ParallelEnumerable Class</span></span>

<span data-ttu-id="3de03-128">A classe <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> expõe quase todas as funcionalidades de PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-128">The <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> class exposes almost all of PLINQ's functionality.</span></span> <span data-ttu-id="3de03-129">Ela e o restante dos tipos <xref:System.Linq?displayProperty=nameWithType> de namespace são compilados no assembly System.Core.dll.</span><span class="sxs-lookup"><span data-stu-id="3de03-129">It and the rest of the <xref:System.Linq?displayProperty=nameWithType> namespace types are compiled into the System.Core.dll assembly.</span></span> <span data-ttu-id="3de03-130">Os projetos padrão de C# e do Visual Basic no Visual Studio fazem referência ao assembly e importam o namespace.</span><span class="sxs-lookup"><span data-stu-id="3de03-130">The default C# and Visual Basic projects in Visual Studio both reference the assembly and import the namespace.</span></span>

<span data-ttu-id="3de03-131"><xref:System.Linq.ParallelEnumerable> inclui implementações de todos os operadores de consulta padrão com suporte do LINQ to Objects, embora ele não tente paralelizar cada uma.</span><span class="sxs-lookup"><span data-stu-id="3de03-131"><xref:System.Linq.ParallelEnumerable> includes implementations of all the standard query operators that LINQ to Objects supports, although it does not attempt to parallelize each one.</span></span> <span data-ttu-id="3de03-132">Se você não estiver familiarizado com o LINQ, consulte [introdução ao LINQ (C#)](../../csharp/programming-guide/concepts/linq/index.md) e [introdução ao LINQ (Visual Basic)](../../visual-basic/programming-guide/concepts/linq/introduction-to-linq.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-132">If you are not familiar with LINQ, see [Introduction to LINQ (C#)](../../csharp/programming-guide/concepts/linq/index.md) and [Introduction to LINQ (Visual Basic)](../../visual-basic/programming-guide/concepts/linq/introduction-to-linq.md).</span></span>

<span data-ttu-id="3de03-133">Além dos operadores de consulta padrão, a classe <xref:System.Linq.ParallelEnumerable> contém um conjunto de métodos que permitem comportamentos específicos para execução paralela.</span><span class="sxs-lookup"><span data-stu-id="3de03-133">In addition to the standard query operators, the <xref:System.Linq.ParallelEnumerable> class contains a set of methods that enable behaviors specific to parallel execution.</span></span> <span data-ttu-id="3de03-134">Esses métodos específicos de PLINQ são listados na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="3de03-134">These PLINQ-specific methods are listed in the following table.</span></span>

|<span data-ttu-id="3de03-135">Operador ParallelEnumerable</span><span class="sxs-lookup"><span data-stu-id="3de03-135">ParallelEnumerable Operator</span></span>|<span data-ttu-id="3de03-136">Descrição</span><span class="sxs-lookup"><span data-stu-id="3de03-136">Description</span></span>|
|---------------------------------|-----------------|
|<xref:System.Linq.ParallelEnumerable.AsParallel%2A>|<span data-ttu-id="3de03-137">O ponto de entrada para PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-137">The entry point for PLINQ.</span></span> <span data-ttu-id="3de03-138">Especifica que o restante da consulta deverá ser paralelizado, se possível.</span><span class="sxs-lookup"><span data-stu-id="3de03-138">Specifies that the rest of the query should be parallelized, if it is possible.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsSequential%2A>|<span data-ttu-id="3de03-139">Especifica que o restante da consulta deve ser executado em sequência, como uma consulta LINQ não paralela.</span><span class="sxs-lookup"><span data-stu-id="3de03-139">Specifies that the rest of the query should be run sequentially, as a non-parallel LINQ query.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsOrdered%2A>|<span data-ttu-id="3de03-140">Especifica que a PLINQ deve preservar a ordenação da sequência de origem para o restante da consulta, ou até que a ordenação seja alterada, por exemplo, pelo uso de uma cláusula orderby (Order By no Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="3de03-140">Specifies that PLINQ should preserve the ordering of the source sequence for the rest of the query, or until the ordering is changed, for example by the use of an orderby (Order By in Visual Basic) clause.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsUnordered%2A>|<span data-ttu-id="3de03-141">Especifica que a PLINQ para o restante da consulta não precisa preservar a ordenação da sequência de origem.</span><span class="sxs-lookup"><span data-stu-id="3de03-141">Specifies that PLINQ for the rest of the query is not required to preserve the ordering of the source sequence.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithCancellation%2A>|<span data-ttu-id="3de03-142">Especifica que a PLINQ deve monitorar periodicamente o estado do token de cancelamento fornecido e cancelar a execução se isso for solicitado.</span><span class="sxs-lookup"><span data-stu-id="3de03-142">Specifies that PLINQ should periodically monitor the state of the provided cancellation token and cancel execution if it is requested.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A>|<span data-ttu-id="3de03-143">Especifica o número máximo de processadores que a PLINQ deve usar para paralelizar a consulta.</span><span class="sxs-lookup"><span data-stu-id="3de03-143">Specifies the maximum number of processors that PLINQ should use to parallelize the query.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A>|<span data-ttu-id="3de03-144">Fornece uma dica sobre como a PLINQ deve, se possível, mesclar resultados paralelos novamente em apenas uma sequência no segmento de consumo.</span><span class="sxs-lookup"><span data-stu-id="3de03-144">Provides a hint about how PLINQ should, if it is possible, merge parallel results back into just one sequence on the consuming thread.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A>|<span data-ttu-id="3de03-145">Especifica se a PLINQ deve paralelizar a consulta mesmo quando o comportamento padrão for executá-la em sequência.</span><span class="sxs-lookup"><span data-stu-id="3de03-145">Specifies whether PLINQ should parallelize the query even when the default behavior would be to run it sequentially.</span></span>|
|<xref:System.Linq.ParallelEnumerable.ForAll%2A>|<span data-ttu-id="3de03-146">Um método de enumeração multithread que, ao contrário de iterar sobre os resultados da consulta, permite que os resultados sejam processados em paralelo sem primeiro mesclar de volta para o thread de consumidor.</span><span class="sxs-lookup"><span data-stu-id="3de03-146">A multithreaded enumeration method that, unlike iterating over the results of the query, enables results to be processed in parallel without first merging back to the consumer thread.</span></span>|
|<span data-ttu-id="3de03-147">sobrecarga de <xref:System.Linq.ParallelEnumerable.Aggregate%2A></span><span class="sxs-lookup"><span data-stu-id="3de03-147"><xref:System.Linq.ParallelEnumerable.Aggregate%2A> overload</span></span>|<span data-ttu-id="3de03-148">Uma sobrecarga que é exclusiva da PLINQ e permite agregação intermediária em partições de thread local, além de uma função de agregação final para combinar os resultados de todas as partições.</span><span class="sxs-lookup"><span data-stu-id="3de03-148">An overload that is unique to PLINQ and enables intermediate aggregation over thread-local partitions, plus a final aggregation function to combine the results of all partitions.</span></span>|

## <a name="the-opt-in-model"></a><span data-ttu-id="3de03-149">O Modelo de Aceite</span><span class="sxs-lookup"><span data-stu-id="3de03-149">The Opt-in Model</span></span>

<span data-ttu-id="3de03-150">Ao escrever uma consulta, escolha o PLINQ invocando o método de extensão <xref:System.Linq.ParallelEnumerable.AsParallel%2A?displayProperty=nameWithType> na fonte de dados, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="3de03-150">When you write a query, opt in to PLINQ by invoking the <xref:System.Linq.ParallelEnumerable.AsParallel%2A?displayProperty=nameWithType> extension method on the data source, as shown in the following example.</span></span>

[!code-csharp[PLINQ#1](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#1)]
[!code-vb[PLINQ#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#1)]

<span data-ttu-id="3de03-151">O método de extensão <xref:System.Linq.ParallelEnumerable.AsParallel%2A> associa os operadores de consulta subsequentes, nesse caso, `where` e `select`, às implementações <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3de03-151">The <xref:System.Linq.ParallelEnumerable.AsParallel%2A> extension method binds the subsequent query operators, in this case, `where` and `select`, to the <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> implementations.</span></span>

## <a name="execution-modes"></a><span data-ttu-id="3de03-152">Modos de Execução</span><span class="sxs-lookup"><span data-stu-id="3de03-152">Execution Modes</span></span>

<span data-ttu-id="3de03-153">Por padrão, a PLINQ é conservadora.</span><span class="sxs-lookup"><span data-stu-id="3de03-153">By default, PLINQ is conservative.</span></span> <span data-ttu-id="3de03-154">Em tempo de execução, a infraestrutura da PLINQ analisa a estrutura geral da consulta.</span><span class="sxs-lookup"><span data-stu-id="3de03-154">At run time, the PLINQ infrastructure analyzes the overall structure of the query.</span></span> <span data-ttu-id="3de03-155">Se for provável que a consulta produza aumentos de velocidade por paralelização, a PLINQ particionará a sequência de origem em tarefas que podem ser executadas simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="3de03-155">If the query is likely to yield speedups by parallelization, PLINQ partitions the source sequence into tasks that can be run concurrently.</span></span> <span data-ttu-id="3de03-156">Se não for seguro a paralelização de uma consulta, a PLINQ apenas executa a consulta em sequência.</span><span class="sxs-lookup"><span data-stu-id="3de03-156">If it is not safe to parallelize a query, PLINQ just runs the query sequentially.</span></span> <span data-ttu-id="3de03-157">Se a PLINQ tiver a opção de escolher entre um algoritmo paralelo potencialmente caro ou um algoritmo sequencial barato, ela escolherá o algoritmo sequencial, por padrão.</span><span class="sxs-lookup"><span data-stu-id="3de03-157">If PLINQ has a choice between a potentially expensive parallel algorithm or an inexpensive sequential algorithm, it chooses the sequential algorithm by default.</span></span> <span data-ttu-id="3de03-158">Você pode usar o método <xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A> e a enumeração <xref:System.Linq.ParallelExecutionMode?displayProperty=nameWithType> para instruir o PLINQ a selecionar o algoritmo em paralelo.</span><span class="sxs-lookup"><span data-stu-id="3de03-158">You can use the <xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A> method and the <xref:System.Linq.ParallelExecutionMode?displayProperty=nameWithType> enumeration to instruct PLINQ to select the parallel algorithm.</span></span> <span data-ttu-id="3de03-159">Isso é útil quando você sabe por meio de testes e medidas que uma determinada consulta é executada mais rapidamente em paralelo.</span><span class="sxs-lookup"><span data-stu-id="3de03-159">This is useful when you know by testing and measurement that a particular query executes faster in parallel.</span></span> <span data-ttu-id="3de03-160">Para saber mais, veja [Como especificar o modo de execução em PLINQ](how-to-specify-the-execution-mode-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-160">For more information, see [How to: Specify the Execution Mode in PLINQ](how-to-specify-the-execution-mode-in-plinq.md).</span></span>

## <a name="degree-of-parallelism"></a><span data-ttu-id="3de03-161">Grau de paralelismo</span><span class="sxs-lookup"><span data-stu-id="3de03-161">Degree of Parallelism</span></span>

<span data-ttu-id="3de03-162">Por padrão, o PLINQ utiliza a todos os processadores no computador host.</span><span class="sxs-lookup"><span data-stu-id="3de03-162">By default, PLINQ uses all of the processors on the host computer.</span></span> <span data-ttu-id="3de03-163">Você pode instruir o PLINQ a não usar mais do que um número especificado de processadores usando o método <xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A>.</span><span class="sxs-lookup"><span data-stu-id="3de03-163">You can instruct PLINQ to use no more than a specified number of processors by using the <xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A> method.</span></span> <span data-ttu-id="3de03-164">Isso é útil quando você deseja certificar-se de que outros processos em execução no computador receberão um determinado período de tempo de CPU.</span><span class="sxs-lookup"><span data-stu-id="3de03-164">This is useful when you want to make sure that other processes running on the computer receive a certain amount of CPU time.</span></span> <span data-ttu-id="3de03-165">O snippet a seguir limita a consulta ao utilizar no máximo dois processadores.</span><span class="sxs-lookup"><span data-stu-id="3de03-165">The following snippet limits the query to utilizing a maximum of two processors.</span></span>

[!code-csharp[PLINQ#5](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinqsamples.cs#5)]
[!code-vb[PLINQ#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#5)]

<span data-ttu-id="3de03-166">Em casos onde uma consulta esteja executando uma quantidade significativa de trabalho associado a computação, como E/S de Arquivo, pode ser útil especificar um grau de paralelismo maior do que o número de núcleos no computador.</span><span class="sxs-lookup"><span data-stu-id="3de03-166">In cases where a query is performing a significant amount of non-compute-bound work such as File I/O, it might be beneficial to specify a degree of parallelism greater than the number of cores on the machine.</span></span>

## <a name="ordered-versus-unordered-parallel-queries"></a><span data-ttu-id="3de03-167">Consultas Paralelas Ordenadas Contra Não Ordenadas</span><span class="sxs-lookup"><span data-stu-id="3de03-167">Ordered Versus Unordered Parallel Queries</span></span>

<span data-ttu-id="3de03-168">Em algumas consultas, um operador de consulta deve produzir resultados que preservem a ordenação da sequência de origem.</span><span class="sxs-lookup"><span data-stu-id="3de03-168">In some queries, a query operator must produce results that preserve the ordering of the source sequence.</span></span> <span data-ttu-id="3de03-169">O PLINQ fornece o operador <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="3de03-169">PLINQ provides the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator for this purpose.</span></span> <span data-ttu-id="3de03-170"><xref:System.Linq.ParallelEnumerable.AsOrdered%2A> é diferente de <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span><span class="sxs-lookup"><span data-stu-id="3de03-170"><xref:System.Linq.ParallelEnumerable.AsOrdered%2A> is distinct from <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span></span> <span data-ttu-id="3de03-171">Uma sequência <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> ainda é processada em paralelo, mas os resultados são armazenados em buffer e classificados.</span><span class="sxs-lookup"><span data-stu-id="3de03-171">An <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> sequence is still processed in parallel, but its results are buffered and sorted.</span></span> <span data-ttu-id="3de03-172">Como a preservação da ordem normalmente envolve trabalho extra, uma sequência <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> pode ser processada mais lentamente do que a sequência padrão <xref:System.Linq.ParallelEnumerable.AsUnordered%2A>.</span><span class="sxs-lookup"><span data-stu-id="3de03-172">Because order preservation typically involves extra work, an <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> sequence might be processed more slowly than the default <xref:System.Linq.ParallelEnumerable.AsUnordered%2A> sequence.</span></span> <span data-ttu-id="3de03-173">Se uma determinada operação paralela ordenada será mais rápida do que uma versão sequencial da operação, isso dependerá de vários fatores.</span><span class="sxs-lookup"><span data-stu-id="3de03-173">Whether a particular ordered parallel operation is faster than a sequential version of the operation depends on many factors.</span></span>

<span data-ttu-id="3de03-174">O exemplo de código a seguir mostra como aceitar a preservação da ordem.</span><span class="sxs-lookup"><span data-stu-id="3de03-174">The following code example shows how to opt in to order preservation.</span></span>

[!code-csharp[PLINQ#3](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#3)]
[!code-vb[PLINQ#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#3)]

<span data-ttu-id="3de03-175">Para saber mais, veja [Preservação da ordem em PLINQ](order-preservation-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-175">For more information, see [Order Preservation in PLINQ](order-preservation-in-plinq.md).</span></span>

## <a name="parallel-vs-sequential-queries"></a><span data-ttu-id="3de03-176">Consultas paralelas versus sequenciais</span><span class="sxs-lookup"><span data-stu-id="3de03-176">Parallel vs. Sequential Queries</span></span>

<span data-ttu-id="3de03-177">Algumas operações exigem que os dados de origem sejam entregue de forma sequencial.</span><span class="sxs-lookup"><span data-stu-id="3de03-177">Some operations require that the source data be delivered in a sequential manner.</span></span> <span data-ttu-id="3de03-178">Os operadores de consulta <xref:System.Linq.ParallelEnumerable> voltam para o modo sequencial automaticamente, quando necessário.</span><span class="sxs-lookup"><span data-stu-id="3de03-178">The <xref:System.Linq.ParallelEnumerable> query operators revert to sequential mode automatically when it is required.</span></span> <span data-ttu-id="3de03-179">Para os operadores de consulta definidos pelo usuário e os representantes do usuário que exigem execução sequencial, o PLINQ fornece o método <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span><span class="sxs-lookup"><span data-stu-id="3de03-179">For user-defined query operators and user delegates that require sequential execution, PLINQ provides the <xref:System.Linq.ParallelEnumerable.AsSequential%2A> method.</span></span> <span data-ttu-id="3de03-180">Quando você usa <xref:System.Linq.ParallelEnumerable.AsSequential%2A>, todos os operadores subsequentes na consulta são executados sequencialmente até <xref:System.Linq.ParallelEnumerable.AsParallel%2A> ser chamado novamente.</span><span class="sxs-lookup"><span data-stu-id="3de03-180">When you use <xref:System.Linq.ParallelEnumerable.AsSequential%2A>, all subsequent operators in the query are executed sequentially until <xref:System.Linq.ParallelEnumerable.AsParallel%2A> is called again.</span></span> <span data-ttu-id="3de03-181">Para saber mais, veja [Como combinar consultas LINQ paralelas e sequenciais](how-to-combine-parallel-and-sequential-linq-queries.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-181">For more information, see [How to: Combine Parallel and Sequential LINQ Queries](how-to-combine-parallel-and-sequential-linq-queries.md).</span></span>

## <a name="options-for-merging-query-results"></a><span data-ttu-id="3de03-182">Opções para Mesclar Resultados da Consulta</span><span class="sxs-lookup"><span data-stu-id="3de03-182">Options for Merging Query Results</span></span>

<span data-ttu-id="3de03-183">Quando uma consulta PLINQ é executada em paralelo, seus resultados de cada thread de trabalho precisam ser mesclados de volta com o thread principal para serem consumidos por um loop `foreach` (`For Each` em Visual Basic) ou inseridos em uma lista ou matriz.</span><span class="sxs-lookup"><span data-stu-id="3de03-183">When a PLINQ query executes in parallel, its results from each worker thread must be merged back onto the main thread for consumption by a `foreach` loop (`For Each` in Visual Basic), or insertion into a list or array.</span></span> <span data-ttu-id="3de03-184">Em alguns casos, ela pode ser útil para especificar um determinado tipo de operação de mesclagem, por exemplo, para começar a produzir resultados mais rapidamente.</span><span class="sxs-lookup"><span data-stu-id="3de03-184">In some cases, it might be beneficial to specify a particular kind of merge operation, for example, to begin producing results more quickly.</span></span> <span data-ttu-id="3de03-185">Para essa finalidade, o PLINQ dá suporte ao método <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> e à enumeração <xref:System.Linq.ParallelMergeOptions>.</span><span class="sxs-lookup"><span data-stu-id="3de03-185">For this purpose, PLINQ supports the <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> method, and the <xref:System.Linq.ParallelMergeOptions> enumeration.</span></span> <span data-ttu-id="3de03-186">Para saber mais, veja [Opções de mesclagem em PLINQ](merge-options-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-186">For more information, see [Merge Options in PLINQ](merge-options-in-plinq.md).</span></span>

## <a name="the-forall-operator"></a><span data-ttu-id="3de03-187">O Operador ForAll</span><span class="sxs-lookup"><span data-stu-id="3de03-187">The ForAll Operator</span></span>

<span data-ttu-id="3de03-188">Em consultas de LINQ sequenciais, a execução é adiada até que a consulta seja enumerada em um `foreach` `For Each` loop (no Visual Basic) ou invocando um método como <xref:System.Linq.ParallelEnumerable.ToList%2A> , <xref:System.Linq.ParallelEnumerable.ToArray%2A> ou <xref:System.Linq.ParallelEnumerable.ToDictionary%2A> .</span><span class="sxs-lookup"><span data-stu-id="3de03-188">In sequential LINQ queries, execution is deferred until the query is enumerated either in a `foreach` (`For Each` in Visual Basic) loop or by invoking a method such as <xref:System.Linq.ParallelEnumerable.ToList%2A> , <xref:System.Linq.ParallelEnumerable.ToArray%2A> , or <xref:System.Linq.ParallelEnumerable.ToDictionary%2A>.</span></span> <span data-ttu-id="3de03-189">Na PLINQ, você também pode usar `foreach` para executar a consulta e percorrer os resultados.</span><span class="sxs-lookup"><span data-stu-id="3de03-189">In PLINQ, you can also use `foreach` to execute the query and iterate through the results.</span></span> <span data-ttu-id="3de03-190">No entanto, `foreach` em si não é executada em paralelo e, portanto, requer que a saída de todas as tarefas paralelas seja mesclada de volta ao thread que está executando o loop.</span><span class="sxs-lookup"><span data-stu-id="3de03-190">However, `foreach` itself does not run in parallel, and therefore, it requires that the output from all parallel tasks be merged back into the thread on which the loop is running.</span></span> <span data-ttu-id="3de03-191">Na PLINQ, você pode usar `foreach` quando tiver de preservar a ordenação final dos resultados da consulta e também sempre que estiver processando os resultados de forma serial, por exemplo, quando estiver chamando `Console.WriteLine` para cada elemento.</span><span class="sxs-lookup"><span data-stu-id="3de03-191">In PLINQ, you can use `foreach` when you must preserve the final ordering of the query results, and also whenever you are processing the results in a serial manner, for example when you are calling `Console.WriteLine` for each element.</span></span> <span data-ttu-id="3de03-192">Para uma execução mais rápida quando a preservação da ordem não for necessário e quando o processamento dos resultados possa ele próprio ser paralelizado, use o método <xref:System.Linq.ParallelEnumerable.ForAll%2A> para executar uma consulta PLINQ.</span><span class="sxs-lookup"><span data-stu-id="3de03-192">For faster query execution when order preservation is not required and when the processing of the results can itself be parallelized, use the <xref:System.Linq.ParallelEnumerable.ForAll%2A> method to execute a PLINQ query.</span></span> <span data-ttu-id="3de03-193"><xref:System.Linq.ParallelEnumerable.ForAll%2A> não executa essa etapa de mesclagem final.</span><span class="sxs-lookup"><span data-stu-id="3de03-193"><xref:System.Linq.ParallelEnumerable.ForAll%2A> does not perform this final merge step.</span></span> <span data-ttu-id="3de03-194">O exemplo de código a seguir mostra como usar o método <xref:System.Linq.ParallelEnumerable.ForAll%2A>.</span><span class="sxs-lookup"><span data-stu-id="3de03-194">The following code example shows how to use the <xref:System.Linq.ParallelEnumerable.ForAll%2A> method.</span></span> <span data-ttu-id="3de03-195"><xref:System.Collections.Concurrent.ConcurrentBag%601?displayProperty=nameWithType> é usado aqui porque é otimizado para vários threads, adicionando simultaneamente sem tentar remover itens.</span><span class="sxs-lookup"><span data-stu-id="3de03-195"><xref:System.Collections.Concurrent.ConcurrentBag%601?displayProperty=nameWithType> is used here because it is optimized for multiple threads adding concurrently without attempting to remove any items.</span></span>

[!code-csharp[PLINQ#4](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#4)]
[!code-vb[PLINQ#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#4)]

<span data-ttu-id="3de03-196">A ilustração a seguir mostra a diferença entre `foreach` e <xref:System.Linq.ParallelEnumerable.ForAll%2A> em relação à execução da consulta.</span><span class="sxs-lookup"><span data-stu-id="3de03-196">The following illustration shows the difference between `foreach` and <xref:System.Linq.ParallelEnumerable.ForAll%2A> with regard to query execution.</span></span>

<span data-ttu-id="3de03-197">![ForAll vs. ForEach](media/vs-isvnt-allvseach.png "VS_ISVNT_ALLvsEACH")</span><span class="sxs-lookup"><span data-stu-id="3de03-197">![ForAll vs. ForEach](media/vs-isvnt-allvseach.png "VS_ISVNT_ALLvsEACH")</span></span>

## <a name="cancellation"></a><span data-ttu-id="3de03-198">Cancelamento</span><span class="sxs-lookup"><span data-stu-id="3de03-198">Cancellation</span></span>

<span data-ttu-id="3de03-199">A PLINQ é integrada aos tipos de cancelamento no .NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="3de03-199">PLINQ is integrated with the cancellation types in .NET Framework 4.</span></span> <span data-ttu-id="3de03-200">(Para obter mais informações, consulte [cancelamento em threads gerenciados](../threading/cancellation-in-managed-threads.md).) Portanto, diferentemente das consultas de LINQ to Objects sequenciais, as consultas PLINQ podem ser canceladas.</span><span class="sxs-lookup"><span data-stu-id="3de03-200">(For more information, see [Cancellation in Managed Threads](../threading/cancellation-in-managed-threads.md).) Therefore, unlike sequential LINQ to Objects queries, PLINQ queries can be canceled.</span></span> <span data-ttu-id="3de03-201">Para criar uma consulta PLINQ anulável, use o operador <xref:System.Linq.ParallelEnumerable.WithCancellation%2A> na consulta e forneça uma instância <xref:System.Threading.CancellationToken> como argumento.</span><span class="sxs-lookup"><span data-stu-id="3de03-201">To create a cancelable PLINQ query, use the <xref:System.Linq.ParallelEnumerable.WithCancellation%2A> operator on the query and provide a <xref:System.Threading.CancellationToken> instance as the argument.</span></span> <span data-ttu-id="3de03-202">Quando a propriedade <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> no token é definida como true, o PLINQ a observa, para o processamento de todos os threads e lança um <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="3de03-202">When the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property on the token is set to true, PLINQ will notice it, stop processing on all threads, and throw an <xref:System.OperationCanceledException>.</span></span>

<span data-ttu-id="3de03-203">É possível que uma consulta PLINQ possa continuar a processar alguns elementos depois que o token de cancelamento é definido.</span><span class="sxs-lookup"><span data-stu-id="3de03-203">It is possible that a PLINQ query might continue to process some elements after the cancellation token is set.</span></span>

<span data-ttu-id="3de03-204">Para maior capacidade de resposta, você também pode responder a solicitações de cancelamento em representantes do usuário de longa duração.</span><span class="sxs-lookup"><span data-stu-id="3de03-204">For greater responsiveness, you can also respond to cancellation requests in long-running user delegates.</span></span> <span data-ttu-id="3de03-205">Para saber mais, veja [Como cancelar uma consulta PLINQ](how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-205">For more information, see [How to: Cancel a PLINQ Query](how-to-cancel-a-plinq-query.md).</span></span>

## <a name="exceptions"></a><span data-ttu-id="3de03-206">Exceções</span><span class="sxs-lookup"><span data-stu-id="3de03-206">Exceptions</span></span>

<span data-ttu-id="3de03-207">Quando uma consulta PLINQ é executada, várias exceções podem ser geradas de diversos threads simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="3de03-207">When a PLINQ query executes, multiple exceptions might be thrown from different threads simultaneously.</span></span> <span data-ttu-id="3de03-208">Além disso, o código para tratar a exceção pode estar em um thread diferente do código que gerou a exceção.</span><span class="sxs-lookup"><span data-stu-id="3de03-208">Also, the code to handle the exception might be on a different thread than the code that threw the exception.</span></span> <span data-ttu-id="3de03-209">O PLINQ utiliza o tipo <xref:System.AggregateException> para encapsular todas as exceções que foram geradas por uma consulta e para realizar marshaling nessas exceções no thread de chamada.</span><span class="sxs-lookup"><span data-stu-id="3de03-209">PLINQ uses the <xref:System.AggregateException> type to encapsulate all the exceptions that were thrown by a query, and marshal those exceptions back to the calling thread.</span></span> <span data-ttu-id="3de03-210">No thread de chamada, apenas um bloco try-catch é necessário.</span><span class="sxs-lookup"><span data-stu-id="3de03-210">On the calling thread, only one try-catch block is required.</span></span> <span data-ttu-id="3de03-211">No entanto, você pode iterar por todas as exceções encapsuladas na <xref:System.AggregateException> e capturar qualquer uma que você possa recuperar com segurança.</span><span class="sxs-lookup"><span data-stu-id="3de03-211">However, you can iterate through all of the exceptions that are encapsulated in the <xref:System.AggregateException> and catch any that you can safely recover from.</span></span> <span data-ttu-id="3de03-212">Em casos raros, podem ser geradas algumas exceções que não são encapsuladas em um <xref:System.AggregateException>, e <xref:System.Threading.ThreadAbortException>s também não são encapsulados.</span><span class="sxs-lookup"><span data-stu-id="3de03-212">In rare cases, some exceptions may be thrown that are not wrapped in an <xref:System.AggregateException>, and <xref:System.Threading.ThreadAbortException>s  are also not wrapped.</span></span>

<span data-ttu-id="3de03-213">Quando as exceções tiverem permissão de emergirem novamente para o thread de associação, então será possível que uma consulta continue a processar alguns itens após a geração da exceção.</span><span class="sxs-lookup"><span data-stu-id="3de03-213">When exceptions are allowed to bubble up back to the joining thread, then it is possible that a query may continue to process some items after the exception is raised.</span></span>

<span data-ttu-id="3de03-214">Para saber mais, veja [Como tratar exceções em uma consulta PLINQ](how-to-handle-exceptions-in-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-214">For more information, see [How to: Handle Exceptions in a PLINQ Query](how-to-handle-exceptions-in-a-plinq-query.md).</span></span>

## <a name="custom-partitioners"></a><span data-ttu-id="3de03-215">Particionadores Personalizados</span><span class="sxs-lookup"><span data-stu-id="3de03-215">Custom Partitioners</span></span>

<span data-ttu-id="3de03-216">Em alguns casos, você pode melhorar o desempenho da consulta escrevendo um particionador personalizado que aproveite algumas características da fonte de dados.</span><span class="sxs-lookup"><span data-stu-id="3de03-216">In some cases, you can improve query performance by writing a custom partitioner that takes advantage of some characteristic of the source data.</span></span> <span data-ttu-id="3de03-217">Na consulta, o particionador personalizado em si é o objeto enumerável que será consultado.</span><span class="sxs-lookup"><span data-stu-id="3de03-217">In the query, the custom partitioner itself is the enumerable object that is queried.</span></span>

[!code-csharp[PLINQ#2](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#2)]
[!code-vb[PLINQ#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq3.vb#2)]

<span data-ttu-id="3de03-218">A PLINQ oferece suporte a um número fixo de partições (embora os dados possam ser dinamicamente reatribuídos a essas partições durante o tempo de execução para balanceamento de carga.).</span><span class="sxs-lookup"><span data-stu-id="3de03-218">PLINQ supports a fixed number of partitions (although data may be dynamically reassigned to those partitions during run time for load balancing.).</span></span> <span data-ttu-id="3de03-219"><xref:System.Threading.Tasks.Parallel.For%2A> e <xref:System.Threading.Tasks.Parallel.ForEach%2A> dão suporte somente ao particionamento dinâmico, o que significa que o número de partições é alterado em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="3de03-219"><xref:System.Threading.Tasks.Parallel.For%2A> and <xref:System.Threading.Tasks.Parallel.ForEach%2A> support only dynamic partitioning, which means that the number of partitions changes at run time.</span></span> <span data-ttu-id="3de03-220">Para saber mais, veja [Particionadores personalizados para PLINQ e TPL](custom-partitioners-for-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-220">For more information, see [Custom Partitioners for PLINQ and TPL](custom-partitioners-for-plinq-and-tpl.md).</span></span>

## <a name="measuring-plinq-performance"></a><span data-ttu-id="3de03-221">Medindo Desempenho PLINQ</span><span class="sxs-lookup"><span data-stu-id="3de03-221">Measuring PLINQ Performance</span></span>

<span data-ttu-id="3de03-222">Em muitos casos, uma consulta pode ser paralelizada, mas a sobrecarga de configuração de consulta paralela supera o benefício de desempenho obtido.</span><span class="sxs-lookup"><span data-stu-id="3de03-222">In many cases, a query can be parallelized, but the overhead of setting up the parallel query outweighs the performance benefit gained.</span></span> <span data-ttu-id="3de03-223">Se uma consulta não gerar muita computação ou se a fonte de dados for pequena, uma consulta PLINQ poderá ser mais lenta do que uma consulta sequencial LINQ to Objects.</span><span class="sxs-lookup"><span data-stu-id="3de03-223">If a query does not perform much computation or if the data source is small, a PLINQ query may be slower than a sequential LINQ to Objects query.</span></span> <span data-ttu-id="3de03-224">Você pode usar o Analisador de Desempenho Paralelo no Visual Studio Team Server para comparar o desempenho de várias consultas, para localizar gargalos de processamento e para determinar se a consulta está em execução em paralelo ou sequencialmente.</span><span class="sxs-lookup"><span data-stu-id="3de03-224">You can use the Parallel Performance Analyzer in Visual Studio Team Server to compare the performance of various queries, to locate processing bottlenecks, and to determine whether your query is running in parallel or sequentially.</span></span> <span data-ttu-id="3de03-225">Para saber mais, veja [Visualizador de Simultaneidade](/visualstudio/profiling/concurrency-visualizer) e [Como medir o Desempenho da Consulta PLINQ](how-to-measure-plinq-query-performance.md).</span><span class="sxs-lookup"><span data-stu-id="3de03-225">For more information, see [Concurrency Visualizer](/visualstudio/profiling/concurrency-visualizer) and [How to: Measure PLINQ Query Performance](how-to-measure-plinq-query-performance.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="3de03-226">Confira também</span><span class="sxs-lookup"><span data-stu-id="3de03-226">See also</span></span>

- [<span data-ttu-id="3de03-227">LINQ paralelo (PLINQ)</span><span class="sxs-lookup"><span data-stu-id="3de03-227">Parallel LINQ (PLINQ)</span></span>](introduction-to-plinq.md)
- [<span data-ttu-id="3de03-228">Noções básicas sobre agilização em PLINQ</span><span class="sxs-lookup"><span data-stu-id="3de03-228">Understanding Speedup in PLINQ</span></span>](understanding-speedup-in-plinq.md)
