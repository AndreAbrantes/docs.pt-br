---
title: Como escrever um loop Parallel.For com variáveis locais de thread
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 18458e52c6cf38b2900036613676adea3f3b2d0b
ms.sourcegitcommit: c7f3e2e9d6ead6cc3acd0d66b10a251d0c66e59d
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/09/2018
ms.locfileid: "44188118"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="d5e1f-102">Como escrever um loop Parallel.For com variáveis locais de thread</span><span class="sxs-lookup"><span data-stu-id="d5e1f-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="d5e1f-103">Este exemplo mostra como usar variáveis de thread local para armazenar e recuperar o estado em cada tarefa separada criada por um loop <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="d5e1f-104">Usando dados de thread local, você pode evitar a sobrecarga de sincronizar um grande número de acessos com estado compartilhado.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="d5e1f-105">Em vez de gravar em um recurso compartilhado em cada iteração, você computa e armazena o valor até todas as iterações da tarefas serem concluídas.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="d5e1f-106">Em seguida, é possível gravar o resultado final uma vez no recurso compartilhado ou passá-lo para outro método.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="d5e1f-107">Exemplo</span><span class="sxs-lookup"><span data-stu-id="d5e1f-107">Example</span></span>  
 <span data-ttu-id="d5e1f-108">O exemplo a seguir chama o método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> para calcular a soma dos valores em uma matriz com um milhão de elementos.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="d5e1f-109">O valor de cada elemento é igual a seu índice.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="d5e1f-110">Os dois primeiros parâmetros de todo método <xref:System.Threading.Tasks.Parallel.For%2A> especificam os valores de iteração iniciais e finais.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="d5e1f-111">Nessa sobrecarga do método, o terceiro parâmetro é onde o estado local é inicializado.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="d5e1f-112">Nesse contexto, estado local significa uma variável cujo tempo de vida se prolonga um pouco antes da primeira iteração do loop no thread atual até pouco depois da última iteração.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="d5e1f-113">O tipo do terceiro parâmetro é um <xref:System.Func%601>, em que `TResult` é o tipo da variável que armazenará o estado de thread local.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="d5e1f-114">Seu tipo é definido pelo argumento de tipo genérico fornecido durante a chamada do método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> genérico, que, neste caso é <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="d5e1f-115">O argumento de tipo informa ao compilador o tipo da variável temporária que será usada para armazenar o estado de thread local.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="d5e1f-116">Neste exemplo, a expressão `() => 0` (ou `Function() 0` no Visual Basic) inicializa a variável de thread local em zero.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="d5e1f-117">Se o argumento de tipo genérico fosse um tipo de referência ou um tipo de valor definido pelo usuário, a expressão seria assim:</span><span class="sxs-lookup"><span data-stu-id="d5e1f-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="d5e1f-118">O quarto parâmetro define a lógica do loop.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="d5e1f-119">Ele deve ser uma expressão representante ou lambda, cuja assinatura é `Func<int, ParallelLoopState, long, long>` no C# ou `Func(Of Integer, ParallelLoopState, Long, Long)` no Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="d5e1f-120">O primeiro parâmetro é o valor do contador de loops para essa iteração do loop.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="d5e1f-121">O segundo é um objeto <xref:System.Threading.Tasks.ParallelLoopState> que pode ser usado para interromper o loop. Esse objeto é fornecido pela classe <xref:System.Threading.Tasks.Parallel> para cada ocorrência do loop.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="d5e1f-122">O terceiro parâmetro é a variável de thread local.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="d5e1f-123">O último parâmetro é o tipo de retorno.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-123">The last parameter is the return type.</span></span> <span data-ttu-id="d5e1f-124">Neste caso, o tipo é <xref:System.Int64> porque esse é o tipo que especificamos no argumento do tipo <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="d5e1f-125">Essa variável se chama `subtotal` e é retornada pela expressão lambda.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="d5e1f-126">O valor retornado é usado para inicializar `subtotal` em toda iteração subsequente do loop.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="d5e1f-127">Também é possível considerar esse último parâmetro como um valor passado para cada iteração e, em seguida, passado para o representante `localFinally` quando a última iteração está concluída.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="d5e1f-128">O quinto parâmetro define o método chamado uma vez, depois que todas as iterações em um determinado thread foram concluídas.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="d5e1f-129">O tipo de argumento de entrada mais uma vez corresponde ao argumento de tipo do método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> e ao tipo retornado pela expressão lambda do corpo.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="d5e1f-130">Neste exemplo, o valor é adicionado a uma variável no escopo da classe em thread-safe chamando o método <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d5e1f-131">Usando uma variável de thread local, evitamos a gravação nessa variável de classe em toda iteração do loop.</span><span class="sxs-lookup"><span data-stu-id="d5e1f-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="d5e1f-132">Para obter mais informações sobre como usar expressões lambda, confira [Expressões lambda no PLINQ e TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="d5e1f-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d5e1f-133">Consulte também</span><span class="sxs-lookup"><span data-stu-id="d5e1f-133">See also</span></span>

- [<span data-ttu-id="d5e1f-134">Paralelismo de dados</span><span class="sxs-lookup"><span data-stu-id="d5e1f-134">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
- [<span data-ttu-id="d5e1f-135">Programação paralela</span><span class="sxs-lookup"><span data-stu-id="d5e1f-135">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)  
- [<span data-ttu-id="d5e1f-136">TPL (Biblioteca de Paralelismo de Tarefas)</span><span class="sxs-lookup"><span data-stu-id="d5e1f-136">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)  
- [<span data-ttu-id="d5e1f-137">Expressões lambda em PLINQ e TPL</span><span class="sxs-lookup"><span data-stu-id="d5e1f-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
