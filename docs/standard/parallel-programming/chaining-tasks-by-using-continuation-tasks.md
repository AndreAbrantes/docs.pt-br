---
title: Encadeando tarefas usando tarefas de continuação
description: Aprenda a encadear a tarefa usando tarefas de continuação no .NET. Uma tarefa de continuação é uma tarefa assíncrona que é invocada por outra tarefa.
ms.date: 07/20/2020
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- tasks, continuations
ms.assetid: 0b45e9a2-de28-46ce-8212-1817280ed42d
ms.openlocfilehash: 132518b9d8d22efecfcf3ed14e8b5969aa768cd4
ms.sourcegitcommit: 1e6439ec4d5889fc08cf3bfb4dac2b91931eb827
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/08/2020
ms.locfileid: "88024583"
---
# <a name="chaining-tasks-using-continuation-tasks"></a><span data-ttu-id="b400d-104">Encadeando tarefas usando tarefas de continuação</span><span class="sxs-lookup"><span data-stu-id="b400d-104">Chaining tasks using continuation tasks</span></span>

<span data-ttu-id="b400d-105">Na programação assíncrona, é comum uma operação assíncrona, ao concluir, invocar uma segunda operação.</span><span class="sxs-lookup"><span data-stu-id="b400d-105">In asynchronous programming, it's common for one asynchronous operation, on completion, to invoke a second operation.</span></span> <span data-ttu-id="b400d-106">As continuações permitem que as operações descendente consumam os resultados da primeira operação.</span><span class="sxs-lookup"><span data-stu-id="b400d-106">Continuations allow decedent operations to consume the results of the first operation.</span></span> <span data-ttu-id="b400d-107">Tradicionalmente, continuações foram feitas usando os métodos de retorno de chamada.</span><span class="sxs-lookup"><span data-stu-id="b400d-107">Traditionally, continuations have been done by using callback methods.</span></span> <span data-ttu-id="b400d-108">Na Biblioteca de Tarefas Paralelas, a mesma funcionalidade é fornecida pelas _tarefas de continuação_.</span><span class="sxs-lookup"><span data-stu-id="b400d-108">In the Task Parallel Library, the same functionality is provided by _continuation tasks_.</span></span> <span data-ttu-id="b400d-109">Uma tarefa de continuação (também conhecida como uma continuação) é uma tarefa assíncrona que é invocada por outra tarefa, conhecida como _Antecedent_, quando o Antecedent é concluído.</span><span class="sxs-lookup"><span data-stu-id="b400d-109">A continuation task (also known just as a continuation) is an asynchronous task that's invoked by another task, known as the _antecedent_, when the antecedent finishes.</span></span>

<span data-ttu-id="b400d-110">As continuações são relativamente fáceis de usar, mas mesmo assim são poderosas e flexíveis.</span><span class="sxs-lookup"><span data-stu-id="b400d-110">Continuations are relatively easy to use, but are nevertheless powerful and flexible.</span></span> <span data-ttu-id="b400d-111">Por exemplo, você pode:</span><span class="sxs-lookup"><span data-stu-id="b400d-111">For example, you can:</span></span>

- <span data-ttu-id="b400d-112">Passe dados da antecessora para a continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-112">Pass data from the antecedent to the continuation.</span></span>
- <span data-ttu-id="b400d-113">Especifique as condições precisas sob a qual a continuação será invocada ou não invocada.</span><span class="sxs-lookup"><span data-stu-id="b400d-113">Specify the precise conditions under which the continuation will be invoked or not invoked.</span></span>
- <span data-ttu-id="b400d-114">Cancele uma continuação antes que ela comece ou cooperativamente enquanto ela estiver em execução.</span><span class="sxs-lookup"><span data-stu-id="b400d-114">Cancel a continuation either before it starts or cooperatively as it is running.</span></span>
- <span data-ttu-id="b400d-115">Forneça dicas sobre como a continuação deve ser agendada.</span><span class="sxs-lookup"><span data-stu-id="b400d-115">Provide hints about how the continuation should be scheduled.</span></span>
- <span data-ttu-id="b400d-116">Invoque várias continuações da mesma antecessora.</span><span class="sxs-lookup"><span data-stu-id="b400d-116">Invoke multiple continuations from the same antecedent.</span></span>
- <span data-ttu-id="b400d-117">Invoque uma continuação quando todas ou qualquer uma das diversas antecessoras for concluída.</span><span class="sxs-lookup"><span data-stu-id="b400d-117">Invoke one continuation when all or any one of multiple antecedents complete.</span></span>
- <span data-ttu-id="b400d-118">Encadeie continuações uma após a outra para qualquer comprimento arbitrário.</span><span class="sxs-lookup"><span data-stu-id="b400d-118">Chain continuations one after another to any arbitrary length.</span></span>
- <span data-ttu-id="b400d-119">Use uma continuação para manipular exceções lançadas pela antecessora.</span><span class="sxs-lookup"><span data-stu-id="b400d-119">Use a continuation to handle exceptions thrown by the antecedent.</span></span>

## <a name="about-continuations"></a><span data-ttu-id="b400d-120">Sobre continuações</span><span class="sxs-lookup"><span data-stu-id="b400d-120">About continuations</span></span>

<span data-ttu-id="b400d-121">Uma continuação é uma tarefa que é criada no estado <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation>.</span><span class="sxs-lookup"><span data-stu-id="b400d-121">A continuation is a task that is created in the <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> state.</span></span> <span data-ttu-id="b400d-122">Ela é ativada automaticamente quando sua tarefa ou tarefas antecessoras são concluídas.</span><span class="sxs-lookup"><span data-stu-id="b400d-122">It is activated automatically when its antecedent task or tasks complete.</span></span> <span data-ttu-id="b400d-123">Chamar <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> em uma continuação no código do usuário gera uma exceção <xref:System.InvalidOperationException?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-123">Calling <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> on a continuation in user code throws an <xref:System.InvalidOperationException?displayProperty=nameWithType> exception.</span></span>

<span data-ttu-id="b400d-124">Uma continuação é um <xref:System.Threading.Tasks.Task> e não bloqueia o thread em que é iniciada.</span><span class="sxs-lookup"><span data-stu-id="b400d-124">A continuation is itself a <xref:System.Threading.Tasks.Task> and does not block the thread on which it is started.</span></span> <span data-ttu-id="b400d-125">Chame o método <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> para bloquear até que a tarefa de continuação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="b400d-125">Call the <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> method to block until the continuation task finishes.</span></span>

## <a name="create-a-continuation-for-a-single-antecedent"></a><span data-ttu-id="b400d-126">Criar uma continuação para um único antecedente</span><span class="sxs-lookup"><span data-stu-id="b400d-126">Create a continuation for a single antecedent</span></span>

<span data-ttu-id="b400d-127">Você cria uma continuação que é executada quando seu antecessor é concluído chamando o método <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-127">You create a continuation that executes when its antecedent has completed by calling the <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="b400d-128">O exemplo a seguir mostra o padrão básico (para esclarecer, o tratamento de exceções é omitido).</span><span class="sxs-lookup"><span data-stu-id="b400d-128">The following example shows the basic pattern (for clarity, exception handling is omitted).</span></span> <span data-ttu-id="b400d-129">Ela executa uma tarefa antecessora, `taskA`, que retorna um objeto <xref:System.DayOfWeek> que indica o nome do dia da semana atual.</span><span class="sxs-lookup"><span data-stu-id="b400d-129">It executes an antecedent task, `taskA`, that returns a <xref:System.DayOfWeek> object that indicates the name of the current day of the week.</span></span> <span data-ttu-id="b400d-130">Quando a antecessora é concluída, a tarefa de continuação, `continuation`, recebe a antecessora e exibe uma cadeia de caracteres que inclui seu resultado.</span><span class="sxs-lookup"><span data-stu-id="b400d-130">When the antecedent completes, the continuation task, `continuation`, is passed the antecedent and displays a string that includes its result.</span></span>

> [!NOTE]
> <span data-ttu-id="b400d-131">Os exemplos de C# neste artigo usam o modificador `async` no método `Main`.</span><span class="sxs-lookup"><span data-stu-id="b400d-131">The C# samples in this article make use of the `async` modifier on the `Main` method.</span></span> <span data-ttu-id="b400d-132">Este recurso está disponível no C# 7.1 e versões posteriores.</span><span class="sxs-lookup"><span data-stu-id="b400d-132">That feature is available in C# 7.1 and later.</span></span> <span data-ttu-id="b400d-133">Versões anteriores geram [`CS5001`](../../csharp/misc/cs5001.md) ao compilar este código de exemplo.</span><span class="sxs-lookup"><span data-stu-id="b400d-133">Previous versions generate [`CS5001`](../../csharp/misc/cs5001.md) when compiling this sample code.</span></span> <span data-ttu-id="b400d-134">Você precisará definir a versão da linguagem de programação para C# 7.1 ou mais recente.</span><span class="sxs-lookup"><span data-stu-id="b400d-134">You'll need to set the language version to C# 7.1 or newer.</span></span> <span data-ttu-id="b400d-135">Você pode aprender como configurar a versão da linguagem de programação no artigo sobre [configuração da versão da linguagem](../../csharp/language-reference/configure-language-version.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-135">You can learn how to configure the language version in the article on [configure language version](../../csharp/language-reference/configure-language-version.md).</span></span>

:::code language="csharp" source="snippets/cs/simple1.cs":::

[!code-vb[TPL_Continuations#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/simple1.vb#1)]

## <a name="create-a-continuation-for-multiple-antecedents"></a><span data-ttu-id="b400d-136">Criar uma continuação para vários antecedentes</span><span class="sxs-lookup"><span data-stu-id="b400d-136">Create a continuation for multiple antecedents</span></span>

<span data-ttu-id="b400d-137">Você também pode criar uma continuação que será executada quando qualquer uma ou todo um grupo de tarefas tiver sido concluído.</span><span class="sxs-lookup"><span data-stu-id="b400d-137">You can also create a continuation that will run when any or all of a group of tasks has completed.</span></span> <span data-ttu-id="b400d-138">Para executar uma continuação quando todas as tarefas antecedentes são concluídas, você chama o método estático (`Shared` no Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> ou o método de instância <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-138">To execute a continuation when all antecedent tasks have completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="b400d-139">Para executar uma continuação quando qualquer uma das tarefas antecedentes é concluída, você chama o método estático (`Shared` no Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> ou o método de instância <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-139">To execute a continuation when any of the antecedent tasks has completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> method.</span></span>

<span data-ttu-id="b400d-140">Observe que as chamadas para as sobrecargas <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> e <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> não bloqueiam o thread de chamada.</span><span class="sxs-lookup"><span data-stu-id="b400d-140">Note that calls to the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> overloads do not block the calling thread.</span></span> <span data-ttu-id="b400d-141">No entanto, normalmente você chama todos <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> os <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> métodos e, para recuperar a <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> propriedade retornada, que bloqueia o thread de chamada.</span><span class="sxs-lookup"><span data-stu-id="b400d-141">However, you typically call all but the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> methods to retrieve the returned <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property, which does block the calling thread.</span></span>

<span data-ttu-id="b400d-142">O exemplo a seguir chama o método <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> para criar uma tarefa de continuação que reflete os resultados das dez tarefas antecedentes.</span><span class="sxs-lookup"><span data-stu-id="b400d-142">The following example calls the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> method to create a continuation task that reflects the results of its 10 antecedent tasks.</span></span> <span data-ttu-id="b400d-143">Cada tarefa antecessora eleva ao quadrado um valor de índice que varia de um a dez.</span><span class="sxs-lookup"><span data-stu-id="b400d-143">Each antecedent task squares an index value that ranges from one to 10.</span></span> <span data-ttu-id="b400d-144">Se os antecedentes tiverem sido concluídos com êxito (se sua propriedade <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> for <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), a propriedade <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> da continuação será uma matriz dos valores <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> retornados por cada antecessor.</span><span class="sxs-lookup"><span data-stu-id="b400d-144">If the antecedents complete successfully (their <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the continuation is an array of the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> values returned by each antecedent.</span></span> <span data-ttu-id="b400d-145">O exemplo os adiciona para calcular a soma dos quadrados de todos os números entre um e dez.</span><span class="sxs-lookup"><span data-stu-id="b400d-145">The example adds them to compute the sum of squares for all numbers between one and 10.</span></span>

:::code language="csharp" source="snippets/cs/whenall1.cs":::

[!code-vb[TPL_Continuations#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/whenall1.vb#5)]

## <a name="continuation-options"></a><span data-ttu-id="b400d-146">Opções de continuação</span><span class="sxs-lookup"><span data-stu-id="b400d-146">Continuation options</span></span>

<span data-ttu-id="b400d-147">Ao criar uma continuação de tarefa única, você pode usar uma sobrecarga <xref:System.Threading.Tasks.Task.ContinueWith%2A> que utiliza um valor de enumeração <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> para especificar as condições sob as quais a continuação é iniciada.</span><span class="sxs-lookup"><span data-stu-id="b400d-147">When you create a single-task continuation, you can use a <xref:System.Threading.Tasks.Task.ContinueWith%2A> overload that takes a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration value to specify the conditions under which the continuation starts.</span></span> <span data-ttu-id="b400d-148">Por exemplo, você pode especificar que a continuação só será executada se a antecessora for concluída com êxito ou apenas se ela for concluída em um estado de falha.</span><span class="sxs-lookup"><span data-stu-id="b400d-148">For example, you can specify that the continuation is to run only if the antecedent completes successfully, or only if it completes in a faulted state.</span></span> <span data-ttu-id="b400d-149">Se a condição não for verdadeira quando a antecessora estiver pronta para invocar a continuação, a continuação fará a transição diretamente para o estado <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> e não poderá ser iniciada depois disso.</span><span class="sxs-lookup"><span data-stu-id="b400d-149">If the condition is not true when the antecedent is ready to invoke the continuation, the continuation transitions directly to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state and subsequently cannot be started.</span></span>

<span data-ttu-id="b400d-150">Vários métodos de continuação de várias tarefas, como sobrecargas do método <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType>, também incluem um parâmetro <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-150">A number of multi-task continuation methods, such as overloads of the <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method, also include a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> parameter.</span></span> <span data-ttu-id="b400d-151">Somente um subconjunto de todos os membros de enumeração <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> é válido, no entanto.</span><span class="sxs-lookup"><span data-stu-id="b400d-151">Only a subset of all <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration members are valid, however.</span></span> <span data-ttu-id="b400d-152">Você pode especificar valores <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> que têm contrapartes na enumeração <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType>, como <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType> e <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-152">You can specify <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> values that have counterparts in the <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> enumeration, such as <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span></span> <span data-ttu-id="b400d-153">Se você especificar qualquer uma das opções `NotOn` ou `OnlyOn` com uma continuação de várias tarefas, uma exceção <xref:System.ArgumentOutOfRangeException> será gerada em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="b400d-153">If you specify any of the `NotOn` or `OnlyOn` options with a multi-task continuation, an <xref:System.ArgumentOutOfRangeException> exception will be thrown at run time.</span></span>

<span data-ttu-id="b400d-154">Para saber mais sobre opções de continuação de tarefas, confira o tópico <xref:System.Threading.Tasks.TaskContinuationOptions>.</span><span class="sxs-lookup"><span data-stu-id="b400d-154">For more information on task continuation options, see the <xref:System.Threading.Tasks.TaskContinuationOptions> topic.</span></span>

## <a name="pass-data-to-a-continuation"></a><span data-ttu-id="b400d-155">Passar dados para uma continuação</span><span class="sxs-lookup"><span data-stu-id="b400d-155">Pass data to a continuation</span></span>

<span data-ttu-id="b400d-156">O método <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> passa uma referência ao antecessor para o representante de usuário de continuação como um argumento.</span><span class="sxs-lookup"><span data-stu-id="b400d-156">The <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method passes a reference to the antecedent to the user delegate of the continuation as an argument.</span></span> <span data-ttu-id="b400d-157">Se o antecessor for um objeto <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType>, e a tarefa tiver sido executada ser concluída, a continuação poderá acessar a propriedade <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> da tarefa.</span><span class="sxs-lookup"><span data-stu-id="b400d-157">If the antecedent is a <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> object, and the task ran until it was completed, then the continuation can access the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the task.</span></span>

<span data-ttu-id="b400d-158">A propriedade <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> realiza o bloqueio até que a tarefa seja concluída.</span><span class="sxs-lookup"><span data-stu-id="b400d-158">The <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property blocks until the task has completed.</span></span> <span data-ttu-id="b400d-159">No entanto, se a tarefa foi cancelada ou falhou, a tentativa de acessar a propriedade <xref:System.Threading.Tasks.Task%601.Result%2A> gera uma exceção <xref:System.AggregateException>.</span><span class="sxs-lookup"><span data-stu-id="b400d-159">However, if the task was canceled or faulted, attempting to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property throws an <xref:System.AggregateException> exception.</span></span> <span data-ttu-id="b400d-160">Você pode evitar esse problema usando a opção <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion>, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="b400d-160">You can avoid this problem by using the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> option, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/result1.cs":::

[!code-vb[TPL_Continuations#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result1.vb#2)]

<span data-ttu-id="b400d-161">Se você quiser que a continuação seja executada mesmo se a antecessora não tiver sido concluída com êxito, deverá se proteger contra a exceção.</span><span class="sxs-lookup"><span data-stu-id="b400d-161">If you want the continuation to run even if the antecedent did not run to successful completion, you must guard against the exception.</span></span> <span data-ttu-id="b400d-162">Uma abordagem é testar a propriedade <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> do antecedente e só tentar acessar a propriedade <xref:System.Threading.Tasks.Task%601.Result%2A> se o status não é <xref:System.Threading.Tasks.TaskStatus.Faulted> ou <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="b400d-162">One approach is to test the <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of the antecedent, and only attempt to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property if the status is not <xref:System.Threading.Tasks.TaskStatus.Faulted> or <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span></span> <span data-ttu-id="b400d-163">Você também pode examinar a propriedade <xref:System.Threading.Tasks.Task.Exception%2A> do antecessor.</span><span class="sxs-lookup"><span data-stu-id="b400d-163">You can also examine the <xref:System.Threading.Tasks.Task.Exception%2A> property of the antecedent.</span></span> <span data-ttu-id="b400d-164">Para saber mais, veja [Tratamento de exceção](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-164">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span> <span data-ttu-id="b400d-165">O exemplo a seguir modifica o exemplo anterior para acessar a propriedade <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> do antecessor somente se o status é <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-165">The following example modifies the previous example to access antecedent's <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property only if its status is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/result2.cs":::

[!code-vb[TPL_Continuations#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result2.vb#7)]

## <a name="cancel-a-continuation"></a><span data-ttu-id="b400d-166">Cancelar uma continuação</span><span class="sxs-lookup"><span data-stu-id="b400d-166">Cancel a continuation</span></span>

<span data-ttu-id="b400d-167">A propriedade <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> de uma continuação é definida como <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> nas seguintes situações:</span><span class="sxs-lookup"><span data-stu-id="b400d-167">The <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of a continuation is set to <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> in the following situations:</span></span>

- <span data-ttu-id="b400d-168">Gera uma exceção <xref:System.OperationCanceledException> em resposta a uma solicitação de cancelamento.</span><span class="sxs-lookup"><span data-stu-id="b400d-168">It throws an <xref:System.OperationCanceledException> exception in response to a cancellation request.</span></span> <span data-ttu-id="b400d-169">Assim como acontece com qualquer tarefa, se a exceção contiver o mesmo token que foi passado para a continuação, ela será tratada como uma confirmação do cancelamento cooperativo.</span><span class="sxs-lookup"><span data-stu-id="b400d-169">As with any task, if the exception contains the same token that was passed to the continuation, it is treated as an acknowledgement of cooperative cancellation.</span></span>
- <span data-ttu-id="b400d-170">A continuação recebe um <xref:System.Threading.CancellationToken?displayProperty=nameWithType> cuja propriedade <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> é `true`.</span><span class="sxs-lookup"><span data-stu-id="b400d-170">The continuation is passed a <xref:System.Threading.CancellationToken?displayProperty=nameWithType> whose <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property is `true`.</span></span> <span data-ttu-id="b400d-171">Nesse caso, a continuação não é iniciada e faz a transição para o estado <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-171">In this case, the continuation does not start, and it transitions to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state.</span></span>
- <span data-ttu-id="b400d-172">A continuação nunca é executada porque a condição definida por seu argumento <xref:System.Threading.Tasks.TaskContinuationOptions> não foi atendida.</span><span class="sxs-lookup"><span data-stu-id="b400d-172">The continuation never runs because the condition set by its <xref:System.Threading.Tasks.TaskContinuationOptions> argument was not met.</span></span> <span data-ttu-id="b400d-173">Por exemplo, se um antecessor entrar em um estado <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType>, sua continuação que recebeu a opção <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> não será executada, mas fará a transição para o estado <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="b400d-173">For example, if an antecedent goes into a <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> state, its continuation that was passed the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> option will not run but will transition to the <xref:System.Threading.Tasks.TaskStatus.Canceled> state.</span></span>

<span data-ttu-id="b400d-174">Se uma tarefa e sua continuação representam duas partes da mesma operação lógica, você pode passar o mesmo token de cancelamento para as duas tarefas, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="b400d-174">If a task and its continuation represent two parts of the same logical operation, you can pass the same cancellation token to both tasks, as shown in the following example.</span></span> <span data-ttu-id="b400d-175">Ele consiste em uma antecessora que gera uma lista de inteiros divisíveis por 33, que é passada para a continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-175">It consists of an antecedent that generates a list of integers that are divisible by 33, which it passes to the continuation.</span></span> <span data-ttu-id="b400d-176">Por sua vez, a continuação exibe a lista.</span><span class="sxs-lookup"><span data-stu-id="b400d-176">The continuation in turn displays the list.</span></span> <span data-ttu-id="b400d-177">A antecessora e a continuação pausam regularmente por intervalos aleatórios.</span><span class="sxs-lookup"><span data-stu-id="b400d-177">Both the antecedent and the continuation pause regularly for random intervals.</span></span> <span data-ttu-id="b400d-178">Além disso, um objeto <xref:System.Threading.Timer?displayProperty=nameWithType> é usado para executar o método `Elapsed` após um intervalo de tempo limite de cinco segundos.</span><span class="sxs-lookup"><span data-stu-id="b400d-178">In addition, a <xref:System.Threading.Timer?displayProperty=nameWithType> object is used to execute the `Elapsed` method after a five-second timeout interval.</span></span> <span data-ttu-id="b400d-179">Este exemplo chama o método <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType>, o que faz com que a tarefa em execução no momento chame o método <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-179">This example calls the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method, which causes the currently executing task to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="b400d-180">O método <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> é chamado ou não quando o antecessor ou sua continuação está em execução, dependendo da duração das pausas geradas aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="b400d-180">Whether the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method is called when the antecedent or its continuation is executing depends on the duration of the randomly generated pauses.</span></span> <span data-ttu-id="b400d-181">Se a antecessora for cancelada, a continuação não será iniciada.</span><span class="sxs-lookup"><span data-stu-id="b400d-181">If the antecedent is canceled, the continuation will not start.</span></span> <span data-ttu-id="b400d-182">Se a antecessora não for cancelada, o token ainda poderá ser usado para cancelar a continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-182">If the antecedent is not canceled, the token can still be used to cancel the continuation.</span></span>

:::code language="csharp" source="snippets/cs/cancellation1.cs":::

[!code-vb[TPL_Continuations#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation1.vb#3)]

<span data-ttu-id="b400d-183">Você também pode impedir a execução de uma continuação caso sua antecessora seja cancelada sem o fornecimento da continuação de um token de cancelamento especificando a opção <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> quando a continuação for criada.</span><span class="sxs-lookup"><span data-stu-id="b400d-183">You can also prevent a continuation from executing if its antecedent is canceled without supplying the continuation a cancellation token by specifying the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> option when you create the continuation.</span></span> <span data-ttu-id="b400d-184">A seguir há um exemplo simples.</span><span class="sxs-lookup"><span data-stu-id="b400d-184">The following is a simple example.</span></span>

:::code language="csharp" source="snippets/cs/cancellation2.cs":::

[!code-vb[TPL_Continuations#8](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation2.vb#8)]

<span data-ttu-id="b400d-185">Depois que uma continuação entra no estado <xref:System.Threading.Tasks.TaskStatus.Canceled>, pode afetar as continuações seguintes, dependendo do <xref:System.Threading.Tasks.TaskContinuationOptions> especificado para as continuações.</span><span class="sxs-lookup"><span data-stu-id="b400d-185">After a continuation goes into the <xref:System.Threading.Tasks.TaskStatus.Canceled> state, it may affect continuations that follow, depending on the <xref:System.Threading.Tasks.TaskContinuationOptions> that were specified for those continuations.</span></span>

<span data-ttu-id="b400d-186">As continuações descartadas não serão iniciadas.</span><span class="sxs-lookup"><span data-stu-id="b400d-186">Continuations that are disposed will not start.</span></span>

## <a name="continuations-and-child-tasks"></a><span data-ttu-id="b400d-187">Tarefas de continuação e filho</span><span class="sxs-lookup"><span data-stu-id="b400d-187">Continuations and child tasks</span></span>

<span data-ttu-id="b400d-188">Uma continuação não é executada até que a antecessora e todas suas tarefas filhas anexadas sejam concluídas.</span><span class="sxs-lookup"><span data-stu-id="b400d-188">A continuation does not run until the antecedent and all of its attached child tasks have completed.</span></span> <span data-ttu-id="b400d-189">A continuação não espera a conclusão de tarefas filhas desanexadas.</span><span class="sxs-lookup"><span data-stu-id="b400d-189">The continuation does not wait for detached child tasks to finish.</span></span> <span data-ttu-id="b400d-190">Os dois exemplos a seguir ilustram tarefas filhas anexadas e desanexadas de uma antecessora que cria uma continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-190">The following two examples illustrate child tasks that are attached to and detached from an antecedent that creates a continuation.</span></span> <span data-ttu-id="b400d-191">No exemplo a seguir, a continuação é executada somente após a conclusão de todas as tarefas filhas e executar o exemplo várias vezes produzirá uma saída idêntica em todas elas.</span><span class="sxs-lookup"><span data-stu-id="b400d-191">In the following example, the continuation runs only after all child tasks have completed, and running the example multiple times produces identical output each time.</span></span> <span data-ttu-id="b400d-192">O exemplo inicia o antecessor chamando o método <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType>, pois, por padrão, o método <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> cria uma tarefa pai de opção de criação de tarefa cujo padrão é <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-192">The example launches the antecedent by calling the <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType> method, since by default the <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> method creates a parent task whose default task creation option is <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/attached1.cs":::

[!code-vb[TPL_Continuations#9](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/attached1.vb#9)]

<span data-ttu-id="b400d-193">Se as tarefas filhas forem desanexadas da antecessora, no entanto, a continuação será executada assim que a antecessor tiver sido finalizada, independentemente do estado das tarefas filhas.</span><span class="sxs-lookup"><span data-stu-id="b400d-193">If child tasks are detached from the antecedent, however, the continuation runs as soon as the antecedent has terminated, regardless of the state of the child tasks.</span></span> <span data-ttu-id="b400d-194">Como resultado, várias execuções do exemplo a seguir podem produzir uma saída variável que depende de como o agendador de tarefas tratou cada tarefa filha.</span><span class="sxs-lookup"><span data-stu-id="b400d-194">As a result, multiple runs of the following example can produce variable output that depends on how the task scheduler handled each child task.</span></span>

:::code language="csharp" source="snippets/cs/detached1.cs":::

[!code-vb[TPL_Continuations#10](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/detached1.vb#10)]

<span data-ttu-id="b400d-195">O status final da tarefa antecessora depende do status final de quaisquer tarefas filhas anexadas.</span><span class="sxs-lookup"><span data-stu-id="b400d-195">The final status of the antecedent task depends on the final status of any attached child tasks.</span></span> <span data-ttu-id="b400d-196">O status de tarefas filhas desanexadas não afeta a principal.</span><span class="sxs-lookup"><span data-stu-id="b400d-196">The status of detached child tasks does not affect the parent.</span></span> <span data-ttu-id="b400d-197">Para obter mais informações, consulte [Tarefas filho anexadas e desanexadas](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-197">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="associate-state-with-continuations"></a><span data-ttu-id="b400d-198">Associar o estado a continuas</span><span class="sxs-lookup"><span data-stu-id="b400d-198">Associate state with continuations</span></span>

<span data-ttu-id="b400d-199">Você pode associar o estado arbitrário a uma continuação da tarefa.</span><span class="sxs-lookup"><span data-stu-id="b400d-199">You can associate arbitrary state with a task continuation.</span></span> <span data-ttu-id="b400d-200">O método <xref:System.Threading.Tasks.Task.ContinueWith%2A> fornece versões sobrecarregadas que utilizam um valor <xref:System.Object> que representa o estado de continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-200">The <xref:System.Threading.Tasks.Task.ContinueWith%2A> method provides overloaded versions that each take an <xref:System.Object> value that represents the state of the continuation.</span></span> <span data-ttu-id="b400d-201">Mais tarde, você pode acessar esse objeto de estado usando a propriedade <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-201">You can later access this state object by using the <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="b400d-202">Esse objeto de estado será `null` se você não fornecer um valor.</span><span class="sxs-lookup"><span data-stu-id="b400d-202">This state object is `null` if you do not provide a value.</span></span>

<span data-ttu-id="b400d-203">O estado de continuação é útil quando você converte o código existente que usa o [APM (Modelo de Programação Assíncrona)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) para usar o TPL.</span><span class="sxs-lookup"><span data-stu-id="b400d-203">Continuation state is useful when you convert existing code that uses the [Asynchronous Programming Model (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) to use the TPL.</span></span> <span data-ttu-id="b400d-204">No APM, você normalmente fornece o estado do objeto no método **Begin**_Method_ e acessa posteriormente esse estado usando a propriedade <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="b400d-204">In the APM, you typically provide object state in the **Begin**_Method_ method and later access that state by using the <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="b400d-205">Usando o método <xref:System.Threading.Tasks.Task.ContinueWith%2A>, você pode preservar esse estado ao converter o código que usa o APM para usar a TPL.</span><span class="sxs-lookup"><span data-stu-id="b400d-205">By using the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method, you can preserve this state when you convert code that uses the APM to use the TPL.</span></span>

<span data-ttu-id="b400d-206">O estado de continuação também pode ser útil quando você trabalha com objetos <xref:System.Threading.Tasks.Task> no depurador do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b400d-206">Continuation state can also be useful when you work with <xref:System.Threading.Tasks.Task> objects in the Visual Studio debugger.</span></span> <span data-ttu-id="b400d-207">Por exemplo, na janela **Tarefas Paralelas**, a coluna **Tarefa** exibe a representação de cadeia de caracteres do objeto de estado para cada tarefa.</span><span class="sxs-lookup"><span data-stu-id="b400d-207">For example, in the **Parallel Tasks** window, the **Task** column displays the string representation of the state object for each task.</span></span> <span data-ttu-id="b400d-208">Para saber mais sobre a janela **Tarefas Paralelas**, veja [Uso da janela Tarefas](/visualstudio/debugger/using-the-tasks-window).</span><span class="sxs-lookup"><span data-stu-id="b400d-208">For more information about the **Parallel Tasks** window, see [Using the Tasks Window](/visualstudio/debugger/using-the-tasks-window).</span></span>

<span data-ttu-id="b400d-209">O exemplo a seguir mostra como usar o estado de continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-209">The following example shows how to use continuation state.</span></span> <span data-ttu-id="b400d-210">Ele cria uma cadeia de tarefas de continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-210">It creates a chain of continuation tasks.</span></span> <span data-ttu-id="b400d-211">Cada tarefa fornece a hora atual, um objeto <xref:System.DateTime>, para o parâmetro `state` do método <xref:System.Threading.Tasks.Task.ContinueWith%2A>.</span><span class="sxs-lookup"><span data-stu-id="b400d-211">Each task provides the current time, a <xref:System.DateTime> object, for the `state` parameter of the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method.</span></span> <span data-ttu-id="b400d-212">Cada objeto <xref:System.DateTime> representa a hora em que a tarefa de continuação é criada.</span><span class="sxs-lookup"><span data-stu-id="b400d-212">Each <xref:System.DateTime> object represents the time at which the continuation task is created.</span></span> <span data-ttu-id="b400d-213">Cada tarefa gera como resultado um segundo objeto <xref:System.DateTime> que representa a hora de conclusão da tarefa.</span><span class="sxs-lookup"><span data-stu-id="b400d-213">Each task produces as its result a second <xref:System.DateTime> object that represents the time at which the task finishes.</span></span> <span data-ttu-id="b400d-214">Depois de concluir todas as tarefas, este exemplo exibe a hora de criação e a hora em que cada continuação a tarefa é concluída.</span><span class="sxs-lookup"><span data-stu-id="b400d-214">After all tasks finish, this example displays the creation time and the time at which each continuation task finishes.</span></span>

:::code language="csharp" source="snippets/cs/continuationstate.cs":::

[!code-vb[TPL_ContinuationState#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuationstate/vb/continuationstate.vb#1)]

## <a name="continuations-that-return-task-types"></a><span data-ttu-id="b400d-215">Continuas que retornam tipos de tarefas</span><span class="sxs-lookup"><span data-stu-id="b400d-215">Continuations that return Task types</span></span>

<span data-ttu-id="b400d-216">Às vezes, talvez seja necessário encadear uma continuação que retorne um <xref:System.Threading.Tasks.Task> tipo.</span><span class="sxs-lookup"><span data-stu-id="b400d-216">Sometimes you may need to chain a continuation that returns a <xref:System.Threading.Tasks.Task> type.</span></span> <span data-ttu-id="b400d-217">Eles são chamados de tarefas aninhadas e são comuns.</span><span class="sxs-lookup"><span data-stu-id="b400d-217">These are referred to as nested tasks, and they are common.</span></span> <span data-ttu-id="b400d-218">Quando uma tarefa pai chama <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType> , e fornece uma `continuationFunction` tarefa que retorna <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> a chamada para criar uma tarefa de proxy que representa a operação assíncrona do `<Task<Task<T>>>` ou `Task(Of Task(Of T))` (Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="b400d-218">When a parent task calls <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType>, and provides a `continuationFunction` that is task returning you call <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> to create a proxy task that represents the asynchronous operation of the `<Task<Task<T>>>` or `Task(Of Task(Of T))` (Visual Basic).</span></span>

<span data-ttu-id="b400d-219">O exemplo a seguir mostra como usar as continuações que encapsulam funções de retorno de tarefas adicionais.</span><span class="sxs-lookup"><span data-stu-id="b400d-219">The following example shows how to use continuations that wrap additional task returning functions.</span></span> <span data-ttu-id="b400d-220">Cada continuação pode ser desencapsulada, expondo a tarefa interna que foi encapsulada.</span><span class="sxs-lookup"><span data-stu-id="b400d-220">Each continuation can be unwrapped, exposing the inner task that was wrapped.</span></span>

:::code language="csharp" source="snippets/cs/unwrap.cs":::
:::code language="vb" source="snippets/vb/unwrap.vb":::

<span data-ttu-id="b400d-221">Para obter mais informações sobre <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> como usar [o, consulte Como: desencapsular uma tarefa aninhada](how-to-unwrap-a-nested-task.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-221">For more information on using <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A>, see [How to: Unwrap a nested Task](how-to-unwrap-a-nested-task.md).</span></span>

## <a name="handle-exceptions-thrown-from-continuations"></a><span data-ttu-id="b400d-222">Tratar exceções geradas a partir de continuaçãos</span><span class="sxs-lookup"><span data-stu-id="b400d-222">Handle exceptions thrown from continuations</span></span>

<span data-ttu-id="b400d-223">Uma relação antecessora-continuação não é uma relação pai-filho.</span><span class="sxs-lookup"><span data-stu-id="b400d-223">An antecedent-continuation relationship is not a parent-child relationship.</span></span> <span data-ttu-id="b400d-224">As exceções geradas por continuações não são propagadas para o antecessor.</span><span class="sxs-lookup"><span data-stu-id="b400d-224">Exceptions thrown by continuations are not propagated to the antecedent.</span></span> <span data-ttu-id="b400d-225">Portanto, trate as exceções geradas por continuações como você lidaria com elas em qualquer outra tarefa, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="b400d-225">Therefore, handle exceptions thrown by continuations as you would handle them in any other task, as follows:</span></span>

- <span data-ttu-id="b400d-226">Você pode usar o método <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A> ou <xref:System.Threading.Tasks.Task.WaitAny%2A>, ou seu equivalente genérico, para aguardar a continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-226">You can use the <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, or <xref:System.Threading.Tasks.Task.WaitAny%2A> method, or its generic counterpart, to wait on the continuation.</span></span> <span data-ttu-id="b400d-227">Você pode esperar por uma antecessora e suas continuações na mesma instrução `try`, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="b400d-227">You can wait for an antecedent and its continuations in the same `try` statement, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/exception1.cs":::

[!code-vb[TPL_Continuations#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception1.vb#6)]

- <span data-ttu-id="b400d-228">Você pode usar uma segunda continuação para observar a propriedade <xref:System.Threading.Tasks.Task.Exception%2A> da primeira continuação.</span><span class="sxs-lookup"><span data-stu-id="b400d-228">You can use a second continuation to observe the <xref:System.Threading.Tasks.Task.Exception%2A> property of the first continuation.</span></span> <span data-ttu-id="b400d-229">No exemplo a seguir, uma tarefa tenta ler um arquivo inexistente.</span><span class="sxs-lookup"><span data-stu-id="b400d-229">In the following example, a task attempts to read from a non-existent file.</span></span> <span data-ttu-id="b400d-230">Em seguida, a continuação exibe informações sobre a exceção na tarefa antecessora.</span><span class="sxs-lookup"><span data-stu-id="b400d-230">The continuation then displays information about the exception in the antecedent task.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="example":::

[!code-vb[TPL_Continuations#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#4)]

<span data-ttu-id="b400d-231">Como ele foi executado com a opção <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType>, a continuação será executada somente se uma exceção ocorrer no antecessor. Portanto, ele pode presumir que a propriedade <xref:System.Threading.Tasks.Task.Exception%2A> do antecessor não é `null`.</span><span class="sxs-lookup"><span data-stu-id="b400d-231">Because it was run with the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> option, the continuation executes only if an exception occurs in the antecedent, and therefore it can assume that the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null`.</span></span> <span data-ttu-id="b400d-232">Se a continuação for executada, caso uma exceção seja ou não gerada na antecessora, ela deverá verificar se a propriedade <xref:System.Threading.Tasks.Task.Exception%2A> da antecessora não é `null` antes de tentar tratar a exceção, como mostrado pelo fragmento de código a seguir.</span><span class="sxs-lookup"><span data-stu-id="b400d-232">If the continuation executes whether or not an exception is thrown in the antecedent, it would have to check whether the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null` before attempting to handle the exception, as the following code fragment shows.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="exception":::

[!code-vb[TPL_Continuations#11](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#11)]

<span data-ttu-id="b400d-233">Para saber mais, veja [Tratamento de exceção](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-233">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span>

- <span data-ttu-id="b400d-234">Se a continuação for uma tarefa filha anexada que foi criada usando a opção <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, suas exceções serão propagadas pelo pai para o thread de chamada, como será o caso em qualquer outra filha anexada.</span><span class="sxs-lookup"><span data-stu-id="b400d-234">If the continuation is an attached child task that was created by using the <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> option, its exceptions will be propagated by the parent back to the calling thread, as is the case in any other attached child.</span></span> <span data-ttu-id="b400d-235">Para obter mais informações, consulte [Tarefas filho anexadas e desanexadas](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="b400d-235">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="b400d-236">Consulte também</span><span class="sxs-lookup"><span data-stu-id="b400d-236">See also</span></span>

- [<span data-ttu-id="b400d-237">Biblioteca de tarefas paralelas (TPL)</span><span class="sxs-lookup"><span data-stu-id="b400d-237">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
