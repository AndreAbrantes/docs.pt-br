---
title: "Desafios e soluções de gerenciamento de dados distribuído"
description: "Arquitetura de Microservices .NET para aplicativos .NET em contêineres | Desafios e soluções de gerenciamento de dados distribuído"
keywords: "Docker, Microsserviços, ASP.NET, Contêiner"
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.openlocfilehash: f961475b40c74bf448cff1aeae04ae4866360e52
ms.sourcegitcommit: c2e216692ef7576a213ae16af2377cd98d1a67fa
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/22/2017
---
# <a name="challenges-and-solutions-for-distributed-data-management"></a><span data-ttu-id="a0b7a-104">Desafios e soluções de gerenciamento de dados distribuído</span><span class="sxs-lookup"><span data-stu-id="a0b7a-104">Challenges and solutions for distributed data management</span></span>

## <a name="challenge-1-how-to-define-the-boundaries-of-each-microservice"></a><span data-ttu-id="a0b7a-105">Desafio \#1: como definir os limites de cada microsserviço</span><span class="sxs-lookup"><span data-stu-id="a0b7a-105">Challenge \#1: How to define the boundaries of each microservice</span></span>

<span data-ttu-id="a0b7a-106">Definir limites de microsserviço provavelmente é o primeiro desafio que qualquer pessoa que se encontra.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-106">Defining microservice boundaries is probably the first challenge anyone encounters.</span></span> <span data-ttu-id="a0b7a-107">Cada microsserviço deve ser uma parte do seu aplicativo, e cada microsserviço deve ser autônomo com todos os benefícios e desafios que transmite.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-107">Each microservice has to be a piece of your application and each microservice should be autonomous with all the benefits and challenges that it conveys.</span></span> <span data-ttu-id="a0b7a-108">Mas como identificar esses limites?</span><span class="sxs-lookup"><span data-stu-id="a0b7a-108">But how do you identify those boundaries?</span></span>

<span data-ttu-id="a0b7a-109">Primeiro, você precisa se concentrar em modelos de domínio lógica do aplicativo e dados relacionados.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-109">First, you need to focus on the application’s logical domain models and related data.</span></span> <span data-ttu-id="a0b7a-110">Você deve tentar identificar desacopladas ilhas de dados e contextos diferentes dentro do mesmo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-110">You must try to identify decoupled islands of data and different contexts within the same application.</span></span> <span data-ttu-id="a0b7a-111">Cada contexto pode ter um idioma diferente de negócios (termos de negócios diferente).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-111">Each context could have a different business language (different business terms).</span></span> <span data-ttu-id="a0b7a-112">Os contextos devem ser definidos e gerenciados de forma independente.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-112">The contexts should be defined and managed independently.</span></span> <span data-ttu-id="a0b7a-113">Os termos e as entidades usadas nesses contextos diferentes, podem parecer semelhantes, mas você pode descobrir que, em um contexto específico, um conceito de negócios com um é usado para uma finalidade diferente em outro contexto e pode ter um nome diferente.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-113">The terms and entities used in those different contexts might sound similar, but you might discover that in a particular context, a business concept with one is used for a different purpose in another context, and might even have a different name.</span></span> <span data-ttu-id="a0b7a-114">Por exemplo, um usuário pode ser referido como um usuário no contexto de identidade ou de associação, como um cliente em um contexto CRM, como um cliente em um contexto de ordenação e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-114">For instance, a user can be referred as a user in the identity or membership context, as a customer in a CRM context, as a buyer in an ordering context, and so forth.</span></span>

<span data-ttu-id="a0b7a-115">A maneira como você identificar os limites entre vários contextos de aplicativo com um domínio diferente para cada contexto é exatamente como você pode identificar os limites para cada microsserviço de negócios e seu relacionados modelo de domínio e os dados.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-115">The way you identify boundaries between multiple application contexts with a different domain for each context is exactly how you can identify the boundaries for each business microservice and its related domain model and data.</span></span> <span data-ttu-id="a0b7a-116">Você sempre tentar reduzir o acoplamento entre esses microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-116">You always attempt to minimize the coupling between those microservices.</span></span> <span data-ttu-id="a0b7a-117">Este guia apresenta mais detalhes sobre esse design de modelo de domínio e a identificação na seção [identificar limites de modelo de domínio para cada microsserviço](#identifying-domain-model-boundaries-for-each-microservice) mais tarde.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-117">This guide goes into more detail about this identification and domain model design in the section [Identifying domain-model boundaries for each microservice](#identifying-domain-model-boundaries-for-each-microservice) later.</span></span>

## <a name="challenge-2-how-to-create-queries-that-retrieve-data-from-several-microservices"></a><span data-ttu-id="a0b7a-118">Desafio \#2: como criar consultas que recuperam dados de vários microservices</span><span class="sxs-lookup"><span data-stu-id="a0b7a-118">Challenge \#2: How to create queries that retrieve data from several microservices</span></span>

<span data-ttu-id="a0b7a-119">Um segundo desafio é a implementação de consultas que recuperam dados de vários microservices, evitando a comunicação verborrágica para o microservices de aplicativos de cliente remoto.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-119">A second challenge is how to implement queries that retrieve data from several microservices, while avoiding chatty communication to the microservices from remote client apps.</span></span> <span data-ttu-id="a0b7a-120">Um exemplo pode ser uma única tela de um aplicativo móvel que precisa para mostrar informações do usuário que pertencem o carrinho, catálogo e microservices de identidade do usuário.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-120">An example could be a single screen from a mobile app that needs to show user information that is owned by the basket, catalog, and user identity microservices.</span></span> <span data-ttu-id="a0b7a-121">Outro exemplo seria um relatório complexo que envolve muitas tabelas localizadas em vários microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-121">Another example would be a complex report involving many tables located in multiple microservices.</span></span> <span data-ttu-id="a0b7a-122">A solução certa depende da complexidade das consultas.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-122">The right solution depends on the complexity of the queries.</span></span> <span data-ttu-id="a0b7a-123">Mas em qualquer caso, será necessário um método de agregação informações para melhorar a eficiência na comunicação do sistema.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-123">But in any case, you will need a way to aggregate information if you want to improve the efficiency in the communications of your system.</span></span> <span data-ttu-id="a0b7a-124">As soluções mais comuns são as seguintes.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-124">The most popular solutions are the following.</span></span>

<span data-ttu-id="a0b7a-125">**API de Gateway**.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-125">**API Gateway**.</span></span> <span data-ttu-id="a0b7a-126">Para a agregação de dados simples de vários microservices que possui bancos de dados diferentes, a abordagem recomendada é um microsserviço de agregação, conhecido como um Gateway de API.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-126">For simple data aggregation from multiple microservices that own different databases, the recommended approach is an aggregation microservice referred to as an API Gateway.</span></span> <span data-ttu-id="a0b7a-127">No entanto, você precisa ter cuidado ao implementar esse padrão, porque ele pode ser um ponto de restrição no seu sistema e ele pode violar o princípio de microsserviço autonomia.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-127">However, you need to be careful about implementing this pattern, because it can be a choke point in your system, and it can violate the principle of microservice autonomy.</span></span> <span data-ttu-id="a0b7a-128">Para atenuar essa possibilidade, você pode ter vários Gateways de API granular cada um focalizando um vertical "fatia" ou a área de negócios do sistema.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-128">To mitigate this possibility, you can have multiple fined-grained API Gateways each one focusing on a vertical “slice” or business area of the system.</span></span> <span data-ttu-id="a0b7a-129">O padrão de Gateway de API é explicado mais detalhadamente na seção de usando um Gateway de API mais tarde.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-129">The API Gateway pattern is explained in more detail in the section in the Using an API Gateway later.</span></span>

<span data-ttu-id="a0b7a-130">**CQRS com tabelas de consulta/leituras**.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-130">**CQRS with query/reads tables**.</span></span> <span data-ttu-id="a0b7a-131">Outra solução para agregar dados de vários microservices é o [padrão da exibição materializada](https://docs.microsoft.com/azure/architecture/patterns/materialized-view).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-131">Another solution for aggregating data from multiple microservices is the [Materialized View pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view).</span></span> <span data-ttu-id="a0b7a-132">Nessa abordagem, gerar, com antecedência (preparar dados desnormalizados antes das consultas reais ocorrem), uma tabela somente leitura com os dados que pertencem a vários microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-132">In this approach, you generate, in advance (prepare denormalized data before the actual queries happen), a read-only table with the data that is owned by multiple microservices.</span></span> <span data-ttu-id="a0b7a-133">A tabela tem um formato adequado às necessidades do aplicativo cliente.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-133">The table has a format suited to the client app’s needs.</span></span>

<span data-ttu-id="a0b7a-134">Considere a possibilidade de algo como tela de um aplicativo móvel.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-134">Consider something like the screen for a mobile app.</span></span> <span data-ttu-id="a0b7a-135">Se você tiver um único banco de dados, você pode reunir dados para essa tela usando uma consulta SQL que executa uma junção complexa que envolve várias tabelas.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-135">If you have a single database, you might pull together the data for that screen using a SQL query that performs a complex join involving multiple tables.</span></span> <span data-ttu-id="a0b7a-136">No entanto, quando você tiver vários bancos de dados, e cada banco de dados pertence a um microsserviço diferente, você não pode consultar esses bancos de dados e criar uma junção SQL.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-136">However, when you have multiple databases, and each database is owned by a different microservice, you cannot query those databases and create a SQL join.</span></span> <span data-ttu-id="a0b7a-137">Sua consulta complexa se torna um desafio.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-137">Your complex query becomes a challenge.</span></span> <span data-ttu-id="a0b7a-138">Você pode lidar com o requisito usando uma abordagem CQRS — criar uma tabela não normalizada em outro banco de dados que é usado apenas para consultas.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-138">You can address the requirement using a CQRS approach—you create a denormalized table in a different database that is used just for queries.</span></span> <span data-ttu-id="a0b7a-139">A tabela pode ser desenvolvida especificamente para os dados que necessários para a consulta complexa, com uma relação um para um entre campos necessários a tela do aplicativo e as colunas na tabela de consulta.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-139">The table can be designed specifically for the data you need for the complex query, with a one-to-one relationship between fields needed by your application’s screen and the columns in the query table.</span></span> <span data-ttu-id="a0b7a-140">Ele também pode funcionar para fins de relatório.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-140">It could also serve for reporting purposes.</span></span>

<span data-ttu-id="a0b7a-141">Essa abordagem não apenas resolve o problema original (como a consulta e junção em microservices); Isso também melhora o desempenho consideravelmente em comparação com uma junção complexa, porque você já tem os dados que o aplicativo precisa na tabela de consulta.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-141">This approach not only solves the original problem (how to query and join across microservices); it also improves performance considerably when compared with a complex join, because you already have the data that the application needs in the query table.</span></span> <span data-ttu-id="a0b7a-142">É claro que, usando o comando e consulta responsabilidade CQRS (segregação) com tabelas de consulta/leituras significa o trabalho de desenvolvimento adicional e você precisará adotar consistência eventual.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-142">Of course, using Command and Query Responsibility Segregation (CQRS) with query/reads tables means additional development work, and you will need to embrace eventual consistency.</span></span> <span data-ttu-id="a0b7a-143">No entanto, requisitos de desempenho e alta escalabilidade em [cenários de colaboração](http://udidahan.com/2011/10/02/why-you-should-be-using-cqrs-almost-everywhere/) (ou cenários de concorrência, dependendo do ponto de Vista) é onde você deve aplicar CQRS com vários bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-143">Nonetheless, requirements on performance and high scalability in [collaborative scenarios](http://udidahan.com/2011/10/02/why-you-should-be-using-cqrs-almost-everywhere/) (or competitive scenarios, depending on the point of view) is where you should apply CQRS with multiple databases.</span></span>

<span data-ttu-id="a0b7a-144">**"Dados frios" em bancos de dados centrais**.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-144">**“Cold data” in central databases**.</span></span> <span data-ttu-id="a0b7a-145">Para relatórios complexos e consultas que podem não exigir dados em tempo real, uma abordagem comum é exportar o "hot dados" (dados transacionais do microservices) como "dados frios" para grandes bancos de dados que são usados somente para relatórios.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-145">For complex reports and queries that might not require real-time data, a common approach is to export your “hot data” (transactional data from the microservices) as “cold data” into large databases that are used only for reporting.</span></span> <span data-ttu-id="a0b7a-146">Esse sistema de banco de dados central pode ser um sistema baseado em Big Data, como Hadoop, um data warehouse como com base no Azure SQL Data Warehouse, ou até mesmo um único banco de dados SQL usados apenas para relatórios (se o tamanho não será um problema).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-146">That central database system can be a Big Data-based system, like Hadoop, a data warehouse like one based on Azure SQL Data Warehouse, or even a single SQL database used just for reports (if size will not be an issue).</span></span>

<span data-ttu-id="a0b7a-147">Tenha em mente que este banco de dados centralizado deve ser usado somente para consultas e relatórios que não precisam de dados em tempo real.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-147">Keep in mind that this centralized database would be used only for queries and reports that do not need real-time data.</span></span> <span data-ttu-id="a0b7a-148">As atualizações de original e transações, como a fonte de verdade, precisam ser em seus dados microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-148">The original updates and transactions, as your source of truth, have to be in your microservices data.</span></span> <span data-ttu-id="a0b7a-149">A maneira como você sincronizarão os dados seriam usando comunicação controlada por evento (abordada nas próximas seções) ou usando outras ferramentas de importação/exportação de infraestrutura de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-149">The way you would synchronize data would be either by using event-driven communication (covered in the next sections) or by using other database infrastructure import/export tools.</span></span> <span data-ttu-id="a0b7a-150">Se você usar a comunicação controlada por evento, esse processo de integração seria semelhante à forma como você propagar os dados conforme descrito anteriormente para consultar tabelas de CQRS.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-150">If you use event-driven communication, that integration process would be similar to the way you propagate data as described earlier for CQRS query tables.</span></span>

<span data-ttu-id="a0b7a-151">No entanto, se o design do aplicativo envolve constantemente agregar informações de vários microservices para consultas complexas, pode ser um sintoma de um design ruim — um microsserviço deve ser isolado como possível de outros microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-151">However, if your application design involves constantly aggregating information from multiple microservices for complex queries, it might be a symptom of a bad design—a microservice should be as isolated as possible from other microservices.</span></span> <span data-ttu-id="a0b7a-152">(Isso exclui relatórios/analytics que sempre devem usar bancos de dados centrais de dados a frio). Com esse problema geralmente pode ser um motivo para mesclar microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-152">(This excludes reports/analytics that always should use cold-data central databases.) Having this problem often might be a reason to merge microservices.</span></span> <span data-ttu-id="a0b7a-153">Você precisa equilibrar a autonomia de evolução e a implantação de cada microsserviço com dependências fortes, coesão e agregação de dados.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-153">You need to balance the autonomy of evolution and deployment of each microservice with strong dependencies, cohesion, and data aggregation.</span></span>

## <a name="challenge-3-how-to-achieve-consistency-across-multiple-microservices"></a><span data-ttu-id="a0b7a-154">Desafio \#3: como obter consistência em vários microservices</span><span class="sxs-lookup"><span data-stu-id="a0b7a-154">Challenge \#3: How to achieve consistency across multiple microservices</span></span>

<span data-ttu-id="a0b7a-155">Como mencionado anteriormente, os dados de cada microsserviço é privados que microsserviço e só podem ser acessados usando o API microsserviço.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-155">As stated previously, the data owned by each microservice is private to that microservice and can only be accessed using its microservice API.</span></span> <span data-ttu-id="a0b7a-156">Portanto, um desafio apresentado é como implementar processos de negócios de ponta a ponta, mantendo a consistência entre várias microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-156">Therefore, a challenge presented is how to implement end-to-end business processes while keeping consistency across multiple microservices.</span></span>

<span data-ttu-id="a0b7a-157">Para analisar o problema, vamos examinar um exemplo da [eShopOnContainers Referência aplicativo](http://aka.ms/eshoponcontainers).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-157">To analyze this problem, let’s look at an example from the [eShopOnContainers reference application](http://aka.ms/eshoponcontainers).</span></span> <span data-ttu-id="a0b7a-158">O catálogo microsserviço mantém informações sobre todos os produtos, inclusive o nível de estoque.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-158">The Catalog microservice maintains information about all the products, including their stock level.</span></span> <span data-ttu-id="a0b7a-159">O ordenação microsserviço gerencia pedidos e deve verificar que um novo pedido não exceda o estoque de produtos disponíveis do catálogo.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-159">The Ordering microservice manages orders and must verify that a new order does not exceed the available catalog product stock.</span></span> <span data-ttu-id="a0b7a-160">(Ou o cenário pode envolver a lógica que trata os produtos pendente). Em uma versão monolítica hipotética deste aplicativo, o subsistema de ordenação pode simplesmente usar uma transação ACID para verificar o estoque disponível, criar a ordem na tabela Orders e atualizar o estoque disponível na tabela de produtos.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-160">(Or the scenario might involve logic that handles backordered products.) In a hypothetical monolithic version of this application, the ordering subsystem could simply use an ACID transaction to check the available stock, create the order in the Orders table, and update the available stock in the Products table.</span></span>

<span data-ttu-id="a0b7a-161">No entanto, em um aplicativo baseados em microservices, tabelas Order e produto pertencem a seus respectivos microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-161">However, in a microservices- based application, the Order and Product tables are owned by their respective microservices.</span></span> <span data-ttu-id="a0b7a-162">Nenhum microsserviço já deve incluir bancos de dados pertencentes a outro microsserviço em suas próprias transações ou consultas, conforme mostrado na Figura 4-9.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-162">No microservice should ever include databases owned by another microservice in its own transactions or queries, as shown in Figure 4-9.</span></span>

![](./media/image9.PNG)

<span data-ttu-id="a0b7a-163">**Figura 4-9**.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-163">**Figure 4-9**.</span></span> <span data-ttu-id="a0b7a-164">Um microsserviço não pode acessar diretamente uma tabela em outro microsserviço</span><span class="sxs-lookup"><span data-stu-id="a0b7a-164">A microservice cannot directly access a table in another microservice</span></span>

<span data-ttu-id="a0b7a-165">O ordenação de microsserviço não deve atualizar a tabela de produtos diretamente, porque a tabela de produtos é de propriedade de microsserviço o catálogo.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-165">The Ordering microservice should not update the Products table directly, because the Products table is owned by the Catalog microservice.</span></span> <span data-ttu-id="a0b7a-166">Para fazer uma atualização para o catálogo de microsserviço, microsserviço a ordenação só deve usar a comunicação assíncrona, como eventos de integração (mensagem e comunicação baseada em evento).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-166">To make an update to the Catalog microservice, the Ordering microservice should only ever use asynchronous communication such as integration events (message and event-based communication).</span></span> <span data-ttu-id="a0b7a-167">Isso é como o [eShopOnContainers](http://aka.ms/eshoponcontainers) referência aplicativo executa esse tipo de atualização.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-167">This is how the [eShopOnContainers](http://aka.ms/eshoponcontainers) reference application performs this type of update.</span></span>

<span data-ttu-id="a0b7a-168">Conforme indicado pelo [Teorema de CAP](https://en.wikipedia.org/wiki/CAP_theorem), é necessário escolher entre disponibilidade e ACID consistência forte.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-168">As stated by the [CAP theorem](https://en.wikipedia.org/wiki/CAP_theorem), you need to choose between availability and ACID strong consistency.</span></span> <span data-ttu-id="a0b7a-169">Maioria dos cenários de microsserviço exigem alta escalabilidade em vez de consistência forte e disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-169">Most microservice-based scenarios demand availability and high scalability as opposed to strong consistency.</span></span> <span data-ttu-id="a0b7a-170">Aplicativos de missão crítica devem permanecer para cima e em execução e os desenvolvedores podem contornar consistência forte usando técnicas para trabalhar com consistência eventual ou fraca.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-170">Mission-critical applications must remain up and running, and developers can work around strong consistency by using techniques for working with weak or eventual consistency.</span></span> <span data-ttu-id="a0b7a-171">Essa é a abordagem usada pela maioria das arquiteturas de microsserviço.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-171">This is the approach taken by most microservice-based architectures.</span></span>

<span data-ttu-id="a0b7a-172">Além disso, o estilo ACID ou transações de confirmação de duas fases não são apenas em relação a princípios microservices; a maioria dos bancos de dados SQL (como o banco de dados do Azure Cosmos, MongoDB, etc.) não dão suporte a transações de confirmação de duas fases.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-172">Moreover, ACID-style or two-phase commit transactions are not just against microservices principles; most NoSQL databases (like Azure Cosmos DB, MongoDB, etc.) do not support two-phase commit transactions.</span></span> <span data-ttu-id="a0b7a-173">No entanto, manter dados de consistência em serviços e bancos de dados é essencial.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-173">However, maintaining data consistency across services and databases is essential.</span></span> <span data-ttu-id="a0b7a-174">Esse desafio também está relacionado à pergunta de como propagar alterações em várias microservices quando determinados dados precisam ser redundante — por exemplo, quando você precisa ter o nome ou a descrição em microsserviço o catálogo e o carrinho do produto microsserviço.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-174">This challenge is also related to the question of how to propagate changes across multiple microservices when certain data needs to be redundant—for example, when you need to have the product’s name or description in the Catalog microservice and the Basket microservice.</span></span>

<span data-ttu-id="a0b7a-175">Uma boa solução para esse problema é usar consistência eventual entre microservices articulados por meio de comunicação orientada a eventos e um sistema de publicação e assinatura.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-175">A good solution for this problem is to use eventual consistency between microservices articulated through event-driven communication and a publish-and-subscribe system.</span></span> <span data-ttu-id="a0b7a-176">Esses tópicos são abordados na seção [comunicação assíncrona controlada por evento](#async_event_driven_communication) posteriormente neste guia.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-176">These topics are covered in the section [Asynchronous event-driven communication](#async_event_driven_communication) later in this guide.</span></span>

## <a name="challenge-4-how-to-design-communication-across-microservice-boundaries"></a><span data-ttu-id="a0b7a-177">Desafio \#4: como criar a comunicação entre os limites de microsserviço</span><span class="sxs-lookup"><span data-stu-id="a0b7a-177">Challenge \#4: How to design communication across microservice boundaries</span></span>

<span data-ttu-id="a0b7a-178">Limites de se comunicar pela microsserviço é um desafio real.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-178">Communicating across microservice boundaries is a real challenge.</span></span> <span data-ttu-id="a0b7a-179">Nesse contexto, comunicação não se refere ao protocolo ao qual você deve usar (HTTP e REST, AMQP, mensagens e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-179">In this context, communication does not refer to what protocol you should use (HTTP and REST, AMQP, messaging, and so on).</span></span> <span data-ttu-id="a0b7a-180">Em vez disso, aborda o estilo de comunicação, você deve usar, e especialmente o microservices como acopladas deve ser.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-180">Instead, it addresses what communication style you should use, and especially how coupled your microservices should be.</span></span> <span data-ttu-id="a0b7a-181">Dependendo do nível de acoplamento, quando ocorre falha, o impacto dessa falha em seu sistema variam significativamente.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-181">Depending on the level of coupling, when failure occurs, the impact of that failure on your system will vary significantly.</span></span>

<span data-ttu-id="a0b7a-182">Em um sistema distribuído como um aplicativo baseado em microservices, com muitos artefatos de movimentação e serviços distribuídos em vários servidores ou hosts, componentes eventualmente falhará.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-182">In a distributed system like a microservices-based application, with so many artifacts moving around and with distributed services across many servers or hosts, components will eventually fail.</span></span> <span data-ttu-id="a0b7a-183">Falha parcial e falhas ainda maiores ocorrerá, portanto você precisa para projetar seu microservices e a comunicação entre eles levando em conta os riscos comum nesse tipo de sistema distribuído.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-183">Partial failure and even larger outages will occur, so you need to design your microservices and the communication across them taking into account the risks common in this type of distributed system.</span></span>

<span data-ttu-id="a0b7a-184">É um método popular implementar o HTTP (REST)-com base em microservices, devido à sua simplicidade.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-184">A popular approach is to implement HTTP (REST)- based microservices, due to their simplicity.</span></span> <span data-ttu-id="a0b7a-185">Uma abordagem baseada em HTTP é perfeitamente aceitável; aqui, o problema está relacionado à maneira como você usa.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-185">An HTTP-based approach is perfectly acceptable; the issue here is related to how you use it.</span></span> <span data-ttu-id="a0b7a-186">Se você usar solicitações e respostas HTTP para interagir com seu microservices de aplicativos cliente ou de Gateways de API, que é bom.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-186">If you use HTTP requests and responses just to interact with your microservices from client applications or from API Gateways, that is fine.</span></span> <span data-ttu-id="a0b7a-187">Mas, se você criar longas cadeias de chamadas HTTP síncronas em microservices, comunicação seus limites, como se o microservices foram objetos em um aplicativo monolítico, seu aplicativo serão eventualmente tiver problemas.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-187">But if you create long chains of synchronous HTTP calls across microservices, communicating across their boundaries as if the microservices were objects in a monolithic application, your application will eventually run into problems.</span></span>

<span data-ttu-id="a0b7a-188">Por exemplo, imagine que o aplicativo cliente faz uma chamada de API HTTP para um microsserviço individual como o ordenação de microsserviço.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-188">For instance, imagine that your client application makes an HTTP API call to an individual microservice like the Ordering microservice.</span></span> <span data-ttu-id="a0b7a-189">Se o microsserviço de ordenação por sua vez chama adicional microservices usando HTTP na mesma solicitação/resposta ciclo, você está criando uma cadeia de chamadas HTTP.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-189">If the Ordering microservice in turn calls additional microservices using HTTP within the same request/response cycle, you are creating a chain of HTTP calls.</span></span> <span data-ttu-id="a0b7a-190">Parece razoável inicialmente.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-190">It might sound reasonable initially.</span></span> <span data-ttu-id="a0b7a-191">No entanto, existem pontos importantes a considerar quando este caminho:</span><span class="sxs-lookup"><span data-stu-id="a0b7a-191">However, there are important points to consider when going down this path:</span></span>

-   <span data-ttu-id="a0b7a-192">Bloqueio e baixo desempenho.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-192">Blocking and low performance.</span></span> <span data-ttu-id="a0b7a-193">Devido à natureza síncrona de HTTP, a solicitação original não obterá uma resposta até que todas as chamadas HTTP internas sejam concluídas.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-193">Due to the synchronous nature of HTTP, the original request will not get a response until all the internal HTTP calls are finished.</span></span> <span data-ttu-id="a0b7a-194">Imagine se o número dessas chamadas aumenta significativamente e ao mesmo tempo um intermediário HTTP chamadas para um microsserviço está bloqueado.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-194">Imagine if the number of these calls increases significantly and at the same time one of the intermediate HTTP calls to a microservice is blocked.</span></span> <span data-ttu-id="a0b7a-195">O resultado é que o desempenho é afetado, e a escalabilidade geral será afetada exponencialmente como um aumento adicional de solicitações HTTP.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-195">The result is that performance is impacted, and the overall scalability will be exponentially affected as additional HTTP requests increase.</span></span>

-   <span data-ttu-id="a0b7a-196">Acoplamento microservices com HTTP.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-196">Coupling microservices with HTTP.</span></span> <span data-ttu-id="a0b7a-197">Business microservices não deve ser combinado com outros microservices de negócios.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-197">Business microservices should not be coupled with other business microservices.</span></span> <span data-ttu-id="a0b7a-198">Idealmente, eles devem "conhece" a existência de outros microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-198">Ideally, they should not “know” about the existence of other microservices.</span></span> <span data-ttu-id="a0b7a-199">Se seu aplicativo depende de acoplamento microservices como no exemplo, para alcançar a autonomia por microsserviço será praticamente impossível.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-199">If your application relies on coupling microservices as in the example, achieving autonomy per microservice will be almost impossible.</span></span>

-   <span data-ttu-id="a0b7a-200">Falha em qualquer um microsserviço.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-200">Failure in any one microservice.</span></span> <span data-ttu-id="a0b7a-201">Se você implementou uma cadeia de microservices vinculadas por chamadas HTTP, quando qualquer uma da microservices falha (e, eventualmente, eles falharão) toda a cadeia de microservices falhará.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-201">If you implemented a chain of microservices linked by HTTP calls, when any of the microservices fails (and eventually they will fail) the whole chain of microservices will fail.</span></span> <span data-ttu-id="a0b7a-202">Um sistema baseado em microsserviço deve ser criado para continuar a trabalhar, bem como possíveis durante falhas parciais.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-202">A microservice-based system should be designed to continue to work as well as possible during partial failures.</span></span> <span data-ttu-id="a0b7a-203">Mesmo se você implementar a lógica do cliente que usa novas tentativas com retirada exponencial ou mecanismos de Disjuntor, as cadeias de chamada mais complexos HTTP são, mais complexo, ele é implementar uma estratégia de falha com base em HTTP.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-203">Even if you implement client logic that uses retries with exponential backoff or circuit breaker mechanisms, the more complex the HTTP call chains are, the more complex it is implement a failure strategy based on HTTP.</span></span>

<span data-ttu-id="a0b7a-204">Na verdade, se seu microservices internos estão se comunicando por meio da criação de cadeias de solicitações HTTP conforme descrito, poderíamos argumentar que você tenha um aplicativo monolítico, mas um com base em HTTP entre processos em vez de mecanismos de comunicação intraprocess.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-204">In fact, if your internal microservices are communicating by creating chains of HTTP requests as described, it could be argued that you have a monolithic application, but one based on HTTP between processes instead of intraprocess communication mechanisms.</span></span>

<span data-ttu-id="a0b7a-205">Portanto, para impor a autonomia de microsserviço e ter melhor resiliência, você deve minimizar o uso de cadeias de comunicação de solicitação/resposta em microservices.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-205">Therefore, in order to enforce microservice autonomy and have better resiliency, you should minimize the use of chains of request/response communication across microservices.</span></span> <span data-ttu-id="a0b7a-206">É recomendável que você usar interação assíncrona apenas para comunicação de microsserviço inter usando a comunicação assíncrona baseado em evento e à mensagem ou consulta de HTTP, independentemente do ciclo de solicitação/resposta HTTP original.</span><span class="sxs-lookup"><span data-stu-id="a0b7a-206">It is recommended that you use only asynchronous interaction for inter-microservice communication, either by using asynchronous message- and event-based communication, or by using HTTP polling independently of the original HTTP request/response cycle.</span></span>

<span data-ttu-id="a0b7a-207">O uso de comunicação assíncrona é explicado com mais detalhes posteriormente neste guia nas seções a [microsserviço assíncrona integração impõe a autonomia do microsserviço](#asynchronous-microservice-integration-enforce-microservices-autonomy) e [assíncrona comunicação baseada em mensagem](#asynchronous-message-based-communication).</span><span class="sxs-lookup"><span data-stu-id="a0b7a-207">The use of asynchronous communication is explained with additional details later in this guide in the sections [Asynchronous microservice integration enforces microservice’s autonomy](#asynchronous-microservice-integration-enforce-microservices-autonomy) and [Asynchronous message-based communication](#asynchronous-message-based-communication).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="a0b7a-208">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="a0b7a-208">Additional resources</span></span>

-   <span data-ttu-id="a0b7a-209">**Teorema de CAP**
    [*https://en.wikipedia.org/wiki/CAP\_Teorema*](https://en.wikipedia.org/wiki/CAP_theorem)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-209">**CAP theorem**
[*https://en.wikipedia.org/wiki/CAP\_theorem*](https://en.wikipedia.org/wiki/CAP_theorem)</span></span>

-   <span data-ttu-id="a0b7a-210">**Consistência eventual**
    [*https://en.wikipedia.org/wiki/Eventual\_consistência*](https://en.wikipedia.org/wiki/Eventual_consistency)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-210">**Eventual consistency**
[*https://en.wikipedia.org/wiki/Eventual\_consistency*](https://en.wikipedia.org/wiki/Eventual_consistency)</span></span>

-   <span data-ttu-id="a0b7a-211">**Primer de consistência de dados**
    [*https://msdn.microsoft.com/library/dn589800.aspx*](https://msdn.microsoft.com/library/dn589800.aspx)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-211">**Data Consistency Primer**
[*https://msdn.microsoft.com/library/dn589800.aspx*](https://msdn.microsoft.com/library/dn589800.aspx)</span></span>

-   <span data-ttu-id="a0b7a-212">**Martin Fowler. CQRS (comando e segregação de responsabilidade de consulta)**
    [*http://martinfowler.com/bliki/CQRS.html*](http://martinfowler.com/bliki/CQRS.html)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-212">**Martin Fowler. CQRS (Command and Query Responsibility Segregation)**
[*http://martinfowler.com/bliki/CQRS.html*](http://martinfowler.com/bliki/CQRS.html)</span></span>

-   <span data-ttu-id="a0b7a-213">**Materializada exibição**
    [*https://docs.microsoft.com/azure/architecture/patterns/materialized-view*](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-213">**Materialized View**
[*https://docs.microsoft.com/azure/architecture/patterns/materialized-view*](https://docs.microsoft.com/azure/architecture/patterns/materialized-view)</span></span>

-   <span data-ttu-id="a0b7a-214">**Charles linha. ACID vs. BASE: O Shifting pH de processamento de transações do banco de dados**
    [*http://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-processing/*](http://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-processing/)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-214">**Charles Row. ACID vs. BASE: The Shifting pH of Database Transaction Processing**
[*http://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-processing/*](http://www.dataversity.net/acid-vs-base-the-shifting-ph-of-database-transaction-processing/)</span></span>

-   <span data-ttu-id="a0b7a-215">**Transações de compensação**
    [*https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction*](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-215">**Compensating Transaction**
[*https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction*](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction)</span></span>

-   <span data-ttu-id="a0b7a-216">**Udi Dahan. Composição orientada a serviços**
    [*http://udidahan.com/2014/07/30/service-oriented-composition-with-video/*](http://udidahan.com/2014/07/30/service-oriented-composition-with-video/)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-216">**Udi Dahan. Service Oriented Composition**
[*http://udidahan.com/2014/07/30/service-oriented-composition-with-video/*](http://udidahan.com/2014/07/30/service-oriented-composition-with-video/)</span></span>


>[!div class="step-by-step"]
<span data-ttu-id="a0b7a-217">[Anterior] (lógico-versus-físico-architecture.md) [Avançar] (identificar-microsserviço-domínio-modelo-boundaries.md)</span><span class="sxs-lookup"><span data-stu-id="a0b7a-217">[Previous] (logical-versus-physical-architecture.md) [Next] (identify-microservice-domain-model-boundaries.md)</span></span>
