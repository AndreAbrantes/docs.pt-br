---
title: Migrando aplicativos monolíticos herdados do Framework .NET para contêineres do Windows
description: Arquitetura de microsserviços do .NET para aplicativos .NET em contêineres | Migrando aplicativos monolíticos herdados do Framework .NET para contêineres do Windows
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.openlocfilehash: a12012f115629a79734c18c3bc75733ae2fc8195
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/04/2018
ms.locfileid: "33578827"
---
# <a name="migrating-legacy-monolithic-net-framework-applications-to-windows-containers"></a><span data-ttu-id="71170-103">Migrando aplicativos monolíticos herdados do Framework .NET para contêineres do Windows</span><span class="sxs-lookup"><span data-stu-id="71170-103">Migrating Legacy Monolithic .NET Framework Applications to Windows Containers</span></span>

<span data-ttu-id="71170-104">*Os contêineres do Windows podem ser usados como uma maneira de melhorar os ambientes de desenvolvimento e teste e para implantar aplicativos baseados em tecnologias herdadas do .NET Framework como Web* *Forms. Usar contêineres para aplicativos herdados dessa maneira é conhecido como um cenário de "lift-and-shift".*</span><span class="sxs-lookup"><span data-stu-id="71170-104">*Windows Containers can be used as a way to improve development and test environments, and to deploy applications that are based on legacy .NET Framework technologies like Web* *Forms. Using containers for legacy applications in this way is referred to as a “lift and shift” scenario.*</span></span>

<span data-ttu-id="71170-105">As seções anteriores deste guia defenderam uma arquitetura de microsserviços na qual os aplicativos de negócios são distribuídos entre diferentes contêineres, cada um executando um serviço pequeno e concentrado.</span><span class="sxs-lookup"><span data-stu-id="71170-105">Earlier sections of this guide have championed a microservices architecture where business applications are distributed among different containers, each running a small, focused service.</span></span> <span data-ttu-id="71170-106">Essa meta traz muitos benefícios.</span><span class="sxs-lookup"><span data-stu-id="71170-106">That goal has many benefits.</span></span> <span data-ttu-id="71170-107">No novo desenvolvimento, essa abordagem é altamente recomendável.</span><span class="sxs-lookup"><span data-stu-id="71170-107">In new development, that approach is strongly recommended.</span></span> <span data-ttu-id="71170-108">Os aplicativos críticos para a empresa também serão beneficiados o suficiente para justificar o custo de uma nova arquitetura e de uma reimplementação.</span><span class="sxs-lookup"><span data-stu-id="71170-108">Enterprise-critical applications will also benefit enough to justify the cost of a rearchitecture and reimplementation.</span></span>

<span data-ttu-id="71170-109">Mas nem todos os aplicativos serão beneficiados o suficiente para justificar o custo.</span><span class="sxs-lookup"><span data-stu-id="71170-109">But not every application will benefit enough to justify the cost.</span></span> <span data-ttu-id="71170-110">Isso não significa que esses aplicativos não podem ser usados em cenários de contêiner.</span><span class="sxs-lookup"><span data-stu-id="71170-110">That does not mean that those applications cannot be used in container scenarios.</span></span>

<span data-ttu-id="71170-111">Nesta seção, vamos explorar um aplicativo para eShopOnContainers, mostrado na Figura 7-1.</span><span class="sxs-lookup"><span data-stu-id="71170-111">In this section, we will explore an application for eShopOnContainers, shown in Figure 7-1.</span></span> <span data-ttu-id="71170-112">Este aplicativo seria usado por membros da equipe corporativa eShopOnContainers para exibir e editar o catálogo de produtos.</span><span class="sxs-lookup"><span data-stu-id="71170-112">This application would be used by members of the eShopOnContainers enterprise team to view and edit the product catalog.</span></span>

![](./media/image1.png)

<span data-ttu-id="71170-113">**Figura 7-1**.</span><span class="sxs-lookup"><span data-stu-id="71170-113">**Figure 7-1**.</span></span> <span data-ttu-id="71170-114">Aplicativo Web Forms do ASP.NET (tecnologia herdada) em um contêiner do Windows</span><span class="sxs-lookup"><span data-stu-id="71170-114">ASP.NET Web Forms application (legacy technology) on a Windows Container</span></span>

<span data-ttu-id="71170-115">Este é um aplicativo Web Forms usado para navegar e modificar as entradas no catálogo.</span><span class="sxs-lookup"><span data-stu-id="71170-115">This is a Web Forms application that is used to browse and modify the catalog entries.</span></span> <span data-ttu-id="71170-116">A dependência do Web Forms significa que este aplicativo não será executado no .NET Core, a menos que ele seja reescrito sem o Web Forms e use o ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="71170-116">The Web Forms dependency means this application will not run on .NET Core unless it is rewritten without Web Forms and instead uses ASP.NET Core MVC.</span></span> <span data-ttu-id="71170-117">Você verá como é possível executar aplicativos como esses em contêineres sem alterações.</span><span class="sxs-lookup"><span data-stu-id="71170-117">You will see how you can run applications like these in containers without changes.</span></span> <span data-ttu-id="71170-118">Você também verá como é possível fazer alterações mínimas para trabalhar em um modo híbrido, no qual algumas funcionalidades são movidas para um microsserviço separado, mas a maior parte das funcionalidades permanece no aplicativo monolítico.</span><span class="sxs-lookup"><span data-stu-id="71170-118">You will also see how you can make minimal changes to work in a hybrid mode where some functionality has been moved into a separate microservice, but most functionality remains in the monolithic application.</span></span>

## <a name="benefits-of-containerizing-a-monolithic-application"></a><span data-ttu-id="71170-119">Benefícios de inserir um aplicativo monolítico em contêineres</span><span class="sxs-lookup"><span data-stu-id="71170-119">Benefits of containerizing a monolithic application</span></span>

<span data-ttu-id="71170-120">O aplicativo Catalog.WebForms está disponível no repositório eShopOnContainers do GitHub (<https://github.com/dotnet/eShopOnContainers>).</span><span class="sxs-lookup"><span data-stu-id="71170-120">The Catalog.WebForms application is available in the eShopOnContainers GitHub repository (<https://github.com/dotnet/eShopOnContainers>).</span></span> <span data-ttu-id="71170-121">Este aplicativo é um aplicativo Web autônomo que acessa um armazenamento de dados de alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="71170-121">This application is a standalone web application accessing a high-availability data store.</span></span> <span data-ttu-id="71170-122">Mesmo assim, há vantagens de executar o aplicativo em um contêiner.</span><span class="sxs-lookup"><span data-stu-id="71170-122">Even so, there are advantages to running the application in a container.</span></span> <span data-ttu-id="71170-123">Você cria uma imagem para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="71170-123">You create an image for the application.</span></span> <span data-ttu-id="71170-124">A partir desse ponto, cada implantação é executada no mesmo ambiente.</span><span class="sxs-lookup"><span data-stu-id="71170-124">From that point forward, every deployment runs in the same environment.</span></span> <span data-ttu-id="71170-125">Cada contêiner usa a mesma versão do sistema operacional, tem a mesma versão das dependências instaladas, usa a mesma estrutura e é criado usando o mesmo processo.</span><span class="sxs-lookup"><span data-stu-id="71170-125">Every container uses the same OS version, has the same version of dependencies installed, uses the same framework, and is built using the same process.</span></span> <span data-ttu-id="71170-126">Veja o aplicativo carregado no Visual Studio 2017 na Figura 7-2.</span><span class="sxs-lookup"><span data-stu-id="71170-126">You can see the application loaded in Visual Studio 2017 in Figure 7-2.</span></span>

![](./media/image2.png)

<span data-ttu-id="71170-127">**Figura 7-2**.</span><span class="sxs-lookup"><span data-stu-id="71170-127">**Figure 7-2**.</span></span> <span data-ttu-id="71170-128">Aplicativo Web Forms de gerenciamento de catálogo no Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="71170-128">Catalog management Web Forms application in Visual Studio 2017</span></span>

<span data-ttu-id="71170-129">Além disso, os desenvolvedores podem executar o aplicativo nesse ambiente consistente.</span><span class="sxs-lookup"><span data-stu-id="71170-129">In addition, developers can all run the application in this consistent environment.</span></span> <span data-ttu-id="71170-130">Os problemas que só aparecem com determinadas versões aparecerão imediatamente para os desenvolvedores em vez de surgirem em um ambiente de preparo ou de produção.</span><span class="sxs-lookup"><span data-stu-id="71170-130">Issues that only appear with certain versions will appear immediately for developers rather than surfacing in a staging or production environment.</span></span> <span data-ttu-id="71170-131">As diferenças entre os ambientes de desenvolvimento entre a equipe de desenvolvimento perdem importância quando os aplicativos passam a ser executados em contêineres.</span><span class="sxs-lookup"><span data-stu-id="71170-131">Differences between the development environments among the development team matter less once applications run in containers.</span></span>

<span data-ttu-id="71170-132">Finalmente, os aplicativos em contêineres têm uma curva de escala horizontal mais simples.</span><span class="sxs-lookup"><span data-stu-id="71170-132">Finally, containerized applications have a flatter scale-out curve.</span></span> <span data-ttu-id="71170-133">Você já aprendeu como os aplicativos em contêineres permitem mais contêineres em uma VM ou em um computador físico.</span><span class="sxs-lookup"><span data-stu-id="71170-133">You have learned how containerized apps enable more containers in a VM or more containers in a physical machine.</span></span> <span data-ttu-id="71170-134">Isso resulta em maior densidade e menos necessários recursos.</span><span class="sxs-lookup"><span data-stu-id="71170-134">This translates to higher density and fewer required resources.</span></span>

<span data-ttu-id="71170-135">Por esses motivos, considere a possibilidade de executar aplicativos monolíticos herdados em um contêiner de Docker usando uma operação “lift-and-shift”.</span><span class="sxs-lookup"><span data-stu-id="71170-135">For all these reasons, consider running legacy monolithic apps in a Docker container using a “lift-and-shift” operation.</span></span> <span data-ttu-id="71170-136">A frase “lift-and-shift” descreve o escopo da tarefa: você *levanta* todo o aplicativo de um computador físico ou máquina virtual e *coloca-o* em um contêiner.</span><span class="sxs-lookup"><span data-stu-id="71170-136">The phrase “lift and shift” describes the scope of the task: you *lift* the entire application from a physical or virtual machine, and *shift* it into a container.</span></span> <span data-ttu-id="71170-137">Em situações ideais, não é necessário alterar o código do aplicativo para executá-lo em um contêiner.</span><span class="sxs-lookup"><span data-stu-id="71170-137">In ideal situations, you do not need to make any changes to the application code to run it in a container.</span></span>

## <a name="possible-migration-paths"></a><span data-ttu-id="71170-138">Caminhos de migração possíveis</span><span class="sxs-lookup"><span data-stu-id="71170-138">Possible migration paths</span></span>

<span data-ttu-id="71170-139">Como um aplicativo monolítico, o aplicativo Catalog.Webforms é um único aplicativo Web que contém todo o código, incluindo as bibliotecas de acesso a dados.</span><span class="sxs-lookup"><span data-stu-id="71170-139">As a monolithic application, the Catalog.Webforms application is one web application containing all the code, including the data access libraries.</span></span> <span data-ttu-id="71170-140">O banco de dados é executado em um computador separado de alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="71170-140">The database runs on a separate high-availability machine.</span></span> <span data-ttu-id="71170-141">Essa configuração é simulada no código de exemplo, usando um serviço de catálogo fictício: você pode executar o aplicativo Catalog.WebForms com esses dados falsos para simular um cenário de lift-and-shift simples.</span><span class="sxs-lookup"><span data-stu-id="71170-141">That configuration is simulated in the sample code by using a mock catalog service: you can run the Catalog.WebForms application against that fake data to simulate a pure lift-and-shift scenario.</span></span> <span data-ttu-id="71170-142">Isso demonstra o caminho de migração mais simples, no qual você move os ativos existentes para serem executados em um contêiner sem nenhuma alteração de código.</span><span class="sxs-lookup"><span data-stu-id="71170-142">This demonstrates the simplest migration path, where you move existing assets to run in a container without any code changes at all.</span></span> <span data-ttu-id="71170-143">Esse caminho é adequado para aplicativos que estão completos e que têm uma interação mínima com a funcionalidade que você está movendo para microsserviços.</span><span class="sxs-lookup"><span data-stu-id="71170-143">This path is appropriate for applications that are complete and that have minimal interaction with functionality that you are moving to microservices.</span></span>

<span data-ttu-id="71170-144">No entanto, o site eShopOnContainers já está acessando o armazenamento de dados usando microsserviços para cenários diferentes.</span><span class="sxs-lookup"><span data-stu-id="71170-144">However, the eShopOnContainers website is already accessing the data storage using microservices for different scenarios.</span></span> <span data-ttu-id="71170-145">Podem ser feitas algumas pequenas alterações adicionais no editor de catálogo para aproveitar o microsserviço de catálogo em vez de acessar o armazenamento de dados de catálogo diretamente.</span><span class="sxs-lookup"><span data-stu-id="71170-145">Some small additional changes can be made to the catalog editor to leverage the catalog microservice instead of accessing the catalog data storage directly.</span></span>

<span data-ttu-id="71170-146">Essas alterações demonstram a continuidade para seus próprios aplicativos.</span><span class="sxs-lookup"><span data-stu-id="71170-146">These changes demonstrate the continuum for your own applications.</span></span> <span data-ttu-id="71170-147">Você pode fazer qualquer coisa como colocar em contêineres um aplicativo existente sem alteração, fazer pequenas alterações para permitir que os aplicativos existentes acessem alguns dos novos microsserviços e reescrever completamente um aplicativo para participar totalmente de uma nova arquitetura baseada em microsserviço.</span><span class="sxs-lookup"><span data-stu-id="71170-147">You can do anything from moving an existing application without change into containers, to making small changes that enable existing applications to access some of the new microservices, to completely rewriting an application to fully participate in a new microservice-based architecture.</span></span> <span data-ttu-id="71170-148">O caminho certo depende do custo de migração e dos benefícios da migração.</span><span class="sxs-lookup"><span data-stu-id="71170-148">The right path depends on both the cost of the migration and the benefits from any migration.</span></span>

## <a name="application-tour"></a><span data-ttu-id="71170-149">Tour do aplicativo</span><span class="sxs-lookup"><span data-stu-id="71170-149">Application tour</span></span>

<span data-ttu-id="71170-150">Você pode carregar a solução Catalog.WebForms e executar o aplicativo como um aplicativo autônomo.</span><span class="sxs-lookup"><span data-stu-id="71170-150">You can load the Catalog.WebForms solution and run the application as a standalone application.</span></span> <span data-ttu-id="71170-151">Nessa configuração, em vez de um banco de dados do armazenamento persistente, o aplicativo usa um serviço fictício para retornar dados.</span><span class="sxs-lookup"><span data-stu-id="71170-151">In this configuration, instead of a persistent storage database, the application uses a fake service to return data.</span></span> <span data-ttu-id="71170-152">O aplicativo usa o Autofac (<https://autofac.org/>) como um contêiner de IOC (inversão de controle).</span><span class="sxs-lookup"><span data-stu-id="71170-152">The application uses Autofac (<https://autofac.org/>) as an inversion of control (IOC) container.</span></span> <span data-ttu-id="71170-153">Usando a DI (injeção de dependência), você pode configurar o aplicativo para usar os dados fictícios ou o serviço de dados de catálogo ativo.</span><span class="sxs-lookup"><span data-stu-id="71170-153">Using Dependency Injection (DI), you can configure the application to use the fake data or the live catalog data service.</span></span> <span data-ttu-id="71170-154">(Explicaremos mais sobre a DI em breve.) O código de inicialização lê uma configuração de useFake dos arquivos web.config e configura o contêiner Autofac para injetar o serviço de dados fictícios ou o serviço de catálogo ativo.</span><span class="sxs-lookup"><span data-stu-id="71170-154">(We will explain more about DI shortly.) The startup code reads a useFake setting from the web.config files, and configures the Autofac container to inject either the fake data service or the live catalog service.</span></span> <span data-ttu-id="71170-155">Ao executar o aplicativo com useFake definido como false no arquivo web.config, você verá o aplicativo Web Forms exibindo os dados do catálogo.</span><span class="sxs-lookup"><span data-stu-id="71170-155">If you run the application with useFake set to false in the web.config file, you see the Web Forms application displaying the catalog data.</span></span>

<span data-ttu-id="71170-156">A maioria das técnicas usadas neste aplicativo é muito familiar para qualquer pessoa que já tenha usado o Web Forms.</span><span class="sxs-lookup"><span data-stu-id="71170-156">Most of the techniques used in this application should be very familiar to anyone who has used Web Forms.</span></span> <span data-ttu-id="71170-157">No entanto, o microsserviço de catálogo apresenta duas técnicas que podem não ser familiares: a DI (injeção de dependência), já mencionada anteriormente e o trabalho com armazenamentos de dados assíncronos no Web Forms.</span><span class="sxs-lookup"><span data-stu-id="71170-157">However, the catalog microservice introduces two techniques that might be unfamiliar: Dependency Injection (DI), which was mentioned earlier, and working with asynchronous data stores in Web Forms.</span></span>

<span data-ttu-id="71170-158">A DI inverte a estratégia controlada por objeto típica de escrever classes que alocam todos os recursos necessários.</span><span class="sxs-lookup"><span data-stu-id="71170-158">DI inverts the typical object-oriented strategy of writing classes that allocate all needed resources.</span></span> <span data-ttu-id="71170-159">Em vez disso, as classes solicitam suas dependências de um contêiner de serviço.</span><span class="sxs-lookup"><span data-stu-id="71170-159">Instead, classes request their dependencies from a service container.</span></span> <span data-ttu-id="71170-160">A vantagem da DI é que você pode substituir a serviços externos por elementos fictícios (simulações) para dar suporte a ambientes de teste ou outros.</span><span class="sxs-lookup"><span data-stu-id="71170-160">The advantage of DI is that you can replace external services with fakes (mocks) to support testing or other environments.</span></span>

<span data-ttu-id="71170-161">O contêiner de DI usa a configuração appSettings do web.config para controlar se deseja usar os dados do catálogo fictícios ou os dados ativos do serviço em execução.</span><span class="sxs-lookup"><span data-stu-id="71170-161">The DI container uses the web.config appSettings configuration to control whether to use the fake catalog data or the live data from the running service.</span></span> <span data-ttu-id="71170-162">O aplicativo registra um objeto HttpModule que cria o contêiner e registra um manipulador de pré-solicitação para injetar dependências.</span><span class="sxs-lookup"><span data-stu-id="71170-162">The application registers an HttpModule object that builds the container and registers a pre-request handler to inject dependencies.</span></span> <span data-ttu-id="71170-163">Você pode ver esse código no arquivo Modules/AutoFacHttpModule.cs, que é semelhante ao exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="71170-163">You can see that code in the Modules/AutoFacHttpModule.cs file, which looks like the following example:</span></span>

```cs
private static IContainer CreateContainer()
{
  // Configure AutoFac:
  // Register Containers:

  var settings = WebConfigurationManager.AppSettings;
  var useFake = settings["usefake"];
  bool fake = useFake == "true";
  var builder = new ContainerBuilder();

  if (fake)
  {
    builder.RegisterType<CatalogMockService>()
    .As<ICatalogService>();
  }
  else
  {
    builder.RegisterType<CatalogService>()
    .As<ICatalogService>();
    builder.RegisterType<RequestProvider>()
    .As<IRequestProvider>();
  }

  var container = builder.Build();
  return container;
}

private void InjectDependencies()
{
  if (HttpContext.Current.CurrentHandler is Page page)
  {
    // Get the code-behind class that we may have written
    var pageType = page.GetType().BaseType;

    // Determine if there is a constructor to inject, and grab it
    var ctor = (from c in pageType.GetConstructors()
                where c.GetParameters().Length > 0
                select c).FirstOrDefault();

    if (ctor != null)
    {
      // Resolve the parameters for the constructor
      var args = (from parm in ctor.GetParameters()
                  select Container.Resolve(parm.ParameterType))
                  .ToArray();

      // Execute the constructor method with the arguments resolved
      ctor.Invoke(page, args);
    }

    // Use the Autofac method to inject any
    // properties that can be filled by Autofac
    Container.InjectProperties(page);
  }
}
```

<span data-ttu-id="71170-164">As páginas do aplicativo (Default.aspx.cs e EditPage.aspx.cs) definem os construtores que usam essas dependências.</span><span class="sxs-lookup"><span data-stu-id="71170-164">The application’s pages (Default.aspx.cs and EditPage.aspx.cs) define constructors that take these dependencies.</span></span> <span data-ttu-id="71170-165">Observe que o construtor padrão ainda está presente e acessível.</span><span class="sxs-lookup"><span data-stu-id="71170-165">Note that the default constructor is still present and accessible.</span></span> <span data-ttu-id="71170-166">A infraestrutura precisa do código a seguir.</span><span class="sxs-lookup"><span data-stu-id="71170-166">The infrastructure needs the following code.</span></span>

```cs
protected _Default() { }

public _Default(ICatalogService catalog) => this.catalog = catalog;
```

<span data-ttu-id="71170-167">As APIs de catálogo são métodos assíncronos.</span><span class="sxs-lookup"><span data-stu-id="71170-167">The catalog APIs are all asynchronous methods.</span></span> <span data-ttu-id="71170-168">Agora o Web Forms dá suporte para todos os controles de dados.</span><span class="sxs-lookup"><span data-stu-id="71170-168">Web Forms now supports these for all data controls.</span></span> <span data-ttu-id="71170-169">O aplicativo Catalog.WebForms usa associação de modelos para as páginas de lista e de edição. Os controles nas páginas definem as propriedades UpdateMethod, SelectMethod, InsertMethod e DeleteMethod que especificam operações assíncronas de retorno de tarefa.</span><span class="sxs-lookup"><span data-stu-id="71170-169">The Catalog.WebForms application uses model binding for the list and edit pages; controls on the pages define SelectMethod, UpdateMethod, InsertMethod, and DeleteMethod properties that specify Task-returning asynchronous operations.</span></span> <span data-ttu-id="71170-170">Os controles do Web Forms entendem quando os métodos associados a um controle são assíncronos.</span><span class="sxs-lookup"><span data-stu-id="71170-170">Web Forms controls understand when the methods bound to a control are asynchronous.</span></span> <span data-ttu-id="71170-171">A única restrição encontrada ao usar os métodos de seleção assíncronos é que não há suporte para paginação.</span><span class="sxs-lookup"><span data-stu-id="71170-171">The only restriction you encounter when using asynchronous select methods is that you cannot support paging.</span></span> <span data-ttu-id="71170-172">A assinatura de paginação requer um parâmetro de saída e os métodos assíncronos não podem ter parâmetros de saída.</span><span class="sxs-lookup"><span data-stu-id="71170-172">The paging signature requires an out parameter, and asynchronous methods cannot have out parameters.</span></span> <span data-ttu-id="71170-173">Essa mesma técnica é usada em outras páginas que exigem dados do serviço de catálogo.</span><span class="sxs-lookup"><span data-stu-id="71170-173">This same technique is used on other pages that require data from the catalog service.</span></span>

<span data-ttu-id="71170-174">A configuração padrão para aplicativos Web Forms de catálogo usa uma implementação fictícia do serviço catalog.api.</span><span class="sxs-lookup"><span data-stu-id="71170-174">The default configuration for the catalog Web Forms application uses a mock implementation of the catalog.api service.</span></span> <span data-ttu-id="71170-175">Essa implementação fictícia usa um conjunto de dados embutido em código para seus dados, o que simplifica algumas tarefas por remover a dependência do serviço catalog.api em ambientes de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="71170-175">This mock uses a hard-coded dataset for its data, which simplifies some tasks by removing the dependency on the catalog.api service in development environments.</span></span>

## <a name="lifting-and-shifting"></a><span data-ttu-id="71170-176">Levantando e mudando</span><span class="sxs-lookup"><span data-stu-id="71170-176">Lifting and shifting</span></span>

<span data-ttu-id="71170-177">O Visual Studio fornece um excelente suporte para colocar um aplicativo em contêineres.</span><span class="sxs-lookup"><span data-stu-id="71170-177">Visual Studio provides great support for containerizing an application.</span></span> <span data-ttu-id="71170-178">Clique com botão direito do mouse no nó do projeto e, em seguida, selecione **Adicionar** e **Suporte ao Docker**.</span><span class="sxs-lookup"><span data-stu-id="71170-178">You right-click the project node and then select **Add** and **Docker Support**.</span></span> <span data-ttu-id="71170-179">O modelo de projeto do Docker adiciona um novo projeto à solução chamado **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="71170-179">The Docker project template adds a new project to the solution called **docker-compose**.</span></span> <span data-ttu-id="71170-180">O projeto contém os ativos do Docker que compõem (ou compilam) as imagens necessárias e começa a executar os contêineres necessários, conforme é mostrado na Figura 7-3.</span><span class="sxs-lookup"><span data-stu-id="71170-180">The project contains the Docker assets that compose (or build) the images you need, and starts running the necessary containers, as shown in Figure 7-3.</span></span>

<span data-ttu-id="71170-181">Nos cenários lift-and-shift mais simples, o aplicativo será o único serviço que você usará para o aplicativo Web Forms.</span><span class="sxs-lookup"><span data-stu-id="71170-181">In the simplest lift-and-shift scenarios, the application will be the single service that you use for the Web Forms application.</span></span> <span data-ttu-id="71170-182">O modelo também altera o projeto de inicialização para apontar para o projeto **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="71170-182">The template also changes your startup project to point to the **docker-compose** project.</span></span> <span data-ttu-id="71170-183">Pressionar Ctrl + F5 ou F5 agora cria a imagem do Docker e inicia o contêiner do Docker.</span><span class="sxs-lookup"><span data-stu-id="71170-183">Pressing Ctrl+F5 or F5 now creates the Docker image and launches the Docker container.</span></span>

![](./media/image3.png)

<span data-ttu-id="71170-184">**Figura 7-3**.</span><span class="sxs-lookup"><span data-stu-id="71170-184">**Figure 7-3**.</span></span> <span data-ttu-id="71170-185">O projeto **docker-compose** na solução do Web Forms</span><span class="sxs-lookup"><span data-stu-id="71170-185">The **docker-compose** project in the Web Forms solution</span></span>

<span data-ttu-id="71170-186">Antes de executar a solução, você deve configurar o Docker para usar contêineres do Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-186">Before you run the solution, you must make sure that you configure Docker to use Windows Containers.</span></span> <span data-ttu-id="71170-187">Para fazer isso, clique com botão direito do mouse no ícone de barra de tarefas do Docker no Windows e selecione **Alternar para Contêineres do Windows**, conforme é mostrado na Figura 7-4.</span><span class="sxs-lookup"><span data-stu-id="71170-187">To do that, you right-click the Docker taskbar icon in Windows and select **Switch to Windows Containers**, as shown in Figure 7-4.</span></span>

![](./media/image4.png)

<span data-ttu-id="71170-188">**Figura 7-4**.</span><span class="sxs-lookup"><span data-stu-id="71170-188">**Figure 7-4**.</span></span> <span data-ttu-id="71170-189">Alternando para contêineres do Windows pelo ícone de barra de tarefas do Docker no Windows</span><span class="sxs-lookup"><span data-stu-id="71170-189">Switching to Windows Containers from the Docker taskbar icon in Windows</span></span>

<span data-ttu-id="71170-190">Se o item de menu mostrar **Alternar para Contêineres do Linux**, você já estará executando o Docker com contêineres do Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-190">If the menu item says **Switch to Linux containers**, you are already running Docker with Windows Containers.</span></span>

<span data-ttu-id="71170-191">Executar a solução reinicia o host do Docker.</span><span class="sxs-lookup"><span data-stu-id="71170-191">Running the solution restarts the Docker host.</span></span> <span data-ttu-id="71170-192">Ao compilar, você compila o aplicativo e a imagem do Docker para o projeto do Web Forms.</span><span class="sxs-lookup"><span data-stu-id="71170-192">When you build, you build the application and the Docker image for the Web Forms project.</span></span> <span data-ttu-id="71170-193">A primeira vez que você fizer isso levará um tempo considerável.</span><span class="sxs-lookup"><span data-stu-id="71170-193">The first time you do this, it takes considerable time.</span></span> <span data-ttu-id="71170-194">Isso ocorre porque o processo de build extrai a imagem base do Windows Server e a imagem adicional do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="71170-194">This is because the build process pulls down the base Windows Server image and the additional image for ASP.NET.</span></span> <span data-ttu-id="71170-195">Os próximos ciclos de build e execução serão muito mais rápidos.</span><span class="sxs-lookup"><span data-stu-id="71170-195">Subsequent build and run cycles will be much faster.</span></span>

<span data-ttu-id="71170-196">Vamos fazer uma análise mais profunda dos arquivos adicionados pelo modelo de projeto do Docker.</span><span class="sxs-lookup"><span data-stu-id="71170-196">Let’s take a deeper look at the files added by the Docker project template.</span></span> <span data-ttu-id="71170-197">Ele criou vários arquivos para você.</span><span class="sxs-lookup"><span data-stu-id="71170-197">It created several files for you.</span></span> <span data-ttu-id="71170-198">O Visual Studio usa esses arquivos para criar a imagem do Docker e iniciar um contêiner.</span><span class="sxs-lookup"><span data-stu-id="71170-198">Visual Studio uses these files to create the Docker image and launch a container.</span></span> <span data-ttu-id="71170-199">Você pode usar os mesmos arquivos da CLI para executar os comandos do Docker manualmente.</span><span class="sxs-lookup"><span data-stu-id="71170-199">You can use the same files from the CLI to run Docker commands manually.</span></span>

<span data-ttu-id="71170-200">O exemplo de Dockerfile a seguir mostra as configurações básicas para compilar uma imagem do Docker com base na imagem do ASP.NET do Windows que executa um site ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="71170-200">The following Dockerfile example shows the basic settings for building a Docker image based on the Windows ASP.NET image that runs an ASP.NET site.</span></span>

```
FROM microsoft/aspnet

ARG source

WORKDIR /inetpub/wwwroot

COPY ${source:-obj/Docker/publish} .
```

<span data-ttu-id="71170-201">Este Dockerfile será muito semelhante ao que é criado para executar um aplicativo ASP.NET Core em contêineres do Linux.</span><span class="sxs-lookup"><span data-stu-id="71170-201">This Dockerfile will look very similar to those created for running an ASP.NET Core application in Linux containers.</span></span> <span data-ttu-id="71170-202">No entanto, há algumas diferenças importantes.</span><span class="sxs-lookup"><span data-stu-id="71170-202">However, there are a few important differences.</span></span> <span data-ttu-id="71170-203">A diferença mais importante é que a imagem base é microsoft/aspnet, que é a imagem atual do Windows Server que inclui o .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="71170-203">The most important difference is that the base image is microsoft/aspnet, which is the current Windows Server image that includes the .NET Framework.</span></span> <span data-ttu-id="71170-204">Outras diferenças são que os diretórios copiados do seu diretório de origem são diferentes.</span><span class="sxs-lookup"><span data-stu-id="71170-204">Other differences are that the directories copied from your source directory are different.</span></span>

<span data-ttu-id="71170-205">Os outros arquivos do projeto **docker-compose** são os ativos do Docker necessários para criar e configurar os contêineres.</span><span class="sxs-lookup"><span data-stu-id="71170-205">The other files in the **docker-compose** project are the Docker assets needed to build and configure the containers.</span></span> <span data-ttu-id="71170-206">O Visual Studio coloca os diversos arquivos docker-compose.yml em um único nó para realçar como eles são usados.</span><span class="sxs-lookup"><span data-stu-id="71170-206">Visual Studio puts the various docker-compose.yml files under one node to highlight how they are used.</span></span> <span data-ttu-id="71170-207">O arquivo base docker-compose contém as diretivas que são comuns a todas as configurações.</span><span class="sxs-lookup"><span data-stu-id="71170-207">The base docker-compose file contains the directives that are common to all configurations.</span></span> <span data-ttu-id="71170-208">O arquivo docker-compose.override.yml contém variáveis de ambiente e as substituições relacionadas para uma configuração de desenvolvedor.</span><span class="sxs-lookup"><span data-stu-id="71170-208">The docker-compose.override.yml file contains environment variables and related overrides for a developer configuration.</span></span> <span data-ttu-id="71170-209">As variantes com .vs.debug e .vs.release fornecem configurações de ambiente que permitem que o Visual Studio seja anexado ao contêiner em execução e o gerencie.</span><span class="sxs-lookup"><span data-stu-id="71170-209">The variants with .vs.debug and .vs.release provide environment settings that enable Visual Studio to attach to and manage the running container.</span></span>

<span data-ttu-id="71170-210">Embora a integração do Visual Studio faça parte da adição do suporte ao Docker na sua solução, você também pode criar e executar na linha de comando usando o comando docker-compose up, como você viu nas seções anteriores.</span><span class="sxs-lookup"><span data-stu-id="71170-210">While Visual Studio integration is part of adding Docker support to your solution, you can also build and run from the command line, using the docker-compose up command, as you saw in previous sections.</span></span>

## <a name="getting-data-from-the-existing-catalog-net-core-microservice"></a><span data-ttu-id="71170-211">Obtendo dados do microsserviço de catálogo existente do .NET Core</span><span class="sxs-lookup"><span data-stu-id="71170-211">Getting data from the existing catalog .NET Core microservice</span></span>

<span data-ttu-id="71170-212">Você pode configurar o aplicativo Web Forms para usar o microsserviço de catálogo eShopOnContainers para obter os dados em vez de usar dados fictícios.</span><span class="sxs-lookup"><span data-stu-id="71170-212">You can configure the Web Forms application to use the eShopOnContainers catalog microservice to get data instead of using fake data.</span></span> <span data-ttu-id="71170-213">Para fazer isso, você pode editar o arquivo web.config e definir o valor da chave useFake como false.</span><span class="sxs-lookup"><span data-stu-id="71170-213">To do this, you edit the web.config file and set the value of the useFake key to false.</span></span> <span data-ttu-id="71170-214">O contêiner de DI usará a classe que acessa o microsserviço de catálogo ativo em vez da classe que retorna os dados embutidos em código.</span><span class="sxs-lookup"><span data-stu-id="71170-214">The DI container will use the class that accesses the live catalog microservice instead of the class that returns the hard-coded data.</span></span> <span data-ttu-id="71170-215">Nenhuma outra alteração de código será necessária.</span><span class="sxs-lookup"><span data-stu-id="71170-215">No other code changes are needed.</span></span>

<span data-ttu-id="71170-216">Acessar o serviço de catálogo ativo significa que você precisa atualizar o projeto **docker-compose** para compilar a imagem do serviço de catálogo e iniciar o contêiner do serviço de catálogo.</span><span class="sxs-lookup"><span data-stu-id="71170-216">Accessing the live catalog service does mean you need to update the **docker-compose** project to build the catalog service image and launch the catalog service container.</span></span> <span data-ttu-id="71170-217">O Docker CE para Window dá suporte a contêineres do Linux e contêineres do Windows, mas não para ambos ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="71170-217">Docker CE for Windows supports both Linux containers and Windows Containers, but not at the same time.</span></span> <span data-ttu-id="71170-218">Para executar o microsserviço de catálogo, você precisa compilar uma imagem que execute o microsserviço de catálogo com base em um contêiner baseado em Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-218">To run the catalog microservice, you need to build an image that runs the catalog microservice on top of a Windows-based container.</span></span> <span data-ttu-id="71170-219">Essa abordagem requer um Dockerfile diferente para o projeto microsserviços que você viu nas seções anteriores.</span><span class="sxs-lookup"><span data-stu-id="71170-219">This approach requires a different Dockerfile for the microservices project than you have seen in earlier sections.</span></span> <span data-ttu-id="71170-220">O arquivo Dockerfile.windows contém as definições de configuração para compilar a imagem de contêiner da API de catálogo para executar em um contêiner do Windows, por exemplo, para usar uma imagem do Docker do Windows Nano.</span><span class="sxs-lookup"><span data-stu-id="71170-220">The Dockerfile.windows file contains the configuration settings to build the catalog API container image so that it runs on a Windows container—for example, to use a Windows Nano Docker image.</span></span>

<span data-ttu-id="71170-221">O microsserviço de catálogo depende do banco de dados do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="71170-221">The catalog microservice relies on the SQL Server database.</span></span> <span data-ttu-id="71170-222">Portanto, você também precisa usar uma imagem do Docker do SQL Server baseado em Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-222">Therefore, you need to use a Windows-based SQL Server Docker image as well.</span></span>

<span data-ttu-id="71170-223">Após essas alterações, o projeto docker-compose fará algo mais para iniciar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="71170-223">After these changes, the docker-compose project does more to start the application.</span></span> <span data-ttu-id="71170-224">O projeto agora inicia o SQL Server usando a imagem do SQL Server baseado em Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-224">The project now starts the SQL Server using the Windows based SQL Server image.</span></span> <span data-ttu-id="71170-225">Ele inicia o microsserviço de catálogo em um contêiner do Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-225">It starts the catalog microservice in a Windows container.</span></span> <span data-ttu-id="71170-226">E também inicia o contêiner do editor de catálogo do Web Forms em um contêiner do Windows.</span><span class="sxs-lookup"><span data-stu-id="71170-226">And it starts the Web Forms catalog editor container, also in a Windows container.</span></span> <span data-ttu-id="71170-227">Se uma das imagens precisar de build, as imagens serão criadas primeiro.</span><span class="sxs-lookup"><span data-stu-id="71170-227">If any of the images need building, the images are created first.</span></span>

## <a name="development-and-production-environments"></a><span data-ttu-id="71170-228">Ambientes de desenvolvimento e produção</span><span class="sxs-lookup"><span data-stu-id="71170-228">Development and production environments</span></span>

<span data-ttu-id="71170-229">Há algumas diferenças entre a configuração de desenvolvimento e uma configuração de produção.</span><span class="sxs-lookup"><span data-stu-id="71170-229">There are a couple of differences between the development configuration and a production configuration.</span></span> <span data-ttu-id="71170-230">No ambiente de desenvolvimento, você executa o aplicativo Web Forms, o microsserviço de catálogo e o SQL Server nos contêineres do Windows, como parte do mesmo host do Docker.</span><span class="sxs-lookup"><span data-stu-id="71170-230">In the development environment, you run the Web Forms application, the catalog microservice, and SQL Server in Windows Containers, as part of the same Docker host.</span></span> <span data-ttu-id="71170-231">Nas seções anteriores, mencionamos que as imagens do SQL Server são implantadas no mesmo host do Docker que os outros serviços baseados em .NET Core em um host do Docker baseado em Linux.</span><span class="sxs-lookup"><span data-stu-id="71170-231">In earlier sections, we mentioned SQL Server images deployed in the same Docker host as the other .NET Core-based services on a Linux-based Docker host.</span></span> <span data-ttu-id="71170-232">A vantagem de executar vários microservices no mesmo host (ou cluster) do Docker é que há menos comunicação de rede e a comunicação entre contêineres tem uma latência menor.</span><span class="sxs-lookup"><span data-stu-id="71170-232">The advantage of running the multiple microservices in the same Docker host (or cluster) is that there is less network communication and the communication between containers has lower latency.</span></span>

<span data-ttu-id="71170-233">No ambiente de desenvolvimento, você deve executar todos os contêineres no mesmo sistema operacional.</span><span class="sxs-lookup"><span data-stu-id="71170-233">In the development environment, you must run all the containers in the same OS.</span></span> <span data-ttu-id="71170-234">O Docker CE para Windows não dá suporte para execução de contêineres baseados em Windows e em Linux ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="71170-234">Docker CE for Windows does not support running Windows- and Linux-based containers at the same time.</span></span> <span data-ttu-id="71170-235">Em produção, você pode decidir se deseja executar o microsserviço de catálogo em um contêiner do Windows em um único host (ou cluster) do Docker ou fazer com que o aplicativo Web Forms se comunique com uma instância de microsserviço de catálogo em execução em um contêiner do Linux em um host do Docker diferente.</span><span class="sxs-lookup"><span data-stu-id="71170-235">In production, you can decide if you want to run the catalog microservice in a Windows container in a single Docker host (or cluster), or have the Web Forms application communicate with an instance of the catalog microservice running in a Linux container on a different Docker host.</span></span> <span data-ttu-id="71170-236">Isso depende de como você deseja otimizar a latência da rede.</span><span class="sxs-lookup"><span data-stu-id="71170-236">It depends on how you want to optimize for network latency.</span></span> <span data-ttu-id="71170-237">Na maioria dos casos, convém que os microsserviços dos quais os aplicativos dependem sejam executado no mesmo host (ou nuvem) do Docker para facilitar a implantação e reduzir a latência de comunicação.</span><span class="sxs-lookup"><span data-stu-id="71170-237">In most cases, you want the microservices that your applications depend on running in the same Docker host (or swarm) for ease of deployment and lower communication latency.</span></span> <span data-ttu-id="71170-238">Nessas configurações, as únicas comunicações de alto custo são as que ocorrem entre as instâncias de microsserviços e os servidores de alta disponibilidade do armazenamento de dados persistentes.</span><span class="sxs-lookup"><span data-stu-id="71170-238">In those configurations, the only costly communications is between the microservice instances and the high-availability servers for the persistent data storage.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="71170-239">[Previous] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span><span class="sxs-lookup"><span data-stu-id="71170-239">[Previous] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span></span>
