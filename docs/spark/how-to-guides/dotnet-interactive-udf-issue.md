---
title: Escreva e chame UDFs no .NET para Apache Spark ambientes interativos.
description: Saiba como escrever e chamar UDFs no .NET para Apache Spark shells interativos.
ms.author: nidutta
author: Niharikadutta
ms.date: 10/09/2020
ms.topic: conceptual
ms.custom: mvc,how-to
ms.openlocfilehash: d07d757f9e47a84c75f46b190bdb613b8d2db7c1
ms.sourcegitcommit: 67ebdb695fd017d79d9f1f7f35d145042d5a37f7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/20/2020
ms.locfileid: "92224136"
---
# <a name="write-and-call-udfs-in-net-for-apache-spark-interactive-environments"></a><span data-ttu-id="ad2ff-103">Escreva e chame UDFs no .NET para Apache Spark ambientes interativos</span><span class="sxs-lookup"><span data-stu-id="ad2ff-103">Write and call UDFs in .NET for Apache Spark interactive environments</span></span>

<span data-ttu-id="ad2ff-104">Neste artigo, você aprenderá a usar as UDFs (funções definidas pelo usuário) em um ambiente do .NET para Apache Spark interativo.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-104">In this article, you will learn how to use user-defined functions (UDFs) in a .NET for Apache Spark interactive environment.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ad2ff-105">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="ad2ff-105">Prerequisites</span></span>

1. <span data-ttu-id="ad2ff-106">Instalar o [.net Interactive](https://github.com/dotnet/interactive)</span><span class="sxs-lookup"><span data-stu-id="ad2ff-106">Install [.NET Interactive](https://github.com/dotnet/interactive)</span></span>
2. <span data-ttu-id="ad2ff-107">Instalar o [Jupyter Lab](https://jupyter.org/)</span><span class="sxs-lookup"><span data-stu-id="ad2ff-107">Install [Jupyter lab](https://jupyter.org/)</span></span>

## <a name="net-for-apache-spark-interactive-experience"></a><span data-ttu-id="ad2ff-108">.NET para Apache Spark experiência interativa</span><span class="sxs-lookup"><span data-stu-id="ad2ff-108">.NET for Apache Spark Interactive experience</span></span>

<span data-ttu-id="ad2ff-109">O [.net para Apache Spark](https://github.com/dotnet/spark) usa o [.net Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) para fornecer suporte ao .net para experiência interativa no Spark.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-109">[.NET for Apache Spark](https://github.com/dotnet/spark) uses [.NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) to provide .NET support for interactive experience inside Spark.</span></span> <span data-ttu-id="ad2ff-110">Para entender como configurar o ambiente para experimentar o .NET Interactive com notebooks Jupyter, consulte o [repositório interativo do .net](https://github.com/dotnet/interactive).</span><span class="sxs-lookup"><span data-stu-id="ad2ff-110">To understand how to set up the environment to try .NET Interactive with Jupyter notebooks, see the [.NET Interactive repository](https://github.com/dotnet/interactive).</span></span>

<span data-ttu-id="ad2ff-111">Além disso, é recomendável seguir [Este artigo sobre a SERIALIZAÇÃO UDF no .net para Apache Spark](udf-guide.md) entender quais UDFs são e como elas são serializadas no .net para Apache Spark.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-111">Also, it is recommended to go through [this article about UDF serialization in .NET for Apache Spark](udf-guide.md) to understand what UDFs are and how they are serialized in .NET for Apache Spark.</span></span>
<span data-ttu-id="ad2ff-112">Este guia usa blocos de anotações do Jupyter para ilustrar como usar UDFs em uma experiência interativa.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-112">This guide uses Jupyter Notebooks to illustrate how to use UDFs in an interactive experience.</span></span>

## <a name="define-a-udf-in-net-interactive"></a><span data-ttu-id="ad2ff-113">Definir um UDF no .NET Interactive</span><span class="sxs-lookup"><span data-stu-id="ad2ff-113">Define a UDF in .NET Interactive</span></span>

<span data-ttu-id="ad2ff-114">Na experiência interativa, uma célula pode ser considerada como o trecho de código que está sendo enviado como parte de uma iteração do [repl](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span><span class="sxs-lookup"><span data-stu-id="ad2ff-114">In the interactive experience, a cell can be thought of as the code snippet being submitted as part of one iteration of the [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span></span> <span data-ttu-id="ad2ff-115">Por exemplo, veja o bloco de anotações a seguir para entender o que isso significa:</span><span class="sxs-lookup"><span data-stu-id="ad2ff-115">For example, take a look at the following notebook to understand what that means:</span></span>

![Jupyter Notebook células](./media/dotnet-interactive/dotnet-interactive-cells.png)

<span data-ttu-id="ad2ff-117">Cada um desses blocos marcados pela seta vermelha é uma célula ou um envio de código para Spark.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-117">Each of those blocks marked by the red arrow is one cell, or one submission of code to Spark.</span></span> <span data-ttu-id="ad2ff-118">Agora, ao definir um UDF que faz referência a um objeto personalizado definido pelo usuário, é necessário que o UDF seja definido na mesma célula em que o objeto ao qual ele faz referência é definido.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-118">Now when defining a UDF that references a custom user-defined object, it is required that the UDF be defined in the same cell where the object it references is defined.</span></span> <span data-ttu-id="ad2ff-119">Vejamos o que parece ser um exemplo:</span><span class="sxs-lookup"><span data-stu-id="ad2ff-119">Let's look at what that looks like as an example:</span></span>

![UDF de trabalho](./media/dotnet-interactive/working-udf.png)

## <a name="call-a-udf-on-a-dataframe"></a><span data-ttu-id="ad2ff-121">Chamar um UDF em um dataframe</span><span class="sxs-lookup"><span data-stu-id="ad2ff-121">Call a UDF on a DataFrame</span></span>

<span data-ttu-id="ad2ff-122">Ao chamar um UDF previamente definido em um, `DataFrame` é importante verificar se o UDF está definido em uma célula enviada anteriormente, antes de chamá-lo, como pode ser visto no exemplo anterior.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-122">When calling a previously defined UDF on a `DataFrame` it is important to make sure the UDF is defined in a previously submitted cell, before calling it, as can be seen in the previous example.</span></span>

<span data-ttu-id="ad2ff-123">Agora, vamos ver o que acontece se chamarmos o UDF na mesma célula onde ele está definido.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-123">Now let's see what happens if we call the UDF in the same cell where it is defined.</span></span>

![falha na chamada UDF](./media/dotnet-interactive/udf_fails.png)

<span data-ttu-id="ad2ff-125">O erro realçado acima é porque os assemblies UDF precisam primeiro ser compilados e enviados para os trabalhadores antes que possam ser chamados em um dataframe.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-125">The above highlighted error is because the UDF assemblies need to first be compiled and shipped to the workers before it can be called on a DataFrame.</span></span>

<span data-ttu-id="ad2ff-126">Essas são algumas coisas importantes para se ter em mente ao implementar UDFs no .NET para Apache Spark experiência interativa (como [notebooks Synapse do Azure](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span><span class="sxs-lookup"><span data-stu-id="ad2ff-126">These are a few important things to keep in mind while implementing UDFs in .NET for Apache Spark interactive experience (such as [Azure Synapse Notebooks](https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span></span>

## <a name="faqs"></a><span data-ttu-id="ad2ff-127">Perguntas frequentes</span><span class="sxs-lookup"><span data-stu-id="ad2ff-127">FAQs</span></span>

1. <span data-ttu-id="ad2ff-128">**Por que meu UDF que faz referência a um objeto personalizado definido pelo usuário gera o erro `Type Submission#_ is not marked as serializable` ?**</span><span class="sxs-lookup"><span data-stu-id="ad2ff-128">**Why does my UDF referencing a custom user-defined object throw the error `Type Submission#_ is not marked as serializable`?**</span></span>
    <span data-ttu-id="ad2ff-129">O .NET Interactive encapsula cada uma dessas células com uma classe wrapper do número de envio da célula para identificar exclusivamente cada célula que está sendo enviada.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-129">.NET Interactive wraps each of these cells with a wrapper class of the cell submission number, to uniquely identify each cell being submitted.</span></span> <span data-ttu-id="ad2ff-130">Agora, conforme explicado em detalhes neste [guia](udf-guide.md), quando um UDF que faz referência a um objeto personalizado está sendo serializado, seu destino também é selecionado para serialização, que, no caso do .net Interactive, é encapsulado pela classe wrapper da célula onde o objeto personalizado é definido.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-130">Now as explained in detail in [this guide](udf-guide.md), when a UDF that references a custom object is being serialized its target is also picked up for serialization, which in the case of .NET Interactive gets wrapped by the wrapper class of the cell where the custom object is defined.</span></span>
    <span data-ttu-id="ad2ff-131">Agora vamos ver como isso afeta nossa definição de UDF no bloco de anotações:</span><span class="sxs-lookup"><span data-stu-id="ad2ff-131">Now let's see how that affects our UDF definition in the notebook:</span></span>

    ![Erro de serialização UDF](./media/dotnet-interactive/udf-serialization-error.png)

    <span data-ttu-id="ad2ff-133">Como pode ser visto no caso do `udf2_fails` , vemos a mensagem de erro dizendo que o tipo `Submission#7` não está marcado como serializável, isso ocorre porque o .net Interactive encapsula cada objeto definido em uma célula com sua `Submission#` classe, que é gerada imediatamente e, portanto, não é marcada como `Serializable` .</span><span class="sxs-lookup"><span data-stu-id="ad2ff-133">As can be seen in the case of `udf2_fails`, we see the error message that says Type `Submission#7` is not marked as serializable, this is because .NET Interactive wraps every object defined in a cell with its `Submission#` class, which is generated on the fly and hence is not marked as `Serializable`.</span></span>

    <span data-ttu-id="ad2ff-134">Por esse motivo, é **necessário que um UDF referenciando um objeto personalizado seja definido na mesma célula que o objeto**.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-134">For this reason, it is **required that a UDF referencing a custom object is defined in the same cell as that object**.</span></span>

2. <span data-ttu-id="ad2ff-135">**Por que não difundir variáveis funcionam com o .NET interativo?**</span><span class="sxs-lookup"><span data-stu-id="ad2ff-135">**Why don't Broadcast Variables work with .NET Interactive?**</span></span>
    <span data-ttu-id="ad2ff-136">Pelos motivos explicados anteriormente, as variáveis de difusão não funcionam com o .NET Interactive.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-136">For the reasons explained previously, broadcast variables don't work with .NET Interactive.</span></span> <span data-ttu-id="ad2ff-137">É uma boa ideia seguir [este guia sobre variáveis de difusão](broadcast-guide.md) para obter uma compreensão mais profunda de quais variáveis de difusão são e como usá-las.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-137">It is a good idea to go through [this guide on broadcast variables](broadcast-guide.md) to get a deeper understanding of what broadcast variables are and how to use them.</span></span> <span data-ttu-id="ad2ff-138">O motivo pelo qual as variáveis de difusão não funcionam com cenários interativos é devido ao design interativo do .NET de acrescentar cada objeto definido em uma célula com sua classe de envio de célula, que, como não está marcada como serializável, falha com a mesma exceção que foi mostrado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-138">The reason broadcast variables don't work with interactive scenarios is because of .NET interactive's design of appending each object defined in a cell with its cell submission class, which since is not marked serializable, fails with the same exception as shown previously.</span></span>
    <span data-ttu-id="ad2ff-139">Vamos nos aprofundar um pouco mais com o exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="ad2ff-139">Let's dive a little deeper with the following example:</span></span>

    ![Falha nas variáveis de difusão](./media/dotnet-interactive/broadcast-fails.png)

    <span data-ttu-id="ad2ff-141">Conforme recomendado nas seções anteriores, definimos o UDF e o objeto que ele está referenciando (variável de difusão, nesse caso) na mesma célula, mas ainda vemos o erro reclamando `SerializationException` `Microsoft.Spark.Sql.Session` não estar marcado como serializável.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-141">As recommended in the previous sections, we define both the UDF and the object it is referencing (broadcast variable in this case) in the same cell, but we still see the `SerializationException` error complaining about `Microsoft.Spark.Sql.Session` not being marked as serializable.</span></span> <span data-ttu-id="ad2ff-142">Isso ocorre porque, quando o compilador tenta serializar o objeto de variável de difusão `bv` , ele encontra seu nome a ser anexado ao [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) objeto `spark` , o que exige que seja marcado como serializável.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-142">This is because when the compiler tries to serialize the broadcast variable object `bv`, it finds its name to be appended with [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) object `spark`, which it requires to be marked as serializable.</span></span> <span data-ttu-id="ad2ff-143">Isso pode ser demonstrado com mais facilidade fazendo uma inspeção no assembly descompilado deste envio de célula:</span><span class="sxs-lookup"><span data-stu-id="ad2ff-143">This can be demonstrated with more ease by taking a peek at the decompiled assembly of this cell submission:</span></span>

    ![Código de assembly descompilado](./media/dotnet-interactive/decompiledAssembly.png)

    <span data-ttu-id="ad2ff-145">Se marcarmos a [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) classe como `[Serializable]` , podemos fazer com que isso funcione, mas essa não é uma solução ideal, pois não queremos dar ao usuário a capacidade de serializar um objeto SparkSession, pois isso poderia levar a um comportamento estranho e indesejável.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-145">If we mark the [`SparkSession`](https://github.com/dotnet/spark/blob/master/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) class as `[Serializable]`, we can get this to work, but this is not an ideal solution as we don't want to give the user the ability to serialize a SparkSession object, as that could lead to some weird, undesirable behavior.</span></span> <span data-ttu-id="ad2ff-146">Esse é um [problema conhecido](https://github.com/dotnet/spark/issues/619) e será resolvido em versões futuras.</span><span class="sxs-lookup"><span data-stu-id="ad2ff-146">This is a [known issue](https://github.com/dotnet/spark/issues/619) and will be resolved in future versions.</span></span>
