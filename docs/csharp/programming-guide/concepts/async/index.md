---
title: Programação assíncrona em C#
description: Uma visão geral do suporte de linguagem C# para programação assíncrona usando async, await, Task e Task<T>
ms.date: 05/26/2020
ms.openlocfilehash: 703392ca6ba4e6fb08dd8a88817babc167394788
ms.sourcegitcommit: 03fec33630b46e78d5e81e91b40518f32c4bd7b5
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/27/2020
ms.locfileid: "84007956"
---
# <a name="asynchronous-programming-with-async-and-await"></a><span data-ttu-id="7e9ef-103">Programação assíncrona com async e await</span><span class="sxs-lookup"><span data-stu-id="7e9ef-103">Asynchronous programming with async and await</span></span>

<span data-ttu-id="7e9ef-104">O [modelo de programação assíncrona de tarefa (TAP)](task-asynchronous-programming-model.md) fornece uma abstração sobre código assíncrono.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-104">The [Task asynchronous programming model (TAP)](task-asynchronous-programming-model.md) provides an abstraction over asynchronous code.</span></span> <span data-ttu-id="7e9ef-105">Você escreve o código como uma sequência de instruções, como usual.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-105">You write code as a sequence of statements, just like always.</span></span> <span data-ttu-id="7e9ef-106">Você pode ler o código como se cada instrução fosse concluída antes do início da próxima.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-106">You can read that code as though each statement completes before the next begins.</span></span> <span data-ttu-id="7e9ef-107">O compilador realiza uma série de transformações, porque algumas dessas instruções podem iniciar o trabalho e retornar um <xref:System.Threading.Tasks.Task> que representa o trabalho em andamento.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-107">The compiler performs a number of transformations because some of those statements may start work and return a <xref:System.Threading.Tasks.Task> that represents the ongoing work.</span></span>

<span data-ttu-id="7e9ef-108">Essa é a meta dessa sintaxe: habilitar um código que leia como uma sequência de instruções, mas que execute em uma ordem muito mais complicada com base na alocação de recurso externo e em quando as tarefas são concluídas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-108">That's the goal of this syntax: enable code that reads like a sequence of statements, but executes in a much more complicated order based on external resource allocation and when tasks complete.</span></span> <span data-ttu-id="7e9ef-109">Isso é semelhante à maneira como as pessoas dão instruções para processos que incluem tarefas assíncronas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-109">It's analogous to how people give instructions for processes that include asynchronous tasks.</span></span> <span data-ttu-id="7e9ef-110">Ao longo deste artigo, você usará um exemplo de instruções para fazer uma café de manhã para ver como as `async` palavras-chave e facilitam o `await` motivo do código, que inclui uma série de instruções assíncronas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-110">Throughout this article, you'll use an example of instructions for making a breakfast to see how the `async` and `await` keywords make it easier to reason about code, that includes a series of asynchronous instructions.</span></span> <span data-ttu-id="7e9ef-111">Você deve escrever as instruções de maneira parecida com a lista a seguir para explicar como fazer um café da manhã:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-111">You'd write the instructions something like the following list to explain how to make a breakfast:</span></span>

1. <span data-ttu-id="7e9ef-112">Encher uma xícara de café.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-112">Pour a cup of coffee.</span></span>
1. <span data-ttu-id="7e9ef-113">Aquecer uma frigideira e, em seguida, fritar dois ovos.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-113">Heat up a pan, then fry two eggs.</span></span>
1. <span data-ttu-id="7e9ef-114">Frita três fatias de bacon.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-114">Fry three slices of bacon.</span></span>
1. <span data-ttu-id="7e9ef-115">Torrar dois pedaços de pão.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-115">Toast two pieces of bread.</span></span>
1. <span data-ttu-id="7e9ef-116">Adicionar manteiga e a geleia na torrada.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-116">Add butter and jam to the toast.</span></span>
1. <span data-ttu-id="7e9ef-117">Encher um copo com suco de laranja.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-117">Pour a glass of orange juice.</span></span>

<span data-ttu-id="7e9ef-118">Se tivesse experiência em culinária, você executaria essas instruções **assincronamente**.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-118">If you have experience with cooking, you'd execute those instructions **asynchronously**.</span></span> <span data-ttu-id="7e9ef-119">Você iniciaria aquecendo a frigideira para os ovos e, em seguida, começaria a preparar o bacon.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-119">You'd start warming the pan for eggs, then start the bacon.</span></span> <span data-ttu-id="7e9ef-120">Você colocaria o pão na torradeira e começaria a preparar os ovos.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-120">You'd put the bread in the toaster, then start the eggs.</span></span> <span data-ttu-id="7e9ef-121">Em cada etapa do processo, iniciaria uma tarefa e voltaria sua atenção para as tarefas que estivessem prontas para a sua atenção.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-121">At each step of the process, you'd start a task, then turn your attention to tasks that are ready for your attention.</span></span>

<span data-ttu-id="7e9ef-122">Preparar o café da manhã é um bom exemplo de trabalho assíncrono que não é paralelo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-122">Cooking breakfast is a good example of asynchronous work that isn't parallel.</span></span> <span data-ttu-id="7e9ef-123">Uma pessoa (ou um thread) pode lidar com todas essas tarefas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-123">One person (or thread) can handle all these tasks.</span></span> <span data-ttu-id="7e9ef-124">Continuando com a analogia do café da manhã, uma pessoa pode fazer café da manhã assincronamente iniciando a tarefa seguinte antes de concluir a primeira.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-124">Continuing the breakfast analogy, one person can make breakfast asynchronously by starting the next task before the first completes.</span></span> <span data-ttu-id="7e9ef-125">O preparo progride independentemente de haver alguém observando.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-125">The cooking progresses whether or not someone is watching it.</span></span> <span data-ttu-id="7e9ef-126">Assim que inicia o aquecimento da frigideira para os ovos, você pode começar a fritar o bacon.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-126">As soon as you start warming the pan for the eggs, you can begin frying the bacon.</span></span> <span data-ttu-id="7e9ef-127">Quando começar a preparar o bacon, você pode colocar o pão na torradeira.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-127">Once the bacon starts, you can put the bread into the toaster.</span></span>

<span data-ttu-id="7e9ef-128">Para um algoritmo paralelo, você precisaria de vários cozinheiros (ou threads).</span><span class="sxs-lookup"><span data-stu-id="7e9ef-128">For a parallel algorithm, you'd need multiple cooks (or threads).</span></span> <span data-ttu-id="7e9ef-129">Um prepararia os ovos, outro o bacon e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-129">One would make the eggs, one the bacon, and so on.</span></span> <span data-ttu-id="7e9ef-130">Cada um se concentraria apenas naquela tarefa específica.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-130">Each one would be focused on just that one task.</span></span> <span data-ttu-id="7e9ef-131">Cada cozinheiro (ou thread) ficaria bloqueado de forma síncrona, esperando que o bacon estivesse pronto para ser virado ou que a torrada pulasse.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-131">Each cook (or thread) would be blocked synchronously waiting for bacon to be ready to flip, or the toast to pop.</span></span>

<span data-ttu-id="7e9ef-132">Agora, considere essas mesmas instruções escritas como instruções em C#:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-132">Now, consider those same instructions written as C# statements:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-starter/Program.cs" highlight="8-27":::

> [!NOTE]
> <span data-ttu-id="7e9ef-133">As `Coffee` `Egg` classes,, `Bacon` , `Toast` e `Juice` estão vazias.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-133">The `Coffee`, `Egg`, `Bacon`, `Toast`, and `Juice` classes are empty.</span></span> <span data-ttu-id="7e9ef-134">Eles são simplesmente classes de marcador para fins de demonstração, não contêm propriedades e não servem para nenhuma outra finalidade.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-134">They are simply marker classes for the purpose of demonstration, contain no properties, and serve no other purpose.</span></span>

<span data-ttu-id="7e9ef-135">Os computadores não interpretam essas instruções da mesma forma que as pessoas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-135">Computers don't interpret those instructions the same way people do.</span></span> <span data-ttu-id="7e9ef-136">O computador ficará bloqueado em cada instrução até que o trabalho seja concluído, antes de passar para a próxima instrução.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-136">The computer will block on each statement until the work is complete before moving on to the next statement.</span></span> <span data-ttu-id="7e9ef-137">Isso cria um café da manhã insatisfatório.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-137">That creates an unsatisfying breakfast.</span></span> <span data-ttu-id="7e9ef-138">As tarefas posteriores não seriam iniciadas até que as tarefas anteriores fossem concluídas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-138">The later tasks wouldn't be started until the earlier tasks had completed.</span></span> <span data-ttu-id="7e9ef-139">Levaria muito mais tempo para criar o café da manhã e alguns itens ficariam frios antes de serem servidos.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-139">It would take much longer to create the breakfast, and some items would have gotten cold before being served.</span></span>

<span data-ttu-id="7e9ef-140">Se você quiser que o computador execute as instruções acima de forma assíncrona, deverá escrever o código assíncrono.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-140">If you want the computer to execute the above instructions asynchronously, you must write asynchronous code.</span></span>

<span data-ttu-id="7e9ef-141">Essas questões são importantes para os programas que você escreve atualmente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-141">These concerns are important for the programs you write today.</span></span> <span data-ttu-id="7e9ef-142">Ao escrever programas de cliente, você quer que a interface do usuário responda de acordo com as solicitações do usuário.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-142">When you write client programs, you want the UI to be responsive to user input.</span></span> <span data-ttu-id="7e9ef-143">Seu aplicativo não deve fazer um telefone parecer travado enquanto ele está baixando dados da Web.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-143">Your application shouldn't make a phone appear frozen while it's downloading data from the web.</span></span> <span data-ttu-id="7e9ef-144">Ao escrever programas de servidor, você não quer threads bloqueados.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-144">When you write server programs, you don't want threads blocked.</span></span> <span data-ttu-id="7e9ef-145">Esses threads poderiam servir a outras solicitações.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-145">Those threads could be serving other requests.</span></span> <span data-ttu-id="7e9ef-146">O uso de código síncrono quando existem alternativas assíncronas afeta sua capacidade de aumentar de forma menos custosa.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-146">Using synchronous code when asynchronous alternatives exist hurts your ability to scale out less expensively.</span></span> <span data-ttu-id="7e9ef-147">Você paga pelos threads bloqueados.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-147">You pay for those blocked threads.</span></span>

<span data-ttu-id="7e9ef-148">Aplicativos modernos bem-sucedidos exigem código assíncrono.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-148">Successful modern applications require asynchronous code.</span></span> <span data-ttu-id="7e9ef-149">Sem suporte de linguagem, escrever código assíncrono exigia retornos de chamada, eventos de conclusão ou outros meios que obscureciam a intenção original do código.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-149">Without language support, writing asynchronous code required callbacks, completion events, or other means that obscured the original intent of the code.</span></span> <span data-ttu-id="7e9ef-150">A vantagem do código síncrono é que ele é fácil de entender.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-150">The advantage of the synchronous code is that it's easy to understand.</span></span> <span data-ttu-id="7e9ef-151">As ações passo a passo facilitam o exame e o entendimento.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-151">The step-by-step actions make it easy to scan and understand.</span></span> <span data-ttu-id="7e9ef-152">Modelos assíncronos tradicionais forçavam você a se concentrar na natureza assíncrona do código e não nas ações fundamentais do código.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-152">Traditional asynchronous models forced you to focus on the asynchronous nature of the code, not on the fundamental actions of the code.</span></span>

## <a name="dont-block-await-instead"></a><span data-ttu-id="7e9ef-153">Não bloquear, mas aguardar</span><span class="sxs-lookup"><span data-stu-id="7e9ef-153">Don't block, await instead</span></span>

<span data-ttu-id="7e9ef-154">O código anterior demonstra uma prática inadequada: construção de código síncrono para realizar operações assíncronas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-154">The preceding code demonstrates a bad practice: constructing synchronous code to perform asynchronous operations.</span></span> <span data-ttu-id="7e9ef-155">Como escrito, esse código bloqueia o thread que o está executando, impedindo-o de realizar qualquer outra tarefa.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-155">As written, this code blocks the thread executing it from doing any other work.</span></span> <span data-ttu-id="7e9ef-156">Ele não será interrompido enquanto qualquer uma das tarefas estiver em andamento.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-156">It won't be interrupted while any of the tasks are in progress.</span></span> <span data-ttu-id="7e9ef-157">Seria como se você fixasse o olhar na torradeira depois de colocar o pão.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-157">It would be as though you stared at the toaster after putting the bread in.</span></span> <span data-ttu-id="7e9ef-158">Você ignoraria qualquer pessoa que estivesse conversando com você até que a torrada pulasse.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-158">You'd ignore anyone talking to you until the toast popped.</span></span>

<span data-ttu-id="7e9ef-159">Vamos começar atualizando esse código para que o thread não seja bloqueado enquanto houver tarefas em execução.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-159">Let's start by updating this code so that the thread doesn't block while tasks are running.</span></span> <span data-ttu-id="7e9ef-160">A palavra-chave `await` oferece uma maneira sem bloqueio de iniciar uma tarefa e, em seguida, continuar a execução quando essa tarefa for concluída.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-160">The `await` keyword provides a non-blocking way to start a task, then continue execution when that task completes.</span></span> <span data-ttu-id="7e9ef-161">Uma versão assíncrona simples do código de fazer café da manhã ficaria como o snippet a seguir:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-161">A simple asynchronous version of the make a breakfast code would look like the following snippet:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V2/Program.cs" id="SnippetMain":::

> [!TIP]
> <span data-ttu-id="7e9ef-162">Os corpos de método do `FryEggsAsync` , `FryBaconAsync` , e `ToastBreadAsync` foram atualizados para retornar `Task<Egg>` , `Task<Bacon>` e, `Task<Toast>` respectivamente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-162">The method bodies of the `FryEggsAsync`, `FryBaconAsync`, and `ToastBreadAsync` have all been updated to return `Task<Egg>`, `Task<Bacon>`, and `Task<Toast>` respectively.</span></span> <span data-ttu-id="7e9ef-163">Os métodos são renomeados de sua versão original para incluir o sufixo "Async".</span><span class="sxs-lookup"><span data-stu-id="7e9ef-163">The methods are renamed from their original version to include the "Async" suffix.</span></span> <span data-ttu-id="7e9ef-164">Suas implementações são mostradas como parte da [versão final](#final-version) mais adiante neste artigo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-164">Their implementations are shown as part of the [final version](#final-version) later in this article.</span></span>

<span data-ttu-id="7e9ef-165">Esse código não bloqueia enquanto os ovos ou o bacon são preparados.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-165">This code doesn't block while the eggs or the bacon are cooking.</span></span> <span data-ttu-id="7e9ef-166">Entretanto, esse código não iniciará outras tarefas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-166">This code won't start any other tasks though.</span></span> <span data-ttu-id="7e9ef-167">Você ainda colocaria o pão na torradeira e ficaria olhando até ele pular.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-167">You'd still put the toast in the toaster and stare at it until it pops.</span></span> <span data-ttu-id="7e9ef-168">Mas, pelo menos, você responderia a qualquer pessoa que quisesse sua atenção.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-168">But at least, you'd respond to anyone that wanted your attention.</span></span> <span data-ttu-id="7e9ef-169">Em um restaurante em que vários pedidos são feitos, o cozinheiro pode iniciar o preparo de outro café da manhã enquanto prepara o primeiro.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-169">In a restaurant where multiple orders are placed, the cook could start another breakfast while the first is cooking.</span></span>

<span data-ttu-id="7e9ef-170">Agora, o thread trabalhando no café da manhã não fica bloqueado aguardando qualquer tarefa iniciada que ainda não tenha terminado.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-170">Now, the thread working on the breakfast isn't blocked while awaiting any started task that hasn't yet finished.</span></span> <span data-ttu-id="7e9ef-171">Para alguns aplicativos, essa alteração já basta.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-171">For some applications, this change is all that's needed.</span></span> <span data-ttu-id="7e9ef-172">Um aplicativo de GUI ainda responde ao usuário com apenas essa alteração.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-172">A GUI application still responds to the user with just this change.</span></span> <span data-ttu-id="7e9ef-173">No entanto, neste cenário, você quer mais.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-173">However, for this scenario, you want more.</span></span> <span data-ttu-id="7e9ef-174">Você não deseja que cada uma das tarefas componentes seja executada em sequência.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-174">You don't want each of the component tasks to be executed sequentially.</span></span> <span data-ttu-id="7e9ef-175">É melhor iniciar cada uma das tarefas componentes antes de aguardar a conclusão da tarefa anterior.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-175">It's better to start each of the component tasks before awaiting the previous task's completion.</span></span>

## <a name="start-tasks-concurrently"></a><span data-ttu-id="7e9ef-176">Iniciar tarefas simultaneamente</span><span class="sxs-lookup"><span data-stu-id="7e9ef-176">Start tasks concurrently</span></span>

<span data-ttu-id="7e9ef-177">Em muitos cenários, convém iniciar várias tarefas independentes imediatamente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-177">In many scenarios, you want to start several independent tasks immediately.</span></span> <span data-ttu-id="7e9ef-178">Em seguida, conforme cada tarefa é concluída, você pode continuar outro trabalho que esteja pronto.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-178">Then, as each task finishes, you can continue other work that's ready.</span></span> <span data-ttu-id="7e9ef-179">Na analogia do café da manhã, é assim que você prepara o café da manhã muito mais rapidamente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-179">In the breakfast analogy, that's how you get breakfast done more quickly.</span></span> <span data-ttu-id="7e9ef-180">Você também prepara tudo quase ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-180">You also get everything done close to the same time.</span></span> <span data-ttu-id="7e9ef-181">Você terá um café da manhã quente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-181">You'll get a hot breakfast.</span></span>

<span data-ttu-id="7e9ef-182">O <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> e os tipos relacionados são classes que você pode usar para pensar nas tarefas que estão em andamento.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-182">The <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and related types are classes you can use to reason about tasks that are in progress.</span></span> <span data-ttu-id="7e9ef-183">Elas permitem que você escreva código que se assemelhe mais à maneira como você realmente prepara o café da manhã.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-183">That enables you to write code that more closely resembles the way you'd actually create breakfast.</span></span> <span data-ttu-id="7e9ef-184">Você começaria a preparar os ovos, o bacon e a torrada ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-184">You'd start cooking the eggs, bacon, and toast at the same time.</span></span> <span data-ttu-id="7e9ef-185">Como cada um exige ação, você voltaria sua atenção para essa tarefa, cuidaria da próxima ação e aguardaria algo mais que exigisse sua atenção.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-185">As each requires action, you'd turn your attention to that task, take care of the next action, then await for something else that requires your attention.</span></span>

<span data-ttu-id="7e9ef-186">Você inicia uma tarefa e espera o objeto <xref:System.Threading.Tasks.Task> que representa o trabalho.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-186">You start a task and hold on to the <xref:System.Threading.Tasks.Task> object that represents the work.</span></span> <span data-ttu-id="7e9ef-187">Você vai `await` cada tarefa antes de trabalhar com o respectivo resultado.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-187">You'll `await` each task before working with its result.</span></span>

<span data-ttu-id="7e9ef-188">Vamos fazer essas alterações no código do café da manhã.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-188">Let's make these changes to the breakfast code.</span></span> <span data-ttu-id="7e9ef-189">A primeira etapa é armazenar as tarefas para as operações quando elas forem iniciadas, em vez de aguardá-las:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-189">The first step is to store the tasks for operations when they start, rather than awaiting them:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");

Task<Bacon> baconTask = FryBaconAsync(3);
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Task<Toast> toastTask = ToastBreadAsync(2);
Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");

Juice oj = PourOJ();
Console.WriteLine("oj is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="7e9ef-190">Em seguida, você pode mover as instruções `await` do bacon e dos ovos até o final do método, antes de servir o café da manhã:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-190">Next, you can move the `await` statements for the bacon and eggs to the end of the method, before serving breakfast:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Task<Bacon> baconTask = FryBaconAsync(3);
Task<Toast> toastTask = ToastBreadAsync(2);

Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");
Juice oj = PourOJ();
Console.WriteLine("oj is ready");

Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="7e9ef-191">O código anterior funciona melhor.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-191">The preceding code works better.</span></span> <span data-ttu-id="7e9ef-192">Você inicia todas as tarefas assíncronas ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-192">You start all the asynchronous tasks at once.</span></span> <span data-ttu-id="7e9ef-193">Você aguarda cada tarefa somente quando precisar dos resultados.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-193">You await each task only when you need the results.</span></span> <span data-ttu-id="7e9ef-194">O código anterior pode ser semelhante a um código em um aplicativo Web que faz solicitações de diferentes microsserviços e combina os resultados em uma única página.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-194">The preceding code may be similar to code in a web application that makes requests of different microservices, then combines the results into a single page.</span></span> <span data-ttu-id="7e9ef-195">Você fará todas as solicitações imediatamente e, em seguida, `await` em todas essas tarefas e comporá a página da Web.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-195">You'll make all the requests immediately, then `await` all those tasks and compose the web page.</span></span>

## <a name="composition-with-tasks"></a><span data-ttu-id="7e9ef-196">Composição com tarefas</span><span class="sxs-lookup"><span data-stu-id="7e9ef-196">Composition with tasks</span></span>

 <span data-ttu-id="7e9ef-197">Você prepara tudo para o café da manhã ao mesmo tempo, exceto a torrada.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-197">You have everything ready for breakfast at the same time except the toast.</span></span> <span data-ttu-id="7e9ef-198">Preparar a torrada é a composição de uma operação assíncrona (torrar o pão) com operações síncronas (adicionar a manteiga e a geleia).</span><span class="sxs-lookup"><span data-stu-id="7e9ef-198">Making the toast is the composition of an asynchronous operation (toasting the bread), and synchronous operations (adding the butter and the jam).</span></span> <span data-ttu-id="7e9ef-199">A atualização deste código ilustra um conceito importante:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-199">Updating this code illustrates an important concept:</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7e9ef-200">A composição de uma operação assíncrona seguida por trabalho síncrono é uma operação assíncrona.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-200">The composition of an asynchronous operation followed by synchronous work is an asynchronous operation.</span></span> <span data-ttu-id="7e9ef-201">Explicando de outra forma, se qualquer parte de uma operação for assíncrona, toda a operação será assíncrona.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-201">Stated another way, if any portion of an operation is asynchronous, the entire operation is asynchronous.</span></span>

<span data-ttu-id="7e9ef-202">O código anterior mostrou que você pode usar objetos <xref:System.Threading.Tasks.Task> ou <xref:System.Threading.Tasks.Task%601> para manter tarefas em execução.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-202">The preceding code showed you that you can use <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> objects to hold running tasks.</span></span> <span data-ttu-id="7e9ef-203">Você `await` em cada tarefa antes de usar seu resultado.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-203">You `await` each task before using its result.</span></span> <span data-ttu-id="7e9ef-204">A próxima etapa é criar métodos que declarem a combinação de outro trabalho.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-204">The next step is to create methods that represent the combination of other work.</span></span> <span data-ttu-id="7e9ef-205">Antes de servir o café da manhã, você quer aguardar a tarefa que representa torrar o pão antes de adicionar manteiga e geleia.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-205">Before serving breakfast, you want to await the task that represents toasting the bread before adding butter and jam.</span></span> <span data-ttu-id="7e9ef-206">Você pode declarar esse trabalho com o código a seguir:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-206">You can represent that work with the following code:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetComposeToastTask":::

<span data-ttu-id="7e9ef-207">O método anterior tem o modificador `async` na sua assinatura.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-207">The preceding method has the `async` modifier in its signature.</span></span> <span data-ttu-id="7e9ef-208">Isso sinaliza ao compilador que esse método contém uma instrução `await`; ele contém operações assíncronas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-208">That signals to the compiler that this method contains an `await` statement; it contains asynchronous operations.</span></span> <span data-ttu-id="7e9ef-209">Este método representa a tarefa que torra o pão e, em seguida, adiciona manteiga e geleia.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-209">This method represents the task that toasts the bread, then adds butter and jam.</span></span> <span data-ttu-id="7e9ef-210">Esse método retorna um <xref:System.Threading.Tasks.Task%601> que representa a composição dessas três operações.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-210">This method returns a <xref:System.Threading.Tasks.Task%601> that represents the composition of those three operations.</span></span> <span data-ttu-id="7e9ef-211">O principal bloco de código agora se torna:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-211">The main block of code now becomes:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetMain":::

<span data-ttu-id="7e9ef-212">A alteração anterior ilustrou uma técnica importante para trabalhar com código assíncrono.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-212">The previous change illustrated an important technique for working with asynchronous code.</span></span> <span data-ttu-id="7e9ef-213">Você pode compor tarefas, separando as operações em um novo método que retorna uma tarefa.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-213">You compose tasks by separating the operations into a new method that returns a task.</span></span> <span data-ttu-id="7e9ef-214">Você pode escolher quando aguardar essa tarefa.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-214">You can choose when to await that task.</span></span> <span data-ttu-id="7e9ef-215">Você pode iniciar outras tarefas simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-215">You can start other tasks concurrently.</span></span>

## <a name="await-tasks-efficiently"></a><span data-ttu-id="7e9ef-216">Aguardar tarefas com eficiência</span><span class="sxs-lookup"><span data-stu-id="7e9ef-216">Await tasks efficiently</span></span>

<span data-ttu-id="7e9ef-217">A série de instruções `await` no final do código anterior pode ser melhorada usando métodos da classe `Task`.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-217">The series of `await` statements at the end of the preceding code can be improved by using methods of the `Task` class.</span></span> <span data-ttu-id="7e9ef-218">Uma dessas APIs é a <xref:System.Threading.Tasks.Task.WhenAll%2A>, que retorna um <xref:System.Threading.Tasks.Task> que é concluído ao final de todas as tarefas na lista de argumentos, conforme mostrado no código a seguir:</span><span class="sxs-lookup"><span data-stu-id="7e9ef-218">One of those APIs is <xref:System.Threading.Tasks.Task.WhenAll%2A>, which returns a <xref:System.Threading.Tasks.Task> that completes when all the tasks in its argument list have completed, as shown in the following code:</span></span>

```csharp
await Task.WhenAll(eggsTask, baconTask, toastTask);
Console.WriteLine("eggs are ready");
Console.WriteLine("bacon is ready");
Console.WriteLine("toast is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="7e9ef-219">Outra opção é usar <xref:System.Threading.Tasks.Task.WhenAny%2A>, que retorna uma `Task<Task>` que é concluída quando qualquer um dos argumentos é concluído.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-219">Another option is to use <xref:System.Threading.Tasks.Task.WhenAny%2A>, which returns a `Task<Task>` that completes when any of its arguments completes.</span></span> <span data-ttu-id="7e9ef-220">Você pode aguardar a tarefa retornada, sabendo que ela já foi concluída.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-220">You can await the returned task, knowing that it has already finished.</span></span> <span data-ttu-id="7e9ef-221">O código a seguir mostra como você poderia usar <xref:System.Threading.Tasks.Task.WhenAny%2A> para aguardar a primeira tarefa concluir e, em seguida, processar seu resultado.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-221">The following code shows how you could use <xref:System.Threading.Tasks.Task.WhenAny%2A> to await the first task to finish and then process its result.</span></span> <span data-ttu-id="7e9ef-222">Depois de processar o resultado da tarefa concluída, você remove essa tarefa concluída da lista de tarefas passada para `WhenAny`.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-222">After processing the result from the completed task, you remove that completed task from the list of tasks passed to `WhenAny`.</span></span>

```csharp
var breakfastTasks = new List<Task> { eggsTask, baconTask, toastTask };
while (breakfastTasks.Count > 0)
{
    Task finishedTask = await Task.WhenAny(breakfastTasks);
    if (finishedTask == eggsTask)
    {
        Console.WriteLine("eggs are ready");
    }
    else if (finishedTask == baconTask)
    {
        Console.WriteLine("bacon is ready");
    }
    else if (finishedTask == toastTask)
    {
        Console.WriteLine("toast is ready");
    }
    breakfastTasks.Remove(finishedTask);
}
```

<span data-ttu-id="7e9ef-223">Depois de todas essas alterações, a versão final do código tem esta aparência:<a id="final-version"></a></span><span class="sxs-lookup"><span data-stu-id="7e9ef-223">After all those changes, the final version of the code looks like this: <a id="final-version"></a></span></span>
:::code language="csharp" source="snippets/index/AsyncBreakfast-final/Program.cs" highlight="9-40":::

<span data-ttu-id="7e9ef-224">Esse código final é assíncrono.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-224">This final code is asynchronous.</span></span> <span data-ttu-id="7e9ef-225">Ele reflete mais precisamente como uma pessoa poderia preparar um café da manhã.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-225">It more accurately reflects how a person would cook a breakfast.</span></span> <span data-ttu-id="7e9ef-226">Compare o código anterior com o primeiro exemplo de código neste artigo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-226">Compare the preceding code with the first code sample in this article.</span></span> <span data-ttu-id="7e9ef-227">As ações principais permanecem claras ao ler o código.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-227">The core actions are still clear from reading the code.</span></span> <span data-ttu-id="7e9ef-228">Você pode ler esse código da mesma forma como faria ao ler essas instruções para fazer um café da manhã no início deste artigo.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-228">You can read this code the same way you'd read those instructions for making a breakfast at the beginning of this article.</span></span> <span data-ttu-id="7e9ef-229">Os recursos de linguagem para `async` e `await` fornecem a tradução que todas as pessoas fazem para seguir essas instruções escritas: iniciar tarefas assim que possível e não ficar bloqueado ao aguardar a conclusão de tarefas.</span><span class="sxs-lookup"><span data-stu-id="7e9ef-229">The language features for `async` and `await` provide the translation every person makes to follow those written instructions: start tasks as you can and don't block waiting for tasks to complete.</span></span>

## <a name="next-steps"></a><span data-ttu-id="7e9ef-230">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="7e9ef-230">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="7e9ef-231">Saiba mais sobre o modelo de programação assíncrona de tarefas</span><span class="sxs-lookup"><span data-stu-id="7e9ef-231">Learn about the task asynchronous programming model</span></span>](task-asynchronous-programming-model.md)
