### <a name="avoiding-endless-recursion-for-iworkflowinstancemanagementtransactedcancel-and-iworkflowinstancemanagementtransactedterminate"></a><span data-ttu-id="8388c-101">Evitando a recursão infinita para IWorkflowInstanceManagement.TransactedCancel e IWorkflowInstanceManagement.TransactedTerminate</span><span class="sxs-lookup"><span data-stu-id="8388c-101">Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate</span></span>

|   |   |
|---|---|
|<span data-ttu-id="8388c-102">Detalhes</span><span class="sxs-lookup"><span data-stu-id="8388c-102">Details</span></span>|<span data-ttu-id="8388c-103">Em algumas circunstâncias, ao usar as APIs <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> ou <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> para cancelar ou terminar uma instância de serviço de fluxo de trabalho, a instância de fluxo de trabalho pode encontrar um excedente de pilha devido à recursão infinita quando o tempo de execução do <code>Workflow</code> tenta persistir a instância de serviço como parte do processamento da solicitação.</span><span class="sxs-lookup"><span data-stu-id="8388c-103">Under some circumstances when using <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> APIs to cancel or terminate a worklow service instance, the workflow instance may encounter a stack overflow due to endless recursion when the <code>Workflow</code> runtime attempts to persist the service instance as part of processing the request.</span></span> <span data-ttu-id="8388c-104">O problema ocorre quando a instância de fluxo de trabalho está em um estado em que está esperando a conclusão de outras solicitações do WCF pendentes para outro serviço. As operações <code>TransactedCancel</code> e <code>TransactedTerminate</code> criam itens de trabalho que são colocados na fila para a instância de serviço de fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="8388c-104">The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.The <code>TransactedCancel</code> and <code>TransactedTerminate</code> operations create work items that are queued for the workflow service instance.</span></span> <span data-ttu-id="8388c-105">Esses itens de trabalho não são executados como parte do processamento da solicitação <code>TransactedCancel/TransactedTerminate</code>.</span><span class="sxs-lookup"><span data-stu-id="8388c-105">These work items are not executed as part of the processing of the <code>TransactedCancel/TransactedTerminate</code> request.</span></span> <span data-ttu-id="8388c-106">Como a instância de serviço do fluxo de trabalho está ocupada esperando a conclusão da outra solicitação do WCF pendente, o item de trabalho criado permanece na fila.</span><span class="sxs-lookup"><span data-stu-id="8388c-106">Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued.</span></span> <span data-ttu-id="8388c-107">A operação <code>TransactedCancel/TransactedTerminate</code> é concluída e o controle é retornado ao cliente.</span><span class="sxs-lookup"><span data-stu-id="8388c-107">The <code>TransactedCancel/TransactedTerminate</code> operation completes and control is returned back to the client.</span></span> <span data-ttu-id="8388c-108">Quando a transação associada à operação <code>TransactedCancel/TransactedTerminate</code> tenta ser confirmada, ela precisa persistir o estado da instância de serviço do fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="8388c-108">When the transaction associated with the <code>TransactedCancel/TransactedTerminate</code> operation attempts to commit, it needs to persist the workflow serivce instance state.</span></span> <span data-ttu-id="8388c-109">Mas como há uma solicitação de <code>WCF</code> pendente para a instância, o tempo de execução do fluxo de trabalho não consegue persistir a instância de serviço do fluxo de trabalho e um loop de recursão infinita causa o excedente de pilha. Como <code>TransactedCancel</code> e <code>TransactedTerminate</code> apenas criam um item de trabalho na memória, o fato de que existe uma transação não tem nenhum efeito.</span><span class="sxs-lookup"><span data-stu-id="8388c-109">But because there is an outstanding <code>WCF</code> request for the instance, the Workflow runtime cannot persist the workflow service instance, and an endless recursion loop leads to the stack overflow.Because <code>TransactedCancel</code> and <code>TransactedTerminate</code> only create a work item in memory, the fact that a transaction exists doesn't have any effect.</span></span> <span data-ttu-id="8388c-110">Uma reversão da transação não descarta o item de trabalho. Para resolver esse problema, começando com o .NET Framework 4.7.2, foi introduzido um <code>AppSetting</code> que pode ser adicionado ao serviço de fluxo de trabalho <code>web.config/app.config</code> para solicitar que as transações de <code>TransactedCancel</code> e <code>TransactedTerminate</code> sejam ignoradas.</span><span class="sxs-lookup"><span data-stu-id="8388c-110">A rollback of the transaction does not discard the work item.To address this issue, starting in .NET Framework 4.7.2, we have introduced an <code>AppSetting</code> that can be added to the <code>web.config/app.config</code> of the workflow service that tells it to ignore transactions for <code>TransactedCancel</code> and <code>TransactedTerminate</code>.</span></span> <span data-ttu-id="8388c-111">Isso permite que a transação seja confirmada sem esperar que a instância de fluxo de trabalho persista. A AppSetting para esse recurso é chamada de <code>microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate</code>.</span><span class="sxs-lookup"><span data-stu-id="8388c-111">This allows the transaction to commit without waiting for the workflow instance to persist.The AppSetting for this feature is named <code>microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate</code>.</span></span> <span data-ttu-id="8388c-112">O valor <code>true</code> indica que a transação deve ser ignorada, evitando o excedente de pilha.</span><span class="sxs-lookup"><span data-stu-id="8388c-112">A value of <code>true</code> indicates that the transaction should be ignored, thus avoiding the stack overflow.</span></span> <span data-ttu-id="8388c-113">O valor padrão dessa AppSetting é <code>false</code>, portanto, as instâncias de serviço do fluxo de trabalho existentes não são afetadas.</span><span class="sxs-lookup"><span data-stu-id="8388c-113">The default value of this AppSetting is <code>false</code>, so existing workflow service instances are not affected.</span></span>|
|<span data-ttu-id="8388c-114">Sugestão</span><span class="sxs-lookup"><span data-stu-id="8388c-114">Suggestion</span></span>|<span data-ttu-id="8388c-115">Se você estiver usando o AppFabric ou outro cliente <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> e encontrar um excedente de pilha na instância de serviço do fluxo de trabalho durante a tentativa de cancelar ou terminar uma instância de fluxo de trabalho, você poderá adicionar o seguinte à seção <code>&lt;appSettings&gt;</code> do arquivo web.config/app.config para o serviço de fluxo de trabalho:</span><span class="sxs-lookup"><span data-stu-id="8388c-115">If you are using AppFabric or another <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> client and are encountering a stack overflow in the workflow serivce instance when trying to cancel or terminate a workflow instance, you can add the following to the <code>&lt;appSettings&gt;</code> section of the web.config/app.config file for the workflow service:</span></span><pre><code class="lang-xml">&lt;add key=&quot;microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate&quot; value=&quot;true&quot;/&gt;&#13;&#10;</code></pre><span data-ttu-id="8388c-116">Se o problema não ocorrer, não será necessário fazer isso.</span><span class="sxs-lookup"><span data-stu-id="8388c-116">If you are not encountering the problem, you do not need to do this.</span></span>|
|<span data-ttu-id="8388c-117">Escopo</span><span class="sxs-lookup"><span data-stu-id="8388c-117">Scope</span></span>|<span data-ttu-id="8388c-118">Microsoft Edge</span><span class="sxs-lookup"><span data-stu-id="8388c-118">Edge</span></span>|
|<span data-ttu-id="8388c-119">Versão</span><span class="sxs-lookup"><span data-stu-id="8388c-119">Version</span></span>|<span data-ttu-id="8388c-120">4.7.2</span><span class="sxs-lookup"><span data-stu-id="8388c-120">4.7.2</span></span>|
|<span data-ttu-id="8388c-121">Tipo</span><span class="sxs-lookup"><span data-stu-id="8388c-121">Type</span></span>|<span data-ttu-id="8388c-122">Redirecionando</span><span class="sxs-lookup"><span data-stu-id="8388c-122">Retargeting</span></span>|

