---
ms.openlocfilehash: ab9431780422dfece5dcf8007d13e6d584f5118f
ms.sourcegitcommit: 721c3e4bdbb1ea0bb420818ec944c538fe5c513a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/01/2020
ms.locfileid: "96477788"
---
### <a name="avoiding-endless-recursion-for-iworkflowinstancemanagementtransactedcancel-and-iworkflowinstancemanagementtransactedterminate"></a><span data-ttu-id="ef8e1-101">Evitando a recursão infinita para IWorkflowInstanceManagement.TransactedCancel e IWorkflowInstanceManagement.TransactedTerminate</span><span class="sxs-lookup"><span data-stu-id="ef8e1-101">Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate</span></span>

#### <a name="details"></a><span data-ttu-id="ef8e1-102">Detalhes</span><span class="sxs-lookup"><span data-stu-id="ef8e1-102">Details</span></span>

<span data-ttu-id="ef8e1-103">Em algumas circunstâncias, ao usar as APIs <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> ou <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> para cancelar ou terminar uma instância de serviço de fluxo de trabalho, a instância de fluxo de trabalho pode encontrar um excedente de pilha devido à recursão infinita quando o runtime do `Workflow` tenta persistir a instância de serviço como parte do processamento da solicitação.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-103">Under some circumstances when using <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> APIs to cancel or terminate a workflow service instance, the workflow instance may encounter a stack overflow due to endless recursion when the `Workflow` runtime attempts to persist the service instance as part of processing the request.</span></span> <span data-ttu-id="ef8e1-104">O problema ocorre se a instância do fluxo de trabalho estiver em um estado em que está aguardando a conclusão de alguma outra solicitação pendente do WCF para outro serviço.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-104">The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.</span></span> <span data-ttu-id="ef8e1-105">As `TransactedCancel` `TransactedTerminate` operações e criam itens de trabalho que são enfileirados para a instância do serviço de Workflow.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-105">The `TransactedCancel` and `TransactedTerminate` operations create work items that are queued for the workflow service instance.</span></span> <span data-ttu-id="ef8e1-106">Esses itens de trabalho não são executados como parte do processamento da solicitação `TransactedCancel/TransactedTerminate`.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-106">These work items are not executed as part of the processing of the `TransactedCancel/TransactedTerminate` request.</span></span> <span data-ttu-id="ef8e1-107">Como a instância de serviço do fluxo de trabalho está ocupada esperando a conclusão da outra solicitação do WCF pendente, o item de trabalho criado permanece na fila.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-107">Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued.</span></span> <span data-ttu-id="ef8e1-108">A operação `TransactedCancel/TransactedTerminate` é concluída e o controle é retornado ao cliente.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-108">The `TransactedCancel/TransactedTerminate` operation completes and control is returned back to the client.</span></span> <span data-ttu-id="ef8e1-109">Quando a transação associada à operação `TransactedCancel/TransactedTerminate` tenta ser confirmada, ela precisa persistir o estado da instância de serviço do fluxo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-109">When the transaction associated with the `TransactedCancel/TransactedTerminate` operation attempts to commit, it needs to persist the workflow service instance state.</span></span> <span data-ttu-id="ef8e1-110">Mas como há uma solicitação de `WCF` pendente para a instância, o runtime de fluxo de trabalho não consegue persistir a instância de serviço do fluxo de trabalho e um loop de recursão infinita causa o excedente de pilha. Como `TransactedCancel` e `TransactedTerminate` apenas criam um item de trabalho na memória, o fato de que existe uma transação não tem nenhum efeito.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-110">But because there is an outstanding `WCF` request for the instance, the Workflow runtime cannot persist the workflow service instance, and an endless recursion loop leads to the stack overflow.Because `TransactedCancel` and `TransactedTerminate` only create a work item in memory, the fact that a transaction exists doesn't have any effect.</span></span> <span data-ttu-id="ef8e1-111">Uma reversão da transação não descarta o item de trabalho. Para resolver esse problema, começando com o .NET Framework 4.7.2, foi introduzido um `AppSetting` que pode ser adicionado ao serviço de fluxo de trabalho `web.config/app.config` para solicitar que as transações de `TransactedCancel` e `TransactedTerminate` sejam ignoradas.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-111">A rollback of the transaction does not discard the work item.To address this issue, starting in .NET Framework 4.7.2, we have introduced an `AppSetting` that can be added to the `web.config/app.config` of the workflow service that tells it to ignore transactions for `TransactedCancel` and `TransactedTerminate`.</span></span> <span data-ttu-id="ef8e1-112">Isso permite que a transação seja confirmada sem esperar que a instância do fluxo de trabalho persista.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-112">This allows the transaction to commit without waiting for the workflow instance to persist.</span></span> <span data-ttu-id="ef8e1-113">O AppSetting para esse recurso é nomeado `microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate` .</span><span class="sxs-lookup"><span data-stu-id="ef8e1-113">The AppSetting for this feature is named `microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate`.</span></span> <span data-ttu-id="ef8e1-114">O valor `true` indica que a transação deve ser ignorada, evitando o excedente de pilha.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-114">A value of `true` indicates that the transaction should be ignored, thus avoiding the stack overflow.</span></span> <span data-ttu-id="ef8e1-115">O valor padrão dessa AppSetting é `false`, portanto, as instâncias de serviço do fluxo de trabalho existentes não são afetadas.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-115">The default value of this AppSetting is `false`, so existing workflow service instances are not affected.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="ef8e1-116">Sugestão</span><span class="sxs-lookup"><span data-stu-id="ef8e1-116">Suggestion</span></span>

<span data-ttu-id="ef8e1-117">Se você estiver usando o AppFabric ou outro cliente <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> e encontrar um excedente de pilha na instância de serviço do fluxo de trabalho durante a tentativa de cancelar ou terminar uma instância de fluxo de trabalho, você poderá adicionar o seguinte à seção `<appSettings>` do arquivo web.config/app.config para o serviço de fluxo de trabalho:</span><span class="sxs-lookup"><span data-stu-id="ef8e1-117">If you are using AppFabric or another <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> client and are encountering a stack overflow in the workflow service instance when trying to cancel or terminate a workflow instance, you can add the following to the `<appSettings>` section of the web.config/app.config file for the workflow service:</span></span>

<pre><code class="lang-xml">&lt;add key=&quot;microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate&quot; value=&quot;true&quot;/&gt;&#13;&#10;</code></pre>

<span data-ttu-id="ef8e1-118">Se o problema não ocorrer, não será necessário fazer isso.</span><span class="sxs-lookup"><span data-stu-id="ef8e1-118">If you are not encountering the problem, you do not need to do this.</span></span>

| <span data-ttu-id="ef8e1-119">Nome</span><span class="sxs-lookup"><span data-stu-id="ef8e1-119">Name</span></span>    | <span data-ttu-id="ef8e1-120">Valor</span><span class="sxs-lookup"><span data-stu-id="ef8e1-120">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="ef8e1-121">Escopo</span><span class="sxs-lookup"><span data-stu-id="ef8e1-121">Scope</span></span>   | <span data-ttu-id="ef8e1-122">Edge</span><span class="sxs-lookup"><span data-stu-id="ef8e1-122">Edge</span></span>        |
| <span data-ttu-id="ef8e1-123">Versão</span><span class="sxs-lookup"><span data-stu-id="ef8e1-123">Version</span></span> | <span data-ttu-id="ef8e1-124">4.7.2</span><span class="sxs-lookup"><span data-stu-id="ef8e1-124">4.7.2</span></span>       |
| <span data-ttu-id="ef8e1-125">Tipo</span><span class="sxs-lookup"><span data-stu-id="ef8e1-125">Type</span></span>    | <span data-ttu-id="ef8e1-126">Redirecionando</span><span class="sxs-lookup"><span data-stu-id="ef8e1-126">Retargeting</span></span> |
